
<!DOCTYPE html>
<html>
<head>
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script type="text/javascript" src="/js/common_query_dialog.js"></script>
    <script src="/js/lhgdialog/lhgdialog.js"></script>
    <link rel="stylesheet" href="/css/common.css">
    <link rel="stylesheet" href="/css/plugins/dialog/dialog_default.css">
	<title></title>
    <style type="text/css" scoped>
        .footer {
            height: 30px;
            line-height: 30px;
            position: fixed;
            bottom: 0;
            width: 100%;
            text-align: right;
        }
        .table-cell{
            text-align: center;
            padding: 0;
            margin: 0;
        }
        .cell-normal {
            height: 40px;
        }

        .btn-hide {
            display: none;
        }
        .sbtn{
            padding: 3px 10px;
            background: #2465a8;
            color: #fff;
            border-radius: 4px;
            display: inline-block;
            cursor: pointer;
        }
        .del{
            background-color: #ce3c3c;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <div style="height: 650px">
    	<div id="tt" class="easyui-tabs" style="width:100%;height:100%" tabPosition="left" tabHeight="40px">
            <div title="General" style="padding:20px;display:none;" data-options="href:'/views/defect/defectBaseInfo.shtml'"></div>
    	    <!-- <div title="General" style="padding:20px;display:none;">
    			<iframe id="iframe-page-content" src="/views/defect/defectBaseInfo.shtml" width="98%" height="98%" frameborder="no" border="0" marginwidth="0" marginheight=" 0" scrolling="no" allowtransparency="yes"></iframe>
    	    </div> -->
    	    <div title="Pending/Deferral" style="padding:20px;display:none;" data-options="href:'/views/defect/PendingDeferal.shtml'">
    			<!-- <iframe id="iframe-page-content" src="/views/defect/PendingDeferal.shtml" width="98%" height="98%" frameborder="no" border="0" marginwidth="0" marginheight=" 0" scrolling="no" allowtransparency="yes"></iframe> -->
    	    </div>
    	    <div title="Action" style="padding:20px;display:none;" data-options="href:'/views/defect/actionTab.shtml'">
    			<!-- <iframe id="iframe-page-content" src="/views/defect/actionTab.shtml" width="98%" height="98%" frameborder="no" border="0" marginwidth="0" marginheight=" 0" scrolling="no" allowtransparency="yes"></iframe> -->
    	    </div>
            <div style="padding:20px;display:none;" title="TO">
                <iframe allowtransparency="yes" border="0" frameborder="no" height="98%" id="iframe-page-content-to"
                        marginheight=" 0" marginwidth="0" scrolling="no" src="/views/defect/view_defect_base_to.shtml"
                        width="98%"></iframe>
            </div>
            <div data-options="href:'/views/defect/defect_show_mr.shtml'" style="padding:20px;display:none;" title="Material Request">
            </div>
            <div title="WorkLog" style="padding:20px;display:none;" data-options="href:'/views/defect/worklog/worklogTab.shtml'">
            </div>
            <div title="Relation Defect" style="padding:20px;display:none;" data-options="href:'/views/defect/relationTab.shtml'">
            </div>
            <div title="Component Change" style="padding:20px;display:none;" data-options="href:'/views/defect/ccTab.shtml'">
            </div>
            <div title="TBM Task" style="padding:20px;display:none;" data-options="href:'/views/defect/tbmTab.shtml'">
            </div>
            <!-- <div title="TLB" style="padding:20px;display:none;" data-options="href:'/views/defect/tlb/tlbTab.shtml'">
            </div> -->
    	</div>
    </div>
    <div class="footer">
        <div style="padding-right: 40px;">
            <a auth="DEFECT_ADD_WORKLOG" class="searchBtn btn-hide" onClick="open_worklog()" name="addWorkLog" type="button">add WorkLog</a>
            <a auth="DEFECT_PEND" class="searchBtn btn-hide" onClick="open_pending()" name="defectPend" type="button">故障推迟</a>
            <a auth="DEFECT_PEND" class="searchBtn btn-hide" onClick="continue_pending()" name="continuePend" type="button">Continue Pend</a>
            <a auth="DEFECT_DD" class="searchBtn btn-hide" onClick="open_deferral()" name="defectDeferral" type="button">故障保留</a>
            <a auth="DEFECT_CLOSE" class="searchBtn btn-hide" name="structureDefectClose" onClick="to_structure()" type="button">TO结构</a>
            <a auth="DEFECT_DD" class="searchBtn btn-hide" onClick="extention()" name="renewal" type="button">再次保留</a>
            <a auth="DEFECT_DD" class="searchBtn btn-hide" onClick="continue_deferral()" name="continueDd" type="button">Continue DD</a>
            <a auth="DEFECT_DD" class="searchBtn btn-hide" onClick="closeDD()" name="closeDd" type="button">关闭DD</a>
            <a auth="DEFECT_MCC" class="searchBtn btn-hide" onClick="toMCC()" name="toMcc" type="button">转MCC</a>
            <a auth="DEFECT_ADD_MR" class="searchBtn btn-hide" name="addMr" onClick="add_mr()" type="button">add MR</a>
            <a auth="DEFECT_ADD_TO" class="searchBtn btn-hide" onClick="add_to()" name="addTo" type="button">add TO</a>
            <a auth="DEFECT_CLOSE" class="searchBtn btn-hide" onClick="defect_close(false)" name="defectClose" type="button">故障关闭</a>
            <a auth="DEFECT_CLOSE" class="searchBtn btn-hide" onClick="defect_re_open()" name="reopen" type="button">故障重开</a>
            <a auth="DEFECT_UPLOAD_MEASURES" class="searchBtn btn-hide" onClick="open_process()" name="defectProcess" type="button">上传排故措施</a>
            <a class="searchBtn btn-hide" onClick="close_window()" name="addWorkLog" type="button">Close</a>
        </div>
    </div>
</body>
<script type="text/javascript">
	const params = getParentParam_();
    const defectId = params.defectId;
    const defectNo = params.defectNo;
    var acReg = "";
    var station = "";
    var pendInfo = "";
    var drBaseSubmitAsmsDTO = {};
    var workorderId = '';
    var sapTaskId = '';
    var global_data = {
        // fh: page_data.defectPend.ddDueDatas[0].fh,
        // fc: page_data.defectPend.ddDueDatas[0].fc,
        // calendarDays: page_data.defectPend.ddDueDatas[0].calendarDay,
        // flyingDays: page_data.defectPend.ddDueDatas[0].flightDay,
        fh:'',
        fc:'',
        calendarDays:'',
        flyingDays:'',
    };
    function get_defectId(){
    	return defectId
    }
    function get_defectNo(){
        return defectNo
    }

    /**
     *
     * @param 添加mr成功后 刷新页面
     * @param
     * @private
     */
    function reload_()
    {
        if ($("#tt" ).tabs('exists', 'Material Request')) {
            let tab = $('#tt').tabs("getTab", 4);
            tab.panel('refresh', '/views/defect/defect_show_mr.shtml');
            $('#tt').tabs('select', 'Material Request');
        }

    }


    function add_mr() {
        let parameters = {
            "cardId": params.defectId,
            "cardNum": params.defectNo,
            "sonId": workorderId,
            "tdWorkType": "DEFECT",
            "sapTaskId": sapTaskId,
            "acReg":acReg,
            "station":station,
        };
        let title = "add mr";

        ShowWindowIframe({
            width: "1200",
            height: "700",
            title: title,
            param: parameters,
            url: "/views/mr/add_mr.shtml"
        });

    }
    function get_workorderId(val) {
        workorderId = val ;
        return workorderId;
    }

    function get_sapTaskId(val) {
        sapTaskId = val;
        return sapTaskId;
    }
    function to_structure() {
        if(drBaseSubmitAsmsDTO.nrcDtoList.length == 0){
            MsgAlert({type: "error", content: '请提醒结构部门开NRC'})
        }else{
            if (confirm("请确认是否转结构处理并关闭故障")) {
                defect_close(true);
            }
        }


    }
    function add_to() {
        let url = "/views/mccdoc/edit/add_fault_isolate_to.shtml";
        let parameters = {
            "defectId": params.defectId,
            "toType": "1",
            "pageType": "add",
            "id": 0
        };
        P.$.dialog({
            id: 'addToDialog1',
            title: 'Add TO',
            width: '1000px',
            height: '600px',
            left: '30%',
            top: '35%',
            esc: true,
            cache: false,
            max: false,
            min: false,
            parent: null,
            lock: true,
            content: "url:" + url,
            data: parameters,
            close: function () {
                location.reload();
            }
        });
    }


    function open_worklog(){
        console.log($("#status").html());
        let title = "add worklog";
        let param = {
            defectId: params.defectId,
            operation: "add",
            statusO: $("#status").html(),
            successCallback: ()=>{
                MsgAlert({type: "info", content: "保存成功"});
                if ($("#tt" ).tabs('exists', 'WorkLog')) {
                    let tab = $('#tt').tabs("getTab", 5);
                    tab.panel('refresh', '/views/defect/worklog/worklogTab.shtml');
                    $('#tt').tabs('select','WorkLog');
                    location.reload();
                }

            }
        };
        ShowWindowIframe({
            width: "1200",
            height: "700",
            title: title,
            param: param,
            url: "/views/defect/worklog/addWorklog.shtml"
        });

    }

    function open_process(){
        let title = "上传排故措施";
        let param = {
            defectId: params.defectId,
            operation: "add",
            successCallback: ()=>{
                let tab2 = $('#tt').tabs("getTab", 2);
                tab2.panel('refresh', '/views/defect/actionTab.shtml');
            }
        };
        ShowWindowIframe({
            width: "1250",
            height: "750",
            title: title,
            param: param,
            url: "/views/defect/processDefect.shtml"
        });
    }

    function view_pending(){
        let title = "故障推迟";
        let param = {
            defectId: params.defectId,
            operation: "PEND"
        };
        ShowWindowIframe({
            width: "1100",
            height: "700",
            title: title,
            param: param,
            url: "/views/defect/viewPending.shtml"
        });
    }
    function open_pending(){
        let title = "故障推迟";
        let param = {
            defectId: params.defectId,
            operation: "PEND",
            successCallback: ()=>{
                let tab0 = $('#tt').tabs("getTab", 0);
                tab0.panel('refresh', '/views/defect/defectBaseInfo.shtml');
                let tab1 = $('#tt').tabs("getTab", 1);
                tab1.panel('refresh', '/views/defect/PendingDeferal.shtml');
                let tab2 = $('#tt').tabs("getTab", 2);
                tab2.panel('refresh', '/views/defect/actionTab.shtml');
                location.reload();
            }
        };
        ShowWindowIframe({
            width: "1100",
            height: "700",
            title: title,
            param: param,
            url: "/views/defect/defectPending.shtml"
        });
    }
    /**
     * 继续推迟
     */
    function continue_pending() {
        let url = "/api/v1/defect/defect/pend/continuePend";
        let form = new FormData();
        form.append('id',  params.defectId);
        form.append('category', "PEND");
        axios.post(url, form).then(response=>{
            if(response.data.msg.indexOf("ERROR") != -1) {
                throw new Error(response.data.msgData[0])
            }else if(response.data.msg.toUpperCase().indexOf("SUCCESS") != -1){
                MsgAlert({type: "success", content: "继续推迟成功"});
                location.reload();
            }
        }).catch(err=>{
            MsgAlert({type: "error", content: err.message})
        })
    }

    function open_deferral(){
        let title = "故障保留";
        let param = {
            defectId: params.defectId,
            operation: "DEFERRAL",
            successCallback: ()=>{
                let tab0 = $('#tt').tabs("getTab", 0);
                tab0.panel('refresh', '/views/defect/defectBaseInfo.shtml');
                let tab1 = $('#tt').tabs("getTab", 1);
                tab1.panel('refresh', '/views/defect/PendingDeferal.shtml');
                let tab2 = $('#tt').tabs("getTab", 2);
                tab2.panel('refresh', '/views/defect/actionTab.shtml');
                // location.reload()
            }
        };
        ShowWindowIframe({
            width: "1100",
            height: "700",
            title: title,
            param: param,
            url: "/views/defect/defectPending.shtml"
        });
    }
    function  extention(){
        if(!isEmpty(pendInfo.extensionInstanceId))
        {
            MsgAlert({content: '再次保留只能办理一次！', type: 'error'});
            return;
        }
        let category = pendInfo.ddDueData.category;
        let categoryStr = pendInfo.ddDueData.dueDataStr;
        let expiredDate = new Date(pendInfo.expiredDate.replace(/-/g, '/'));
        expiredDate.setTime(expiredDate.getTime());

        let title = "续保";
        let param = {
            'businessKey': pendInfo.id + "_" + pendInfo.defectId,
            'isnew': true,
            'categoryStr': categoryStr,
            'extensionDate': formatterDate(expiredDate),
            'category': category
        };
        P.$.dialog({
            id: 'source_submit_dg',
            title: title + " deferred No. " + pendInfo.deferredNo,
            width: '600px',
            height: '300px',
            top: '60px',
            data: param,
            content: "url:/views/defect/deferral/extention1.shtml",
            close: function () {
                location.reload();
            }
        });
    }
    function isEmpty(obj){
        if(typeof obj == "undefined" || obj == null || obj == ""){
            return true;
        }else{
            return false;
        }
    }
    /** 故障保留category选项配置 **/
    const category_list_deferral = [
        {
            value: "a",
            label: "A: ",
            name: "a",
        },
        {
            value: "b",
            label: "B: 三天",
            name: "b",
            days: 3
        },
        {
            value: "c",
            label: "C: 十天",
            name: "c",
            days: 10
        },
        {
            value: "d",
            label: "D: 一百二十天",
            name: "d",
            days: 120
        },
        {
            value: "other",
            label: "OTHER",
            name: "other"
        }
    ];

    /** category选择时计算失效时间 **/
    function calculate_expired_date(days, start) {
        let startDate = start ? new Date(start) : new Date();
        let current_date_start = new Date(new Date(startDate.toLocaleDateString()).getTime());
        let res_date = new Date(current_date_start.getTime() + 24 * 60 * 60 * 1000 * Number(days + 1) - 1);
        return res_date
    }
    /*继续保留*/
    function continue_deferral() {
        let url = "/api/v1/defect/defect/dfrl/continueDfrl";
        let form = new FormData();
        form.append('id',  params.defectId);
        form.append('category', "DFRL");
        axios.post(url, form).then(response=>{
            if(response.data.msg.indexOf("ERROR") != -1) {
                throw new Error(response.data.msgData[0])
            }else if(response.data.msg.toUpperCase().indexOf("SUCCESS") != -1){
                MsgAlert({type: "success", content: "继续保留成功"});
                location.reload();
            }
        }).catch(err=>{
            MsgAlert({type: "error", content: err.message})
        })
    }
    /*关闭DD*/
    function closeDD(){
        if (confirm("确定关闭DDI？")) {
            let url = "/api/v1/defect/defect/dfrl/closeDD";
            let form = new FormData();
            form.append('id',  params.defectId);
            axios.post(url, form).then(response=>{
                if (response.data.code == 200) {
                    MsgAlert({type: "success", content: response.data.msg});
                    location.reload();
                } else {
                    throw new Error(response.data.msgData[0])
                }
            }).catch(err=>{
                MsgAlert({type: "error", content: err.message})
            })
        }

    }
    function defect_re_open(){
        let url = "/api/v1/defect/defect_base_info/reOpen";
        let form = new FormData();
        form.append('id', params.defectId);
        axios.post(url, form).then(response=>{
            if(response.data.msg.indexOf("ERROR") != -1) {
                throw new Error(response.data.msgData[0])
            }else if(response.data.msg.toUpperCase().indexOf("SUCCESS") != -1){
                MsgAlert({type: "success", content: "提交成功"});
                location.reload();
            }
        }).catch(err=>{
            MsgAlert({type: "error", content: err.message})
        })
    }

    function defect_close(isStructureClose) {

        if (confirm("确定关闭故障！")) {
            let url = "/api/v1/defect/defect_base_info/close?defectId=" + params.defectId+"&isStructureClose="+isStructureClose;
            axios.get(url).then(response => {
                if (response.data.msg.indexOf("ERROR") != -1) {
                    throw new Error(response.data.msgData[0])
                } else if (response.data.msg.toUpperCase().indexOf("SUCCESS") != -1) {
                    MsgAlert({type: "success", content: "关闭成功"});
                    location.reload();
                }else if(response.data.msg.toUpperCase().indexOf("ALREADY") != -1){
                    MsgAlert({type: "success", content: "此任务涉及双重维修限制，请确认是否已按要求执行"})
                }
            }).catch(err => {
                MsgAlert({type: "error", content: err.message})
            })
        }
    }
    window.onbeforeunload=onclose;
    function onclose(){
        if(params.OWindow.listreload_){
            params.OWindow.listreload_();
        }
    }
    //底部关闭按钮点击事件
    function close_window(){
        window.opener=null;
        window.open('','_self');
        window.close();
    }

    /**
     * 转MCC
     */
    function toMCC(){
        let url = "/api/v1/defect/defect_base_info/toMcc";
        let form_data = new FormData();
        form_data.append("id", params.defectId);
        axios.post(url, form_data).then(response=>{
            let tab0 = $('#tt').tabs("getTab", 0);
            if(response.data.code == '200'){
                MsgAlert({type: "success", content: "提交成功"});
                tab0.panel('refresh', '/views/defect/defectBaseInfo.shtml');
                location.reload();
            }else{
                MsgAlert({content: response.data.msgData[0] ? response.data.msgData[0] : response.data.msg, type: 'error'});
            }
        }).catch(err => {
            MsgAlert({type: "error", content: err.message})
        })
    }

    function get_buttons(){
        let url = "/api/v1/defect/defect_base_info/viewById";
        let form = new FormData();
        let defectId = get_defectId();
        let defectNo = get_defectNo();
        form.append('id', defectId);
        form.append("defectNo", defectNo);
        let opt = {};
        opt.headers = {
            'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8'
        };
        axios.post(url, form, opt).then(response=>{
            if(response.data.msg.indexOf("SUCCESS") != -1) {
                pendInfo = response.data.data.pendInfo;
                drBaseSubmitAsmsDTO = response.data.data.defectBaseInfo.drBaseSubmitAsmsDTO;
                acReg = response.data.data.defectBaseInfo.acReg;
                station = response.data.data.workOrder.station;
                for(let key in response.data.data.btnFlag){
                    if( $(`a[name=${key}]`) ){
                        if(response.data.data.btnFlag[key]){
                            $(`a[name=${key}]`).show()
                        }else{
                            $(`a[name=${key}]`).remove()
                        }
                    }
                }
            }else if(response.data.msg.indexOf("ERROR") != -1){
                throw new Error("查询基本信息失败")
            }
        }).catch(err=>{
            MsgAlert({type: "error", content: err.message})
        })
    }

	$(function(){
		$('#tt').tabs({
    			fit: true,
    		    border:true,
    		    onSelect:function(title){
		    }
		});
        get_buttons();
	})

</script>
</html>