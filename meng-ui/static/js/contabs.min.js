$(function () {

    $(".J_menuItem").each(function (k) {
        if (!$(this).attr("data-index")) {
            $(this).attr("data-index", k)
        }
    });

    $("#side-menu").on("click",".J_menuItem", c);

    $(".J_menuTabs").on("click", ".J_menuTab i", h); //删除


    $(".J_tabCloseOther").on("click", i);

    $(".J_tabShowActive").on("click", j);

    $(".J_menuTabs").on("click", ".J_menuTab", e);

    $(".J_menuTabs").on("dblclick", ".J_menuTab", d);
    $(".J_tabLeft").on("click", a);
    $(".J_tabRight").on("click", b);
    $(".J_tabCloseAll").on("click", function () {
        $(".page-tabs-content").children("[data-id]").not(":first").each(function () {
            $('.J_iframe[data-id="' + $(this).data("id") + '"]').remove();
            $(this).remove()
            clearTabParam($(this).data("id"));
        });
        $(".page-tabs-content").children("[data-id]:first").each(function () {
            $('.J_iframe[data-id="' + $(this).data("id") + '"]').show();
            $(this).addClass("active")
        });
        $(".page-tabs-content").css("margin-left", "0")
    })
});

function c() {
    var o = $(this).attr("href"), m = $(this).data("index") || '0', l = $.trim($(this).text()), k = true;
    if (o == undefined || $.trim(o).length == 0) {
        return false
    }
    createOrSelectTab_(o, m, l, k);
    return false
}

function d() {
    var l = $('.J_iframe[data-id="' + $(this).data("id") + '"]');
    var k = l.attr("src")
}

function i() {
    $(".page-tabs-content").children("[data-id]").not(":first").not(".active").each(function () {
        $('.J_iframe[data-id="' + $(this).data("id") + '"]').remove();
        $(this).remove()
        clearTabParam($(this).data("id"));
    });
    $(".page-tabs-content").css("margin-left", "0")
}

function e() {
    if (!$(this).hasClass("active")) {
        var k = $(this).data("id");
        $(".J_mainContent .J_iframe").each(function () {
            if ($(this).data("id") == k) {
                $(this).show().siblings(".J_iframe").hide();
                return false
            }
        });
        $(this).addClass("active").siblings(".J_menuTab").removeClass("active");
        g(this)
        minimizeEYWindows();
    }
}

function h() {
    var m = $(this).parents(".J_menuTab").data("id");
    var l = $(this).parents(".J_menuTab").width();
    if ($(this).parents(".J_menuTab").hasClass("active")) {//当前tabitem处于活动中
        if ($(this).parents(".J_menuTab").next(".J_menuTab").size()) {//当前要删除的tab next有tabitem
            var k = $(this).parents(".J_menuTab").next(".J_menuTab:eq(0)").data("id");
            $(this).parents(".J_menuTab").next(".J_menuTab:eq(0)").addClass("active");
            $(".J_mainContent .J_iframe").each(function () {
                if ($(this).data("id") == k) {
                    $(this).show().siblings(".J_iframe").hide();
                    return false
                }
            });
            var n = parseInt($(".page-tabs-content").css("margin-left"));
            if (n < 0) {
                $(".page-tabs-content").animate({marginLeft: (n + l) + "px"}, "fast")
            }
            $(this).parents(".J_menuTab").remove();
            $(".J_mainContent .J_iframe").each(function () {
                if ($(this).data("id") == m) {
                    $(this).remove();
                    clearTabParam(m);
                    return false
                }
            })
        }
        if ($(this).parents(".J_menuTab").prev(".J_menuTab").size()) {//当前要删除的tab prev有tabitem
            var k = $(this).parents(".J_menuTab").prev(".J_menuTab:last").data("id");
            $(this).parents(".J_menuTab").prev(".J_menuTab:last").addClass("active");
            $(".J_mainContent .J_iframe").each(function () {
                if ($(this).data("id") == k) {
                    $(this).show().siblings(".J_iframe").hide();
                    return false
                }
            });
            $(this).parents(".J_menuTab").remove();
            $(".J_mainContent .J_iframe").each(function () {
                if ($(this).data("id") == m) {
                    $(this).remove();
                    clearTabParam(m);
                    return false
                }
            })
        }
    } else {
        $(this).parents(".J_menuTab").remove();
        $(".J_mainContent .J_iframe").each(function () {
            if ($(this).data("id") == m) {
                $(this).remove();
                clearTabParam(m);
                return false
            }
        });
        g($(".J_menuTab.active"))
    }
    return false
}

function j() {
    g($(".J_menuTab.active"))
}

function f(l) {
    var k = 0;
    $(l).each(function () {
        k += $(this).outerWidth(true)
    });
    return k
}

function a() {
    var o = Math.abs(parseInt($(".page-tabs-content").css("margin-left")));
    var l = f($(".content-tabs").children().not(".J_menuTabs"));
    var k = $(".content-tabs").outerWidth(true) - l;
    var p = 0;
    if ($(".page-tabs-content").width() < k) {
        return false
    } else {
        var m = $(".J_menuTab:first");
        var n = 0;
        while ((n + $(m).outerWidth(true)) <= o) {
            n += $(m).outerWidth(true);
            m = $(m).next()
        }
        n = 0;
        if (f($(m).prevAll()) > k) {
            while ((n + $(m).outerWidth(true)) < (k) && m.length > 0) {
                n += $(m).outerWidth(true);
                m = $(m).prev()
            }
            p = f($(m).prevAll())
        }
    }
    $(".page-tabs-content").animate({marginLeft: 0 - p + "px"}, "fast")
}

function b() {
    var o = Math.abs(parseInt($(".page-tabs-content").css("margin-left")));
    var l = f($(".content-tabs").children().not(".J_menuTabs"));
    var k = $(".content-tabs").outerWidth(true) - l;
    var p = 0;
    if ($(".page-tabs-content").width() < k) {
        return false
    } else {
        var m = $(".J_menuTab:first");
        var n = 0;
        while ((n + $(m).outerWidth(true)) <= o) {
            n += $(m).outerWidth(true);
            m = $(m).next()
        }
        n = 0;
        while ((n + $(m).outerWidth(true)) < (k) && m.length > 0) {
            n += $(m).outerWidth(true);
            m = $(m).next()
        }
        p = f($(m).prevAll());
        if (p > 0) {
            $(".page-tabs-content").animate({marginLeft: 0 - p + "px"}, "fast")
        }
    }
}

function g(n) {
    var o = f($(n).prevAll()), q = f($(n).nextAll());
    var l = f($(".content-tabs").children().not(".J_menuTabs"));
    var k = $(".content-tabs").outerWidth(true) - l;
    var p = 0;
    if ($(".page-tabs-content").outerWidth() < k) {
        p = 0
    } else {
        if (q <= (k - $(n).outerWidth(true) - $(n).next().outerWidth(true))) {
            if ((k - $(n).next().outerWidth(true)) > q) {
                p = o;
                var m = n;
                while ((p - $(m).outerWidth()) > ($(".page-tabs-content").outerWidth() - k)) {
                    p -= $(m).prev().outerWidth();
                    m = $(m).prev()
                }
            }
        } else {
            if (o > (k - $(n).outerWidth(true) - $(n).prev().outerWidth(true))) {
                p = o - $(n).prev().outerWidth(true)
            }
        }
    }
    $(".page-tabs-content").animate({marginLeft: 0 - p + "px"}, "fast")
}

function createOrSelectTab(menuId, k, param){
    /*var $a = $("#side-menu li[ty='menu'] > a[data-index='"+menuId+"']");
    var url = $a.attr('href'); var title = $a.text();*/
    var menu = MenuDataMap[''+menuId];
    var url = menu ? menu.url : '';
    if(!url){ alert('无法打开对应菜单'); return; }
    var title = menu ? menu.name : '';
    var r = createOrSelectTab_(url, menu.id, title, k);
    createTabParam(r[1], param);
    if(r[0] == false){
        var $fm = $("iframe.J_iframe[data-id='"+r[1]+"']"); //刷新
        $fm.attr('src', $fm.attr('src'));
    }
}

/**
 * 创建或查找Tab
 * @param o 页面地址
 * @param m 标识索引index
 * @param l title标题
 * @param k 是否创建； 否：只查找当前已打开tab并选中
 */
function createOrSelectTab_(u, m, l, k, p){
    var o = new Base64().encode(u);
    $(".J_menuTab").each(function () {
        if ($(this).data("id") == o) {
            if (!$(this).hasClass("active")) {
                $(this).addClass("active").siblings(".J_menuTab").removeClass("active");
                g(this);
                $(".J_mainContent .J_iframe").each(function () {
                    if ($(this).data("id") == o) {
                        $(this).show().siblings(".J_iframe").hide();
                        return false
                    }
                });
            }
            k = false;
            return false
        }
    });
    if (k) {
        var mQ = $("#side-menu .J_menuItem[data-index='"+m+"'] span");
        var mainHeight = '100%'; //$(".J_mainContent").height();
        var p = '<a href="javascript:;" class="active J_menuTab" data-id="' + o + '" >' + '<span data-i18n="'+mQ.attr("data-i18n")+'">' + l + '</span> '
            +(p == undefined || p === true ? '<i class="fa fa-times-circle"></i>':'')+'</a>';
        $(".J_menuTab").removeClass("active");
        var n = '<iframe class="J_iframe" name="iframe' + o + '" width="100%" height="'+mainHeight+'" src="' + u + '" frameborder="0" data-id="' + o + '" seamless></iframe>';
        $(".J_mainContent").find("iframe.J_iframe").hide();
        $(".J_mainContent").append(n);
        $(".J_menuTabs .page-tabs-content").append(p);
        g($(".J_menuTab.active"))
    }
    minimizeEYWindows();
    return [k, o];
}

/**
 * @deprecated
 */
function minimizeEYWindows(){
    if(window.top.EY_WINDOWS){
        $.each(window.top.EY_WINDOWS, function(k,v){
            if(v){
                v.window('minimize');
            }
        });
    }
}

function closePWinodws(m){
    if(window.top.P_WINDOWS && window.top.P_WINDOWS[m]){
        $.each(window.top.P_WINDOWS[m], function(k,v){
            if(v.WINDOW && !v.WINDOW.closed){
                try{
                    v.WINDOW.close();
                }catch(e){}
            }
        });
        window.top.P_WINDOWS[m] = [];
    }
}

function closeAllPWindows() {
    if (window.top.P_WINDOWS) {
        $.each(window.top.P_WINDOWS, function (m, item) {
            $.each(item, function (k, v) {
                if (v.WINDOW && !v.WINDOW.closed) {
                    try {
                        v.WINDOW.close();
                    } catch (e) {
                    }
                }
            });
            window.top.P_WINDOWS[m] = [];
        });
    }
}

function createTabParam(pkey, param){
    document[pkey] = param;
}

function getTabParam(menuId){
    var menu = MenuDataMap[''+menuId];
    var url = menu ? menu.url : '';
    /*var $a = $("#side-menu li[ty='menu'] a[data-index='"+menuId+"']");
    var url = $a.attr('href');*/
    if(!url) {return;}
    var pkey = new Base64().encode(url);
    return document[pkey] || undefined;
}

function clearTabParam(pkey){
    if(document[pkey])
        document[pkey] = null;
    closePWinodws(pkey);
}