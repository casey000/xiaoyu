<!DOCTYPE html>
<html>
<!-- Mirrored , Wed, 20 Jan 2016 14:19:52 GMT -->
<head>
    <!--#include virtual="/views/items/header.shtml"-->
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script type="text/javascript">
        if (window.top !== window.self) {
            window.top.location = window.location;
        }
    </script>
    <style>
        html {
            background: url("/img/timg.png") no-repeat center center;
            background-size: cover;
        }

        .gray-bg {
            background: none;
        }

        .fadeInDown {
            padding: 0;
        }

        .allDiv {
            width: 900px;
            height: 310px;
            margin: 120px auto;
        }

        .allDiv .leftDiv {
            width: 550px;
            height: 310px;
            float: left;
            background: url("/img/timg.jpg") no-repeat center center;
            background-size: cover;
        }

        .allDiv .ritDiv {
            width: 350px;
            height: 310px;
            float: left;
            background: #fff;
        }

        .btn-primary {
            background: #2d3c5d;
        }
    </style>
</head>
<body class="gray-bg">
<div class="allDiv">
    <div style="position: absolute;right: -20px; bottom: 20px;"><img src="/img/bireturnLogo.png" width="70%"
                                                                     height="70%"></div>
    <div class="leftDiv"></div>
    <div class="middle-box text-center loginscreen  animated fadeInDown ritDiv">
        <div>
            <div>
                <h1 class="logo-name" style="font-size: 60px;letter-spacing: 2px;color: #2d3c5d;margin-top: 30px;">
                    TDMS</h1>
            </div>
            <h4 style="color: #cccccc">Technical Document Management System</h4>

            <form id="mform" class="m-t" role="form" action="#" method="post">
                <div class="form-group" style="width: 300px;margin: 10px auto">
                    <input type="username" name="username" class="form-control" value="admin" placeholder="用户名"
                           required="">
                </div>
                <div class="form-group" style="width: 300px;margin: 0px auto;margin-bottom: 10px;">

                    <input type="password" id="userPassword" name="userPassword" autocomplete="off" class="form-control"
                           value="" placeholder="密码"
                           required="">
                </div>
                <div class="form-group" style="width: 300px;margin: 0px auto;margin-bottom: 10px;">
                    <input type="hidden" name="vCode" class="form-control" id="vCode" value="1">
                    <!--<img id="imgcode" src="/verifyCode" style="margin-top:10px;">-->
                </div>
                <button type="submit" id="btnSubmit"
                        style="width: 300px;padding: 2px 0;margin: 0 auto;border-color: #2d3c5d;"
                        class="btn btn-primary block m-b">登 录
                </button>
                <p class="text-muted text-center"> <!--<a href="login_v2.shtml"><small>第二版登陆</small></a>-->
                </p>

            </form>
        </div>
    </div>
</div>
<script type="text/javascript">
    var IS_DEBUG = true;
    $(function () {
        $('#mform').form({
            onSubmit: function () {
                var isValidate = $(this).form('validate');
                if (isValidate) {
                    var data = $('#mform').serializeObject();
                    if (!IS_DEBUG && $.trim(data.vCode) == '') {
                        layer.msg("请输入验证码!", {icon: 5});
                        return;
                    }
                    if (IS_DEBUG) {
                        data.vCode = '1';
                    }

                    var loginUrl = "/api/v1/security/login";
                    if (new RegExp("^[0-9]*$").test(data.username)){
                        loginUrl = "/api/v1/security/ldap/login";
                    }
                    var mlg = JSON.stringify(data);
                    tdms_data = {"mlg": encodeStr(mlg)};

                    $("#btnSubmit").attr("disabled", true);
                    $("#btnSubmit").html("登 录 中 . . .");
                    InitGatewayRequest_({
                        path:"/user/auth/login",
                        data:{
                            "appKey":ENVGlobal.appKey,
                            "appSecret":ENVGlobal.appSecret,
                            "deviceId": "dumy",
                            "username": data.username,
                            "password": data.userPassword,
                            "vcode":data.vCode
                        }, successCallBack: function (jdata) {
                            if (jdata.success == true) {
                                debugger;
                                //获取网关登录的token
                                // window.gateway_token = jdata.obj.token;
                                sessionStorage.setItem('token',jdata.obj.token);
                                debugger
                                layerStandardAjaxCall_({
                                    url: loginUrl,
                                    data: tdms_data,
                                    success: function (jdata) {
                                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                                            window.location.href = "/views/home.shtml";
                                        } else {
                                            $("#btnSubmit").attr("disabled", false);
                                            $("#btnSubmit").html("登 录");
                                            if (!IS_DEBUG) {
                                                reloadImgCode();
                                            }
                                            var error_msg;
                                            if(jdata.msgData){
                                                error_msg = jdata.msgData[0];
                                            }else{
                                                error_msg = jdata.msg;
                                            }
                                            layer.msg(error_msg, {icon: 5});
                                        }
                                    }
                                });
                            } else {
                                $("#btnSubmit").attr("disabled", false);
                                $("#btnSubmit").html("登 录");
                                if (!IS_DEBUG) {
                                    reloadImgCode();
                                }
                                layer.msg(jdata.errorMessage, {icon: 5});
                            }
                        }
                    });
                }
                return false;
            }
        });
        // $("#btnSubmit").submit();
        if (!IS_DEBUG) {
            $('#imgcode').bind("click", function () {
                reloadImgCode();
            });
        }
    });

    function reloadImgCode() {
        $('#vCode').text('');
        $('#imgcode').attr('src', "/verifyCode?_t=" + new Date().getTime())
    }

    function encodeStr(str) {
        var _s = new Base64().encode(str);
        return hps(_s);
    }

</script>
</body>

<!-- Mirrored , Wed, 20 Jan 2016 14:19:52 GMT -->
</html>
