<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->

    <script type="text/javascript" src="/views/defect/comeFileTypeSelect.js"></script>
    <meta charset="UTF-8">
    <title>ADDCC</title>
    <link href="/css/nrc/nrc_add.css" rel="stylesheet">
    <link href="/css/nrc/addcc_close_dialog.css" rel="stylesheet">
    <style type="text/css">
        .cai_type label {
            margin-right: 20px;
        }

        .sousuo_div {
            position: absolute;
            top: 0px;
            left: 0px;
            right: 0px;
            bottom: 0px;
            padding-top: 8px;
            z-index: 10;
        }

        .zhezhao {
            display: none;
            position: absolute;
            z-index: 9;
            top: 0px;
            bottom: 0px;
            right: 0px;
            left: 0px;
        }

        #nrcNoZhezhao{
            width: 100%;
            height: 100%;
            background-color: #9999990d;
            /*border-left: 1px solid #CCCCCC;*/
            display: none;
            position: absolute;
            z-index: 9;
            top: 0px;
            right: 0px;
        }
        .red {
            color: red;
        }
        .zhezhao1,.zhezhao2 {
            display: none;
            background-color: #9999990d;
            position: absolute;
            z-index: 9;
            top: 0px;
            bottom: 0px;
            right: 0px;
            left: 0px;
        }
        #ata:focus{
            border-color: #BBBBBB;
            border-radius: 5px;
            box-shadow: 0 0 3px 0 #d4d4d4;
            outline: 0;
        }

    </style>
    <script src="../../../../../manual/src/main.ts"></script>
</head>
<body>
<div class="zhezhao" id="dazhehzao" onclick="zhezhao_hide()"></div>
<div class="zhezhao" id="zhezhao"></div>
<div class="nrc_div">
    <div style="display: none">
        <input id="ccid" type="text"/> <input class="easyui-textbox" id="ac_id"/>
        <input id="workorderId" type="text"/>
        <input id="tlbId" type="text"/>
        <input id="comeTypePush" type="text"/>
    </div>
    <table class="addnrc_table">
        <tbody>
        <tr style="display: none">
            <td class="key">来源文件</td>
            <td colspan="3" class="">
                <span id="doc_type"></span>
                <input class="easyui-textbox" id="docNo" readonly="readonly"/>
            </td>
            <td colspan="3">
            </td>
        </tr>
        <tr  id="comeFromFile">
            <td class="key" >来源文件类型</td>
            <td colspan="2" class="cai_type">
                <input class="easyui-textbox" id="comeType" readonly="readonly"  type="text">
            </td>
            <td class="key" >来源文件编号<span class="red">*</span></td>
            <td colspan="1" class="cai_type">
                <input class="easyui-textbox" id="comeTypeShow" readonly="readonly"  type="text">
                <img id="comeNumber" onClick="returnFileData('A',1)" src="/img/search.png" style="position: absolute;right: 30px;top: 11px;"/>
            </td>
            <td class="key" >TLB编号</td>
            <td colspan="1" class="cai_type">
                <input class="easyui-textbox" id="tlbNumber" readonly="readonly" type="text">
            </td>
        </tr>
        <tr>
            <td class="key" rowspan="2">拆换类型</td>
            <td colspan="2" class="cai_type"><input id="caixia" name="defect" type="radio" value="1"
                                                    onclick="caihuan_type(1)" checked="checked"><label
                    for="caixia">拆下</label><input
                    id="zhuangshang" name="defect" type="radio" value="2" onclick="caihuan_type(2)"><label
                    for="zhuangshang">装上</label>
                <input id="caihuan" name="defect" type="radio" value="3" onclick="caihuan_type(3)"><label for="caihuan">拆换</label><input
                        id="chuanjian" name="defect" type="radio" value="4" onclick="caihuan_type(4)"><label
                        for="chuanjian">串件</label>
            </td>
            <td colspan="4">
                <div id="ac_zhe" class="zhezhao"></div>
                <div style="float: left;width: 60%;">
                    <input id="feiji" name="aeType" onclick="acno_url('feiji')" type="radio" value="1"><label
                        for="feiji">飞机</label>

                    <input id="faji" name="aeType" onclick="acno_url('faji')" type="radio" value="2"><label
                        for="faji">部件</label>
                    <input class="easyui-combobox" id="acReg" name="acEng" style="width:50%" />
                </div>
            </td>
        </tr>

        <tr>
            <td>
                <div>
                    <span style="margin-left: 20px">航班号：</span>
                    <input class="easyui-textbox" readonly="readonly" id="nrcNo" style="width: 60%" type="text">
                </div>
                <div id="nrcNoZhezhao"></div>
            </td>
            <td colspan="1" class="newRebackNotShow">
                航站
                <span class="red">*</span>
                <input class="easyui-textbox" id="newStation" readonly="readonly" style="width: 70%" type="text">
                <img alt="" id="newStationBtn" onClick="stationQuery()" src="/img/search.png" style="position: absolute;right: 20px;top: 11px;"/>
            </td>
            <td colspan="4">
                <span style="width: 80px;display: inline-block;text-align: right">章节号：</span><span class="red">*</span>
                <input id="ata"  name="ata" class="easyui-textbox" maxlength="4" style="width:calc(70% - 4px); border: 1px solid #D4D4D4; line-height: 20px; vertical-align: middle; border-radius:5px;padding-left: 4px" type="text" value=""/>
                <!--                <input id="ata"  name="ata" maxlength="4" class="easyui-textbox" style="width: 70%;"/>-->
                <input type="hidden" id="flightId"/>
            </td>
<!--            <td colspan="1" class="rebackShow">-->
<!--                <div style="float: left;height:40px;line-height:40px;width: 100%;">-->
<!--                    是否退料-->
<!--                    <span class="red">*</span>-->
<!--                    <input id="yes" name="reback" type="radio" value="1" style="vertical-align: middle">是-->
<!--                    <input id="no" name="reback" type="radio" value="2" style="vertical-align: middle">否-->
<!--                </div>-->
<!--            </td>-->
        </tr>
        <!--     --------------  拆下部件分割线---------------------------->

        <tr class="tr_caixia">
            <td class="key" rowspan="3">拆下部件</td>
            <td colspan="2">
                <div id="jian_name1"></div>
            </td>
            <td colspan="2">
                <div class="zhezhao1"></div>
                <span style="width: 80px;display: inline-block;text-align: right">件号：</span><span class="red">*</span>
                <input class="easyui-textbox" id="original1" style="width: 70%" type="text" disabled>
                <img alt="" class="fangdajin" id="acBtn" onClick="pn_data('A',1)" src="/img/search.png"/>

            </td>

            <td colspan="2">
                <div class="zhezhao1"></div>
                序号<span class="red">*</span><input class="easyui-textbox" id="stazone" name="stazone" style="width: 60%"
                                                   type="text"><span style="margin-left:10px;vertical-align: middle" class="unknowSn"><input id="unknowSn" name="defect" type="checkbox" value="1" style="vertical-align: middle" onclick="unknowSnClick()"
            >未知</span>

            </td>

        </tr>

        <tr class="tr_caixia">
            <td class="rebackNotShow" colspan="2">构型<span class="red">*</span><input class="easyui-combobox no_entry" id="gouxin" name="skill"
                                                                                     style="width: 70%"/></td>
            <td colspan="4" class="rebackNotShow">位置<span class="red">*</span>
                <input class="easyui-textbox " id="weizhi" name="skill" style="width: 70%"/>
            </td>

            <td colspan="2" class="rebackShow">
                <div style="float: left;height:40px;line-height:40px;width:100%;">
                    构型
                    <span class="red">*</span>
                    <input class="easyui-combobox no_entry" id="gouxin3" name="skill" style="width: 70%"/></div>
            </td>
            <td colspan="4" class="rebackShow">
                <div style="float: left;height:40px;line-height:40px;width:100%;">
                    位置
                    <span class="red">*</span>
                    <input class="easyui-textbox " id="weizhi3" name="skill" style="width: 70%"/>
                </div>
            </td>
        </tr>
<!--        调整拆换，增加拆下挂签故障原因-->
        <tr  class="tr_caixia">
            <td colspan="2" class="rebackShow">
                <div style="float: left;height:40px;line-height:40px;width: 100%;" onclick="checkIsBack()">
                    是否退料
                    <span class="red">*</span>
                    <input id="yes" name="reback" type="radio" value="1" style="vertical-align: middle">
                    <label for="yes">是</label>
                    <input id="no" name="reback" type="radio" value="2" style="vertical-align: middle">
                    <label for="no">否</label>
                </div>
            </td>
            <td colspan="4" class="rebackShow">
                <div style="text-align: left;display: none" class="chaixiaReason">拆下挂签里的拆下故障原因<span class="red">*</span>
                    <textarea id="faultReason"  style="height: 50px"></textarea>
                </div>
            </td>
        </tr>

        <tr class="tr_caixia">
            <td class="key" rowspan="1">下级组件</td>
            <td colspan="6">
                <div style="max-height: 180px;overflow: auto;">
                    <table class="addnrc_table" id="caixia_zujian">
                        <tr class="sub_title">
                            <td class="key">件号名称 <img alt="" class="fangdajin" onClick="cai_jian_name(1,'cai_name_div')"
                                                      src="/img/search.png"/>
                                <div class="sousuo_div" id="cai_name_div" style="display:none;"><input class="beiliao"
                                                                                                       id="cai_name_in"
                                                                                                       onblur="cai_jian_input('cai')"
                                                                                                       name="stazone"
                                                                                                       style="width: 85%"
                                                                                                       type="text">
                                </div>
                            </td>
                            <td class="key">件号 <img alt="" class="fangdajin" onClick="cai_jian_name(2,'cai_jian_div')"
                                                    src="/img/search.png"/>
                                <div class="sousuo_div" id="cai_jian_div" style="display:none;"><input class="beiliao"
                                                                                                       id="cai_jian_in"
                                                                                                       onblur="cai_jian_input('cai')"
                                                                                                       name="stazone"
                                                                                                       style="width: 85%"
                                                                                                       type="text">
                                </div>
                            </td>
                            <td class="key">序号 <img alt="" class="fangdajin" onClick="cai_jian_name(3,'cai_xu_div')"
                                                    src="/img/search.png"/>
                                <div class="sousuo_div" id="cai_xu_div" style="display:none;"><input class="beiliao"
                                                                                                     id="cai_xu_in"
                                                                                                     onblur="cai_jian_input('cai')"
                                                                                                     name="stazone"
                                                                                                     style="width: 85%"
                                                                                                     type="text"></div>
                            </td>
                            <td class="key" style="width: 60px;">部件状态</td>
                            <td class="key" style="width: 80px;">航材状态</td>
                            <td class="key">装上件号</td>
                            <td class="key">装上序号</td>
                            <td class="key" style="width: 100px;">是否退料</td>
                        </tr>
                    </table>
                </div>
            </td>

        </tr>

        <!--     --------------  装上部件分割线---------------------------->
        <tr class="tr_zhuangshang">
            <td class="key" rowspan="2">装上部件</td>
            <td colspan="2">
                <!--                <input class="easyui-textbox" readonly="readonly" id="jian_name2" style="width: 70%"-->
                <!--                       type="text"></td>-->
                <div id="jian_name2"></div>
            </td>
            <td colspan="2">
                <div class="zhezhao2"></div>
                <div style="width: 80px;display: inline-block;text-align: right" id="zhuangshang_PN">
                    <span>件号：</span>
                </div><span class="red">*</span>
                <input class="easyui-textbox" id="original2" style="width: 70%" type="text" disabled>
                <img alt="" class="fangdajin" id="acBtn2" onClick="pn_data('B',2)" src="/img/search.png"/>

            </td>

            <td colspan="2">
                <div class="zhezhao2"></div>
                序号<span class="red">*</span><input class="easyui-textbox" id="stazone2" name="stazone"
                                                   style="width: 70%" type="text">

            </td>

        </tr>
        <tr class="tr_zhuangshang">
            <td colspan="2">构型<span class="red">*</span><input class="easyui-combobox no_entry" id="gouxin2" name="skill"
                                                               style="width: 70%"/></td>
            <td colspan="4">位置<span class="red">*</span>
                <input class="easyui-textbox " id="weizhi2" name="skill" style="width: 70%"/></td>
        </tr>

        <tr class="tr_zhuangshang" id="zs_prohibited">
            <td>禁限装放行理由<span class="red">*</span></td>
            <td colspan="5">
                <textarea  style="height: 50px" id="releaseReason"></textarea>
            </td>
        </tr>
        <tr class="tr_zhuangshang"  >
            <td class="key" rowspan="1">下级组件</td>
            <td colspan="6">
                <div style="max-height: 180px;overflow: auto;">
                    <table class="addnrc_table" id="zhuang_zujian">
                        <td class="key">件号名称 <img alt="" class="fangdajin" onClick="cai_jian_name(4,'zhuang_name_div')"
                                                  src="/img/search.png"/>
                            <div class="sousuo_div" id="zhuang_name_div" style="display:none;"><input class="beiliao"
                                                                                                      id="zhuang_name_in"
                                                                                                      onblur="cai_jian_input('zhuang')"
                                                                                                      name="stazone"
                                                                                                      style="width: 85%"
                                                                                                      type="text"></div>
                        </td>
                        <td class="key">件号 <img alt="" class="fangdajin" onClick="cai_jian_name(5,'zhuang_jian_div')"
                                                src="/img/search.png"/>
                            <div class="sousuo_div" id="zhuang_jian_div" style="display:none;"><input class="beiliao"
                                                                                                      id="zhuang_jian_in"
                                                                                                      onblur="cai_jian_input('zhuang')"
                                                                                                      name="stazone"
                                                                                                      style="width: 85%"
                                                                                                      type="text"></div>
                        </td>
                        <td class="key">序号 <img alt="" class="fangdajin" onClick="cai_jian_name(6,'zhuang_xu_div')"
                                                src="/img/search.png"/>
                            <div class="sousuo_div" id="zhuang_xu_div" style="display:none;"><input class="beiliao"
                                                                                                    id="zhuang_xu_in"
                                                                                                    onblur="cai_jian_input('zhuang')"
                                                                                                    name="stazone"
                                                                                                    style="width: 85%"
                                                                                                    type="text">
                            </div>
                        </td>
                        <td class="key" style="width: 60px;">部件状态</td>
                        <td class="key" style="width: 80px;">航材状态</td>
                        <td class="key">装上件号</td>
                        <td class="key">装上序号</td>
                        <td class="key" style="width: 100px;">是否退料</td>
                    </table>
                </div>
            </td>
        </tr>
        <!--     --------------  代码分割---------------------------->
        <tr class="">
            <td class="key">
                <div >计划性<span class="red">*</span></div>
            </td>
            <td>
                <div ><input class="easyui-combobox no_entry" id="jihua" name="skill"
                             style="width: 85%"/></div>
            </td>
            <td>
                <div class="zhuanghide">拆换原因<span class="red">*</span><input class="easyui-combobox no_entry" id="caihuanyuanyin"
                                                                             name="skill"
                                                                             style="width: 70%"/></div>
            </td>
            <td>
                <div class="zhuanghide">航材状态<span class="red">*</span><input class="easyui-combobox no_entry" id="hangcaitype"
                                                                             name="skill"
                                                                             style="width: 70%"/></div>
            </td>
            <td>工作者<span class="red">*</span><input class="easyui-textbox easyui-validatebox"
                                                    data-options="validType:['maxLength[20]'] "
                                                    id="repSn" name="repSn" style=" width:70%;"/><input
                    style="display: none" id="repname"/></td>
            <td colspan="2">拆换时间<span class="red">*</span><input class="easyui-datetimebox" id="rep_date" name="repTime"
                                                                 style="width: 70%" type="text"></td>
        </tr>
        <tr>
            <td class="key">原因描述<span class="red">*</span></td>
            <td colspan="6">
                <textarea id="rectChn" name="rectChn" style="height: 50px"></textarea>
            </td>
        </tr>
        <tr>
            <td class="key">措施<span class="red">*</span></td>
            <td colspan="6">
                <textarea id="cuoshi" name="rectChn" style="height: 50px"></textarea>
            </td>
        </tr>
        <tr>
            <td class="key">备注</td>
            <td colspan="6">
                <textarea id="beizhu" name="rectChn" style="height: 50px"></textarea>
            </td>
        </tr>
        <tr>
            <td class="key">附件</td>
            <td colspan="6" id="attachament_td">
                <div id="attach_file">

                </div>
            </td>
        </tr>
        </tbody>
    </table>
    <div class="button_a" style="position: relative">
        <a class="save display_button" style="display: none" onclick="save(1)">保存</a>
        <a class="submit display_button"  style="display: none"  onclick="save(3)">关闭</a>
        <!--<a class="save display_button" onclick="save(2)">关闭</a>-->
        <!--        <a class="save display_button" onclick="ccdelete()">删除</a>-->
    </div>
</div>

<div class="lift_Dialog">
    <div class="lift_mask"></div>
    <div class="lift_content">
        <div>请确认救生筏是否需要退回航材库房</div>
        <div  style="text-align: center;margin-top: 30px">
            <a onclick="liferaftpn(1)" class="linkbutton">确认</a>
            <a onclick="liferaftpn(2)" class="linkbutton" style="margin-left: 20px">取消</a>
        </div>
    </div>
</div>

<div class="force_Dialog">
    <div class="lift_mask"></div>
    <div class="force_content">
        <div class="msgTips"></div>
        <div  class="msgTipsSub" style="text-align: center;margin-top: 20px">
            <a onclick="forceSubmin(1)" class="linkbutton" style="background-color: #ce3c3c">是</a>
            <a onclick="forceSubmin(2)" class="linkbutton" style="margin-left: 20px">否</a>
        </div>
    </div>
</div>
<div class="remarkDialogLoad">
    <div class="remarkModal"></div>
    <span>加载中...</span>
</div>

<script src="/js/plugins/ajaxfileupload/ajaxfileupload.js" type="text/javascript"></script>
<script src="../../../js/datagrid_utils.js" type="text/javascript"></script>
<script src="/js/common/query_data_dict.js" type="text/javascript"></script>
<script type="text/javascript">
    const air_material_state_list = [
        {
            label: "离位",
            value: "离位"
        },
        {
            label: "拆换",
            value: "拆换"
        },
        {
            label: "待观察件",
            value: "WDISPOSE"
        }
    ];
    var jiahua_list = [] ;
    var hangcaitype_list = [] ;
    var caihuanyuanyin_list =[];
    var liferaftpn_list = [];
    var releasetype_list = [];
    var prohibitedMark="";
    var WorkOrderData = {};
    let cc_varags = {
        cai: 'cai',
        zhuang: 'zhuang',
        on_part: 'ON',
        off_part: 'OFF'
    };
    var params = getParentParam_();
    var caixialist = [];
    var zhuanshanglist = [];
    var acRegData=[];//保存飞机和部件下拉数据
    var acfeiji="";//保存飞机，便于重新赋值
    var acfaji="";
    var acfaji_pn="";//保存部件 件号，便于重新赋值
    var acfaji_sn="";//保存部件 序号，便于重新赋值
    var saveNum="";//存save方法的入参
    var saveData=[];//存save方法调接口的data
    var forceCode="";//存强制关闭的code码
    var ataGet = "";//临时保存ATA信息
    var comefromPage = "";
    var taskNumber = "";
    var sapTaskId = "";
    $(function () {
        // 优先加载数据字典
        queryDataDict({
            "domainCode": "AIR_MATERIAL_STATE,CC_PLAN_TYPE,CC_SOURCE_TYPE,AIR_MATERIAL_PROPERTIES,LIFE_RAFT_PN,RELEASE_TYPE", "functionCode": "ANALYSIS_DOMAIN_BYCODE",
            succFn:function(data){
                if(data){
                    // air_material_state_list = data.AIR_MATERIAL_PROPERTIES;
                    jiahua_list = data.CC_PLAN_TYPE;
                    hangcaitype_list = data.AIR_MATERIAL_STATE;
                    caihuanyuanyin_list = data.CC_SOURCE_TYPE;
                    liferaftpn_list=data.LIFE_RAFT_PN;
                    releasetype_list=data.RELEASE_TYPE;

                }
            }
        });
        //获取工单中的工作航站
        if(params.hasOwnProperty('orderId')){
            getWorkData();
        };

        caihuan_type(1);
        add_atta_input_flie();
        selectAta();
        $("#repSn").MyComboGrid({
            idField: 'USER_NAME',  //实际选择值
            textField: 'USER_NAME', //文本显示值
            panelHeight: '180px',
            required: true,
            width: "70%",
            params: {FunctionCode: 'FLOW_WORK_ACCOUNT'},
            columns: [[
                {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                {field: 'USER_NAME', title: '审核人', width: 50}
            ]],
            onHidePanel: function () {
                var t = $(this).combogrid('getValue');
                if (t != null && t != '' & t != undefined) {
                    if (selectRow == null || t != selectRow.USER_NAME) {//没有选择或者选项不相等时清除内容
                        alert('请选择，不要直接输入！');
                        $(this).combogrid({value: ''});
                    }
                }
            },
            onSelect: function (index, row) {
                selectRow = row;
                $("#repname").val(row.ACCOUNT_NUMBER);
            }
        });
        $("#hangcaitype").combobox({
            valueField: 'VALUE',
            textField: 'TEXT',
            panelHeight: '70px',
            data: hangcaitype_list,
            onSelect:function(item){
                let offPn=$("#original1").textbox("getValue");
                for(let i=0;i<liferaftpn_list.length;i++) {//遍历救生筏件号
                    if (liferaftpn_list[i].VALUE ==offPn&&item.VALUE==hangcaitype_list[0].VALUE) {//拆下件号
                        $("#no").click();//救生筏 退料 可用 设置为否
                        break;
                    }
                }
            }
        });
        $("#jihua").combobox({
            valueField: 'VALUE',
            textField: 'TEXT',
            panelHeight: '70px',
            data: jiahua_list,
        });
        //类型为CCO时，录CC时，计划默认为计划性且不可修改
        let jx_flag = jiahua_list.find((item)=>{
            return item.VALUE == '2';
        });
        if(params.docType == 11 && jx_flag && jx_flag.VALUE == '2'){
            $("#jihua").combobox({ disabled: true });
            $("#jihua").combobox("setValue", '2');
        }
        $("#caihuanyuanyin").combobox({
            valueField: 'VALUE',
            textField: 'TEXT',
            panelHeight: '150px',
            data: caihuanyuanyin_list,
        });
        if (params.hasOwnProperty('id')) {
            post_date(params.id,"state");//加state是为了第一次加载时，不清空拆下 位置
            $("#ccid").val(params.id);
            add_file_show(params.id);
            // if (params.type == "see") {
            //     // $("#zhezhao").show();
            //     viewOnly();
            //     $(".button_a").hide();
            //     $(".fangdajin").hide();
            // }
            // $("#ac_zhe").show();
            ac_zheShow();
        }else {
            // $("#ac_zhe").hide();
            ac_zheHide();
            $("#nrcNoZhezhao").show();
            $('.submit').remove();
            beizhuAndCuoshi();
        }
        if (params.hasOwnProperty('defect_info')) {
            if(params.defect_info.hasOwnProperty('station')&&params.defect_info.hasOwnProperty('ata')){
                ataAndStation(params.defect_info);
                beizhuAndCuoshi();
            }
            taskNumber = params.defect_info.taskNumber||"";
            sapTaskId  = params.defect_info.sapTaskId ||"";
            var _actype = params.defect_info.acType || '1';

            if(_actype == 1 && params.defect_info.acId){
                // 来源于飞机位置
                initPgaeParam();
            }else{
                //来源于部件位置
                if(params.docNo){
                    $.ajax({
                        type: "GET",
                        url: "/api/v1/compCc/queryComp/"+ params.docType+"/"+params.docNo,
                        contentType: "application/json;charset=utf-8",
                        dataType: "json",
                        success: function (data) {

                            if(data.code == 200){
                                $("#faji").prop("checked", true);
                                if(data.data){
                                    let pn_sn="("+data.data.pn+")"+data.data.sn;

                                    // $("#acReg").textbox("setValue", pn_sn);
                                    acfaji_pn=data.data.pn;
                                    acfaji_sn=data.data.sn;
                                    acfaji=pn_sn;
                                    ac_model(pn_sn,[],"faji");//
                                    $('#ac_id').textbox('setValue', data.data.equipmentId);

                                }
                            }else {
                                MsgAlert({type: "warn", content: "找不到部件信息，无法创建CC，请确认该部件是否已经进入设备库。 " })
                                // alert('找不到发动机信息，无法创建CC，请确认该发动机是否已经进入设备库。');
                            }

                        },
                        error: function (obj) {
                            alert("失败！");
                        }
                    });
                }

            }
        }

        if ($("#docNo").val()) {
            // $("#ac_zhe").show();
            $("#nrcNoZhezhao").show();
        }
        $('.save,.submit').show();
        //工单id
        assignmentWorkId(params);
        initBothCome(params);
        comeFileTypeNumberTlbShow();
    });
    var lisr_file = 0;
    //来源于飞机位置
    function initPgaeParam(){
        if (params.hasOwnProperty('defect_info')) {
            $("#flightId").val(params.defect_info.flightId);
            $("#nrcNo").textbox("setValue", params.defect_info.flightNo);
            // $('#rectChn').val(params.defect_info.reasonChn);
            // $('#cuoshi').val(params.defect_info.actionChn);
            // beizhuAndCuoshi();
            // $("#acReg").textbox("setValue", params.defect_info.ac);

            $('#ac_id').textbox('setValue', params.defect_info.acId);
            $("#docNo").val(params.docNo);
            if (params.defect_info.workorderId) {
                $('#workorderId').val(params.defect_info.workorderId);
            }
            // assignmentWorkId(params.defect_info);
            if (params.defect_info.acType && params.defect_info.acType == 2) {
                $("#faji").prop("checked", true);
                // console.log(acfaji);
                // acfaji="";//给保存部件的变量赋值
            }else{
                $("#feiji").prop("checked", true);
                acfeiji=params.defect_info.ac;//给保存飞机的变量赋值
            }
            ac_model(params.defect_info.ac,[],"feiji");
            if (params.docType) {
                $("#docNo").textbox("setValue", params.docNo);
                //来源文件类型,
                var docType =  {1: 'TLB', 2: 'NRC', 3: 'CC', 4: 'EO', 5: 'JC', 6: 'Defect', 7: 'PCO', 8: 'NRCT', 9: 'TO', 10: 'DDREVIEW', 11: 'CCO'};
                $('#doc_type').html(docType[params.docType]);
                $("#comeType").textbox("setValue", docType[params.docType]||"");
            }
            if (!$('#rectChn').val()) {
                //$(window.opener.document).find('#taskDes').text()
                if ($(window.opener.document).find('#taskDes').text()) {
                    $('#rectChn').val($(window.opener.document).find('#taskDes').text());
                }
            }
        }
    }

    function textbox_() {
        //拆下件号
        $("#original1").textbox({
            onChange: function (obj) {
                if(obj!=""&& obj!=undefined){
                    $("#original1").textbox("setValue", $.trim($("#original1").textbox("getValue")));
                    if($("#stazone").textbox("getValue")==""){
                        caixia_gouxin(obj, "");
                    }else {
                        caixia_gouxin( obj, "");
                        caixia_weizhi(obj,"no");
                    }
                }
            }
        });
        // 拆下序号
        $("#stazone").textbox({
            onChange: function (obj) {
                if (obj != "" && obj != undefined) {
                    $("#stazone").textbox("setValue", $.trim($("#stazone").textbox("getValue")));
                    if ($("#original1").textbox("getValue") == "") {
                    } else {
                        caixia_gouxin($("#original1").textbox("getValue"), "");
                        caixia_weizhi($("#original1").textbox("getValue"), "no");
                    }
                }
            }
        });
        //装上件号
        $("#original2").textbox({
            onChange: function (obj) {
                if(obj!="" && obj!=undefined){
                    $("#original2").textbox("setValue", $.trim($("#original2").textbox("getValue")));
                    zhuang_gouxin(  obj, "");
                }
            }
        });
        //装上序号
        $("#stazone2").textbox({
            onChange: function (obj) {
                if(obj!=""&& obj!=undefined){
                    $("#stazone2").textbox("setValue", $.trim($("#stazone2").textbox("getValue")));
                    if ($("#original2").textbox("getValue") != "") {
                        //先移除上一次追加的禁限装tr 和 隐藏 放行tr
                        $(".addnrc_table tr.removeprohibitedTr").remove(".removeprohibitedTr");
                        $("#zs_prohibited").hide();
                        prohibitedItem($("#original2").textbox("getValue"),obj);
                        caixia_weizhi($("#original2").textbox("getValue"), "no", 'ON');
                    }
                }
            }
        });

        $(".no_entry").combobox({
            required: true,
            editable: false,
        })
        //类型为CCO时，录CC时，计划默认为计划性且不可修改
        let jx_flag = jiahua_list.find((item)=>{
            return item.VALUE == '2';
        });
        if(params.docType == 11 && jx_flag && jx_flag.VALUE == '2'){
            $("#jihua").combobox({ disabled: true });
            $("#jihua").combobox("setValue", '2');
        }
    }
    function caihuan_type(inde) {
        if (inde == 1) {
            $(".tr_caixia").show();
            $(".tr_zhuangshang").hide();
            $(".zhuanghide").show();
            $(".rebackNotShow").hide();
            $(".rebackShow").show();
            $(".unknowSn").show();

        } else if (inde == 2) {
            $(".tr_caixia").hide();
            $(".tr_zhuangshang").show();
            if(prohibitedMark=="XZ"){
                $("#zs_prohibited").show();
            }else{
                $("#zs_prohibited").hide();
            }

            $(".zhuanghide").hide();
            $(".rebackNotShow").show();
            $(".rebackShow").hide();
            $(".unknowSn").hide();
        } else if (inde == 3) {
            $(".tr_caixia").show();
            $(".tr_zhuangshang").show();
            if(prohibitedMark=="XZ"){
                $("#zs_prohibited").show();
            }else{
                $("#zs_prohibited").hide();
            }
            $(".zhuanghide").show();
            $(".rebackNotShow").hide();
            $(".rebackShow").show();
            $(".unknowSn").show();
        } else {
            $(".tr_caixia").show();
            $(".tr_zhuangshang").show();
            if(prohibitedMark=="XZ"){
                $("#zs_prohibited").show();
            }else{
                $("#zs_prohibited").hide();
            }
            $(".zhuanghide").hide();
            $(".rebackNotShow").show();
            $(".rebackShow").hide();
            $(".unknowSn").hide();
        }
        unknowSnClick();
        textbox_();
    }
    //进来直接看到的添加附件功能
    function add_file(i) {
        let file = " <div id=\"atta_input_flie_" + i + "\" class=\"atta_input_fliecss\">\n" +
            "       <input class=\"textbox easyui-validatebox\" type=\"file\" id=\"atta_input_flie_a" + i + "\" size=\"300\" name=\"file\" data-options=\"required:true\"/>            \n" +
            "                    <div class=\"add_jiahao\" onclick=\"add_atta_input_flie()\" style='margin-top: 5px'></div>\n" +
            " <div class='file_duihao' onclick=\"atta_input_flie('atta_input_flie_a'+" + i + ")\">✔</div>\n" +
            "                    <div class=\"jianhao icon-delete\" onclick=\"delete_atta_input_flie(atta_input_flie_" + i + ")\" style='margin-top: 4px'></div>\n" +
            "                </div>";
        let html_row = $(file);
        $("#attachament_td").append(html_row);
    }
    //附件上传增加按钮
    function add_atta_input_flie() {
        add_file(lisr_file);
        lisr_file++;
    }
    //附件上传删除按钮
    function delete_atta_input_flie(val) {
        let geshu = document.getElementsByClassName('atta_input_fliecss');
        if (geshu.length == 1) {
            return
        }
        let newP = $(val);
        if (newP.length > 0) {
            newP.remove();
        }
    }

    //附件上传打钩按钮
    function atta_input_flie(id) {

        if ($("#ccid").val() != "") {
            var fileInput = $("#" + id).get(0).files[0];
            if (fileInput) {
                $.ajaxFileUpload({
                    url: Constant.API_URL + 'ATTACHMENT_UPLOAD',
                    secureuri: false,
                    fileElementId: id, //file控件id
                    dataType: 'json',
                    data: {
                        "fileCategory": "TLB_COMP_CC",
                        "sourceId": getParentParam_().id,
                    },
                    success: function (data) {
                        if (data.code == 200) {
                            var file = document.getElementById("" + id + "");
                            file.value = '';
                            $("#" + id).value = "";
                            add_file_show(getParentParam_().id);
                        }

                    }

                })
            } else {
                alert("请选择上传文件！");
            }
        } else {
            alert("请先保存，在上传附件！")
        }

    }


    function add_file_show(id) {
        $("#attach_file").empty();
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: id,
                CATEGORY: "TLB_COMP_CC",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                for (var ind in jdata.data) {
                    let file = " <div id=\"input_flie_show" + jdata.data[ind].PKID + "\" class=\"atta_input_fliecss\" style=\"line-height: 30px;width: 100%;    height: 30px;border-bottom: 1px solid #ccc;\">\n" +
                        "                            <div style=\"width: 60%;text-align: left;\"><a style=\"color:red;font-size: 14px\" onclick=\"downFile(" + jdata.data[ind].PKID + "," + jdata.data[ind].PKID + ")\">" + jdata.data[ind].ORG_NAME + "</a></div>\n" +
                        "\n" +
                        "                        <div class=\"jianhao icon-delete\" onclick=\"deleteFile(" + jdata.data[ind].PKID + ")\"></div>\n" +
                        "                        </div>";
                    let html_row = $(file);
                    $("#attach_file").append(html_row);
                }
                if (params.type == "see") {
                    // $("#zhezhao").show();
                    viewOnly();
                    $(".button_a").hide();
                    $(".fangdajin").hide();
                }
            }
        });
    }

    function reload_() {
        add_file_show(getParentParam_().id);
    }

    /**
     * 下级件页面渲染
     * @param index
     * @param ccType    cai :拆下母件下级件；zhuang：装上母件下级件
     */
    function caixia_zujian_list(index, ccType) {
        ccType = ccType || cc_varags.cai;
        let pn_date_type = 'C';
        let zujian = $("  <tr class='caixia_tr sub_comp_tr' id=\"caixia_tr" + index + "\"></tr>");
        if (ccType == cc_varags.zhuang) {
            zujian = $("  <tr class='zhuang_tr sub_comp_tr' id=\"zhuang_tr" + index + "\"></tr>");
            pn_date_type = 'D';
        }
        zujian.append('<td ><span id="' + ccType + '_name' + index + '"></span></td>');
        zujian.append('<td ><span id="' + ccType + '_jian' + index + '"></span></td>');
        zujian.append('<td ><span id="' + ccType + '_xu' + index + '"></span></td>');

        zujian.append('<td ><input class="easyui-combobox" id="' + ccType + '_skill' + index + '"  name="skill" style="width: 85%"/></td>');
        zujian.append('<td ><div class="sub_zhuanghide" style="display: none" ><span class="red">*</span><input class="easyui-combobox no_entry ' + ccType + '" id="sub_hangcaitype' + index + '" name="sub_hangcaitype" style="width: 70px"/></div></td>');

        zujian.append('<td ><div class="sub_replace ' + ccType + '" ><input class="easyui-textbox no_entry" id="' + ccType + '_original' + index + '" style="width: 85%" type="text"> ' +
            '   <img alt="" class="fangdajin" id="' + ccType + '_acBtn' + index + '" onClick="pn_data(\'' + pn_date_type + '\',' + index + ')"  src="/img/search.png" /></div></td>');
        zujian.append('  <td ><div class="sub_replace" ><input class="easyui-textbox no_entry_iuput" id="' + ccType + '_stazone' + index + '" name="stazone" style="width: 85%" type="text"></div></td>');
        zujian.append('  <td ><div class="sub_reback"> <input id="' + ccType + '_yes' + index + '" name="sub_reback_' + ccType +index+'" type="radio" value="1" style="vertical-align: middle">是<input id="' + ccType + '_no' + index + '" name="sub_reback_' + ccType +index+'" type="radio" value="2" style="vertical-align: middle">否</td>');
        /*  */
        if (ccType == cc_varags.cai) {
            $("#caixia_zujian").append(zujian);
        } else if (ccType == cc_varags.zhuang) {
            $("#zhuang_zujian").append(zujian);
        }
        $("#" + ccType + "_original" + index).textbox();
        $("#" + ccType + "_stazone" + index).textbox();
        $('#' + ccType + '_skill' + index).combobox({
            required: true,
            valueField: 'id',
            textField: 'text',
            panelHeight: '70px',
            editable: false,
            onSelect: function (e) {
                $(this).closest('tr').find('.sub_zhuanghide').hide();
                $(this).closest('tr').find('.sub_replace').hide();
                $(this).closest('tr').find('.sub_reback').hide();
                if (e.id == 1 || e.id == 2) {// 下级航材状态
                    $(this).closest('tr').find('.sub_zhuanghide').show();
                    //当离位或者拆换时 必须设置是否退料
                    $(this).closest('tr').find('.sub_reback').show();
                } else {
                    $(this).closest('tr').find('[id*="sub_hangcaitype"]').textbox('setValue', '');
                }

                if (e.id == 2) {// 拆换时，显示装上件序号，否则隐藏，并清空
                    $(this).closest('tr').find('.sub_replace').show();
                }
            },
            data: [{id: 1, text: "离位"}, {id: 2, text: "拆换"}, {id: 3, text: "跟随",selected:"seletced"}],
        });
        $("#sub_hangcaitype" + index + "." + ccType).combobox({
            required: true,
            editable: false,
            valueField: 'VALUE',
            textField: 'TEXT',
            panelHeight: '70px',
            data: hangcaitype_list,
        });
        $(".no_entry", zujian).combobox({required: true});
        $(".no_entry_iuput", zujian).textbox({required: true});

    }

    var shuzu = [];         // 拆下母件的下级件集合
    var on_shuzu = [];     // 装上母件的下级件集合
    // 母件件页面渲染及查询下级件
    function build_sub_comp(data, partType) {
        let arr = [];

        for (let i in data.data) {
            arr.push({
                "name": data.data[i].pnName,
                "offAssetId": "",
                "offPn": "",
                "offPnId": "",
                "offPosition": "",
                "offSn": "",
                "onAssetId": "",
                "onCin": "",
                "onPn": data.data[i].pn,
                "onPnId": "",
                "onPositon": "",
                "onSn": data.data[i].sn,
                "ppart": partType,
                "status": "",
            });
            if (partType == 'OFF') {
                caixia_zujian_list(i);
                $("#cai_name" + i).text(data.data[i].pnName);
                $("#cai_jian" + i).text(data.data[i].pn);
                $("#cai_xu" + i).text(data.data[i].sn);
                $("#cai_name" + i).closest('tr').find('.sub_replace').hide();
                $("#cai_name" + i).closest('tr').find('.sub_reback').hide();
            } else if (partType == 'ON') {
                caixia_zujian_list(i, cc_varags.zhuang);
                $("#zhuang_name" + i).text(data.data[i].pnName);
                $("#zhuang_jian" + i).text(data.data[i].pn);
                $("#zhuang_xu" + i).text(data.data[i].sn);
                $("#zhuang_name" + i).closest('tr').find('.sub_replace').hide();
                $("#zhuang_name" + i).closest('tr').find('.sub_reback').hide();
            }

        }
        return arr;
    }

    /**
     * 件号选择后事件
     */
    function pn_data(type, ind) {
        $.pnSelect({
            success: function (data) {
                if (type == "A") {
                    $("#original" + ind).textbox('setValue', data.partno);
                    // $("#jian_name" + ind).textbox('setValue', data.description);
                    var nameA=data.udchndesc.trim();
                    $("#jian_name" + ind).html(nameA);
                    if ($("#stazone").textbox("getValue")) {
                        caixia_gouxin( data.partno, "");
                        caixia_weizhi(data.partno, "no", 'OFF');
                    }

                    //航材状态为可用时，选中的件号为救生筏
                    let airMaterialState=$("#hangcaitype").combobox("getValue");
                    for(let i=0;i<liferaftpn_list.length;i++) {//遍历救生筏件号
                        if (liferaftpn_list[i].VALUE ==data.partno&&airMaterialState==hangcaitype_list[0].VALUE) {//拆下件号
                            $("#no").click();//救生筏 退料 可用 设置为否
                            break;
                        }
                    }

                } else if (type == "B") {
                    $("#original" + ind).textbox('setValue', data.partno);
                    // $("#jian_name" + ind).textbox('setValue', data.description);
                    var nameA=data.udchndesc.trim();
                    $("#jian_name" + ind).html(nameA);
                    zhuang_gouxin(data.partno, "");

                    //先移除上一次追加的禁限装tr 和 隐藏 放行tr
                    $(".addnrc_table tr.removeprohibitedTr").remove(".removeprohibitedTr");
                    $("#zs_prohibited").hide();

                    if ($("#stazone2").textbox("getValue")) {
                        caixia_weizhi(data.partno, "no", 'ON');
                        let sn=$("#stazone2").textbox("getValue");
                        prohibitedItem(data.partno,sn);//查禁限装
                    }

                } else if (type == "C") {
                    $("#cai_original" + ind).textbox('setValue', data.partno);
                } else if (type == "D") {
                    $("#zhuang_original" + ind).textbox('setValue', data.partno);
                }

            }
        })
    }

    function setCinAndWeiZhi(_data, cin,gouxinId,weizhiId,state){
        _data = _data || [];
        _data.push({
            "cin": "其他",
            "equipmentId": "",
            "pn": "",
            "sn": "",
            "actualCin":false,
            "location": ""
        });
        if(!state){
            $("#weizhi").textbox("setValue", '');
            $("#weizhi3").textbox("setValue", '');
        }

        $('#gouxin').combobox({
            valueField: 'cin',
            textField: 'cin',
            data: _data,
            value: cin,
            onSelect: function (obj) {
                $("#weizhi").textbox("readonly",true);
                if(!obj.actualCin){
                    $("#weizhi").textbox("readonly",false);
                }
                $("#weizhi").textbox("setValue", obj.location);
            }
        });
        $('#gouxin3').combobox({
            valueField: 'cin',
            textField: 'cin',
            data: _data,
            value: cin,
            onSelect: function (obj) {
                $("#weizhi3").textbox("readonly",true);
                if(!obj.actualCin){
                    $("#weizhi3").textbox("readonly",false);
                }
                $("#weizhi3").textbox("setValue", obj.location);
            }
        });
    }
    /*拆下母件实装构型查询*/
    function caixia_gouxin(pn,cin,state) {
        if(getParentParam_()&&getParentParam_().type == 'see'){
            return ;
        }

        var acReg = $("#acReg").textbox("getValue");
        if(!acReg){
            console.warn("允装构型查询飞机或在库上级件信息不能为空");
            return;
        }
        var sn = $("#stazone").textbox("getValue");
        if ($('#unknowSn').is(':checked')) {
            setCinAndWeiZhi([], cin, 'gouxin', 'weizhi',state);
            return;
        } else if (!sn) {
            return;
        }
        var d_ = {
            "aircraft": acReg,
            "equipmentId": "",
            "pn": pn,
            "sn": sn,
            "type": "B"
        };
        if (acTypeCheck() == '2') {
            d_ = {
                "sn": sn,
                "equipmentId": $("#ac_id").textbox("getValue"),
                "pnsnId": $("#ac_id").textbox("getValue"),
                "pn": pn,
                "type": "B"
            };
        }
        $.ajax({
            type: "POST",
            url: "/api/v1/configurationData/getActualCin",
            data: JSON.stringify(d_),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {

                setCinAndWeiZhi(data.data, cin, 'gouxin', 'weizhi',state);
                if(data.code == 200){

                }else {
                    alert(data.msg);
                }

            },
            error: function (obj) {
                alert("失败！");
            }
        });
    }

    function acTypeCheck() {
        var acType = $('[name="aeType"]:checked').val() || '';
        return acType;
    }
    /*装上母件允装构型查询*/
    function zhuang_gouxin( pn, cin) {
        if(getParentParam_()&&getParentParam_().type == 'see'){
            return ;
        }
        if(!pn){
            console.warn("允装构型查询件号不能为空");
            return;
        }
        var acReg = $("#acReg").textbox("getValue");
        if(!acReg){
            console.warn("允装构型查询飞机或在库上级件信息不能为空");
            return;
        }
        var d_ = {
            "aircraft": acReg,
            "pn": pn
        };
        if (acTypeCheck() == '2') {
            d_ = {
                "equipmentId": $("#ac_id").textbox("getValue"),
                "pn": pn
            };
        }

        $.ajax({
            type: "POST",
            url: "/api/v1/configurationData/getPermittedCin",
            data: JSON.stringify(d_),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                data.data.push({
                    "cin": "其他",
                    "equipmentId": "",
                    "pn": "",
                    "sn": "",
                    "actualCin":false,
                    "location": ""
                });
                $('#gouxin2').combobox({
                    valueField: 'cin',
                    textField: 'cin',
                    data: data.data,
                    value: cin,
                    onSelect: function (obj) {
                        $("#weizhi2").textbox("readonly",true);
                        if(!obj.actualCin){
                            $("#weizhi2").textbox("readonly",false);
                        }
                        $("#weizhi2").textbox("setValue", obj.location);
                    }
                });
                if(data.code == 200){

                }else {
                    alert(data.msg);
                }
            },
            error: function (obj) {
                alert("失败！");
            }
        });
    }

    /**
     * 根据母件查询下级件
     * @param pn
     * @param type
     * @param partType      ON 装上母件；OFF拆下母件
     */
    function caixia_weizhi(pn, type, partType) {      //获取下级组件
        partType = partType || 'OFF';// 默认拆下件的下级件
        var _sn = $("#stazone").textbox("getValue");
        if (partType == 'ON') {
            _sn = $("#stazone2").textbox("getValue");
        }
        $.ajax({
            type: "POST",
            url: "/api/v1/configurationData/getActualCin",
            data: JSON.stringify({
                "equipmentId": "",
                "pn": pn,
                "sn": _sn,
                "type": "C"
            }),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (partType == 'OFF') {
                    shuzu = [];
                } else if (partType == 'ON') {
                    on_shuzu = [];
                }

                if(data.code == 200){
                    if (partType == 'OFF') {
                        $(".caixia_tr").remove();
                        shuzu = build_sub_comp(data, partType);
                    } else if (partType == 'ON') {
                        $(".zhuang_tr").remove();
                        on_shuzu = build_sub_comp(data, partType);
                    }
                }else {
                    alert(data.msg);
                }
            },
            error: function (obj) {
                alert("失败！");
            }
        });
    }


    function cai_jian_name(inde, id) {      //拆下件名称搜索
        $("#" + id).show().find('input').select();
        $("#dazhehzao").show();
    }

    function zhezhao_hide() {
        $(".sousuo_div").hide();
        $("#dazhehzao").hide();
    }

    function cai_jian_input(obj) {
        let name = "";
        let jian = "";
        let xu = "";
        //    $(".caixia_tr").hide();
        if (obj == cc_varags.cai) {
            name = $("#cai_name_in").val();
            jian = $("#cai_jian_in").val();
            xu = $("#cai_xu_in").val();
            filter("caixia_zujian", name, jian, xu);
        } else {
            name = $("#zhuang_name_in").val();
            jian = $("#zhuang_jian_in").val();
            xu = $("#zhuang_xu_in").val();
            filter("zhuang_zujian", name, jian, xu);
        }


    }


    function filter(tlble, pn, sn, pos) {
        //.date_tr 数据显示行，用于区分标题行
        $("#" + tlble + " tr.sub_comp_tr").each(function (i, e) {
            $(e).hide();
            if (filterTr(e, pn, sn, pos)) {
                $(e).show();
            }
        })
    }

    function filterTr(tr, pn, sn, pos) {
        var flag = filterFlag(tr, pn, $(tr).find('td').eq(0).text());
        flag = flag && filterFlag(tr, sn, $(tr).find('td').eq(1).text());
        flag = flag && filterFlag(tr, pos, $(tr).find('td').eq(2).text());
        return flag;
    }

    function filterFlag(tr, val, id) {
        // 值为空时，无需过滤
        if (!val || !id) return true;

        if (id.indexOf(val) != -1) {
            return true
        } else {
            return false
        }
    }

    //
    function liferaftpn(index) {
        if(index==1){
            compCcadd(saveNum,saveData);
        }else{
            $("#no").click();//救生筏 退料 可用 ，关闭点取消 重置默认为否
            $(".lift_Dialog").hide();
        }
    }

    function compCcadd(indx,data) {//保存或者关闭调用接口单独写方法
        let url = "/api/v1/compCc/add";
        if (getParentParam_().hasOwnProperty('id')) {
            url = "/api/v1/compCc/update";
            data.tlbCompCc.id = getParentParam_().id;
        }
        $.ajax({
            type: "POST",
            url: url,
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(data),
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    if (indx == 1) {
                        alert("成功！");
                        if (typeof params.successCallback == "function") params.successCallback();
                        if (typeof params.OWindow.queryCCTable == "function") params.OWindow.queryCCTable();
                        if (typeof params.OWindow.Refresh == "function") params.OWindow.Refresh();


                        // parent && parent.window.colsa_window && parent.window.colsa_window();
                        window.close();
                    } else if (indx == 2) {
                        ccClose();
                    } else {
                        submin();
                    }

                } else if (data.msgData && data.msgData[0]) {
                    alert(data.msgData[0]);
                } else {
                    alert(data.msg);
                }
            },
            error: function () {
                window.alert("保存失败！");
            }
        });
    }

    function save(indx) {
        if(!no_null()){
            return ;
        };

        //校验拆换的时候件号不一致的提醒功能
        if($("#caihuan").is(":checked")&&($("#original2").textbox("getValue") != $("#original1").textbox("getValue"))){//如果是拆换
            if(!confirm("装上件和拆下件不一致，请确认装上件是否满足IPC适用性。")){
                return false;
            }
        };

        let data = {
            tlbCompCcSubList: [],
            tlbCompCc: {
                "airMaterialState": $("#hangcaitype").combobox("getValue"),
                "ata":  $("#ata").textbox("getValue")||params.defect_info.ata ,
                "autoConfirm": "",
                "ccId": "",
                "ccNo": "",
                "cin": $("#gouxin").textbox("getValue") || $("#gouxin3").textbox("getValue"),
                "completeDate": $("#rep_date").textbox("getValue"),
                // "completeWhere": $("#station").val() || $("#station3").val(),
                "completeWhere": $("#newStation").val(),
                "createTime": "",
                "createdId": "",
                "defectId": "",
                "flightId": $("#flightId").val(),
                "flightNo": $("#nrcNo").textbox("getValue"),
                "focus": "",
                "ignoreReason": "",
                "jobId": "",
                "middleStatus": "",
                "offAcId": $('#ac_id').textbox('getValue'),
                "offAssetId": "",
                // "offName": $("#jian_name1").textbox("getValue"),
                "offName": $("#jian_name1").html(),
                "offPn": $("#original1").textbox("getValue"),
                "offPnId": "",
                "offPosition": $("#weizhi").textbox("getValue") || $("#weizhi3").textbox("getValue"),
                "offSn": $("#stazone").textbox("getValue"),
                "onAcId": $('#ac_id').textbox('getValue'),
                "onAcType": "",
                "onAssetId": "",
                "onCin": $("#gouxin2").textbox("getValue"),
                "onModel": $("#acReg").textbox("getValue"),
                // "onName": $("#jian_name2").textbox("getValue"),
                "onName": $("#jian_name2").html(),
                "onPn": $("#original2").textbox("getValue"),
                "onPnId": "",
                "onPosition": $("#weizhi2").textbox("getValue"),
                "onSn": $("#stazone2").textbox("getValue"),
                "opttype": "",
                "planType": $("#jihua").combobox("getValue"),
                "reason": $("#rectChn").val(),
                "refCcNo": "",
                "referId": "",
                "referType": "",
                "remark": $("#beizhu").val(),
                "status": "",
                "takenAction": $("#cuoshi").val(),
                "updatedId": "",
                "workerId": $("#repname").val(),
                "workerName": $("#repSn").combogrid('getValue'),
                "workingReason": $("#caihuanyuanyin").combobox("getValue"),
                "docType": params.docType ||$("#comeTypePush").val()|| "",
                "tlbId": params.defect_info.tlbId ||$("#tlbId").val()|| "",
                "docNo": $("#docNo").val() || "",//工卡编号
                "tlbNo":$("#tlbNumber").val()||"",//tlb编号
                // "docType":$("#comeType").val()||"",//工卡类型

            }

        };
        data.tlbCompCc.workorderId = $('#workorderId').val() || '';
        if ($("#caixia").is(":checked")) {
            data.tlbCompCc.ccType = 1;
            if($("#yes").is(':checked')){
                data.tlbCompCc.giveBack = 'Y';
                data.tlbCompCc.defectReason = $("#faultReason").val()||"";
            }else if($("#no").is(':checked')){
                data.tlbCompCc.giveBack = 'N';
                data.tlbCompCc.defectReason = "";
            }
            if($('#unknowSn').is(':checked')){
                data.tlbCompCc.unknowSn = 'Y';
            }else{
                data.tlbCompCc.unknowSn = 'N';
            }
        } else if ($("#zhuangshang").is(":checked")) {
            data.tlbCompCc.ccType = 2;
        } else if ($("#caihuan").is(":checked")) {
            data.tlbCompCc.ccType = 3;
            if($("#yes").is(':checked')){
                data.tlbCompCc.giveBack = 'Y';
                data.tlbCompCc.defectReason = $("#faultReason").val()||"";
            }else if($("#no").is(':checked')){
                data.tlbCompCc.giveBack = 'N';
                data.tlbCompCc.defectReason = "";
            }
            if($('#unknowSn').is(':checked')){
                data.tlbCompCc.unknowSn = 'Y';
            }else{
                data.tlbCompCc.unknowSn = 'N';
            }
        } else {
            data.tlbCompCc.ccType = 4;
        }
        if(data.tlbCompCc.ccType!=1){
            data.tlbCompCc.releaseType="";
            data.tlbCompCc.releaseReason=$("#releaseReason").val();
        }

        if ($("#feiji").is(":checked")) {
            data.tlbCompCc.offAcType = 1;
            data.tlbCompCc.onAcType = 1;
        } else if ($("#faji").is(":checked")) {
            data.tlbCompCc.offAcType = 2;
            data.tlbCompCc.onAcType = 2;
            if(indx ==1 ){//保存按钮
                let acreg=$("#acReg").textbox("getValue");
                // console.log(acRegData);
                if(acRegData.length>0){
                    acRegData.map((item,key,acRegData)=>{
                        if(acreg==acRegData[key].tail){
                            data.tlbCompCc.opttype=acRegData[key].model;
                        }

                    })
                }
                if(acfaji_pn&&acfaji_sn){
                    data.tlbCompCc.opttype=acfaji_pn;
                    data.tlbCompCc.onModel=acfaji_sn;
                }

            }
        }
        //拆下件下级件
        if ($("#caixia").is(":checked") || $("#caihuan").is(":checked") || $("#chuanjian").is(":checked")) {
            data.tlbCompCcSubList = [];
            for (let i in shuzu) {
                let subObj = shuzu[i];
                subObj.offPn = $("#cai_original" + i).textbox("getValue");
                subObj.offSn = $("#cai_stazone" + i).textbox("getValue");
                subObj.status = $("#cai_skill" + i).textbox("getValue");
                subObj.ppart = 'OFF';
                subObj.airMaterialState = $('#sub_hangcaitype' + i + ".cai").combobox("getValue");
                if (subObj.status != 2) {
                    subObj.offPn = '';
                    subObj.offSn = '';
                }
                if(subObj.status != 3){
                    //如果退料没有勾选
                    if(!($("#cai_yes" + i).is(':checked') || $("#cai_no" + i).is(':checked'))){
                        alert("拆下部件下级组件是否退料必须勾选！");
                        return false;
                    }
                }
                if(subObj.status != 3){
                    if($("#cai_yes" + i).is(':checked')){
                        subObj.giveBack = 'Y';
                    }else if($("#cai_no" + i).is(':checked')){
                        subObj.giveBack = 'N';
                    }
                }else{
                    subObj.giveBack = '';
                }
                data.tlbCompCcSubList.push(subObj);
            }

        }
        //装上件下级件
        if ($("#zhuangshang").is(":checked") || $("#caihuan").is(":checked") || $("#chuanjian").is(":checked")) {
            if (!data.tlbCompCcSubList) {
                data.tlbCompCcSubList = [];
            }
            for (let i in on_shuzu) {
                let subObj = on_shuzu[i];
                subObj.offPn = $("#zhuang_original" + i).textbox("getValue");
                subObj.offSn = $("#zhuang_stazone" + i).textbox("getValue");
                subObj.status = $("#zhuang_skill" + i).textbox("getValue");
                subObj.ppart = 'ON';
                subObj.airMaterialState = $('#sub_hangcaitype' + i + ".zhuang").combobox("getValue");
                if (subObj.status != 2) {
                    subObj.offPn = '';
                    subObj.offSn = '';
                }
                if(subObj.status != 3){
                    //如果退料没有勾选
                    if(!($("#zhuang_yes" + i).is(':checked') || $("#zhuang_no" + i).is(':checked'))){
                        alert("装上部件下级组件是否退料必须勾选！");
                        return false;
                    };
                }
                if(subObj.status != 3){
                    if($("#zhuang_yes" + i).is(':checked')){
                        subObj.giveBack = 'Y';
                    }else if($("#zhuang_no" + i).is(':checked')){
                        subObj.giveBack = 'N';
                    }
                }else{
                    subObj.giveBack = '';
                }
                data.tlbCompCcSubList.push(subObj);
            }

        }
        //来源文件类型
        if (comefromPage == "cc_list" && params.type == "add" && !data.tlbCompCc.docNo) {
            alert("来源文件必选！");
            return false;
        }
        if($("#caixia").is(":checked") || $("#caihuan").is(":checked")){
            if($("#yes").is(':checked')&& !$("#faultReason").val()){
                alert("拆下挂签里的拆下故障原因必填！");
                return false;
            }
        }
        saveNum=indx;
        saveData=data;
        console.log("saveNum：",saveNum);
        console.log("saveData：",saveData);
        //新增或者编辑CC时，拆下/拆换类型，救生筏件号，可用件、退料。CC提交时需要弹出提示框
        if($("#caixia").is(":checked") || $("#caihuan").is(":checked")){
            let k=1;
            for(let i=0;i<liferaftpn_list.length;i++){//遍历救生筏件号
                if(liferaftpn_list[i].VALUE==data.tlbCompCc.offPn){//拆下件号

                    //航材为可用并且选退料状态
                    if(data.tlbCompCc.airMaterialState==hangcaitype_list[0].VALUE&&data.tlbCompCc.giveBack == 'Y'){
                        $(".lift_Dialog").show();
                    }else{
                        compCcadd(indx,data);
                    }

                }else{
                    if(k==liferaftpn_list.length){
                        compCcadd(indx,data);
                    }
                    k+=1;
                }
            }

        }else{
            compCcadd(indx,data);
        }
    }
    //点击是否退料联动“拆下挂签里的拆下故障原因”
    function checkIsBack() {
        if($("#yes").is(':checked')){
            $(".chaixiaReason").show();
        }else if($("#no").is(':checked')){
            $(".chaixiaReason").hide();
        }
    }

    function acno_url(type_ac) {      //飞机与发动机选择组件
        // var type_ac = "";
        let url_ac = "";
        if ($("#feiji").is(":checked")) {//飞机
            // $("#ac_zhe").hide();
            ac_zheHide();
            $("#nrcNoZhezhao").hide();
            url_ac = "/api/v1/plugins/FLB_AC_LIST";
            // type_ac = false;
        } else if ($("#faji").is(":checked")) {//发动机 部件
            // $("#ac_zhe").hide();
            ac_zheHide();
            $("#nrcNoZhezhao").hide();
            url_ac = "/api/v1/plugins/SAP_COMP_LIST";// cc查询SAP设备库所有部件
            // type_ac = true;
        }

        //控制上游带过来飞机或者部件，不允许修改，
        let feijiVal="";
        if(type_ac=="faji"){
            feijiVal=acfaji;
            if(!acfaji){
                ac_modelQuery(type_ac,feijiVal,url_ac);
            }else{
                acRegData=[];
                ac_model(feijiVal,[],type_ac);
            }

        }else {
            feijiVal=acfeiji;
            if(!acfeiji){
                ac_modelQuery(type_ac,feijiVal,url_ac);
            }else{
                acRegData=[];
                ac_model(feijiVal,[],type_ac);
            }
        }


    }

    //飞机或者部件 下拉数据接口  star
    function ac_modelQuery(type_ac,feijiVal,url_ac) {
        $.ajax({
            type: "POST",
            url:url_ac ,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    if(data.data){
                        acRegData=data.data;
                    }
                    if(type_ac=="faji"){
                        acRegData.map((item,key,acRegData)=>{
                            acRegData[key].pn_sn="("+acRegData[key].model+")"+acRegData[key].tail;
                        });
                    }else {
                        acRegData.map((item,key,acRegData)=>{
                            acRegData[key].pn_sn=acRegData[key].tail;
                        });
                    }
                    ac_model(feijiVal,acRegData,type_ac);

                } else{
                    ac_model(feijiVal,[],type_ac);
                }
            },
            error: function () {
                ac_model(feijiVal,[],type_ac);
            }
        });
    }
    //飞机或者部件 下拉数据接口  end

    //飞机或者部件 下拉框数据渲染 star
    function ac_model(val,data,type) {
        var selectVal;
        if(acfaji&&type=="faji"){//发动机或者部件
            $('#acReg').combobox({disabled:true});
        }else if(acfeiji&&type=="feiji"){//飞机
            $('#acReg').combobox({disabled:true});
        }else{
            $('#acReg').combobox({disabled:false});
        }

        $("#acReg").combobox({
            valueField: 'tail',
            textField: 'pn_sn',
            value:val,
            data:data,
            prompt: '请先选择查询类型飞机或者发动机',
            onHidePanel:function(){
                var t = $(this).combobox('getValue');
                if (selectVal==undefined || selectVal == null ||  t != selectVal.tail) {//没有选择或者选项不相等时清除内容
                    if(acfaji&&type=="faji"){//发动机或者部件
                        $(this).combobox({value: acfaji});
                    }else if(acfeiji&&type=="feiji"){//飞机
                        $(this).combobox({value: acfeiji});
                    }else{
                        $(this).combobox({value: ''});
                    }
                }


            },
            onSelect: function (val) {
                selectVal=val;
                $('#ac_id').textbox('setValue', val.acId);

                if (type) {

                    $('#ac_type_input').textbox('setValue', val.model);
                } else {
                    $('#ac_type_input').textbox('setValue', val.model);
                }

            }
        });


    }
    //飞机或者部件 下拉框数据渲染 end


    function build_post_sub_comp(subList, ccType) {
        if (!subList || subList.length == 0) {
            return;
        }
        ccType = ccType || cc_varags.cai;
        for (let i in subList) {
            caixia_zujian_list(i, ccType);
            $("#" + ccType + "_name" + i).text(subList[i].name);
            $("#" + ccType + "_jian" + i).text(subList[i].onPn);
            $("#" + ccType + "_xu" + i).text(subList[i].onSn);

            $("#" + ccType + "_original" + i).textbox("setValue", subList[i].offPn);
            $("#" + ccType + "_stazone" + i).textbox("setValue", subList[i].offSn);
            $('#' + ccType + '_skill' + i).combobox("setValue", subList[i].status);
            // 下级件航材状态
            if (subList[i].airMaterialState) {
                $('#sub_hangcaitype' + i + "." + ccType).combobox("setValue", subList[i].airMaterialState);
            }

            $("#" + ccType + "_name" + i).closest('tr').find('.sub_replace').hide();
            $("#sub_hangcaitype" + i + "." + ccType).closest('div').hide();

            if (subList[i].status == 1 || subList[i].status == 2) {

                if(ccType==cc_varags.cai){
                    $(".zhezhao1").show();
                }else if(ccType==cc_varags.zhuang){
                    $(".zhezhao2").show();
                }

                $("#sub_hangcaitype" + i + "." + ccType).closest('div').show();
                if (subList[i].status == 2) {
                    $("#" + ccType + "_name" + i).closest('tr').find('.sub_replace').show();
                }
                $("#"+ccType+"_yes"+i).closest('tr').find('.sub_reback').show();
                if(subList[i].giveBack == 'Y'){
                    $("#"+ccType+"_yes"+i).prop("checked", true);
                }else if(subList[i].giveBack == 'N'){
                    $("#"+ccType+"_no"+i).prop("checked", true);
                }
            }
            if(subList[i].status == 3){
                $("#"+ccType+"_yes"+i).closest('tr').find('.sub_reback').hide();
            }
        }

    }

    /*基于tlb的ID传递只有新增自带参数才能传递原则，扩展编辑页面进行参数赋值*/
    function postParams(cc){
        if(!cc || !cc.tlbId){
            return ;
        }
        if(params){
            if(!params.defect_info){
                params.defect_info = {};
            }
            params.defect_info.tlbId = cc.tlbId;
        }

    }

    function post_date(id,state) {
        $.ajax({
            type: "GET",
            url: "/api/v1/compCc/selectById/" + id,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    shuzu = [];
                    on_shuzu = [];
                    let dataobj = data.data.tlbCompCc;
                    postParams(data.data.tlbCompCc);
                    if (dataobj.offAcType == 1 || dataobj.onAcType == 1) {
                        $("#feiji").prop("checked", true);
                    } else if (dataobj.offAcType == 2 || dataobj.onAcType == 2) {
                        $("#faji").prop("checked", true);
                    }
                    if (dataobj.offAcId) {
                        $('#ac_id').textbox('setValue', dataobj.offAcId);
                    } else if (dataobj.onAcId) {
                        $('#ac_id').textbox('setValue', dataobj.onAcId);
                    }
                    if(dataobj.ccType == 1 || dataobj.ccType == 3){
                        $(".unknowSn").show();
                        if(dataobj.unknowSn == 'Y'){
                            $("#unknowSn").prop("checked", true);
                        }else if(dataobj.unknowSn == 'N'){
                            $("#unknowSn").prop("checked", false);
                        }
                        if(dataobj.giveBack == 'Y'){
                            $("#yes").prop("checked", true);
                        }else if(dataobj.giveBack == 'N'){
                            $("#no").prop("checked", true);
                        }
                    }
                    checkIsBack();
                    // acno_url();
                    caihuan_type(dataobj.ccType);
                    if(dataobj.ccType!=1){
                        releaseType=dataobj.releaseType;
                        releaseReason=dataobj.releaseReason;
                        if(!dataobj.releaseType){
                            releaseType="";
                        }
                        if(!dataobj.releaseReason){
                            releaseReason="";
                        }
                        prohibitedItem(dataobj.onPn,dataobj.onSn,releaseType,releaseReason);//编辑第一次查询 禁限装


                    }
                    $("#ata").textbox("setValue", dataobj.ata);
                    // ataGet = dataobj.ata;
                    $("#flightId").val(dataobj.flightId);
                    $("#nrcNo").textbox("setValue", dataobj.flightNo);
                    $("#acReg").textbox("setValue", dataobj.onModel);
                    // acfaji=dataobj.onModel;
                    // console.log(acfaji);
                    // $("#station").textbox("setValue",dataobj.completeWhere);
                    // $("#station3").textbox("setValue",dataobj.completeWhere);

                    $("#newStation").textbox("setValue",dataobj.completeWhere);
                    $("#rep_date").textbox("setValue", dataobj.completeDate);
                    // $("#jian_name1").textbox("setValue", dataobj.offName);
                    $("#jian_name1").html(dataobj.offName);
                    $("#original1").textbox("initValue", dataobj.offPn);
                    $("#stazone").textbox("initValue", dataobj.offSn);
                    $("#weizhi").textbox("setValue", dataobj.offPosition);
                    $("#weizhi3").textbox("setValue", dataobj.offPosition);
                    $("#jihua").combobox("setValue", dataobj.planType);
                    $("#caihuanyuanyin").combobox("setValue", dataobj.workingReason);
                    $("#hangcaitype").combobox("setValue", dataobj.airMaterialState);
                    $("#repSn").textbox("setValue", dataobj.workerName);
                    // $("#jian_name2").textbox("setValue", dataobj.onName);
                    $("#jian_name2").html(dataobj.onName);
                    $("#original2").textbox("initValue", dataobj.onPn);
                    $("#stazone2").textbox("initValue", dataobj.onSn);
                    $("#weizhi2").textbox("setValue", dataobj.onPosition);
                    $("#repname").val(dataobj.workerId);
                    $("#faultReason").val(dataobj.defectReason||"");
                    // $("#rectChn").val(dataobj.reason);
                    // $("#cuoshi").val(dataobj.takenAction);
                    $("#beizhu").val(dataobj.remark);
                    //备注和措施在添加和编辑状态不同start
                    // if(params.operation == "add"){
                    //     $("#beizhu").val(params.defect_info.descChn);
                    //     $("#cuoshi").val(params.defect_info.rectFinishChn);
                    // }else if(params.operation == "edit"){
                    //     $("#beizhu").val(dataobj.remark);
                    //     $("#cuoshi").val(dataobj.takenAction);
                    // }

                    beizhuAndCuoshi(dataobj);
                    //备注和措施在添加和编辑状态不同end
                    $("#docNo").val(dataobj.docNo);

                    $('#workorderId').val(dataobj.workorderId);

                    if ($("#docNo").val() || dataobj.ccNo) {
                        // $("#ac_zhe").show();
                        ac_zheShow();
                        $("#nrcNoZhezhao").hide();
                    }
                    if (dataobj.docType) {
                        $("#docNo").textbox("setValue", dataobj.docNo);
                        if(params)params.docType = dataobj.docType;
                        //来源文件类型,
                        var docType =  {1: 'TLB', 2: 'NRC', 3: 'IMPORT', 4: 'EO', 5: 'JC', 6: 'Defect', 7: 'TO'};
                        $('#doc_type').html(docType[dataobj.docType]);
                        $("#comeType").textbox("setValue", docType[dataobj.docType]||"");
                        $("#comeTypePush").val(docType[dataobj.docType]||"");
                    }
                    $("#comeTypeShow").textbox("setValue", dataobj.docNo||"");
                    $("#tlbNumber").textbox("setValue", dataobj.tlbNo||"");
                    $("#tlbId").val(dataobj.tlbId||"");
                    for (let i in data.data.tlbCompCcSubList) {
                        if (data.data.tlbCompCcSubList[i].ppart == "ON" || data.data.tlbCompCcSubList[i].pPart == "ON") {
                            on_shuzu.push(data.data.tlbCompCcSubList[i]);
                        } else {
                            shuzu.push(data.data.tlbCompCcSubList[i]);
                        }
                    }

                    build_post_sub_comp(shuzu, cc_varags.cai);
                    build_post_sub_comp(on_shuzu, cc_varags.zhuang);
                    // shuzu = caixialist;
                    // on_shuzu = zhuanshanglist;

                    if(dataobj.status == 'y'){
                        $('.save,.submit').remove();
                    }

                    if(dataobj.middleStatus && dataobj.middleStatus != 'O'){
                        $('.save').remove();
                    }
                    if(dataobj.middleStatus == 'W'){
                        $('.submit').remove();
                    }

                    $('.save,.submit').show();
                    if (dataobj.cin) {
                        $('#gouxin').combobox('setValue', dataobj.cin);
                        $('#gouxin3').combobox('setValue', dataobj.cin);
                    }
                    if (dataobj.onCin) {
                        $('#gouxin2').combobox('setValue', dataobj.onCin);
                    }
                    if (dataobj.ccType == 1) {
                        $("#caixia").prop("checked", true);
                        if (dataobj.cin) {
                            $('#gouxin').combobox('setValue', dataobj.cin);
                        }
                        //todo 进入页面重加载构型与位置，是否必要
                        // caixia_gouxin( dataobj.offPn,  dataobj.cin);

                    } else if (dataobj.ccType == 2) {
                        $("#zhuangshang").prop("checked", true);
                        zhuang_gouxin( dataobj.onPn,dataobj.onCin);

                    } else if (dataobj.ccType == 3) {
                        $("#caihuan").prop("checked", true);
                        caixia_gouxin( dataobj.offPn,  dataobj.cin,state);

                        zhuang_gouxin( dataobj.onPn,dataobj.onCin);
                    } else {
                        $("#chuanjian").prop("checked", true);
                        caixia_gouxin( dataobj.offPn,  dataobj.cin,state);
                        zhuang_gouxin( dataobj.onPn,dataobj.onCin);
                    }



                } else {
                    window.alert("查询失败:" + data.msg);
                }

            },
            error: function () {
                window.alert("查询失败！");
            }
        });
    }

    function ccClose() {
        if (confirm("确定关闭吗")) {
            $.ajax({
                type: "GET",
                url: "/api/v1/compCc/close/" + getParentParam_().id,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if (data.code == 200) {
                        alert("关闭成功！");
                        window.close();
                    } else {
                        if(data.msg){
                            alert(data.msg);
                        }else{
                            alert("关闭失败");
                        }
                    }
                },
                error: function () {
                    window.alert("失败！");
                }
            });
        }
    }

    function submin() {
        $(".lift_Dialog").hide();
        if (confirm("更新提交到SAP?")) {
            $.ajax({
                type: "GET",
                url: "/api/v1/compCc/close/" + getParentParam_().id,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if (data.code == 200) {
                        alert("更新成功！");
                        if (typeof params.successCallback == "function") params.successCallback();
                        if (typeof params.OWindow.queryCCTable == "function") params.OWindow.queryCCTable();
                        if (typeof params.OWindow.Refresh == "function") params.OWindow.Refresh();

                        window.close();
                    }else{
                        if(40000<data.code&&data.code<50000){
                            if(data.msg){
                                MsgAlert({content:"更新失败："+data.msg, type: 'error'});
                            }else{
                                MsgAlert({content:"更新失败", type: 'error'});
                            }
                        }else if(data.code>50000){
                            if(data.msg){
                                forceCode=data.code;
                                $(".force_Dialog").show();
                                $(".msgTips")[0].innerHTML=data.msg+",是否强行提交本条数据到SAP(后续运维人员会跟进)";
                                console.log($(".msgTips")[0].innerHTML,data.msg);
                            }else{
                                MsgAlert({content:"更新失败", type: 'error'});
                            }
                        }else{
                            if(data.msg){
                                MsgAlert({content:"失败："+data.msg, type: 'error'});
                            }else{
                                MsgAlert({content:"更新失败", type: 'error'});
                            }
                        }

                    }
                },
                error: function () {
                    window.alert("失败！");
                }
            });
        }
    }

    function forceSubmin(index) {
        if(index==1){
            // MsgAlert({content:"调强制提交接口"});
            $.ajax({
                type: "GET",
                url: "/api/v1/compCc/forciblyClose/" + getParentParam_().id+"/"+forceCode,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    $(".force_Dialog").hide();
                    if(data.code==200){
                        MsgAlert({content:"更新成功"});
                        window.close();
                    }else{
                        MsgAlert({content:data.msg, type: 'error'});
                    }

                },
                error: function () {
                    window.alert("失败！");
                }
            });
        }else{
            $(".force_Dialog").hide();
        }
    }

    function ccdelete() {
        if (confirm("确定删除吗")) {
            $.ajax({
                type: "GET",
                url: "/api/v1/compCc/delete/" + getParentParam_().id,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if (data.code == 200) {
                        alert("删除成功！");
                        window.close();
                        params.OWindow.Refresh();
                    }
                },
                error: function () {
                    window.alert("失败！");
                }
            });
        }
    }

    function error_tips(ele) {
        $(ele).animate({width: '+=15'}, 100).animate({width: '-=15'}, 100)
            .animate({width: '+=15'}, 100).animate({width: '-=15'}, 100);
    }

    //非空校验
    function no_null() {                     //非空判断
        if (!$("#feiji").is(":checked") && !$("#faji").is(":checked")) {
            alert("请选择飞机或者部件");
            return false;
        }
        if ($("#caixia").is(":checked") || $("#caihuan").is(":checked") || $("#chuanjian").is(":checked")) {
            if ($("#original1").textbox("getValue") == "") {
                alert("拆下件号不能为空！");
                return false;
            }
        }
        if ($("#caixia").is(":checked") || $("#caihuan").is(":checked")){
            if(!$('#unknowSn').is(':checked')){
                //非未知情况下 序号不能为空
                if ($("#stazone").textbox("getValue") == "") {
                    alert("拆下序号不能为空！");
                    return false;
                }
            }
            if ($("#gouxin3").textbox("getValue") == "") {
                alert("拆下构型号不能为空！");
                return false;
            }
            if ($("#weizhi3").textbox("getValue") == "") {
                alert("拆下位置不能为空！");
                return false;
            }

            if ($("#newStation").val() == "") {
                alert("航站不能为空！");
                return false;
            }
        }
        if ($("#chuanjian").is(":checked")){
            if ($("#gouxin").textbox("getValue") == "") {
                alert("拆下构型号不能为空！");
                return false;
            }
            if ($("#weizhi").textbox("getValue") == "") {
                alert("拆下位置不能为空！");
                return false;
            }

            if ($("#newStation").val() == "") {
                alert("航站不能为空！");
                return false;
            }
        }
        if ($("#zhuangshang").is(":checked") || $("#caihuan").is(":checked") || $("#chuanjian").is(":checked")) {
            if ($("#original2").textbox("getValue") == "") {
                alert("装上件号不能为空！");
                return false;
            }
            if ($("#stazone2").textbox("getValue") == "") {
                alert("装上序号不能为空！");
                return false;
            }
            if ($("#gouxin2").textbox("getValue") == "") {
                alert("装上构型号不能为空！");
                return false;
            }
            if ($("#weizhi2").textbox("getValue") == "") {
                alert("装上位置不能为空！");
                return false;
            }
        }
        if ($("#caixia").is(":checked") || $("#caihuan").is(":checked")) {

            if ($("#caihuanyuanyin").textbox("getValue") == "") {
                alert("拆换原因不能为空！");
                return false;
            }
            if ($("#hangcaitype").textbox("getValue") == "") {
                alert("航材状态不能为空！");
                return false;
            }

            //是否退料必须勾选
            if(!($("#yes").is(':checked') || $("#no").is(':checked'))){
                alert("是否退料必须勾选！");
                return false;
            }
        }
        if ($("#jihua").textbox("getValue") == "") {
            alert("计划性不能为空！");
            return false;
        }
        if(!$("#caixia").is(":checked")&&prohibitedMark=="XZ"){
            if($("#releaseReason").val()==""){
                MsgAlert({content: "禁限装放行理由不能为空！", type: 'error'});
                return false;
            }
        }

        //章节号
        if ($("#ata").textbox("getValue") == "") {
            alert("章节号ATA不能为空！");
            return false;
        }

        if ($("#repSn").textbox("getValue") == "") {
            alert("工作者不能为空！");
            return false;
        }
        if ($("#rep_date").textbox("getValue") == "") {
            alert("拆换时间不能为空！");
            return false;
        }
        if ($("#rectChn").val() == "") {
            alert("原因描述不能为空！");
            return false;
        }
        if ($("#cuoshi").val() == "") {
            alert("措施不能为空！");
            return false;
        }
        if ($('.textbox-invalid:visible').length > 0) {
            alert("页面必填项未完成填写");
            error_tips($('.textbox-invalid:visible'));
            return false;
        }
        return true;
    }
    //备注和措施在添加和编辑状态不同start
    function beizhuAndCuoshi(dataobj) {
        if(params.operation == "add"){
            var rectChnDescChn,cuoshiRectFinishChn;
            if(!!params.defect_info.descChn){
                if(!!params.defect_info.descEn){
                    // rectChnDescChn = params.defect_info.descChn + " English "+ params.defect_info.descEn;
                    rectChnDescChn = params.defect_info.descChn;
                }else {
                    rectChnDescChn = params.defect_info.descChn;
                }
            };
            if(!!params.defect_info.rectFinishChn){
                if(!!params.defect_info.rectFinishEn){
                    // cuoshiRectFinishChn = params.defect_info.rectFinishChn + " English " +params.defect_info.rectFinishEn;
                    cuoshiRectFinishChn = params.defect_info.rectFinishChn;
                }else {
                    cuoshiRectFinishChn = params.defect_info.rectFinishChn;
                }
            };
            $("#rectChn").val(rectChnDescChn);
            $("#cuoshi").val(cuoshiRectFinishChn);

        }else {
            if (dataobj) {
                $("#rectChn").val(dataobj.reason);
                $("#cuoshi").val(dataobj.takenAction);
            }
        }
    }

    //备注和措施在添加和编辑状态不同end

    //航站查询start
    function stationQuery() {
        var title_ = $.i18n.t('航站查询');
        var curWidth = ($(window).width() * 0.5).toString();
        var curheight = ($(window).height() * 0.5).toString();
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: title_,
            param: {"stationId":"newStation"},
            url: "/views/tbm/flb/station_query.shtml"
        });
    }
    //航站查询end

    //    获取工单信息并显示start
    function getWorkData(){
        $.ajax({
            type: "GET",
            url: "/api/v1/workOrder/getWorkOrder/"+ params.orderId,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                WorkOrderData = data.data;
                if(data.hasOwnProperty("data")&&data.data.hasOwnProperty("station")){
                    $("#newStation").textbox("setValue",WorkOrderData.station);
                };
                console.log("工单数据获取成功");
                console.log(data);
            },
            error: function () {
                alert("工单数据获取失败");
            }
        });
    }
    //    获取工单信息并显示end

    //    给航站和章节号赋值start
    function ataAndStation(data) {
        $("#newStation").textbox("setValue",data.station);
        $("#ata").textbox("setValue", data.ata);
    }
    //    给航站和章节号赋值end

    //    赋值工单id
    function assignmentWorkId(data) {
        if(data.hasOwnProperty("orderId")){
            $('#workorderId').val(data.orderId);
        }else if(data.hasOwnProperty("workorderId")){
            $('#workorderId').val(data.workorderId);
        }else if(data.hasOwnProperty("defect_info")&&data.defect_info.hasOwnProperty("workorderId")){
            $('#workorderId').val(data.defect_info.workorderId);
        }else if(data.hasOwnProperty("defect_info")&&data.defect_info.hasOwnProperty("orderId")){
            $('#workorderId').val(data.defect_info.orderId);
        };
        if(data.hasOwnProperty("defect_info")&&data.defect_info.hasOwnProperty("taskType")&&data.defect_info.taskType == "CCO"){
            getTaskDescription();
        };
    };

    //    根据workorderId获取从CCO进来的正确“原因描述”,CCO以外的类型不走该接口，并且该函数必须在beizhuAndCuoshi()函数后面执行
    function getTaskDescription() {
        var getUrl = "/hanaMaterial/produceTask/selectBySapTaskId/?sapTaskId="+sapTaskId;
        if(!!sapTaskId ){
            InitGatewayRequest_({
                type: "get",
                async: false,
                // data:{posDamageId:posDamageId},
                path: getUrl,
                successCallBack: function (jdata) {
                    if (jdata.success == true) {
                        var descriptionData = jdata.obj||"";
                        var reasonDescription = descriptionData.reason;
                        $("#rectChn").val(reasonDescription);
                    } else {
                        MsgAlert({content: "获取任务描述信息失败！", type: 'error'});
                    }
                }
            });
        };
    }

    //    初始化赋值（不管是来源于飞机还是来源于飞机部位都要赋的基本值）
    function initBothCome(data) {
        //docNo赋值
        if(data.hasOwnProperty('docNo')){
            $("#docNo").val(data.docNo);
        }
    };

    //未知事件点击后unknowSnClick
    function unknowSnClick(){
        //未知点击后 序号不可编辑
        if($("#chuanjian").is(":checked")){
            $('#stazone').textbox({disabled:false});//启用
        }
        if($('#unknowSn').is(':checked') && !$("#chuanjian").is(":checked")){
            $('#stazone').textbox('setValue','');
            $('#stazone').textbox({disabled:true})
        }else{
            $('#stazone').textbox({disabled:false});//启用
        }
        caixia_gouxin($("#original1").textbox("getValue"), "");
    }

    //查询数据
    var hadAta = "";
    function getAtaData() {
        //这里必须使用两种取值方式，getValue取值是选择组件里包含的真实值，getText是组件里的显示的值
        //正常输入两个值相等，当使用上下键选择的时候就会出现不同的结果
        var ata = $("#ata").textbox("getValue");
        var ataText = $('#ata').combobox('getText');
        //限制长度大于1且小于7为了防止用上下键选择的时候，触发接口查询
        if(ata.length > 1 && ataText.length<7){
            //hadAta用来在第二次输入数据库不存在的章节号的时候，组件会清空输入框的情况下进行重新赋值
            if(ataText.length >3){
                hadAta = ataText.slice(0,4);
            }else {
                hadAta = "";
            };
            $.ajax({
                type: "POST",
                url: "/api/v1/ata/selectAta6?chapter="+ata,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if(!!data.data && data.data.length>0){
                        var getData = data.data;
                        var ataData=[] ;
                        for(var i=0;i<getData.length;i++){
                            var labelValue = {};
                            labelValue.label = getData[i].chapter + getData[i].section +getData[i].subject+" "+ getData[i].description;
                            labelValue.value = getData[i].chapter + getData[i].section;
                            ataData.push(labelValue);
                        };
                        $('#ata').combobox('loadData',ataData);
                    }else {
                        $('#ata').combobox('loadData',[]);
                    }
                },
                error: function () {
                    window.alert("系统出错，请联系系统管理员。");
                }
            });
        }else if(ataText.length<2){
            //设置等于1而不是0，是由于即使是输入正确的也会在点击回车键组件后会执行清空内容的操作，
            // 导致无法分辨是否是用户回退出现的空取值还是组件自动清空出现的空格
            if(ataText.length == 1){
                hadAta = "";
            };
            var ataData=[] ;
            $('#ata').combobox('loadData',ataData);
        }
    }

    //章节下拉数据预备
    function selectAta() {
        var ataSelect = "";
        $("#ata").combobox({
            required: true,
            data:[],
            panelHeight: 160,
            valueField: 'value',
            textField: 'label',
            width:400,
            hasDownArrow:true,
            //在选择(键盘的上下键和鼠标点击都会触发触发该函数)的时候做操作
            onSelect: (data) => {
                $("#ata").textbox("setValue", data.value);
            },
            //主要是解决当输入正确四位章节号后，该组件会直接带出描述的问题
            onLoadSuccess : () => {
                if(!!ataSelect){
                    $("#ata").textbox("setValue", ataSelect);
                    ataSelect = "";
                };
            },
            onChange:()=>{
                ataSelect = $("#ata").textbox("getValue");
                getAtaData();
            }
        });
        //解决当用户只是纯输入的时候，多于四位限制只取前面四位，少于四位直接置空
        $("#ata").next("span").children("input:first").blur(function () {
            setTimeout(function(){
                var ataNow = $("#ata").textbox("getValue");
                if(ataNow.length>4){
                    $("#ata").textbox("setValue", ataNow.slice(0,4));
                }if(ataNow.length<4){
                    $("#ata").textbox("setValue", "");
                }
            },300);
        });
        //解决当用户输入一个正确的四位章节号后，点击回车键出现输入框带入描述的问题
        $("#ata").next("span").children("input:first").keydown(function () {
            if(event.keyCode == "13") {
                //或操作hadAta主要解决当纯输入四位数据库不存在的章节号的时候，按下回车键内容被清空的问题
                var ataNow = $("#ata").combobox('getText')||hadAta;
                if(ataNow.length>3){
                    $("#ata").textbox("setValue", ataNow.slice(0,4));
                }
            }
        })
    }

    function viewOnly() {
        $("input[name='defect']").attr("disabled", "disabled");
        $("input[name='aeType']").attr("disabled", "disabled");
        $("#acReg").textbox("readonly",true);
        $("#nrcNo").textbox("readonly",true);
        $("#newStation").textbox("readonly",true);
        $("#newStationBtn").hide();
        $("#ata").textbox("readonly",true);
        $("#ata").combobox('disable');
        $("input[name='reback']").attr("disabled", "disabled");
        $("#original1").textbox("readonly",true);
        $("#acBtn").hide();
        $("#stazone").textbox("readonly",true);
        $("#unknowSn").attr("disabled", "disabled");
        $("#gouxin").textbox("readonly",true);
        $("#gouxin3").combobox('disable');
        $("#weizhi").textbox("readonly",true);
        $("#weizhi3").textbox("readonly",true);
        $("#caixia_zujian").find('img').hide();
        $("#original2").textbox("readonly",true);
        $("#acBtn2").hide();
        $("#stazone2").textbox("readonly",true);
        $("#gouxin2").combobox('disable');
        $("#weizhi2").textbox("readonly",true);
        $("#zhuang_zujian").find('img').hide();
        $("#jihua").combobox('disable');
        $("#caihuanyuanyin").combobox('disable');
        $("#hangcaitype").combobox('disable');
        $("#repSn").combobox('disable');
        $("#rep_date").combobox('disable');
        $("#rectChn").attr("disabled", "disabled");
        $("#cuoshi").attr("disabled", "disabled");
        $("#beizhu").attr("disabled", "disabled");
        $(".button_a").hide();
        $("#attachament_td ").find(".textbox.easyui-validatebox").hide();
        $("#attachament_td ").find(".file_duihao").hide();
        $("#attachament_td ").find(".jianhao").hide();
        $("#attachament_td ").find(".add_jiahao").hide();
        $("#attachament_td ").find(".jianhao.icon-delete").hide();
        $("#releasetype").combobox('disable');
        $("#releaseReason").attr("disabled", "disabled");
    }
    //CC禁限装
    function prohibitedItem(pn,sn,releaseType,releaseReason){
        let newSn=sn.toUpperCase();
        $.ajax({
            type: "POST",
            url: "/api/v1/emEoProhibitedItems/selectByPnAndSn",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            data: JSON.stringify({pn: pn,sn:newSn}),
            success: function (data) {
                if (data.code == 200 && data.data) {
                    var datas = data.data;
                    prohibitedInfo(datas, releaseType, releaseReason);//展示禁限装信息
                }
            },
            error: function () {
                MsgAlert({content: '失败', type: 'error'});
            }

        });
    }

    //禁限装信息
    function prohibitedInfo(data,releaseType,releaseReason){
        if(data.length>0){
            if(data[0].prohibitedMark=="XZ"){
                $("#releasetype").combobox({
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: releasetype_list,
                    onSelect:function(item){}
                });

                if(releaseType){
                    $("#releasetype").combobox("setValue",releaseType);
                }
                if(releaseReason){
                    $("#releaseReason").val(releaseReason);
                }

                prohibitedMark="XZ";
                $("#zhuangshang_PN span.pn_jxz").remove();
                $("#zhuangshang_PN").prepend("<span class='pn_jxz' style='color:#e28b41;font-weight: bold'>禁限装</span>");
            }
            else{
                //允装
                prohibitedMark="";
                $("#zhuangshang_PN span.pn_jxz").remove();
            }


            for(let i=0;i<data.length;i++){
                let remark=data[i].remark||"";
                if(data[i].businessType=="TB"){
                    remark==""?remark="请参考TB原文附件":remark;
                }
                remark = remark.replace(/[\r\n]/g, "");//换行
                if(prohibitedMark=="XZ"){
                    prohibitedHtml(data,i,remark);
                }
            }

        }else{
            //允装
            prohibitedMark="";
            $("#zhuangshang_PN span.pn_jxz").remove();
        }
    }

    //禁限装HTML操作
    function prohibitedHtml(data,i,remark){
        $("#zs_prohibited").show();
        if(i==0){//判断第一条数据
            let html=`<tr class="tr_zhuangshang removeprohibitedTr">
                            <td class="key" rowspan="${data.length+1}">禁限装信息</td>
                            <td>编号</td>
                            <td>
                                <span style="cursor: pointer;color: #f60;" title="预览"
                                    onclick="prohibitedCli('${data[i].businessType}','${data[i].businessId}')">${data[i].businessNo}</span>
                            </td>
                            <td>描述</td>
                            <td colspan="3">${remark}</td>
                        </tr>`;
            $("#zs_prohibited").before(html);
        }else{
            let html=`<tr class="tr_zhuangshang removeprohibitedTr">
                            <td>编号</td>
                            <td>
                                <span style="cursor: pointer;color: #f60;" title="预览"
                                    onclick="prohibitedCli('${data[i].businessType}','${data[i].businessId}')">${data[i].businessNo}</span>
                            </td>
                            <td>描述</td>
                            <td colspan="3">${remark}</td>
                        </tr>`;
            $("#zs_prohibited").before(html);
        }


    }

    //禁限装编号--查看PDF star
    function prohibitedCli(businessType,businessId){
        $(".remarkDialogLoad").show();//加载中
        if(businessType=="EO"){
            InitFuncCodeRequest_({
                data: {pkid: businessId, FunctionCode: 'EM_EO_PRINT'},
                successCallBack: function (jdata) {
                    $(".remarkDialogLoad").hide();//加载中
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        let urls = jdata.data;
                        if (urls.indexOf(":") != -1) {
                            urls = urls.substring(urls.indexOf(":") + 1).replace("//", "/");
                        }
                        prohibitedPDF(urls);
                    } else {
                        MsgAlert({content: jdata.msg, type: "error"});
                    }
                }
            });
        }else if(businessType=="TB"){
            InitFuncCodeRequest_({
                data: {pkid: businessId, FunctionCode: 'EM_TB_PRINT'},
                successCallBack: function (jdata) {
                    $(".remarkDialogLoad").hide();//加载中
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        let urls = jdata.data;
                        if (urls.indexOf(":") != -1) {
                            urls = urls.substring(urls.indexOf(":") + 1).replace("//", "/");
                        }
                        prohibitedPDF(urls);
                    } else {
                        MsgAlert({content: jdata.msg, type: "error"});
                    }
                }
            });
        }

    }

    function prohibitedPDF(url){
        var curWidth = ($(window).width() * 0.85).toString();
        var curheight = $(window).height().toString();
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: "",
            param: {},
            url: url,
        });
    }
    //禁限装编号--查看PDF end

    function ac_zheShow(){
        $("input[name='aeType']").attr("disabled", "disabled");
        $("#acReg").textbox("readonly",true);
    }

    function ac_zheHide(){
        $("input[name='aeType']").attr("disabled", false);
        $("#acReg").textbox("readonly",false);
    }

    //首行来源文件类型，编号，TLB编号显示
    function comeFileTypeNumberTlbShow(){
        //确定来源于CC列表首页&&是新增类型
        if (!!params && !!params.OWindow && params.OWindow.location.pathname.indexOf("cc_list") > -1 && params.type == "add") {
            $("#comeFromFile").show();
            comefromPage = "cc_list";
        }else{
            $("#comeFromFile").hide();
            comefromPage = "";
        };
    }

    //选择来源文件后返回类型，编号，TLB编号
    function returnFileData(type, ind){
        $.comeFileTypeSelect({
            success: function (data) {
                //    来源文件类型
                $("#comeType").textbox("setValue", data.workType||"");
                if(!!data.workType){
                    var docType =  {TLB: 1, NRC:2, CC: 3, EO: 4, JC: 5, DEFECT: 6, PCO: 7, NRCT: 8, TO: 9, DDREVIEW: 10, CCO: 11};
                    $("#comeTypePush").val(docType[data.workType.toUpperCase()]||"");
                };
                //来源文件编号
                $("#comeTypeShow").textbox("setValue", data.cardNumber||"");
                $("#docNo").val(data.cardNumber||"");
                //来源TLB编号
                $("#tlbNumber").textbox("setValue", data.tlbNo||"");
                //工单ID
                $("#workorderId").val(data.id||"");
                //tlbId
                $("#tlbId").val(data.tlbId||"");
                //航班ID
                $("#flightId").val(data.flightId||"");
                //航班号
                $("#nrcNo").textbox("setValue", data.flightNo||"");
                //航站
                $("#newStation").textbox("setValue",data.zxdd||data.toStation||"");
            }
        })
    }


</script>
</body>

</html>