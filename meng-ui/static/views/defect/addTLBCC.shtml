<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->
<!-- <script type="text/javascript" src="http://10.88.15.51:8080/js/jquery/lhgdialog/lhgdialog.js"></script> -->
<style type="text/css">
    .table-cell{
        text-align: center;
        padding: 0;
        margin: 0;
    }
    .cell-normal {
        height: 40px;
    }
    .cell-textarea {
        height: 80px;
    }
    td{
        -webkit-user-select:none;
        -moz-user-select:none;
        -ms-user-select:none;
        user-select:none;
    }
    input[type="text"]{
        width: 100px;
        margin: 0 5px 0 5px;
    }
    input[type="remove"]{
        width: 140px;
    }
    .foot-btns{
        bottom: 0;
        float: right;
        margin: 10px 20px 0 0;
    }
</style>
</head>
<body> 
    <form id="addCCform" class="form-horizontal">
        <table class="table table-bordered table-info" width="100%" style="padding-top:10px" id="pdList">
            <tr>
                <th class="table-cell cell-normal" colspan="2">CC TYPE</th>
                <td class="table-cell cell-normal" colspan="4" style="width: 40%">
                    <form style="color: black"  id="ccType" name="ccType">
                        <input type="radio" name="ccType" id="remove" value="1" onchange="cc_type_change(1)"><label for="remove">Remove</label>
                        <input type="radio" name="ccType" id="install" style="margin-left: 15px" value="2" onchange="cc_type_change(2)"><label for="install">Install</label>
                        <input type="radio" name="ccType" id="replace" style="margin-left: 15px" value="3" onchange="cc_type_change(3)"><label for="replace">Replace</label>
                        <input type="radio" name="ccType" id="swap" style="margin-left: 15px" value="4" onchange="cc_type_change(4)"><label for="swap">Swap</label>
                    </form>
                </td>
                <td class="table-cell cell-normal"></td>
                <th class="table-cell cell-normal" colspan="2"></th>
                <td class="table-cell cell-normal" colspan="2"></td>
            </tr>
            <tr id="off1">
                <th class="table-cell cell-normal" style="width: 8%">OFF</th>
                <th class="table-cell cell-normal" style="width: 8%">A/C<span style="color: red">*</span></th>
                <td class="table-cell cell-normal" style="width: 10%"><input type="text" id="offAc" name="offAc"/></td>
                <th class="table-cell cell-normal" style="width: 8%">Name</th>
                <td class="table-cell cell-normal" style="width: 10%"><input type="text" id="offName" name="offName"/></td>
                <th class="table-cell cell-normal" style="width: 8%">P/N<span style="color: red">*</span></th>
                <td class="table-cell cell-normal required" style="width: 10%"><input type="text" id="offPn" name="offPn"/></td>
                <th class="table-cell cell-normal" style="width: 8%">S/N<span style="color: red">*</span></th>
                <td class="table-cell cell-normal" style="width: 10%"><input type="text" id="offSn" name="offSn"/></td>
                <th class="table-cell cell-normal" style="width: 8%">构型<span style="color: red">*</span></th>
                <td class="table-cell cell-normal" style="width: 10%"><input type="text" class="gouxin_com" id="gouxin"  name="gouxin"/></td>
                <th class="table-cell cell-normal" style="width: 8%">Position<span style="color: red">*</span></th>
                <td class="table-cell cell-normal" style="width: 10%"><input type="text" id="offPosition" class="off_onPosition" name="offPosition"/></td>
            </tr>
            <tr id="on1">
                <th class="table-cell cell-normal" style="width: 8%">ON</th>
                <th class="table-cell cell-normal" style="width: 8%">A/C<span style="color: red">*</span></th>
                <td class="table-cell cell-normal" style="width: 10%"><input type="text" id="onAc1" name="onAc1"></td>
                <th class="table-cell cell-normal" style="width: 8%">Name</th>
                <td class="table-cell cell-normal" style="width: 10%"><input type="text" id="onName1" name="onName1"/></td>
                <th class="table-cell cell-normal" style="width: 8%">P/N<span style="color: red">*</span></th>
                <td class="table-cell cell-normal required" style="width: 10%"><input type="text" id="onPn1" name="onPn1"/></td>
                <th class="table-cell cell-normal" style="width: 8%">S/N<span style="color: red">*</span></th>
                <td class="table-cell cell-normal" style="width: 10%"><input type="text" id="onSn1" name="onSn1"/></td>
                <th class="table-cell cell-normal" style="width: 8%">构型<span style="color: red">*</span></th>
                <td class="table-cell cell-normal" style="width: 10%"><input type="text" class="gouxin_com" id="gouxin1" name="gouxin1"/></td>
                <th class="table-cell cell-normal" style="width: 8%">Position<span style="color: red">*</span></th>
                <td class="table-cell cell-normal" style="width: 10%"><input type="text" class="off_onPosition" id="onPosition1" name="onPosition1"/></td>
            </tr>
            <tr id="on2">
                <th class="table-cell cell-normal">ON</th>
                <td class="table-cell cell-normal" colspan="4"></td>
                <th class="table-cell cell-normal">P/N<span style="color: red">*</span></th>
                <td class="table-cell cell-normal required"><input type="text" id="onPn2" name="onPn2"/></td>
                <th class="table-cell cell-normal">S/N<span style="color: red">*</span></th>
                <td class="table-cell cell-normal"><input type="text" id="onSn2" name="onSn2"/></td>
<!--                <th class="table-cell cell-normal" style="width: 8%">构型<span style="color: red">*</span></th>-->
<!--                <td class="table-cell cell-normal" style="width: 10%"><input type="text" class="gouxin_com" id="gouxin2" name="gouxin2"/></td>-->
<!--                <th class="table-cell cell-normal">Position<span style="color: red">*</span></th>-->
<!--                <td class="table-cell cell-normal"><input type="text" id="onPosition2" class="off_onPosition" name="onPosition2"/></td>-->
                <th class="table-cell cell-normal" style="width: 8%"></th>
                <td class="table-cell cell-normal" style="width: 10%"></td>
                <th class="table-cell cell-normal"></th>
                <td class="table-cell cell-normal"></td>
            </tr>
            <tr>
                <th class="table-cell cell-normal required" colspan="3">Complete Date<span style="color: red">*</span></th>
                <td class="table-cell cell-normal" colspan="2"><input type="long" id="completeDate" name="completeDate"></td>
                <th class="table-cell cell-normal required" colspan="2">Flight No.</th>
                <td class="table-cell cell-normal" colspan="2">
                    <input type="hidden" id="flightId" name="flightId">
                    <input type="long" id="flightNo" name="flightNo">
                </td>
                <td class="table-cell cell-normal" colspan="4"></td>
            </tr>
            <tr id="z_hang">
                <th class="table-cell cell-normal required" colspan="2">航材状态<span style="color: red">*</span></th>
                <td class="table-cell cell-normal"><input type="text" name="airMaterialState" id="airMaterial"></td>
                <td class="table-cell cell-normal" colspan="10"></td>
            </tr>
            <tr>
                <th class="table-cell cell-normal required" colspan="3">Reason<span style="color: red">*</span></th>
                <td class="table-cell cell-textarea" colspan="10">
                    <textarea id="reason" maxlength="1000" name="reason"  style="height: 100%;width: 100%;resize: none;"></textarea>
                </td>
            </tr>
            <tr>
                <th class="table-cell cell-normal required" colspan="3">TAKEN ACTION<span style="color: red">*</span></th>
                <td class="table-cell cell-textarea" colspan="10">
                    <textarea id="takenAction" maxlength="1000" name="takenAction"  style="height: 100%;width: 100%;resize: none;"></textarea>
                </td>
            </tr>
            <table id="tableRemove" class="table table-bordered table-info">
                <tr>
                    <th class="table-cell cell-normal" colspan="12">该部件存在以下下级部件请核实是否一起拆下</th>
                </tr>
                <tr>
                    <th class="table-cell cell-normal" style="width: 20%">Name</th>
                    <th class="table-cell cell-normal required" style="width: 20%">P/N</th>
                    <th class="table-cell cell-normal required" style="width: 20%">S/N</th>
                    <th class="table-cell cell-normal required" style="width: 20%">Position</th>
                    <th class="table-cell cell-normal required" style="width: 20%">是否随上层母件一起拆下？</th>
                </tr>
                <!-- <tr>
                    <td class="table-cell cell-normal"><input type="long" name="remove_name" id="remove_name"></td>
                    <td class="table-cell cell-normal"><input type="long" name="remove_pn" id="remove_pn"></td>
                    <td class="table-cell cell-normal"><input type="long" name="remove_sn" id="remove_sn"></td>
                    <td class="table-cell cell-normal"><input type="long" name="remove_position" id="remove_position"></td>
                    <td class="table-cell cell-normal">yes</td>
                </tr> -->
            </table>
            <table id="tableReplace" class="table table-bordered table-info">
                <tr>
                    <th class="table-cell cell-normal" colspan="12">该部件存在以下下级部件请核实是否一起拆换</th>
                </tr>
                <tr>
                    <th class="table-cell cell-normal" style="width: 14%">Name</th>
                    <th class="table-cell cell-normal required" style="width: 14%">P/N(OFF)</th>
                    <th class="table-cell cell-normal required" style="width: 14%">S/N(OFF)</th>
                    <th class="table-cell cell-normal required" style="width: 14%">Position</th>
                    <th class="table-cell cell-normal required" style="width: 16%">是否随上层母件一起拆换？</th>
                    <th class="table-cell cell-normal" style="width: 14%">P/N(ON)</th>
                    <th class="table-cell cell-normal" style="width: 14%">S/N(ON)</th>
                </tr>
            </table>
            <!-- <table id="tableSwap"></table> -->
            <table class="table table-bordered table-info">
                <tr>
                    <th class="table-cell cell-normal" style="width: 20%">Remark</th>
                    <td class="table-cell cell-textarea">
                        <textarea id="remark" name="remark" maxlength="1000" style="height: 100%;width: 100%;resize: none;"></textarea>
                    </td>
                </tr>
            </table>
        </table>
    </form>
    <div class="foot-btns">
        <a class="searchBtn" type="button" onclick="save()" data-options="iconCls:'icon-clear'" style="margin-right: 10px;">
            <span data-i18n="common:COMMON_OPERATION.SAVE"></span>
        </a>
        <!-- <a class="searchBtn" data-options="iconCls:'icon-clear'" onclick="submitFlow()" style="margin-right: 10px;"
           type="button">
            <span data-i18n="common:COMMON_OPERATION.SUBMIT"></span>
        </a> -->
        <a class="ridoBtn" type="button" onclick="close_window()" data-options="iconCls:'icon-clear'">
            <span data-i18n="common:COMMON_OPERATION.CANCEL"></span>
        </a>
    </div>

    <!-- ac选择弹窗, copy from flb_station_task_list.shtml -->
    <div id="ACQueryWindow" class="easyui-window" title="A/C Query" data-options=""
         style="width:46%;height:50%;padding:5px 5px 5px 5px;">
        <table id="ACDg" pagination="true"></table>
    </div>
    
<script type="text/javascript">
    const params = getParentParam_();
    console.info(params, 'params');
    var global_data = {
        sublength: 0
    };
    //设置一个gouxin 初始值flag
    var gouxinFlag = false;
    var gouxinFlag1 = false;
    //设置一个gouxin 初始值flag
    const air_material_state_list = [
        {
            label: "可用件",
            value: "USED"
        },
        {
            label: "不可用件",
            value: "UNUSED"
        },
        {
            label: "待观察件",
            value: "WDISPOSE"
        }
    ];

    function get_data(){
        if(params.operation == "add"){
            let chnReason = params.defect_info.reasonChn;
            let enReason = params.defect_info.reasonEn;
            let actionChn = params.defect_info.actionChn;
            let actionEn = params.defect_info.reasonEn;
            $('#reason').val(chnReason);
            $('#takenAction').val(actionChn);
            return;
        }

        let url = "/api/v1/cc/view";
        let form = new FormData();
        form.append('id', params.id);
        axios.post(url, form).then(response=>{
            if(response.data.msg.toUpperCase().indexOf("SUCCESS") != -1){
                if(!!response.data.data){
                    console.log(response.data.data);
                    init_data(response.data.data)
                }
            }else{
                throw new Error(response.data.msgData[0])
            }
        }).catch(err=>{
            MsgAlert({type: "error", content: "获取cc信息失败: " + err})
        })
    }


    /**
     * 给remove的下级件列表加一行
     * @param {object} row_data 该行对应的数据
     * @param {number} index 该行对应的行号
     */
    function add_table_remove(row_data, index){
        if(!!$(`#remove_tr${index}`)){
            $(`#remove_tr${index}`).empty();
            $(`#remove_tr${index}`).remove();
        }
        let html = `<tr id="remove_tr${index}" name="remove_tr">
                    <td class="table-cell cell-normal"><input type="long" name="remove_name${index}" id="remove_name${index}"></td>
                    <td class="table-cell cell-normal"><input type="long" name="remove_pn${index}" id="remove_pn${index}"></td>
                    <td class="table-cell cell-normal"><input type="long" name="remove_sn${index}" id="remove_sn${index}"></td>
                    <td class="table-cell cell-normal"><input type="long" name="remove_position${index}" id="remove_position${index}"></td>
                    <td class="table-cell cell-normal">
                        <form style="color: black">
                            <input type="radio" name="remove_status${index}" id="remove_status_yes${index}" value="y">是
                            <input type="radio" name="remove_status${index}" id="remove_status_no${index}" style="margin-left: 15px" value="n" disabled="true">否
                        </form>
                        <input style="visibility: hidden; position: absolute" name="remove_id${index}" id="remove_id${index}" value="${row_data.id}">
                    </td>
                </tr>`;
        let node = $(html);
        $("#tableRemove").append(html);
        $(`#remove_name${index}`).textbox({value: row_data.name});
        $(`#remove_pn${index}`).textbox({
            value: row_data.offPn,
            editable: false,
            icons: [{
                iconCls:'icon-search',
                handler: function(e){
                    $.pnSelect({
                        success: data=>{
                            $(`#remove_pn${index}`).textbox("setValue", data.partno)
                        }
                    })
                }
            }]
        });
        $(`#remove_sn${index}`).textbox({value: row_data.offSn});
        $(`#remove_position${index}`).textbox({value: row_data.offPosition});
        if(row_data.flag == "y"){
            $(`#remove_status_yes${index}`).attr("checked", "checked");
        }else if(row_data.flag == "n"){
            $(`#remove_status_no${index}`).attr("checked", "checked");
        }
    }

    /**
     * 给replace的下级件列表加一行
     * @param {object} row_data 改行对应的数据
     * @param {number} index 该行对应的行号
     */
    function add_table_replace(row_data, index){
        if(!!$(`#replace_tr${index}`)){
            $(`#replace_tr${index}`).empty();
            $(`#replace_tr${index}`).remove();
        }
        let html = `<tr id="replace_tr${index}" name="replace_tr">
                    <td class="table-cell cell-normal"><input type="remove" name="replace_name${index}" id="replace_name${index}"></td>
                    <td class="table-cell cell-normal"><input type="remove" name="replace_offPn${index}" id="replace_offPn${index}"></td>
                    <td class="table-cell cell-normal"><input type="remove" name="replace_offSn${index}" id="replace_offSn${index}"></td>
                    <td class="table-cell cell-normal"><input type="remove" name="replace_position${index}" id="replace_position${index}"></td>
                    <td class="table-cell cell-normal">
                        <form style="color: black"  id="replace_status${index}" name="replace_status${index}">
                            <input type="radio" name="replace_status${index}" id="replace_status_yes${index}" value="y">是
                            <input type="radio" name="replace_status${index}" id="replace_status_no${index}" style="margin-left: 15px" value="n">否
                        </form>
                        <input style="visibility: hidden; position: absolute" name="replace_id${index}" id="replace_id${index}" value="${row_data.id}">
                    </td>
                    <td class="table-cell cell-normal"><input type="remove" name="replace_onPn${index}" id="replace_onPn${index}"></td>
                    <td class="table-cell cell-normal"><input type="remove" name="replace_onSn${index}" id="replace_onSn${index}"></td>
                </tr>`;
        let node = $(html);
        $("#tableReplace").append(html);
        $(`#replace_name${index}`).textbox({value: row_data.name});
        $(`#replace_offPn${index}`).textbox({
            value: row_data.offPn,
            editable: false,
            icons: [{
                iconCls:'icon-search',
                handler: function(e){
                    $.pnSelect({
                        success: data=>{
                            $(`#replace_offPn${index}`).textbox("setValue", data.partno)
                        }
                    })
                }
            }]
        });
        $(`#replace_onPn${index}`).textbox({
            value: row_data.onPn,
            editable: false,
            icons: [{
                iconCls:'icon-search',
                handler: function(e){
                    $.pnSelect({
                        success: data=>{
                            $(`#replace_onPn${index}`).textbox("setValue", data.partno)
                        }
                    })
                }
            }]
        });
        $(`#replace_offSn${index}`).textbox({value: row_data.offSn});
        $(`#replace_onSn${index}`).textbox({value: row_data.onSn});
        $(`#replace_position${index}`).textbox({value: row_data.offPosition});
        if(row_data.flag == "y"){
            $(`#replace_status_yes${index}`).attr("checked", "checked");
        }else if(row_data.flag == "n"){
            $(`#replace_status_no${index}`).attr("checked", "checked");
        }
    }

    function get_component_list(){
        let url = "/api/v1/cc/initSubComponentList";
        let post_data = {
            offAc: $("#offAc").textbox("getValue"),
            offPn: $("#offPn").textbox("getValue"),
            offSn: $("#offSn").textbox("getValue"),
            offAcId: "",
            onPn: "",
            onSn: "",
            ccType: $("input[name='ccType']:checked").val()
        };
        axios.post(url, post_data).then(response=>{
            let ccType = $("input[name='ccType']:checked").val();
            if(response.data.msg.toUpperCase().indexOf("SUCCESS") != -1){
                if(!!response.data.data && Array.isArray(response.data.data.subComponentList)){
                    if(ccType == 1){
                        response.data.data.subComponentList.forEach(add_table_remove)
                    }else if(ccType == 3){
                        response.data.data.subComponentList.forEach(add_table_replace)
                    }
                    global_data.sublength = response.data.data.subComponentList.length;
                }
            }else{
                throw new Error(response.data.msgData[0])
            }
        }).catch(err=>{
            MsgAlert({type: "error", content: err.message})
        })
    }

    // function bclick(){
    //     let data = $("#addCCform").serializeObject();
    //     console.log(data);
    //     add_table_replace({}, 1);
    //     add_table_remove({}, 1)
    // }

    function save(){
        //废弃页面
        window.alert("失败！废弃页面,请联系运维工程师.");
        return false;
        let post_data = get_post_data();
        if( !check_required(post_data) ){
            return
        }
        var hadSelect = $("#gouxin").combobox("getValue");
        var hadSelect1 = $("#gouxin1").combobox("getValue");
        if(!hadSelect && gouxinFlag){
            alert("请选择拆下构型选项");
            return;
        }
        if(!hadSelect1 && gouxinFlag1){
            alert("请选择装上构型选项");
            return;
        }
        if($("tr[name='remove_tr']").length>0){
            for(var i=0;i<$("tr[name='remove_tr']").length;i++){
                  if($("#remove_name"+i).textbox("getValue")==""||$("#remove_pn"+i).textbox("getValue")==""||$("#remove_sn"+i).textbox("getValue")==""||$("#remove_position"+i).textbox("getValue")==""|| $("input[name='remove_status']").val()==""){
                       alert("部件拆下件不能为空！");
                      return;
                  }
            }
        }
        let url = "";
        if(params.operation == "add"){
            url = "/api/v1/cc/save";

        }else if(params.operation == "edit" && params.id){
            url = "/api/v1/cc/update";
        }
        if(params.defect_info.workorderId){
            post_data.workOrderId=params.defect_info.workorderId;
        }
        axios.post(url, post_data).then(response=>{
            if(response.data.msg.toUpperCase().indexOf("SUCCESS") != -1){
                // MsgAlert({type: "success", content: "保存成功"})
                if (typeof params.successCallback == "function") params.successCallback();
                if (typeof params.OWindow.queryCCTable == "function") params.OWindow.queryCCTable();

                close_window()
            }else{
                throw new Error(response.data.msgData[0])
            }
        }).catch(err=>{
            MsgAlert({type: "error", content: "保存失败: " + err})
        })
    }

     function init_data(page_data){

         $("#reason").attr('readonly', 'readonly');
         $("#takenAction").attr('readonly', 'readonly');
        if(!page_data){
            return
        }
         if(params.defect_info.workorderId){
             if(page_data.tlbCompCC.ccType == 2 || page_data.tlbCompCC.ccType == 4){
                 $("#z_hang").hide();
             }
             $("#reason").removeAttr('readonly');
             $("#takenAction").removeAttr('readonly');
         }
        //先执行cc_type_change处理上部表格,cc_type_change会清空上部数据,执行之后再赋值
         global_data.onAcId = page_data.tlbCompCC.onAcId;
        if(page_data.tlbCompCC.ccType == 1){
            //remove
            $("#remove").attr("checked", "checked");
            cc_type_change(1);
            if(Array.isArray(page_data.tlbCompCCSubs)){
                page_data.tlbCompCCSubs.forEach(add_table_remove)
            }
            editoff_ongouxin(1,page_data.tlbCompCC)
            eidtposition_list(1,page_data.tlbCompCC);
        }else if(page_data.tlbCompCC.ccType == 2){
            //install
            $("#install").attr("checked", "checked");
            cc_type_change(2);
            $("#onAc1").textbox("setValue", page_data.tlbCompCC.onAc);
            $("#onName1").textbox("setValue", page_data.tlbCompCC.onName);
            $("#onPn1").textbox("setValue", page_data.tlbCompCC.onPn);
            $("#onSn1").textbox("setValue", page_data.tlbCompCC.onSn);
            editoff_ongouxin(2,page_data.tlbCompCC)
            eidtposition_list(2,page_data.tlbCompCC);
            $("#onPosition1").combobox("setValue", page_data.tlbCompCC.onPosition);
            $("#gouxin1").combobox("setValue", page_data.tlbCompCC.onCin);

        }else if(page_data.tlbCompCC.ccType == 3){
            //replaceK
            $("#replace").attr("checked", "checked");
            cc_type_change(3);
            if(Array.isArray(page_data.tlbCompCCSubs)){
                page_data.tlbCompCCSubs.forEach(add_table_replace)
            }
            $("#onPn2").textbox("setValue", page_data.tlbCompCC.onPn);
            $("#onSn2").textbox("setValue", page_data.tlbCompCC.onSn);
            editoff_ongouxin(1,page_data.tlbCompCC)
            editoff_ongouxin(3,page_data.tlbCompCC)
            eidtposition_list(1,page_data.tlbCompCC);
            eidtposition_list(3,page_data.tlbCompCC);
            // $("#onPosition2").combobox("setValue", page_data.tlbCompCC.onPosition);
            // $("#gouxin2").combobox("setValue", page_data.tlbCompCC.onCin);

        }else if(page_data.tlbCompCC.ccType == 4){
            //swap
            $("#swap").attr("checked", "checked");
            cc_type_change(4);
            $("#onAc1").textbox("setValue", page_data.tlbCompCC.onAc);
            $("#onName1").textbox("setValue", page_data.tlbCompCC.onName);
            $("#onPn1").textbox("setValue", page_data.tlbCompCC.onPn);
            $("#onSn1").textbox("setValue", page_data.tlbCompCC.onSn);
            editoff_ongouxin(1,page_data.tlbCompCC)
            editoff_ongouxin(2,page_data.tlbCompCC)
            eidtposition_list(1,page_data.tlbCompCC);
            eidtposition_list(2,page_data.tlbCompCC);
            $("#onPosition1").combobox("setValue", page_data.tlbCompCC.onPosition);
            $("#gouxin1").combobox("setValue", page_data.tlbCompCC.onCin);


        }
        global_data.sublength = (page_data.tlbCompCCSubs || []).length;
         global_data.ccType = page_data.tlbCompCC.ccType;



        $("#offPosition").combobox("setValue", page_data.tlbCompCC.offPosition);
        $("#gouxin").combobox("setValue", page_data.tlbCompCC.cin);
        $("#offName").textbox("setValue", page_data.tlbCompCC.offName);
        $("#offSn").textbox("setValue", page_data.tlbCompCC.offSn);
        // $("#offSn").next("span").children().first().blur(get_component_list);
         $("#reason").val(page_data.tlbCompCC.reason);
         $("#takenAction").val(page_data.tlbCompCC.takenAction);
         $("#remark").val(page_data.tlbCompCC.remark);
         $("#flightId").val(page_data.tlbCompCC.flightId);
         $("#flightNo").val(page_data.tlbCompCC.flightNo || "");
        // $("#onAc1").textbox();
        // $("#onPosition1").textbox();
        // $("#onName1").textbox();
        // $("#onSn1").textbox();
        // $("#onAc2").textbox();
        // $("#onPosition2").textbox();
        // $("#onName2").textbox();
        // $("#onSn2").textbox();
        $("#offPn").textbox("setValue", page_data.tlbCompCC.offPn);
        $('#airMaterial').combobox("setValue", page_data.tlbCompCC.airMaterialState);
        // $("#onPn1").textbox();
        // $("#onPn2").textbox();
        $("#completeDate").datetimebox("setValue", formatterDate(new Date(page_data.tlbCompCC.completeDate)));
        
        // $("#remove").attr("checked", "checked");
        // cc_type_change(1)
    }

    function get_post_data(){
        let data = $("#addCCform").serializeObject();
        let ccType = $("input[name='ccType']:checked").val();
        if(!data.completeDate){
            MsgAlert({type: "error", content: "请填写完成时间"});
            return;
        }
        let post_data = { 
            completeDate: new Date(data.completeDate),
            ccType: data.ccType,
            flightId: data.flightId,
            flightNo: data.flightNo, 
            offAc: data.offAc,
            offAcId: global_data.offAcId || "",
            offName: data.offName, 
            offPn: data.offPn, 
            offPosition: data.offPosition,
            cin:data.gouxin,
            offSn: data.offSn, 
            offAcType: 1,
            reason: data.reason, 
            remark: data.remark, 
            takenAction: data.takenAction,
            onAc: data.onAc1? data.onAc1: "",
            onAcId: global_data.onAcId || "",
            onAcType: 1,
            onName: data.onName1? data.onName1: "",
            onPn: data.onPn1? data.onPn1: data.onPn2,
            onSn: data.onSn1? data.onSn1: data.onSn2,
            onPosition: data.onPosition1,
            onCin:data.gouxin1,
            tlbCompCCSubSet: [],
            airMaterialState: data.airMaterialState,
            tlbId: params.defect_info.tlbId,
            defectId: params.defect_info.defectId,
            docNo: params.docNo || "",
            docType: params.docType || ""
        };
        if(params.operation == "edit"){
            post_data.ccType = global_data.ccType
        }
        if(!!params.id){
            post_data.id = params.id
        }
        let temp = {};
        if(ccType == 1){
            for(let i = 0; i < global_data.sublength; i++){
                temp = {
                    name: data["remove_name" + i],
                    offPn: data["remove_pn" + i],
                    offSn: data["remove_sn" + i],
                    offPosition: data["remove_position" + i],
                    flag: $(`input[name='remove_status${i}']:checked`).val(),
                    id: ""
                };
                if(!!data["remove_id" + i] && data["remove_id" + i] != "undefined"){
                    temp.id = data["remove_id" + i]
                }
                post_data.tlbCompCCSubSet.push(temp);
                temp = {}
            }
        }else if(ccType == 3){
            for(let i = 0; i < global_data.sublength; i++){
                temp = {
                    name: data["replace_name" + i],
                    onPn: data["replace_onPn" + i],
                    offPn: data["replace_offPn" + i],
                    offSn: data["replace_offSn" + i],
                    onSn: data["replace_onSn" + i],
                    offPosition: data["replace_position" + i],
                    flag: $(`input[name='replace_status${i}']:checked`).val(),
                    id: ""
                };
                if(!!data["replace_id" + i] && data["replace_id" + i] != "undefined"){
                    temp.id = data["replace_id" + i]
                }
                post_data.tlbCompCCSubSet.push(temp);
                temp = {}
            }
        }
        return post_data
    }

    function check_required(data){
        let result = true;
        if(data.ccType == 1){
            if(!data.offAc  || !data.offPn || !data.offPosition || !data.offSn){
                result = false;
            }
        }else if(data.ccType == 2){
            if(!data.onAc  || !data.onPn || !data.onPosition || !data.onSn){
                result = false;
            }
        }else if(data.ccType == 3){
            if(!data.offAc || !data.offPn || !data.offPosition || !data.offSn || !data.onPn || !data.onPosition || !data.onSn){
                result = false;
            }
        }else if(data.ccType == 4){
            if(!data.offAc  || !data.offPn || !data.offPosition || !data.offSn || !data.onAc || !data.onPn || !data.onPosition || !data.onSn){
                result = false;
            }
        }
        if(params.defect_info.workorderId){
            if(data.ccType == 1 || data.ccType == 3){
                if(!data.completeDate || !data.airMaterialState){
                    result = false;
                }
             }
            if( $("#reason").val()=="" || $("#takenAction").val()==""){
                result = false;
            }
        }else {
            if(!data.completeDate ){
                result = false;
            }
        }

        if(!result){
            MsgAlert({type: "error", content: "请填写必填项"});
        }
        return result
    }

    function cc_type_change(data){
        clear_cc_row();
        switch(data){
            case 1:
                $("#off1").show();
                $("#on1").hide();
                $("#on2").hide();
                $("tr[name='replace_tr']").empty();
                $("tr[name='replace_tr']").remove();
                $("#tableReplace").hide();
                $("#tableRemove").show();
                $("#z_hang").show();
                global_data.offAcId = params.defect_info.acId;
                break;
            case 2:
                // if(params.defect_info.workorderId){
                //
                // }
                $("#z_hang").hide();
                $("#onAc1").textbox("setValue", params.defect_info.ac);
                $("#onAc1").textbox({
                    editable: false
                });
                $("#on1").show();
                $("#off1").hide();
                $("#on2").hide();
                $("tr[name='replace_tr']").empty();
                $("tr[name='replace_tr']").remove();
                $("tr[name='remove_tr']").empty();
                $("tr[name='remove_tr']").remove();
                $("#tableReplace").hide();
                $("#tableRemove").hide();
                global_data.onAcId = params.defect_info.acId;
                break;
            case 3:
                $("#off1").show();
                $("#on1").hide();
                $("#on2").show();
                $("tr[name='remove_tr']").empty();
                $("tr[name='remove_tr']").remove();
                $("#tableRemove").hide();
                $("#tableReplace").show();
                $("#z_hang").show();
                global_data.offAcId = params.defect_info.acId;
                break;
            case 4:
                // if(params.defect_info.workorderId){
                //
                // }
                $("#z_hang").hide();
                $("#off1").show();
                $("#on1").show();
                $("#onAc1").textbox({
                    editable: true
                });
                $("#on2").hide();
                $("#tableReplace").hide();
                $("#tableRemove").hide();
                $("tr[name='replace_tr']").empty();
                $("tr[name='replace_tr']").remove();
                $("tr[name='remove_tr']").empty();
                $("tr[name='remove_tr']").remove();
                break;
        }
    }

    function clear_cc_row(){
        let id = ["offName", "offPn", "offSn", "offPosition", "onAc1", "onName1", "onPn1", "onSn1", "onPosition1", "onPn2", "onSn2"];
        id.forEach(key=>{
            $("#" + key).textbox("clear")
        })
    }

    /**
     * 初始化easyUI组件
     */
    function init_page(){
        $("#offAc").textbox({
            editable: false,
            value: params.defect_info.ac
        });

        $("#offName").textbox({

        });
        $("#offSn").textbox({
            required: true,
        });
        $(".weizhi").textbox({
        });
        $("#offSn").next("span").children().first().blur(get_component_list);
        $("#onAc1").textbox({
            required: true,
            icons: [{
                iconCls:'icon-search',
                handler: function(e){
                    acQuery()
                }
            }]
        });
        $('#ACQueryWindow').window('close');

        $("#onName1").textbox({

        });
        $("#onSn1").textbox({
            required: true,
        });
        // $("#onAc2").textbox();

        // $("#onName2").textbox();
        $("#onSn2").textbox({
            required: true,
        });
        $("#offPn").textbox({
            required: true,
            editable: false,
            icons: [{
                iconCls:'icon-search',
                handler: function(e){
                    $.pnSelect({
                        success: data=>{
                            off_ongouxin(1,data.partno);
                            $("#offPn").textbox("setValue", data.partno);
                            $("#gouxin").combobox("setValue", "");
                            $("#offPosition").combobox();
                            get_component_list()
                        }
                    })
                }
            }]
        });
        $('#airMaterial').combobox({
            required: true,
            editable: false,
            data: air_material_state_list,
            valueField:'value',
            textField:'label',
            panelHeight: '70px',
        });

        $('.gouxin_com').combobox({
            required: true,
            editable: false,
            data: [],
            valueField:'value',
            textField:'label',
            panelHeight: '70px',
        });

        $('.off_onPosition').combobox({
            required: true,
            data: [],
            panelHeight: '70px',
        });
        $("#onPn1").textbox({
            required: true,
            editable: false,
            icons: [{
                iconCls:'icon-search',
                handler: function(e){
                    $.pnSelect({
                        success: data=>{
                             off_ongouxin(2,data.partno);
                            $("#onPn1").textbox("setValue", data.partno);
                            $("#gouxin1").textbox("setValue", "");
                            $("#onPosition1").textbox("setValue", "");
                            get_component_list()
                        }
                    })
                }
            }]
        });
        $("#onPn2").textbox({
            required: true,
            editable: false,
            icons: [{
                iconCls:'icon-search',
                handler: function(e){
                    $.pnSelect({
                        success: data=>{
                            // off_ongouxin(3,data.partno);
                            // $("#onPn2").textbox("setValue", data.partno);
                            // $("#gouxin2").textbox("setValue", "");
                            // $("#onPosition2").textbox("setValue", "");
                            get_component_list()
                        }
                    })
                }
            }]
        });
        $("#completeDate").datetimebox({
            required: true,
            value: params.defect_info.completeDate,
            editable: false,
            showSecond: true
        });
        $("#flightNo").textbox({
            editable: false,
            value: params.defect_info.flightNo
        });
        $("#flightId").val(params.defect_info.flightId);
        $("#remove").attr("checked", "checked");
        cc_type_change(1);
        if(params.operation == "edit"){
            $("input[name='ccType']").attr("disabled", "disabled");
        }
    }

    function off_ongouxin(inde,obj) {
        let ac="";
        if(inde==1){
            ac=global_data.offAcId;
        }else if(inde==2){
            ac=global_data.onAcId;
        }else if(inde==3){
            ac=global_data.offAcId;
        }
        $.ajax({
            type: "GET",
            url: "/config/pos/queryCin?pn="+obj+"&acId="+ac,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                console.log(data);
                if(inde==1){
                    if(typeof(data.data)!="undefined"){
                    if(data.data.length>0){
                        gouxinFlag = true;
                    }else if(data.data.length==0){
                        gouxinFlag = false;
                    }
                    }
                    $('#gouxin').combobox({
                        valueField: 'cin',
                        textField: 'cin',
                        data: data.data,
                        onSelect:function () {
                            $("#offPosition").textbox("setValue", "");
                            position_list(1);

                        }
                    });
                }else if(inde==2){
                    if(typeof(data.data)!="undefined"){
                        if(data.data.length>0){
                            gouxinFlag1 = true;
                        }else if(data.data.length==0){
                            gouxinFlag1 = false;
                        }
                    }
                    $('#gouxin1').combobox({
                        valueField: 'cin',
                        textField: 'cin',
                        data: data.data,
                        onSelect:function () {
                            $("#onPosition1").textbox("setValue", "");
                            position_list(2);
                        }
                    });
                }else if(inde==3){
                    // $('#gouxin2').combobox({
                    //     valueField: 'cin',
                    //     textField: 'cin',
                    //     data: data.data,
                    //     onSelect:function () {
                    //         $("#onPosition2").textbox("setValue", "");
                    //         position_list(3);
                    //     }
                    // });
                }
            },
            error: function () {
                window.alert("查询失败！");
            }
        });

    }
    //查询A/C的点击事件
    function acQuery() {
        $('#ACQueryWindow').window('open');
        InitACDataGrid();
    }

    function InitACDataGrid() {
        $("#ACDg").MyDataGrid({
            identity: 'ACDg',
            sortable: true,
            singleSelect: true,
            pagination: true,     //开启分页
            fitColumns: true,
            striped: false,
            showHeader: false,
            columns: {
                param: {FunctionCode: 'FLB_AC_LIST'},
                alter: {}
            },
            onLoadSuccess: function () {
            },
            // 固定表格所占整个表格高度
            resize: function () {
                return {width: "100%", height: "100%"}
                // return tabs_standard_resize($('#tt'), 0.45, 0.54, 140, -6);
            },
            contextMenus: [],
            toolbar: [],
            onClickRow: function (rowIndex, rowData) {
            },
            onDblClickRow: function () {
                var row = $('#ACDg').datagrid('getSelected'); //获取所选行的数据
                $("#onAc1").textbox("setValue", row.tail); //给station控件赋值
                global_data.onAcId = row.acId;
                position_list(3);
                $('#ACQueryWindow').window('close'); //关闭弹窗
            }
        });
    }

    /**
     * 关闭当前addCC窗口
     * @return {void}
     */
    function close_window(){
        window.opener=null;
        window.open('','_self');
        window.close();
    }
    function position_list(inde){
        var ac='';
        var pn='';
        var gou="";
       if(inde==1){
           ac=global_data.offAcId;
           pn=$("#offPn").textbox("getValue");
           gou=$("#gouxin").combobox("getValue");
       }else if(inde==2){
           ac=global_data.onAcId;
           pn=$("#onPn1").textbox("getValue");
           gou=$("#gouxin1").combobox("getValue");
       }else if(inde==3){
           ac=global_data.offAcId;
           pn=$("#onPn2").textbox("getValue");
           // gou=$("#gouxin2").combobox("getValue");
       }
        $.ajax({
            type: "GET",
            url: "/config/pos/list?cin=" + gou + "&acId="+ac+"&pn="+pn,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                console.log(data.data);
                if(inde==1){
                    $('#offPosition').combobox({
                        valueField: 'value',
                        textField: 'name',
                        data: data.data,
                        onHidePanel: function () {
                            if(data.data.length>0){
                                var t = $(this).combobox('getValue');
                                if (t != null && t != '' & t != undefined) {
                                    if (off_tion == null || t != off_tion.name) {//没有选择或者选项不相等时清除内容
                                        alert('请选择，不要直接输入！');
                                        $(this).combobox({value: ''});
                                    }
                                }
                            }
                        },
                        onSelect: function (record) {
                            off_tion = record;
                        }
                    });
                }else if(inde==2){
                    $('#onPosition1').combobox({
                        valueField: 'value',
                        textField: 'name',
                        data: data.data,
                        onHidePanel: function () {
                            if(data.data.length>0){
                                var t = $(this).combobox('getValue');
                                if (t != null && t != '' & t != undefined) {
                                    if (on_tion == null || t != on_tion.name) {//没有选择或者选项不相等时清除内容
                                        alert('请选择，不要直接输入！');
                                        $(this).combobox({value: ''});
                                    }
                                }
                            }
                        },
                        onSelect: function (record) {
                            on_tion = record;
                        }
                    });
                }else if(inde==3){
                    // $('#onPosition2').combobox({
                    //     valueField: 'value',
                    //     textField: 'name',
                    //     data: data.data,
                    //     onHidePanel: function () {
                    //         if(data.data.length>0){
                    //             var t = $(this).combobox('getValue');
                    //             if (t != null && t != '' & t != undefined) {
                    //                 if (onn_tion == null || t != onn_tion.name) {//没有选择或者选项不相等时清除内容
                    //                     alert('请选择，不要直接输入！');
                    //                     $(this).combobox({value: ''});
                    //                 }
                    //             }
                    //         }
                    //     },
                    //     onSelect: function (record) {
                    //         onn_tion = record;
                    //     }
                    //
                    // });
                }
            },
            error: function () {
                window.alert("查询失败！");
            }
        });
    }

    $(function(){
        init_page();
        get_data();

    })


    //编辑时调用
    function eidtposition_list(inde,obj){
        var ac='';
        var pn='';
        var gou="";
        if(inde==1){
            ac=obj.offAcId;
            pn=obj.offPn;
            gou=obj.cin;
        }else if(inde==2){
            ac=obj.onAcId;
            pn=obj.onPn;
            gou=obj.onCin;
        }else if(inde==3){
            ac=obj.offAcId;
            pn=obj.offPn;
            gou=obj.cin;
        }
        $.ajax({
            type: "GET",
            url: "/config/pos/list?cin=" + gou + "&acId="+ac+"&pn="+pn,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                console.log(data.data);
                if(inde==1){
                    $('#offPosition').combobox({
                        valueField: 'value',
                        textField: 'name',
                        data: data.data,
                        onHidePanel: function () {
                            if(data.data.length>0){
                                var t = $(this).combobox('getValue');
                                if (t != null && t != '' & t != undefined) {
                                    if (off_tion == null || t != off_tion.name) {//没有选择或者选项不相等时清除内容
                                        alert('请选择，不要直接输入！');
                                        $(this).combobox({value: ''});
                                    }
                                }
                            }
                        },
                        onSelect: function (record) {
                            off_tion = record;
                        }
                    });
                    $('#offPosition').textbox("setValue",obj.offPosition);
                }else if(inde==2){
                    $('#onPosition1').combobox({
                        valueField: 'value',
                        textField: 'name',
                        data: data.data,
                        value:obj.onPosition,
                        onHidePanel: function () {
                            if(data.data.length>0){
                                var t = $(this).combobox('getValue');
                                if (t != null && t != '' & t != undefined) {
                                    if (on_tion == null || t != on_tion.name) {//没有选择或者选项不相等时清除内容
                                        alert('请选择，不要直接输入！');
                                        $(this).combobox({value: ''});
                                    }
                                }
                            }
                        },
                        onSelect: function (record) {
                            on_tion = record;
                        }
                    });
                    $('#onPosition1').textbox("setValue",obj.onPosition);
                }else if(inde==3){
                    // $('#onPosition2').combobox({
                    //     valueField: 'value',
                    //     textField: 'name',
                    //     data: data.data,
                    //     onHidePanel: function () {
                    //         if(data.data.length>0){
                    //             var t = $(this).combobox('getValue');
                    //             if (t != null && t != '' & t != undefined) {
                    //                 if (onn_tion == null || t != onn_tion.name) {//没有选择或者选项不相等时清除内容
                    //                     alert('请选择，不要直接输入！');
                    //                     $(this).combobox({value: ''});
                    //                 }
                    //             }
                    //         }
                    //     },
                    //     onSelect: function (record) {
                    //         onn_tion = record;
                    //     }
                    //
                    // });
                    // $('#onPosition2').textbox("setValue",obj.offPosition);
                }
            },
            error: function () {
                window.alert("查询失败！");
            }
        });
    }

    function editoff_ongouxin(inde,obj) {
        var ac='';
        var pn='';

        if(inde==1){
            ac=obj.offAcId;
            pn=obj.offPn;
        }else if(inde==2){
            ac=obj.onAcId;
            pn=obj.onPn;
        }else if(inde==3){
            ac=obj.offAcId;
            pn=obj.offPn;
        }
        $.ajax({
            type: "GET",
            url: "/config/pos/queryCin?pn="+pn+"&acId="+ac,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                console.log(data);
                if(inde==1){
                    $('#gouxin').combobox({
                        valueField: 'cin',
                        textField: 'cin',
                        data: data.data,
                        onSelect:function () {
                            $("#offPosition").textbox("setValue", "");
                            position_list(1);

                        }
                    });
                    $('#gouxin').textbox("setValue",obj.cin);
                }else if(inde==2){
                    $('#gouxin1').combobox({
                        valueField: 'cin',
                        textField: 'cin',
                        data: data.data,
                        onSelect:function () {
                            $("#offPosition1").textbox("setValue", "");
                            position_list(2);
                        }
                    });
                    $('#gouxin1').textbox("setValue",obj.onCin);
                }else if(inde==3){
                    // $('#gouxin2').combobox({
                    //     valueField: 'cin',
                    //     textField: 'cin',
                    //     data: data.data,
                    //     onSelect:function () {
                    //         $("#offPosition2").textbox("setValue", "");
                    //         position_list(3);
                    //     }
                    // });
                    // $('#gouxin2').textbox("setValue",obj.cin);
                }
            },
            error: function () {
                window.alert("查询失败！");
            }
        });

    }

</script>
</body>
</html>