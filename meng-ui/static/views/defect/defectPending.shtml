<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->
    <!-- <script type="text/javascript" src="http://10.88.15.51:8080/js/jquery/lhgdialog/lhgdialog.js"></script> -->
    <style type="text/css" scoped>
        .table-cell {
            text-align: center;
            padding: 0;
            margin: 0;
        }

        .cell-normal {
            height: 40px;
            line-height: 40px;
        }

        .cell-high {
            height: 100px;
        }

        input[type="radio"], input[type="checkbox"] {
            vertical-align: -2px
        }

        td, #dm, #RIIRCI {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }



        .foot-btns {
            float: right;
            margin: 10px 20px 0 0;
        }
        .button_a {
            text-align: right;
            margin-top: 10px;
        }

        .button_a a {
            display: inline-block;
            cursor: pointer;
            background: #2465a8;
            color: #fff;
            border-radius: 4px;
            padding: 5px 20px;
            border: none;
            font-size: 14px;
            margin-right: 12px;
        }
    </style>
</head>
<body>
<table class="table table-bordered table-info" width="100%" style="padding-top:10px">
    <tr>
        <th class="table-cell cell-normal" style="width: 16%">Total FLT Hours</th>
        <td class="table-cell cell-normal" style="width: 16%">
            <input style="width: 90%" class="easyui-textbox" id="fltHours" disabled="true"/>
        </td>
        <th class="table-cell cell-normal" style="width: 16%">Total FLT Cycles</th>
        <td class="table-cell cell-normal" style="width: 16%">
            <input style="width: 90%" class="easyui-textbox" id="fltCycles" disabled="true"/>
        </td>
        <th class="table-cell cell-normal required" style="width: 16%">Model</th>
        <td class="table-cell cell-normal" style="width: 16%">
            <input class="easyui-textbox" disabled="true" id="acModel" style="width: 90%"/>
        </td>
    </tr>
    <tr>
        <th class="table-cell cell-normal required" style="width: 16%">Tlb No</th>
        <td class="table-cell cell-normal" style="width: 16%">
            <input class="easyui-textbox" id="tlbNo" style="width: 90%" validType="number"/>
        </td>
        <th class="table-cell cell-normal required" style="width: 16%">飞机号</th>
        <td class="table-cell cell-normal" style="width: 16%">
            <input style="width: 90%" class="easyui-textbox" id="acReg" disabled="true"/>
        </td>
        <th class="table-cell cell-normal required">ZONE</th>
        <td class="table-cell cell-normal">
            <input class="easyui-textbox" id="zone" name="zone" style="width: 90%"/>
        </td>
    </tr>
    <tr>
        <th class="table-cell cell-normal required" style="width: 16%">Reasons</th>
        <td class="table-cell cell-normal" colspan="5">
            <form id="reasons"></form>
        </td>
    </tr>
    </td>
    <th class="table-cell cell-normal required" style="width: 16%"><span>Finder Sign</span></th>
    <td class="table-cell cell-normal">
        <input  class="easyui-textbox " id="finderSign" style="width: 90%"/>
    <tr>
        <!--<th class="table-cell cell-normal" style="width: 16%">Others</th>-->
        <!--<td class="table-cell cell-normal" style="width: 16%">-->
        <!--<input style="width: 90%" class="easyui-textbox" id="others"/>-->
        <!--</td>-->
        <th class="table-cell cell-normal required" style="width: 16%">Affected ENG</th>
        <td class="table-cell cell-normal" style="width: 16%">
            <input class="easyui-textbox" disabled="true" id="affecteEng" style="width: 90%"/>
        </td>
        <th class="table-cell cell-normal required" style="width: 16%"><span id="baoliu"
                                                                             style="display:none;">保留编号</span><span
                id="pending" style="display:none;">pending编号</span></th>
        <td class="table-cell cell-normal" style="width: 16%">
            <input class="easyui-textbox" disabled="true" id="pendNo" style="width: 90%"/>
        </td>
        <th class="table-cell cell-normal required" style="width: 16%">Category</th>
        <td class="table-cell cell-normal">
            <input style="width: 90%" class="easyui-textbox" id="category"/>
            <div id="categoryOtherDiv"><input style="width: 90%" class="easyui-textbox" id="categoryOther"
                                              editable="false"/></div>
            </div>
        </td>
    </tr>
    <tr>
        <th class="table-cell cell-normal required" style="width: 16%">Expired Date</th>
        <td class="table-cell cell-normal" style="width: 16%">
            <input style="width: 90%" class="easyui-textbox" id="expiredDate" disabled="true"/>
        </td>
        <th class="table-cell cell-normal required" style="width: 16%">Reference</th>
        <td class="table-cell cell-normal" style="width: 16%">
            <input style="width: 90%" class="easyui-textbox" id="reference"/>
        </td>
        <td class="table-cell cell-normal" style="width: 16%">
            <input style="width: 90%" class="easyui-textbox" id="referenceOther"/>
            <input style="display: none;"  id = "melCTitle"/>
            <input style="display: none;" id = "melETitle"/>
        </td>
        <th class="table-cell cell-normal " style="width: 16%">DM<span style="color: red">*</span>：
            <form style="display: inline-block; font-weight: normal;" id="dm">
                <label><input type="radio" name="dm" id="dmYes" value="y">是</label>
                <label><input type="radio" name="dm" id="dmNo" style="margin-left: 15px" value="n">否</label>
            </form>
        </th>
    </tr>
    <tr>
        <th class="table-cell cell-normal required" style="width: 16%">ManHours</th>
        <td class="table-cell cell-normal" style="width: 16%">
            <input style="width: 90%" class="easyui-textbox" id="manHours"/>
        </td>
        <!--<th class="table-cell cell-normal" style="width: 16%">DLY/CNL</th>-->
        <!--<td class="table-cell cell-normal" style="width: 16%">-->
        <!--<input type="checkbox" name="dlyCnl" id="dlyCnl">-->
        <!--</td>-->

        <th class="table-cell cell-normal required" style="width: 16%">Apply Date</th>
        <td class="table-cell cell-normal" style="width: 16%">
            <input class="easyui-textbox" disabled="true" id="applyDate" style="width: 90%"/>
        </td>

        <th class="table-cell cell-normal" style="width: 16%" id="RIIRCI">
            <label>RII<input style="margin: 0 10px 0 5px" type="checkbox" onchange="rii_change()" name="RII" id="RII"/></label>
            <label>RCI<input style="margin: 0 0px 0 5px" type="checkbox" onchange="rci_change()" name="RCI"
                             id="RCI"/></label>
        </th>
        <td class="table-cell cell-normal">
            Sign
            <input style="width: 70%; display: inline-block;" class="easyui-textbox" id="sign" editable="false"/>
        </td>
    </tr>
    <tr>
        <th class="table-cell cell-high required" style="width: 16%">FAULT REPORT(CHN)</th>
        <td class="table-cell cell-high" colspan="2" style="width: 16%">
            <textarea id="chineseReport" maxlength="1000" style="height: 100%;width: 100%;resize: none;"></textarea>
        </td>
        <th class="table-cell cell-high required" style="width: 16%">FAULT REPORT(ENG)</th>
        <td class="table-cell cell-high" colspan="2" style="width: 16%">
            <textarea id="englishReport" maxlength="1000" style="height: 100%;width: 100%;resize: none;"></textarea>
        </td>
    </tr>
    <tr>
        <th class="table-cell cell-normal" style="width: 16%">Placard</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <form style="" id="placard">
                <input type="radio" name="placard" id="placardYes" value="y"><span style="padding-left: 5px">Y</span>
                <input type="radio" name="placard" id="placardNo" style="margin-left: 15px" value="n"><span
                    style="padding-left: 5px">N</span>
            </form>
        </td>
        <th class="table-cell cell-normal" style="width: 16%">Maintenace Caution Item</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <form style="" id="MCI">
                <input type="radio" name="MCItem" id="MCItemYes" value="y"><span style="padding-left: 5px">Y</span>
                <input type="radio" name="MCItem" id="MCItemNo" style="margin-left: 15px" value="n"><span
                    style="padding-left: 5px">N</span>
            </form>
        </td>
    </tr>
    <tr>
        <th class="table-cell cell-normal" style="width: 16%">（M）Item</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <form style="" id="MItem">
                <input type="radio" name="MItem" id="MItemYes" value="y"><span style="padding-left: 5px">Y</span>
                <input type="radio" name="MItem" id="MItemNo" style="margin-left: 15px" value="n"><span
                    style="padding-left: 5px">N</span>
            </form>
        </td>
        <th class="table-cell cell-normal" style="width: 16%">执行“备注或例外”SPECIAL REQUIREMENT</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <form style="" id="SQ">
                <input type="radio" name="SQ" id="SQYes" value="y"><span style="padding-left: 5px">Y</span>
                <input type="radio" name="SQ" id="SQNo" style="margin-left: 15px" value="n"><span
                    style="padding-left: 5px">N</span>
            </form>
        </td>
    </tr>
    <tr>
        <th class="table-cell cell-normal" style="width: 16%">每个飞行前检查 REVIEW EACH PREFLIGHT</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <form style="" id="reviewBefore">
                <input type="radio" name="reviewBefore" id="reviewBeforeYes" value="y" onchange="reviewBeforeConfirm()"><span
                    style="padding-left: 5px">Y</span>
                <input type="radio" name="reviewBefore" id="reviewBeforeNo" style="margin-left: 15px" value="n"><span
                    style="padding-left: 5px">N</span>
            </form>
        </td>
        <th class="table-cell cell-normal" style="width: 16%">每个飞行日检查 REVIEW EACH FLYING DAY</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <form style="" id="reviewDuring">
                <input type="radio" name="reviewDuring" id="reviewDuringYes" value="y"><span
                    style="padding-left: 5px">Y</span>
                <input type="radio" name="reviewDuring" id="reviewDuringNo" style="margin-left: 15px" value="n"><span
                    style="padding-left: 5px">N</span>
            </form>
        </td>
    </tr>
    <tr>
        <th class="table-cell cell-normal" style="width: 16%">是否有O项（O）ITEM</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <form style="" id="OItem">
                <input type="radio" name="OItem" id="OItemYes" value="y"><span style="padding-left: 5px">Y</span>
                <input type="radio" name="OItem" id="OItemNo" style="margin-left: 15px" value="n"><span
                    style="padding-left: 5px">N</span>
            </form>
        </td>
        <th class="table-cell cell-normal" style="width: 16%">Flight Crews Notified</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <form style="" id="FCN">
                <input type="radio" name="FCN" id="FCNYes" value="y"><span style="padding-left: 5px">Y</span>
                <input type="radio" name="FCN" id="FCNNo" style="margin-left: 15px" value="n"><span
                    style="padding-left: 5px">N</span>
            </form>
        </td>
    </tr>
    <tr>
        <th class="table-cell cell-normal" style="width: 16%">EWIS</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <form style="" id="EWIS">
                <input type="radio" name="EWIS" id="EWISYes" value="y" onchange="ewis_y()"><span
                    style="padding-left: 5px">Y</span>
                <input type="radio" name="EWIS" id="EWISNo" style="margin-left: 15px" value="n"
                       onchange="ewis_n()"><span style="padding-left: 5px">N</span>
            </form>
        </td>
        <th class="table-cell cell-normal" style="width: 16%">油液渗漏</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <form style="" id="oilSpill">
                <input type="radio" name="oilSpill" id="oilSpillYes" value="y" onchange="os_y()"><span
                    style="padding-left: 5px">Y</span>
                <input type="radio" name="oilSpill" id="oilSpillNo" style="margin-left: 15px" value="n"
                       onchange="os_n()"><span style="padding-left: 5px">N</span>
            </form>
        </td>
    </tr>
    <!-- <tr>
        <td id="EWISTable" colspan="99"></td>
    </tr> -->
    <tr>
        <th class="table-cell cell-normal" style="width: 16%">Requested By</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <input style="width: 90%" class="easyui-textbox" id="requestedBy" disabled="true"/>
            <input id="requester" type="hidden"/>
            <input id="requesterNo" type="hidden"/>
        </td>
        <th class="table-cell cell-normal required" style="width: 16%">License No.</th>
        <td class="table-cell cell-normal" colspan="2" style="width: 16%">
            <input style="width: 90%" class="easyui-textbox" id="license"/>
        </td>
    </tr>
    <tr>
        <th >ATTACH PATH</th>
        <td colspan="3" id="upload">ATTACH PATH</td>
    </tr>
</table>
<div class="foot-btns">
    <a class="searchBtn" data-options="iconCls:'icon-clear'" onclick="checkEwis('save')" style="margin-right: 10px;" type="button">
        <span data-i18n="common:COMMON_OPERATION.SAVE"></span>
    </a>
    <a class="searchBtn" data-options="iconCls:'icon-clear'" id="submitBtn" onclick="checkEwis('tanchuang')"
       style="margin-right: 10px;"
       type="button">
        <span data-i18n="common:COMMON_OPERATION.SUBMIT">提交</span>
    </a>
    <!--<a class="searchBtn" data-options="iconCls:'icon-clear'" id="extentionBtn" onclick="extention()"
       style="margin-right: 10px;"
       type="button">
        <span data-i18n="common:COMMON_OPERATION.EXTENTION">续保</span>
    </a>-->
    <a class="ridoBtn" data-options="iconCls:'icon-clear'" id="cancelBtn" onclick="close_window()" type="button">
        <span data-i18n="common:COMMON_OPERATION.CANCEL"></span>
    </a>
</div>
<div class="easyui-window" data-options="iconCls:'icon-save',modal:true" id="submit_add"
     style="width:350px;height:220px;padding:10px;display: none;"
     title="请选择保留审核人">
    <!--    add状态提交弹窗-->
    <div style="    width: 100%;height: 118px;text-align: center;">
        <input class="easyui-textbox easyui-validatebox"
               data-options="validType:['maxLength[20]'] " id="rectPlanUpdatedSn"
               name="rectPlanUpdatedSn" style=" width:85%;"/>
        <div class="rectPlanUpdatedSn" style="display: none">
            <input class="name_in" id="name_id">
        </div>
    </div>
    <div class="button_a">
        <a onclick=" fangan();">确定</a>
    </div>
</div>
<script type="text/javascript" src="/js/upload_file.js"></script>
<script type="text/javascript">
    const params = getParentParam_();
    let userName;
    let userId;
    //注：转代办的时候getLoginInfo()方法报错导致程序中断故直接使用传来的字段
    if(!!params.userName && !!params.userId){
        userName = params.userName;
        userId = params.userId;
    }else {
        userName = getLoginInfo().userName;
        userId = getLoginInfo().accountNumber;
    }
    /** reasons选项的配置 **/
    const reasons_list = [
        {
            value: "Material",
            label: "Material",
            name: "Material"
        },
        {
            value: "Ground Time",
            label: "Ground Time",
            name: "Ground Time"
        },
        {
            value: "Tooling",
            label: "Tooling",
            name: "Tooling"
        },
        {
            value: "Engineering",
            label: "Engineering",
            name: "Engineering"
        },
    ];

    /** category选项配置 **/
    const category_list = [
        {
            value: "a",
            label: "A: 一天",
            name: "a",
            days: 1
        },
        {
            value: "b",
            label: "B: 三天",
            name: "b",
            days: 3
        },
        {
            value: "c",
            label: "C: 十天",
            name: "c",
            days: 10
        },
        {
            value: "d",
            label: "D: 一百二十天",
            name: "d",
            days: 120
        },
        {
            value: "other",
            label: "OTHER",
            name: "other"
        }
    ];

    /** 故障保留category选项配置 **/
    const category_list_deferral = [
        {
            value: "a",
            label: "A: ",
            name: "a",
        },
        {
            value: "b",
            label: "B: 三天",
            name: "b",
            days: 3
        },
        {
            value: "c",
            label: "C: 十天",
            name: "c",
            days: 10
        },
        {
            value: "d",
            label: "D: 一百二十天",
            name: "d",
            days: 120
        },
        {
            value: "other",
            label: "OTHER",
            name: "other"
        }
    ];

    /** reference选项配置 **/
    const reference_list = [
        {
            value: "MEL",
            label: "MEL",
            name: "MEL"
        },
        {
            value: "CDL",
            label: "CDL",
            name: "CDL"
        },
        {
            value: "TE",
            label: "TE",
            name: "TE"
        },
        {
            value: "AMM",
            label: "AMM",
            name: "AMM"
        },
        {
            value: "SRM",
            label: "SRM",
            name: "SRM"
        },
        {
            value: "FIM",
            label: "FIM",
            name: "FIM"
        },
        {
            value: "OTHERS",
            label: "OTHERS",
            name: "OTHERS"
        }
    ];

    /** 故障保留reference选项配置 **/
    const reference_list_deferral = [
        {
            value: "MEL",
            label: "MEL",
            name: "MEL"
        },
        {
            value: "CDL",
            label: "CDL",
            name: "CDL"
        },
        {
            value: "TE",
            label: "TE",
            name: "TE"
        }
    ];

    /** 保存页面临时信息的全局变量 **/
    var global_data = {
        fh: "",
        fc: "",
        calendarDays: "",
        flyingDays: "",
        id: "",
        actionId: "",
        tlbId: "",
        dueDataId: "",
        fhTotal: "",
        cyTotal: "",
        isUpdate: "",
        zone_id: "",
        dbiDate:''
    };


    /** 添加必填标志 **/
    function add_require() {
        $(".required").append("<span style='color: red'>*</span>")
    }

    /** 所有easyui组件的初始化 **/
    function init_page() {

        add_require();
        $.ajax({cache: false});
        $("#reasons").checkboxList({
            data: reasons_list
        });
        $("#category").combobox({
            data: params.operation === "PEND" ? category_list : category_list_deferral,
            editable: false,
            panelHeight: '120px',
            valueField: 'value',
            textField: 'label',
            onSelect: (data) => {
                clear_category();
                let cc = $("#reference").combobox('getValue');
                if ((data.name === "other" || data.name === "a") && cc !== 'AMM' && cc !== 'SRM'&& cc !== 'FIM' && cc !== 'OTHERS') {
                    $("#categoryOtherDiv").show();
                    $("#expiredDate").datetimebox("clear");
                    category_other()
                } else {
                    $("#categoryOtherDiv").hide();
                    let res_date = calculate_expired_date(data.days,global_data.dbiDate);
                    $("#expiredDate").datetimebox("setValue", formatterDate(res_date))
                }
            }
        });
        $("#reference").combobox({
            data: params.operation === "PEND" ? reference_list : reference_list_deferral,
            editable: false,
            panelHeight: '160px',
            valueField: 'value',
            textField: 'label',
            onSelect: (data) => {
                if (data.value === "CDL" || data.value === "MEL" || data.value === "TE") {
                    $("#category").combobox({
                        data:category_list_deferral
                    });
                    if (data.value === "CDL"){
                        $("#category").combobox("setValue", "d");
                    }
                    $("#categoryOtherDiv").hide();
                    let res_date = calculate_expired_date(120, global_data.dbiDate);
                    $("#expiredDate").datetimebox("setValue", formatterDate(res_date))
                    $("#category").combobox('readonly',false);

                } else {
                    $("#categoryOtherDiv").hide();
                    $("#category").combobox({
                        data:category_list
                    });
                    if(params.operation === "PEND"){
                        $("#category").combobox('setValue','d');
                        $("#category").combobox('readonly',true);
                        let cc_date = calculate_expired_date(120,global_data.dbiDate);
                        $("#expiredDate").datetimebox("setValue", formatterDate(cc_date))
                    }
                }
                selectCategory(data.value);
            }
        });
        $("#applyDate").datetimebox({
            showSeconds: true
        });
        $("#expiredDate").datetimebox({
            showSeconds: true
        });
        $('#sign').textbox({
            disabled: true,
            icons: [{
                iconCls: 'icon-search',
                handler: function (e) {
                    $.dialog.setting.extendDrag = true;
                    UserUtils.showDialog({
                        callback: function (data) {
                            let user_info = data[0];
                            $("#sign").textbox("setValue", user_info.userName + "(" + user_info.sn + ")")
                        }
                    });
                }
            }]
        });
        $("#finderSign").textbox({
            value: `${userName}(${userId})`,
            editable: false,
            icons: [{
                iconCls:'icon-search',
                handler: function(e){
                    $.dialog.setting.extendDrag = true;
                    UserUtils.showDialog({
                        callback:function(data){
                            let user_info = data[0];
                            $("#finderSign").textbox("setValue", user_info.userName + "(" + user_info.sn + ")")
                        }
                    });
                }
            }, {
                iconCls:'icon-cross',
                handler: function(e){
                    $("#finderSign").textbox("setValue", "")
                }
            }]
        });
        $("#categoryOther").textbox({
            icons: [{
                iconCls: 'icon-edit',
                handler: (e) => {
                    category_other()
                }
            }]
        });
        $("#categoryOtherDiv").hide();
        //这个地方设置referenceOther只是为了在显示的时候和其它下拉框同时显示
        $("#referenceOther").combobox({
            data:[],
            // editable: false,
            panelHeight: '160px',
            valueField: 'value',
            textField: 'label',
            onSelect: (data) => {
            }
        });

    }

    function ddRenewalInsuranceAttachment(page_data){
        let attData = {};
        attData.attachments = page_data.ddRenewalInsuranceAttachmentList;
        $("#upload").UPLOAD("view",attData.attachments);
    }

    /**
     * category选择other时的弹窗
     */
    function category_other(){
        ShowWindowIframe({
            width: "320",
            height: "200",
            title: "【故障到期日期】",
            param: {data: global_data},
            url: "./categoryOther.shtml"
        });
    }

    function init_data(page_data) {
        global_data.isUpdate = page_data.isUpdate;
        global_data.zone_id = page_data.tlbTechLog.zoneId;
        global_data.dbiDate = page_data.dbi.dateFound || '';
        init_zone(page_data.dbi.model, page_data.tlbTechLog.zoneNo);
        getAllLog(page_data.dbi.model);
         console.log(page_data);
        if (page_data.isUpdate == 1) {
            global_data.id = page_data.defectPend.id;
            global_data.actionId = page_data.defectPend.actionId;
            global_data.tlbId = page_data.tlbTechLog.tlbId;

            // 更新的时候tlbNo和license输入框是禁止输入的
            $("#tlbNo").textbox("disable");
            $("#license").textbox("disable");

            // 只有更新操作的时候才把tlbNo显示出来
            $("#tlbNo").textbox("setValue", page_data.tlbTechLog.tlbNo);
        }
        global_data.dueDataId = page_data.defectPend.ddDueDatas[0].id;
        // if (page_data.defectPend.id) {
        //     $("#tlbNo").textbox("disable");
        //     $("#license").textbox("disable");
        // }
        if (page_data.defectPend.dfralCategory == "other" || page_data.defectPend.dfralCategory == "a" ) {
            $("#categoryOtherDiv").show();
            let other = {
                fh: page_data.defectPend.ddDueDatas[0].fh,
                fc: page_data.defectPend.ddDueDatas[0].fc,
                calendarDays: page_data.defectPend.ddDueDatas[0].calendarDay,
                flyingDays: page_data.defectPend.ddDueDatas[0].flightDay,
            };
            add_category(other)
        }
        //发现人名字工号设置
        if(!!page_data.tlbTechLog) {
            if (page_data.tlbTechLog.technicianFound && page_data.tlbTechLog.technicianFoundNo) {
                $("#finderSign").textbox("setValue", `${page_data.tlbTechLog.technicianFound}(${page_data.tlbTechLog.technicianFoundNo})`)
            }
        }
        var affecteEngType = page_data.dbi.engineType;
        var affecteEngData = "";
        if (affecteEngType) {
            if (affecteEngType == '1') {
                affecteEngData = 'ENG1';
            } else if (affecteEngType == '2') {
                affecteEngData = 'ENG2';
            } else if (affecteEngType == '3') {
                affecteEngData = 'APU';
            }
            affecteEngData = affecteEngData + "  " + page_data.dbi.engineSn;
        }

        $("#affecteEng").textbox("setValue", affecteEngData);

        $("#acModel").textbox("setValue", page_data.dbi.minorModel);
        if(params.operation === "PEND"){
            $("#pendNo").textbox("setValue", page_data.defectPend.pendNo);
        }else if (params.operation === "DEFERRAL"){
            $("#pendNo").textbox("setValue", page_data.defectPend.deferredNo);
        }
        $("#acReg").textbox("setValue", page_data.dbi.acReg);
        $("#zoneNo").textbox("setValue", page_data.tlbTechLog.zoneNo);
        $("#category").combobox("setValue", page_data.defectPend.dfralCategory);
        $("#expiredDate").datetimebox("setValue", page_data.defectPend.expiredDate);
        // $("#categoryOther").textbox("getValue");好像没有
        //如果是故障保留并且 reference不是MEL\CDL\TE的，将reference 和referItem 数据 置空
        if(params.operation=="DEFERRAL" && page_data.defectPend.reference!="MEL"&&page_data.defectPend.reference!="CDL"&&page_data.defectPend.reference!="TE")
        {
            $("#reference").combobox("setValue", "");
            $("#referenceOther").textbox("setValue","");
        }else{
            $("#reference").combobox("setValue", page_data.defectPend.reference);
            $("#referenceOther").textbox("setValue", page_data.defectPend.referItem);
        }
        // let dm = $("input[name='dm']:checked").val();
        if (page_data.defectPend.dm == "y") {
            $("#dmYes").attr("checked", "checked");
        } else if (page_data.defectPend.dm == "n") {
            $("#dmNo").attr("checked", "checked");
        }
        $("#manHours").textbox("setValue", page_data.tlbTechLog.manHours);
        // if (page_data.tlbTechLog.dlyCnl == "y") {
        //     $("input[name='dlyCnl']").prop("checked", true);
        // } else if (page_data.tlbTechLog.dlyCnl == "n") {
        //     $("input[name='dlyCnl']").prop("checked", false);
        // }
        if (page_data.tlbTechLog.rii == "y") {
            $("input[name='RII']").prop("checked", true);
            $("#sign").textbox("enable")
        } else if (page_data.tlbTechLog.rii == "n") {
            $("input[name='RII']").prop("checked", false);
        }
        if (page_data.tlbTechLog.rci == "y") {
            $("input[name='RCI']").prop("checked", true);
            $("#sign").textbox("enable")
        } else if (page_data.tlbTechLog.rci == "n") {
            $("input[name='RCI']").prop("checked", false);
        }
        if (!!page_data.tlbTechLog.inspector && !!page_data.tlbTechLog.inspectorNo) {
            $("#sign").textbox("setValue", `${page_data.tlbTechLog.inspector}(${page_data.tlbTechLog.inspectorNo})`);
        }
        if(page_data.isUpdate == 1 ){
            if(page_data.defectPend.id){
                $("#chineseReport").val(page_data.defectPend.defectDescChn);
                $("#englishReport").val(page_data.defectPend.defectDescEng);
            }else {
                $("#chineseReport").val(page_data.dbi.faultReportChn);
                $("#englishReport").val(page_data.dbi.faultReportEng);
            }
        }
        if (page_data.defectPend.isPlacard == "y") {
            $("#placardYes").attr("checked", "checked");
        } else { //if(page_data.defectPend.isPlacard == "n")
            $("#placardNo").attr("checked", "checked");
        }
        if (page_data.defectPend.isReview == "y") {
            $("#reviewDuringYes").attr("checked", "checked");
        } else { //if(page_data.defectPend.isReview == "n")
            $("#reviewDuringNo").attr("checked", "checked");
        }
        if (page_data.defectPend.isSpecial == "y") {
            $("#SQYes").attr("checked", "checked");
        } else { // if(page_data.defectPend.isSpecial == "n")
            $("#SQNo").attr("checked", "checked");
        }
        if (page_data.defectPend.isO == "y") {
            $("#OItemYes").attr("checked", "checked");
        } else { //if(page_data.defectPend.isO == "n")
            $("#OItemNo").attr("checked", "checked");
        }
        if (page_data.defectPend.isM == "y") {
            $("#MItemYes").attr("checked", "checked");
        } else { //if(page_data.defectPend.isM == "n")
            $("#MItemNo").attr("checked", "checked");
        }
        if (page_data.defectPend.isCaution == "y") {
            $("#MCItemYes").attr("checked", "checked");
        } else { //if(page_data.defectPend.isCaution == "n")
            $("#MCItemNo").attr("checked", "checked");
        }
        if (page_data.defectPend.isCheck == "y") {
            $("#reviewBeforeYes").attr("checked", "checked");
        } else {//if(page_data.defectPend.isCheck == "n")
            $("#reviewBeforeNo").attr("checked", "checked");
        }
        if (page_data.defectPend.isNotify == "y") {
            $("#FCNYes").attr("checked", "checked");
        } else { //if(page_data.defectPend.isNotify == "n")
            $("#FCNNo").attr("checked", "checked");
        }
        if (page_data.tlbTechLog.isHasEwis == "y") {
            $("#EWISYes").attr("checked", "checked");
        } else if (page_data.tlbTechLog.isHasEwis == "n") {
            $("#EWISNo").attr("checked", "checked");
        }
        if (page_data.tlbTechLog.isHasOil == "y") {
            $("#oilSpillYes").attr("checked", "checked");
        } else if (page_data.tlbTechLog.isHasOil == "n") {
            $("#oilSpillNo").attr("checked", "checked");
        }
        if (page_data.defectPend.lackMater == "y") {
            $("#reasons").checkboxList("check", "Material")
        }
        if (page_data.defectPend.lackTech == "y") {
            $("#reasons").checkboxList("check", "Engineering")
        }
        if (page_data.defectPend.lackTime == "y") {
            $("#reasons").checkboxList("check", "Ground Time")
        }
        if (page_data.defectPend.lackTool == "y") {
            $("#reasons").checkboxList("check", "Tooling")
        }
        $("#applyDate").datetimebox("setValue", page_data.defectPend.applyDate);

        if (!!page_data.defectPend.requester && !!page_data.defectPend.requesterNo) {
            $("#requestedBy").textbox("setValue", `${page_data.defectPend.requester}(${page_data.defectPend.requesterNo})`);
            $("#requester").val(page_data.defectPend.requester);
            $("#requesterNo").val(page_data.defectPend.requesterNo);
        }

        $("#license").textbox("setValue", page_data.defectPend.requesterLice);
        if (page_data.flbFlightDataVo.cyTotalAll) {
            $("#fltCycles").textbox("setValue", page_data.flbFlightDataVo.cyTotalAll);
            global_data.cyTotal = page_data.flbFlightDataVo.cyTotalAll;
        } else {
            $("#fltCycles").textbox("setValue", "");
        }

        var totalFh;
        if (page_data.flbFlightDataVo.fhTotal) {
            totalFh = page_data.flbFlightDataVo.fhTotal;
            global_data.fhTotal = page_data.flbFlightDataVo.fhTotal;
        }

        if (null != totalFh) {
            totalFh = flbFormatTime(totalFh);
        }
        $("#fltHours").textbox("setValue", totalFh);

        // let isHasOil = $("input[name='oilSpill']:checked").val();
        // let isHasEwis = $("input[name='EWIS']:checked").val();
        let ewis_data = page_data.pageEwislst;
        let oil_data = page_data.pageOillst;
        $("#EWIS").EWIS("setData", ewis_data);
        $("#oilSpill").oilSpill("setData", oil_data);
        ddRenewalInsuranceAttachment(page_data);
    }

    function flbFormatTime(time) {
        var hour = parseInt(time / 60);
        var minute = time % 60;
        hour = hour >= 10 ? hour : ("0" + hour);
        minute = minute >= 10 ? minute : ("0" + minute);
        return hour + ":" + minute;
    }

    /** 页面数据初始化 **/
    function get_data() {
        let url = "";
        if (params.operation === "PEND") {
            $("#pending").show();
            $("#extentionBtn").css('display', 'none');
            $("#submitBtn").css('display', 'none');
            url = `/api/v1/defect/defect/pend/edit/${params.defectId}`;
        } else if (params.operation === "DEFERRAL") {
            $("#baoliu").show();
            // $("#submitBtn").css('display', 'none');
            url = `/api/v1/defect/defect/dfrl/edit/${params.defectId}`;
        }

        if (params && params.btnDisplay) {
            $("#submitBtn").css('display', 'none');
            $("#cancelBtn").css('display', 'none');
        }

        axios.get(url).then(response => {
            if (response.data.msg.indexOf("ERROR") != -1) {
                throw new Error(response.data.msgData[0])
            } else if (response.data.msg.toUpperCase().indexOf("SUCCESS") != -1) {
                if (response.data.data.defectPend) {
                    init_data(response.data.data);
                }
            }
        }).catch(err => {
            MsgAlert({type: "error", content: err.message})
        })
    }

    /** category other 回填 **/
    function add_category(data) {
        for (item in data) {
            global_data[item] = data[item]
        }
        let show_data = "";
        if (global_data.fh) {
            show_data += global_data.fh + "FH "
        }
        if (global_data.fc) {
            show_data += global_data.fc + "FC "
        }
        if (global_data.calendarDays) {
            show_data += global_data.calendarDays + "日历日 "
        }
        if (global_data.flyingDays) {
            show_data += global_data.flyingDays + "飞行日 "
        }
        $("#categoryOther").textbox("setValue", show_data)
    }

    /** category选择时计算失效时间 **/
    function calculate_expired_date(days, start) {
        let startDate = start ? new Date(start) : new Date();
        let current_date_start = new Date(new Date(startDate.toLocaleDateString()).getTime());
        let res_date = new Date(current_date_start.getTime() + 24 * 60 * 60 * 1000 * Number(days + 1) - 1);
        return res_date
    }

    function clear_category() {
        $("#categoryOther").textbox("clear");
        global_data.fh = "";
        global_data.fc = "";
        global_data.calendarDays = "";
        global_data.flyingDays = ""
    }

    function rii_change() {
        $("input[name='RCI']").attr("checked", false);
        $("#sign").textbox("clear");
        let a = $("input[name='RII']").prop("checked");
        if ($("input[name='RII']").prop("checked")) {
            $("#sign").textbox("enable")
        } else {
            $("#sign").textbox("disable")
        }
    }

    function rci_change() {
        $("input[name='RII']").attr("checked", false);
        $("#sign").textbox("clear");
        if ($("input[name='RCI']").prop("checked")) {
            $("#sign").textbox("enable")
        } else {
            $("#sign").textbox("disable")
        }
    }

    function get_post_data() {
        let tlbNo = $("#tlbNo").textbox("getValue");
        // let reasonOther = $("#others").textbox("getValue");
        let category = $("#category").combobox("getValue");
        let expiredDate = $("#expiredDate").datetimebox("getValue");
        // let categoryOther = $("#categoryOther").textbox("getValue");
        let reference = $("#reference").combobox("getValue");
        let referItem = $("#referenceOther").textbox("getValue");
        let dm = $("input[name='dm']:checked").val();
        let manHours = $("#manHours").textbox("getValue");
        // let dlyCnl = $("input[name='dlyCnl']:checked").val() == "on" ? "y" : "n";
        let rii = $("input[name='RII']:checked").val() == "on" ? "y" : "n";
        let rci = $("input[name='RCI']:checked").val() == "on" ? "y" : "n";
        let sign = $("#sign").textbox("getValue");
        let inspectorNo = "";
        let inspector = "";
        let zone = $("#zone").textbox("getValue");
        let zone_id = global_data.zone_id;
        //let affecteEng = $("#affecteEng").textbox("getValue");
        let acModel = $("#acModel").textbox("getValue");
        let pendNo = $("#pendNo").textbox("getValue");
        if (!!sign) {
            inspectorNo = sign.match(/\((.+?)\)/)[1];
            inspector = sign.split("(")[0];
        }
        let faultReportChn = $("#chineseReport").val();
        let faultReportEng = $("#englishReport").val();
        let isPlacard = $("input[name='placard']:checked").val();
        let isCaution = $("input[name='MCItem']:checked").val();
        let isReview = $("input[name='reviewDuring']:checked").val();
        let isCheck = $("input[name='reviewBefore']:checked").val();
        let isSpecial = $("input[name='SQ']:checked").val();
        let isM = $("input[name='MItem']:checked").val();
        let isO = $("input[name='OItem']:checked").val();
        let isNotify = $("input[name='FCN']:checked").val();
        let applyDate = $("#applyDate").datetimebox("getValue");
        let requester = $("#requester").val();
        let requesterNo = $("#requesterNo").val();
        let requesterLice = $("#license").textbox("getValue");
        let totalCy = $("#fltCycles").textbox("getValue");
        let totalFh = $("#fltHours").textbox("getValue");
        let isHasOil = $("input[name='oilSpill']:checked").val();
        let isHasEwis = $("input[name='EWIS']:checked").val();
        let reasons = $("#reasons").checkboxList("getValue");
        //获取发现人名字工号
        let technicianFoundNo= "";
        let technicianFound = "";
        let finderSign = $("#finderSign").textbox("getValue");
        if (finderSign) {
            technicianFoundNo = finderSign.match(/\((.+?)\)/)[1];
            technicianFound = finderSign.split("(")[0];
        };
        let lackMater = "n";
        let lackTech = "n";
        let lackTime = "n";
        let lackTool = "n";
        let melCTitle;
        let melETitle;
        if(reference == 'CDL' || reference == 'MEL'){
            melCTitle = $('#melCTitle').val();
            melETitle = $('#melETitle').val();
        }else {
            melCTitle = '';
            melETitle = '';
        };

        reasons.forEach(item => {
            console.log(item);
            console.log("item");
            if (item == "Material") {
                lackMater = "y"
            }
            if (item == "Tooling") {
                lackTool = "y"
            }
            if (item == "Ground Time") {
                lackTime = "y"
            }
            if (item == "Engineering") {
                lackTech = "y"
            }
        });
        let ewis = $("#EWIS").EWIS("getData");
        let oilSpill = $("#oilSpill").oilSpill("getData");
        let post_data = {
            defectPend: {
                actionId: global_data.actionId,
                applyDate: new Date(applyDate),
                category: "PEND",
                ddDueDatas: [{
                    category: category,
                    categoryExpDate: "",
                    id: global_data.dueDataId,
                    fh: global_data.fh,
                    fc: global_data.fc,
                    calendarDay: global_data.calendarDays,
                    flightDay: global_data.flyingDays
                }],
                defectId: params.defectId,
                dfralCategory: category,
                dm: dm,
                expiredDate: new Date(expiredDate),
                id: global_data.id,
                isCaution: isCaution,
                isCheck: isCheck,
                isM: isM,
                isNotify: isNotify,
                isO: isO,
                isPlacard: isPlacard,
                isReview: isReview,
                isSpecial: isSpecial,
                lackMater: lackMater,
                lackTech: lackTech,
                lackTime: lackTime,
                lackTool: lackTool,
                // pendCount: 0,
                // reasonOther: reasonOther,
                referItem: referItem,
                melCTitle : melCTitle,
                melETitle : melETitle,
                reference: reference,
                requester: requester,
                requesterLice: requesterLice,
                requesterNo: requesterNo,
                // tlbId: global_data.tlbId,
                tlbNo: tlbNo,
                totalCy: global_data.cyTotal,
                totalFh: global_data.fhTotal//,
                //affecteEng: affecteEng,
                //acModel: acModel,
                //pendNo: pendNo,
            },
            ewisList: ewis,
            oilList: oilSpill,
            tlbTechLog: {
                // defectId: 0,
                // dlyCnl: dlyCnl,
                dm: dm,
                faultReportChn: faultReportChn,
                faultReportEng: faultReportEng,
                inspector: inspector,
                inspectorNo: inspectorNo,
                isHasEwis: isHasEwis,
                isHasOil: isHasOil,
                manHours: manHours,
                rci: rci,
                rii: rii,
                tlbId: global_data.tlbId,
                tlbNo: tlbNo,
                zone_no: zone,
                zone_id:zone_id,
                technicianFoundNo:technicianFoundNo,
                technicianFound:technicianFound,
            }
        };
        console.log(post_data);
        return post_data;
    }

    function ewis_y() {
        $("#EWIS").EWIS("create")
    }

    function ewis_n() {
        $("#EWIS").EWIS("destroy")
    }

    function os_y() {
        $("#oilSpill").oilSpill("create")
    }

    function os_n() {
        $("#oilSpill").oilSpill("destroy")
    }
    function validateLine(val) {
        return val ? val:'0';
    }
    function checkEwis(type) {
        let ewis = $("#EWIS").EWIS("getData",'noWarn');
        var acReg = $("#acReg").textbox('getValue');
        if(ewis.length){
            for(let j = 0 ; j < ewis.length; j++){
                if(ewis[j].treatmentMethod == 1 && ewis[j].lineEquipmentType == 1){
                    let delArr = ewis_deleteId.filter(item => item);
                    ewis[j].id && delArr.push(ewis[j].id);
                    for(let k = 0 ; k < ewis[j].lineNumList.length ; k++){
                        var lineNumReg = /^[0]+/;
                        var ind = (k+1).toString();
                        var lineNum1 = $("#ewis_xianhaoOne" + (j+1)+ind).textbox("getValue").replace(lineNumReg,"");
                        var lineNum2 = validateLine($("#ewis_xianhaoTwo" + (j+1)+ind).textbox("getValue").replace(lineNumReg,""));
                        var lineNum3 = validateLine($("#ewis_xianhaoThree" + (j+1)+ind).textbox("getValue").replace(lineNumReg,""));
                        var lineNum4 = validateLine($("#ewis_xianhaoFour" + (j+1)+ind).textbox("getValue").replace(lineNumReg,""));
                        var ewisCheckData = {
                            acReg:acReg,
                            lineNum:validateLine(lineNum1)+'-'+validateLine(lineNum2)+'-'+validateLine(lineNum3)+'-'+validateLine(lineNum4),
                            ids:delArr
                        };
                        axios.post('/api/v1/defect/ewis/getIsLineNumRepeatFlag', ewisCheckData).then(response=>{
                            response.data.data &&  MsgAlert({type: "success", content: "新增接线管不应超过3个，该导线已进行过接线修理，请核实" });
                            if(k ==  ewis[j].lineNumList.length - 1){
                                if(type=='save'){
                                    save()
                                }else{
                                    tanchuang();
                                }
                            }

                        }).catch(err=>{
                            MsgAlert({type: "error", content: "校验EWIS失败" + err})
                        });
                    }


                }else{
                    if(type=='save'){
                        save()
                    }else{
                        tanchuang();
                    }
                }
            }
        }else{
            if(type=='save'){
                save()
            }else{
                tanchuang();
            }
        }
    }
    function save() {
        let post_data = get_post_data();
        if (!checkRequired(post_data)) {
            return
        }
        let url = "";
        if (params.operation === "PEND") {
            url = "/api/v1/defect/defect/pend/add"
        } else if (params.operation === "DEFERRAL") {
            url = "/api/v1/defect/defect/dfrl/add"
        }
        ajaxLoading();
        axios.post(url, post_data).then(response => {
            if (response.data.msg.toUpperCase().indexOf("SUCCESS") != -1) {
                ajaxLoadEnd();
                alert("保存成功！");
                if (typeof params.successCallback == "function") params.successCallback();
                window.location.reload();
                // close_window();

            } else {
                ajaxLoadEnd();
                throw new Error(response.data.msgData[0]);
            }
        }).catch(err => {
            ajaxLoadEnd();
            MsgAlert({type: "error", content: "保存失败" + err});
        })
    }

    function fangan() {
        if ($("#rectPlanUpdatedSn").textbox("getValue") == "") {
            alert("请先选择方案制定人");
            return
        }
        submitFlow();
    }
    function tanchuang() {
        var screenHeight = $(window).height();
        var scrolltop = $(document).scrollTop();
        var objTop = (screenHeight - 350) / 2 + scrolltop;

        $("#submit_add").window({
            resizable: false,
            modal: true,
            top: objTop + "px"
        });
    }
    function submitFlow() {
        let post_data = get_post_data();
        if (!checkRequired(post_data)) {
            return
        }
        post_data.defectPend.auditorNo=$("#rectPlanUpdatedSn").textbox("getValue");
        post_data.defectPend.auditor=$("#name_id").val();
        let url = "/api/v1/defect/defect/dfrl/submit";
        ajaxLoading();
        axios.post(url, post_data).then(response => {
            if (response.data.msg.toUpperCase().indexOf("SUCCESS") != -1) {
            ajaxLoadEnd();
            alert("提交成功！");
            if (typeof params.successCallback == "function") params.successCallback();
            // window.opener.location.reload();
            close_window();

        } else {
            ajaxLoadEnd();
            throw new Error(response.data.msgData[0]);
        }
    }).catch(err => {
            ajaxLoadEnd();
        MsgAlert({type: "error", content: "提交失败" + err});
    })
        // pkid = global_data.id;
        // if (!pkid) {
        //     MsgAlert({content: "请先保存数据！", type: 'error'});
        //     return;
        // }
        // if (!confirm("确认提交该记录？")) {
        //     return;
        // }
        // datas = $.extend({}, {}, {FunctionCode: 'DEFECT_DD_WORKFLOW_STATUS', pkid: pkid});
        // InitFuncCodeRequest_({
        //     data: datas, successCallBack: function (jdata) {
        //         if (jdata.data != null) {
        //             common_add_edit_({
        //                 identity: '', isEdit: '', width: 520, height: 300, title: $.i18n.t('选择审批人'),
        //                 param: {
        //                     roleId: '',
        //                     otherParam: pkid,
        //                     FunctionCode_: 'DEFECT_DD_WORKFLOW_SUBMIT',
        //                     successCallback: function(){
        //                         if (typeof params.successCallback == "function") params.successCallback();
        //                         close_window()
        //                     }
        //                 },
        //                 url: "/views/flow/work_flow_account_select.shtml"
        //             });
        //         } else {
        //             MsgAlert({content: "该保留处于还未提交或者审批中。", type: 'error'});
        //         }
        //     }
        // });
    }

    /** 检查必填项 **/
    function checkRequired(post_data) {
        if (!post_data.defectPend.id && !post_data.defectPend.tlbNo) {
            //不是修改、是新增,必填tlbNo
            MsgAlert({content: "tlbNo必须填写!", type: 'error'});
            return false
        }
        let rege = /^[0-9]+([.]{1}[0-9]+){0,1}$/;
        if (!rege.test(post_data.defectPend.tlbNo)) {
            $('#tlbNo').textbox("setValue", "");
            MsgAlert({type: "error", content: "TLB NO只能输入半角数字"});
            return false
        }
        if (post_data.defectPend.lackMater == "n" && post_data.defectPend.lackTech == "n" && post_data.defectPend.lackTime == "n" && post_data.defectPend.lackTool == "n") {
            MsgAlert({content: "reasons必须选择!", type: 'error'});
            return false
        }
        if (!post_data.defectPend.reference || !post_data.defectPend.referItem) {
            MsgAlert({content: "reference必须填写!", type: 'error'});
            return false
        }

        if(/[^a-zA-Z0-9`+-~!@#$%^&*()_,./?;:'"\\|\s\n\r\t]/g.test(post_data.tlbTechLog.faultReportEng)){
            MsgAlert({content:"FAULT REPORT(ENG)内容必须是英文数字或英文标点符号",type: 'error'});
            return false;
        }

        if (!post_data.defectPend.dfralCategory) {
            MsgAlert({content: "category必须选择!", type: 'error'});
            return false
        }else{
            if(params.operation == "DEFERRAL" && ( post_data.defectPend.dfralCategory == "a" || post_data.defectPend.dfralCategory == "other")){
                //保留时检验other信息是否填写
                if(!post_data.defectPend.ddDueDatas[0].fh && !post_data.defectPend.ddDueDatas[0].fc && !post_data.defectPend.ddDueDatas[0].calendarDay && !post_data.defectPend.ddDueDatas[0].flightDay){
                    MsgAlert({content: "故障到期日期必须填写!", type: 'error'});
                    return false
                }
            }
            if(params.operation == "PEND" && post_data.defectPend.dfralCategory == "other"){ 
                //推迟时检验other信息是否填写
                if(!post_data.defectPend.ddDueDatas[0].fh && !post_data.defectPend.ddDueDatas[0].fc && !post_data.defectPend.ddDueDatas[0].calendarDay && !post_data.defectPend.ddDueDatas[0].flightDay){
                    MsgAlert({content: "故障到期日期必须填写!", type: 'error'});
                    return false
                }
            }
        }
        if (!post_data.tlbTechLog.manHours) {
            MsgAlert({content: "ManHours必须填写!", type: 'error'});
            return false
        } else {
            let regex = /^[0-9]+([.]{1}[0-9]+){0,1}$/;
            if (!regex.test($('#manHours').textbox("getValue"))) {
                $('#manHours').textbox("setValue", "");
                MsgAlert({type: "error", content: "ManHours只能输入数字"});
                return false
            }
            if (0 >= $('#manHours').textbox("getValue")) {
                $('#manHours').textbox("setValue", "");
                MsgAlert({type: "error", content: "ManHours输入必选大于0"});
                return false
            }
        }
        if(!$("#chineseReport").val()){
            MsgAlert({content: "FAULT REPORT(CHN) 必须填写!", type: 'error'});
            return false
        };
        if(!$("#englishReport").val()){
            MsgAlert({content: "FAULT REPORT(ENG) 必须填写!", type: 'error'});
            return false
        };
        if (!post_data.defectPend.requesterLice) {
            MsgAlert({content: "License No.必须填写!", type: 'error'});
            return false
        }
        let ewis = $("input[name='EWIS']:checked").val();
        let oil = $("input[name='oilSpill']:checked").val();
        if (ewis != "n" && ewis != "y") {
            MsgAlert({content: "EWIS必须选择!", type: 'error'});
            return false
        }
        if (oil != "n" && oil != "y") {
            MsgAlert({content: "油液渗漏情况必须选择!", type: 'error'});
            return false
        }

        if(!post_data.ewisList){
            return false
        }

        if( (post_data.tlbTechLog.rci == 'y' || post_data.tlbTechLog.rii == 'y') && (!post_data.tlbTechLog.inspector || !post_data.tlbTechLog.inspectorNo) ){
            MsgAlert({content: "无效的Sign信息!", type: 'error'});
            return false
        }
        return true

    }

    /** 选择每次起飞前检查是需要确认 **/
    function reviewBeforeConfirm() {
        if (!confirm("Are you sure to set \"Review Before Each Take Off\"?")) {
            $("#reviewBeforeYes").prop("checked", false);
            $("#reviewBeforeNo").prop("checked", true)
        }
    }

    //刷新
    function reload_() {
        pkid = $("#pkid").val();
        // InitDataForm(pkid);
        // $("#dg").datagrid("reload");
        InitFuncCodeRequest_({
            data: {
                domainCode: "DA_FLEET,SBI_CHANGE_STATUS,TD_MANUAL_SBI_FLEET_F",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //资料来源
                    applyModel = $("#fleet").combobox("getValue");
                    pkid = $("#pkid").val();
                    InitDataGrid(pkid, jdata);

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    /**
     * 续保
     * @return {[type]} [description]
     */
    function extention(){
        let category = $("#category").combobox("getValue");
        let expiredDate = $("#expiredDate").combobox("getValue");
        //没有expiredDate设置当前日期
        let extentionDate = new Date().Format("yyyy-MM-dd");
        let extensionFh = "", extentionFc = "", extentionCalendarDay = "", extentionFlightDay = "";
        if(expiredDate){
            extentionDate = new Date(new Date(expiredDate).getTime() + 1000).Format("yyyy-MM-dd")
        }
        category_list_deferral.forEach(item=>{
            if(item.value === category){
                category = item.label;
                if(item.days){
                    //计算推迟日期
                    expiredDate = calculate_expired_date(item.days, extentionDate)
                }
                if(item.value === "a" || item.value === "other"){
                    extensionFh = global_data.fh,
                    extentionFc = global_data.fc,
                    extentionCalendarDay = global_data.calendarDays,
                    extentionFlightDay = global_data.flyingDays
                }
            }
        });

        let title = "续保";
        let param = {
            category: category,
            extentionDate: extentionDate,
            expiredDate: expiredDate,
            extensionFh: extensionFh,
            extentionFc: extentionFc,
            extentionCalendarDay: extentionCalendarDay,
            extentionFlightDay: extentionFlightDay,
            id: global_data.id,
            successCallback: function(){
                MsgAlert({type: "info", content: "保存成功"})
            }
        };
        ShowWindowIframe({
            width: "1200",
            height: "700",
            title: title,
            param: param,
            url: "/views/defect/deferral/extention.shtml"
        });
        return;
        lhgdialog.setting.extendDrag = true;
    }

    function close_window() {
        window.opener = null;
        window.open('', '_self');
        window.close();
    }


    function init_zone(model, value) {
        axios.get("/api/v1/eo_zone/list/?model=" + model).then(response => {
            $("#zone").combobox({
            data: response.data.data.eoZoneList,
            panelHeight: '150px',
            valueField: 'zone',
            textField: 'zone',
            onSelect: item => {
            global_data.zone_id = item.id;
        global_data.zone_flag = 1;
    },
        onChange: item => {
            global_data.zone_flag = 0;
        }
    });
        $("#zone").next("span").children("input:first").blur(function () {
            if (!global_data.zone_flag) {
                $("#zone").combobox("clear")
            }
        });
        if (value) {
            $("#zone").combobox("setValue", value)
        }
    })
    }

    function xuanren(id) {  //选择人组件
        //下个审批人选择初始化
        $("#" + id).MyComboGrid({
            idField: 'ACCOUNT_NUMBER',  //实际选择值
            textField: 'USER_NAME', //文本显示值
            panelHeight: '180px',
            required: true,
            width: "85%",
            params: {FunctionCode: 'FLOW_WORK_ACCOUNT'},
            columns: [[
                {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                {field: 'USER_NAME', title: '审核人', width: 50}
            ]],
            onHidePanel: function () {
                var t = $(this).combogrid('getValue');
                if (t != null && t != '' & t != undefined) {
                    if (selectRow == null || t != selectRow.ACCOUNT_NUMBER) {//没有选择或者选项不相等时清除内容
                        alert('请选择，不要直接输入！');
                        $(this).combogrid({value: ''});
                    }
                }
            },
            onSelect: function (index, row) {
                selectRow = row;
                $("." + id + " .name_in").val(row.USER_NAME);

                $("." + id + " .gonghao").val(row.ACCOUNT_ID);

                // $(this).combobox('setValue',row.ACCOUNT_ID);
                // $("#authName").combobox('setValue',row.USER_NAME);

            }
        });
    }


    $(function () {
        init_page();
        get_data();
        $('#submit_add').window('close');
        xuanren("rectPlanUpdatedSn");
    })


    //获取所有的章节日志数据
    var allLogData = [];
    var logMELChapterData = [];
    var logCDLChapterData = [];
    function getAllLog(model) {
        var logUrl = "/api/v1/plugins/MEL_LIST";
        var get_data_parameter = {
            page:1,
            rows:999999999,
            model:model
        };
        axios.get(logUrl,{params:get_data_parameter}).then(response => {
            if(response.data.code == 200) {
                allLogData = response.data.data;
                //分类，分成MEL和CDL两类
                for (var i=1 ; i < allLogData.length+1; i++ ){
                    if(allLogData[i-1].type == "CDL"){
                        var suitObject = {
                            value: allLogData[i-1].melNumber,
                            label: allLogData[i-1].melNumber,
                            name: allLogData[i-1].melNumber,
                            melETitle:allLogData[i-1].melETitle,
                            melCTitle:allLogData[i-1].melCTitle,
                        };
                        logCDLChapterData.push(suitObject);
                    }else if(allLogData[i-1].type == "MEL"){
                        var suitObject = {
                            value: allLogData[i-1].melNumber,
                            label: allLogData[i-1].melNumber,
                            name: allLogData[i-1].melNumber,
                            melETitle:allLogData[i-1].melETitle,
                            melCTitle:allLogData[i-1].melCTitle,
                        };
                        logMELChapterData.push(suitObject);
                    };
                };
                let reference = $("#reference").combobox('getValue');
                let referenceOther = $("#referenceOther").combobox('getValue');
                selectCategory(reference);
                $("#referenceOther").combobox('setValue',referenceOther);
            }
        }).catch(err => {
            MsgAlert({type: "error", content: err.message})
        })
    }

//    category数据选择功能
    function selectCategory(type) {
        //一个清空标识，当为false的时候清空，为true的时候保留
        var selectCategoryFlag = false;
        //    Category选项设置
        $("#referenceOther").combobox({
            data:type == "CDL"?logCDLChapterData:type == "MEL"?logMELChapterData:[],
            // editable: false,
            panelHeight: (type == "CDL"||type == "MEL")?160:0,
            valueField: 'value',
            textField: 'label',
            hasDownArrow:(type == "CDL"||type == "MEL")?true:false,
            //在选择的时候做操作
            onSelect: (data) => {
                selectCategoryFlag = true;
                    $('#melCTitle').val(data.melCTitle);
                    $('#melETitle').val(data.melETitle);
            },
            onChange:()=>{

            }
        });
        $("#referenceOther").next("span").children("input:first").blur(function () {
            //如果不是选中的
            if (!selectCategoryFlag && (type == "MEL"||type == "CDL")) {
                $("#referenceOther").combobox("clear");
            }
        });
    }

</script>
</body>
</html>