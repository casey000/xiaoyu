<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html
>
<head id="i18n_" module="pm_mplanconf">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
    <script type="text/javascript" src="/views/pm/mc/js/datagrid_utils.js"></script>
    <title></title>
    <style>
        .datagrid-wrap {
            height: 200px !important;
        }

    </style>
</head>
<body>
<div style="width:95%;margin:0 auto;">
<div class="ibox-content">
    <form class="form-horizontal m-t" id="mform" style="width:100%;">
        <div id="p0" class="easyui-panel" title="待办项维护" style="width: 100%"></div>
        <input type="hidden" id="pkid" name="pkid">
        <input type="hidden" id="refPkid" name="refPkid">
        <table class="table table-bordered table-info">
            <tr>
                <td align="right" style="padding-right:10px;height:35px">
                    <input class="btn btn-primary" type="button" onclick="save();" value="保存"/>&nbsp;&nbsp;
                    <input class="btn btn-primary" type="button" style="margin-right: 25px;" onclick="closeAdd();"
                           value="关闭"/>
                </td>
            </tr>
        </table>
        <table class="table table-bordered table-info">
            <tr>
                <th class="td5" style="width:100px;" align="right"> 标题：</th>
                <td class="tdr">
                    <input class="easyui-combobox" id="acno" name="acno" data-options="required:true"
                           style="width:150px;"/>
                </td>
                <th class="td5" style="width:100px;" align="right"> 开始日期：</th>
                <td class="tdr">
                    <input class="easyui-datebox" id="beginDate" name="beginDate"
                           data-options="required:true,editable:false"
                           style="width:150px;"/>
                </td>
            </tr>
            <tr>
                <th class="td5" style="width:100px;" align="right"> 席位：</th>
                <td class="tdr">
                    <input class="easyui-textbox" id="type" name="type" data-options="onlyview:true,editable: false"
                           style="width:150px;"/>
                </td>
                <th class="td5" style="width:100px;" align="right"> <div id="majorTh">专业：</div></th>
                <td class="tdr">
                    <div id="majorTd"><input class="easyui-textbox" id="major" name="major" data-options=""
                           style="width:150px;"/></div>
                </td>
            </tr>
            <tr id="toTr">
                <th class="td5" style="width:100px;" align="right"> TO：</th>
                <td class="tdr">
                    <input type="hidden" id="toId" name="toId"/>
                    <input type="hidden" id="toType" name="toType"/>
                    <input class="easyui-textbox" id="toNo" name="toNo" data-options="onlyview:true,editable: false"
                           style="width:120px;"/>
                    <a href="javascript:void(0)" class="easyui-linkbutton" style="height:20px"
                       data-options="iconCls:'icon-search'"
                       onclick="openTos();"/>
                </td>
                <th class="td5" style="width:100px;" align="right"> DEFECT：</th>
                <td class="tdr" >
                    <input type="hidden" id="defectId" name="defectId"/>
                    <input class="easyui-textbox" id="defectNo" name="defectNo"
                           data-options="onlyview:true,editable: false"
                           style="width:120px;"/>
                    <a href="javascript:void(0)"  class="easyui-linkbutton" style="height: 20px"
                       data-options="iconCls:'icon-search'"
                       onclick="searchDefects();"/>
                </td>
            </tr>
            <tr>
                <th class="td5" style="width: 100px;" align="right">工作内容：</th>
                <td class="tdr" colspan="5">
                    <input class="easyui-textbox " name="des" id="des" data-options="validType:['maxLength[2000]']"
                           multiline="true" style="height:100px; width:465px;"/>
                </td>
            </tr>
            <tr>
                <th class="td5" style="width: 100px;" align="right">日志：</th>
                <td class="tdr" colspan="5">
                    <input class="easyui-textbox " name="log" id="log" data-options="validType:['maxLength[2000]']"
                           multiline="true" style="height:100px; width:465px;"/>
                </td>
            </tr>
        </table>
    </form>
</div>
</div>
<link rel="stylesheet" href="/css/plugins/dialog/dialog_default.css">
<script type="text/javascript" src="/views/defect/chooseFlight.js"></script>
<script src="/js/lhgdialog/lhgdialog.js"></script>
<script type="text/javascript" src="/js/common_query_dialog.js"></script>
<script type="application/javascript">
    var param;
    var identity = 'dg';
    var identity1 = 'dg1';
    var PAGE_DATA = {};
    var selectRow;
    var hoPkid;
    var byWho;
    var ifLast;
    function i18nCallBack() {
        param = getParentParam_();
        if (param.hoPkid) {
            hoPkid = param.hoPkid;
            $("#refPkid").val(hoPkid);
        }
        if (param.byWho) {
            byWho = param.byWho;
            $("#type").combobox({value: byWho});
            if (byWho != "SUPPORT") {
                $("#majorTh").hide();
                $("#majorTd").hide();
                $("#toTr").hide();
            }
        }
        if (param.ifLast) {
            ifLast = param.ifLast;
        }
        if ("Y" == ifLast) {
            $(".easyui-combobox").combobox({onlyview: true, editable: false});
            $(".easyui-textbox").textbox({onlyview: true, editable: false});
            $(".easyui-datebox").datebox({onlyview: true, editable: false});
            $("#log").textbox({onlyview: false, editable: true});
        }
        InitFuncCodeRequest_({
            data: {FunctionCode: "ANALYSIS_DOMAIN_BYCODE", domainCode: "MSGRP,PM_MC_SEAT,MCC_TODO_MAJOR"},
            successCallBack: function (jdata) {
                PAGE_DATA['position'] = DomainCodeToMap_(jdata.data.PM_MC_POSITION);
                // 初始化查询条件
                $('#acno').combobox({
                    panelHeight: '160px',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data.MSGRP
                });
                $('#type').combobox({
                    panelHeight: '160px',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data.PM_MC_SEAT
                });
                $('#major').combobox({
                    panelHeight: '160px',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data.MCC_TODO_MAJOR
                });
                if (param.PKID) {
                    $("#pkid").val(param.PKID);
                    InitDataForm(param.PKID);
                }
            }
        });
        window.resizeTo(700, 500);
    }

    //回显数据
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "PM_MC_HO_TODO_GET"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, null, Constant.CAMEL_CASE);
                }
            }
        });
    }


    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate) {
            return false;
        }
        var data = $("#mform").serializeObject();
        data = $.extend({}, data, {FunctionCode: 'PM_MC_HO_TODO_ADD_EDIT'});
        InitFuncCodeRequest_({
            data: data,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    var pkid = jdata.data;
                    $("#pkid").val(pkid);
                    param.OWindow.InitDataGridTodayTodo();
                    param.OWindow.InitDataGridTodo();
                    //CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msgData ? jdata.msgData[0] : jdata.msg, type: 'error'});
                }
            }
        });
    }

    function openTos() {
        ShowWindowIframe({
            width: "1000",
            height: "700",
            title: 'TO列表',
            param: {},
            url: "/views/pm/mc/handover/select_to_list.shtml"
        });
    }

    //查询关联TO
    function searchTos(tos) {
        var toIds = [];
        var toNos = [];
        var toTypes = [];
        var acReg;
        $.each(tos, function (k, val) {
            toNos.push(val.TO_NUMBER);
            toIds.push(val.ID);
            toTypes.push(val.TYPE);
            if(!acReg && val.AC_REG){
                acReg = val.AC_REG;
                $("#acno").combobox({value: val.AC_REG,editable: false,onlyview:true});
            }
        });
        toIds = toIds.join(',');
        toNos = toNos.join(',');
        toTypes = toTypes.join(',');
        $('#toNo').textbox({value: toNos});
        $("#toId").val(toIds);
        $("#toType").val(toTypes);
    }

    // 查询关联Defect
    function searchDefects() {
        var defaultParam = {
            "qname": [],
            "qoperator": [],
            "qvalue": []
        };

        multiSelectDefectDialog(defaultParam, function (rowdata, originalData) {
            if (rowdata && rowdata.length > 0) {
                var defectIds = [];
                var defectNos = [];
                var acReg;
                $.each(rowdata, function (k, val) {
                    defectNos.push(val.defectNo);
                    defectIds.push(val.defectId);
                    if(!acReg && val.acReg){
                        acReg = val.acReg;
                        $("#acno").combobox({value: val.acReg,editable: false,onlyview:true});
                    }
                });
                defectIds = defectIds.join(',');
                defectNos = defectNos.join(',');
                $('#defectNo').textbox({value: defectNos});
                $("#defectId").val(defectIds);
                //根据defectNo查询专业
                $.ajax({
                    type: "GET",
                    url: "/api/v1/worklog/findWorkLogByDefectNo?defectNo="+defectNos,
                    contentType: "application/json;charset=utf-8",
                    success: function (jdata) {
                        //console.log(jdata.data);1电子 2电气 3机械 4动力 5其他
                        if(jdata.data){
                            if("1" == jdata.data.profession){
                                $('#major').combobox('setValue','DZ');
                            }else if("2" == jdata.data.profession){
                                $('#major').combobox('setValue','DQ');
                            }else if("3" == jdata.data.profession){
                                $('#major').combobox('setValue','JX');
                            }else if("4" == jdata.data.profession){
                                $('#major').combobox('setValue','DL');
                            }else if("5" == jdata.data.profession){
                                $('#major').combobox('setValue','QT');
                            }
                        }
                    }
                })
            }
        });
    }

    function closeAdd() {
        CloseWindowIframe();
        param.OWindow.InitDataGridTodo();
        $("#mform").form('clear');
    }
</script>
</body>
</html>