<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->
    <title>使用困难报告</title>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
</head>
<body style="padding-left:2px;padding-right:2px">
<div style="width:95%;margin:0 auto;">
    <div class="ibox-content">
        <form class="form-horizontal m-t" id="mform">
            <div id="p0" class="easyui-panel" title="使用困难报告" style="width: 100%"></div>
            <input type="hidden" name="rev" value="0"/>
            <input type="hidden" name="pkid" id="pkid">
            <input type="hidden" name="status">
            <input type="hidden" name="inputerName">
            <input type="hidden" name="inputerId">
            <input type="hidden" name="inputerDate">
            <input type="hidden" id="actype" name="actype">
            <table class="table table-bordered table-info">
                <!-- 按钮行 -->
                <tr id="buttonRow">
                    <td align="right" style="padding: 10px;">
                        <a class="searchBtn" type="button" onclick="saveOrUpdate()" id="saveButton"
                           data-options="iconCls:'icon-save'">
                            <span>保存</span></a>&nbsp;&nbsp;
                        <a class="searchBtn" type="button" onclick="submitFlow()" id="submitFlowButton"
                           data-options="iconCls:'icon-save'">
                            <span>提交</span></a>&nbsp;&nbsp;
                        <a class="searchBtn" type="button" onclick="closeWindow()" id="closeButton"
                           data-options="iconCls:'icon-close'">
                            <span>关闭</span></a>&nbsp;&nbsp;
                    </td>
                </tr>
            </table>
            <table class="table table-bordered table-info">
                <tr>
                    <th class="th" style="width:140px" nowrap>1.航空器注册号/型号：</th>
                    <td class="tdr hs"><input class="easyui-combobox" name="acno" id="acno"
                                                            data-options="required:true" style="width: 120px"/></td>
                    <td class="tdr hs" rowspan="2" style="text-align:center;">
                        <label style="font-size:16px;">中国民用航空总局</label><br>
                        <label style="font-size:22px;margin-right:3px">使用困难报告</label>
                        <label style="font-size:22px;">（</label>
                        <input type="radio" name="sdrType" id="sdrTypeO" value="O" checked/>
                        <label style="font-size:22px;">运行</label>
                        <input type="radio" name="sdrType" id="sdrTypeS" value="S" style="marigin-left:30px"/>
                        <label style="font-size:22px;">结构 ）</label>
                    </td>
                    <th class="th" style="text-align:center;">3.报告编号：</th>
                </tr>
                <tr>
                    <th class="th">2.航空运营人：</th>
                    <td class="tdr hs">顺丰航空有限公司</td>
                    <td class="tdr hs"><input class="easyui-textbox" name="sdrNo" id="sdrNo"
                                              data-options="editable:false"/></td>
                </tr>
            </table>
            <table class="table table-bordered table-info">
                <tr>
                    <th class="th" style="width:120px" rowspan="3">4.基本信息：</th>
                    <th class="th">(a)运行种类:</th>
                    <td class="tdr hs"><input class="easyui-combobox" name="operationType" id="operationType"
                                              data-options="required:true" style="width: 160px;"></td>
                    <th class="th">(b)航班代码:</th>
                    <td class="tdr hs" nowrap>
                        <input class="easyui-textbox" name="flightNo" id="flightNo"
                               data-options="required:true,editable:false" style="width: 160px;"/>
                        <a class="easyui-linkbutton" href="javascript:" style="height: 20px" id="getFlightNoButton"
                           iconCls="icon-search" onclick="getFlightNo();"></a>
                    </td>
                    <th class="th">(c)发生日期时间:</th>
                    <td class="tdr hs"><input class="easyui-datetimebox" name="sdrDate" id="sdrDate"
                                              data-options="required:true,editable:false" style="width: 160px;"/>
                    </td>
                </tr>
                <tr>
                    <th class="th">(d)发生地点:</th>
                    <td class="tdr hs">
                        <input class="easyui-combogrid easyui-validatebox" name="sdrPlace" id="sdrPlace"
                               data-options="validType:['maxLength[20]']" style="width: 160px;"/>
                    </td>
                    <th>(e)涉及主要系统:</th>
                    <td class="tdr hs"><input class="easyui-combobox" name="sdrAta" id="sdrAta"
                                              data-options="required:true,editable:false" style="width: 160px;"/></td>
                    <th>(f)发生阶段:</th>
                    <td class="tdr hs"><input class="easyui-combobox" name="sdrStage" id="sdrStage"
                                              data-options="required:true" style="width: 160px;"/></td>
                </tr>
                <tr>
                    <th>(f)故障现象:</th>
                    <td class="tdr hs"><input class="easyui-combobox" name="sdrAppear" id="sdrAppear"
                                              data-options="required:true, showSeconds:false" style="width: 160px;"/></td>
                    <th>(g)预防/紧急措施:</th>
                    <td class="tdr hs"><input class="easyui-combobox" name="sdrMeasure" id="sdrMeasure"
                                              data-options="required:true, showSeconds:false" style="width: 160px;"/></td>
                    <th>(h)故障件<br/>更换件名称:</th>
                    <td class="tdr hs">
                        <input class="easyui-textbox" name="sdrPnName" id="sdrPnName"
                               data-options="validType:['maxLength[300]'],multiline:true,required:true"
                               style="width: 160px;height:45px;"/>
                    </td>
                </tr>
                <tr>
                    <th class="th">5.问题描述&nbsp;&nbsp;<br/>和纠正措施：</th>
                    <td class="tdr hs" colspan="6">
                        <input class="easyui-textbox" style="width: 1000px;height:100px;"
                               data-options="validType:['maxLength[1000]'],multiline:true,required:true"
                               name="sdrDes"
                               id="sdrDes"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" rowspan="2" nowrap>6.提交单位信息：</th>
                    <th class="th" style="text-align:center">(a)单位编码：</th>
                    <th class="th" style="text-align:center">(b)提交人：</th>
                    <th class="th" style="text-align:center">(c)提交日期：</th>
                    <th class="th" style="text-align:center">(d)联系电话：</th>
                    <th class="th" style="text-align:center">(e)E-Mail地址:</th>
                    <th class="th" style="text-align:center">(f)审核人</th>
                </tr>
                <tr>
                    <td class="tdr hs" style="text-align:center">SFHK</td>
                    <td class="tdr hs" style="text-align:center">
                        <input type="hidden" name="reportId" id="reportId"/>
                        <input class="easyui-textbox" name="reportName" id="reportName"
                               data-options="editable:false" style="width: 120px;"/>
                    </td>
                    <td class="tdr hs" style="text-align:center"><input class="easyui-datebox" name="reportDate"
                                                                        id="reportDate"
                                                                        data-options="required:true,editable:false" style="width: 120px;"/>
                    </td>
                    <td class="tdr hs" style="text-align:center"><input class="easyui-textbox" name="reportTel"
                                                                        data-options="validType:['maxLength[60]']"
                                                                        id="reportTel" style="width: 120px;"/>
                    </td>
                    <td class="tdr hs" style="text-align:center"><input class="easyui-textbox" name="reportEmail"
                                                                        data-options="validType:['maxLength[60]']"
                                                                        id="reportEmail" style="width: 120px;"/>
                    </td>
                    <td class="tdr hs" style="text-align:center">
                        <input type="hidden" name="checkId" id="checkId"/>
                        <!--<input class="easyui-textbox" name="checkName" id="checkName"
                               data-options="editable:false,width:'120px'"/>-->
                        <input type="text" name="checkName" id="checkName" disabled
                               style="width: 120px;height: 20px;border: 1px solid #D4D4D4;border-radius: 4px;"/>
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>

<script type="text/javascript">
    var param;
    var operation;
    var PAGE_DATA = {};
    var sdrData = {};

    function i18nCallBack() {
        param = getParentParam_() || {};
        operation = param.operation || 'add';

        InitFuncCodeRequest_({
            data: {
                domainCode: "MSGRP,SDR_APPEAR,SDR_OPERATION_TYPE,SDR_STAGE,SDR_MEASURE,TD_ATA",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //飞机号
                    $('#acno').combobox({
                        panelHeight: '140px',
                        data: jdata.data.MSGRP,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (item) {
                            InitFuncCodeRequest_({
                                data: {acno: item.VALUE, FunctionCode: "SELECT_ACTYPE_BY_ACNO"},
                                successCallBack: function (jdata) {
                                    $('#actype').val(jdata.data.VALUE);
                                }
                            })
                        }
                    });

                    $('#sdrAta').combobox({
                        panelHeight: '140px',
                        data: jdata.data.TD_ATA,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        multiple: true
                    });

                    //运行种类
                    $('#operationType').combobox({
                        panelHeight: '140px',
                        data: jdata.data.SDR_OPERATION_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        multiple: true
                    });

                    //发生阶段
                    $('#sdrStage').combobox({
                        panelHeight: '140px',
                        data: jdata.data.SDR_STAGE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        multiple: true
                    });

                    //故障现象
                    $('#sdrAppear').combobox({
                        panelHeight: '140px',
                        data: jdata.data.SDR_APPEAR,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        multiple: true
                    });

                    //预防/紧急措施
                    $('#sdrMeasure').combobox({
                        panelHeight: '140px',
                        data: jdata.data.SDR_MEASURE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        multiple: true
                    });

                    PAGE_DATA['acno'] = DomainCodeToMap_(jdata.data["MSGRP"]);
                    PAGE_DATA['SDR_OPERATION_TYPE'] = DomainCodeToMap_(jdata.data["SDR_OPERATION_TYPE"]);
                    PAGE_DATA['SDR_STAGE'] = DomainCodeToMap_(jdata.data["SDR_STAGE"]);
                    PAGE_DATA['SDR_APPEAR'] = DomainCodeToMap_(jdata.data["SDR_APPEAR"]);
                    PAGE_DATA['SDR_MEASURE'] = DomainCodeToMap_(jdata.data["SDR_MEASURE"]);
                    PAGE_DATA['TD_ATA'] = DomainCodeToMap_(jdata.data["TD_ATA"]);

                    $("#sdrPlace").MyComboGrid({
                        idField: 'STATION',  //实际选择值
                        textField: 'STATION', //文本显示值
                        panelHeight: '200px',
                        panelWidth: '350px',
                        required: true,
                        width: 160,
                        params: {FunctionCode: 'SELECT_STATION'},
                        columns: [[
                            {field: 'STATION', title: '航站三字码', width: 50},
                            {field: 'STATION_FCODE', title: '航站四字码', width: 50},
                            {field: 'SHORT_NAME', title: '中文简称', width: 50},
                            {field: 'FULLNAME_CN', title: '中文全称', width: 50},
                        ]],
                        /*params: {FunctionCode: 'PM_MC_SDR_STATION'},
                        columns: [[
                            {field: 'STATION', title: 'THREE CODE', width: 50},
                            {field: 'SHORT_NAME', title: 'NAME', width: 50}
                         ]],*/
                        onHidePanel: function () {
                            var t = $(this).combogrid('getValue');
                            if (t) {
                                if (selectRow == null || t != selectRow.STATION) {//没有选择或者选项不相等时清除内容
                                    alert('请选择，不要直接输入！');
                                    $(this).combogrid({value: ''});
                                }
                            }
                        },
                        onSelect: function (index, row) {
                            selectRow = row;
                        }
                    });

                    initForm();
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //页面初始化
    function initForm() {
        //不正常事件触发新增
        if (operation == 'mcc') {
            $('#acno').combobox('setValue', param.acno);
            $('#flightNo').textbox('setValue', param.flightNo);
            $('#sdrDate').datetimebox('setValue', param.incidentDate);
            $("#sdrPlace").combogrid('setValue', param.station);

            if (param.ata) {
                var atas = param.ata.split(',');
                var finalAtas = [];
                if (atas && atas.length > 0) {
                    for (var i = 0; i < atas.length; i++) {
                        if (atas[i] && atas[i].trim().length > 0) {
                            if (atas[i].length >= 2) {
                                finalAtas.push(atas[i].substring(0, 2));
                            } else {
                                finalAtas.push(atas[i])
                            }
                        }
                    }
                }
                $('#sdrAta').combobox('setValue', finalAtas);
            }

            $("#reportDate").datebox('setValue', new Date().toDateString());
            $("#reportName").textbox('setValue', getLoginInfo().userName);
            $("#reportId").val(getLoginInfo().accountId);
        }
        // 编辑
        else if (operation == 'edit') {
            fillForm();
        }
        //查看
        else if (operation == 'view') {
            $("#buttonRow").remove();
            fillForm();
        } else if (operation == 'add') {
            $("#reportDate").datebox('setValue', new Date().toDateString());
            $("#reportName").textbox('setValue', getLoginInfo().userName);
            $("#reportId").val(getLoginInfo().accountId);
        }

        if (param.flow) {
            $("#buttonRow").hide();
        }
    }

    function fillForm() {
        if (param.pkid) {
            InitFuncCodeRequest_({
                data: {'pkid': param.pkid, FunctionCode: 'PM_MC_SDR_LIST'},
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        sdrData = jdata.data[0];
                        ParseFormField_(sdrData, null, Constant.CAMEL_CASE);
                        //有些特殊字段需要手动进行赋值
                        $("#acno").combobox('setValue', sdrData.ACNO);
                        if (sdrData.SDR_ATA) {
                            $("#sdrAta").combobox("setValue", sdrData.SDR_ATA.split(","));
                        }

                        if (sdrData.SDR_STAGE) {
                            $("#sdrStage").combobox("setValue", sdrData.SDR_STAGE.split(","));
                        }

                        if (sdrData.OPERATION_TYPE) {
                            $("#operationType").combobox("setValue", sdrData.OPERATION_TYPE.split(","));
                        }

                        if (sdrData.SDR_APPEAR) {
                            $("#sdrAppear").combobox("setValue", sdrData.SDR_APPEAR.split(","));
                        }

                        if (sdrData.SDR_MEASURE) {
                            $("#sdrMeasure").combobox("setValue", sdrData.SDR_MEASURE.split(","));
                        }

                        if (sdrData.SDR_TYPE) {
                            $("#sdrType" + sdrData.SDR_TYPE).attr("checked", "checked");
                        }

                        if (sdrData.SDR_PLACE) {
                            $("#sdrPlace").combogrid('setValue', sdrData.SDR_PLACE);
                        }
                    } else {
                        MsgAlert({content: jdata.msg, type: 'error'});
                    }
                }
            });
        }
    }
    //保存提交
    function saveOrUpdate() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;

        var $form = $("#mform");
        var datas = $form.serializeObject();
        if (Array.isArray(datas['operationType'])) {
            datas['operationType'] = datas['operationType'].join(',');
        }
        var operationTypeText = $("#operationType").combobox('getText');
        datas['operationTypeText'] = operationTypeText;

        if (Array.isArray(datas['sdrStage'])) {
            datas['sdrStage'] = datas['sdrStage'].join(',');
        }
        var sdrStageText = $("#sdrStage").combobox('getText');
        datas['sdrStageText'] = sdrStageText;

        if (Array.isArray(datas['sdrAppear'])) {
            datas['sdrAppear'] = datas['sdrAppear'].join(',');
        }
        var sdrAppearText = $("#sdrAppear").combobox('getText');
        datas['sdrAppearText'] = sdrAppearText;


        if (Array.isArray(datas['sdrMeasure'])) {
            datas['sdrMeasure'] = datas['sdrMeasure'].join(',');
        }
        var sdrMeasureText = $("#sdrMeasure").combobox('getText');
        datas['sdrMeasureText'] = sdrMeasureText;

        if (Array.isArray(datas['sdrAta'])) {
            datas['sdrAta'] = datas['sdrAta'].join(',');
        }

        if (operation == 'mcc') {
            datas['cirId'] = param.cirId;
        }

        datas = $.extend({}, datas, {operation: operation, FunctionCode: 'PM_MC_SDR_ADD_OR_EDIT'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (param.OWindow && typeof param.OWindow.reload_ == 'function') {
                        param.OWindow.reload_();
                    }

                    if (param.OWindow && typeof param.OWindow.sdrCallBack == 'function') {
                        var sdrType = $("input[name='sdrType']:checked").val();
                        typeof param.OWindow.sdrCallBack(jdata.data.pkid, sdrType);
                    }

                    //流程表单
                    if (param.flow) {
                        MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        $("#pkid").val(jdata.data.pkid);
                        operation = 'edit';
                        //CloseWindowIframe();
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    //关闭窗口
    function closeWindow() {
        if (operation != 'view') {
            if (confirm("确认取消编辑/新增？")) {
                CloseWindowIframe();
            }
        } else {
            CloseWindowIframe();
        }
    }

    //获取航班号
    /*
     function getFlightNo(){
     var acno = $("#acno").combobox('getValue');
     if (acno) {
     $.chooseFlight({
     filter: {
     ac: acno
     },
     success: function(data){
     $("#flightNo").textbox('setValue', data.FLIGHT_NO);
     //$('#sdrPlace').combogrid('setValue', data.ARRIVAL);
     },
     fullData: true
     })
     }
     }*/

    function getFlightNo() {
        var acno = $("#acno").combobox('getValue');
        if (!acno) {
            MsgAlert({content: '请先选择机号', type: 'error'});
            return;
        }
        ShowWindowIframe({
            width: "800",
            height: "450",
            title: "航班号列表",
            param: {acReg: acno},
            url: "/views/common/select_fltno_list.shtml"
        });
    }

    //航班获取回调方法
    function queryFltno(rowData) {
        if (rowData && rowData.FLIGHT_NO) {
            $("#flightNo").textbox('setValue', rowData.FLIGHT_NO);
            //$('#sdrPlace').combogrid('setValue', rowData.TO_STATION);
        }
    }

    //提交工作流
    function submitFlow(){
        var pkid = $("#pkid").val();
        if (!pkid){
            MsgAlert({content:"请先保存基础数据！", type: 'error'});
            return;
        }
        if(confirm("确认提交吗？")){
            InitFuncCodeRequest_({
                data: {pkid:pkid, FunctionCode: 'PM_MC_SDR_WORKFLOW_DEAL'},
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (param.OWindow && typeof param.OWindow.reload_ == 'function') {
                            param.OWindow.reload_();
                        }
                        CloseWindowIframe();
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        }
    }
</script>
</body>