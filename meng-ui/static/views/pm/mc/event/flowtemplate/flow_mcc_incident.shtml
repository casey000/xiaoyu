<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="ws_work_flow">
  <!--#include virtual="/views/items/resource_.shtml"-->
  <script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
  <script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
  <title>MCC主控</title>
</head>
<body class="ibody">

<div id="tabs" style="width: 100%; height: 100%;">
  <div id="tab01" title="业务表单数据" style="">
    <div class="ibox float-e-margins">
      <div class="ibox-content">
        <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
          <input type="hidden" name="sdrId" id="sdrId"/>
            <input type="hidden" name="ifMcc" id="ifMcc"/>
          <!-- 业务数据展示(MCC主控建议要求) start-->
          <table class="table table-bordered table-info" id="mccTable" >
            <tr>
              <th class="tdl" style="width: 145px;">责任单位 ：</th>
              <td class="tdr">
                  <input class="easyui-combobox easyui-validatebox" name="dept" id="dept" data-options=""
                         style="height:25px; width: 98%;"/>
              </td>
            </tr>
              <tr>
                  <th class="tdl" style="width: 145px;">扣除分值 ：</th>
                  <td class="tdr">
                      <input class="easyui-numberbox" name="point" id="point" data-options="validType:['maxLength[10]'],width:120,precision:1"/>
                  </td>
              </tr>
            <tr>
              <th class="tdl">MCC意见：</th>
              <td class="tdr">
                <input class="easyui-textbox easyui-validatebox" name="mccDes" id="mccDes"
                       data-options="multiline:true, validType:['maxLength[500]']" style="height:120px;width:98%"/>
              </td>
            </tr>
            <tr>
              <th class="tdl">涉及MEL/CDL：</th>
              <td class="tdr">
                <label><input type="radio" name="isMel" value="1"/>Y</label>
                <label><input type="radio" name="isMel" style="margin-left:15px" value="0" checked/>N<label
                        style="color:red">*</label></label>
              </td>
            </tr>
            <tr>
              <th class="tdl">MEL/CDL Content：</th>
              <td class="tdr">
                <input class="easyui-textbox" name="melcdlDesc" id="melcdlDesc" style="width:60%"
                       data-options="editable:false,validType:['maxLength[500]']"/>(多组内容，可用逗号分隔)
              </td>
            </tr>
            <tr>
              <th class="tdl">使用困难报告(SDR)：</th>
              <td class="tdr">
                <label><input type="radio" name="isSdr" value="1"/>Y</label>
                <input type="radio" name="isSdr" value="0" style="margin-left:15px" checked/>N<label
                      style="color:red">*</label>
              </td>
            </tr>
            <tr>
              <td class="tdr" colspan="2">
                  <label><input type="radio" name="sdrType" value="O" disabled/>运行</label>
                  <input type="radio" name="sdrType" value="S" style="margin-left:15px" disabled/><label>结构</label>
              </td>
            </tr>
          </table>

          <!-- 业务数据展示(值班经理建议) start-->
          <table class="table table-bordered table-info" id="manageTable" >
            <tr>
              <th class="td5" style="text-algin:left;">值班经理建议与要求：</th>
              <td class="tdr">
                <input class="easyui-textbox" name="manageDes"
                       data-options="multiline:true, validType:['maxLength[500]']" style="height:120px;width:80%"/>
              </td>
            </tr>
            <tr>
              <th class="td5" colspan="2" style="text-align:left;">建议：</th>
            </tr>
            <tr>
              <input type="hidden" name="dutySuggest" id="dutySuggest"/>
              <td class="td5" colspan="2" style="padding-left:30px">
                <input type="checkbox" name="isMcc" id="isMcc"/><label style="margin-right:10px">MCC监控;</label>
                <input type="checkbox" name="isTmc" id="isTmc"/><label style="margin-right:10px">技术支援处监控;</label>
                <input type="checkbox" name="isPPC" id="isPPC"/><label style="margin-right:10px">PPC跟进;</label>
                <input type="checkbox" name="isProj" id="isProj"/><label style="margin-right:10px">工程评估;</label>
                <input type="checkbox" name="isTrain" id="isTrain"/><label style="margin-right:10px">培训开展;</label>
                <input type="checkbox" name="isLine" id="isLine"/><label style="margin-right:10px">航线关注;</label>
                <input type="checkbox" name="isDj" id="isDj"/><label style="margin-right:10px">定检跟进;</label>
                <input type="checkbox" name="isQa" id="isQa"/><label style="margin-right:10px">质量调查;</label>
                <input type="checkbox" name="isMateria" id="isMateria"/><label style="margin-right:10px">航材保障;</label>
              </td>
            </tr>
            <tr>
              <th class="tdl">各处室反馈日期：</th>
              <td class="td5" colspan="2">
                  <input class="easyui-datebox" name="feedbackDate" id="feedbackDate" data-options="editable:false"/>
              </td>
            </tr>
          </table>
          <!-- 业务数据展示end-->

          <h5 style="margin-bottom: 4px;">流程处理：</h5>
          <input name="taskId" type="hidden" />
          <table class="table table-bordered table-info" id="mtable">
            <tr>
              <th class="tdl"> 处理意见：</th>
              <td class="tdr">
                <input id="notes" class="easyui-textbox easyui-validatebox" name="notes"
                       data-options="multiline:true, required:true, validType:['maxLength[500]'] "
                       style="height:65px; width: 90%;"/>
              </td>
            </tr>
            <tr>
              <td colspan="2" align="center">
                <input id="canSubmit" class="btn" type="button" onclick="flowToNextNode()" value="提交"/>
                <input id="canReturn" class="btn" type="button" onclick="doReturn();" value="退回"/>
                <input id="viewButton" class="btn btn-primary " type="button" onclick="viewDetails()" value="查看详情">
                <!--<input id="canTerminate" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="终止"/>
                <input id="canHangUp" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="挂起"/>-->
              </td>
            </tr>
          </table>
        </form>
      </div>
    </div>
  </div>
  <div title="流程信息">
    <table class="table table-bordered table-info" id="processInfo">
      <tr>
        <th class="tdl" style="width: 145px;">流程业务Key ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="businessKey"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="executionName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <tr>
        <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="createTime"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">流程创建人 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="userName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <tr>
        <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="nodeName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="isJoint"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <!--<tr>
        <th class="tdl" style="width: 145px;">流程任务-配置 ：</th>
        <td class="tdr" colspan="3" style="vertical-align: middle;">
          <input type="checkbox" name="canReturn" value="" disabled/> 可退回
          <input type="checkbox" name="canTrunTo" value="" disabled/> 可转办
          <input type="checkbox" name="canTerminate" value="" disabled/> 可终止
          <input type="checkbox" name="canHangUp" value="" disabled/> 可挂起
        </td>
      </tr>-->
    </table>
    <div id="workflow" style="overflow-x: scroll;"></div>
  </div>
  <div id="tab02" title="历史任务信息" style="">
    <table id="historyDg"></table>
  </div>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
/**
 * 初始化流程业务处理页面
 * @param resource  业务数据
 * @param execution 流程实例数据
 * @param node 节点配置数据
 * @constructor
 */
var pageData;
var currNode;
var operation = 'view';
var ifMcc;
function InitLoadResource(resource, execution, node) {
    InitFuncCodeRequest_({
        data: {
            domainCode: "INCIDENT_DEPT",
            FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
        },
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                $('#dept').combobox({
                    panelHeight: '140px',
                    data: jdata.data.INCIDENT_DEPT,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });

                pageData = resource;
                ifMcc = pageData.ifMcc;
                if ("X" == ifMcc) {
                    $("#ifMcc").val(ifMcc);
                }
                if (node.taskPropId == "task1563161370453") {
                    $("#mccTable").remove();
                    $("#manageTable").remove();
                    operation = 'edit';
                    $("#viewButton").val("编辑事件");
                }
                if (node.taskPropId == "task1554347693669") {
                    // 当前节点为不正常事件MCC主控审核
                    $("#sdrId").val(resource.sdrId);
                    currNode = 'checking';
                    $("#manageTable").remove();

                    $("input[name='isMel']").bind('click', function () {
                        if ($(this).val() == '1') {
                            $("#melcdlDesc").textbox({editable: true});
                        } else {
                            $("#melcdlDesc").textbox({editable: false});
                            $("#melcdlDesc").textbox('clear');
                        }
                    });

                    //是否使用困难报告
                    $("input[name='isSdr']").bind('click', function () {
                        if ($(this).val() == '1') {
                            //$("input[name='sdrType']").removeAttr('disabled');
                            //$("input[name='sdrType'][value=O]").attr("checked", "checked");

                            if (!pageData.sdrId) {
                                var title_ = $.i18n.t('使用困难报告');
                                ShowWindowIframe({
                                    width: "1230",
                                    height: "460",
                                    title: title_,
                                    param: $.extend({operation: 'mcc', cirId: pageData.pkid}, pageData),
                                    url: "/views/pm/mc/event/pm_mcc_sdr_detail.shtml"
                                });
                            }
                        } else {
                            //$("input[name='sdrType']").attr('disabled', 'disabled');
                            $("input[name='sdrType']").attr('checked', false);
                        }
                    });

                } else if (node.taskPropId == "task1554348307069") {
                    //值班经理审批
                    currNode = 'approve';
                    $("#mccTable").remove();
                    $("#manageId").textbox({required: false, disabled: true});
                } else if (node.taskPropId == "task1554347823700") {
                    //退回到起点
                    operation = 'edit';
                    currNode = 'return';

                    $("#canReturn").remove();
                    $("#viewButton").val("编辑事件");

                    $("#manageTable").remove();
                    //mcc主控及值班经理界面只读设置
                    $("#dept").combobox({disabled: true});
                    $("#point").numberbox({disabled: true});
                    $("#mccDes").textbox({disabled: true});
                    $("#melcdlDesc").textbox({disabled: true});
                    $("input[name=isMel]").attr("disabled", true);
                    $("input[name=isSdr]").attr("disabled", true);
                    //$("input[name=sdrType]").attr("disabled",true);
                }

                if (resource.isSdr == '1') {
                    $("input[name=isSdr][value=1]").attr('checked', true);
                    if (resource.sdrType == 'O') {
                        $("input[name=sdrType][value=O]").attr('checked', true);
                    } else {
                        $("input[name=sdrType][value=S]").attr('checked', true);
                    }
                }

                if (resource.isMel == '1') {
                    $("input[name=isMel][value=1]").attr('checked', true);
                }

                ParseFormField_(resource, null, null);
            }
        }
    });
}

// 使用困难报告回调方法
function sdrCallBack(sdrId, sdrType) {
    $("input[name=sdrType]").prop('disabled', false);
    $("#sdrId").val(sdrId);
    if (sdrType == 'O') {
        $("input[name=sdrType][value=S]").prop('checked', false);
        $("input[name=sdrType][value=O]").prop('checked', true);
    } else {
        $("input[name=sdrType][value=O]").prop('checked', false);
        $("input[name=sdrType][value=S]").prop('checked', true);
    }
    $("input[name=sdrType]").prop('disabled', true);
}

// 流程流转到下一个节点
function flowToNextNode(){
  /*MCC主控室审核*/
  if (currNode == 'checking'){
    //启用使用困难报告
    if ($("input[name=isSdr]:checked").val() == '1'){
      if (!$("#sdrId").val()){
        MsgAlert({content: '请先创建使用困难报告', type: 'warning'});
        return;
      }
    }
  }else if (currNode == 'approve'){
    var duttySuggest = [];
    var checkGrp = $("input:checked");
    $.each(checkGrp, function(k, val){
      duttySuggest.push($(val).attr('name'));
    });

    duttySuggest = duttySuggest.join(',');
    $("#dutySuggest").val(duttySuggest);
  }

  var $form = $("#mform");
  if (!$form.form('validate')){
    return;
  }
    $("input[name=sdrType]").prop('disabled', false);
  doSubmit();
}

function viewDetails(){
  var title_ = $.i18n.t('不正常事件查看/编辑');
  ShowWindowIframe({
      width: "1105",
      height: "650",
      title: title_,
      param: {operation: operation, pkid: pageData.pkid, isFlow: true},
      url: "/views/pm/mc/event/incident_detail.shtml"
  });
}

function editSucCallBack(){
  MsgAlert({content: '操作成功', type: 'info'});
}

function doReturn(){
  var notes = $("#notes").textbox('getValue');
  if($.trim(notes) == ''){
      MsgAlert({ content :'请输入您的退回意见',  type:'error' });
      return;
  }

  $.messager.confirm('提示?', "是否进行退回?", function(r){
      if (r){
          var $form = $("#mform");
          var data = $form.serializeObject();
          var reNode = "top";
          //值班经理审批节点只能退回到上一级
          if (currNode == 'approve'){
            reNode = "up";
          }
          if ("X" == $("#ifMcc").val() && currNode == 'checking') {
              reNode = "up";
          }
          data = $.extend({}, data, {
              FunctionCode: 'WS_FLOW_TURNBACK', reSelect: reNode,
              taskId: param.TASK_ID, procDefId : param.PROC_DEF_ID, notes: notes
          });
          if(!PAGE_EVENTS.beforeTurnBack(data)){
              return;
          }
          MaskUtil.mask("请求处理中...");
          InitFuncCodeRequest_({
              data: data,
              successCallBack: function (jdata) {
                  MaskUtil.unmask();
                  PAGE_EVENTS.afterTurnBack(jdata);
                  if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                      if(typeof(param.OWindow.reload_ == 'function')) {
                          param.OWindow.reload_();
                      }
                      param.OWindow.MsgAlert({ content : jdata.msg ? jdata.msg : $.i18n.t('msg_err:ERRMSG.COMMON.COMMON.OPT_SUCCESS')  });
                      CloseWindowIframe();
                  } else {
                      MsgAlert({ content: jdata.msg, type: 'error'});
                  }
              }
          });
      }
  });
}
</script>
</body>
</html>