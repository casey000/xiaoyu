<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="ws_work_flow">
  <!--#include virtual="/views/items/resource_.shtml"-->
  <script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
  <script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
  <title>使用困难报告调查流程</title>
</head>
<body class="ibody">

<div id="tabs" style="width: 100%; height: 100%;">
  <div id="tab01" title="业务表单数据" style="">
    <div class="ibox float-e-margins">
      <div class="ibox-content">
        <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
          <!-- Hidden Area-->
          <input type="hidden" name="pkid" id="pkid"/>
          <input type="hidden" id="ifReturn" name="ifReturn"/>
          <!---->
          <!-- 业务数据展示(MCC主控建议要求) start-->
          <table class="table table-bordered table-info">
            <tr>
              <td colspan="2">
                <table class="table table-bordered table-info sdrTable">
                  <tr>
                    <th class="th">1.航空器注册型号/型号：</th>
                    <td><input class="easyui-textbox" name="acno" id="acno"
                               data-options="required:true,disabled:true"/></td>
                    <td rowspan="2" style="width:50%;text-align:center;">
                      <label style="font-size:22px;">使用困难报告调查单</label><br>
                    </td>
                    <td class="th" style="text-align:center;background-color: #F5F5F6;">3.调查单编号：</td>
                  </tr>
                  <tr>
                    <th>2.航空运营人：</th>
                    <td style="text-align:center;">顺丰航空有限公司</td>
                    <td style="text-align:center;"><input class="easyui-textbox" name="surveyNo" id="surveyNo"
                                                          data-options="disabled:true"/></td>
                  </tr>
                </table>
              </td>
            </tr>
            <tr>
              <th class="th">4.使用困难报告核实：</th>
              <td>
                <table class="table table-bordered table-info" style="height:200px;">
                  <tr>
                    <th class="th">SDR编号:</th>
                    <td class="td5"><input class="easyui-textbox" name="sdrNo" id="sdrNo"
                                           data-options="disabled:true"></td>
                    <th class="th">航班代码:</th>
                    <td class="td5">
                      <input class="easyui-textbox" name="flightNo" id="flightNo"
                             data-options="disabled:true"/>
                    </td>
                    <th class="th">发生日期:</th>
                    <td class="td5"><input class="easyui-textbox" name="sdrDate" id="sdrDate"
                                           data-options="disabled:true"/>
                    </td>
                    <th class="th">发生地点:</th>
                    <td class="td5">
                      <input class="easyui-textbox" name="sdrPlace" id="sdrPlace" data-options="disabled:true"/>
                    </td>
                  </tr>
                  <tr>
                    <th class="th">发生阶段:</th>
                    <td class="td5"><input class="easyui-combobox" name="sdrStage" id="sdrStage"
                                           data-options="disabled:true"/></td>
                    <th class="th">故障现象:</th>
                    <td class="td5"><input class="easyui-combobox" name="sdrAppear" id="sdrAppear"
                                           data-options="disabled:true"/></td>
                    <th class="th">预防紧急措施:</th>
                    <td class="td5"><input class="easyui-combobox" name="sdrMeasure" id="sdrMeasure"
                                           data-options="disabled:true"/></td>
                    <th class="th">涉及主要系统:</th>
                    <td class="td5"><input class="easyui-textbox" name="sdrAta" id="sdrAta"
                                           data-options="disabled:true"/></td>
                  </tr>
                  <tr>
                    <th colspan="8" style="text-align:left;">事件描述和纠正措施：</th>
                  </tr>
                  <tr>
                    <td class="td5" colspan="8" style="padding-left:2px">
                      <input class="easyui-textbox" style="width:99%;height:100px;" name="sdrDes" id="sdrDes"
                             data-options="multiline:true,disabled:true"/>
                    </td>
                  </tr>
                </table>
              </td>
            </tr>
          </table>
          <h5 style="margin-bottom: 4px;">流程处理：</h5>
          <input name="taskId" type="hidden"/>
          <table class="table table-bordered table-info" id="mtable">
            <tr>
              <th class="tdl"> 处理意见：</th>
              <td class="tdr">
                <input id="notes" class="easyui-textbox easyui-validatebox" name="notes"
                       data-options="multiline:true, required:true,validType:['maxLength[500]'] "
                       style="height:65px; width: 90%;"/>
              </td>
            </tr>

            <tr>
              <td colspan="2" align="center">
                <input id="canSubmit" class="btn" type="button" onclick="javascript:doSubmit()" value="提交"/>
                <input id="canReturn" class="btn" type="button" onclick="javascript: returnCheck();" value="退回"/>
                <input id="view" class="btn btn-primary " type="button" onclick="viewDetails()" value="查看详情">
                <!--<input id="canTerminate" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="终止"/>
                <input id="canHangUp" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="挂起"/>-->
              </td>
            </tr>
          </table>
        </form>
      </div>
    </div>
  </div>
  <div title="流程信息">
    <table class="table table-bordered table-info" id="processInfo">
      <tr>
        <th class="tdl" style="width: 145px;">流程业务Key ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="businessKey"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="executionName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <tr>
        <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="createTime"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">流程创建人 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="userName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <tr>
        <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="nodeName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="isJoint"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <!--<tr>
        <th class="tdl" style="width: 145px;">流程任务-配置 ：</th>
        <td class="tdr" colspan="3" style="vertical-align: middle;">
          <input type="checkbox" name="canReturn" value="" disabled/> 可退回
          <input type="checkbox" name="canTrunTo" value="" disabled/> 可转办
          <input type="checkbox" name="canTerminate" value="" disabled/> 可终止
          <input type="checkbox" name="canHangUp" value="" disabled/> 可挂起
        </td>
      </tr>-->
    </table>
    <div id="workflow" style="overflow-x: scroll;"></div>
  </div>
  <div id="tab02" title="历史任务信息" style="">
    <table id="historyDg"></table>
  </div>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">

    var pkid;
    var flowNode;
    var taskId;
    /**
     * 初始化流程业务处理页面
     * @param resource  业务数据
     * @param execution 流程实例数据
     * @param node 节点配置数据
     * @constructor
     */
    function InitLoadResource(resource, execution, node) {
        // 业务对象主要数据展示
        initForm(resource);
        pkid = resource.pkid;
        taskId=node.taskPropId;
        //当前节点为回退节点
        if (node.taskPropId == "task1557222212339"){
          flowNode = 'return';
          $("#canReturn").remove();
        }//可靠性组审核
        else if (node.taskPropId == "task1557222158250"){
          flowNode = 'check';
        }//质量工程师确认
        else if(node.taskPropId == "task1557222170873"){
          flowNode = 'confirm';
        }
        //调查单编写
        else if(node.taskPropId == "task1582303159984"){
          flowNode = 'check';
            $("#canReturn").remove();
        }
    }
    function returnCheck() {

        if(taskId=="task1557222158250"){
          $("#ifReturn").val("Y");
          doSubmit();
        }else {
          doReturn();
        }

    }
    function initForm(resource){
      InitFuncCodeRequest_({
        data: {
            domainCode: "SDR_APPEAR,SDR_STAGE,SDR_MEASURE,IS_MACHINE",
            FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
        },
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                //困难报告部分初始化
                $('#sdrStage').combobox({
                    panelHeight: '140px',
                    data: jdata.data.SDR_STAGE,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    multiple: true
                });

                $('#sdrAppear').combobox({
                    panelHeight: '140px',
                    data: jdata.data.SDR_APPEAR,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    multiple: true
                });

                $('#sdrMeasure').combobox({
                    panelHeight: '140px',
                    data: jdata.data.SDR_MEASURE,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    multiple: true
                });

                InitFuncCodeRequest_({
                    data: {'pkid':resource.pkid, FunctionCode: 'PM_MC_SDR_SURVEY_LIST'},
                    successCallBack: function (jdata) {
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                          var surveyData = jdata.data[0];

                          ParseFormField_(surveyData, null, Constant.CAMEL_CASE);

                          //有些特殊字段需要手动进行赋值
                          $("#acno").textbox('setValue', surveyData.ACNO);
                          if(surveyData.SDR_APPEAR){
                            $("#sdrAppear").combobox("setValue", surveyData.SDR_APPEAR.split(","));
                          }
                          if(surveyData.SDR_MEASURE){
                            $("#sdrMeasure").combobox("setValue", surveyData.SDR_MEASURE.split(","));
                          }
                          if(surveyData.SDR_STAGE){
                            $("#sdrStage").combobox("setValue", surveyData.SDR_STAGE.split(","));
                          }
                        }
                    }
                });
            }else {
                MsgAlert({content: jdata.msg, type: 'error'});
            }
        }
      });
    }

    /**
    * 查看详情，在退回时可编辑
    */
    function viewDetails(){
      var title_ = $.i18n.t('非正常事件查看编辑');
      ShowWindowIframe({
          width: "1250",
          height: "620",
          title: title_,
          param: {operation: 'edit', pkid: pkid, flowNode: flowNode},
          url: "/views/pm/mc/event/pm_mcc_sdr_survey_detail.shtml"
      });
    }

    /*流程回退*/
    function doReturn(){
        $.messager.confirm('提示?', "是否进行退回?", function(r){
            if (r){
                var notes = $("#notes").textbox('getValue');
                if($.trim(notes) == ''){
                    MsgAlert({ content :'请输入您的退回意见',  type:'error' });
                    return;
                }
                var $form = $("#mform");
                var data = $form.serializeObject();
                data = $.extend({}, data, {
                    FunctionCode: 'WS_FLOW_TURNBACK', reSelect: "up",
                    taskId: param.TASK_ID, procDefId : param.PROC_DEF_ID, notes: notes
                });
                if(!PAGE_EVENTS.beforeTurnBack(data)){
                    return;
                }
                MaskUtil.mask("请求处理中...");
                InitFuncCodeRequest_({
                    data: data,
                    successCallBack: function (jdata) {
                        MaskUtil.unmask();
                        PAGE_EVENTS.afterTurnBack(jdata);
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                            if(typeof(param.OWindow.reload_ == 'function')) {
                                param.OWindow.reload_();
                            }
                            param.OWindow.MsgAlert({ content : jdata.msg ? jdata.msg : $.i18n.t('msg_err:ERRMSG.COMMON.COMMON.OPT_SUCCESS')  });
                            CloseWindowIframe();
                        } else {
                            MsgAlert({ content: jdata.msg, type: 'error'});
                        }
                    }
                });
            }
        });
    }

    function reload_(){
      //do nothing
    }

</script>
</body>
</html>