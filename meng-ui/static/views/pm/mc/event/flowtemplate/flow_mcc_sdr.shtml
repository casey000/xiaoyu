<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="ws_work_flow">
  <!--#include virtual="/views/items/resource_.shtml"-->
  <script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
  <script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
  <title>使用困难报告流程</title>
</head>
<body class="ibody">

<div id="tabs" style="width: 100%; height: 100%;">
  <div id="tab01" title="业务表单数据" style="">
    <div class="ibox float-e-margins">
      <div class="ibox-content">
        <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
          <!-- Hidden Area-->
          <input type="hidden" name="pkid" id="pkid"/>
          <input type="hidden" id="isTriggerSaveButton" value="false"/>
          <!---->
          <!-- 业务数据展示(MCC主控建议要求) start-->
            <div style="height: 500px;">
            <iframe scrolling="auto" id="iframe" frameborder="0" src="" style="width:100%;height:100%;"></iframe>
          </div>
          <h5 style="margin-bottom: 4px;">流程处理：</h5>
          <input name="taskId" type="hidden"/>
          <table class="table table-bordered table-info" id="mtable">
            <tr>
              <th class="tdl"> 处理意见：</th>
              <td class="tdr">
                <input id="notes" class="easyui-textbox easyui-validatebox" name="notes"
                       data-options="multiline:true, required:true,validType:['maxLength[500]'] "
                       style="height:65px; width: 90%;"/>
              </td>
            </tr>

            <tr>
              <td colspan="2" align="center">
                <input id="returnSaveButton" class="btn btn-primary" type="button" style="display:none;"
                       onclick="returnSave()" value="保存"/>
                  <input id="canSubmit" class="btn" type="button" onclick="doSubmitSelf()" value="提交"/>
                  <input id="canReturn" class="btn" type="button" onclick="doReturn();" value="退回"/>
                <!--<input id="view" class="btn btn-primary " type="button" onclick="viewDetails()"value="查看详情">-->
                <!--<input id="canTerminate" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="终止"/>
                <input id="canHangUp" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="挂起"/>-->
              </td>
            </tr>
          </table>
        </form>
      </div>
    </div>
  </div>
  <div title="流程信息">
    <table class="table table-bordered table-info" id="processInfo">
      <tr>
        <th class="tdl" style="width: 145px;">流程业务Key ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="businessKey"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="executionName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <tr>
        <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="createTime"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">流程创建人 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="userName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <tr>
        <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="nodeName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="isJoint"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <!--<tr>
        <th class="tdl" style="width: 145px;">流程任务-配置 ：</th>
        <td class="tdr" colspan="3" style="vertical-align: middle;">
          <input type="checkbox" name="canReturn" value="" disabled/> 可退回
          <input type="checkbox" name="canTrunTo" value="" disabled/> 可转办
          <input type="checkbox" name="canTerminate" value="" disabled/> 可终止
          <input type="checkbox" name="canHangUp" value="" disabled/> 可挂起
        </td>
      </tr>-->
    </table>
    <div id="workflow" style="overflow-x: scroll;"></div>
  </div>
  <div id="tab02" title="历史任务信息" style="">
    <table id="historyDg"></table>
  </div>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    /**
     * 初始化流程业务处理页面
     * @param resource  业务数据
     * @param execution 流程实例数据
     * @param node 节点配置数据
     * @constructor
     */
    var currNode;
    function InitLoadResource(resource, execution, node) {
        var operation = 'view';

        $("#pkid").val(resource.pkid);

        //当前节点为回退节点
        if (node.taskPropId == "task1557140640740"){
          operation = 'edit';
          $("#canReturn").remove();
          $("#returnSaveButton").show();
          currNode = 'returnNode';
        }

        $("#iframe").attr("src",
          "/views/pm/mc/event/pm_mcc_sdr_detail.shtml?pkid="+resource.pkid+"&operation="+operation+"&flow=true");

        $("#iframe").load(function(){
          $("#iframe").contents().find("#checkName").val(getLoginInfo().userName);
        });

    }

    function doSubmitSelf(){
      var isValidate = $("#mform").form('validate');
      if (!isValidate){
        return;
      }

      if (currNode == 'returnNode'){
        //检查是否触发保存按钮
        if ($("#isTriggerSaveButton").val() == 'false'){
          MsgAlert({content: '请先保存数据，再提交', type: 'warn'});
          return;
        }
      }

      doSubmit();
    }

    /*回退后保存业务数据*/
    function returnSave(){
        $("#iframe").contents().find("#saveButton").click();
        $("#isTriggerSaveButton").val("true");
    }

    /*流程回退*/
    function doReturn(){
        $.messager.confirm('提示?', "是否进行退回?", function(r){
            if (r){
                var notes = $("#notes").textbox('getValue');
                if($.trim(notes) == ''){
                    MsgAlert({ content :'请输入您的退回意见',  type:'error' });
                    return;
                }
                var $form = $("#mform");
                var data = $form.serializeObject();
                data = $.extend({}, data, {
                    FunctionCode: 'WS_FLOW_TURNBACK', reSelect: "top",
                    taskId: param.TASK_ID, procDefId : param.PROC_DEF_ID, notes: notes
                });
                if(!PAGE_EVENTS.beforeTurnBack(data)){
                    return;
                }
                MaskUtil.mask("请求处理中...");
                InitFuncCodeRequest_({
                    data: data,
                    successCallBack: function (jdata) {
                        MaskUtil.unmask();
                        PAGE_EVENTS.afterTurnBack(jdata);
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                            if(typeof(param.OWindow.reload_ == 'function')) {
                                param.OWindow.reload_();
                            }
                            param.OWindow.MsgAlert({ content : jdata.msg ? jdata.msg : $.i18n.t('msg_err:ERRMSG.COMMON.COMMON.OPT_SUCCESS')  });
                            CloseWindowIframe();
                        } else {
                            MsgAlert({ content: jdata.msg, type: 'error'});
                        }
                    }
                });
            }
        });
    }

</script>
</body>
</html>