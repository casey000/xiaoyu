<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="tm_hrarchive">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title></title>
    <link href="/css/gantt/ganttstyle.css" rel="stylesheet" type="text/css" />
    <style>
        .contain {
            width: 800px;
            margin: 0 auto;

        }

        .menu {
            background-color: #fafafa;
            border-color: #ddd;
            color: #444;
            position: absolute;
            margin: 0;
            padding: 2px;
            display: none;
            border-width: 1px;
            border-style: solid;
            overflow: hidden;
        }
        .menu-item {
            border-color: transparent;
            position: relative;
            margin: 0;
            padding: 0;
            overflow: hidden;
            white-space: nowrap;
            cursor: pointer;
            border-width: 1px;
            border-style: solid;
        }
        .menu-text {
            float: left;
            padding-left: 28px;
        }
        .menu-item:hover {
            border-color: #b7d2ff;
            color: #000000;
            background: #eaf2ff;
        }
        .fn-gantt .navigate .nav-slider .nav-prev-week{
            display: none;
        }
        .fn-gantt .navigate .nav-slider .nav-now{
            display: none;
        }
        .fn-gantt .navigate .nav-slider .nav-prev-day{
            display: none;
        }
        .fn-gantt .navigate .nav-slider-right {
            display: none;
        }
        .fn-gantt .leftPanel{
            width: 100px;
        }
        .fn-gantt .bar .fn-label {
            font-weight: 500;
        }
    </style>
</head>
<body class="ibody">
<form class="form-horizontal" id="ffSearch">
    <table class="table table-bordered table-info">
        <tr>
            <th align="right" class="th" style="width:150px;">开始日期</th>
            <td style="width:80px; padding:3px;">
                <input class="easyui-datebox" id="startDate" name="startDate" style="width:180px;"/>
            </td>
            <th align="right" class="th" style="width:150px;">结束日期</th>
            <td style="width:80px; padding:3px;">
                <input class="easyui-datebox" id="endDate" name="endDate" style="width:180px;"/>
            </td>

            <td colspan="3">
                <a class="searchBtn" data-options="iconCls:'icon-search'" onclick="searchData()" style="margin-left: 50px" type="button">
                    <span data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>
                <a class="searchBtn" data-options="iconCls:'icon-search'" onclick="searchData()" style="margin-left: 50px" type="button">
                    <span>刷新</span></a>
<!--                <a class="searchBtn" data-options="iconCls:'icon-search'" onclick="test()" style="margin-left: 50px" type="button">-->
<!--                    <span data-i18n="common:COMMON_OPERATION.QUERY">test</span></a>-->
            </td>
        </tr>
        <tr>
            <td colspan="10" >
                <p style="color: red;padding-left: 20px">数据是从开始日期的12:00到结束日期的12:00</p>
            </td>
        </tr>
    </table>
</form>
<div class="gantt_ot" style="width:100%; margin:0px auto 100px;">
    <div class="gantt"></div>
</div>
<div class="menu-top menu"  id="rightMenu"
     style="width: 150px;z-index: 110007;">
    <div class="menu-item" style="height: 32px;">
        <div class="menu-text" onclick="newChart(1)" style="height: 30px; line-height: 30px;">编辑停场原因</div>
    </div>
    <div class="menu-item" style="height: 32px;">
        <div class="menu-text" onclick="newChart(2)" style="height: 30px; line-height: 30px;">编辑风险与注意事项</div>
    </div>
    <div class="menu-item" style="height: 32px;">
        <div class="menu-text" onclick="newChart(3)" style="height: 30px; line-height: 30px;">编辑定检联系人</div>
    </div>
</div>
<script src="/js/gantt/jquery.fn.gantt.js" type="text/javascript"></script>
<script src="/views/pm/mc/js/datagrid_utils.js" type="text/javascript"></script>
<script type="text/javascript" src="/js/statistics.js"></script>
<script type="text/javascript">
    var dataArr = [];
    function i18nCallBack() {
        var date = new Date();
        var yesterday  = new Date(date.setDate(date.getDate()-1))
        var start =  yesterday.Format("yyyy-MM-dd");
        var dateTime = new Date(date.setDate(date.getDate()+2));
        var end = dateTime.Format("yyyy-MM-dd");
        $('#startDate').datebox('setValue',start)
        $('#endDate').datebox('setValue',end)
        searchData();
    }

    //五分钟定时刷新一次 1000（1秒）
    setInterval('searchData()', 300000);
    function searchData(){
        if(!$('#startDate').datebox('getValue') || !$('#endDate').datebox('getValue')){
            MsgAlert({type: "error", content: "开始时间与结束时间必填"});
            return
        }
        let url ="/api/v1/mcc/visualBoard/list_aircraft_maintenance_info";
        let dateObj = {
            startDate:$('#startDate').datebox('getValue') +' ' + "12:00:00",
            endDate:$('#endDate').datebox('getValue') + ' '+ "12:00:00"
        }
        axios.post(url, dateObj).then(response=>{
            if(response.data.code === 200){
            formatGantt(response.data.data)

            // close_window()
        }else{
            throw new Error(response.data.msgData[0])
        }
    }).catch(err=>{
            MsgAlert({type: "error", content: "保存失败" + err});
        })
        //如果需要统计，就每次调用结束都会手动记录一次浏览量
        dynamicStatisticsSrc();
    };

    function formatGantt(array) {
        // console.log(data)
        // for(let i in data){
        //
        // }
        var result = array.map(o=>{

            return{
                name:o.acReg,
                values:secFormat(o.itemList,o.acReg),
            }
        });
        // var tt = result.values.map(o=>{return{from:o.startTime,to:o.endTime}});

        // console.log(result,'213123');
        dataArr = result;
        prettyPrint()

        // result.values.map(o=>{return{from:o.startTime,to:o.endTime}});
    }

    function secFormat(array,acReg) {

        var result = array.map(o=>{
            o.acReg = acReg;
            var desc = o.flightNo;
            var customClass;
            var label;
            if(o.periodType == "FLIGHT"){
                customClass = 'ganttFlight';
                var short = o.limitMap.LIMIT_NAMES_SHORT || ''
                label = o.fromStation +',' + short + ',' + o.toStation
            }else if(o.periodType == "TC"){
                label = o.maintenanceStatus
                if(o.releaseStatus == 'RELEASED'){
                    customClass = 'ganttGreen';
                }
                if(o.releaseStatus == 'UNRELEASED'){
                    if(o.isNoGo == 'y'){
                        customClass = 'ganttRed';
                    }else{
                        if(o.workType == 'Po/F'){
                            if(o.isCurrentOverSeventeenOClock == 'y' || o.isLandingOverSixHour == 'y'){
                                customClass = 'ganttOrange';
                            }else{
                                customClass = 'ganttGrey';
                            }
                        }else{
                            customClass = 'ganttGrey';

                        }
                    }
                }
                var pCheck='',pStop='',pRisk='';
                pCheck = '无';
                pRisk =  '无';
                pStop =  '无';
                if(o.flightRemarkList.length > 0){
                    for(let i in o.flightRemarkList){
                        if(o.flightRemarkList[i].type == 'PCHECK_CONTACTS')
                            pCheck = o.flightRemarkList[i].content || '无';
                        if(o.flightRemarkList[i].type == 'RISKS_NOTES')
                            pRisk = o.flightRemarkList[i].content|| '无';
                        if(o.flightRemarkList[i].type == 'STOP_PRO_REA')
                            pStop = o.flightRemarkList[i].content|| '无';
                    }
                }else{
                    pCheck = '无';
                    pRisk =  '无';
                    pStop =  '无';
                }


                desc = '定检飞机联系人：' +  pCheck +'<br/>'+ '停场原因：' + pStop + '<br/>' + '风险与注意事项：' + pRisk;
            }
            let dateObj = {
                startDate:$('#startDate').datebox('getValue') +' ' + "12:00:00",
                endDate:$('#endDate').datebox('getValue') + ' '+ "12:00:00"
            }
            // console.info(new Date(dateObj.endDate).getTime(),'end')
            // console.info(new Date(dateObj.startDate).getTime(),'start')
            var searchStart = new Date(dateObj.startDate).getTime()
            var searchEnd = new Date(dateObj.endDate).getTime()
            return{
                from:o.startTime > searchStart ? o.startTime :searchStart,
                to:o.endTime > searchEnd ? searchEnd - 1: o.endTime -1,  //不减一会多占一格
                // from:o.startTime,
                // to:o.endTime,
                label:label,
                customClass: customClass,
                dataObj: o,
                desc: desc,
            }
        });
        // console.info(result)

        return  result
    }
    function test() {
        dataArr[0].values[0].desc ='2132';
        console.log(dataArr)
    }
    function validateDateTime(beginTimeId,endTimeId,whichTimeId)
    {
        var v1=$('#'+beginTimeId).datetimebox("getValue");
        var date1 = new Date(v1);
        var v2=$('#'+endTimeId).datetimebox("getValue");
        var date2 = new Date(v2);

        if(v1==''||v2=='')
        {
            return true;
        }
        if(date1<date2)
        {
            var diff=DateDiff(date1,date2);
            if(diff>2)
            {
                MsgAlert({type: "error", content: "时间段不能超过2天"});
                $('#'+whichTimeId).datebox("setValue","");
            }
            return true;
        }
        try{
            $('#'+whichTimeId).datebox("setValue","");
        }catch(e){
        }

        MsgAlert({type: "error", content: "开始时间要小于结束时间" });
        return false;
    };
    $('#startDate').datebox({
        onHidePanel: function(date){
            validateDateTime('startDate','endDate','startDate');
        }
    });
    $('#endDate').datebox({
        onHidePanel: function(date){
            validateDateTime('startDate','endDate','endDate');
        }
    });
    function DateDiff(date1,date2){
        var startTime=Date.parse(date1);
        var endTime=Date.parse(date2);
        return (endTime-startTime)/1000/3600/24
    }
    function prettyPrint () {
        var arr =[

            {
                name: "B1566",
                values: [
                    {
                        from: "1320110000000",
                        to: "1320115000000",
                        label: "Po/F",
                        customClass: "ganttRed",
                        dataObj: {id: '2'},
                        desc: '<b>Task #</b>3<br><b>Data</b>: [2018-06-06 15:30:00 - 2018-06-28 16:00:00]',
                    }
                ]
            },
            {
                name: "B1569",
                values: [
                    {
                        from: "/Date(1320192000000)/",
                        to: "/Date(1320210000000)/",
                        label: "Pr/F",
                        desc: "这是1566",
                        dataObj: {id: '3'},
                        customClass: "ganttRed"
                    },
                ]
            },

        ]
        // "use strict";
        //初始化gantt
        $(".gantt").gantt({
            source: dataArr,
            navigate: 'scroll',//buttons  scroll
            scale: "hours",// months  weeks days  hours
            maxScale: "months",
            minScale: "days",
            itemsPerPage: 100,
            scrollToToday:false,
            waitText:'加载中...',
            months: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
            onItemClick: function (data) {
                $('#rightMenu').css('display', 'none');
            },
            onAddClick: function (dt, rowId) {
                $('#rightMenu').css('display', 'none');
            },
            onRightClick: function (data) {
                // console.log(data)
                obj = data;
            },
            onRender: function () {
                if (window.console && typeof console.log === "function") {
                    console.log("chart rendered");
                }
            }
        });


        //弹窗功能
        // $(".gantt").popover({
        //         selector: ".bar",
        //         title: "I'm a popover",
        //         content: '123123',
        //         trigger: "hover",
        //         placement: "auto right"
        // });


        //prettyPrint();
    };

    function newChart(data) {
        // console.warn(obj)
        // console.warn(data)
        var curWidth = ($(window).width() * 0.8).toString();
        var curheight = $(window).height().toString();
        ShowWindowIframe({
            width: curWidth,
            height: 700,
            title: '',
            param: {
                obj: obj,
                nav:data,
            },
            url: "/views/pm/mc/summary/gantt_edit.shtml"
        });
    };
    //不需要积隐藏右键菜单

    $("body").click(function(event){
        $('#rightMenu').css('display', 'none');
    });


</script>
</body>
</html>