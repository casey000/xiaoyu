<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->
    <meta charset="UTF-8">
    <title>NRC DELAY</title>
    <link href="/css/nrc/nrc_add.css" rel="stylesheet">

</head>
<body>
<table class="addnrc_table">
    <div style="display: none">
        <input class="easyui-textbox" id="nrcId">

    </div>
    <tr>
        <td class="key" colspan="4"><span>NRC<span id="timeLimitTypeto"></span>延期申请</span></td>
    </tr>
    <tr>
        <td class="key">NRC号</td>
        <td><span id="nrcNo" onclick="nrc_see()" style="cursor: pointer"></span></td>
        <td class="key">飞机/发动机</td>
        <td><span id="acEng"></span></td>
    </tr>
    <tr>
        <td class="key">NRC缺陷描述</td>
        <td colspan="3"><span id="descChn"></span></td>
    </tr>
    <tr>
        <td class="key">NRC纠正方案</td>
        <td colspan="3"><span id="rectChn"></span></td>
    </tr>
    <tr>
        <td class="key">延期原因</td>

        <td class="input_td" colspan="3" id="hoReason">
            <div class="zhezhao" style="display: none;background-color: #fafafa4d"></div>
            <input class="input_checkbox" id="ts" type="checkbox" value="1"><label
                for="ts">技术</label>
            <input class="input_checkbox" id="material" type="checkbox" value="2"><label
                for="material">航材</label>
            <input class="input_checkbox" id="spec" type="checkbox" value="3"><label for="spec">特殊工具</label>
            <input class="input_checkbox" id="tine" type="checkbox" value="4"><label for="tine">时间不足</label>
            <input class="input_checkbox" id="others" onclick="Other_matters()" type="checkbox"
                   value="5"><label for="others">其他</label>
            <div class="input_div">
                <input class="beiliao" disabled="disabled" id="hoReasonOther" style="width: 85%;"
                       type="text">
            </div>
        </td>
    </tr>
    <tr>
        <td class="key">运行分类</td>
        <td COLSPAN="3"><span id="fenlei"
                              style="    padding: 5px 50px 5px 50px;border: 1px solid #ccc;">10天（20fc/30fh）内纠正</span>
            <input disabled="disabled" id="yunxin_y" name="runType" type="radio" value="1"><label
                    for="yunxin_y">运行</label><input
                    disabled="disabled"
                    id="yunxin_n"
                    name="runType" type="radio" value="0"><label
                    for="yunxin_n">非运行</label>
        </td>
    </tr>
    <tr>
        <td class="key">时限类型</td>
        <td><span id="timeLimitType"></span></td>
        <td class="key">延期次数</td>
        <td><span id="delayNum"></span></td>
    </tr>
    <tr class="hard" style="display:none;">
        <td class="key">时限依据</td>
        <td colspan="3">
            <input disabled="disabled" id="shouche" name="manualOrTechnical" type="radio" value="1"><label
                for="shouche">手册要求</label>
            <input disabled="disabled" id="jishu" name="manualOrTechnical" type="radio" value="2"><label
                for="jishu">技术评估</label>
        </td>
    </tr>
    <tr class="soft" style="display:none;">
        <td class="key">延期时限</td>
        <td colspan="3">
            <div class="zhezhao hardTime_zhe" style="display: none;background-color: #fafafa4d"></div>
            <input id="ruan_9" name="adviseDoTimeType" onclick="update_pnsn_cols(1)" type="radio"
                   value="1"><label for="ruan_9">90天</label>
            <input id="ruan_12" name="adviseDoTimeType" onclick="update_pnsn_cols(2)" type="radio"
                   value="2"><label for="ruan_12">120天</label>
            <input id="ruan_18" name="adviseDoTimeType" onclick="update_pnsn_cols(3)" type="radio"
                   value="3"><label for="ruan_18">180天</label>
            <input id="ruan_next" name="adviseDoTimeType" onclick="update_pnsn_cols(4)" type="radio"
                   value="4"><label
                for="ruan_next">下次C检</label>
            <input id="ruan_huan" name="adviseDoTimeType" onclick="update_pnsn_input(5)" type="radio"
                   value="5"><label
                for="ruan_huan">换发时执行</label>
            <input id="ruan_song" name="adviseDoTimeType" onclick="update_pnsn_input(6)" type="radio"
                   value="6"><label
                for="ruan_song">送修时执行</label>
        </td>
    </tr>
    <tr class="hard" style="display:none;">
        <td class="key">延期时限</td>
        <td colspan="3">
            <div class="zhezhao hardTime_zhe" style="display: none;background-color: #fafafa4d"></div>
            <div class="yin_div_2">
                <div class="yin_neizi" style="float: left">
                    <div><input class="beiliao hardtime" id="fh" name="fh" onblur="fh_fc_daye('fh')" readonly="readonly"
                                style="width: 65%" type="text">FH
                    </div>
                    <div><input class="beiliao hardtime" id="fc" name="fc" onblur="fh_fc_daye('fc')" readonly="readonly"
                                style="width: 65%" type="text">FC
                    </div>

                    <div style="width: 100px;"><input class="beiliao hardtime" id="days" name="days" readonly="readonly"
                                                      onblur="fh_fc_daye('days')"
                                                      style="width: 65%" type="text">DAYS
                    </div>
                </div>
                <div id="next_div" style="float: left">
                    <input class="input_checkbox" id="next_c" name="hardTimeType"
                           type="radio" value="2"><label
                        FOR="next_c">NEXT C</label>
                    <input class="input_checkbox" id="songxiu" name="hardTimeType"
                           type="radio" value="3"><label
                        FOR="songxiu">送修时执行</label>
                </div>
            </div>
            <div class="yin_div_3" style="height: 100%;width: 95px">
                <input disabled="disabled" id="First" name="firstLast" type="radio" value="1"><label
                    FOR="First">First</label>
                <input disabled="disabled" id="last" name="firstLast" type="radio" value="2"><label
                    FOR="last">last</label>
            </div>
        </td>
    </tr>
    <tr>
        <td class="key">送修部件</td>
        <td class="pn_sn_input" colspan="3">
            PN:<input class="beiliao" disabled="disabled" id="pn" name="pn"
                      style="width: 35%;" type="text">
            SN:<input class="beiliao" disabled="disabled" id="sn" name="sn"
                      style="width: 35%;" type="text">
        </td>
    </tr>
    <tr>
        <td class="key">延期原因及措施<span id="addspan">*</span></td>
        <td colspan="3">
            <textarea id="delayReason" maxlength="300" name="descChn"></textarea>
            <span id="delayReasonspan" style="display: none"></span>
        </td>
    </tr>
    <tr id="reason_tr" style="display: none">
        <td class="key" id="reason_">审批意见<span>*</span></td>
        <td class="key" id="re_jiru" style="display: none">审批记录</td>
        <td colspan="3">
            <textarea id="reason" maxlength="300" name="descChn"></textarea>
            <span id="reasonspan" style="display: none"></span>
        </td>
    </tr>

</table>
<div class="button_a">
    <a id="EDITING" onclick="submit_nrc()">提交</a>
    <a id="CHECKING" onclick="bohui_nrc()">驳回</a>
    <a id="ACTIVE" onclick="confirm_nrc()">确定</a>
</div>
</body>
<script src="/js/plugins/ajaxfileupload/ajaxfileupload.js" type="text/javascript"></script>
<script src="../../../js/datagrid_utils.js" type="text/javascript"></script>
<!--<script src="/js/nrc/nrc_toadd.js" type="text/javascript"></script>-->
<script type="text/javascript">

    $(function () {
        //如果为字符串，就转化成JSON对象
        if (typeof getParentParam_().delay !== "string") {
            delay_data(getParentParam_().delay);
        } else {
            let delay_index = JSON.parse(getParentParam_().delay);
            let processStatus = delay_index.processStatus;
            let ur_l = '';
            if (processStatus === 'ACTIVE') {
                //该方法不含对流程判断
                ur_l = "/api/v1/nrc/delay/query_delay_and_flow_info_by_id?id=" + delay_index.id;
            } else {
                ur_l = "/api/v1/nrc/delay/get_delay_by_nrc_id?nrcId=" + delay_index.nrcId;
            }

            $.ajax({
                type: "GET",
                url: ur_l,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if (data.code === 200) {
                        delay_data(data);
                    } else {
                        if (data.msgData) {
                            alert(data.msgData[0]);
                        } else {
                            alert(data.msg);
                        }
                    }
                },
                error: function () {
                    alert("失败！");
                }
            });
        }

    });
    var ajax_data = {};
    function delay_data(data) {
         ajax_data = data.data;
        console.log(ajax_data);
        $("#nrcId").textbox("setValue", data.data.nrcId);
                    if (data.data.processStatus != "EDITING") {
                        $(".zhezhao").show();
                        $("#delayReasonspan").text(data.data.delayReason);
                        $("#delayReasonspan").show();
                        $("#delayReason").hide();
                        $("#addspan").hide();
                        $("#reason_tr").show();
                    } else {
                        $("#CHECKING").hide();
                        $("#ACTIVE").hide()
                    }
                    if (data.data.processStatus == "CHECKING") {
                        $(".hardTime_zhe").hide();
                    }
                    if (data.data.processStatus != "ACTIVE") {
                        $("#ACTIVE").hide();
                    } else {
                        $("#reason_tr").hide();
                        $("#EDITING").hide();
                        $("#CHECKING").hide();
                    }
                    if (data.data.isMtr == 1) {
                        $("#material").removeAttr('disabled');
                        $("#spec").removeAttr('disabled');
                    } else {
                        $("#material").attr('disabled', 'false');
                        $("#spec").attr('disabled', 'false');
                    }
                    $("#acEng").text(data.data.acEng);
                    $("#nrcNo").text(data.data.nrcNo);
                    $("#descChn").text(data.data.descChn);
                    $("#delayNum").text(data.data.delayNum);
                    $("#rectChn").text(data.data.rectChn);
                    $("#fenlei").text(runcategory(data.data.runCategory));
        if (data.data.fh) {
            $("#fh").removeAttr('readonly');
        }
        if (data.data.fc) {
            $("#fc").removeAttr('readonly');
        }
        if (data.data.days) {
            $("#days").removeAttr('readonly');
        }
                    $("#pn").val(data.data.pn);
                    $("#sn").val(data.data.sn);
                    $("#fh").val(data.data.fh);
                    $("#fc").val(data.data.fc);
                    $("#days").val(data.data.days);

                    let hoReason = data.data.hoReason.split(",");
                    let intto = 1;
                    // $('#approval').dialog('open');
                    $.each($('#hoReason .input_checkbox'), function () {
                        for (let i in hoReason) {
                            if (hoReason[i] == intto) {
                                $(this).prop("checked", true);
                                if (hoReason[i] == 5) {
                                    Other_matters();
                                }
                            }
                        }
                        intto++;
                    });
                    $("#hoReasonOther").val(data.data.hoReasonOther);
                    if (data.data.runType == 1) {
                        $("#yunxin_y").prop("checked", true);
                    } else if (data.data.runType == 0) {
                        $("#yunxin_n").prop("checked", true);
                    }
                    if (data.data.timeLimitType == 1) {
                        hardTimeType(data.data.hardTimeType);
                        $("#timeLimitType").text("硬时限");
                        $("#timeLimitTypeto").text("硬时限");
                        $(".hard").show();
                    } else {
                        adviseDoTimeTy(data.data.suspending.adviseDoTimeType,data.data.adviseDoTimeType);
                        $("#timeLimitType").text("软时限");
                        $("#timeLimitTypeto").text("软时限");
                        $(".soft").show();
                    }
                    if (data.data.manualOrTechnical == 1) {
                        $("#shouche").prop("checked", true);
                    } else if (data.data.manualOrTechnical == 2) {
                        $("#jishu").prop("checked", true);
                    }
                    if (data.data.firstLast == 1) {
                        $("#First").prop("checked", true);
                    } else if (data.data.firstLast == 2) {
                        $("#last").prop("checked", true);
                    }


    }

    function confirm_nrc() {
        let id = ajax_data.id;

        $.ajax({
            type: "GET",
            url: "/api/v1/nrc/delay/confirm_delay?id=" + id,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    alert("提交成功");
                    parent && parent.window.colsa_window && parent.window.colsa_window();
                    window.close();
                } else {
                    if (data.msgData) {
                        alert(data.msgData)
                    } else {
                        alert(data.msg)
                    }
                }
                // parent.window.colsa_window();
            },
            error: function () {
                window.alert("失败！");
            }
        });
    }

    function runcategory(data) {
        if (data == 1) {
            return "运行飞机串件";
        } else if (data == 2) {
            return "机组操作";
        } else if (data == 3) {
            return "影响地服推行";
        } else if (data == 4) {
            return "影响机组飞行品质";
        } else if (data == 5) {
            return "液体渗漏";
        } else if (data == 6) {
            return "10天（20FC/30FH）内纠正";
        } else if (data == 8) {
            return "货舱装载系统缺陷"
        } else if (data == 9) {
            return "下货舱门开关缺陷"
        } else if (data == 10) {
            return "烤箱烧水杯故障"
        } else if (data == 11) {
            return "厕所排放系统缺陷"
        } else if (data == 7) {
            return "其他";
        }
    }

    function hardTimeType(data) {
        if (data == 1) {
            $("#next_c").attr("disabled", "disabled");
            $("#songxiu").attr("disabled", "disabled");
        }
        if (data == 2) {
            $("#next_c").prop("checked", true);
            $(".hardtime").attr("disabled", "disabled");
            $(".hardTime_zhe").show();
        }
        if (data == 3) {
            $("#songxiu").prop("checked", true);
            $(".hardtime").attr("disabled", "disabled");
            $(".hardTime_zhe").show();
        }
    }

    function adviseDoTimeTy(data,adviseDoTimeType) {
        if (data == 1) {
            $("#ruan_12").attr("disabled", "disabled");
            $("#ruan_18").attr("disabled", "disabled");
            $("#ruan_next").attr("disabled", "disabled");
            $("#ruan_huan").attr("disabled", "disabled");
            $("#ruan_song").attr("disabled", "disabled");
        }
        if (data == 2) {
            $("#ruan_18").attr("disabled", "disabled");
            $("#ruan_next").attr("disabled", "disabled");
            $("#ruan_huan").attr("disabled", "disabled");
            $("#ruan_song").attr("disabled", "disabled");
        }
        if (data == 3) {
            $("#ruan_next").attr("disabled", "disabled");
            $("#ruan_huan").attr("disabled", "disabled");
            $("#ruan_song").attr("disabled", "disabled");
        }
        if (data == 4) {
            $("#ruan_9").attr("disabled", "disabled");
            $("#ruan_12").attr("disabled", "disabled");
            $("#ruan_18").attr("disabled", "disabled");
            $("#ruan_huan").attr("disabled", "disabled");
            $("#ruan_song").attr("disabled", "disabled");
        }
        if (data == 5) {
            $("#ruan_9").attr("disabled", "disabled");
            $("#ruan_12").attr("disabled", "disabled");
            $("#ruan_18").attr("disabled", "disabled");
            $("#ruan_next").attr("disabled", "disabled");
            $("#ruan_song").attr("disabled", "disabled");
        }
        if (data == 6) {
            $("#ruan_9").attr("disabled", "disabled");
            $("#ruan_12").attr("disabled", "disabled");
            $("#ruan_18").attr("disabled", "disabled");
            $("#ruan_huan").attr("disabled", "disabled");
            $("#ruan_next").attr("disabled", "disabled");
        }
        if (adviseDoTimeType == 1) {
            $("#ruan_9").prop("checked", true);
        }
        if (adviseDoTimeType == 2) {
            $("#ruan_12").prop("checked", true);
        }
        if (adviseDoTimeType == 3) {
            $("#ruan_18").prop("checked", true);
        }
        if (adviseDoTimeType == 4) {
            $("#ruan_next").prop("checked", true);
        }
        if (adviseDoTimeType == 5) {
            $("#ruan_huan").prop("checked", true);
        }
        if (adviseDoTimeType == 6) {
            $("#ruan_song").prop("checked", true);
        }

    }

    function Other_matters() {

        if ($("#others").is(":checked")) {
            $('#hoReasonOther').removeAttr("disabled");
        } else {
            $("#hoReasonOther").attr("disabled", "disabled");
            $("#hoReasonOther").val("");
        }


    }

    var adviseDoTime = "";

    function update_pnsn_input(id) {   //点击开放PN和SN的输入框
        // $('.pn_sn_input input').removeAttr('disabled');
        adviseDoTime = id;
    }

    function update_pnsn_cols(id) {   //点击开放PN和SN的输入框
        // $('.pn_sn_input input').attr('disabled', "disabled");

        adviseDoTime = id;
    }

    function input_checkbox(val) {
        let name_bal = "";
        $.each($(val + ' input:checkbox:checked'), function () {
            if (name_bal.length > 0) {
                name_bal += ",";
            }
            name_bal += $(this).val();
        });
        return name_bal;
    }
    function submit_nrc() {
        ajax_data.hoReason = input_checkbox("#hoReason");
        if ($("#others").is(":checked")) {
            if ($("#hoReasonOther").val() == "") {
                alert("选择其他后，原因必填！");
                return
            }
        }
        ajax_data.hoReasonOther = $("#hoReasonOther").val();
        if (adviseDoTime != "") {
            ajax_data.adviseDoTimeType = adviseDoTime;
        }

        if (ajax_data.processStatus == "EDITING") {
            if ($("#delayReason").val() == "") {
                alert("延期原因及措施必填写！");
                return
            }
            ajax_data.delayReason = $("#delayReason").val();
        }
        if (ajax_data.processStatus != "EDITING" && ajax_data.processStatus != "ACTIVE") {
            if ($("#reason").val() == "") {
                alert("审批意见必填写！");
                return
            }
            ajax_data.reason = $("#reason").val();
        }


        $.ajax({
            type: "POST",
            url: "/api/v1/nrc/delay/submit_delay",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(ajax_data),
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    alert("提交成功");
                    parent && parent.window.colsa_window && parent.window.colsa_window();
                    window.close();
                } else {
                    if (data.msgData) {
                        alert(data.msgData)
                    } else {
                        alert(data.msg)
                    }
                }
                // parent.window.colsa_window();
            },
            error: function () {
                window.alert("失败！");
            }
        });
    }

    function fh_fc_daye(data) {
        var ind = 0;
        if (data == "fh") {
            ind = ajax_data.suspending.fh;
        }
        if (data == "fc") {
            ind = ajax_data.suspending.fc;
        }
        if (data == "days") {
            ind = ajax_data.suspending.days;
        }
        if ($("#" + data).val() == "") {
            $("#" + data).val(ind);
            return
        }
        if ($("#" + data).val() > ind || $("#" + data).val() == 0) {
            $("#" + data).val(ind);
        } else {
            if (data == "fh") {
                ajax_data.fh = parseInt($("#" + data).val());
            }
            if (data == "fc") {
                ajax_data.fc = parseInt($("#" + data).val());
            }
            if (data == "days") {
                ajax_data.days = parseInt($("#" + data).val());
            }
        }
    }

    function bohui_nrc() {
        if ($("#reason").val() == "") {
            return alert("审批意见必填写！");
        }
        ajax_data.reason = $("#reason").val();

        $.ajax({
            type: "POST",
            url: "/api/v1/nrc/delay/reject_delay",
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify({
                id: ajax_data.id,
                reason: ajax_data.reason
            }),
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    alert("驳回成功");
                    parent && parent.window.colsa_window && parent.window.colsa_window();
                    window.close();
                } else {
                    if (data.msgData) {
                        alert(data.msgData)
                    } else {
                        alert(data.msg)
                    }
                }
                // parent.window.colsa_window();
            },
            error: function () {
                window.alert("失败！");
            }
        });
    }

    function nrc_see() {
        if ($(window).width() < 1100) {
            var curWidth = ($(window).width()).toString();
            var curheight = $(window).height().toString();
        } else {
            var curWidth = ($(window).width() * 0.6).toString();
            var curheight = $(window).height().toString();
        }
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: "",
            param: {nrcid: $("#nrcId").textbox("getValue"), unCurAssignee: "see",},
            url: "/views/nrc/see_nrc.shtml"
        });
    }
</script>
</html>