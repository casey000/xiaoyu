<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->
    <meta charset="UTF-8">
    <title>附件上传</title>
    <style type="text/css">
        .size_color {
            color: red;
            margin-top: 15px;
            margin-left: 10px;
            font-size: 13px;
        }

        .upload_anttu {
            float: right;
            background-color: #2465a8;
            color: #fff;
            text-align: center;
            padding: 5px 20px;
            margin-right: 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .caozuo {
            margin-top: 20px;
            margin-left: 10px;
        }

        .file_content {
            margin-top: 20px;
            margin-left: 10px;
            width: calc(100% - 20px);
            height: 280px;
            border: 1px solid #ccc;
        }

        .button_a {
            display: inline-block;
            cursor: pointer;
            background: #2465a8;
            color: #fff;
            border-radius: 4px;
            padding: 5px 20px;
            border: none;
            font-size: 14px;
            margin-right: 12px;
        }

        .button_div {
            text-align: center;
            margin-top: 10px;
        }

        .jianhao {
            width: 20px;
            height: 20px;
            cursor: pointer;
            margin-right: 10px;
            float: right;
        }

        .file_tr {
            height: 25px;
            width: 98%;
            margin: 0 auto;
            border-bottom: 1px solid #ccc;
            padding-top: 5px;
        }

        .file_tr:hover {
            background-color: #cccccc87;
        }

        .file_tr span {
            font-size: 14px;
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div class="size_color">温馨提示：上传文件的最大尺寸为100MB</div>
<div class="size_color">上传文件支持类型：</div>
<div class="size_color">DOCX|DOC|PPTX|XLSX|XLS|TXT|SQL|LOG|PDF|BMP|GIF|JPG|PNG|RAR|ZIP|MSG|XLSM</div>
<div class="caozuo">
    <input id="all_file" onclick="all_file_che()" type="checkbox"><label for="all_file">全选</label>
    <!--<input class="textbox easyui-validatebox" data-options="required:true"  name="file"-->
    <!--onchange="atta_input_flie('file_input')" size="300" style="display:none;" type="file"/>-->
    <input id="file_input" onchange="atta_input_flie('file_input')" style="display: none" type="file">
    <div class="upload_anttu" onclick="file_upload_div()">上传</div>
</div>
<div class="file_content" id="file_div_content">

</div>
<div class="button_div">
    <a class="button_a" onclick="file_sure()">确定</a>
    <!--    <a class="button_a">取消</a>-->
</div>
</body>
<script src="/js/plugins/ajaxfileupload/ajaxfileupload.js" type="text/javascript"></script>
<script src="../../../js/datagrid_utils.js" type="text/javascript"></script>

<script>
    function file_upload_div() {
        $("#file_input").trigger("click");
    }

    var params = getParentParam_();
    console.info(params,'params');
    var file_obj = [];
    var fileid_obj = [];
    function atta_input_flie(id) {
        var files = document.getElementById(id);
        var formData = new FormData();
        let url =  "/api/v1/file/upload";
        formData.append("file", files.files[0]);
        if(params.params == 'action'){
            formData.append("fileCategory",'action');
        }
        $.ajax({
            type: "POST",
            url:url,
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
                if (data.code == 200) {
                    file_obj.push(data.data);
                    fileid_obj.push(data.data.fileId);
                    let file = "<div class=\"file_tr\" id=\"file_tr" + data.data.fileId + "\">\n" +
                        "    <input type='checkbox' id=\"file_input" + data.data.fileId + "\" class='file_input' name='file_input_name'>    <label for=\"file_input" + data.data.fileId + "\">" + data.data.fileName + "</label>\n" +
                        "        <div class=\"jianhao icon-delete\" onclick=\"file_content_datale(file_tr" + data.data.fileId + ")\"></div>\n" +
                        "    </div> ";
                    let html_row = $(file);
                    $("#file_div_content").append(html_row);
                } else {
                    alert(data.msgData[0]);
                }
            },
            error: function (data) {
                alert("上传失败！");
            }
        });

    }

    function file_content_datale(id) {
        let inde = id.id.substring(7);
        $.ajax({
            type: "POST",
            url: "/api/v1/file/delete/" + inde,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    alert("删除成功！");
                    $("#" + id.id).remove();
                } else {
                    alert(data.msgData[0]);
                }


            },
            error: function () {
                window.alert("删除失败！");
            }
        });
        // deleteFile( jdata.data[ind].PKID );
    }

    function file_sure() {
        let obj = {
            file_obj: [],
            fileid_obj: [],
        };
        if ($("#all_file").is(":checked")) {
            obj.file_obj = file_obj;
            obj.fileid_obj = fileid_obj;
        } else {
            $("input:checkbox[name=file_input_name]:checked").each(function () {
                let inde = $(this)[0].id.substring(10);
                for (let i in file_obj) {
                    if (file_obj[i].fileId == inde) {
                        obj.file_obj.push(file_obj[i]);
                        obj.fileid_obj.push(inde);
                    }
                }
            });
        }

        params.success(obj);
        window.close();
    }

    function all_file_che() {
        if ($("#all_file").is(":checked")) {
            $(".file_input").prop("checked", true);
        } else {
            $(".file_input").prop("checked", false);
        }
    }

</script>
</html>