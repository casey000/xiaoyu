<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <meta charset="UTF-8">
    <title>flb_summary_list</title>
    <link href="/css/common_new.css" rel="stylesheet" type="text/css"/>
    <link href="/css/jquery-ui-1.8.2.custom.css" rel="stylesheet" type="text/css"/>
    <link href="/css/ui.jqgrid.css" rel="stylesheet" type="text/css"/>
    <link href="/css/common_new.css" rel="stylesheet" type="text/css"/>
    <link href="/css/common_from_me.css" rel="stylesheet" type="text/css"/>
    <link href="/css/dialog_default.css" rel="stylesheet" type="text/css"/>
    <link href="/css/easyui.css" rel="stylesheet" type="text/css"/>
    <link href="/js/jquery/ztree/zTreeStyle.css" rel="stylesheet" type="text/css"/>
    <!-- <link rel="stylesheet" type="text/css" href="/css/easyui/gray/easyui.css"/> -->
    <link href="/css/common_qc.css" rel="stylesheet" type="text/css"/>
    <link href="/js/jquery/jquery-ui-multiselect/jquery.multiselect.css" rel="stylesheet" type="text/css"/>


    <script src="/js/global_var.js"></script>

    <script src="/js/jquery/easyui/jquery-1.8.0.min.js" type="text/javascript"></script>

    <!-- multiSelect -->
    <script src="/js/jquery-ui-1.8.16.custom.min.js" type="text/javascript"></script>
    <script src="/js/jquery/jquery-ui-multiselect/src/jquery.multiselect.js" type="text/javascript"></script>

    <!-- easy UI -->
    <script src="/js/jquery/easyui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="/js/jquery/easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>

    <!-- Ztree 使用了tree类型的查询条件定义则需要引入此js -->
    <script src="/js/jquery/ztree/jquery.ztree.core-3.4.js" type="text/javascript"></script>
    <script src="/js/jquery/ztree/jquery.ztree.excheck-3.4.js" type="text/javascript"></script>

    <!-- jqGrid-->
    <script src="/js/jquery/jqGrid/jquery.jqGrid.min.js" type="text/javascript"></script>
    <script src="/js/jquery/jqGrid/i18n/grid.locale-cn.js" type="text/javascript"></script>

    <script src="/js/jquery/lhgdialog/lhgdialog.js" type="text/javascript"></script>

    <script src="/js/sfa-query-1.0.js" type="text/javascript"></script>
    <script src="/js/date_utils_from_me.js" type="text/javascript"></script>
    <script src="/js/sfa-executor.js" type="text/javascript"></script>
    <script src="/js/sfa-export.js" type="text/javascript"></script>


    <script src="../../../js/datagrid_utils.js" type="text/javascript"></script>
</head>

<body>
<div id="qc_box"></div>
<div class="list_btn_row_s qc_template" id="qc_template_box"></div>
<div class="qc_advance" id="qc_advance_box"></div>

<div class="list_btn_row">
    <ul>
        <li class="right_button">
            <input class="btn" id="nrc_suspending_btn" onclick="reload_()" type="button" value="NRC Delay"/>
        </li>
        <li class="right_button">
            <input class="btn" id="export_btn" type="button" value="Export"/>
        </li>
    </ul>
</div>

<div class="listbox">
    <div class="gridbox">
        <div class="grid_tab">
            <table id="common_list_grid"></table>
            <div id="gridPager"></div>
        </div>
    </div>
</div>
<div class="listbox">
    <div class="gridbox">
        <div class="grid_tab">
            <table id="common_list_grid1"></table>
            <div id="gridPager1"></div>
        </div>
    </div>
</div>
</body>
<script type="application/javascript">
    $(function () {
        var options = {
            view: 'V_NRC_MONITOR',
            // 初始化查询参数
            defaultParam: {
                'qname': ['runType'],
                'qoperator': ['equals'],
                'qvalue': ['0']
            },
            qcOptions: {
                qcBoxId: 'qc_box'
            },
            gridOptions: {
                gridId: 'common_list_grid',
                allColModels: {
                    'assign': {
                        name: 'Assign',
                        hidden: true
                    },
                    'timeLimitType': {
                        formatter: "select",
                        editoptions: {
                            value: {1: "硬时限", 2: "软时限"}
                        },
                        /*
                         * 配置列表导出Format
                         *  formatType： map | merge
                         *  pattern : {}
                       */
                        formatType: 'map',
                        pattern: {
                            // "y":"<font style='color:green'>在位</font>", //允许添加样式进行填充
                            1: "硬时限",
                            2: "软时限",
                            "": ""
                        }
                    },
                    'postSap': {
                        formatter: "select",
                        editoptions: {
                            value: {"send": "已推送", "unsend": "未发送", "back": "退回"}
                        },
                        formatType: 'map',
                        pattern: {
                            "send": "已推送",
                            "unsend": "未发送",
                            "back": "退回",
                            "": ""
                        }
                    },
                    'isIssued': {
                        formatter: "select",
                        editoptions: {
                            value: {"y": "已下发", "n": "未下发"}
                        },
                        formatType: 'map',
                        pattern: {
                            "y": "已下发",
                            "n": "未下发",
                            "": "未下发"
                        }
                    },
                },
                jqGridSettings: {
                    multiselect: true,
                    autowidth: false,
                    width: 1078
                },
                optsFirst: true
            }
        };

        $(document).sfaQuery(options);

        // 导出
        $("#export_btn").click(function () {
            export_self();
        });


    });



    function reload_() {
        //获得NRC的ID
        let nodes = $(".ui-state-highlight");
        if (nodes.length !== 1) {
            return window.alert("请选择一条NRC！");
        }
        let rowDataId = $(nodes).attr("id");
        let rowData = $(document).sfaQuery().queryGrid.jqGrid.getRowData(rowDataId);
        let nrcId = rowData.cardId;
        if (rowData.cardType != "NRC") {
            return window.alert("请选择类型为NRC的数据！");
        }
        //含网页信息就这样
        let nrcNo = $(rowData.nrcNo).text();

        $.ajax({
            type: "GET",
            url: "/api/v1/nrc/delay/get_delay_by_nrc_id?nrcId=" + nrcId,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    //结合状态，当登录用户与操作用户不一致，且不为EDITING和ACTIVE状态，给出提示
                    let curAssignee = data.data.curAssignee;
                    let processStatus = data.data.processStatus;
                    if (curAssignee == null && processStatus !== 'EDITING' && processStatus !== 'ACTIVE') {
                        alert("当前用户无权限操作");
                    } else if (curAssignee != null && curAssignee !== loginInfo.accountId) {
                        alert("当前用户无权限操作");
                    } else {
                        //弹出NRC延期窗口
                        var curWidth = ($(window).width() * 0.6).toString();
                        var curheight = $(window).height().toString();
                        ShowWindowIframe({
                            width: curWidth,
                            height: curheight,
                            title: "NRC延期申请",
                            param: {delay: data},
                            url: "/views/nrc/nrc_delay.shtml"
                        });
                    }
                } else {
                    if (data.msgData && data.msgData[0]) {
                        alert(data.msgData[0]);
                    } else {
                        alert(data.msg);
                    }
                }

            },
            error: function () {
                alert("失败！");
                parent && parent.window.colsa_window && parent.window.colsa_window();
                window.close();
            }
        });
    }
</script>
</html>