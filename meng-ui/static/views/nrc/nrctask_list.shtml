<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <meta charset="UTF-8">
    <title>nrc task list</title>
    <link href="/css/common_new.css" rel="stylesheet" type="text/css"/>
    <link href="/css/jquery-ui-1.8.2.custom.css" rel="stylesheet" type="text/css"/>
    <link href="/css/ui.jqgrid.css" rel="stylesheet" type="text/css"/>
    <link href="/css/common_new.css" rel="stylesheet" type="text/css"/>
    <link href="/css/common_from_me.css" rel="stylesheet" type="text/css"/>
    <link href="/css/dialog_default.css" rel="stylesheet" type="text/css"/>
    <link href="/css/easyui.css" rel="stylesheet" type="text/css"/>
    <link href="/js/jquery/ztree/zTreeStyle.css" rel="stylesheet" type="text/css"/>
    <!-- <link rel="stylesheet" type="text/css" href="/css/easyui/gray/easyui.css"/> -->
    <link href="/css/common_qc.css" rel="stylesheet" type="text/css"/>
    <link href="/js/jquery/jquery-ui-multiselect/jquery.multiselect.css" rel="stylesheet" type="text/css"/>


    <script src="/js/global_var.js"></script>

    <script src="/js/jquery/easyui/jquery-1.8.0.min.js" type="text/javascript"></script>

    <!-- multiSelect -->
    <script src="/js/jquery-ui-1.8.16.custom.min.js" type="text/javascript"></script>
    <script src="/js/jquery/jquery-ui-multiselect/src/jquery.multiselect.js" type="text/javascript"></script>

    <!-- easy UI -->
    <script src="/js/jquery/easyui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="/js/jquery/easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>

    <!-- Ztree 使用了tree类型的查询条件定义则需要引入此js -->
    <script src="/js/jquery/ztree/jquery.ztree.core-3.4.js" type="text/javascript"></script>
    <script src="/js/jquery/ztree/jquery.ztree.excheck-3.4.js" type="text/javascript"></script>

    <!-- jqGrid-->
    <script src="/js/jquery/jqGrid/jquery.jqGrid.min.js" type="text/javascript"></script>
    <script src="/js/jquery/jqGrid/i18n/grid.locale-cn.js" type="text/javascript"></script>

    <script src="/js/jquery/lhgdialog/lhgdialog.js" type="text/javascript"></script>

    <script src="/js/sfa-query-1.0.js" type="text/javascript"></script>
    <script src="/js/date_utils_from_me.js" type="text/javascript"></script>
    <script src="/js/sfa-executor.js" type="text/javascript"></script>
    <script src="/js/sfa-export.js" type="text/javascript"></script>


    <script src="../../../js/datagrid_utils.js" type="text/javascript"></script>
</head>

<body>
<div id="qc_box"></div>
<div class="list_btn_row_s qc_template" id="qc_template_box"></div>
<div class="qc_advance" id="qc_advance_box"></div>
<div class="list_btn_row">
    <!--<ul>-->

    <!--<li class="right_button"><input type="button" id="export_btn" value="Export" class="btn" /></li>-->

    <!--<li class="right_button"><input type="button" id="import_btn" value="Import" class="btn" /></li>-->


    <!--<li class="right_button"><input type="button" class="btn" value="Batch ExcDate" id="batch_update_exec_date" /></li>-->
    <!---->
    <!--<li class="right_button"><input type="button" id="add_btn" value="Add" class="btn"/></li>-->

    <!--</ul> -->
</div>
<div class="listbox">
    <div class="gridbox">
        <div class="grid_tab">
            <table id="common_list_grid"></table>
            <div id="gridPager"></div>
        </div>
    </div>
</div>
</body>
<script type="application/javascript">
    $(function () {
        var optsCols = [];
        optsCols.push("edit");
        optsCols.push("del");
        var permissionMap = {
            view: false,
            mrview: false,
            remark: false
        };
        var options = {
            view: "V_NRC_TASK_BASE",
            qcOptions: {
                qcBoxId: "qc_box"
            },
            gridOptions: {
                gridId: "common_list_grid",
                allColModels: {
                    "edit": {
                        name: 'E',
                        colNameEn: 'E',
                        isOpts: true,
                        width: 25,
                        formatter: function (cellValue, options, rowObj) {
                            if (rowObj.status == "EDITING") {
                                var ele = '<div id="rowData_' + rowObj.id + '" class="ui-corner-all clever-jqgrid-action clever-jqgrid-edit edit icon-edit" title="Edit"></div>';
                                $('#rowData_' + rowObj.id).live('click', function () {
                                    nrctask_edit(rowObj.nrcId, rowObj);
                                });
                                return ele;
                            } else {
                                return "";
                            }


                        }
                    },
                    "nrcTaskNo": {

                        formatter: function (cellValue, options, rowObj) {
                            var ele = '<span id="nrctaskno_' + rowObj.id + '"  style="cursor: pointer;color: #f60; ">' + (cellValue == null ? "" : cellValue) + '-R' + rowObj.revNo + '</span>';
                            $('#nrctaskno_' + rowObj.id).live('click', function () {
                                view(rowObj);
                            });
                            return ele;
                        }
                    },
                    "nrcNo": {
                        formatter: function (cellValue, options, rowObj) {
                            var ele = '<span id="nrcno_' + rowObj.id + '"  style="cursor: pointer;color: #f60; ">' + (cellValue == null ? "" : cellValue) + '</span>';
                            $('#nrcno_' + rowObj.id).live('click', function () {
                                viewNrc(rowObj);
                            });
                            return ele;
                        }
                    },
                    "mrMrp": {
                        formatter: formatMrMrp
                    },

                    "del": {
                        colNameEn: "D",
                        isOpts: true,
                        width: 25,
                        formatter: formatDelete
                    }
                },
                jqGridSettings: {
                    height: 500,
                    multiselect: true
                },
                optsFirst: true,
                optsCols: optsCols
            }
        };
        $(document).sfaQuery(options);


    });






    function formatMrMrp(cellValue, options, rowObject) {
        var str = "";
        var status = rowObject.status;

        if (status == "ACTIVE") {
            if (rowObject.mrNo != null) {
                var mrNos = rowObject.mrNo;
                var arr = mrNos.split(',');
                for (var i = 0; i < arr.length; i++) {
                    var mrNo = arr[i];
                    if (mrNo) {

                        var link = '<a href="#" style="color:#f60" title="View MR" '
                            + " onclick='viewMr(this,event,\""
                            + mrNo
                            + "\");'>" + mrNo + "</a><br/>";
                        str += link;
                    }
                }
            } else {
                var mrpNo = rowObject.mrpNo == null ? "" : rowObject.mrpNo;
                return '<a href="#" style="color:#f60" title="View MR" '
                    + " onclick='viewMrp(this,event,\""
                    + mrpNo
                    + "\");'>" + mrpNo + "</a><br/>";
            }
        }
        return str;
    }

    //查看
    function view(event) {

        var curWidth = ($(window).width() * 0.6).toString();
        var curheight = ($(window).height() * 0.6).toString();
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: "",
            param: {

                taskid: event.id,
                type: "view"
            },
            url: "/views/nrc/task_revision.shtml"
        });
    }

    function Refresh() {
        $(".qc_btn_srh").click();
    }

    //查看
    function viewNrc(obj) {
        if ($(window).width() < 1100) {
            var curWidth = ($(window).width()).toString();
            var curheight = $(window).height().toString();
        } else {
            var curWidth = ($(window).width() * 0.6).toString();
            var curheight = $(window).height().toString();
        }

        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: "",
            param: {nrcid: obj.nrcId, unCurAssignee: "see"},
            url: "/views/nrc/see_nrc.shtml"
        });

    }

    //MR
    function viewMr(obj, event, mrNo) {
        // var curWidth = ($(window).width() * 0.6).toString();
        // var curheight = ($(window).height() * 0.6).toString();
        // ShowWindowIframe({
        //     width: curWidth,
        //     height: curheight,
        //     title: "",
        //     param: {
        //         nrcid: event.nrcId,
        //         acid: "",
        //         nrcno: event.nrcNo,
        //         aceng:event.acEng,
        //         aeType: 9,
        //         taskid:event.id,
        //         type:"vi"
        //     },
        //     url: "/views/nrc/nrc_task.shtml"
        // });
    }

    // 查看Mrp
    function viewMrp(obj, event, mrpNo) {
        /*
        mrpNo = $.trim(mrpNo);
        var url = basePath + '/mr/mrp_view.action?mrNo=' + mrpNo;
        P.$.dialog({
            title: 'View Material Requires Plan',
            width: '1000px',
            height: '500px',
            top: '20%',
            esc: true,
            cache: false,
            max: false,
            min: false,
            parent: this,
            content: 'url:' + url,
            data: {
                edit: false,
                send: false,
                cancel: false
            }
        });
         */
    }

    //编辑
    function nrctask_edit(id, event) {
        console.log(event);
        var curWidth = ($(window).width() * 0.6).toString();
        var curheight = ($(window).height() * 0.6).toString();
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: "",
            param: {
                taskid: event.id,
                type: "edit"
            },
            url: "/views/nrc/task_revision.shtml"
        });
    }

    //删除
    function del(obj, event, id) {
        if (confirm("确定刪除吗")) {
            $.ajax({
                type: "POST",
                url: "/api/v1/tbm/nrc/nrcTask/delete_nrc_task_by_id",
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify({
                    "id": id,
                    "reason": ""
                }),
                dataType: "json",
                success: function (data) {
                    if (data.code == 200) {
                        alert("删除成功！");
                        Refresh();
                    } else {
                        alert(data.msgData[0]);
                }


                },
                error: function () {
                    window.alert("删除失败！");
                }
        });
        }
    }

    function Refresh() {
        $(".qc_btn_srh").click();
    }

    function formatEdit(cellValue, options, rowObject) {
        if (rowObject.status == 'EDITING') {
            return '<div class="ui-corner-all clever-jqgrid-action clever-jqgrid-edit edit" title="Edit" onclick="edit(this,event,'
                + rowObject.id + ');"><span class="ui-icon ui-icon-pencil"></span></div>';
        } else {
            return "";
        }
    }

    function formatDelete(cellValue, options, rowObject) {
        if (rowObject.status == 'EDITING') {
            return '<div class="ui-corner-all clever-jqgrid-action clever-jqgrid-edit edit" title="Delete" onclick="del(this,event,'
                + rowObject.id + ');"><span class="ui-icon ui-icon-close"></span></div>';
        } else {
            return "";
        }
    }


</script>
</html>