<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title data-i18n="page:PAGE.SYSUSER.PAGE_TITLE">用户管理</title>
    <script type="text/javascript">

        $(function () {
            $("#userName").MyComboGrid({
                idField: 'USER_NAME',//'PKID',  //实际选择值
                textField: 'REAL_NAME', //文本显示值
                width: 180,
                url: Constant.API_V1_URL + 'sysuser/list',
                columns: [[
                    {field: 'PKID', title: '编号', width: 80},
                    {field: 'USER_NAME', title: '用户账号', width: 120},
                    {field: 'REAL_NAME', title: '用户名称', width: 120}
                ]]
            });

            InitFuncCodeRequest_({
                data: {
                    /** 设置对应的数据域*/
                    domainCode: "USER_ORGAN",
                    FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
                },
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        $('#org').combobox({
                            panelHeight: '150px',
                            data: jdata.data.USER_ORGAN,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                        });
                    }
                }
            });
        });
    </script>
</head>
<body class="ibody">
<fieldset class="fieldset_eui">
    <legend data-i18n="common:COMMON_OPERATION.SEARCH">搜索</legend>
    <form id="ffSearch" method="post">
        <div id="searchBar">
            <table cellspacing="0" cellpadding="2" class="table table-bordered table-info">
                <tr>
                    <th data-i18n="page:PAGE.SYSUSER.QY_USER_NAME">用户姓名：</th>
                    <td style="width:110px">
                        <input class="easyui-textbox" name="userName" id="userName"/>
                    </td>
                    <th data-i18n="">部门：</th>
                    <td style="width:110px">
                        <input class="easyui-textbox" name="org" id="org"/>
                    </td>
                    <td colspan="2">
                        &nbsp;&nbsp;
                        <a href="javascript:void(0)" class="searchBtn" auth="WS_USER_QUERY" onclick="onSearch_()"><span
                                data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>&nbsp;&nbsp;
                        <a href="javascript:void(0)" class="clearBtn" auth="WS_USER_QUERY" onclick="onClear_()"><span
                                data-i18n="common:COMMON_OPERATION.RESET">重置</span></a>&nbsp;&nbsp;
                        <a href="javascript:void(0)" class="addBtn" auth="WS_USER_QUERY"
                           onclick="helpQuery('dg01', 'SYS_USER_LIST');"><span>高级查询</span></a>&nbsp;&nbsp;
                        <a href="javascript:void(0)" class="excelBtn" auth="WS_USER_EXPORT"
                           onclick="excelExport('dg01','用户列表');"><span>导出Excel</span></a>
                    </td>
                </tr>
            </table>
        </div>
    </form>
</fieldset>
<table id="dg"></table>

<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var identity = 'dg01';

    function i18nCallBack() {
        InitDataGrid();
    }

    function InitDataGrid() {
        $("#dg").MyDataGrid({
            identity: identity,
            //title: $.i18n.t('page:PAGE.SYSUSER.PAGE_TITLE'),
            firstLoad: true,
            url: Constant.API_V1_URL + 'sysuser/list',
            columns: {
                param: {FunctionCode: 'SYS_USER_LIST'},
                alter: {
                    PKID: {nfield: 'U.PKID'}
                }
            },
            contextMenus: [
                {
                    id: "m-edit", i18nText: "common:COMMON_OPERATION.EDIT", auth: "WS_USER_EDIT", /*USER_EDIT*/
                    onclick: function () {
                        var ACC_PKID = $('#dg').datagrid('getSelected').ACC_PKID;
                        common_add_edit_({
                            identity: identity, isEdit: 1, width: 700, height: 380, param: {ACC_PKID: ACC_PKID},
                            url: "/views/sysuser/sysuser_add_edit.shtml"
                        });
                    }
                }/*,
                {id: "m-edit", i18nText : "common:COMMON_OPERATION.ACCOUNTINFO", auth:"WS_USER_ACCOUNTINFO",/!*USER_EDIT*!/
                    onclick: function(){
                        var ACC_PKID = $('#dg').datagrid('getSelected').ACC_PKID;
                        common_add_edit_({
                            identity: identity, isEdit: 1, width: 700, height : 340,param:{ACC_PKID:ACC_PKID},
                            url: "/views/sysuser/sysuser_account.shtml"
                        });
                    }
                }*/
                , {
                    id: "m-delete", i18nText: "common:COMMON_OPERATION.DEL", auth: "WS_USER_DELTE", /*USER_DEL*/
                    onclick: function () {
                        common_delete_({
                            identity: identity,
                            cfmI18next: "msg_err:ERRMSG.COMMON.DEL_CONFIRM",
                            param: {pkid: "PKID"},
                            FunctionCode: "USER_DELETE"
                        });
                    }
                }, {
                    id: "m-resetPwd",
                    i18nText: "common:RES.SYS_USER_LIST.RESET_PWD",
                    auth: "WS_USER_RESET_PWD", /*USER_RESET_PWD*/
                    onclick: function () {
                        resetPwd_();
                    }
                },
                {
                    id: "m-modifyPwd",
                    i18nText: "common:RES.SYS_USER_LIST.MODIFY_PWD",
                    auth: "WS_USER_MODIFY_PWD", /*USER_MODIFY_PWD*/
                    onclick: function () {
                        modifyPwd_();
                    }
                }/*,
                {i18nText : "测试发消息", auth:"",
                    onclick: function(){
                        var ACC_PKID = $('#dg').datagrid('getSelected').ACC_PKID;
                        AjaxCall_(Constant.API_V1_URL + "sysuser/testmessage", {accId: ACC_PKID, type: 'warn'}, function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                layer.msg(jdata.msg, {icon: 1});
                            } else {
                                layer.msg(jdata.msg, {icon: 5});
                            }
                        });
                    }
                }*/
            ],
            validAuth: function (row, items) {
                if (row.ACC_PKID == "1") {
                    items['common:COMMON_OPERATION.EDIT'].enable = false;
                    items['common:COMMON_OPERATION.DEL'].enable = false;
                }
                var accountId = getLoginInfo().accountId;
                var accountType = getLoginInfo().accountType;
                var userId = getLoginInfo().userId;
                if (accountId != "1") {
                    items['common:RES.SYS_USER_LIST.RESET_PWD'].display = false;
                }
                if (accountId != "1" && row.ACC_PKID != accountId) {
                    items['common:RES.SYS_USER_LIST.MODIFY_PWD'].display = false;
                }
                return items;
            },
            toolbar: [
                {
                    key: "COMMON_ADD", text: $.i18n.t('common:COMMON_OPERATION.ADD'), auth: "WS_USER_ADD",
                    handler: function () {
                        common_add_edit_({
                            identity: identity, isEdit: 0, width: 650, height: 380, /*param: {PKID : '1'},*/
                            url: "/views/sysuser/sysuser_add_edit.shtml"
                        });
                    }
                }, '-',
                {
                    key: "COMMON_RELOAD", text: $.i18n.t('common:COMMON_OPERATION.RELOAD'),
                    handler: function () {
                        common_reload_({identity: identity});
                    }
                }
            ]
        });
    }

    /** 刷新列表数据 */
    function reload_() {
        $("#dg").datagrid("reload");
    }

    /** 重置密码 */
    function resetPwd_() {
        layerConfirm_({
            content: $.i18n.t("RES.SYS_USER_LIST.RESET_PWD_CONFIRM"),
            yesFunc: function (index) {
                var rowData = $("#dg").datagrid('getSelected');
                if (!rowData) {
                    layer.msg($.i18n.t('msg_err:ERRMSG.NO_SELECT_ROW_ERROR'), {icon: 5});
                    return;
                }
                AjaxCall_(Constant.API_V1_URL + "sysuser/resetPwd", {pkid: rowData.PKID}, function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        layer.msg(jdata.msg, {icon: 1});
                    } else {
                        layer.msg(jdata.msg, {icon: 5});
                    }
                });
            }
        });
    }

    /** 修改密码 */
    function modifyPwd_() {
        var rowData = $("#dg").datagrid('getSelected');
        if (!rowData) {
            layer.msg($.i18n.t('msg_err:ERRMSG.NO_SELECT_ROW_ERROR'), {icon: 5});
            return;
        }
        ShowWindowIframe({
            width: 600, height: 280,
            title: "修改密码[" + rowData.REAL_NAME + "]",
            param: {pkid: rowData.PKID},
            url: "/views/sysuser/sysuser_modify_pwd.shtml"
        });
    }
</script>


</body>
</html>