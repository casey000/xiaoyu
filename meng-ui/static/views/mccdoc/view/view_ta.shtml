<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <title>TA view</title>
    <link href="/css/easyui/gray/easyui.css" rel="stylesheet" type="text/css"/>
    <link href="/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/js/jquery/ztree/zTreeStyle.css" rel="stylesheet" type="text/css"/>
    <link href="/css/jquery-ui-1.8.2.custom.css" rel="stylesheet" type="text/css"/>
    <!-- mcc模块的公用css -->
    <link href="/css/mccdoc/mcc_doc_commons.css" rel="stylesheet" type="text/css"/>


    <!-- load js -->
    <script src="/js/jquery-1.8.0.min.js"></script>
    <script src="/js/json2.js" type="text/JavaScript"></script>
    <script src="/js/jquery/easyui/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script src="/js/global_var.js" type="text/JavaScript"></script>
    <script src="/js/jquery/lhgdialog/lhgdialog.js" type="text/javascript"></script>
    <script src="/js/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="/js/jquery/ztree/jquery.ztree.core-3.4.js" type="text/javascript"></script>
    <script src="/js/jquery/ztree/jquery.ztree.excheck-3.4.js" type="text/javascript"></script>
    <script src="/js/jquery-ui.js"></script>
    <script src="/js/date_utils.js" type="text/javascript"></script>
    <script src="/js/sfa-query-1.0.js" type="text/javascript"></script>
    <script src="/js/jquery.form.js" type="text/javascript"></script>
    <script src="/js/data/ata_utils.js" type="text/javascript"></script>
    <!-- 表单验证jquery.validate -->
    <script src="/js/jquery.validate.js" type="text/javascript"></script>
    <script src="/js/custom-validate.js" type="text/javascript"></script>
    <script src="/js/jquery.maxlength.js" type="text/javascript"></script>

    <!-- TA View专用js -->
    <script src="/js/mccdoc/view/view_ta.js" type="text/javascript"></script>

</head>
<body>
<div align="right" class="ui_buttons">
    <div align="right" id="revision" style="padding-right: 6px;padding-bottom: 4px">
        <c:if test="${revisionable}">
            <shiro:hasPermission name="ta:revision"><input id="new_reversion_btn" type="button" value="New Reversion"/>
            </shiro:hasPermission>
        </c:if>
    </div>
</div>
<form id="addForm">
    <input name="taBaseInfo.id" type="hidden" value="${taBaseInfo.id}"/>
    <table border="1" cellpadding="0" cellspacing="0" class="table-zi" style="padding-top:10px" width="100%">
        <tr>
            <td class="tab_title_background">TA NO:</td>
            <td>${taBaseInfo.number}&nbsp;</td>
            <td class="tab_title_background">Rev.:</td>
            <td>
                <c:if test="${not empty taBaseInfo.revNo}">R${taBaseInfo.revNo}</c:if>
                <c:if test="${empty taBaseInfo.revNo}">R0</c:if>
            </td>
            <td class="tab_title_background">&nbsp;</td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td class="tab_title_background" width="15%">Model:</td>
            <td width="18%">
                ${taBaseInfo.model}
            </td>
            <td class="tab_title_background" width="15%">
                <s:text name="base.aircraft.tail"/>
                :
            </td>
            <td width="20%">
                <input name="taBaseInfo.acId" readonly="readonly" type="hidden" value="${taBaseInfo.acId}"/>
                ${taBaseInfo.acNo}
                <div class="errorMessage"></div>
            </td>
            <td class="tab_title_background" width="15%">ATA:</td>
            <td width="18%">${taBaseInfo.ata}
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="tab_title_background">Subject:</td>
            <td colspan="5">
                <textarea disabled="disabled" name='taBaseInfo.subject' readonly="readonly"
                          style="width:97%;height:100px;">${taBaseInfo.subject}</textarea>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="tab_title_background">Distribution:</td>
            <td colspan="5">&nbsp;
                <input id="distributions" readonly="readonly" type="hidden" value="${taBaseInfo.distribution}"/>
                <input disabled="disabled" name="taBaseInfo.distribution" type="checkbox" value="31"/>&nbsp;<span
                        style="vertical-align: middle;">PPC</span>&nbsp;
                <input disabled="disabled" name="taBaseInfo.distribution" type="checkbox" value="32"/>&nbsp;<span
                        style="vertical-align: middle;">质量</span>&nbsp;
                <input disabled="disabled" name="taBaseInfo.distribution" type="checkbox" value="33"/>&nbsp;<span
                        style="vertical-align: middle;">航材</span>&nbsp;
                <input disabled="disabled" name="taBaseInfo.distribution" type="checkbox" value="34"/>&nbsp;<span
                        style="vertical-align: middle;">MCC</span>&nbsp;
                <input disabled="disabled" name="taBaseInfo.distribution" type="checkbox" value="35"/>&nbsp;<span
                        style="vertical-align: middle;">维修处</span>&nbsp;
                <!-- <input type="checkbox" name="taBaseInfo.distribution" disabled="disabled" value="36" />&nbsp;<span style="vertical-align: middle;">外站</span>&nbsp;  -->
                <input disabled="disabled" name="taBaseInfo.distribution" type="checkbox" value="37"/>&nbsp;<span
                        style="vertical-align: middle;">飞行</span>&nbsp;
                <input disabled="disabled" name="taBaseInfo.distribution" type="checkbox" value="38"/>&nbsp;<span
                        style="vertical-align: middle;">安监</span>&nbsp;
                <%-- <input disabled="disabled" name="taBaseInfo.distribution" type="checkbox" value="39"/>&nbsp;<span
                        style="vertical-align: middle;">飞管</span>&nbsp; --%>
                <input disabled="disabled" name="taBaseInfo.distribution" type="checkbox" value="40"/>&nbsp;<span
                        style="vertical-align: middle;">运标</span>&nbsp;
                <input disabled="disabled" name="taBaseInfo.distribution" type="checkbox" value="41"/>&nbsp;<span
                        style="vertical-align: middle;">运控</span>&nbsp;
                <input disabled="disabled" name="taBaseInfo.distribution" type="checkbox" value="48"/>&nbsp;<span
                        style="vertical-align: middle;">地服</span>&nbsp;
                <div class="errorMessage"></div>
            </td>
        </tr>
    </table>
</form>

<form action="" enctype="multipart/form-data" id="uploadForm" method="post">
    <table border="1" cellpadding="0" cellspacing="0" class="table-zi" style="padding-top:10px; border-top: none;"
           width="100%">
        <tr>
            <td class="tab_title_background" style="border-top:none;">Detail:</td>
            <td style="border-top:none; width: 85%;">
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="qc_table_detail"
                       style="padding-top:10px" width="100%">
                    <tr>
                        <td colspan="5"><input name="upload" style="width: 50%" type="file"/>
                            <span style='float: right; padding-right: 20px'>
					<input onclick="uploadAttachment();return false;" type="submit"
                           value="upload"/>
				</span></td>
                    </tr>
                    <tr id="td_files">
                        <td class="td-line30-with-bg-center">Doc Name</td>
                        <td class="td-line30-with-bg-center">Doc Type</td>
                        <td class="td-line30-with-bg-center">Uploader</td>
                        <td class="td-line30-with-bg-center">Upload Date</td>
                        <td class="td-line30-with-bg-center">Operate</td>
                    </tr>
                </table>
                <div class="errorMessage"></div>
            </td>
        </tr>
    </table>
</form>


<script type="text/javascript">
    var entityId = '${taBaseInfo.id}';
    var moduleForDb = '${attachmentPath}';
    var status = '${taBaseInfo.editStatus}';
    var taskOwnerId = '${param.taskOwnerId}';
    var fileDelAble = false;
    //如果文件不能删除同时禁用上传功能
    if (!fileDelAble) {
        $("#uploadForm table tr td table tr:first").hide();
    }

    var api = frameElement.api, win = api.opener;
    var s_params = api.data;

    if (status == 2 && (!!taskOwnerId) && taskOwnerId == '${userId}') {
        api.button(
            {
                name: 'Check',
                callback: function () {
                    var actionUrl = "/mccdoc/form/check_ta.jsp?id=${taBaseInfo.id}&status=${taBaseInfo.editStatus}";
                    if (!'${taBaseInfo.number}') {
                        actionUrl += '&title=TA task Checking [Tail: ${taBaseInfo.acNo}]'
                    } else {
                        actionUrl += '&title=TA task Checking [TA NO: ${taBaseInfo.number}] R${taBaseInfo.revNo}'
                    }
                    P.$.dialog({
                        id: "checkTaDialog",
                        title: "TA Checking",
                        width: "750px",
                        height: "500px",
                        data: {},
                        parent: this,
                        lock: true,
                        close: function () {
                            api.close();
                        },
                        content: 'url:' + basePath + actionUrl
                    });
                    return false;
                }
            },
            {
                name: 'Process Logs',
                callback: function () {
                    logs();
                    return false;
                }
            },
        < shiro;
    :
        hasPermission;
        name = "ta:pdf" > {
            name: 'View PDF',
            callback: function () {
                api.button({name: 'View PDF', disabled: true});
                window.location.href = basePath + "/mccdoc/ta_management_createPdf.action?taBaseInfo.id=" + $("input[name='taBaseInfo.id']").val();
                setTimeout(function () {
                    api.button({name: 'View PDF', disabled: false});
                }, 2000);
                return false;
            }
        },;
    <
        /shiro:hasPermission>;
        {
            'Close',
                callback;
        :

            function () {
                return true;
            }
        }

    )
    } else {
        api.button(
            {
                name: 'Process Logs',
                callback: function () {
                    logs();
                    return false;
                }
            },
        < shiro;
    :
        hasPermission;
        name = "ta:pdf" > {
            name: 'View PDF',
            callback: function () {
                api.button({name: 'View PDF', disabled: true});
                window.location.href = basePath + "/mccdoc/ta_management_createPdf.action?taBaseInfo.id=" + $("input[name='taBaseInfo.id']").val();
                setTimeout(function () {
                    api.button({name: 'View PDF', disabled: false});
                }, 2000);
                return false;
            }
        },;
    <
        /shiro:hasPermission>;
        {
            'Close',
                callback;
        :

            function () {
                return true;
            }
        }
    )
    }


    function validForm() {

        var text = $(":file").val();

        if (!text) {

            var message = "Please choose a file !";

            P.$.dialog.alert(message);

            return false;
        }

        if (!text) {

            var message = "Please choose a file !";

            P.$.dialog.alert(message);

            return false;
        }
        return true;
    }

    function uploadAttachment(override) {

        $(".error").remove();

        if (!validForm()) {

            return false;
        }

        var params = {

            "entityId": entityId,

            "moduleForPath": moduleForDb,

            "moduleForDb": moduleForDb,

            "jsonData": override,

            'licenType': 'save'
        };

        var actionUrl = basePath + "/er/fileUploadAuxiliary_uploadFile.action";

        $("#uploadForm").ajaxSubmit({

            url: actionUrl,

            dataType: "json",

            data: params,

            cache: false,

            type: "post",

            success: function (obj, textStatus) {
                var data = JSON.parse(obj);

                if (data && data.ajaxResult == "failure") {

                    if (!data.errorIndex[0].type) {

                        P.$.dialog.alert(data.errorIndex[0].text);
                    }
                }

                if (data && data.ajaxResult == "success") {

                    P.$.dialog.success("File uploaded success!");

                    buildAttachment(data.filesObejct, "fileList", $("#td_files"), true);

                } else if (data && data.errorIndex) {

                    var duplicate = false;

                    $.each(data.errorIndex, function (i, n) {

                        var err_div = '<span class="error">' + n.text + '</span>';

                        $($(":file")[n.index]).nextAll(".errorMessage").append(err_div);

                        if (n.type) {

                            duplicate = true;
                        }
                    });

                    if (duplicate) {

                        P.$.dialog.alert("File is exist !");
                    }
                }
            }
        });
    }

    $(function () {

        var actionSelectUrl = basePath + "/er/fileUploadAuxiliary_getAllFile.action";

        var params = {

            "entityId": entityId,

            "reliabilityTaskId": '',

            "moduleForPath": moduleForDb,

            "moduleForDb": moduleForDb,

            'licenType': 'select'
        };
        if (typeof (params.entityId) == "undefined" || (params.entityId + "") == "null" || params.entityId == "") {
            return;
        }

        $.ajax({

            url: actionSelectUrl,

            async: false,

            data: params,

            cache: false,

            type: "post",

            success: function (obj, textStatus) {

                if (obj) {

                    var data = JSON.parse(obj);

                    buildAttachment(data.filesObejct, "fileList", $("#td_files"), fileDelAble);

                    //buildAttachment(data.reliabilityFilesObejct,"reliabilityFileList",$("#reliability_committee_td_files"),false);
                }
            }
        });
    });

    function buildAttachment(_dataObj, divId, appendObj, isDel) {
        var _str = "";
        if (!!_dataObj) {
            $.each(_dataObj, function (i, _value) {
                if (_value && _value.name && _value.type && _value.uploadByName && _value.createDate && _value.id) {
                    _str += '<tr name="' + divId + '">';
                    _str += '  <td  class="td-line30-center">' + _value.name + '</td>';
                    _str += '  <td  class="td-line30-center">' + _value.type + '</td>';
                    _str += '  <td  class="td-line30-center">' + _value.uploadByName + '</td>';
                    _str += '  <td  class="td-line30-center">' + _value.createDate + '</td>';
                    _str += '  <td  class="td-line30-center">';
                    _str += '    <div align="center" class="ui_buttons_upload" style="vertical-align: middle;">';
                    if (!isDel) {
                        _str += '        <input type="button" onclick="download(' + _value.id + ')" value="Download" style="cursor: pointer;" />';
                    }
                    if (isDel) {
                        _str += '    <input type="button" onclick="deleteAttachmentById(' + _value.id + ')" value="Delete" style="cursor: pointer;" />';
                    }
                    _str += '    </div>';
                    _str += '  </td>';
                    _str += '</tr>';
                }
            });
        }
        appendObj.nextAll().remove();
        appendObj.after(_str);
    }

    function deleteAttachmentById(_id) {
        P.$.dialog.confirm("Are you sure to delete?", function () {
            if (!_id) {
                P.$.dialog.alert("Delete Error");
                return false;
            }
            var actionDeleteUrl = basePath + "/er/fileUploadAuxiliary_deleteAttachmentById.action";

            var params = {

                "entityId": entityId,

                "attachmentId": _id,

                "moduleForPath": moduleForDb,

                "moduleForDb": moduleForDb,

                'licenType': 'delete'
            };

            $.ajax({

                url: actionDeleteUrl,

                async: false,

                data: params,

                cache: false,

                type: "post",

                success: function (obj, textStatus) {

                    var data = JSON.parse(obj);

                    buildAttachment(data.filesObejct, "fileList", $("#td_files"), true);
                }
            });
        });

    }

    function download(id) {
        window.location.href = basePath + "/ee/attachment_downloadAndMsg.action?fileId=" + id
    }

    function logs() {
        var _id = ${taBaseInfo.flowInstanceId};
        var url = 'mccdoc/logs.jsp?id=' + _id;
        P.$.dialog({
            title: 'Process Logs',
            width: '650px',
            height: '300px',
            top: '20%',
            esc: true,
            cache: false,
            max: false,
            min: false,
            parent: this,
            content: 'url:' + url
        });
    }
</script>
</body>
</html>


