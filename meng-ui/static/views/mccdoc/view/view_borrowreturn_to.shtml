<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <style type="text/css">
        .returnButton {
            float: right;
            margin-right: 10px;
            padding: 0px 24px;
        }
    </style>
    <title>借件归还类的TO</title>

    <!-- load css -->
    <link href="/css/mccdoc/to_commons.css" rel="stylesheet" type="text/css"/>
    <link href="/css/jquery-ui-1.8.2.custom.css" rel="stylesheet" type="text/css"/>
    <!-- load js -->
    <script src="/js/global_var.js" type="text/javascript"></script>
    <script src="/js/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script src="/js/jquery/lhgdialog/lhgdialog.js" type="text/javascript"></script>
    <script src="/js/sfa-query-1.0.js" type="text/javaScript"></script>
    <script src="/js/common_query_dialog.js" type="text/javaScript"></script>
    <script src="/views/defect/pnSelect.js" type="text/javascript"></script>
    <script src="/js/plugins/easyui/plugins/jquery.validatebox.js" type="text/javascript"></script>
    <script src="/js/common.js" type="text/javascript"></script>
    <script src="/js/constants.js" type="text/javascript"></script>
    <script src="/js/base64.js" type="text/javascript"></script>
    <script src="/js/mccdoc/common/to_common.js" type="text/javascript"></script>
    <!--    <script src="/js/mccdoc/edit/edit_fault_isolate_to.js" type="text/javascript"></script>-->
</head>
<body>
<div align="right" class="ui_buttons_revise" style="padding-right: 6px;padding-bottom: 4px">
    <span id="revision_span"></span>
</div>
<form action="" id="add_form" method="post">
    <table border="1" cellpadding="0" cellspacing="0" class="table-zi" style="padding-top:10px" width="100%">
        <tr>
            <td class="td-line30-with-bg">TO NO</td>
            <td >
                <span id="dm_to_no" name="toBaseInfo.ata" readonly="readonly"
                      style="width: 53%; cursor: default;" type="text" value=""></span>
            </td>
            <td class="td-line30-with-bg">生效状态</td>
            <td>
                <span id="effect_status" name="toBaseInfo.ata" readonly="readonly"
                      style="width: 53%; cursor: default;" type="text" value=""></span>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg" width="20%">Type</td>
            <td width="30%">
                借件归还
                <input id="dmType" name="toBaseInfo.dmType" tails="" type="hidden" value=""/>
                <input id="to_pdfPermission" type="hidden" value="true"/>
                <input id="toBaseInfoId" name="toBaseInfo.id" type="hidden" value=""/>
                <input id="revNo" name="toBaseInfo.revNo" type="hidden" value=""/>
                <input id="toBaseInfoType" name="toBaseInfo.type" type="hidden" value=""/>
                <input id="delTOMaterialToolsId" name="toBaseInfo.delTOMaterialToolsId" type="hidden" value=""/>
            </td>
            <td class="td-line30-with-bg">执行状态</td>
            <td>
                <span id="execute_status" name="toBaseInfo.ata" readonly="readonly"
                      style="width: 53%; cursor: default;" type="text" value=""></span>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg">DM</td>
            <td id="dm_type_id">
                <input type="radio" id="dm-yes" name="dm"><label for="dm-yes">Yes</label>
                <input type="radio" id="dm-no" name="dm"><label for="dm-no">NO</label>
            </td>
            <td class="td-line30-with-bg" width="20%">版本号(Rev#)</td>
            <td width="30%">R0
            </td>

        </tr>

        <tr>
            <td class="td-line30-with-bg">
                借件归还申请单
            </td>
            <td>
                <input id="grabNo" name="toBaseInfo.grabNo" readonly="readonly"
                       style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
<!--            <td class="td-line30-with-bg">拆件来源</td>-->
<!--            <td>-->
<!--                <input id="grabSource" name="toBaseInfo.grabSource" readonly="readonly"-->
<!--                       style="background-color: #f0f0f0;width: 53%"-->
<!--                       type="text" value=""/>-->
<!--            </td>-->
            <td class="td-line30-with-bg">章节号(ATA)</td>
            <td>
                <input id="ata" name="toBaseInfo.ata" readonly="readonly"
                       style="width: 53%;background-color: #f0f0f0; cursor: default;" type="text" value=""/>
                <span class="td-font-red">*</span>
            </td>
        </tr>
        <tr class="feiji">
            <td class="td-line30-with-bg">机型</td>
            <td>
                <input id="model" name="toBaseInfo.model" readonly="readonly"
                       style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
            <td class="td-line30-with-bg">飞机号</td>
            <td>
                <input id="acReg" name="toBaseInfo.acReg" readonly="readonly"
                       style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
        </tr>
        <tr class="beijian">
            <td class="td-line30-with-bg">拆自件号</td>
            <td>
                <input id="grabPn" name="toBaseInfo.grabPn" readonly="readonly"
                       style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
            <td class="td-line30-with-bg">拆自序号</td>
            <td>
                <input id="grabSn" name="toBaseInfo.grabSn" readonly="readonly"
                       style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg">反馈要求</td>
            <td>
                <input id="yes" name="toBaseInfo.feedbackRequests" type="radio" value="y"/>
                YES&nbsp;&nbsp;
                <input id="no" name="toBaseInfo.feedbackRequests" type="radio" value="n"
                       style="margin-left: 40px"/>
                NO&nbsp;
                <span class="td-font-red" style="margin-left: 40px">*</span>
                <div class="errorMessage"></div>
            </td>
            <td class="td-line30-with-bg">
                <span class="td-line30-with-bg-center" style="border-top: none;">责任单位</span>
            </td>
            <td>
                <input type="radio" id="technology_support" name="toBaseInfo.sourceType" value="0" checked="checked"
                       readonly="readonly">技术支援
                <input type="radio" id="borrow_mcc" name="toBaseInfo.sourceType" value="1" disabled="disabled"
                       style="margin-left: 40px"
                >MCC
                <span class="td-font-red" style="margin-left: 40px">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
<!--        <tr>-->
<!--            <td class="td-line30-with-bg">章节号(ATA)</td>-->
<!--            <td>-->
<!--                <input id="ata" name="toBaseInfo.ata" readonly="readonly"-->
<!--                       style="width: 53%;background-color: #f0f0f0; cursor: default;" type="text" value=""/>-->
<!--            </td>-->
<!--        </tr>-->
        <tr>
            <td class="td-line30-with-bg" colspan="4">归还部件详情</td>
        </tr>
        <tr>
            <td colspan="4">
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="return_component_table"
                       style="border-top: none;" width="100%">
                    <tr>
                        <td class="td-line30-with-bg-center" style="border-top: none;width: 20%">件号名称</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">P/N</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">序号</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">参考位置</td>
                    </tr>
                </table>
            </td>
        </tr>

        <tr>
            <td class="td-line30-with-bg">标题</td>
            <td colspan="3">
                <textarea id="subject" maxlength="3000" name="toBaseInfo.subject" readonly="readonly"
                          style="width:97%;height:40px"></textarea>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg">描述</td>
            <td colspan="3">
                <span style="width: 100%">如果测试通过</span>
                <textarea id="description1" maxlength="1000" name="toBaseInfo.description" readonly="readonly"
                          style="width:97%;height:30px" ></textarea>
                <span class="td-font-red">*</span>
                <!--                <div class="errorMessage"></div>-->
                <span style="width: 100%">如果测试不通过</span>
                <textarea id="description2" maxlength="1000" name="toBaseInfo.description" readonly="readonly"
                          style="width:97%;height:30px"></textarea>
                <span class="td-font-red">*</span>
                <!--                <div class="errorMessage"></div>-->
                <span style="width: 100%">如有问题请联系技术支援处</span>
                <textarea id="description3" maxlength="1000" name="toBaseInfo.description" readonly="readonly"
                          style="width:97%;height:30px" ></textarea>
                <span class="td-font-red">*</span>
<!--                <div class="errorMessage"></div>-->
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg" colspan="4">
                <span style="line-height: 23px">航材/专用工具需求</span>
                <!--            <button class="returnButton" id = "delete">删除</button>-->
                <button class="returnButton" id="add"  disabled="disabled">添加</button>
            </td>
        </tr>
        <tr>
            <td colspan="4">
                <!--添加航材begin -->
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="material_tool_select_table"
                       style="border-top: none;" width="100%">
                    <tr id="toMaterialToolsHtml">
                        <td class="td-line30-with-bg-center" width="24%">Name</td>
                        <td class="td-line30-with-bg-center" width="25%">P/N</td>
                        <td class="td-line30-with-bg-center" width="15%">Tools</td>
                        <td class="td-line30-with-bg-center" width="18%">QTY</td>
                        <td class="td-line30-with-bg-center" width="18%">UNIT</td>
                    </tr>
                </table>
                <!--添加航材end -->
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg" colspan="4">
                <span style="line-height: 23px">任务附件</span>
            </td>
        </tr>
        <tr>
            <td colspan="4">
            <!-- 任务附件tabel-->
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="attachmentHtml" style="border-top: none" width="100%">
                    <tr>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="20%">Doc Name</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="20%">Doc Type</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="20%">Uploader</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="20%">Uploader Data</td>
                        <!--<td class="td-line30-with-bg-center" style="border-top: none;" width="20%">Operate</td>-->
                    </tr>
             <!-- 这里接收来自后台传来的任务附件信息 -->
                </table>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg" colspan="4">部件拆换信息</td>
        </tr>
        <tr>
            <td colspan="4">
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="cc_list_table"
                       style="border-top: none;" width="100%">
                    <tr id="ccListHtml">
                        <td class="td-line30-with-bg-center" style="border-top: none;">Type</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">Name Off</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">P/N Off</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">S/N Off</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">Position Off</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">Name On</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">P/N On</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">S/N On</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">Position On</td>
                    </tr>
                <!--这里插入部件拆换信息列表-->
                </table>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg" width="20%">反馈信息</td>
            <td colspan="3">
            <textarea id="actionAndFeedback" readonly="readonly" rows="4"
                      style="width: 99.5%;background-color: #f0f0f0"></textarea>
            </td>
        </tr>
        <tr>
            <td class="tab_title_background">任务反馈附件</td>
            <td colspan="3">
                <table border="1" bordercolor="#B2C9E0" cellpadding="0" cellspacing="0" class="table-zi"
                       id="qc_table_detail" style="padding-top:10px" width="100%">
                    <tr>
                        <td class="td-line30-with-bg-center" width="25%;">Doc Name</td>
                        <td class="td-line30-with-bg-center" width="25%;">Doc Type</td>
                        <td class="td-line30-with-bg-center" width="25%;">Uploader</td>
                        <td class="td-line30-with-bg-center" width="25%;">Upload Date</td>
                    </tr>
                    <tr id="appendTr"></tr>
                </table>
            </td>
        </tr>
    </table>
</form>
<script type="text/javascript">

    var sub_win, P, s_params = getParentParam_();
   // var id=s_params.id;
    if (frameElement && frameElement.api) {
        sub_win = frameElement.api;
        P = sub_win.opener;
        s_params = sub_win.data;
        var to_pdfPermission = $("#to_pdfPermission").val();
        if (to_pdfPermission == "true") {
            sub_win.button(
                {
                    name: 'View PDF',
                    callback: function () {
                        viewPdf();
                        return false;
                    }
                },
                {
                    name: 'Cancel',
                    callback: function () {
                        return true;
                    }
                }
            );
        }else if(to_pdfPermission == "false"){
            sub_win.button(
                {
                    name: 'Cancel'
                }
            );
        } else {
            s_params = getParentParam2_()
        }
    }

    var obj = {};
    // sub_win.button(
    //     {
    //         name: 'Cancel'
    //     }
    // );

    console.log(s_params);
    var feedBackAttachment;
    $(function () {
        $(':radio').attr('disabled', true);
        $.ajax({
            type: "GET",
            url: "/api/v1/mccdoc/to_base_info/editOrView?id=" + s_params.id,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                debugger
                obj = data.data;
                console.log(obj);
                $("#grabNo").val(obj.toBaseInfoVO.grabNo);
                // $("#grabSource").val(obj.toBaseInfoVO.grabSource == 'AIRCRAFT' ? "飞机" : "备件");
                if (obj.toBaseInfoVO.grabSource == 'AIRCRAFT') {
                    $(".beijian").hide();
                } else if (obj.toBaseInfoVO.grabSource == 'REPLACEMENT') {
                    $(".feiji").hide();
                }
                //TO NO显示
                $("#dm_to_no").html(obj.toBaseInfoVO.toNumber);
                //生效状态显示
                var effect_status_code = obj.toBaseInfoVO.editStatus;
                if(effect_status_code == "1"){
                    $("#effect_status").html("Editing");
                }else if(effect_status_code == "2"){
                    $("#effect_status").html("Checking");
                }else if(effect_status_code == "3"){
                    $("#effect_status").html("Approving");
                }else if(effect_status_code == "4"){
                    $("#effect_status").html("Approved");
                }else if(effect_status_code == "5"){
                    $("#effect_status").html("Active");
                }else if(effect_status_code == "6"){
                    $("#effect_status").html("Superseded");
                }else if(effect_status_code == "7"){
                    $("#effect_status").html("Cancelling");
                }else if(effect_status_code == "8"){
                    $("#effect_status").html("Canceled");
                }
                //执行状态
                var execute_status_code = obj.toBaseInfoVO.executionStatus;
                if(execute_status_code == 1){
                    $("#execute_status").html("Open");
                } else if(execute_status_code == 2){
                    $("#execute_status").html("Process");
                } else if(execute_status_code == 3){
                    $("#execute_status").html("Complete");
                } else if(execute_status_code == 4){
                    $("#execute_status").html("Close");
                }
                //DM显示
                if (obj.toBaseInfoVO.dmType == 'DM') {
                    $('#dm-yes').attr('checked', true);
                } else if (obj.toBaseInfoVO.dmType == 'n') {
                    $('#dm-no').attr('checked', true);
                }
                //反馈要求
                if (obj.toBaseInfoVO.feedbackRequests == 'y') {
                    $('#yes').attr('checked', true);
                } else if (obj.toBaseInfoVO.feedbackRequests == 'n') {
                    $('#no').attr('checked', true);
                }
                $("#model").val(obj.toBaseInfoVO.model);
                //章节号
                $("#ata").val(obj.toBaseInfoVO.ata);
                $("#acReg").val(obj.toBaseInfoVO.acReg);
                $("#grabPn").val(obj.toBaseInfoVO.grabPn);
                $("#grabSn").val(obj.toBaseInfoVO.grabSn);
                $("#grabRemark").val(obj.toBaseInfoVO.grabRemark);
                //描述
                $("#description1").val(obj.toBaseInfoVO.passTest);
                $("#description2").val(obj.toBaseInfoVO.passTestNot);
                $("#description3").val(obj.toBaseInfoVO.connectForHelp);
                $("#toBaseInfoId").val(obj.toBaseInfoVO.id);
                $("#revNo").val(obj.toBaseInfoVO.revNo);
                //标题
                // var subjectTitle = obj.toBaseInfoVO.subject + obj.toGrabs[0].name;
                $("#subject").val(obj.toBaseInfoVO.subject );
                //反馈信息
                $("#actionAndFeedback").val(obj.toBaseInfoVO.actionAndFeedback);
                //归还部件详情
                for (var i in obj.toGrabs) {
                    let file = " <tr >\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"name1" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"pn1" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"sn1" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"pst" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                    </tr>";
                    let html_row = $(file);
                    $("#return_component_table").append(html_row);
                    $("#name1" + obj.toGrabs[i].id).text(obj.toGrabs[i].name);
                    $("#pn1" + obj.toGrabs[i].id).text(obj.toGrabs[i].pn);
                    $("#sn1" + obj.toGrabs[i].id).text(obj.toGrabs[i].sn);
                    $("#pst" + obj.toGrabs[i].id).text(obj.toGrabs[i].position);
                }
                // //航材需求数据插入
                feedBackAttachment = data.data.feedBackAttachment;
                viewAttachmentsOther();
                searchAttachment();
                insertChangeVersion();
                if(!!obj.toMaterialToolss && obj.toMaterialToolss.length > 0){
                    viewToMaterialTools(obj.toMaterialToolss);
                };
            },
            error: function (obj) {
                alert("失败！");
            }
        });
    });

    $(function () {

        $(':radio').attr('disabled', true);
        $.ajax({
            type: "GET",
            url: "/api/v1/compCc/selectByDocTypeAndDocNo/" +9+"/"+ s_params.toNo,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                obj = data.data;
                console.log(obj);
                for (var i in obj) {
                    let file = " <tr >\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"ccType" + obj[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"offName" + obj[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"offPn" + obj[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"offSn" + obj[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"offPosition" + obj[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"onName" + obj[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"onPn" + obj[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"onSn" + obj[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"onPosition" + obj[i].id + "\"></span></td>\n" +
                        "                    </tr>";
                    let html_row = $(file);
                    $("#cc_list_table").append(html_row);
                    $("#ccType" + obj[i].id).text(obj[i].ccType);
                    $("#offName" + obj[i].id).text(obj[i].offName);
                    $("#offPn" + obj[i].id).text(obj[i].offPn);
                    $("#offSn" + obj[i].id).text(obj[i].offSn);
                    $("#offPosition" + obj[i].id).text(obj[i].offPosition);
                    $("#onName" + obj[i].id).text(obj[i].onName);
                    $("#onPn" + obj[i].id).text(obj[i].onPn);
                    $("#onSn" + obj[i].id).text(obj[i].onSn);
                    $("#onPosition" + obj[i].id).text(obj[i].onPosition);
                };
            },
            error: function (obj) {
                alert("失败！");
            }
        });
    });





    /**
     * 验证Form表单
     */
    function validForm() {

        var isValid = false;
        $("#add_form .error").remove();
        var errMsg = '<span class="error">This field is required.</span>';
        var errMsg1 = '<span class="error">The length is greater than 3000 bytes.</span>';
        var numberErrMsg = '<span class="error">Please enter only digits.</span>';


        if (!$("[name='toBaseInfo.acId']").val()) {
            $("[name='toBaseInfo.acId']").nextAll("div.errorMessage").append(errMsg);
        }

        if ($("input:radio[name='toBaseInfo.feedbackRequests']:checked").val() == null) {
            $("[name='toBaseInfo.feedbackRequests']").nextAll("div.errorMessage").append(errMsg);
        }

        if ($("input:radio[name='toBaseInfo.sourceType']:checked").val() == null) {
            $("[name='toBaseInfo.sourceType']").nextAll("div.errorMessage").append(errMsg);
        }

        if (!$("[name='toBaseInfo.subject']").val()) {
            $("[name='toBaseInfo.subject']").nextAll("div.errorMessage").append(errMsg);
        }
        //获取Required Material/Special Tools下面的工具航材
        var materialToolSelect = $("#material_tool_select_table").find("tr:gt(1)");
        //如果存在必须要填写
        if (materialToolSelect) {
            $.each(materialToolSelect, function (index, value) {

                if (!$.trim($(value).find("td:eq(1)").find(":input").val())) {
                    $(value).find("td:eq(1)").find(":input").nextAll("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if (!$.trim($(value).find("td:eq(2)").find(":input").val())) {
                    $(value).find("td:eq(2)").find(":input").nextAll("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if (!$.trim($(value).find("td:eq(4)").find(":input").val())) {
                    $(value).find("td:eq(4)").find(":input").nextAll("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if ((!$.trim($(value).find("td:eq(5)").find("div[class!='hidden'][class!='errorMessage']").children("select").val()))) {
                    $(value).find("td:eq(5)").find("div[class!='hidden'][class!='errorMessage']").children("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if (isNaN($.trim($(value).find("td:eq(4)").find(":input").val()))) {
                    $(value).find("td:eq(4)").find(":input").nextAll("div.errorMessage").append(numberErrMsg);
                    isValid = true;
                }
            });
        }
        checkDMfn && checkDMfn.call();
        if ($("#add_form .errorMessage").text()) {
            isValid = true;
        }
        return isValid;
    }


    /**
     * 提交
     * @returns {Boolean}
     */
    function doSubmit() {
        //移除报错
        $("#add_form .error").remove();
        //如果有报错跳出提交
        if ($("#add_form .errorMessage").text()) {
            return false;
        }
        //如果表单有错误跳出提交
        if (validForm()) {
            return false;
        }
        var actionUrl = basePath + "/api/v1/mccdoc/to_base_info/update";
        var params = $("#add_form").serialize();
        sub_win.button({name: 'Submit', disabled: true});
        sub_win.button({name: 'Cancel', disabled: true});

        $.ajax({
            url: actionUrl,
            type: "post",
            data: params,
            dataType: "json",
            cache: false,
            success: function (data) {
                if (data.code == 200) {
                    P.$.dialog.alert('succ.');
                    sub_win.data['reload'] = '1';
                    sub_win.close();
                } else {
                    // sub_win.button({name: 'Save', disabled: false});
                    sub_win.button({name: 'Submit', disabled: false});
                    sub_win.button({name: 'Cancel', disabled: false});
                    if (data.msg) {
                        P.$.dialog.alert(data.msg);
                    } else {
                        P.$.dialog.alert('Submit failed, please contact the administrator.');
                    }
                }
            }
        });

        return false;
    }

    function viewAttachmentsOther() {
        if (feedBackAttachment) {
            let content = '';
            $.each(feedBackAttachment, function (i, v) {
                let down = basePath + "/api/v1/mccdoc/to_base_info/downloadAttachment?pkid=" + v.pkid + "&down=true";
                var pageType = $("#pageType").val();
                content += "<tr id='appendTr'>";
                content += "<td ><div align='center'><a href=" + down + ">" + v.orgName + "</a></div></td>";
                content += "<td ><div align='center'>" + v.fileContentType + "</div></td>";
                content += "<td ><div align='center'>" + v.ernam + "</div></td>";
                content += "<td ><div align='center'>" + v.erdat + "</div></td>";
                //查看页面不需要删除功能
                if (pageType) {
                    content += "</tr>";
                }
            });
            $("#qc_table_detail").append(content);
        }
    }

    function getFileCategory() {
        let fileCategory = "toProductionModule";
        if (s_params.toType == '1') {
            fileCategory = "toTroubleshootingModule";
        } else if (s_params.toType == '2') {
            fileCategory = "toSurveyModule";
        } else if (s_params.toType == '3') {
            fileCategory = "toMaintenanceModule";
        }else if (s_params.toType == '7') {
            fileCategory = "giveBackAttachment";
        }
        return fileCategory;
    }

    //查询现有的附件信息
    function searchAttachment() {
        var params = {
            "sourceId": s_params.id,
            "fileCategory": getFileCategory()
        };
        var actionUrl = basePath + '/api/v1/mccdoc/to_base_info/searchAttachment';
        $.ajax({
            url: actionUrl,
            type: "get",
            cache: false,
            dataType: "json",
            data: params,
            async: false,
            success: function (data) {
                var html = "";
                debugger
                if (data.code == 200) {
                    $.each(data.data, function (i, v) {
                        let down = basePath + "/api/v1/mccdoc/to_base_info/downloadAttachment?pkid=" + v.pkid + "&down=true";
                        // var pageType = $("#pageType").val();
                        html += "<tr id='appendTr_back'>";
                        html += "<td ><div align='center'><a href=" + down + ">" + v.orgName + "</a></div></td>";
                        html += "<td ><div align='center'>" + v.fileContentType + "</div></td>";
                        html += "<td ><div align='center'>" + v.ernam + "</div></td>";
                        html += "<td ><div align='center'>" + v.erdat + "</div></td>";
                        html += "</tr>";
                        //查看页面不需要删除功能
                        // if (pageType) {

                        // }
                    });
                }
                $("#attachmentHtml").append(html);
            }
        });
    }

    //改版按钮start gaiban
    $("#new_reversion_btn").live("click", function () {
        P.$.dialog.confirm("New Revision?", function () {
            $("#new_reversion_btn").attr("disabled", "disabled");
            let executionStatus = $("input[name='toBaseInfo.executionStatus']").val();
            if (executionStatus == "2") {
                P.$.dialog.alert('请确认是否已经和工作者取得联系!', function () {
                    var id = $("input[name='toBaseInfo.id']").val();
                    var revNo = $("input[name='toBaseInfo.revNo']").val();
                    var params = {"toBaseInfo.id": id, "toBaseInfo.revNo": revNo};
                    $.ajax({
                        url: basePath + "/api/v1/mccdoc/to_base_info/newRevision",
                        type: "post",
                        cache: false,
                        dataType: "json",
                        data: params,
                        success: function (data) {
                            if (data.code == 200) {
                                P.$.dialog.alert("New Revision Success", function () {
                                    sub_win.close();
                                });
                            } else {
                                P.$.dialog.alert(data.msg, function () {
                                    sub_win.close();
                                });
                            }
                        },
                        error: function () {
                            P.$.dialog.alert('New Revision Error!', function () {
                                sub_win.close();
                            });
                        }
                    });
                });
            } else {
                var id = $("input[name='toBaseInfo.id']").val();
                var revNo = $("input[name='toBaseInfo.revNo']").val();
                var params = {"toBaseInfo.id": id, "toBaseInfo.revNo": revNo};
                $.ajax({
                    url: basePath + "/api/v1/mccdoc/to_base_info/newRevision",
                    type: "post",
                    cache: false,
                    dataType: "json",
                    data: params,
                    success: function (data) {
                        if (data.code == 200) {
                            P.$.dialog.alert("New Revision Success", function () {
                                sub_win.close();
                            });
                        } else {
                            P.$.dialog.alert(data.msg, function () {
                                sub_win.close();
                            });
                        }
                    },
                    error: function () {

                        P.$.dialog.alert('New Revision Error!', function () {
                            sub_win.close();
                        });
                    }
                });
            }

        }, function () {
        }, this);
    });
    //改版按钮end

    //插入改版按钮start
    function insertChangeVersion(){
        if(obj.toBaseInfoVO.isNewest && obj.toBaseInfoVO.editStatus == 5 &&
            (obj.toBaseInfoVO.executionStatus == 1 || obj.toBaseInfoVO.executionStatus == 2
                || obj.toBaseInfoVO.executionStatus == 3)) {
            let html = '<input id="new_reversion_btn" type="button" value="New Reversion"/>';
            $("#revision_span").after(html);
        }
    }
    //插入改版按钮end

    function viewPdf() {
        let id = $("#toBaseInfoId").val(), tail = $("#toBaseInfoTail").val();
        window.location.href = basePath + '/api/v1/mccdoc/to_managementPdf/createTO?id=' + id + '&tail=' + tail;
    }

    function viewToMaterialTools(toMaterialToolss) {
        var html = '';
        $.each(toMaterialToolss, function (i, v) {
            html += '<tr>';
            html += '<td class="td-line30-center">';
            html += '<textarea readonly="readonly" rows="2" style="width: 99.5%;background-color: #f0f0f0">' + v.name + '</textarea>';
            html += '</td>';
            html += '<td class="td-line30-center">';
            html += '<textarea readonly="readonly" rows="2" style="width: 99.5%;background-color: #f0f0f0">' + v.pn + '</textarea>';
            html += '</td>';
            html += '<td class="td-line30-center">';
            if (v.type == 2) {
                html += '<input checked="checked" disabled="disabled" style="vertical-align: middle;" type="checkbox"/>&nbsp;&nbsp;工具';
            } else {
                html += '<input disabled="disabled" style="vertical-align: middle;" type="checkbox"/>&nbsp;&nbsp;工具';
            }
            html += '</td>';
            html += '<td class="td-line30-center">' + v.qty + '</td>';
            html += '<td class="td-line30-center">' + v.unit + '</td>';
            html += '</tr>';
        });
        $("#toMaterialToolsHtml").after(html);
    }

</script>
</body>
</html>