<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <title>修改串件类的TO</title>

    <!-- load css -->
    <link href="/css/mccdoc/to_commons.css" rel="stylesheet" type="text/css"/>
    <link href="/css/nrc/nrc_add.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/icon.css">
    <link rel="stylesheet" type="text/css" href="/css/plugins/easyui/themes/bootstrap/easyui.css" id="swicth-style"/>
    <link rel="stylesheet" type="text/css" href="/css/plugins/easyui/themes/icon.css"/>
    <link rel="stylesheet" type="text/css" href="/css/plugins/easyui/themes/color.css"/>
    <style type="text/css">
        #dmZhezhao{
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.4);
            /*border-left: 1px solid #CCCCCC;*/
            /*display: none;*/
            position: absolute;
            z-index: 9;
            top: 0px;
            right: 0px;
        }
    </style>
    <!-- load js -->
    <script src="/js/global_var.js" type="text/javascript"></script>
    <script src="/js/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/plugins/easyui/jquery.easyui.custom.min.js"></script>
    <script type="text/javascript" src="/js/plugins/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script src="/js/jquery/lhgdialog/lhgdialog.js" type="text/javascript"></script>
    <script src="/js/sfa-query-1.0.js" type="text/JavaScript"></script>
    <script src="/js/common_query_dialog.js" type="text/JavaScript"></script>
    <script src="/js/plugins/easyui/plugins/jquery.validatebox.js" type="text/javascript"></script>
    <script src="/views/defect/pnSelect.js" type="text/javascript"></script>
    <script src="/js/common.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/env.js"></script>
    <script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
    <script src="/js/constants.js" type="text/javascript"></script>
    <script src="/js/base64.js" type="text/javascript"></script>
    <script src="/js/mccdoc/common/to_common.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/combobox_utils.js"></script>
<!--    <script src="/js/mccdoc/edit/edit_fault_isolate_to.js" type="text/javascript"></script>-->
</head>
<body>
<form action="" id="add_form" method="post">
    <table border="1" cellpadding="0" cellspacing="0" class="table-zi" style="padding-top:10px" width="100%">
        <tr>
            <td class="td-line30-with-bg" width="20%">Type:</td>
            <td width="40%">
                串件
                <input id="dmType" name="toBaseInfo.dmType" tails="" type="hidden" value=""/>
                <input id="toBaseInfoId" name="toBaseInfo.id" type="hidden" value=""/>
                <input id="toBaseInfoType" name="toBaseInfo.type" type="hidden" value=""/>
                <input id="delTOMaterialToolsId" name="toBaseInfo.delTOMaterialToolsId" type="hidden" value=""/>
                <div id="acId" style="display: none"></div>
            </td>
            <td class="td-line30-with-bg" width="20%">Rev#:</td>
            <td width="20%">R0
            </td>
        </tr>

        <tr>
            <td class="td-line30-with-bg">
                串件申请单:
            </td>
            <td>
                <input id="grabNo" name="toBaseInfo.grabNo" readonly="readonly" style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
            <td class="td-line30-with-bg">拆件来源 :</td>
            <td>
                <input id="caijian" name="toBaseInfo.grabSource" readonly="readonly" style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
        </tr>
        <tr class="feiji">
            <td class="td-line30-with-bg">机型 :</td>
            <td>
                <input id="model" name="toBaseInfo.model" readonly="readonly" style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
            <td class="td-line30-with-bg">飞机号 :</td>
            <td>
                <input id="acReg" name="toBaseInfo.acReg" readonly="readonly" style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg">章节号:</td>
            <td>
<!--                <input id="ata" name="toBaseInfo.ata" maxlength="4" class="number_ata4" style="width: 53%;cursor: default;" type="text" value=""/>-->
                <input name="toBaseInfo.ata" class="easyui-textbox" id="ata" >
                <div class="errorMessage"></div>
            </td>
            <td class="td-line30-with-bg">DM:</td>
            <td id="dm_type_id" style="position: relative">
<!--                这是一段由公共文件统一注入的代码，注释掉为了提醒DM的单选由一段从公共文件to_common通过dm_type_id注入的代码，必须使用否则会通过name=toBaseInfo.acReg注入-->
<!--                <input id="dmYes" type="radio"  name="dm" value="y" ><label for="dmYes">Yes</label>-->
<!--                <input  id="dmNo" type="radio" name="dm" value="n" ><label for="dmNo">NO</label>-->
            </td>
        </tr>
        <tr class="beijian">
            <td class="td-line30-with-bg">拆自件号 :</td>
            <td>
                <input id="grabPn" name="toBaseInfo.grabPn" readonly="readonly" style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
            <td class="td-line30-with-bg">拆自序号 :</td>
            <td>
                <input id="grabSn" name="toBaseInfo.grabSn" readonly="readonly" style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg">反馈要求 :</td>
            <td>
                <input id="yes" name="toBaseInfo.feedbackRequests" type="radio" value="y"/>
                YES&nbsp;&nbsp;
                <input id="no" name="toBaseInfo.feedbackRequests" type="radio" value="n"/>
                NO&nbsp;
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>

            </td>
            <td class="td-line30-with-bg"><span class="td-line30-with-bg-center"
                                                style="border-top: none;">Source Type:</span></td>
            <td >
                <input type="radio" id="sourceType_mcc" name="toBaseInfo.sourceType" value="0" checked="checked"
                       readonly="readonly">MCC</label>
                <input type="radio" id="sourceType_ppc" name="toBaseInfo.sourceType" value="1"
                       disabled="disabled">PPC</label>
                <input type="radio" id="sourceType_ts" name="toBaseInfo.sourceType" value="2"
                       disabled="disabled">TS</label>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg">标题:</td>
            <td colspan="3">
                <textarea id="subject" maxlength="3000" name="toBaseInfo.subject"
                          style="width:97%;height:80px"></textarea>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg">描述:</td>
            <td colspan="3">
                <textarea id="description" maxlength="3000" name="toBaseInfo.description" readonly="readonly"
                          style="width:97%;height:80px"></textarea>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg">备注:</td>
            <td colspan="3">
                <textarea id="grabRemark" maxlength="3000" name="toBaseInfo.grabRemark"
                          style="width:97%;height:80px"></textarea>
<!--                <span class="td-font-red">*</span>-->
<!--                <div class="errorMessage"></div>-->
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg" colspan="4">串件件号/部件:</td>
        </tr>
        <tr>
            <td colspan="4">
                <!--Trouble-shooting begin -->
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="trouble_shooting_table"
                       style="border-top: none;" width="100%">
                    <tr>
                        <td class="td-line30-with-bg-center" style="border-top: none;" >件号名称</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" >P/N</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" >序号</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" >QTY</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" >UNIT</td>
                    </tr>

                </table>
                <!--Trouble-shooting end -->
            </td>
        </tr>

        <tr>
            <td class="td-line30-with-bg" colspan="4">
                Required Material/Special Tools
                <span style="float: right; padding-right:5.5%">
    	<img onclick="add_material_tools();return false;" src="/images/add.gif" style="cursor:pointer"/></span>
            </td>
        </tr>
        <tr>
            <td colspan="4">
                <!--添加航材begin -->
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="material_tool_select_table"
                       style="border-top: none;" width="100%">
                    <tr>
                        <td class="td-line30-with-bg-center" width="20%">Name</td>
                        <td class="td-line30-with-bg-center" width="22%">P/N</td>
                        <td class="td-line30-with-bg-center" width="13%">Tools</td>
                        <td class="td-line30-with-bg-center" width="16%">QTY</td>
                        <td class="td-line30-with-bg-center" width="16%">UNIT</td>
                        <td class="td-line30-with-bg-center" width="13%">Operate</td>
                    </tr>
                    <tr id="toMaterialToolsHtml" style="display:none;">
                        <td class="td-line30-center" style="display:none;">0</td>
                        <td class="td-line30-center">
                            <input maxlength="600" name="" style="width: 90%;height: 20px" type="text"/>
                            <span class="td-font-red">*</span>
                            <div class="errorMessage"></div>
                        </td>
                        <td class="td-line30-center">
                            <input maxlength="100" name="" style="width: 80%;height: 20px" type="text"/>
                            <span class="td-font-red">*</span>
                            <img class="add_del" height="16" id="dbpns" onclick="searchPnNumber(this);return false;"
                                 src="/images/ico_search_16.gif" style="cursor:pointer" ttype="manual_doc" width="16"/>
                            <div class="errorMessage"></div>
                        </td>
                        <td class="td-line30-center">
                            <input name="" onclick="selectTool(this);" style="vertical-align: middle;" type="checkbox"
                                   value="1"/>
                            &nbsp;&nbsp;工具
                        </td>
                        <td class="td-line30-center">
                            <input class="number" maxlength="10" name="" style="width: 80%;height: 20px" type="text"/>
                            <span class="td-font-red">*</span>
                            <div class="errorMessage"></div>
                        </td>
                        <td class="td-line30-center">
                            <!-- 航材单位 -->
                            <div name="materialName">
                                <select id="materialNameSelect" style="width: 90%;height:23px">
                                    <option value="">--------请选择--------</option>
                                </select>
                                <span class="td-font-red">*</span>
                                <div class="errorMessage"></div>
                            </div>

                            <!-- 工具单位 -->
                            <div class="hidden" name="unitName">
                                <select id="unitNameSelect" style="width: 90%;height:23px">
                                    <option value="">--------请选择--------</option>
                                </select>
                                <span class="td-font-red">*</span>
                                <div class="errorMessage"></div>
                            </div>
                        </td>
                        <td class="td-line30-center">
                            <img height="19" id="del" name="del" onclick="delete_material_tools_tr(this)"
                                 src="/images/ico_cut.gif" style="cursor:pointer" title="Delete" width="18"/>
                        </td>
                    </tr>
                </table>
                <!--添加航材end -->
            </td>
        </tr>
        <tr>
            <td class="key">附件</td>
            <td colspan="6" id="attachament_td">
                <div id="attach_file">

                </div>
            </td>
        </tr>
        <tr>
            <td class="tab_title_background" colspan="4" style="text-align: right;">
                <!--<input type="button" value="提交" style="width: 50px;height: 25px;cursor: pointer;" onclick="to_subim()">-->
            </td>

        </tr>
    </table>
</form>
<script type="text/javascript">
    var sub_win, P, s_params = {};
    var obj = {};
    var lisr_file = 0;
    if (frameElement && frameElement.api) {
        sub_win = frameElement.api;
        var toMaterialToolssLength = 0;
        P = sub_win.opener;
        s_params = sub_win.data;
        sub_win.button(
            {
                name: 'Submit',
                callback: function () {
                    doSubmit();
                    return false;
                }
            },{
                name: 'Save',
                callback: function () {
                    saveForm();
                    return false;
                }
            },
            {
                name: 'Cancel'
            }
        );
    } else {
        s_params = getParentParam2_()
    }
    var feedBackAttachment;
    console.log(s_params);
    $(function () {

        $.ajax({
            type: "GET",
            url: "/api/v1/mccdoc/to_base_info/editOrView?id=" + s_params.id,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                obj=data.data;
                $("#grabNo").val(obj.toBaseInfoVO.grabNo);
                $("#caijian").val(obj.toBaseInfoVO.grabSource=='AIRCRAFT'? "飞机":"备件");
                if(obj.toBaseInfoVO.grabSource=='AIRCRAFT'){
                    $(".beijian").hide();
                }else  if(obj.toBaseInfoVO.grabSource=='REPLACEMENT'){
                    $(".feiji").hide();
                }
                //DM显示
                if (obj.toBaseInfoVO.dmType == 'DM') {
                    // $('#dmYes').attr('checked', true);
                    $("#dm_type_id").children().eq(0).prop("checked", "checked")
                } else if (obj.toBaseInfoVO.dmType == 'n') {
                    // $('#dmNo').attr('checked', true);
                    $("#dm_type_id").children().eq(1).prop("checked", "checked")
                }
                //反馈要求
                if (obj.toBaseInfoVO.feedbackRequests == 'y') {
                    $('#yes').attr('checked', true);
                } else if (obj.toBaseInfoVO.feedbackRequests == 'n') {
                    $('#no').attr('checked', true);
                }
                $("#model").val(obj.toBaseInfoVO.model);
                // $("#ata").val(obj.toBaseInfoVO.ata);
                $("#acReg").val(obj.toBaseInfoVO.acReg);
                $("#grabPn").val(obj.toBaseInfoVO.grabPn);
                $("#grabSn").val(obj.toBaseInfoVO.grabSn);
                $("#grabRemark").val(obj.toBaseInfoVO.grabRemark);
                $("#description").val(obj.toBaseInfoVO.description);
                //标题
                // var subjectTitle = obj.toBaseInfoVO.subject + obj.toGrabs[0].name;
                // var subjectTitle = obj.toBaseInfoVO.subject;
                $("#subject").val(obj.toBaseInfoVO.subject);
                $("#acId").html(obj.toBaseInfoVO.acId||"");
                for(var i in obj.toGrabs){
                    let file = " <tr >\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"name" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"pn" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"sn" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"qty" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"unit" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                    </tr>";
                    let html_row = $(file);
                    $("#trouble_shooting_table").append(html_row);
                    $("#name"+obj.toGrabs[i].id).text(obj.toGrabs[i].name);
                    $("#pn"+obj.toGrabs[i].id).text(obj.toGrabs[i].pn);
                    $("#sn"+obj.toGrabs[i].id).text(obj.toGrabs[i].sn);
                    $("#qty"+obj.toGrabs[i].id).text(obj.toGrabs[i].qty);
                    $("#unit"+obj.toGrabs[i].id).text(obj.toGrabs[i].unit);
                }
                add_file_show( s_params.id);
                add_atta_input_flie();
                checkDm(obj.toBaseInfoVO.ata);
                if(!!obj.toMaterialToolss && obj.toMaterialToolss.length > 0){
                    initToMaterialTools(obj.toMaterialToolss)
                };
            },
            error: function (obj) {
                alert("失败！");
            }
        });

        $("[name='toBaseInfo.ata']").unbind();
        ataSelectInit("hideTips");
        setTimeout(function () {
            $("#ata").textbox("setValue", obj.toBaseInfoVO.ata)
        },500)
    });

    /**
     * 验证Form表单
     */
    function validForm() {

        var isValid = false;
        $("#add_form .error").remove();
        var errMsg = '<span class="error">This field is required.</span>';
        var errMsg1 = '<span class="error">The length is greater than 3000 bytes.</span>';
        var numberErrMsg = '<span class="error">Please enter only digits.</span>';

        if (!$("[name='toBaseInfo.ata']").val()) {
            $("[name='toBaseInfo.ata']").nextAll("div.errorMessage").append(errMsg);
        }else{
            let pattern = /^\d{4}$/;
            if (!pattern.test($("[name='toBaseInfo.ata']").val())) {
                $("[name='toBaseInfo.ata']").nextAll("div.errorMessage").append( '<span class="error">章节只能输入4位数字.</span>');
            }
        }

        if (!$("[name='toBaseInfo.acId']").val()) {
            $("[name='toBaseInfo.acId']").nextAll("div.errorMessage").append(errMsg);
        }

        if ($("input:radio[name='toBaseInfo.feedbackRequests']:checked").val() == null) {
            $("[name='toBaseInfo.feedbackRequests']").nextAll("div.errorMessage").append(errMsg);
        }

        if ($("input:radio[name='toBaseInfo.sourceType']:checked").val() == null) {
            $("[name='toBaseInfo.sourceType']").nextAll("div.errorMessage").append(errMsg);
        }

        if (!$("[name='toBaseInfo.subject']").val()) {
            $("[name='toBaseInfo.subject']").nextAll("div.errorMessage").append(errMsg);
        }

        var description = $("[name='toBaseInfo.description']").val();
        if (!description) {
            $("[name='toBaseInfo.description']").nextAll("div.errorMessage").append(errMsg);
            isValid = true;
        }

        //验证是否超过3000字节
        if (description.replace(/[^\u0000-\u00ff]/g, "aaa").length > 3000) {
            $("[name='toBaseInfo.description']").nextAll("div.errorMessage").append(errMsg1);
        }

        //获取Required Material/Special Tools下面的工具航材
        var materialToolSelect = $("#material_tool_select_table").find("tr:gt(1)");
        //如果存在必须要填写
        if (materialToolSelect) {
            $.each(materialToolSelect, function (index, value) {

                if (!$.trim($(value).find("td:eq(1)").find(":input").val())) {
                    $(value).find("td:eq(1)").find(":input").nextAll("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if (!$.trim($(value).find("td:eq(2)").find(":input").val())) {
                    $(value).find("td:eq(2)").find(":input").nextAll("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if (!$.trim($(value).find("td:eq(4)").find(":input").val())) {
                    $(value).find("td:eq(4)").find(":input").nextAll("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if ((!$.trim($(value).find("td:eq(5)").find("div[class!='hidden'][class!='errorMessage']").children("select").val()))) {
                    $(value).find("td:eq(5)").find("div[class!='hidden'][class!='errorMessage']").children("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if (isNaN($.trim($(value).find("td:eq(4)").find(":input").val()))) {
                    $(value).find("td:eq(4)").find(":input").nextAll("div.errorMessage").append(numberErrMsg);
                    isValid = true;
                }
            });
        }
        checkDMfn && checkDMfn.call();
        if ($("#add_form .errorMessage").text()) {
            isValid = true;
        }
        return isValid;
    }


    /**
     * 提交
     * @returns {Boolean}
     */
    function doSubmit() {
        $("#add_form .error").remove();
        if ($("#add_form .errorMessage").text()) {
            return false;
        }
        if (validForm()) {
            return false;
        }
        var actionUrl = basePath + "/api/v1/mccdoc/to_base_info/update";
        var params = $("#add_form").serialize();
        sub_win.button({name: 'Submit', disabled: true});
        sub_win.button({name: 'Cancel', disabled: true});
        $.ajax({
            url: actionUrl,
            type: "post",
            data: params,
            dataType: "json",
            cache: false,
            success: function (data) {
                if (data.code == 200) {
                    P.$.dialog.alert('succ.');
                    sub_win.data['reload'] = '1';
                    sub_win.close();
                } else {
                    // sub_win.button({name: 'Save', disabled: false});
                    sub_win.button({name: 'Submit', disabled: false});
                    sub_win.button({name: 'Cancel', disabled: false});
                    if (data.msg) {
                        P.$.dialog.alert(data.msg);
                    } else {
                        P.$.dialog.alert('Submit failed, please contact the administrator.');
                    }
                }
            }
        });

        return false;
    }

    //添加附件功能
    function add_file(i) {
        let file = " <div id=\"atta_input_flie_" + i + "\" class=\"atta_input_fliecss atta_input_fliecss_move\">\n" +
            "       <input class=\"textbox easyui-validatebox\" type=\"file\" id=\"atta_input_flie_a" + i + "\" size=\"300\" name=\"file\" data-options=\"required:true\"/>            \n" +
            "                    <div class=\"add_jiahao\" onclick=\"add_atta_input_flie()\" style='margin-top: 5px'></div>\n" +
            " <div class='file_duihao' onclick=\"atta_input_flie('atta_input_flie_a'+" + i + ")\">✔</div>\n" +
            "                    <div class=\"jianhao icon-delete\" onclick=\"delete_atta_input_flie(atta_input_flie_" + i + ")\" style='margin-top: 4px'></div>\n" +
            "                </div>";
        let html_row = $(file);
        $("#attachament_td").append(html_row);
    }
    //附件上传增加按钮
    function add_atta_input_flie() {
        add_file(lisr_file);
        lisr_file++;
    }
    //附件上传删除按钮
    function delete_atta_input_flie(val) {
        let geshu = document.getElementsByClassName('atta_input_fliecss_move');
        debugger
        if (geshu.length == 1) {
            return
        }
        let newP = $(val);
        if (newP.length > 0) {
            newP.remove();
        }
    }
    //附件上传打钩按钮
    function atta_input_flie(id) {
        if ($("#ccid").val() != "") {
            var fileInput = $("#" + id).get(0).files[0];
            if (fileInput) {
                $.ajaxFileUpload({
                    url: Constant.API_URL + 'ATTACHMENT_UPLOAD',
                    secureuri: false,
                    fileElementId: id, //file控件id
                    dataType: 'json',
                    data: {
                        "fileCategory": "qiangjianTo",
                        "sourceId":  s_params.id,
                    },
                    success: function (data) {
                        if (data.code == 200) {
                            var file = document.getElementById("" + id + "");
                            file.value = '';
                            $("#" + id).value = "";
                            add_file_show( s_params.id);
                        }

                    }

                })
            } else {
                alert("请选择上传文件！");
            }
        } else {
            alert("请先保存，在上传附件！")
        }

    }

    //删除已添加附件
    function deleteFile(fileid) {
        var _url = basePath + "/api/v1/mccdoc/to_base_info/deleteAttachment";
        P.$.dialog.confirm('Delete Selected ?', function () {
            $.ajax({
                url: _url,
                type: "get",
                data: {'pkid': fileid},
                dataType: "json",
                cache: false,
                success: function (data) {
                    if (data.code == 200) {
                        P.$.dialog.alert("Success");
                        $("#qc_table_detail #appendTr").remove();
                        add_file_show(s_params.id);
                    }
                }
            });
        }, function () {
        });
    }
    //增加文件
    function add_file_show(id) {
        $("#attach_file").empty();
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: id,
                CATEGORY: "qiangjianTo",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                for (var ind in jdata.data) {
                    let file = " <div id=\"input_flie_show" + jdata.data[ind].PKID + "\" class=\"atta_input_fliecss\" style=\"line-height: 30px;width: 100%;    height: 30px;border-bottom: 1px solid #ccc;\">\n" +
                        "                            <div style=\"width: 60%;text-align: left;\"><a style=\"color:red;font-size: 14px\" onclick=\"downFile(" + jdata.data[ind].PKID + "," + jdata.data[ind].PKID + ")\">" + jdata.data[ind].ORG_NAME + "</a></div>\n" +
                        "\n" +
                        "                        <div class=\"jianhao icon-delete\" onclick=\"deleteFile(" + jdata.data[ind].PKID + ")\"></div>\n" +
                        "                        </div>";
                    let html_row = $(file);
                    $("#attach_file").append(html_row);
                }

            }
        });
    }

    //    保存start
    function saveForm() {
        //移除报错
        $("#add_form .error").remove();
        //如果有报错跳出提交
        if ($("#add_form .errorMessage").text()) {
            return false;
        }
        //如果表单有错误跳出提交
        if (validForm()) {
            return false;
        }
        var actionUrl = basePath + "/api/v1/mccdoc/to_base_info/updateForSap";
        var params = $("#add_form").serialize();
        sub_win.button({name: 'Submit', disabled: true});
        sub_win.button({name: 'Save', disabled: true});
        sub_win.button({name: 'Cancel', disabled: true});

        $.ajax({
            url: actionUrl,
            type: "post",
            data: params,
            dataType: "json",
            cache: false,
            success: function (data) {
                // alert("保存成功");
                if (data.code == 200) {
                    P.$.dialog.alert('保存成功');
                    sub_win.data['reload'] = '1';
                    sub_win.button({name: 'Save', disabled: false});
                    sub_win.button({name: 'Submit', disabled: false});
                    sub_win.button({name: 'Cancel', disabled: false});
                    sub_win.close();
                } else {
                    sub_win.button({name: 'Save', disabled: false});
                    sub_win.button({name: 'Submit', disabled: false});
                    sub_win.button({name: 'Cancel', disabled: false});
                    if (data.msg) {
                        P.$.dialog.alert(data.msg);
                    } else {
                        P.$.dialog.alert('Submit failed, please contact the administrator.');
                    }
                }
            },
            error:function (obj) {
                alert("保存失败");
                sub_win.button({name: 'Save', disabled: false});
                sub_win.button({name: 'Submit', disabled: false});
                sub_win.button({name: 'Cancel', disabled: false});
            }
        });

        return false;
    }
    //    保存end

    /**
     * 添加工具航材
     */
    function add_material_tools() {

        var _table = $("#material_tool_select_table");

        var _node = _table.find("tr").last().clone(true);

        _node.removeAttr("style");

        var _findTd = _node.find("td:eq(0)");

        var _index = _findTd.text();

        _findTd.text(Number(_index) + 1);

        //设置Name的name值
        _node.find("td:eq(1)").find(":input").attr("name", "toMaterialToolss[" + Number(_index) + "].name");
        //设置P/N的name值
        _node.find("td:eq(2)").find(":input").attr("name", "toMaterialToolss[" + Number(_index) + "].pn");
        //设置Tools的name值
        _node.find("td:eq(3)").find(":input").attr("name", "toMaterialToolss[" + Number(_index) + "].type");
        //设置QTY的name值
        _node.find("td:eq(4)").find(":input").attr("name", "toMaterialToolss[" + Number(_index) + "].pageQty");
        //设置UNIT的name值
        _node.find("td:eq(5)").find(":input").attr("name", "toMaterialToolss[" + Number(_index) + "].unit");
        //设置id的name值
        _node.find("td:eq(6)").find(":input").attr("name", "toMaterialToolss[" + Number(_index) + "].id");

        //清空id的value值
        _node.find("td:eq(6)").find(":input").val("");
        //设置UNIT中工具DIV的class
        _node.find("td:eq(5)").find("div[name='unitName']").attr("class", "hidden");
        //设置UNIT中航材DIV的class
        _node.find("td:eq(5)").find("div[name='materialName']").attr("class", "");
        //清空select输入框中的值
        _node.find("td:eq(5)").find("div[name='unitName']").find("select").val("");
        // _node.find("td:eq(5)").find("div[name='materialName']").find("select").val("");
        var selectOp=_node.find("td:eq(5)").find("div[name='materialName']").find("select");
        var option = "<option value=''>--------请选择--------</option>";
        selectOp.empty();
        selectOp.append(option);


        //清空input输入框中的值
        _node.find("input[type='text']").val("");
        //清空checkbox
        _node.find("input[type='checkbox']").removeAttr("checked");
        //清空提示
        _node.find(".error").remove();

        //新增一行要添加按钮单击事件
        _node.find("td:eq(2)").find("img").show();
        //移除件号框只读属性
        if (!_node.find("td:eq(2)").find("input").attr("readonly")) {
            _node.find("td:eq(2)").find("input").attr("readonly", "readonly");
            //_node.find("td:eq(1)").find("input").attr("readonly","readonly");
        }
        _table.append(_node);
    }

    /**
     * 删除工具航材行
     */
    function delete_material_tools_tr(_obj, id) {

        if ($("#material_tool_select_table").find("tr").length > 2) {

            if (confirm("你确定要删除当前行吗 ?")) {

                var delTOMaterialToolsId = $.trim($("#delTOMaterialToolsId").val());

                if (delTOMaterialToolsId) {
                    $("#delTOMaterialToolsId").val(delTOMaterialToolsId + "," + id);
                } else {
                    $("#delTOMaterialToolsId").val(id);
                }

                //删除
                $(_obj).parent().parent().remove();

                //删除后重新排序
                var _trArray = $("#material_tool_select_table").find("tr:gt(1)");

                if (_trArray) {

                    _trArray.each(function (index_, value_) {

                        $(value_).find("td:first").text(index_ + 1);
                        $(value_).find("td:eq(1)").find(":input").attr("name", "toMaterialToolss[" + Number(index_) + "].name");
                        $(value_).find("td:eq(2)").find(":input").attr("name", "toMaterialToolss[" + Number(index_) + "].pn");
                        $(value_).find("td:eq(3)").find(":input").attr("name", "toMaterialToolss[" + Number(index_) + "].type");
                        $(value_).find("td:eq(4)").find(":input").attr("name", "toMaterialToolss[" + Number(index_) + "].pageQty");
                        $(value_).find("td:eq(5)").find(":input").attr("name", "toMaterialToolss[" + Number(index_) + "].unit");
                        $(value_).find("td:eq(6)").find(":input").attr("name", "toMaterialToolss[" + Number(index_) + "].id");
                    });
                }

            }
        }
    }

    function initToMaterialTools(toMaterialToolss) {
        var html = '';
        $.each(toMaterialToolss, function (i, v) {
            html += '<tr>';
            html += '<td class="td-line30-center" style="display:none;">' + (i + 1) + '</td>';
            html += '<td class="td-line30-center">';
            html += '<input maxlength="600" name="toMaterialToolss[' + i + '].name" style="width: 90%;height: 20px" type="text" ' +
                'value="' + v.name + '"/>';
            html += '<span class="td-font-red">*</span>';
            html += '<div class="errorMessage"></div>';
            html += '</td>';
            html += '<td class="td-line30-center">';
            html += '<input maxlength="100" name="toMaterialToolss[' + i + '].pn" style="width: 80%;height: 20px" type="text" ' +
                'value="' + v.pn + '"/>';
            html += '<span class="td-font-red">*</span>';
            if(v.type == 2){
                html += '<img class="add_del" height="16" id="dbpns" onclick="searchPnNumber(this);return false;" ' +
                    'src="/images/ico_search_16.gif" style="cursor:pointer; display: none;" ttype="manual_doc" width="16"/>';
            }else {
                html += '<img class="add_del" height="16" id="dbpns" onclick="searchPnNumber(this);return false;" ' +
                    'src="/images/ico_search_16.gif" style="cursor:pointer" ttype="manual_doc" width="16"/>';
            }
            html += '<div class="errorMessage"></div>';
            html += '</td>';
            html += '<td class="td-line30-center">';
            if (v.type == 2) {
                html += '<input checked="checked" name="toMaterialToolss[' + i + '].type" onclick="selectTool(this);" ' +
                    'style="vertical-align: middle;" type="checkbox" value="' + v.type + '"/>&nbsp;&nbsp;工具';
            } else {
                html += '<input name="toMaterialToolss[' + i + '].type" onclick="selectTool(this);" ' +
                    'style="vertical-align: middle;" type="checkbox" value="' + v.type + '"/> &nbsp;&nbsp;工具';
            }
            html += '</td>';
            html += '<td class="td-line30-center">';
            html += '<input class="number" maxlength="10" name="toMaterialToolss[' + i + '].pageQty" ' +
                'style="width: 80%;height: 20px" type="text" value="' + v.qty + '"/>';
            html += '<span class="td-font-red">*</span>';
            html += '<div class="errorMessage"></div>';
            html += '</td>';
            html += '<td class="td-line30-center">';
            if (v.type == 2) {
                html += '<div class="hidden" name="materialName">';
                html += '<select name="toMaterialToolss[' + i + '].unit" style="width: 90%;height:23px" >';
                html += '<option value="">--------请选择--------</option>';
                if (materialUnitList) {
                    $.each(materialUnitList, function (j, vv) {
                        if (vv.VALUE == v.unit) {
                            html += '<option selected="selected" value="' + vv.VALUE + '">' + vv.VALUE + '</option>';
                        } else {
                            html += '<option value="' + vv.VALUE + '">' + vv.VALUE + '</option>';
                        }
                    });
                }
                html += '</select>';
                html += '<span class="td-font-red">*</span>';
                html += '<div class="errorMessage"></div>';
                html += '</div>';

                html += '<div name="unitName">';
                html += '<select name="toMaterialToolss[' + i + '].unit" style="width: 90%;height:23px">';
                html += '<option value="">--------请选择--------</option>';
                if (toolUnitList) {
                    $.each(toolUnitList, function (j, vv) {
                        if (vv.VALUE == v.unit) {
                            html += '<option selected="selected" value="' + vv.VALUE + '">' + vv.VALUE + '</option>';
                        } else {
                            html += '<option value="' + vv.VALUE + '">' + vv.VALUE + '</option>';
                        }
                    });
                }
                html += '</select>';
                html += '<span class="td-font-red">*</span>';
                html += '<div class="errorMessage"></div>';
                html += '</div>';
            } else {
                html += '<div name="materialName">';
                html += '<select name="toMaterialToolss[' + i + '].unit" style="width: 90%;height:23px">';
                // html += '<option value="">--------请选择--------</option>';
                html += '<option value="' + v.unit + '">' + v.unit + '</option>';
                // if (materialUnitList) {
                //     $.each(materialUnitList, function (j, vv) {
                //         if (vv.VALUE == v.unit) {
                //             html += '<option selected="selected" value="' + vv.VALUE + '">' + vv.VALUE + '</option>';
                //         } else {
                //             html += '<option value="' + vv.VALUE + '">' + vv.VALUE + '</option>';
                //         }
                //     });
                // }
                html += '</select>';
                html += '<span class="td-font-red">*</span>';
                html += '<div class="errorMessage"></div>';
                html += '</div>';
                html += '<div class="hidden" name="unitName">';
                html += '<select name="toMaterialToolss[' + i + '].unit" style="width: 90%;height:23px">';
                html += '<option value="">--------请选择--------</option>';
                if (toolUnitList) {
                    $.each(toolUnitList, function (j, vv) {
                        if (vv.VALUE == v.unit) {
                            html += '<option selected="selected" value="' + vv.VALUE + '">' + vv.VALUE + '</option>';
                        } else {
                            html += '<option value="' + vv.VALUE + '">' + vv.VALUE + '</option>';
                        }
                    });
                }
                html += '</select>';
                html += '<span class="td-font-red">*</span>';
                html += '<div class="errorMessage"></div>';
                html += '</div>';
            }
            html += '</td>';
            html += '<td class="td-line30-center" style="display:none;">';
            html += '<input name="toMaterialToolss[' + i + '].id" type="hidden" value="' + v.id + '"/>';
            html += '</td>';
            html += '<td class="td-line30-center">';
            html += '<img height="19" name="del" onclick="delete_material_tools_tr(this,' + v.id + ')" ' +
                'src="/images/ico_cut.gif" style="cursor:pointer" title="Delete" width="18"/>';
            html += '</td>';
            html += '</tr>';
        });
        $("#toMaterialToolsHtml").after(html);
    }

//双重维修查询
    function checkDm(val) {
        if(!!val){
            InitGatewayRequest_({
                type: "post",
                async: false,
                data: {
                    ata:val,
                    applyType:'APL',
                    // acReg:$("#ac").textbox("getValue"),
                    applyId:$("#acId").html(),
                    // applyId:3,
                    // model: global_data.model,
                    // minorModel: global_data.minorModel
                },
                path: "/maintenanceProduction/maintainLimit/selectDmLimit",
                successCallBack: function (jdata) {
                    if (jdata.success == true) {
                        $("#dmZhezhao").remove();
                        if(jdata.obj.isDm && jdata.obj.isDm == 1){
                            $("#dm_type_id").children().eq(0).prop("checked", "checked");
                            var zhezhaoDom = '<div id="dmZhezhao"></div>';
                            $("#dm_type_id").append(zhezhaoDom);
                        }else{
                            $("#dmZhezhao").remove();
                        }
                    } else {
                        MsgAlert({content: jdata.errorMessage, type: 'error'});
                    }
                }
            });
        };
    }

    //ATA数据查询
    var ataData=[] ;
    function ataDataSearch(){
        //这里必须使用两种取值方式，getValue取值是选择组件里包含的真实值，getText是组件里的显示的值
        //正常输入两个值相等，当使用上下键选择的时候就会出现不同的结果
        var model = $("#model").val() || "";
        var ata = $("#ata").textbox("getValue");
        var ataText = $('#ata').combobox('getText');
        //只针对nrc编辑的时候，判断是否发动机类型,是就加上发动机参数，不是就直接传空值
        var engine = "";
        // if ($("#faji").is(":checked")) {
        //     engine = $("#ac_type_input").textbox("getValue");
        // }else if ($("#feiji").is(":checked")){
        //     model = $("#ac_type_input").textbox("getValue").slice(0, 4)|| "";
        // };
        //根据按上下键选择选项的时候，输入框一定超过4个字符的特性，防止在选择的时候进行搜索
        if(ata.length > 1 && ataText.length<5) {
            $.ajax({
                url: "/api/v1/ata/selectBmManualAtaByFleetAndAta?fleet=" + model + "&ata=" + ata + "&engine="+engine,
                dataType: "json",
                contentType: 'application/json;charset=utf-8',
                type: 'POST',
                // data: postData,
                async: true,
                cache: false,
                success: function (obj, textStatus) {
                    var getData = obj.data;
                    ataData = [];
                    for (var i = 0; i < getData.length; i++) {
                        var labelValue = {};
                        if(!!getData[i].companyCode && getData[i].companyCode == '1'){
                            //根据后端返回的标识确定输入章节号+手册名称+发动机型号+标题
                            if(!!getData[i].engine){
                                labelValue.label = getData[i].chapter + " " + getData[i].manualType + " "+getData[i].engine + " " + getData[i].title;
                            }else {
                                labelValue.label = getData[i].chapter + " " + getData[i].manualType +  " " + getData[i].title;
                            };
                        }else {
                            labelValue.label = getData[i].chapter + " " + getData[i].title;
                        };
                        //加上空格号是为了在输入一个正确四位ATA的时候，不要把数组第一个给带进来
                        labelValue.value = getData[i].chapter+" ";
                        ataData.push(labelValue);
                    };
                    $('#ata').combobox('loadData', ataData);
                },
                error: function () {
                    ajaxLoadEnd();
                    $('#saveBtn').text("保存");
                }
            });
        }
    }

    //ATA组件初始化
    function ataSelectInit(modelTips){
        //selectFlage 用来解决当清空后直接按回车键导致重新赋值的问题
        var selectFlage = 0;
        var modelTips = modelTips||"建议先选择‘Flight NO.’";
        $("#ata").combobox({
            editable: true,
            data:ataData,
            panelHeight: 160,
            valueField: 'value',
            textField: 'label',
            width:300,
            hasDownArrow:true,
            multiple:false,
            //在选择的时候做操作
            onSelect: (val) => {
                selectFlage = 1;
                // checkDm(val)
            },
            onLoadSuccess : () => {
            },
            onChange:()=>{
                selectFlage = 0;
                var inputAta = $("#ata").combobox('getText');
                var ac = $("#model").val()||"";
                if(!ac && inputAta.length == 1 && modelTips != "hideTips"){
                    MsgAlert({type: "tip", content: modelTips});
                };
                ataDataSearch();
                if(inputAta.length > 3){
                    var postAta = inputAta.slice(0, 4);
                    checkDm(postAta);
                };
            }
        });
        //eventAta 用来解决使用上下键+回车键选择后，失去焦点时数据被清空需要重新进行赋值的问题
        var eventAta = "";
        $("#ata").next("span").children("input:first").blur(function () {
            //如果使用回车键选中
            setTimeout(function(){
                var ataNow = $("#ata").textbox("getValue")||eventAta;
                if(ataNow.length>3 && !!selectFlage){
                    $("#ata").textbox("setValue", ataNow.slice(0,4));
                }else if(ataNow.length<4 || !selectFlage){
                    $("#ata").textbox("setValue", "");
                }
            },300);});
        //解决当用户输入一个正确的四位章节号后，点击回车键出现输入框带入描述的问题
        $("#ata").next("span").children("input:first").keydown(function () {
            if(event.keyCode == "13") {
                var ataNow = $("#ata").combobox('getText');
                if(ataNow.length>3){
                    $("#ata").textbox("setValue", ataNow.slice(0,4));
                    eventAta = ataNow.slice(0,4);
                    selectFlage = 1;
                }
            }
        });
        $("#ata").next("span").children("input:first").focus(function () {
            var getAtaData = $("#ata").combobox('getText');
            if(!!getAtaData && getAtaData.length == 4){
                selectFlage = 1;
            };
        });
    }



</script>
</body>
</html>