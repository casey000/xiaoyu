<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>

    <title>装机验证类的TO</title>

    <!-- load css -->
    <link href="/css/mccdoc/to_commons.css" rel="stylesheet" type="text/css"/>
    <link href="/css/nrc/nrc_add.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/icon.css">
    <link rel="stylesheet" type="text/css" href="/css/plugins/easyui/themes/bootstrap/easyui.css" id="swicth-style"/>
    <link rel="stylesheet" type="text/css" href="/css/plugins/easyui/themes/icon.css"/>
    <link rel="stylesheet" type="text/css" href="/css/plugins/easyui/themes/color.css"/>
    <!-- load js -->
    <script src="/js/global_var.js" type="text/javascript"></script>
    <script src="/js/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/plugins/easyui/jquery.easyui.custom.min.js"></script>
    <script type="text/javascript" src="/js/plugins/easyui/locale/easyui-lang-zh_CN.js"></script>
    <script src="/js/jquery/lhgdialog/lhgdialog.js" type="text/javascript"></script>
    <script src="/js/sfa-query-1.0.js" type="text/javaScript"></script>
    <script src="/js/common_query_dialog.js" type="text/javaScript"></script>
    <script src="/views/defect/pnSelect.js" type="text/javascript"></script>
    <script src="/js/plugins/easyui/plugins/jquery.validatebox.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
    <script src="/js/common.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/env.js"></script>
    <script src="/js/constants.js" type="text/javascript"></script>
    <script src="/js/base64.js" type="text/javascript"></script>
    <script src="/js/mccdoc/common/to_common.js" type="text/javascript"></script>
    <!--    <script src="/js/mccdoc/edit/edit_fault_isolate_to.js" type="text/javascript"></script>-->
    <style type="text/css">
        .returnButton {
            float: right;
            margin-right: 10px;
            padding: 0px 24px;
        }
        textarea{
            margin: 0em;
        }
        #dmZhezhao{
            width: 100%;
            height: 100%;
            background-color:rgba(255, 255, 255, 0.4);
            /*border-left: 1px solid #CCCCCC;*/
            /*display: none;*/
            position: absolute;
            z-index: 9;
            top: 0px;
            right: 0px;
        }
    </style>
</head>
<body>
<form action="" id="add_form" method="post">
    <table border="1" cellpadding="0" cellspacing="0" class="table-zi" style="padding-top:10px" width="100%">
        <tr>
            <td class="td-line30-with-bg" width="20%">类型</td>
            <td width="40%">
                装机验证
                <input id="dmType" name="toBaseInfo.dmType" tails="" type="hidden" value=""/>
                <input id="toBaseInfoId" name="toBaseInfo.id" type="hidden" value=""/>
                <input id="toBaseInfoType" name="toBaseInfo.type" type="hidden" value=""/>
                <input id="delTOMaterialToolsId" name="toBaseInfo.delTOMaterialToolsId" type="hidden" value=""/>
                <div id="acId" style="display: none"></div>
            </td>
            <td class="td-line30-with-bg" width="20%">版本号</td>
            <td width="20%">R0
            </td>
        </tr>

        <tr>
            <td class="td-line30-with-bg">
                装机验证申请单
            </td>
            <td>
                <input id="grabNo" name="toBaseInfo.grabNo" readonly="readonly"
                       style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
            <td class="td-line30-with-bg">恢复目标类型</td>
            <td>
                <span id = "install_type"></span>
            </td>
        </tr>
        <tr class="feiji">
            <td class="td-line30-with-bg">机型</td>
            <td>
                <input id="model" name="toBaseInfo.model" readonly="readonly"
                       style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
            <td class="td-line30-with-bg">飞机号</td>
            <td>
                <input id="acReg" name="toBaseInfo.acReg"  class="easyui-combobox"
                       style="background-color: #f0f0f0;width: 53%"
                       type="text" value=""/>
            </td>
        </tr>
<!--        <tr class="beijian">-->
<!--            <td class="td-line30-with-bg">拆自件号</td>-->
<!--            <td>-->
<!--                <input id="grabPn" name="toBaseInfo.grabPn" readonly="readonly"-->
<!--                       style="background-color: #f0f0f0;width: 53%"-->
<!--                       type="text" value=""/>-->
<!--            </td>-->
<!--            <td class="td-line30-with-bg">拆自序号</td>-->
<!--            <td>-->
<!--                <input id="grabSn" name="toBaseInfo.grabSn" readonly="readonly"-->
<!--                       style="background-color: #f0f0f0;width: 53%"-->
<!--                       type="text" value=""/>-->
<!--            </td>-->
<!--        </tr>-->
        <tr>
            <td class="td-line30-with-bg">章节号 <span class="td-font-red">*</span></td>
            <td>
<!--                <input id="ata" name="toBaseInfo.ata" maxlength="4"-->
<!--                       style="width: 53%;background-color: #f0f0f0; cursor: default;" type="text" value=""/>-->
                <input name="toBaseInfo.ata" class="easyui-textbox" id="ata" >
                <div class="errorMessage"></div>
            </td>
            <td class="td-line30-with-bg">DM</td>
            <td id="dm_type_id" style="position: relative">
                <input type="radio" id="dm-yes" name="dm"><label for="dm-yes">Yes</label>
                <input type="radio" id="dm-no" name="dm"><label for="dm-no">NO</label>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg">反馈要求<span class="td-font-red" style="margin-left: 40px">*</span></td>
            <td>
                <input id="yes" name="toBaseInfo.feedbackRequests" type="radio" value="y"/>
                <label for="yes">YES</label>
                &nbsp;&nbsp;
                <input id="no" name="toBaseInfo.feedbackRequests" type="radio" value="n"
                       style="margin-left: 40px"/>
                <label for="no">NO</label>
                &nbsp;

                <div class="errorMessage"></div>
            </td>
            <td class="td-line30-with-bg">
                <span class="td-line30-with-bg-center" style="border-top: none;">责任单位 <span class="td-font-red" style="margin-left: 40px">*</span></span>
            </td>
            <td>
                <input type="radio" id="technology_support" name="toBaseInfo.sourceType" value="0" checked="checked"
                       readonly="readonly">技术支援
                <input type="radio" id="borrow_mcc" name="toBaseInfo.sourceType" value="1" disabled="disabled"
                       style="margin-left: 40px"
                >MCC

                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg" colspan="4">待验证部件详情</td>
        </tr>
        <tr>
            <td colspan="4">
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="return_component_table"
                       style="border-top: none;" width="100%">
                    <tr>
                        <td class="td-line30-with-bg-center" style="border-top: none;width: 20%">件号名称</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">P/N</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;">序号</td>
<!--                        <td class="td-line30-with-bg-center" style="border-top: none;">参考位置</td>-->
                    </tr>
                </table>
            </td>
        </tr>

        <tr>
            <td class="td-line30-with-bg">标题 <span class="td-font-red">*</span></td>
            <td colspan="3">
                <textarea id="subject" maxlength="3000" name="toBaseInfo.subject"
                          style="width:99%;height:40px"></textarea>

                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg">描述</td>
            <td colspan="3">
                <span style="width: 100%">如果测试通过  <span class="td-font-red">*</span></span>
                <textarea id="description1" maxlength="1000" name="toBaseInfo.passTest"
                          style="width:99%;height:30px" placeholder="如果测试通过给下一个流程人员的提示"></textarea>

                <!--                <div class="errorMessage"></div>-->
                <span style="width: 100%">如果测试不通过    <span class="td-font-red">*</span></span>
                <textarea id="description2" maxlength="1000" name="toBaseInfo.passTestNot"
                          style="width:99%;height:30px" placeholder="如果测试不通过给下一个流程人员的提示"></textarea>

                <!--                <div class="errorMessage"></div>-->
                <span style="width: 100%">如有问题请联系技术支援处 <span class="td-font-red">*</span></span>
                <textarea id="description3" maxlength="1000" name="toBaseInfo.connectForHelp"
                          style="width:99%;height:30px" placeholder="请在此写下当出现问题时候技术支援部联系方式"></textarea>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="td-line30-with-bg" colspan="4">
                <span style="line-height: 23px">航材需求</span>
                <!--            <button class="returnButton" id = "delete">删除</button>-->
                <button class="returnButton" id="add" onclick="add_return_tool();return false;">添加</button>
            </td>
        </tr>
        <tr>
            <td colspan="4">
                <!--Trouble-shooting begin -->
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="add_return_aviation_table"
                       style="border-top: none;" width="100%">
                    <tr id = "add_return_aviation_table_show">
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="20%">件号名称</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="18%">P/N</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="17%">序号</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="16%">数量</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="16%">单位</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="13%">操作</td>
                    </tr>
                    <tr id="addReturnAviationHtml" style="display: none">
                        <td class="td-line30-center" style="display: none">0</td>
                        <td class="td-line30-center">
                            <input maxlength="600" name="" style="width: 90%;height: 20px" type="text" disabled="disabled"/>
                            <span class="td-font-red">*</span>
                            <div class="errorMessage"></div>
                        </td>
                        <td class="td-line30-center">
                            <input maxlength="100" name="" style="width: 80%;height: 20px" type="text" disabled="disabled"/>
                            <span class="td-font-red">*</span>
                            <img class="add_del" height="16" id="dbpns" onclick="searchPnNumber(this);return false;"
                                 src="/images/ico_search_16.gif" style="cursor:pointer" ttype="manual_doc" width="16"/>
                            <div class="errorMessage"></div>
                        </td>
                        <td class="td-line30-center">
                            <input class="sequence" maxlength="10" name="" style="width: 80%;height: 20px" type="text" disabled="disabled"/>
<!--                            <span class="td-font-red">*</span>-->
<!--                            <div class="errorMessage"></div>-->
                        </td>
                        <td class="td-line30-center">
                            <input class="number" maxlength="10" name="" style="width: 80%;height: 20px" type="text" disabled="disabled"/>
                            <span class="td-font-red">*</span>
                            <div class="errorMessage"></div>
                        </td>
                        <td class="td-line30-center">
                            <!-- 航材单位 -->
                            <div name="materialName">
                                <select id="materialNameSelect" style="width: 90%;height:23px" disabled="disabled">
                                    <option value="">--------请选择--------</option>
                                </select>
                                <span class="td-font-red">*</span>
                                <div class="errorMessage"></div>
                            </div>

                            <!-- 工具单位 -->
                            <div class="hidden" name="unitName">
                                <select id="unitNameSelect" style="width: 90%;height:23px" disabled="disabled">
                                    <option value="">--------请选择--------</option>
                                </select>
                                <span class="td-font-red">*</span>
                                <div class="errorMessage"></div>
                            </div>
                        </td>
                        <td class="td-line30-center">
                            <img height="19" name="del" onclick="delete_return_aviation_table(this,'')"
                                 src="/images/ico_cut.gif" style="cursor:pointer" title="Delete" width="18"/>
                        </td>
                    </tr>
                </table>
                <!--Trouble-shooting end -->
            </td>
        </tr>
        <tr>
            <td class="key">附件</td>
            <td colspan="6" id="attachament_td">
                <div id="attach_file">

                </div>
            </td>
        </tr>
        <tr>
            <td class="tab_title_background" colspan="4" style="text-align: right;">
                <!--<input type="button" value="提交" style="width: 50px;height: 25px;cursor: pointer;" onclick="to_subim()">-->
            </td>

        </tr>
    </table>
</form>
<script type="text/javascript">
    var sub_win, P, s_params = {};
    var obj = {};
    var lisr_file = 0;
    if (frameElement && frameElement.api) {
        sub_win = frameElement.api;
        var toMaterialToolssLength = 0;
        P = sub_win.opener;
        s_params = sub_win.data;
        sub_win.button(
            {
                name: 'Submit',
                callback: function () {
                    doSubmit();
                    return false;
                }
            },{
                name: 'Save',
                callback: function () {
                    saveForm();
                    return false;
                }
            },
            {
                name: 'Cancel'
            }
        );
    } else {
        s_params = getParentParam2_()
    }
    console.log(s_params);
    $(function () {
        $.ajax({
            type: "GET",
            url: "/api/v1/mccdoc/to_base_info/editOrView?id=" + s_params.id,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                obj = data.data;
                $("#grabNo").val(obj.toBaseInfoVO.grabNo);
                //恢复目标类型
                $("#install_type").html(obj.toBaseInfoVO.verifyType);

                if (obj.toBaseInfoVO.grabSource == 'AIRCRAFT') {
                    $(".beijian").hide();
                } else if (obj.toBaseInfoVO.grabSource == 'REPLACEMENT') {
                    $(".feiji").hide();
                }
                //DM显示
                if (obj.toBaseInfoVO.dmType == 'DM') {
                    $('#dm-yes').attr('checked', true);
                } else if (obj.toBaseInfoVO.dmType == 'n') {
                    $('#dm-no').attr('checked', true);
                }
                //反馈要求
                if (obj.toBaseInfoVO.feedbackRequests == 'y') {
                    $('#yes').attr('checked', true);
                } else if (obj.toBaseInfoVO.feedbackRequests == 'n') {
                    $('#no').attr('checked', true);
                }
                //描述
                if(!!obj.toBaseInfoVO.description.match(/如果测试通过：(\S*)；如果测试不通过/)){
                    var description1 = obj.toBaseInfoVO.description.match(/如果测试通过：(\S*)；如果测试不通过/)[1];
                    var description2 = obj.toBaseInfoVO.description.match(/如果测试不通过：(\S*)；如有问题请/)[1];
                    var description3 = obj.toBaseInfoVO.description.match(/联系技术支援处：(\S*)/)[1];
                    $("#description1").val(description1);
                    $("#description2").val(description2);
                    $("#description3").val(description3);
                };


                $("#model").val(obj.toBaseInfoVO.model);
                // $("#ata").val(obj.toBaseInfoVO.ata);
                $("#acId").html(obj.toBaseInfoVO.acId||"");
                // $("#acReg").val(obj.toBaseInfoVO.acReg);
                // $("#grabPn").val(obj.toBaseInfoVO.grabPn);
                // $("#grabSn").val(obj.toBaseInfoVO.grabSn);
                $("#grabRemark").val(obj.toBaseInfoVO.grabRemark);
                $("#description").val(obj.toBaseInfoVO.description);
                //标题
                debugger
                // var subjectTitle = obj.toBaseInfoVO.subject + obj.toGrabs[0].name;
                $("#subject").val(obj.toBaseInfoVO.subject);
                // $("#subject").val(obj.toBaseInfoVO.subject);
                add_file_show( s_params.id);
                //归还部件详情
                for (var i in obj.toGrabs) {
                    let file = " <tr >\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"name1" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"pn1" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"sn1" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        // "                        <td class=\"td-line30-center\"><span id=\"pst" + obj.toGrabs[i].id + "\"></span></td>\n" +
                        "                    </tr>";
                    let html_row = $(file);
                    $("#return_component_table").append(html_row);
                    $("#name1" + obj.toGrabs[i].id).text(obj.toGrabs[i].name);
                    $("#pn1" + obj.toGrabs[i].id).text(obj.toGrabs[i].pn);
                    $("#sn1" + obj.toGrabs[i].id).text(obj.toGrabs[i].sn);
                    // $("#pst" + obj.toGrabs[i].id).text(obj.toGrabs[i].position);
                }
                //记录传来的航材需求数据条数
                toMaterialToolssLength = obj.toMaterialToolss.length;
                // 航材需求start
                for (var i in obj.toMaterialToolss) {
                    let file = " <tr >\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"neet_name" + obj.toMaterialToolss[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"neet_pn" + obj.toMaterialToolss[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"neet_sn" + obj.toMaterialToolss[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"neet_qty" + obj.toMaterialToolss[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"neet_unit" + obj.toMaterialToolss[i].id + "\"></span></td>\n" +
                        "                        <td class=\"td-line30-center\"><span id=\"neet_oper" + obj.toMaterialToolss[i].id + "\"></span></td>\n" +
                        "                    </tr>";
                    let html_row = $(file);
                    $(html_row).insertAfter("#add_return_aviation_table_show");
                    $("#neet_name" + obj.toMaterialToolss[i].id).text(obj.toMaterialToolss[i].name);
                    $("#neet_pn" + obj.toMaterialToolss[i].id).text(obj.toMaterialToolss[i].pn);
                    // $("#neet_sn" + obj.toMaterialToolss[i].id).text(obj.toMaterialToolss[i].sn);
                    if(obj.toMaterialToolss[i].sn==null){
                        $("#neet_sn" + obj.toMaterialToolss[i].id).text("");
                    }else {
                        $("#neet_sn" + obj.toMaterialToolss[i].id).text(obj.toMaterialToolss[i].sn);
                    };
                    $("#neet_qty" + obj.toMaterialToolss[i].id).text(obj.toMaterialToolss[i].qty);
                    $("#neet_unit" + obj.toMaterialToolss[i].id).text(obj.toMaterialToolss[i].unit);
                }
                getDataDictionary();
                add_atta_input_flie();
                // 航材需求end
                checkDm(obj.toBaseInfoVO.ata);
                getAirTypeData();
            },
            error: function (obj) {
                alert("失败！");
            }
        });
        ataSelectInit("hideTips");
        setTimeout(function () {
            $('#acReg').combobox('setValue',obj.toBaseInfoVO.acReg);
            $("#ata").textbox("setValue",obj.toBaseInfoVO.ata)
        },500)
    });

    function qiangjian_data() {

    }
    //删除已添加附件
    function deleteFile(fileid) {
        var _url = basePath + "/api/v1/mccdoc/to_base_info/deleteAttachment";
        P.$.dialog.confirm('Delete Selected ?', function () {
            $.ajax({
                url: _url,
                type: "get",
                data: {'pkid': fileid},
                dataType: "json",
                cache: false,
                success: function (data) {
                    if (data.code == 200) {
                        P.$.dialog.alert("Success");
                        $("#qc_table_detail #appendTr").remove();
                        add_file_show(s_params.id);
                    }
                }
            });
        }, function () {
        });
    }
    //增加文件
    function add_file_show(id) {
        $("#attach_file").empty();
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: id,
                CATEGORY: "installationVerification",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                for (var ind in jdata.data) {
                    let file = " <div id=\"input_flie_show" + jdata.data[ind].PKID + "\" class=\"atta_input_fliecss\" style=\"line-height: 30px;width: 100%;    height: 30px;border-bottom: 1px solid #ccc;\">\n" +
                        "                            <div style=\"width: 60%;text-align: left;\"><a style=\"color:red;font-size: 14px\" onclick=\"downFile(" + jdata.data[ind].PKID + "," + jdata.data[ind].PKID + ")\">" + jdata.data[ind].ORG_NAME + "</a></div>\n" +
                        "\n" +
                        "                        <div class=\"jianhao icon-delete\" onclick=\"deleteFile(" + jdata.data[ind].PKID + ")\"></div>\n" +
                        "                        </div>";
                    let html_row = $(file);
                    $("#attach_file").append(html_row);
                }

            }
        });
    }
    //添加归还航材
    function add_return_tool() {
        var _table = $("#add_return_aviation_table");

        var _node = _table.find("tr").last().clone(true);

        _node.removeAttr("style");
        _node.find("input").removeAttr("disabled");
        _node.find("select").removeAttr("disabled");

        var _findTd = _node.find("td:eq(0)");

        var _index = _findTd.text();

        _findTd.text(Number(_index) + 1);

        //设置Name的name值
        _node.find("td:eq(1)").find(":input").attr("name", "toMaterialToolss[" + Number(_index) + "].name");
        //设置P/N的name值
        _node.find("td:eq(2)").find(":input").attr("name", "toMaterialToolss[" + Number(_index) + "].pn");
        //设置Tools的name值
        _node.find("td:eq(3)").find(":input").attr("name", "toMaterialToolss[" + Number(_index) + "].sn");
        //设置QTY的name值
        _node.find("td:eq(4)").find(":input").attr("name", "toMaterialToolss[" + Number(_index) + "].qty");
        //设置UNIT的name值
        _node.find("td:eq(5)").find(":input").attr("name", "toMaterialToolss[" + Number(_index) + "].unit");

        //设置UNIT中工具DIV的class
        _node.find("td:eq(5)").find("div[name='unitName']").attr("class", "hidden");
        //设置UNIT中航材DIV的class
        _node.find("td:eq(5)").find("div[name='materialName']").attr("class", "");
        //清空select输入框中的值
        _node.find("td:eq(5)").find("div[name='unitName']").find("select").val("");
        _node.find("td:eq(5)").find("div[name='materialName']").find("select").val("");
        //清空input输入框中的值
        _node.find("input[type='text']").val("");
        //清空提示
        _node.find(".error").remove();

        //新增一行要添加按钮单击事件
        _node.find("td:eq(2)").find("img").show();
        //移除件号框只读属性
        if (!_node.find("td:eq(2)").find("input").attr("readonly")) {
            _node.find("td:eq(2)").find("input").attr("readonly", "readonly");
            //_node.find("td:eq(1)").find("input").attr("readonly","readonly");
        }
        _table.append(_node);
    }

    //删除工具航材
    function delete_return_aviation_table(_obj) {
        debugger
        if ($("#add_return_aviation_table").find("tr").length > 2) {
            if (confirm("你确定要删除当前行吗 ?")) {
                //删除
                $(_obj).parent().parent().remove();
                //删除后重新排序
                var _trArray = $("#add_return_aviation_table").find("tr:gt(1)");
                if (_trArray) {
                    _trArray.each(function (index_, value_) {
                        $(value_).find("td:first").text(index_ + 1);
                        $(value_).find("td:eq(1)").find(":input").attr("name", "toMaterialToolss[" + Number(index_-1) + "].name");
                        $(value_).find("td:eq(2)").find(":input").attr("name", "toMaterialToolss[" + Number(index_-1) + "].pn");
                        $(value_).find("td:eq(3)").find(":input").attr("name", "toMaterialToolss[" + Number(index_-1) + "].sn");
                        $(value_).find("td:eq(4)").find(":input").attr("name", "toMaterialToolss[" + Number(index_-1) + "].qty");
                        $(value_).find("td:eq(5)").find(":input").attr("name", "toMaterialToolss[" + Number(index_-1) + "].unit");
                    });
                }

            }
        }
    }


    /**
     * 验证Form表单
     */
    function validForm() {

        var isValid = false;
        $("#add_form .error").remove();
        var errMsg = '<span class="error">This field is required.</span>';
        var errMsg1 = '<span class="error">The length is greater than 3000 bytes.</span>';
        var numberErrMsg = '<span class="error">Please enter only digits.</span>';

        if (!$("[name='toBaseInfo.ata']").val()) {
            $("[name='toBaseInfo.ata']").nextAll("div.errorMessage").append(errMsg);
        }else{
            let pattern = /^\d{4}$/;
            if (!pattern.test($("[name='toBaseInfo.ata']").val())) {
                $("[name='toBaseInfo.ata']").nextAll("div.errorMessage").append( '<span class="error">章节只能输入4位数字.</span>');
            }
        }

        if (!$("[name='toBaseInfo.acId']").val()) {
            $("[name='toBaseInfo.acId']").nextAll("div.errorMessage").append(errMsg);
        }

        if ($("input:radio[name='toBaseInfo.feedbackRequests']:checked").val() == null) {
            $("[name='toBaseInfo.feedbackRequests']").nextAll("div.errorMessage").append(errMsg);
        }

        if ($("input:radio[name='toBaseInfo.sourceType']:checked").val() == null) {
            $("[name='toBaseInfo.sourceType']").nextAll("div.errorMessage").append(errMsg);
        }

        if (!$("[name='toBaseInfo.subject']").val()) {
            $("[name='toBaseInfo.subject']").nextAll("div.errorMessage").append(errMsg);
        }

        // var description = $("[name='toBaseInfo.description']").val();
        // if (!description) {
        //     $("[name='toBaseInfo.description']").nextAll("div.errorMessage1").append(errMsg);
        // }
        //三个说明
        var description1 = $("#description1").val();
        var description2 = $("#description2").val();
        var description3 = $("#description3").val();
        if (!description1 | !description2 | !description3) {

            // $("[name='toBaseInfo.connectForHelp ']").nextAll("div.errorMessage").append(errMsg);
            alert("请填写完描述的3种情况")
            isValid = true;
        }
        //三个说明
        //验证是否超过3000字节
        if (description1.replace(/[^\u0000-\u00ff]/g, "aaa").length > 3000) {
            $("[name='toBaseInfo.description']").nextAll("div.errorMessage").append(errMsg1);
        }
        if (description2.replace(/[^\u0000-\u00ff]/g, "aaa").length > 3000) {
            $("[name='toBaseInfo.description']").nextAll("div.errorMessage").append(errMsg1);
        }
        if (description3.replace(/[^\u0000-\u00ff]/g, "aaa").length > 3000) {
            $("[name='toBaseInfo.description']").nextAll("div.errorMessage").append(errMsg1);
        }
        //获取航材工具从后端传来的数据length
        var toMaterialToolssLengthAdd = toMaterialToolssLength + 1;
        //获取Required Material/Special Tools下面的工具航材
        var materialToolSelect = $("#add_return_aviation_table").find("tr:gt("+(toMaterialToolssLengthAdd)+")");
        //如果存在必须要填写
        if (materialToolSelect) {
            $.each(materialToolSelect, function (index, value) {

                if (!$.trim($(value).find("td:eq(1)").find(":input").val())) {
                    $(value).find("td:eq(1)").find(":input").nextAll("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if (!$.trim($(value).find("td:eq(2)").find(":input").val())) {
                    $(value).find("td:eq(2)").find(":input").nextAll("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if (!$.trim($(value).find("td:eq(4)").find(":input").val())) {
                    $(value).find("td:eq(4)").find(":input").nextAll("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if ((!$.trim($(value).find("td:eq(5)").find("div[class!='hidden'][class!='errorMessage']").children("select").val()))) {
                    $(value).find("td:eq(5)").find("div[class!='hidden'][class!='errorMessage']").children("div.errorMessage").append(errMsg);
                    isValid = true;
                }

                if (isNaN($.trim($(value).find("td:eq(4)").find(":input").val()))) {
                    $(value).find("td:eq(4)").find(":input").nextAll("div.errorMessage").append(numberErrMsg);
                    isValid = true;
                }
            });
        }
        checkDMfn && checkDMfn.call();
        if ($("#add_form .errorMessage").text()) {
            isValid = true;
        }
        return isValid;
    }

    //添加附件功能
    function add_file(i) {

        let file = " <div id=\"atta_input_flie_" + i + "\" class=\"atta_input_fliecss atta_input_fliecss_move\">\n" +
            "       <input class=\"textbox easyui-validatebox\" type=\"file\" id=\"atta_input_flie_a" + i + "\" size=\"300\" name=\"file\" data-options=\"required:true\"/>            \n" +
            "                    <div class=\"add_jiahao\" onclick=\"add_atta_input_flie()\" style='margin-top: 5px'></div>\n" +
            " <div class='file_duihao' onclick=\"atta_input_flie('atta_input_flie_a'+" + i + ")\">✔</div>\n" +
            "                    <div class=\"jianhao icon-delete\" onclick=\"delete_atta_input_flie(atta_input_flie_" + i + ")\" style='margin-top: 4px'></div>\n" +
            "                </div>";
        let html_row = $(file);
        $("#attachament_td").append(html_row);
    }
    //附件上传增加按钮
    function add_atta_input_flie() {
        add_file(lisr_file);
        lisr_file++;
    }
    //附件上传删除按钮
    function delete_atta_input_flie(val) {
        let geshu = document.getElementsByClassName('atta_input_fliecss_move');
        if (geshu.length == 1) {
            return
        }
        let newP = $(val);
        if (newP.length > 0) {
            newP.remove();
        }
    }
    //附件上传打钩按钮
    function atta_input_flie(id) {
        if ($("#ccid").val() != "") {
            var fileInput = $("#" + id).get(0).files[0];
            if (fileInput) {
                $.ajaxFileUpload({
                    url: Constant.API_URL + 'ATTACHMENT_UPLOAD',
                    secureuri: false,
                    fileElementId: id, //file控件id
                    dataType: 'json',
                    data: {
                        "fileCategory": "installationVerification",
                        "sourceId":  s_params.id,
                    },
                    success: function (data) {
                        if (data.code == 200) {
                            var file = document.getElementById("" + id + "");
                            file.value = '';
                            $("#" + id).value = "";
                            add_file_show( s_params.id);
                        }

                    }

                })
            } else {
                alert("请选择上传文件！");
            }
        } else {
            alert("请先保存，在上传附件！")
        }

    }
    /**
     * 提交
     * @returns {Boolean}
     */
    function doSubmit() {
        //移除报错
        $("#add_form .error").remove();
        //如果有报错跳出提交
        if ($("#add_form .errorMessage").text()) {
            return false;
        }
        //如果表单有错误跳出提交
        if (validForm()) {
            return false;
        }
        var actionUrl = basePath + "/api/v1/mccdoc/to_base_info/update";
        var params = $("#add_form").serialize();
        sub_win.button({name: 'Submit', disabled: true});
        sub_win.button({name: 'Cancel', disabled: true});
        debugger
        $.ajax({
            url: actionUrl,
            type: "post",
            data: params,
            dataType: "json",
            cache: false,
            success: function (data) {
                if (data.code == 200) {
                    P.$.dialog.alert('succ.');
                    sub_win.data['reload'] = '1';
                    sub_win.close();
                } else {
                    // sub_win.button({name: 'Save', disabled: false});
                    sub_win.button({name: 'Submit', disabled: false});
                    sub_win.button({name: 'Cancel', disabled: false});
                    if (data.msg) {
                        P.$.dialog.alert(data.msg);
                    } else {
                        P.$.dialog.alert('Submit failed, please contact the administrator.');
                    }
                }
            }
        });

        return false;
    }

    //    保存start
    function saveForm() {
        // //移除报错
        // $("#add_form .error").remove();
        // //如果有报错跳出提交
        // if ($("#add_form .errorMessage").text()) {
        //     return false;
        // }
        // //如果表单有错误跳出提交
        // if (validForm()) {
        //     return false;
        // }
        var actionUrl = basePath + "/api/v1/mccdoc/to_base_info/updateForSap";
        var params = $("#add_form").serialize();
        sub_win.button({name: 'Submit', disabled: true});
        sub_win.button({name: 'Save', disabled: true});
        sub_win.button({name: 'Cancel', disabled: true});

        $.ajax({
            url: actionUrl,
            type: "post",
            data: params,
            dataType: "json",
            cache: false,
            success: function (data) {
                // alert("保存成功");
                if (data.code == 200) {
                    P.$.dialog.alert('保存成功');
                    sub_win.data['reload'] = '1';
                    sub_win.button({name: 'Save', disabled: false});
                    sub_win.button({name: 'Submit', disabled: false});
                    sub_win.button({name: 'Cancel', disabled: false});
                    sub_win.close();
                } else {
                    sub_win.button({name: 'Save', disabled: false});
                    sub_win.button({name: 'Submit', disabled: false});
                    sub_win.button({name: 'Cancel', disabled: false});
                    if (data.msg) {
                        P.$.dialog.alert(data.msg);
                    } else {
                        P.$.dialog.alert('Submit failed, please contact the administrator.');
                    }
                }
            },
            error:function (obj) {
                alert("保存失败");
                sub_win.button({name: 'Save', disabled: false});
                sub_win.button({name: 'Submit', disabled: false});
                sub_win.button({name: 'Cancel', disabled: false});
            }
        });

        return false;
    }
    //    保存end

    //双重维修查询
    function checkDm(val) {
        if(!!val){
            InitGatewayRequest_({
                type: "post",
                async: false,
                data: {
                    ata:val,
                    applyType:'APL',
                    // acReg:$("#ac").textbox("getValue"),
                    applyId:$("#acId").html(),
                    // applyId:3,
                    // model: global_data.model,
                    // minorModel: global_data.minorModel
                },
                path: "/maintenanceProduction/maintainLimit/selectDmLimit",
                successCallBack: function (jdata) {
                    if (jdata.success == true) {
                        $("#dmZhezhao").remove();
                        if(jdata.obj.isDm && jdata.obj.isDm == 1){
                            $("#dm_type_id").children().eq(0).prop("checked", "checked");
                            var zhezhaoDom = '<div id="dmZhezhao"></div>';
                            $("#dm_type_id").append(zhezhaoDom);
                        }else{
                            $("#dmZhezhao").remove();
                        }
                    } else {
                        // MsgAlert({content: jdata.errorMessage, type: 'error'});
                        alert(jdata.errorMessage);
                    }
                }
            });
        };

    }

    //ATA数据查询
    var ataData=[] ;
    function ataDataSearch(){
        //这里必须使用两种取值方式，getValue取值是选择组件里包含的真实值，getText是组件里的显示的值
        //正常输入两个值相等，当使用上下键选择的时候就会出现不同的结果
        var model = $("#model").val() || "";
        var ata = $("#ata").textbox("getValue");
        var ataText = $('#ata').combobox('getText');
        //只针对nrc编辑的时候，判断是否发动机类型,是就加上发动机参数，不是就直接传空值
        var engine = "";
        // if ($("#faji").is(":checked")) {
        //     engine = $("#ac_type_input").textbox("getValue");
        // }else if ($("#feiji").is(":checked")){
        //     model = $("#ac_type_input").textbox("getValue").slice(0, 4)|| "";
        // };
        //根据按上下键选择选项的时候，输入框一定超过4个字符的特性，防止在选择的时候进行搜索
        if(ata.length > 1 && ataText.length<5) {
            $.ajax({
                url: "/api/v1/ata/selectBmManualAtaByFleetAndAta?fleet=" + model + "&ata=" + ata + "&engine="+engine,
                dataType: "json",
                contentType: 'application/json;charset=utf-8',
                type: 'POST',
                // data: postData,
                async: true,
                cache: false,
                success: function (obj, textStatus) {
                    var getData = obj.data;
                    ataData = [];
                    for (var i = 0; i < getData.length; i++) {
                        var labelValue = {};
                        if(!!getData[i].companyCode && getData[i].companyCode == '1'){
                            //根据后端返回的标识确定输入章节号+手册名称+发动机型号+标题
                            if(!!getData[i].engine){
                                labelValue.label = getData[i].chapter + " " + getData[i].manualType + " "+getData[i].engine + " " + getData[i].title;
                            }else {
                                labelValue.label = getData[i].chapter + " " + getData[i].manualType +  " " + getData[i].title;
                            };
                        }else {
                            labelValue.label = getData[i].chapter + " " + getData[i].title;
                        };
                        //加上空格号是为了在输入一个正确四位ATA的时候，不要把数组第一个给带进来
                        labelValue.value = getData[i].chapter+" ";
                        ataData.push(labelValue);
                    };
                    $('#ata').combobox('loadData', ataData);
                },
                error: function () {
                    ajaxLoadEnd();
                    $('#saveBtn').text("保存");
                }
            });
        }
    }

    //ATA组件初始化
    function ataSelectInit(modelTips){
        //selectFlage 用来解决当清空后直接按回车键导致重新赋值的问题
        var selectFlage = 0;
        var modelTips = modelTips||"建议先选择‘Flight NO.’";
        $("#ata").combobox({
            editable: true,
            data:ataData,
            panelHeight: 160,
            valueField: 'value',
            textField: 'label',
            width:300,
            hasDownArrow:true,
            multiple:false,
            //在选择的时候做操作
            onSelect: (val) => {
                selectFlage = 1;
                // checkDm(val)
            },
            onLoadSuccess : () => {
            },
            onChange:()=>{
                selectFlage = 0;
                var inputAta = $("#ata").combobox('getText');
                var ac = $("#model").val()||"";
                if(!ac && inputAta.length == 1 && modelTips != "hideTips"){
                    // MsgAlert({type: "tip", content: modelTips});
                    alert(modelTips);
                };
                ataDataSearch();
                if(inputAta.length > 3){
                    var postAta = inputAta.slice(0, 4);
                    checkDm(postAta);
                };
            }
        });
        //eventAta 用来解决使用上下键+回车键选择后，失去焦点时数据被清空需要重新进行赋值的问题
        var eventAta = "";
        $("#ata").next("span").children("input:first").blur(function () {
            //如果使用回车键选中
            setTimeout(function(){
                var ataNow = $("#ata").textbox("getValue")||eventAta;
                if(ataNow.length>3 && !!selectFlage){
                    $("#ata").textbox("setValue", ataNow.slice(0,4));
                }else if(ataNow.length<4 || !selectFlage){
                    $("#ata").textbox("setValue", "");
                }
            },300);});
        //解决当用户输入一个正确的四位章节号后，点击回车键出现输入框带入描述的问题
        $("#ata").next("span").children("input:first").keydown(function () {
            if(event.keyCode == "13") {
                var ataNow = $("#ata").combobox('getText');
                if(ataNow.length>3){
                    $("#ata").textbox("setValue", ataNow.slice(0,4));
                    eventAta = ataNow.slice(0,4);
                    selectFlage = 1;
                }
            }
        });
        $("#ata").next("span").children("input:first").focus(function () {
            var getAtaData = $("#ata").combobox('getText');
            if(!!getAtaData && getAtaData.length == 4){
                selectFlage = 1;
            };
        });
    }

    //请求飞机以及机型数据，选机型自动带出大机型
    function getAirTypeData(){
        var acRegData = [];
        $.ajax({
            type: "POST",
            url:"/api/v1/plugins/FLB_AC_LIST" ,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    if(data.data){
                        acRegData=data.data;
                    };
                    acRegData.map((item,key,acRegData)=>{
                        acRegData[key].pn_sn=acRegData[key].tail;
                    });
                    initAirSelect(acRegData);
                } else{
                    initAirSelect([]);
                };
            },
            error: function () {
                initAirSelect([]);
            }
        });
    };

//    机型选择组件初始化
    function initAirSelect(data){
        var selectVal = "";
        $("#acReg").combobox({
            valueField: 'tail',
            textField: 'pn_sn',
            data:data,
            // prompt: '请先选择查询类型飞机或者发动机',
            onHidePanel:function(){
                // var t = $(this).combobox('getValue');
                // if (selectVal==undefined || selectVal == null ||  t != selectVal.tail) {//没有选择或者选项不相等时清除内容
                //     $(this).combobox({value: ''});
                // }
            },
            onSelect: function (val) {
                selectVal=val;
                $('#acId').html( val.acId);
                $('#model').val( val.model);
            }
        });
    };


</script>
</body>
</html>