<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <title>基础信息管理</title>
    <!-- mcc模块的公用css -->
    <link href="/css/mccdoc/mcc_doc_commons.css" rel="stylesheet" type="text/css"/>
    <link href="/css/common.css" rel="stylesheet" type="text/css"/>
    <!-- load js -->
    <script src="/js/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script src="/js/jquery/lhgdialog/lhgdialog.js" type="text/javascript"></script>
    <script src="/js/jquery/ztree/jquery.ztree.core-3.4.js" type="text/javascript"></script>
    <script src="/js/jquery/ztree/jquery.ztree.excheck-3.4.js" type="text/javascript"></script>
    <script src="/js/global_var.js" type="text/JavaScript"></script>

    <script src="/js/date_utils.js" type="text/javascript"></script>
    <script src="/js/sfa-query-1.0.js" type="text/javascript"></script>
    <script src="/js/jquery.form.js" type="text/javascript"></script>
    <script src="/js/data/ata_utils.js" type="text/javascript"></script>
    <!-- 表单验证jquery.validate -->
    <script src="/js/jquery.validate.js" type="text/javascript"></script>
    <script src="/js/custom-validate.js" type="text/javascript"></script>
    <script src="/js/jquery.maxlength.js" type="text/javascript"></script>

    <!-- TE Edit专用js -->
    <script src="/js/mccdoc/edit/add_te.js" type="text/javascript"></script>

</head>
<body>
<form enctype="multipart/form-data" id="addForm" method="post">
    <input name="teBaseInfo.id" readonly="readonly" type="hidden" value="${teBaseInfo.id}"/>
    <table border="1" cellpadding="0" cellspacing="0" class="table-zi" style="padding-top:10px" width="100%">
        <tr>
            <td class="tab_title_background" width="20%">TE NO:</td>
            <td width="20%">${teBaseInfo.number}&nbsp;</td>
            <td class="tab_title_background" width="15%">Rev.:</td>
            <td width="15%">
                <c:if test="${not empty teBaseInfo.revNo}">R${teBaseInfo.revNo}</c:if>
                <c:if test="${empty teBaseInfo.revNo}">R0</c:if>
            </td>
            <td class="tab_title_background" width="15%">&nbsp;</td>
            <td width="15%">&nbsp;</td>
        </tr>
        <tr>
            <td class="tab_title_background" width="15%">Model:</td>
            <td>
                <input disabled="disabled" name="teBaseInfo.model" readonly="readonly" style="width: 90%"
                       value="${teBaseInfo.model}"/></td>
            <td class="tab_title_background">
                <s:text name="base.aircraft.tail"/>
                :
            </td>
            <td>
                <input name="teBaseInfo.acId" readonly="readonly" type="hidden" value="${teBaseInfo.acId}"/>
                <input name="teBaseInfo.acNo" onclick="getAirplaneInfo()" readonly="readonly" style="width:70%"
                       type="text" value="${teBaseInfo.acNo}"/>
                <img class="search_btn_img" height="16" onclick="getAirplaneInfo()"
                     src="/images/ico_search_16.gif" style="cursor:pointer;vertical-align: middle;" width="16"/><span
                    class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
            <td class="tab_title_background">ATA:</td>
            <td><input name="teBaseInfo.ata" style="width:90%" type="text" value="${teBaseInfo.ata}"/>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="tab_title_background">Evaluation Type：</td>
            <td colspan="5">&nbsp;
                <input id="evaluationTypes" type="hidden" value="${teBaseInfo.evaluationType}"/>
                <input name="teBaseInfo.evaluationType" type="checkbox" value="1"/>&nbsp;<span
                        style="vertical-align: middle;">飞机放行 A/C Release</span>&nbsp;&nbsp;
                <input name="teBaseInfo.evaluationType" type="checkbox" value="2"/>&nbsp;<span
                        style="vertical-align: middle;">航材验证 Material</span>&nbsp;&nbsp;
                <input name="teBaseInfo.evaluationType" type="checkbox" value="3"/>&nbsp;<span
                        style="vertical-align: middle;">维修提示 Main.Tip</span>&nbsp;&nbsp;
                <input name="teBaseInfo.evaluationType" type="checkbox" value="4"/>&nbsp;<span
                        style="vertical-align: middle;">其他 Other</span>&nbsp;&nbsp;
                <span class="td-font-red" style="float: right;margin-right:10px">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="tab_title_background">Description：</td>
            <td colspan="5">
                <textarea name="teBaseInfo.description"
                          style="width:97%;height:60px">${teBaseInfo.description}</textarea>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr id="attachmentTrId">
            <td class="tab_title_background" width="20%">Attachments:</td>
            <td colspan="5">
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="qc_table_detail"
                       style="padding-top:10px" width="100%">
                    <tr>
                        <td colspan="5">
                            <!--<div id="chosefile" style="border:solid 1px #bababa;width:30%; float:left;" onclick="choseFile(); return false ;">
                            <input value="选择文件" type="button" style="width: 30%;cursor: pointer;" />
                            <span id="showFileName"></span>
                            </div> -->
                            <span style="float: right; padding-right: 32px">
					<input onclick="showUploadDialog();return false;" style="cursor: pointer;" type="button"
                           value="upload"/>
					</span>
                        </td>
                    </tr>
                    <tr id="td_files">
                        <td class="td-line30-with-bg-center">Doc Name</td>
                        <td class="td-line30-with-bg-center">Doc Type</td>
                        <td class="td-line30-with-bg-center">Uploader</td>
                        <td class="td-line30-with-bg-center">Upload Date</td>
                        <td class="td-line30-with-bg-center">Operate</td>
                    </tr>
                </table>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="tab_title_background">Ref.Document:</td>
            <td colspan="5">
                <textarea name="teBaseInfo.refDocument"
                          style="width:97%;height:60px">${teBaseInfo.refDocument}</textarea>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr style="height: 80px">
            <td class="tab_title_background" rowspan="2">MCC技术支援席意见<br/>MCC Technical Support Advice:</td>
            <td colspan="5">
                <textarea name="teBaseInfo.technicalSupportAdvice" style="width:97%;height:80px;">${teBaseInfo.technicalSupportAdvice}</textarea>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="tab_title_background">Name:</td>
            <td colspan="2">${teBaseInfo.technicalSupportEngineerName}</td>
            <td class="tab_title_background">Date:</td>
            <td>
                <fmt:formatDate pattern="yyyy-MM-dd" value="${teBaseInfo.technicalSupportDate}"/>
            </td>
        </tr>
        <tr style="height: 80px;display: none;">
            <td class="tab_title_background" rowspan="2">MCC值班经理意见<br/>MCC Duty Manager Advice:</td>
            <td colspan="5">
                <textarea name="teBaseInfo.dutyManagerAdvice" style="width:97%;height:80px;">${teBaseInfo.dutyManagerAdvice}</textarea>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr style="display: none;">
            <td class="tab_title_background">Name:</td>
            <td colspan="2">${teBaseInfo.dutyManagerName}</td>
            <td class="tab_title_background">Date:</td>
            <td>${teBaseInfo.dutyManagerDate}</td>
        </tr>
        <tr style="height: 80px;display: none;">
            <td class="tab_title_background" rowspan="2">部门值班经理/系统工程师意见<br/>M&E Department Duty Manager/System Engineer
                Advice:
            </td>
            <td colspan="5">
                <textarea name="teBaseInfo.departmentDutyManagerAdvice" style="width:97%;height:80px;">${teBaseInfo.departmentDutyManagerAdvice}</textarea>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr style="display: none;">
            <td class="tab_title_background">Name:</td>
            <td colspan="2">${teBaseInfo.departmentDutyManagerName}</td>
            <td class="tab_title_background">Date:</td>
            <td>${teBaseInfo.departmentDutyManagerDate}</td>
        </tr>
    </table>
</form>

<script type="text/javascript">
    var entityId = '${teBaseInfo.id}';
    var status = '${teBaseInfo.editStatus}';
    var moduleForDb = '${attachmentPath}';
    var fileDelAble = true;

    function validForm() {

        var text = $(":file").val();

        if (!text) {

            var message = "Please choose a file !";

            P.$.dialog.alert(message);

            return false;
        }
        var maxIndex = text.lastIndexOf('\\') > text.lastIndexOf('/') ? text.lastIndexOf('\\') : text.lastIndexOf('/');
        if (text.substring(maxIndex + 1, text.lastIndexOf('.')).length > 100) {
            var message = "The file name length should be less than 100";
            P.$.dialog.alert(message);
            return false;
        }

        var fileCount = $("tr[name='fileList']").length;

        if (!(/\.pdf$/.test(text.toLowerCase()))) {
            var message = "The file should be one pdf .";
            P.$.dialog.alert(message);
            return false;
        }

        return true;
    }

    function showUploadDialog() {
        var parameters = {
            "methodType": "view",
            "entityId": entityId,
            "moduleForDb": moduleForDb
        };
        P.$.dialog({
            title: 'Upload Attachment',
            width: "500px",
            height: "100px",
            top: "25%",
            esc: true,
            cache: false,
            max: false,
            min: false,
            lock: true,
            parent: sub_win,
            close: function () {
                // 关闭后是否标注为要刷新
                if (this.data['reload'] && this.data['reload'] == true) {
                    searchAttachment();
                }
            },
            content: 'url:' + basePath + '/mccdoc/edit/te_upload_attachment.jsp',
            data: parameters
        });
    }


    function uploadAttachment(override) {

        $(".error").remove();

        if (!validForm()) {

            return false;
        }

        var params = {

            "entityId": entityId,

            "moduleForPath": moduleForDb,

            "moduleForDb": moduleForDb,

            "jsonData": override,

            'licenType': 'save'
        };

        var actionUrl = basePath + "/er/fileUploadAuxiliary_uploadFile.action";

        $("#uploadForm").ajaxSubmit({

            url: actionUrl,

            dataType: "json",

            data: params,

            cache: false,

            type: "post",

            success: function (obj, textStatus) {
                var data = JSON.parse(obj);

                if (data && data.ajaxResult == "failure") {

                    if (!data.errorIndex[0].type) {

                        P.$.dialog.alert(data.errorIndex[0].text);
                    }
                }

                if (data && data.ajaxResult == "success") {

                    P.$.dialog.success("File uploaded success!");

                    buildAttachment(data.filesObejct, "fileList", $("#td_files"), true);

                } else if (data && data.errorIndex) {

                    var duplicate = false;

                    $.each(data.errorIndex, function (i, n) {

                        var err_div = '<span class="error">' + n.text + '</span>';

                        $($(":file")[n.index]).nextAll(".errorMessage").append(err_div);

                        if (n.type) {

                            duplicate = true;
                        }
                    });

                    if (duplicate) {

                        P.$.dialog.alert("File is exist !");
                    }
                }
            }
        });
    }

    searchAttachment();

    function searchAttachment() {

        var actionSelectUrl = basePath + "/er/fileUploadAuxiliary_getAllFile.action";

        var params = {

            "entityId": entityId,

            "reliabilityTaskId": '',

            "moduleForPath": moduleForDb,

            "moduleForDb": moduleForDb,

            'licenType': 'select'
        };
        if (typeof (params.entityId) == "undefined" || (params.entityId + "") == "null" || params.entityId == "") {
            return;
        }

        $.ajax({

            url: actionSelectUrl,

            async: false,

            data: params,

            cache: false,

            type: "post",

            success: function (obj, textStatus) {

                if (obj) {

                    var data = JSON.parse(obj);

                    buildAttachment(data.filesObejct, "fileList", $("#td_files"), fileDelAble);

                    //buildAttachment(data.reliabilityFilesObejct,"reliabilityFileList",$("#reliability_committee_td_files"),false);
                }
            }
        });
    }

    function buildAttachment(_dataObj, divId, appendObj, isDel) {
        var _str = "";
        if (!!_dataObj) {
            $.each(_dataObj, function (i, _value) {
                if (_value && _value.name && _value.type && _value.uploadByName && _value.createDate && _value.id) {
                    _str += '<tr name="' + divId + '">';
                    _str += '  <td  class="td-line30-center">' + _value.name + '</td>';
                    _str += '  <td  class="td-line30-center">' + (_value.type && _value.type.toLowerCase()) + '</td>';
                    _str += '  <td  class="td-line30-center">' + _value.uploadByName + '</td>';
                    _str += '  <td  class="td-line30-center">' + _value.createDate + '</td>';
                    _str += '  <td  class="td-line30-center">';
                    _str += '    <div align="center" class="ui_buttons_upload" style="vertical-align: middle;">';
                    if (!isDel) {
                        _str += '        <input type="button" onclick="download(' + _value.id + ')" value="Download" style="cursor: pointer;" />';
                    }
                    if (isDel) {
                        _str += '    <input type="button" onclick="deleteAttachmentById(' + _value.id + ')" value="Delete" style="cursor: pointer;" />';
                    }
                    _str += '    </div>';
                    _str += '  </td>';
                    _str += '</tr>';
                }
            });
        }
        appendObj.nextAll().remove();
        appendObj.after(_str);
    }

    function deleteAttachmentById(_id) {
        P.$.dialog.confirm("Are you sure to delete?", function () {
            if (!_id) {
                P.$.dialog.alert("Delete Error");
                return false;
            }
            var actionDeleteUrl = basePath + "/er/fileUploadAuxiliary_deleteAttachmentById.action";

            var params = {

                "entityId": entityId,

                "attachmentId": _id,

                "moduleForPath": moduleForDb,

                "moduleForDb": moduleForDb,

                'licenType': 'delete'
            };

            $.ajax({

                url: actionDeleteUrl,

                async: false,

                data: params,

                cache: false,

                type: "post",

                success: function (obj, textStatus) {

                    var data = JSON.parse(obj);

                    buildAttachment(data.filesObejct, "fileList", $("#td_files"), true);
                }
            });
        });

    }


    function download(id) {
        window.location.href = basePath + "/ee/attachment_downloadAndMsg.action?fileId=" + id
    }
</script>
</body>
</html>