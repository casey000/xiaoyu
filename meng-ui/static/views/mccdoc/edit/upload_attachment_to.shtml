<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <title>基础信息管理</title>
    <!-- load css -->
    <link href="/css/mccdoc/mcc_doc_commons.css" rel="stylesheet" type="text/css"/>
    <link href="/css/mccdoc/to_commons.css" rel="stylesheet" type="text/css"/>
    <!-- load js -->
    <script src="/js/global_var.js" type="text/javascript"></script>
    <script src="/js/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script src="/js/jquery.form.js" type="text/javascript"></script>
    <script src="/js/jquery.validate.js" type="text/javascript"></script>
</head>

<body>
<form action="" enctype="multipart/form-data" id="add_form" method="post">
    <table border="1" bordercolor="#B2C9E0" cellpadding="0" cellspacing="0" class="table-zi" style="padding-top:10px"
           width="100%">
        <tr>
            <td class="tab_title_background">Attachment:</td>
        </tr>
        <tr>
            <td>
                <div>
                    <input name="file" style="width:50%" type="file"/>
                    <img onclick="add_query_div(this)" src="/images/add.gif" style="vertical-align:middle;"/>&nbsp;
                    <img onclick="del_query_div(this)" src="/images/del.gif" style="vertical-align:middle;"/>
                    <div class="errorMessage"></div>
                </div>
            </td>
        </tr>
    </table>
</form>
<script type="text/javascript">
    //初始化按钮
    var sub_win = frameElement.api, P = sub_win.opener;
    var s_params = sub_win.data;
    var id = s_params["id"];
    var type = s_params["type"];
    sub_win.button(
        {
            name: 'Upload',
            callback: function () {
                submitForm();
                return false;
            }
        },
        {
            name: 'Cancel'
        }
    );

    function add_query_div(img_oj) {
        var td_obj = $(img_oj).closest("td");
        var div_obj = $(img_oj).closest("div").last().clone(true);
        div_obj.find(".doc_type").find("option").removeAttr("selected");
        div_obj.find("input").val("");
        div_obj.find(".errorMessage").html("");
        $(div_obj).attr("style", "padding-top:10px");
        td_obj.append(div_obj);
    }

    function del_query_div(img_oj) {
        if ($(img_oj).closest("td").children().length > 1) {
            $(img_oj).closest("div").remove();
        }
    }


    function submitForm() {
        $(".error").remove();
        if ($(":file[value!='']").size() == 0) {
            P.$.dialog.alert("Please input file!");
            return;
        }
        var arrFile = [];
        for (var i = 0; i < $(":file[value!='']").size(); i++) {
            arrFile.push($(":file[value!='']")[i].value);
        }

        if (arrFile.length > 0) {
            for (var i = 0; i < arrFile.length; i++) {
                var text = arrFile[i];

                //判断文件名长度
                var maxIndex = text.lastIndexOf('\\') > text.lastIndexOf('/') ? text.lastIndexOf('\\') : text.lastIndexOf('/');
                if (text.substring(maxIndex + 1, text.lastIndexOf('.')).length > 100) {
                    var message = '<span class="error">The file name length should be less than 100.</span>';
                    $($(":file[value!='']")[i]).nextAll("div.errorMessage").append(message);
                    return;
                }

                //判断是否是PDF文件
                if (!(/\.pdf$/.test(text.toLowerCase()))) {
                    var message = '<span class="error">The files should be one pdf.</span>';
                    $($(":file[value!='']")[i]).nextAll("div.errorMessage").append(message);
                    return;
                }
            }
            var fileCategory = "toProductionModule";
            if (type == '1') {
                fileCategory = "toTroubleshootingModule";
            } else if (type == '2') {
                fileCategory = "toSurveyModule";
            } else if (type == '3') {
                fileCategory = "toMaintenanceModule";
            }

            var params = {
                "sourceId": id,
                "fileCategory": fileCategory
            };
            var actionUrl = basePath + "/api/v1/mccdoc/to_base_info/attachmentUpload";
            sub_win.button({name: 'Upload', disabled: false});
            $("#add_form").ajaxSubmit({
                url: actionUrl,
                dataType: "json",
                data: params,
                contentType: 'application/x-www-form-urlencoded;charset=utf-8',
                cache: false,
                type: "post",
                success: function (data) {
                    if (data.code == 200) {
                        P.$.dialog.success("success.");
                        sub_win.data['reload'] = true;
                        sub_win.close();
                    } else {
                        P.$.dialog.success("上传附件失败！" + data.msg);
                        sub_win.close();
                    }
                }
            });
        }

    }

</script>
</body>
</html>