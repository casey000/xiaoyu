<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <title>TA修改</title>
    <link href="/css/easyui/gray/easyui.css" rel="stylesheet" type="text/css"/>
    <link href="/css/common.css" rel="stylesheet" type="text/css"/>
    <link href="/js/jquery/ztree/zTreeStyle.css" rel="stylesheet" type="text/css"/>
    <link href="/css/jquery-ui-1.8.2.custom.css" rel="stylesheet" type="text/css"/>
    <!-- mcc模块的公用css -->
    <link href="/css/mccdoc/mcc_doc_commons.css" rel="stylesheet" type="text/css"/>


    <!-- load js -->
    <script src="/js/jquery-1.8.0.min.js"></script>
    <script src="/js/json2.js" type="text/JavaScript"></script>
    <script src="/js/jquery/easyui/jquery-1.8.0.min.js" type="text/javascript"></script>
    <script src="/js/global_var.js" type="text/JavaScript"></script>
    <script src="/js/jquery/lhgdialog/lhgdialog.js" type="text/javascript"></script>
    <script src="/js/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="/js/jquery/ztree/jquery.ztree.core-3.4.js" type="text/javascript"></script>
    <script src="/js/jquery/ztree/jquery.ztree.excheck-3.4.js" type="text/javascript"></script>
    <script src="/js/jquery-ui.js"></script>
    <script src="/js/date_utils.js" type="text/javascript"></script>
    <script src="/js/sfa-query-1.0.js" type="text/javascript"></script>
    <script src="/js/jquery.form.js" type="text/javascript"></script>
    <script src="/js/data/ata_utils.js" type="text/javascript"></script>
    <!-- 表单验证jquery.validate -->
    <script src="/js/jquery.validate.js" type="text/javascript"></script>
    <script src="/js/custom-validate.js" type="text/javascript"></script>
    <script src="/js/jquery.maxlength.js" type="text/javascript"></script>

    <!-- TA Edit专用js -->
    <script src="/js/mccdoc/edit/edit_ta.js" type="text/javascript"></script>

</head>
<body>
<form id="addForm">
    <input name="taBaseInfo.id" type="hidden" value="${taBaseInfo.id}"/>
    <table border="1" cellpadding="0" cellspacing="0" class="table-zi" style="padding-top:10px" width="100%">
        <tr>
            <td class="tab_title_background">TA NO:</td>
            <td>${taBaseInfo.number}&nbsp;</td>
            <td class="tab_title_background">Rev.:</td>
            <td>
                <c:if test="${not empty taBaseInfo.revNo}">R${taBaseInfo.revNo}</c:if>
                <c:if test="${empty taBaseInfo.revNo}">R0</c:if>
            </td>
            <td class="tab_title_background">&nbsp;</td>
            <td>&nbsp;</td>
        </tr>
        <tr>
            <td class="tab_title_background" width="15%">Model:</td>
            <td width="18%">
                <input disabled="disabled" name="taBaseInfo.model" readonly="readonly" style="width: 90%"
                       value="${taBaseInfo.model}"/></td>
            <td class="tab_title_background" width="15%">
                <s:text name="base.aircraft.tail"/>
                :
            </td>
            <td width="20%">
                <input name="taBaseInfo.acId" readonly="readonly" type="hidden" value="${taBaseInfo.acId}"/>
                <input name="taBaseInfo.acNo" onclick="getAirplaneInfo()" readonly="readonly" type="text"
                       value="${taBaseInfo.acNo}"/>
                <img class="search_btn_img" height="16" onclick="getAirplaneInfo()"
                     src="/images/ico_search_16.gif" style="cursor:pointer;vertical-align: middle;" width="16"/> <span
                    class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
            <td class="tab_title_background" width="15%">ATA:</td>
            <td width="18%"><input name="taBaseInfo.ata" style="width:90%" type="text" value="${taBaseInfo.ata}"/>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="tab_title_background">Subject:</td>
            <td colspan="5">
                <textarea name='taBaseInfo.subject' style="width:97%;height:100px;">${taBaseInfo.subject}</textarea>
                <span class="td-font-red">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
        <tr>
            <td class="tab_title_background">Distribution:</td>
            <td colspan="5">&nbsp;
                <input id="distributions" readonly="readonly" type="hidden" value="${taBaseInfo.distribution}"/>
                <input name="taBaseInfo.distribution" type="checkbox" value="31"/>&nbsp;<span
                        style="vertical-align: middle;">PPC</span>&nbsp;
                <input name="taBaseInfo.distribution" type="checkbox" value="32"/>&nbsp;<span
                        style="vertical-align: middle;">质量</span>&nbsp;
                <input name="taBaseInfo.distribution" type="checkbox" value="33"/>&nbsp;<span
                        style="vertical-align: middle;">航材</span>&nbsp;
                <input name="taBaseInfo.distribution" type="checkbox" value="34"/>&nbsp;<span
                        style="vertical-align: middle;">MCC</span>&nbsp;
                <input name="taBaseInfo.distribution" type="checkbox" value="35"/>&nbsp;<span
                        style="vertical-align: middle;">维修处</span>&nbsp;
                <!-- <input type="checkbox" name="taBaseInfo.distribution" value="36" />&nbsp;<span style="vertical-align: middle;">外站</span>&nbsp; -->
                <input name="taBaseInfo.distribution" type="checkbox" value="37"/>&nbsp;<span
                        style="vertical-align: middle;">飞行</span>&nbsp;
                <input name="taBaseInfo.distribution" type="checkbox" value="38"/>&nbsp;<span
                        style="vertical-align: middle;">安监</span>&nbsp;
                <%-- <input name="taBaseInfo.distribution" type="checkbox" value="39"/>&nbsp;<span
                        style="vertical-align: middle;">飞管</span>&nbsp; --%>
                <input name="taBaseInfo.distribution" type="checkbox" value="40"/>&nbsp;<span
                        style="vertical-align: middle;">运标</span>&nbsp;
                <input name="taBaseInfo.distribution" type="checkbox" value="41"/>&nbsp;<span
                        style="vertical-align: middle;">运控</span>&nbsp;
                <input name="taBaseInfo.distribution" type="checkbox" value="48"/>&nbsp;<span
                        style="vertical-align: middle;">地服</span>&nbsp;
                <span style="color:#ff0000;float:right;margin-right:10px">*</span>
                <div class="errorMessage"></div>
            </td>
        </tr>
    </table>
</form>

<form action="" enctype="multipart/form-data" id="uploadForm" method="post">
    <table border="1" cellpadding="0" cellspacing="0" class="table-zi" style="padding-top:10px; border-top: none;"
           width="100%">
        <tr>
            <td class="tab_title_background" style="border-top:none;">Detail:</td>
            <td style="border-top:none; width: 85%;">
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="qc_table_detail"
                       style="padding-top:10px" width="100%">
                    <tr>
                        <td colspan="5"><input name="upload" style="width: 30%" type="file"/>
                            <span style="margin-left:10px;color:#FF0000"> 请上传两个文件，一个为pdf文档，另一个为doc/docx文档 </span>
                            <span style="margin-left:20px; padding-right:2%"><a href="javascript:" id="downloadTemplate"
                                                                                style="color:#f60">Download Template</a></span>
                            <span style='float: right; padding-right: 20px'>
					<input onclick="uploadAttachment();return false;" type="submit"
                           value="upload"/>
				</span></td>
                    </tr>
                    <tr id="td_files">
                        <td class="td-line30-with-bg-center">Doc Name</td>
                        <td class="td-line30-with-bg-center">Doc Type</td>
                        <td class="td-line30-with-bg-center">Uploader</td>
                        <td class="td-line30-with-bg-center">Upload Date</td>
                        <td class="td-line30-with-bg-center">Operate</td>
                    </tr>
                </table>
                <div class="errorMessage"></div>
            </td>
        </tr>
    </table>
</form>


<script type="text/javascript">
    var entityId = '${taBaseInfo.id}';
    var status = '${taBaseInfo.editStatus}';
    var moduleForDb = '${attachmentPath}';
    var fileDelAble = (status == 1);
    //如果文件不能删除同时禁用上传功能
    if (!fileDelAble) {
        $("#uploadForm table tr td table tr:first").hide();
    }

    if (status != 1) {
        $("input").attr("disabled", "disabled");
        $("textarea").attr("disabled", "disabled");
        $(".search_btn_img").add($("input[name='taBaseInfo.acNo']")).removeAttr("onclick");
    }

    var sub_win = frameElement.api, P = sub_win.opener;
    var s_params = sub_win.data;
    var methodType = s_params["methodType"];

    if (status == 1) {
        sub_win.button(
            {
                name: 'Submit',
                callback: function () {
                    saveForm('Submit');
                    return false;
                }
            },
            {
                name: 'Save',
                callback: function () {
                    saveForm('Save');
                    return false;
                }
            },
            {
                name: 'Cancel'
            }
        );
    }

    /** else if(status==2){
	sub_win.button(
		{
			name:'Check',
			callback: function () {
				var actionUrl = "/mccdoc/form/check_ta.jsp?id=${taBaseInfo.id}&status=${taBaseInfo.editStatus}" ;
				if(!'${taBaseInfo.number}'){
					actionUrl+='&title=TA task Checking [Tail: ${taBaseInfo.acNo}]'
				}else{
					actionUrl+='&title=TA task Checking [TA NO: ${taBaseInfo.number}] R${taBaseInfo.revNo}'
				}
				P.$.dialog({
					id : "checkTaDialog",
					title : "TA Checking",
					width : "750px",
					height : "500px",
					data : {},
					parent:this,
					lock:true,
					close : function(){
						sub_win.close();		
					},
					content : 'url:' + basePath + actionUrl
				});
				return false;
			}
		},
		{
			name:'Process Logs',
			callback: function () {
				logs();
				return false;
			}
		},
		{
			name:'Cancel'
		}
	);
}
     **/

    function validForm() {

        var text = $(":file").val();

        if (!text) {

            var message = "Please choose a file !";

            P.$.dialog.alert(message);

            return false;
        }
        var maxIndex = text.lastIndexOf('\\') > text.lastIndexOf('/') ? text.lastIndexOf('\\') : text.lastIndexOf('/');
        if (text.substring(maxIndex + 1, text.lastIndexOf('.')).length > 100) {
            var message = "The file name length should be less than 100";
            P.$.dialog.alert(message);
            return false;
        }

        var fileCount = $("tr[name='fileList']").length;
        if (fileCount >= 2) {
            var message = "The files should be one pdf and one doc(x).";
            P.$.dialog.alert(message);
            return false;
        }

        if (!(/\.doc[x]?$/.test(text.toLowerCase())) && !(/\.pdf$/.test(text.toLowerCase()))) {
            var message = "The files should be one pdf and one doc(x).";
            P.$.dialog.alert(message);
            return false;
        }

        var fileOne = $("tr[name='fileList'] td:eq(0)").text();
        if (fileCount == 1 && fileOne.substr(fileOne.lastIndexOf('.'), 3).toLowerCase() == text.substr(text.lastIndexOf('.'), 3).toLowerCase()) {
            var message = "The files should be one pdf and one doc(x).";
            P.$.dialog.alert(message);
            return false;
        }


        if (fileCount == 1 && fileOne.substring(0, fileOne.lastIndexOf('.')).toLowerCase() != text.substring(maxIndex + 1, text.lastIndexOf('.')).toLowerCase()) {
            var message = "The files name should be same.";
            P.$.dialog.alert(message);
            return false;
        }
        return true;
    }

    function uploadAttachment(override) {

        $(".error").remove();

        if (!validForm()) {

            return false;
        }

        var params = {

            "entityId": entityId,

            "moduleForPath": moduleForDb,

            "moduleForDb": moduleForDb,

            "jsonData": override,

            'licenType': 'save'
        };

        var actionUrl = basePath + "/er/fileUploadAuxiliary_uploadFile.action";

        $("#uploadForm").ajaxSubmit({

            url: actionUrl,

            dataType: "json",

            data: params,

            cache: false,

            type: "post",

            success: function (obj, textStatus) {
                var data = JSON.parse(obj);

                if (data && data.ajaxResult == "failure") {

                    if (!data.errorIndex[0].type) {

                        P.$.dialog.alert(data.errorIndex[0].text);
                    }
                }

                if (data && data.ajaxResult == "success") {

                    P.$.dialog.success("File uploaded success!");

                    buildAttachment(data.filesObejct, "fileList", $("#td_files"), true);

                } else if (data && data.errorIndex) {

                    var duplicate = false;

                    $.each(data.errorIndex, function (i, n) {

                        var err_div = '<span class="error">' + n.text + '</span>';

                        $($(":file")[n.index]).nextAll(".errorMessage").append(err_div);

                        if (n.type) {

                            duplicate = true;
                        }
                    });

                    if (duplicate) {

                        P.$.dialog.alert("File is exist !");
                    }
                }
            }
        });
    }

    $(function () {

        var actionSelectUrl = basePath + "/er/fileUploadAuxiliary_getAllFile.action";

        var params = {

            "entityId": entityId,

            "reliabilityTaskId": '',

            "moduleForPath": moduleForDb,

            "moduleForDb": moduleForDb,

            'licenType': 'select'
        };
        if (typeof (params.entityId) == "undefined" || (params.entityId + "") == "null" || params.entityId == "") {
            return;
        }

        $.ajax({

            url: actionSelectUrl,

            async: false,

            data: params,

            cache: false,

            type: "post",

            success: function (obj, textStatus) {

                if (obj) {

                    var data = JSON.parse(obj);

                    buildAttachment(data.filesObejct, "fileList", $("#td_files"), fileDelAble);

                    //buildAttachment(data.reliabilityFilesObejct,"reliabilityFileList",$("#reliability_committee_td_files"),false);
                }
            }
        });
    });

    function buildAttachment(_dataObj, divId, appendObj, isDel) {
        var _str = "";
        if (!!_dataObj) {
            $.each(_dataObj, function (i, _value) {
                if (_value && _value.name && _value.type && _value.uploadByName && _value.createDate && _value.id) {
                    _str += '<tr name="' + divId + '">';
                    _str += '  <td  class="td-line30-center">' + _value.name + '</td>';
                    _str += '  <td  class="td-line30-center">' + _value.type + '</td>';
                    _str += '  <td  class="td-line30-center">' + _value.uploadByName + '</td>';
                    _str += '  <td  class="td-line30-center">' + _value.createDate + '</td>';
                    _str += '  <td  class="td-line30-center">';
                    _str += '    <div align="center" class="ui_buttons_upload" style="vertical-align: middle;">';
                    if (!isDel) {
                        _str += '        <input type="button" onclick="download(' + _value.id + ')" value="Download" style="cursor: pointer;" />';
                    }
                    if (isDel) {
                        _str += '    <input type="button" onclick="deleteAttachmentById(' + _value.id + ')" value="Delete" style="cursor: pointer;" />';
                    }
                    _str += '    </div>';
                    _str += '  </td>';
                    _str += '</tr>';
                }
            });
        }
        appendObj.nextAll().remove();
        appendObj.after(_str);
    }

    function deleteAttachmentById(_id) {
        P.$.dialog.confirm("Are you sure to delete?", function () {
            if (!_id) {
                P.$.dialog.alert("Delete Error");
                return false;
            }
            var actionDeleteUrl = basePath + "/er/fileUploadAuxiliary_deleteAttachmentById.action";

            var params = {

                "entityId": entityId,

                "attachmentId": _id,

                "moduleForPath": moduleForDb,

                "moduleForDb": moduleForDb,

                'licenType': 'delete'
            };

            $.ajax({

                url: actionDeleteUrl,

                async: false,

                data: params,

                cache: false,

                type: "post",

                success: function (obj, textStatus) {

                    var data = JSON.parse(obj);

                    buildAttachment(data.filesObejct, "fileList", $("#td_files"), true);
                }
            });
        });

    }

    function logs() {
        var _id = ${taBaseInfo.flowInstanceId};
        var url = 'mccdoc/logs.jsp?id=' + _id;
        P.$.dialog({
            title: 'Process Logs',
            width: '650px',
            height: '300px',
            top: '20%',
            esc: true,
            cache: false,
            max: false,
            min: false,
            parent: this,
            content: 'url:' + url
        });
    }

    function download(id) {
        window.location.href = basePath + "/ee/attachment_downloadAndMsg.action?fileId=" + id
    }
</script>
</body>
</html>


