<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>技术资料接收</title>
</head>

<body>
<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <input type="hidden" id="pkid" name="pkid" />
                <input type="hidden" id="dataSort" name="dataSort" />
                <!--<input type="hidden" id="dmReceiverId" name="dmReceiverId" />-->
                <!--<input type="hidden" id="dmReceiveDate" name="dmReceiveDate" />-->
                <table class="table table-bordered table-info">
                    <tr id = "view">
                        <td class="tdr" colspan="6" align="left">
                            <input class="btn btn-primary" id='saveBtn' type="button" onclick="save()" value="保存"
                                   style="width: 50px;margin:5px;"/>
                            <input id="upBtn" class="btn btn-primary" type="button" onclick="upload()" value="上传"
                                   style="width: 50px;margin:5px;"/>
                            <input id="issBtn" class="btn btn-primary" type="button" onclick="issueCheck()" value="发布"
                                   style="width: 50px;margin:5px;"/>
                            <input id="subBtn" class="btn btn-primary" type="button" onclick="subCad()" value="提交"
                                   style="width: 50px;margin:5px;"/>
                            <input id="attBtn" class="btn btn-primary" type="button" onclick="viewAttach()" value="附件查看"
                                   style="width: 60px;margin:5px;"/>
                            <input class="btn btn-primary" type="button" onclick="CloseWindowIframe();" value="关闭" style="width: 50px;margin:5px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">资料类型：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="dataType" name="dataType" data-options="required:true,editable:false" />
                        </td>
                        <th class="th" align="right" style="width: 80px;">紧急程度：</th>
                        <td class="tdr" style="width: 180px">
                            <input class="easyui-combobox" id="urgentLevel" name="urgentLevel"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">资料来源：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="dataFrom" name="dataFrom"
                                   data-options="required:true,editable:false"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">资料编号：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-validatebox" id="dataNo" name="dataNo" onblur="checkNo(this.value)"
                                   data-options="required:true,"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">资料版次：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-validatebox" id="dataVer" name="dataVer" onblur="checkVer(this.value)"
                                   data-options="required:true"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">章节：</th>
                        <td class="tdr" >
                            <input class="easyui-combobox" id="ata" name="ata"
                                   data-options="required:true,editable:false"/>
                        </td>
                    </tr>

                    <tr>
                        <th class="th" align="right" style="width: 80px;">修正案号：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-validatebox" id="dataAmend" name="dataAmend"
                                   onblur="checkAmend(this.value)" data-options="editable:true,required:true"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">生效日期：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-datebox" id="effectDate" name="effectDate"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">颁发日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="issueDate" name="issueDate"
                                   data-options="required:true,editable:false"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">适用类型：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="applyType" name="applyType"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">适用型号：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="applyModel" name="applyModel"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">接收日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="dmReceiveDate" name="dmReceiveDate"
                                   data-options="required:true,editable:false"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">标题：</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox" name="dataTitle" id="dataTitle"
                                   data-options="required:true,multiline:true "
                                   style="width: 730px;height:50px"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">源文件适用性描述：</th>
                        <td class="tdr" colspan="5">
                            <textarea  id="fitScope" name="fitScope" data-options="editable:true" style="width: 730px;height:60px" ></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">关键字：</th>
                        <td class="tdr"  colspan="5">
                            <input class="easyui-textbox" id="keyWords" name="keyWords" data-options="editable:true"style="width: 730px;height:30px" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">参考文件：</th>
                        <td class="tdr" colspan="5">
                            <textarea id="refFile" name="refFile" data-options="editable:true" style="width: 730px;height:60px" ></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">处理要求：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="howDealwith" name="howDealwith"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th id="norea1" class="th" align="right" style="width: 85px;">无需评估原因：</th>
                        <td class="tdr" id="norea2" colspan="5">
                            <input class="easyui-textbox" id="noAssessReason" name="noAssessReason"
                                   style="width:448px"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">专业：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="specialize" name="specialize"
                                   data-options="editable:false"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">备注：</th>
                        <td class="tdr" colspan="5">
                            <textarea id="memo" name="memo" data-options="editable:true" style="width: 730px;height:60px" ></textarea>
                        </td>
                    </tr>

                </table>
            </form>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var param;
    var operation;
    var PAGE_DATA = {};
    var mpkid = "";
    var dataType = "";
    var applyTypeFleetDic;
    var applyTypeEngDic;
    var applyType;
    var namespace;
    var status;
    var eeflag;
    var ifInit;
    var epkid;
    var isFlow;
    var minAta = '';
    var minFleet = '';
    var minSpec = '';
    var filecou = 0;
    var dflag = 'N';

    function i18nCallBack() {
        param = getParentParam_();
        operation = param.operation;
        applyType = param.applyType;
        namespace = param.namespace;
        eeflag = param.eeflag;
        ifInit = param.ifInit;
        epkid = param.epkid;
        isFlow = param.isFlow;
        var url = window.location.search; //获取url中"?"符后的字串
        if (url.indexOf("?") != -1) {
            dataType = url.substr(url.indexOf("=") + 1);
        }
        if(!dataType){
            dataType = param.dataType;
        }
        var ifEval = 'N';
        InitFuncCodeRequest_({
            data: {dataType: dataType, FunctionCode: 'DM_GET_IF_EVA'},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        ifEval = jdata.data.IF_EVAL;
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
        if(ifEval == 'Y'){
            $("#specialize").combobox({required:true});
        }else{
            $("#specialize").combobox({required:false});
        }
        if (applyType == "PART") {
            $("#applyModel").combobox({disabled: true});
            $("#applyModel").combobox('setValue', "CM");
        } else {
            $("#applyModel").combobox({disabled: false});
        }

        InitFuncCodeRequest_({
            data: {
                domainCode: "DM_REC_PRIVIDOR,YESORNO,DM_DATA_TYPE_TECHNOLOGY,DM_FILE_EDIT_TYPE,REVSUG_FLEET,DM_URGENT_LEVEL,EM_APPLY_TYPE,DM_HOW_DEALWITH,DM_ATA," +
                "DA_ENG_TYPE,EM_FILE_SPEC",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //文件格式
                    $('#fileEditType').combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_FILE_EDIT_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#dataFrom').combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_REC_PRIVIDOR,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#dataType").combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_DATA_TYPE_TECHNOLOGY,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (row) {
                            setPages(row.VALUE)
                        },
                        onHidePanel: function () {
                            validSelectValue_(this, "输入值不存在！");
                        }
                    });
                    $('#applyModel').combobox({
                        panelHeight: '70px',
                        data: jdata.data.REVSUG_FLEET,
                        multiple: true,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#urgentLevel').combobox({
                        panelHeight: '70px',
                        data: jdata.data.DM_URGENT_LEVEL,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#howDealwith').combobox({
                        panelHeight: '50px',
                        data: jdata.data.DM_HOW_DEALWITH,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onChange: howDealwithChange
                    });
                    $('#applyType').combobox({
                        panelHeight: '70px',
                        data: jdata.data.EM_APPLY_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onChange: applyTypeChange
                    });
                    $('#ata').combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_ATA,
                        multiple: true,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#specialize').combobox({
                        panelHeight: '135px',
                        data: jdata.data.EM_FILE_SPEC,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });


                    PAGE_DATA['dataType'] = DomainCodeToMap_(jdata.data["DM_DATA_TYPE_TECHNOLOGY"]);
                    PAGE_DATA['applyModel'] = DomainCodeToMap_(jdata.data["REVSUG_FLEET"]);
                    PAGE_DATA['urgentLevel'] = DomainCodeToMap_(jdata.data["DM_URGENT_LEVEL"]);
                    PAGE_DATA['howDealwith'] = DomainCodeToMap_(jdata.data["DM_HOW_DEALWITH"]);
                    PAGE_DATA['applyType'] = DomainCodeToMap_(jdata.data["EM_APPLY_TYPE"]);
                    PAGE_DATA['ata'] = DomainCodeToMap_(jdata.data["DA_ATA_F"]);
                    PAGE_DATA['dataFrom'] = DomainCodeToMap_(jdata.data["DM_REC_PRIVIDOR"]);
                    applyTypeFleetDic = jdata.data["REVSUG_FLEET"];
                    applyTypeEngDic = jdata.data["DA_ENG_TYPE"];
                }
                $("#dataType").textbox('setValue', dataType);
                $("#dmReceiveDate").datebox({onlyview: true, editable: false});
                if (eeflag == 'EE') {
                    $("#dataType").combobox({onlyview: true, editable: false});
                    $("#urgentLevel").combobox({onlyview: true, editable: false});
                    $("#dataFrom").combobox({onlyview: true, editable: false});
                    $("#dataNo").textbox({onlyview: true, editable: false});
                    $("#dataVer").textbox({onlyview: true, editable: false});
                    $("#dataAmend").textbox({onlyview: true, editable: false});
                    $("#effectDate").datebox({onlyview: true, editable: false});
                    $("#issueDate").datebox({onlyview: true, editable: false});
                    $("#dmReceiveDate").datebox({onlyview: true, editable: false});
                    $("#amocOwner").combobox({onlyview: true, editable: false});
                    $("#acLetterNo").textbox({onlyview: true, editable: false});
                    $("#acLetterVer").textbox({onlyview: true, editable: false});
                    $("#approveAc").textbox({onlyview: true, editable: false});
                    $("#fitScope").textbox({onlyview: true, editable: false});
                    $("#keyWords").textbox({onlyview: true, editable: false});
                    $("#refFile").textbox({onlyview: true, editable: false});
                    $("#howDealwith").combobox({onlyview: true, editable: false});
                    $("#noAssessReason").textbox({onlyview: true, editable: false});
                    $("#memo").textbox({onlyview: true, editable: false});
                }
                if (param.pkid) {
                    $("#dataType").combobox({onlyview: true});
                    InitDataForm(param.pkid);
                } else {
                    $("#dataFrom").textbox('setValue', "CAAC");
                    $("#dmReceiveDate").datebox("setValue", curDate());
                }
            }
        })
    }
    function applyTypeChange() {
        var applyType = $("#applyType").combobox('getValue');
        // if (applyType == "none") {
        //     $("#applyModel").combobox('setValue', "");
        //     $("#applyModel").combobox({disabled: true});
        // } else {
        //     $("#applyModel").combobox({disabled: false});
        // }
        if (applyType == "APL") {
            $('#applyModel').combobox({
                panelHeight: '70px',
                data: applyTypeFleetDic,
                valueField: 'VALUE',
                textField: 'TEXT'
            });
            $("#applyModel").combobox({disabled: false});
            $("#applyModel").combobox('clear');
        } else if (applyType == "ENG") {
            $('#applyModel').combobox({
                panelHeight: '70px',
                data: applyTypeEngDic,
                valueField: 'VALUE',
                textField: 'TEXT'
            });
            $("#applyModel").combobox({disabled: false});
            $("#applyModel").combobox('clear');
        } else if (applyType == "PART") {
            $("#applyModel").combobox({disabled: true});
            $("#applyModel").combobox('setValue', "CM");
        }

    }
    function ComOrPerChange() {
    var text = $("#ata").combobox('getValue');
        //如果章节是49、71-80则使用类型自动为发动机，并需要选择发动机型号
     if (text==2){
         $("#ata").textbox('setValue', "ENG");
     }
    }
    function InitDataForm(pkid) {
        mpkid = pkid;
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "DM_DATA_REC_EXTER_PK"},async: false, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    status = jdata.data.DATA_STATUS;
                    var deal = jdata.data.HOW_DEALWITH;
                    $('#applyModel').combobox({value: jdata.data.APPLY_MODEL});
                    $('#ata').combobox({value: jdata.data.ATA});
                    if (deal == 'N') {
                        $("#issBtn").hide();
                        $("#subBtn").show();
                    } else {
                        $("#subBtn").hide();
                        $("#issBtn").show();
                    }
                    if (isFlow) {
                        $("#subBtn").hide();
                    }
                    if (status == 'TURNBACK' || eeflag == 'EE') {
                        $("#upBtn").hide();
                        $("#subBtn").hide();
                        $("#issBtn").hide();
                        $("#saveBtn").show();
                    }

                    if (operation == "view") {
                        $("#upBtn").hide();
                        $("#saveBtn").hide();
                        $("#subBtn").hide();
                        $("#issBtn").hide();
                    }

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }
    //页面重新加载
    function setPages(dataType){
        if (dataType == "") {

        } else if (dataType == 'CAD') {
            window.location.href = '/views/data_manager/technology_data/cad/cadAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'SB') {
            window.location.href = '/views/data_manager/technology_data/sbsl/sbAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'AD') {
            window.location.href = '/views/data_manager/technology_data/ad/adAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'AMOC') {
            window.location.href = '/views/data_manager/technology_data/amoc/amocAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'IN'||dataType == 'NSC') {
            window.location.href = '/views/data_manager/technology_data/nsc/nscAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else {
            window.location.href = '/views/data_manager/technology_data/adother/dmExterDetail.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        }
    }
    function howDealwithChange(value) {
        var ata = $('#ata').combobox('getValues');
        var applyType = $('#applyType').combobox('getValue');
        var applyModel = $('#applyModel').combobox('getValue');
      if ("N"==value){
          //无需填写原因输入框设为可编辑且为必填项
          $('#norea1').show();
          $('#norea2').show();
          $('#noAssessReason').textbox({editable: true, onlyview: false, required: true});
          $('#ata').combobox({required: false});
          $('#applyType').combobox({required: false});
          $('#applyModel').combobox({required: false});
          $('#ata').combobox('setValue', '');
          $('#applyType').combobox('setValue', '');
          $('#applyModel').combobox('setValue', '');
          $('#fitScope').textbox({required: true});
          $('#keyWords').textbox({required: true});
          $('#refFile').textbox({required: true});
      }if ("Y"==value){
            $('#norea1').hide();
            $('#norea2').hide();
            $("#noAssessReason").textbox("setValue","");
            $('#noAssessReason').textbox({editable: false, onlyview: true, required: false});
            $('#ata').combobox({required: true});
            $('#applyType').combobox({required: true});
            $('#applyModel').combobox({required: true});
            $('#ata').combobox('setValue', ata);
            $('#applyType').combobox('setValue', applyType);
            $('#applyModel').combobox('setValue', applyModel);
            $('#fitScope').textbox({required: true});
            $('#keyWords').textbox({required: false});
            $('#refFile').textbox({required: true});
        }
    }
    // 保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        var code = $("#dataNo").val();
        if(code.indexOf("－")!=-1){
            $("#dataNo").val = code.replace("－","-");
        }
        $("#dataNo").val(code.replace(/\s*/g, ""));
        var dataVer = $("#dataVer").val().replace(/\s*/g, "");
        var dataAmend = $("#dataAmend").val().replace(/\s*/g, "");
        $("#dataVer").val(dataVer);
        $("#dataAmend").val(dataAmend);
        var $form = $("#mform");
        var datas = $form.serializeObject();
        if (Array.isArray(datas['ata'])) {
            datas['ata'] = datas['ata'].join(',');
        }
        if (Array.isArray(datas['applyModel'])) {
            datas['applyModel'] = datas['applyModel'].join(',');
        }
        InitFuncCodeRequest_({
            data: {
                dataType: datas['dataType'],
                dataNo: datas['dataNo'],
                dataVer: datas['dataVer'],
                pkid: datas["pkid"],
                FunctionCode: "DM_DATA_REC_EXTER_ADD_BEFORE_CHECK"
            }, successCallBack: function (jdata1) {
                if (jdata1.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata1.data.NUM > 0) {
                        MsgAlert({content: "存在重复数据，不允许保存！", type: 'error'});

                    } else {
                        datas = $.extend({
                            ifInit: ifInit,
                            epkid: epkid
                        }, datas, {FunctionCode: 'DM_DATA_REC_EXTER_ADD'});
                        InitFuncCodeRequest_({
                            data: datas, successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    var howDealwith = $("#howDealwith").combobox('getValue');
                                    if (isFlow) {
                                        MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                        mpkid = jdata.data.pkid;
                                        $("#pkid").val(mpkid);
                                        if (howDealwith == 'Y') {
                                            top.jQuery(".xmclass").hide();
                                            top.jQuery("#authId").combogrid({required: false});
                                        } else {
                                            top.jQuery(".xmclass").show();
                                        }
                                    } else {
                                        if (eeflag == 'EE') {
                                            MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                            param.OWindow.InitGrid();
                                        } else {
                                            if (param.OWindow.onSearch_) {
                                                param.OWindow.onSearch_('dg', '#ffSearch');
                                            }
                                            MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                            mpkid = jdata.data.pkid;
                                            $("#pkid").val(mpkid);
                                            InitDataForm(mpkid);
                                        }
                                    }
                                } else {
                                    if (jdata.msg.indexOf("ORA-00001") != -1) {
                                        alert("同一资料类型、编号、版次重复。");
                                        return false;
                                    } else {
                                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                                    }
                                }
                            }
                        });
                    }
                } else {
                    MsgAlert({content: jdata1.msg, type: 'error'});
                }
            }
        });
    }
    //上传
    function common_uploadFile(edopt) {
        var title_ = $.i18n.t('common:COMMON_OPERATION.UPLOAD');
        ShowWindowIframe({
            width: 575,
            height: 200,
            title: title_,
            param: $.extend({}, edopt.param),
            url: "/views/data_manager/dm/upload/attachment_add.shtml"
        });
    }
    //作废
    function discard() {
        //保存校验
        if(isEmpty(mpkid)){
            alert("请先保存数据！");
            return;
        }
        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas = $.extend({}, datas, {mpkid:mpkid,FunctionCode: 'DM_DATA_REC_EXTER_DIS'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if(param.OWindow.onSearch_){
                        param.OWindow.onSearch_('dg', '#ffSearch');
                    }
                    param.OWindow.MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }
    //发布前检验
    function issueCheck() {
        //保存校验
        if(isEmpty(mpkid)){
            alert("请先保存数据！");
            return;
        }
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        if (checkDm(mpkid)) {
            if (filecou != 0) {
                issue(mpkid, minAta, minFleet, dflag);
            }
        }
    }
    //发布
    function issue(mpkid, minAta, minFleet, dflag) {
        if (!confirm("确定要发布吗，发布后不可再收回？")) {
            return;
        }
        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas = $.extend({}, datas, {
            mpkid: mpkid,
            minAta: minAta,
            minFleet: minFleet,
            ifEval: dflag,
            FunctionCode: 'DM_DATA_REC_EXTER_ISS'
        });
        //发布前，需先验证是否上传附件，如果没有，则不能发布
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if(param.OWindow.onSearch_){
                        param.OWindow.onSearch_('dg', '#ffSearch');
                    }
                    param.OWindow.MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }
    //上传
    function upload() {
        //保存校验
        if(isEmpty(mpkid)){
            alert("请先保存数据！");
            return;
        }
        common_uploadFile({
            identity: 'dg',
            param: {
                cat: "dmDataRecExter",
                sourceId: mpkid,
                successCellBack: "",
                fialCellBack: ""
            }
        });
    }

    //上传成功后回填路径
    function afterUpload(pkid) {
        InitFuncCodeRequest_({
            data: {
                pkid: pkid,
                catagory: 'dmDataRecExter',
                FunctionCode: 'DM_DATA_REC_EXTER_UPLOAD'
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                }
            }
        });
    }
    //附件查看
    function viewAttach() {
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: mpkid,
                CATEGORY: "dmDataRecExter",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                //为0时提示没有上传附件，无法查看
                if (jdata.data.length==0){
                    MsgAlert({content: "请先上传附件", type: 'error'});

                }else {
                    //打开一个列表页面
                    ShowWindowIframe({
                        width: "515",
                        height: "285",
                        param: {
                            pkid: mpkid,
                            category: "dmDataRecExter",
                            namespace: namespace,
                            status: status,
                            operation: operation
                        },
                        url: "/views/data_manager/dm/upload/editAttach.shtml"
                    });
                }
            }
        });
    }
    //刷新
    function reload_() {
        if (param.OWindow.onSearch_) {
            param.OWindow.onSearch_('dg', '#ffSearch');
        }
    }

    function checkNo(dataNo) {
        var reg = /[\x00-\xff]/g;
        if (dataNo != null && dataNo != "") {
            if (!reg.test(dataNo)) {
                $("#dataNo").val("");
                MsgAlert({content: "不允许输入半角！", type: 'error'});
            } else {
                dataNo = dataNo.replace(/\s*/g, "");
                dataNo = dataNo.toUpperCase();
                $("#dataNo").val(dataNo);
            }
        }
    }

    function checkAmend(dataAmend) {
        var reg = /[\x00-\xff]/g;
        if (dataAmend != null && dataAmend != "") {
            if (!reg.test(dataAmend)) {
                $("#dataAmend").val("");
                MsgAlert({content: "不允许输入半角！", type: 'error'});
            } else {
                dataAmend = dataAmend.toUpperCase();
                $("#dataAmend").val(dataAmend);
            }
            var index = dataAmend.lastIndexOf("\-");
            var bottom = dataAmend.substring(index + 1, dataAmend.length);
            var cou = 0;
            InitFuncCodeRequest_({
                data: {dataAmend: bottom - 1, FunctionCode: 'DM_FILE_GET_AMEND'},
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data.COU != null) {
                            cou = jdata.data.COU;
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
            if (cou == 0) {
                MsgAlert({content: "友情提示：当前修正案号与已存在的不连续！", type: 'error'});
            }
        }
    }

    function checkVer(dataVer) {
        var reg = /^\d+$|^\d+[.]?\d+$/;
        var sta = dataVer.substring(0, 1);
        var end = dataVer.substring(1);
        if (dataVer != null && dataVer != "") {
            if (!reg.test(dataVer)) {
                $("#dataVer").val("");
                MsgAlert({content: "只能输入数字！", type: 'error'});
            } else {
                $("#dataVer").val(dataVer);
            }
        }
    }


    function checkAta() {
        var ata = $("#ata").combobox("getValues");
        var strs = ata.sort();
        var atas = strs.join(",");
        $("#ata").combobox("setValue", atas);
    }

    function curDate() {
        var now = new Date();
        var year = now.getFullYear(); //得到年份
        var month = now.getMonth();//得到月份
        var date = now.getDate();//得到日期
        month = month + 1;
        if (month < 10) {
            month = "0" + month
        }
        if (date < 10) {
            date = "0" + date
        }
        var curDate = year + "-" + month + "-" + date;
        return curDate;
    }

    function subCad() {
        if (isEmpty(mpkid)) {
            alert("请先保存数据！");
            return;
        }
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        if (checkDm(mpkid)) {
            if (status == 'WFB') {
                common_add_edit_({
                    identity: '',
                    isEdit: '',
                    width: 520,
                    height: 300,
                    title: $.i18n.t('选择审批人'),
                    param: {
                        operation: "flow",
                        roleId: '',
                        otherParam: minAta + "," + minFleet,
                        PKID: mpkid,
                        FunctionCode_: 'DM_CAD_SUBMIT',
                        successCallback: reload_
                    },
                    url: "/views/flow/work_flow_account_select.shtml"
                });
            } else {
                MsgAlert({content: "状态不是【未发布】不允许提交！", type: 'error'});

            }
        }
    }

    function checkDm(mpkid) {
        var dataType = $("#dataType").combobox('getValue');
        var applyModel = $("#applyModel").combobox('getValues');
        var applyType = $("#applyType").combobox('getValue');
        var howDealwith = $("#howDealwith").combobox('getValue');
        var ata2 = $("#ata").combobox('getValues');
        var spec = $("#specialize").combobox('getValues');
        //保存校验
        if (isEmpty(mpkid)) {
            alert("请先保存数据！");
            return false;
        }
        var $form = $("#mform");
        var datas = $form.serializeObject();
        //发布前，需先验证是否上传附件，如果没有，则不能发布
        datas = $.extend({}, datas, {CATEGORY: 'dmDataRecExter', SOURCE_ID: mpkid, FunctionCode: 'DM_EXTER_ARC'});
        InitFuncCodeRequest_({
            data: datas, async: false, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    filecou = jdata.data.ARC;
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });

        if (filecou == 0) {
            alert("未上传附件，请先上传附件。");
            return false;
        }

        InitFuncCodeRequest_({
            data: {dataType: dataType, FunctionCode: 'EM_FILE_GET_EVAL'},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        dflag = jdata.data.IF_EVAL;
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });

        var coueng = 0;
        minAta = ata2[0];//定义最小值为该数组的第一个数
        for (var i = 0; i < ata2.length; i++) {
            if (minAta > ata2[i]) {
                minAta = ata2[i];
            }
        }

        if (applyType == 'APL') {
            minFleet = applyModel[0];//定义最小值为该数组的第一个数
            for (var i = 0; i < applyModel.length; i++) {
                if (minFleet > applyModel[i]) {
                    minFleet = applyModel[i];
                }
            }
        } else if (applyType == 'ENG') {
            if (applyModel.indexOf("CFM56") != -1) {
                minFleet = 'CFM56';
            } else if (applyModel.indexOf("CF6") != -1) {
                minFleet = 'CF6';
            } else if (applyModel.indexOf("RB211") != -1) {
                minFleet = 'RB211';
            } else if (applyModel.indexOf("PW4000") != -1) {
                minFleet = 'PW4000';
            }
        } else {
            minFleet = applyModel[0];
        }
        //EE专业优先级高到底：AV/ME/STR/ENG
        if(spec != "" && spec != null){
            if (spec.indexOf("AV") != -1) {
                minSpec = 'AV';
            } else if (spec.indexOf("ME") != -1) {
                minSpec = 'ME';
            } else if (spec.indexOf("STR") != -1) {
                minSpec = 'STR';
            } else if (spec.indexOf("ENG") != -1) {
                minSpec = 'ENG';
            }
        }
        if (howDealwith == "Y") {
            //校验章节工程师
            if (dflag == 'Y') {
                InitFuncCodeRequest_({
                    data: {ata: minAta, applyModel: minFleet,specialize:minSpec, FunctionCode: 'EM_FILE_COUNT_ENGER'},
                    async: false,
                    successCallBack: function (jdata) {
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                            if (jdata.data.COU != null) {
                                coueng = jdata.data.COU;
                            }
                        } else {
                            MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                        }
                    }
                });

                if (coueng == 0) {
                    MsgAlert({content: "请先在主数据分工规则配置菜单配置章节工程师！章节为：" + minAta + ";机型为：" + minFleet
                            + ";专业：" + minSpec, type: 'error'});
                    return false;
                }
            }
        }
        return true;
    }

</script>
</html>