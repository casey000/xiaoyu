<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>技术资料接收</title>
</head>

<body>
<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <input type="hidden" id="pkid" name="pkid" />
                <input type="hidden" id="pkids" name="pkids"/>
                <input type="hidden" id="createBy" name="createBy" />
                <input type="hidden" id="createTime" name="createTime" />
                <input type="hidden" id="dataSort" name="dataSort" />
                <table class="table table-bordered table-info">
                    <tr id = "view">
                        <td class="tdr" colspan="6" align="left">
                            <input class="btn btn-primary" type="button" onclick="save()" value="保存" style="width: 50px;margin:5px;"/>
                            <input id="upBtn" class="btn btn-primary" type="button" onclick="upload()" value="上传"
                                   style="width: 50px;margin:5px;"/>
                            <input id="issBtn" class="btn btn-primary" type="button" onclick="issueCheck()" value="发布"
                                   style="width: 50px;margin:5px;"/>
                            <input id="attBtn" class="btn btn-primary" type="button" onclick="viewAttach()" value="附件查看"
                                   style="width: 60px;margin:5px;"/>
                            <input class="btn btn-primary" type="button" onclick="CloseWindowIframe();" value="关闭" style="width: 50px;margin:5px;"/>
                        </td>
                    </tr>
                    <tr id = "view2">
                        <td class="tdr" colspan="6" align="left">
                            <input class="btn btn-primary" type="button" onclick="viewAttach()" value="附件查看" style="width: 60px;margin:5px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">资料类型：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="dataType" name="dataType" data-options="required:true,editable:false" style="width: 180px;"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">资料来源：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="dataFrom" name="dataFrom"
                                   data-options="required:true,editable:false" style="width: 180px;"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">适用类型：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="applyType" name="applyType"
                                   data-options="required:true,editable:false" style="width: 155px;"/>
                        </td>

                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">资料编号：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-validatebox" id="dataNo" name="dataNo" onblur="checkNo(this.value)"
                                   data-options="required:true" style="width: 180px;"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">资料版次：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-validatebox" id="dataVer" name="dataVer" onblur="checkVer(this.value)"
                                   data-options="required:true" style="width: 180px;"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">章节：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="ata" name="ata"
                                   data-options="required:true,editable:false" style="width: 155px;"/>
                        </td>
                    </tr>
                    <tr id="cross">
                        <th class="th" align="right" style="width: 80px;">对应资料:
                        </th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox" name="crossData" id="crossData"
                                   data-options="multiline:true, editable:false,onlyview:true"
                                   style="width: 90%;height:30px"/>
                            <input id="chCross" class="btn btn-primary" type="button" onclick="crossDm()" value="选取"
                                   style="width: 50px;margin:5px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">标题：</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox" name="dataTitle" id="dataTitle"
                                   data-options="required:true,multiline:true "
                                   style="width: 730px;height:50px"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">适用型号：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="applyModel" name="applyModel"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">生效日期：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-datebox" id="effectDate" name="effectDate"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">接收日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="dmReceiveDate" name="dmReceiveDate" style="width: 155px;"
                                   data-options="required:true,editable:false"/>
                        </td>
                    </tr>
                    <tr id='sllev'>
                        <th class="th" align="right" style="width: 80px;">SL级别：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="sbGrade" name="sbGrade"
                                   data-options="editable:true,editable:false"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">颁发日期：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-datebox" id="issueDate" name="issueDate"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th id="am1" class="th" align="right" style="width: 80px;">持有人：</th>
                        <td id="am2" class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="amocOwner" name="amocOwner"
                                   data-options="editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">专业：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="specialize" name="specialize"
                                   data-options="editable:false"/>
                        </td>
                    </tr>
                    <tr id='showAsms'>
                        <th class="th" align="right" style="width: 80px;">是否结构类：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="ifAsms" name="ifAsms"
                                   data-options="editable:true,editable:false"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">备注：</th>
                        <td class="tdr" colspan="5">
                            <textarea id="memo" name="memo" data-options="editable:true"
                                      style="width: 730px;height:60px"></textarea>
                        </td>
                    </tr>
                    <tr id="all">
                        <th colspan="2" class="th" style="width: 80px;">
                            <input id="addF" class="btn btn-primary" style="width: 100px;margin-right:50px;" type="button" onclick="addFile()" value="选取附加文件"/>
                        </th>
                        <th class="th" align="right" style="width: 80px;">是否齐全：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="ifAll" name="ifAll" style="width: 100px;"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" >说明：</th>
                        <td class="tdr" style="width: 180px;">
                            <textarea id="allMemo" name="allMemo" data-options="editable:true"
                                      style="width: 97%;height:60px"></textarea>
                        </td>
                    </tr>
                </table>

                <table id="dg1"></table>
            </form>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript" src="/js/common_sc.js"></script>
<script type="text/javascript">
    var param;
    var operation;
    var PAGE_DATA = {};
    var mpkid = '';
    var type = "";
    var applyTypeFleetDic;
    var applyTypeEngDic;
    var namespace;
    var status;
    var eeflag = "";
    var ifInit;
    var epkid;
    var dataType;
    var pkid;
    var minSpec = "";
    function i18nCallBack() {
        param = getParentParam_();
        operation = param.operation;
        namespace = param.namespace;
        eeflag = param.eeflag;
        ifInit = param.ifInit;
        epkid = param.epkid;
        dataType = param.dataType;
        pkid = param.pkid;
        var url=window.location.search; //获取url中"?"符后的字串
        if(url.indexOf("?")!=-1){
            type = url.substr(url.indexOf("=")+1);
        }
        if (!type) {
            type = dataType;
        }
        if (type != null && type != '') {
            type = decodeURI(type);
        }
        var ifEval = 'N';
        InitFuncCodeRequest_({
            data: {dataType: type, FunctionCode: 'DM_GET_IF_EVA'},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        ifEval = jdata.data.IF_EVAL;
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
        if(ifEval == 'Y'){
            $("#specialize").combobox({required:true});
        }else{
            $("#specialize").combobox({required:false});
        }
        if (type == "SL") {
            $("#sllev").show();
            $("#showAsms").show();
            $("#sbGrade").combobox("setValue", "STANDARD");
        } else {

            $("#sllev").hide();
            $("#showAsms").hide();
            $("#sbGrade").combobox("setValue", "");
        }
        if (type == "MOD") {
            $('#am1').show();
            $('#am2').show();
            $('#all').show();
            $("#ifAll").combobox({required: true});
        } else {
            $('#am1').hide();
            $('#am2').hide();
            $('#all').hide();
            $("#ifAll").combobox({required: false});
        }
        if (type == "MDL" || type == "VSTC") {
            $("#cross").show();
        } else {
            $("#cross").hide();
        }
        if (applyType == "PART") {
            $("#applyModel").combobox({disabled: true});
            $("#applyModel").combobox('setValue', "CM");
        } else {
            $("#applyModel").combobox({disabled: false});
        }
        if(operation == "view"){
            $("#view").hide();
            $("#view2").show();//addF
            $("#addF").prop("disabled", true);
        }else{
            $("#view2").hide();
            $("#view").show();
            $("#addF").prop("disabled", false);
        }
        if(operation == "file"){
            $("#dataType").combobox({onlyview:true,editable:false});
            $("#dataFrom").combobox({onlyview:true,editable:false});
            $("#applyType").combobox({onlyview:true,editable:false});
            $("#dataNo").textbox({onlyview:true,editable:false});
            $("#dataVer").textbox({onlyview:true,editable:false});
            $("#ata").combobox({onlyview:true,editable:false});
            $("#chCross").prop("disabled", true);
            $("#upBtn").prop("disabled", true);
            $("#issBtn").prop("disabled", true);
            $("#dataTitle").textbox({onlyview:true,editable:false});
            $("#applyModel").combobox({onlyview:true,editable:false});
            $("#effectDate").datebox({onlyview:true,editable:false});
            $("#dmReceiveDate").datebox({onlyview:true,editable:false});
            $("#sbGrade").combobox({onlyview:true,editable:false});
            $("#issueDate").datebox({onlyview:true,editable:false});
            $("#amocOwner").combobox({onlyview:true,editable:false});
            $("#memo").textbox({onlyview:true,editable:false});
        }
        InitFuncCodeRequest_({
            data: {
                domainCode: "YESORNO,DM_FROM,DM_FILE_EDIT_TYPE,DM_REC_PRIVIDOR,DM_DATA_TYPE_TECHNOLOGY,REVSUG_FLEET,DM_URGENT_LEVEL,EM_APPLY_TYPE" +
                ",DM_HOW_DEALWITH,DM_ATA,DA_ENG_TYPE,EM_FILE_SPEC", FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#ifAll').combobox({
                        panelHeight: '100px',
                        data: jdata.data.YESORNO,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#amocOwner').combobox({
                        panelHeight: '100px',
                        data: jdata.data.DM_FROM,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#dataFrom').combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_REC_PRIVIDOR,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //文件格式
                    $('#fileEditType').combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_FILE_EDIT_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#ifAsms').combobox({
                        panelHeight: '135px',
                        data: jdata.data.YESORNO,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });

                    $("#dataType").combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_DATA_TYPE_TECHNOLOGY,
                        valueField: 'VALUE',
                        textField: 'TEXT',
//                        onChange:function (value) {setPages(value)} ,
                        onSelect:function (row) {setPages(row.VALUE)} ,
                        onHidePanel: function() {
                            validSelectValue_(this, "输入值不存在！");
                        }
                    });
                    $('#applyModel').combobox({
                        panelHeight: '70px',
                        data: jdata.data.REVSUG_FLEET,
                        multiple: true,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#urgentLevel').combobox({
                        panelHeight: '70px',
                        data: jdata.data.DM_URGENT_LEVEL,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#howDealwith').combobox({
                        panelHeight: '50px',
                        data: jdata.data.DM_HOW_DEALWITH,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#applyType').combobox({
                        panelHeight: '70px',
                        data: jdata.data.EM_APPLY_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onChange: applyTypeChange
                    });
                    $('#ata').combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_ATA,
                        multiple: true,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#specialize').combobox({
                        panelHeight: '135px',
                        data: jdata.data.EM_FILE_SPEC,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });

                    PAGE_DATA['dataType'] = DomainCodeToMap_(jdata.data["DM_DATA_TYPE_TECHNOLOGY"]);
                    PAGE_DATA['applyModel'] = DomainCodeToMap_(jdata.data["REVSUG_FLEET"]);
                    PAGE_DATA['urgentLevel'] = DomainCodeToMap_(jdata.data["DM_URGENT_LEVEL"]);
                    PAGE_DATA['howDealwith'] = DomainCodeToMap_(jdata.data["DM_HOW_DEALWITH"]);
                    PAGE_DATA['applyType'] = DomainCodeToMap_(jdata.data["EM_APPLY_TYPE"]);
                    PAGE_DATA['ata'] = DomainCodeToMap_(jdata.data["DA_ATA_F"]);
                    applyTypeFleetDic = jdata.data["REVSUG_FLEET"];
                    applyTypeEngDic = jdata.data["DA_ENG_TYPE"];
                }
                $("#dataType").textbox('setValue',type);
                $("#howDealwith").combobox({onlyview:true,editable:false});
                $("#howDealwith").combobox('setValue',"Y");
                $("#dmReceiveDate").datebox({onlyview: true, editable: false});

                if (eeflag == 'EE') {
                    $("#upBtn").hide();
                    $("#issBtn").hide();
                    $("#attBtn").hide();
                    $("#disBtn").hide();
                    $("#dataType").combobox({onlyview: true, editable: false});
                    $("#urgentLevel").combobox({onlyview: true, editable: false});
                    $("#dataFrom").combobox({onlyview: true, editable: false});
                    $("#dataNo").textbox({onlyview: true, editable: false});
                    $("#dataVer").textbox({onlyview: true, editable: false});
                    $("#amocOwner").combobox({onlyview: true, editable: false});
                    $("#sbGrade").combobox({onlyview: true, editable: false});
                    $("#issueDate").datebox({onlyview: true, editable: false});
                    $("#memo").textbox({onlyview: true, editable: false});
                }
                if (pkid){
                    $("#dataType").combobox({onlyview:true});
                    InitDataForm(pkid);
                    if(type == 'MOD'){
                        InitDataGrid();
                    }
                } else {
                    $("#dmReceiveDate").datebox("setValue", curDate());
                }
            }
        })
    }

    function initSbLev(dataFrom) {
        var datas = $.extend({dataFrom: dataFrom}, {FunctionCode: 'EM_SB_GRADE'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#sbGrade').combobox({
                        panelHeight: '150px',
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        data: jdata.data
                    });
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });

    }

    function applyTypeChange() {
        var applyType = $("#applyType").combobox('getValue');
        if (applyType == "APL") {
            $('#applyModel').combobox({
                panelHeight: '70px',
                data: applyTypeFleetDic,
                valueField: 'VALUE',
                textField: 'TEXT'
            });
            $("#applyModel").combobox({disabled: false});
            $("#applyModel").combobox('clear');
        } else if (applyType == "ENG") {
            $('#applyModel').combobox({
                panelHeight: '70px',
                data: applyTypeEngDic,
                valueField: 'VALUE',
                textField: 'TEXT'
            });
            $("#applyModel").combobox({disabled: false});
            $("#applyModel").combobox('clear');
        } else if (applyType == "PART") {
            $("#applyModel").combobox({disabled: true});
            $("#applyModel").combobox('setValue', "CM");
        }

    }


    function InitDataForm(pkid) {
        mpkid = pkid;
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "DM_DATA_REC_EXTER_PK"}, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    status = jdata.data.DATA_STATUS;
                    $('#applyModel').combobox({value: jdata.data.APPLY_MODEL});
                    $('#ata').combobox({value: jdata.data.ATA});

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }
    //页面重新加载
    function setPages(dataType){
        if (dataType == "") {

        } else if (dataType == 'CAD') {
            window.location.href = '/views/data_manager/technology_data/cad/cadAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'SB') {
            window.location.href = '/views/data_manager/technology_data/sbsl/sbAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'AD') {
            window.location.href = '/views/data_manager/technology_data/ad/adAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'AMOC') {
            window.location.href = '/views/data_manager/technology_data/amoc/amocAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'IN'||dataType == 'NSC') {
            window.location.href = '/views/data_manager/technology_data/nsc/nscAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else {
            window.location.href = '/views/data_manager/technology_data/adother/dmExterDetail.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        }
    }

    // 保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;

        var code = $("#dataNo").val();
        if (code.indexOf("－") != -1) {
            $("#dataNo").val = code.replace("－", "-");
        }
        $("#dataNo").val(code.replace(/\s*/g, ""));
        var dataVer = $("#dataVer").val().replace(/\s*/g, "");
        $("#dataVer").val(dataVer);
        var $form = $("#mform");
        var datas = $form.serializeObject();

        if (Array.isArray(datas['ata'])) {
            datas['ata'] = datas['ata'].join(',');
        }
        if (Array.isArray(datas['applyModel'])) {
            datas['applyModel'] = datas['applyModel'].join(',');
        }
        InitFuncCodeRequest_({
            data: {
                dataType: datas['dataType'],
                dataNo: datas['dataNo'],
                dataVer: datas['dataVer'],
                pkid: datas["pkid"],
                FunctionCode: "DM_DATA_REC_EXTER_ADD_BEFORE_CHECK"
            }, successCallBack: function (jdata1) {
                if (jdata1.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata1.data.NUM > 0) {
                        MsgAlert({content: "存在重复数据，不允许保存！", type: 'error'});

                    } else {
                        datas = $.extend({
                            ifInit: ifInit,
                            epkid: epkid
                        }, datas, {FunctionCode: 'DM_DATA_REC_EXTER_ADD'});
                        InitFuncCodeRequest_({
                            data: datas, successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    if (eeflag == 'EE') {
                                        MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                        param.OWindow.InitGrid();
                                    } else {
                                        if (param.OWindow.onSearch_) {
                                            param.OWindow.onSearch_('dg', '#ffSearch');
                                        }
                                        MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                        mpkid = jdata.data.pkid;
                                        $("#pkid").val(mpkid);
                                        if (jdata.data.dataType = 'MOD') {
                                            InitDataGrid();
                                        }
                                    }
                                } else {
                                    if (jdata.msg.indexOf("ORA-00001") != -1) {
                                        alert("资料编号、版次重复。");
                                        return false;
                                    } else {
                                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                                    }
                                }
                            }
                        });
                    }
                } else {
                    MsgAlert({content: jdata1.msg, type: 'error'});
                }
            }
        });
    }
    //作废
    function discard() {
        //保存校验
        if(isEmpty(mpkid)){
            alert("请先保存数据！");
            return;
        }
        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas = $.extend({}, datas, {mpkid:mpkid,FunctionCode: 'DM_DATA_REC_EXTER_DIS'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if(param.OWindow.onSearch_){
                        param.OWindow.onSearch_('dg', '#ffSearch');
                    }
                    param.OWindow.MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }
    //发布前检验
    function issueCheck() {
        //保存校验
        if(isEmpty(mpkid)){
            alert("请先保存数据！");
            return;
        }
        var dataType = $("#dataType").combobox('getValue');
        var applyModel = $("#applyModel").combobox('getValues');
        var applyType = $("#applyType").combobox('getValue');
        var ata2 = $("#ata").combobox('getValues');
        var spec = $("#specialize").combobox('getValues');
        if (dataType == "MDL" || dataType == "VSTC") {
            var crossData = $("#crossData").textbox('getValue');
            if (isEmpty(crossData)) {
                alert("请先选择对应资料！");
                return;
            }
        }
        if (applyType == "PART") {
            applyModel = "CM";
        }

        var dflag = 'N';
        InitFuncCodeRequest_({
            data: {dataType: dataType, FunctionCode: 'EM_FILE_GET_EVAL'},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        dflag = jdata.data.IF_EVAL;
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
        var minAta = "";
        var minFleet = "";
        var coueng = 0;
        minAta = ata2[0];//定义最小值为该数组的第一个数
        for (var i = 0; i < ata2.length; i++) {
            if (minAta > ata2[i]) {
                minAta = ata2[i];
            }
        }

        if (applyType == 'APL') {
            minFleet = applyModel[0];//定义最小值为该数组的第一个数
            for (var i = 0; i < applyModel.length; i++) {
                if (minFleet > applyModel[i]) {
                    minFleet = applyModel[i];
                }
            }
        } else if (applyType == 'ENG') {
            if (applyModel.indexOf("CFM56") != -1) {
                minFleet = 'CFM56';
            } else if (applyModel.indexOf("CF6") != -1) {
                minFleet = 'CF6';
            } else if (applyModel.indexOf("RB211") != -1) {
                minFleet = 'RB211';
            } else if (applyModel.indexOf("PW4000") != -1) {
                minFleet = 'PW4000';
            }
        } else {
            minFleet = applyModel[0];
        }
        //EE专业优先级高到底：AV/ME/STR/ENG
        if(spec != "" && spec != null){
            if (spec.indexOf("AV") != -1) {
                minSpec = 'AV';
            } else if (spec.indexOf("ME") != -1) {
                minSpec = 'ME';
            } else if (spec.indexOf("STR") != -1) {
                minSpec = 'STR';
            } else if (spec.indexOf("ENG") != -1) {
                minSpec = 'ENG';
            }
        }
        if (dflag == 'Y') {
            InitFuncCodeRequest_({
                data: {ata: minAta, applyModel: minFleet,specialize:minSpec, FunctionCode: 'EM_FILE_COUNT_ENGER'},
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data.COU != null) {
                            coueng = jdata.data.COU;
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });

            if (coueng == 0) {
                MsgAlert({content: "请先在主数据分工规则配置菜单配置章节工程师！章节为：" + minAta + ";机型为：" + minFleet
                        + ";专业：" + minSpec, type: 'error'});
                return false;
            }
        }

        var $form = $("#mform");
        var datas = $form.serializeObject();
        //发布前，需先验证是否上传附件，如果没有，则不能发布
        datas = $.extend({}, datas, {CATEGORY:'dmDataRecExter',SOURCE_ID:mpkid,FunctionCode: 'DM_EXTER_ARC'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if(jdata.data.ARC != 0){
                        issue(mpkid, minAta, minFleet, dflag);
                    }else{
                        alert("未上传附件，请先上传附件。");

                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }
    //发布
    function issue(mpkid, minAta, minFleet, dflag) {
        if (!confirm("确定要发布吗，发布后不可再收回？")) {
            return;
        }
        //发布按钮置灰 01374973 程建波 20200523
        $("#issBtn").prop("disabled", true);

        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas = $.extend({}, datas, {
            mpkid: mpkid,
            minAta: minAta,
            minFleet: minFleet,
            ifEval: dflag,
            FunctionCode: 'DM_DATA_REC_EXTER_ISS'
        });
        //发布前，需先验证是否上传附件，如果没有，则不能发布
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if(param.OWindow.onSearch_){
                        param.OWindow.onSearch_('dg', '#ffSearch');
                    }
                    param.OWindow.MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }
    //上传
    function upload() {
        //保存校验
        if(isEmpty(mpkid)){
            alert("请先保存数据！");
            return;
        }
        common_uploadFile({
            identity: 'dg',
            param: {
                cat: "dmDataRecExter",
                sourceId: mpkid,
                successCellBack: "",
                fialCellBack: ""
            }
        });
    }
    //上传
    function common_uploadFile(edopt) {
        var title_ = $.i18n.t('common:COMMON_OPERATION.UPLOAD');
        ShowWindowIframe({
            width: 575,
            height: 200,
            title: title_,
            param: $.extend({}, edopt.param),
            url: "/views/data_manager/dm/upload/attachment_add.shtml"
        });
    }
    function reload_() {

    }
    //上传成功后回填路径
    function afterUpload(pkid) {
        InitFuncCodeRequest_({
            data: {
                pkid: pkid,
                catagory: 'dmDataRecExter',
                FunctionCode: 'DM_DATA_REC_EXTER_UPLOAD'
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                }
            }
        });
    }
    //附件查看
    function viewAttach() {
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: mpkid,
                CATEGORY: "dmDataRecExter",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                //为0时提示没有上传附件，无法查看
                if (jdata.data.length==0){
                    MsgAlert({content: "请先上传附件", type: 'error'});

                }else {
                    //打开一个列表页面
                    ShowWindowIframe({
                        width: "515",
                        height: "285",
                        param: {
                            pkid: mpkid,
                            category: "dmDataRecExter",
                            namespace: namespace,
                            status: status,
                            operation: operation
                        },
                        url: "/views/data_manager/dm/upload/editAttach.shtml"
                    });
                }
            }
        });
    }


    function checkNo(dataNo) {
        var reg = /[\x00-\xff]/g;
        if (dataNo != null && dataNo != "") {
            if (!reg.test(dataNo)) {
                $("#dataNo").val("");
                MsgAlert({content: "不允许输入半角！", type: 'error'});
            } else {
                dataNo = dataNo.replace(/\s*/g, "");
                dataNo = dataNo.toUpperCase();
                $("#dataNo").val(dataNo);
            }
        }
    }

    function checkVer(dataVer) {
        var reg = /^[0-9a-zA-Z]+$/;
        var sta = dataVer.substring(0, 1);
        var end = dataVer.substring(1);
        if (!reg.test(dataVer)) {
            $("#dataVer").val("");
            MsgAlert({content: "只能输入数字和字母！", type: 'error'});
        } else {
            if (sta.toUpperCase() == 'R') {
                MsgAlert({content: "首字母不允许为r/R！", type: 'error'});
                $("#dataVer").val(end);
            } else {
                dataVer = dataVer.toUpperCase();
                $("#dataVer").val(dataVer);
            }
        }
    }

    function checkAta() {
        var ata = $("#ata").combobox("getValues");
        var strs = ata.sort();
        var atas = strs.join(",");
        $("#ata").combobox("setValue", atas);
    }


    function curDate() {
        var now = new Date();
        var year = now.getFullYear(); //得到年份
        var month = now.getMonth();//得到月份
        var date = now.getDate();//得到日期
        month = month + 1;
        if (month < 10) {
            month = "0" + month
        }
        if (date < 10) {
            date = "0" + date
        }
        var curDate = year + "-" + month + "-" + date;
        return curDate;
    }


    function crossDm() {
        var pkid = $("#pkid").val();
        var pkids = $("#pkids").val();
        if (pkid) {
            var dataType = $("#dataType").combobox('getValue');
            var title_ = $.i18n.t('对应资料列表');
            ShowWindowIframe({
                width: 750,
                height: 350,
                title: title_,
                param: {dataType: dataType, pkid: pkid, pkids: pkids},
                url: "/views/data_manager/technology_data/dmCrossList.shtml"
            });
        } else {
            MsgAlert({content: "请先保存资料", type: 'error'});
        }
    }

    function addFile() {
        var pkid = $("#pkid").val();
        var pkids = $("#pkids").val();
        if (pkid) {
            var dataType = $("#dataType").combobox('getValue');
            var title_ = $.i18n.t('附加文件待选列表');
            ShowWindowIframe({
                width: 750,
                height: 350,
                title: title_,
                param: {dataType: dataType, pkid: pkid, pkids: pkids},
                url: "/views/data_manager/technology_data/dmAddList.shtml"
            });
        } else {
            MsgAlert({content: "请先保存资料", type: 'error'});
        }
    }

    //MOD增加附加文件
    function InitDataGrid() {
        $("#dg1").MyDataGrid({
            identity: 'dg1',
            sortable: true,
            singleSelect: true,
            pagination: false,
            pageSize: 15,
            enableLineEdit: true,
            queryParams: {mpkid: mpkid},
            columns: {
                param: {FunctionCode: "DM_REF_ADDITION_LIST"},
                alter: {
                    TEST_UPLOAD: {
                        formatter: function (value, row, index) {
                            if (row.TEST_UPLOAD) {
                                return '<a href="javascript:void(0);" rowindex="' + index + '" class="attach">' +
                                    '<img src="/img/edit2.png" border="0" style="width:15px;height:15px;"/></a>'
                            }
                        }
                    },
                    DATA_TYPE: {
                        editor: {
                            type: 'textbox', options: {required: false,editable:false,onlyview:true}
                        }
                    },
                    DATA_NO: {
                        editor: {
                            type: 'textbox', options: {required: true,editable:false,onlyview:true}
                        }
                    },
                    DATA_VER: {
                        editor: {
                            type: 'textbox', options: {required: true,editable:false,onlyview:true}

                        }
                    },
                    CREATE_DATE: {
                        editor: {
                            type: 'datetime', options: {required: false,editable:false,onlyview:true}

                        }
                    },
                    CMEMO: {
                        editor: {
                            type: 'textbox', options: {required: false}

                        }
                    }
                }
            },
            onLoadSuccess: function () {
                InitSuspend('a.attach', {
                    'onmouseover': function (thiz, event, callback) {
                        var index = $(thiz).attr("rowindex");
                        var row = $("#dg1").datagrid('getRows')[index];
                        InitFuncCodeRequest_({
                            data: {
                                SOURCE_ID: row.PKID,
                                CATEGORY: "dmDataRecExter",
                                FunctionCode: 'ATTACHMENT_RSPL_GET'
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {

                                }
                                var html = "";
                                var sta = row.DATA_STATUS;
                                for (var i = 0; i < jdata.data.length; i++) {
                                    if (sta == "YFB") {
                                        html += '<li><a target="_blank" onclick="downFile(' + jdata.data[i].PKID + ')">' + jdata.data[i].ORG_NAME + '</a></li>';
                                    } else {
                                        html += '<li><a target="_blank" onclick="downFile(' + jdata.data[i].PKID + ')">' + jdata.data[i].ORG_NAME + '</a><span onclick="deleteFile(\'' + jdata.data[i].PKID + '\');return false;" class="icon-cross"></span></li>';
                                    }
                                }
                                callback(html);
                            }
                        });
                    }
                });
            },
            onBeforeLoad: function (data) {
            },
            onEndEdit: function (index, row, changes) {
                saveMemo(index, row, changes);
            },
            contextMenus: [
               {
                    id: "m-delete", i18nText: "删除", auth: "",
                    onclick: function () {
                        var row = $('#dg1').datagrid('getSelected');
                        var rowIndex = $('#dg1').datagrid('getRowIndex', row);
                        if (!row.PKID) {
                            //如果没有保存，直接在datagrid移除该行
                            $('#dg1').datagrid('deleteRow', rowIndex);
                        } else {
                            InitFuncCodeRequest_({
                                data: {
                                    pkid: row.CPKID,
                                    FunctionCode: 'DM_ADD_FILE_DEL'
                                },
                                successCallBack: function (jdata) {
                                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                        $('#dg1').datagrid('deleteRow', rowIndex);
                                        reload_("#dg1");
                                        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    } else {
                                        MsgAlert({content: jdata.msg, type: 'error'});
                                    }
                                }
                            });
                        }
                    }
                },
            ],
            onBeforeLoad: function (data) {
            },
            validAuth: function (row, items) {
                if (operation == 'view') {
                    items['删除'].display = false;
                }
                return items;
            },
            onBeginEdit: function (index, row) {
            }
        });
    }

    function reload_(dg) {
        $(dg).datagrid("reload");
    }

    function saveMemo(index, row, changes) {
        row = toCamelCase(row);
        var data = $.extend({}, {
            cpkid:row.cpkid,
            cmemo:row.cmemo,
        }, row, {FunctionCode: 'DM_DATA_ADD_MEMO'});
        InitFuncCodeRequest_({
            data: data,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    reload_("#dg1");
                }
            }
        });
    }

</script>
</html>