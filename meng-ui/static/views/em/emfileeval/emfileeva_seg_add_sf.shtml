<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>增加顺丰执行文件</title>
</head>

<body class="ibody">
<div class="ibox float-e-margins" style="width: 100%">
    <div class="ibox-content">
        <table class="table table-bordered table-info">
            <tr id = "btnId">
                <td class="tdr" colspan="6">
                    <input class="btn btn-primary" type="button" onclick="save()" value="保存"
                           style="width: 50px;margin-left:500px;"/>
                    <input id="upBtn" class="btn btn-primary" type="button" onclick="upload()" value="上传"
                           style="width: 50px;margin:5px;"/>
                    <input class="btn btn-primary" type="button" onclick="CloseWindowIframe()" value="关闭"
                           style="width: 50px;margin:5px;"/>
                </td>
            </tr>
        </table>

        <form id="mform" class="form-horizontal">
            <input type="hidden" id="pkid" name="pkid"/>

            <table class="table table-bordered table-info">
                <tr id="attach">
                    <th class="th" align="right" style="width: 80px;">附件：</th>
                    <td class="tdr" colspan="5">
                        <a href="javascript:void(0);" class="attach"><img src="/img/edit2.png" border="0"
                                                                          style="width:15px;height:15px;"/></a>
                    </td>
                </tr>
                <tr>
                    <th class="td" id="id_exe_no" style="width: 120px; text-align: right">EO编号：</th>
                    <td class="td5">
                        <input class="easyui-textbox" style="width: 150px" id="exeNo" name="exeNo"/>
                    </td>
                    <th class="td" id="id_exe_ver" align="right">EO版次：</th>
                    <td class="td5">
                        <input class="easyui-textbox" style="width: 150px" id="exeVer" name="exeVer"/>
                    </td>
                </tr>
                <tr id="id_deal">
                    <th class="td" align="right">处理措施：</th>
                    <td class="td5" colspan="3">
                        <textarea class="easyui-textbox " id="dealMeasure" name="dealMeasure"
                                  data-options="required:true"
                                  multiline="true"
                                  style="height:30px;width: 81%;border: 1px solid #ddd;border-radius: 5px;"
                        ></textarea>
                    </td>
                </tr>
                <tr id="id_row_apply_type">
                    <th id="man1" class="td" align="right">适用类型：</th>
                    <td id="man2" class="td5">
                        <input class="easyui-combobox" id="applyType" name="applyType" style="width: 150px"
                               data-options="required:true"/>
                    </td>
                    <th class="td" id="id_apply_model" align="right">适用型号：</th>
                    <td id="id_apply_model1" class="td5">
                        <input class="easyui-combobox" id="applyModel" name="applyModel" style="width: 150px"
                               data-options="required:true"/>
                    </td>
                </tr>
                <tr id="id_row_ata">
                    <th class="td" align="right">章节：</th>
                    <td class="td5">
                        <input class="easyui-combobox" id="ata" name="ata" style="width: 150px"
                               data-options="required:true"/>
                    </td>
                    <th class="td" id="id_master" align="right">是否主改装：</th>
                    <td id="id_master1" class="td5">
                        <input class="easyui-combobox" id="ifMaster" name="ifMaster" style="width: 150px"
                        />
                    </td>
                </tr>
            </table>
        </form>
    </div>
</div>
<table class="table table-bordered table-info" style="margin-top: 10px">
    <tr>
        <th style="width: 120px;">分组编号：</th>
        <td style="width: 100px;">
            <input class="easyui-combobox" id="groupName" style="width: 100px"/>
        </td>
        <th style="width: 70px">Config：</th>
        <td style="width: 100px">
            <input class="easyui-combobox" id="appConfig" style="width: 100px"/>
        </td>
        <th id="id_con1" style="width: 70px">机号：</th>
        <td id="id_con11" style="width: 100px">
            <input class="easyui-textbox" id="acno" style="width: 100px"/>
        </td>
        <th id="id_con2" style="width: 70px">件号：</th>
        <td id="id_con21" style="width: 100px">
            <input class="easyui-textbox" id="partno" style="width: 100px"/>
        </td>
        <th id="id_con3" style="width: 70px">序号：</th>
        <td id="id_con31" style="width: 100px">
            <input class="easyui-textbox" id="serialnum" style="width: 100px"/>
        </td>
        <td>
            <a class="searchBtn" data-options="iconCls:'icon-search'" onclick="searchDg()">查询</a>
        </td>
    </tr>
</table>
<div id="mlayout" class="easyui-layout" style="height: 380px; width: 100%">
    <span id="id_applic_text"></span>
    <div id="lay_left" data-options="region:'west',split:false" style="width: 370px">
        <fieldset class="fieldset_eui">
            <legend>待选适用性</legend>
            <table id="dg" aligh="center"></table>
        </fieldset>
    </div>
    <div id="lay_center" data-options="region:'center'" style="height: 100%; width: 50px">
        <input id = 'sa1' class="btn btn-primary" type="button" onclick="saveChecks()" value=">>>"
               style="width: 40px; margin-top: 150px; margin-left: 5px;"/>
        <br/>
        <input id = 'sa2' class="btn btn-primary" type="button" onclick="saveChecks2()" value="<<<"
               style="width: 40px; margin-top: 10px; margin-left: 5px;"/>
    </div>
    <div id="lay_right" data-options="region:'east'" style="width: 360px">
        <fieldset class="fieldset_eui">
            <legend>已选适用性</legend>
            <table id="dg2"></table>
        </fieldset>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var param;

    var dealOpinion;
    var dealMeasure;
    var taskNature;
    var taskId;
    var evapkid;
    var appType;
    var applyModel;
    var ata;
    var exeFlag;
    var exePkid;
    var pkid;
    var rvalues;
    var segpkid;
    var workType;
    var needMaster;
    var status;
    var operation;
    var rangValues = [];

    function i18nCallBack() {
        param = getParentParam_();
        dealOpinion = param.dealOpinion;
        dealMeasure = param.dealMeasure;
        taskNature = param.taskNature;
        taskId = param.taskId;
        evapkid = param.evapkid;
        appType = param.applyType;
        applyModel = param.applyModel;
        ata = param.ata;
        exeFlag = param.exeFlag;
        pkid = param.pkid;
        segpkid = param.segpkid;
        workType = param.workType;
        needMaster = param.needMaster;
        status = param.status;
        operation = param.operation;
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "YESORNO"
            },
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#ifMaster').combobox({
                        data: jdata.data.YESORNO,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '100px'
                    });
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
        if (status == '生效' && dealOpinion != 'TB') {
            $("#sa1").attr("disabled", true);
            $("#sa2").attr("disabled", true);
        }

        if (appType == "PART") {
            $('#id_apply_model').hide();
            $('#id_apply_model1').hide();
            $("#applyModel").combobox({required: false});
        } else {
            $('#id_apply_model').show();
            $('#id_apply_model1').show();
            $("#applyModel").combobox({required: true});
        }
        if (dealOpinion == "OTHERS") {
            $("#upBtn").show();
            $("#attach").show();
        } else {
            $("#upBtn").hide();
            $("#attach").hide();
        }
        if (needMaster && dealOpinion == "EO") {
            $("#ifMaster").combobox({required: true});
            $("#id_master").show();
            $("#id_master1").show();
        } else {
            $("#ifMaster").combobox({required: false});
            $("#id_master").hide();
            $("#id_master1").hide();
        }

        if (dealOpinion == "EO") {
            $("#dealMeasure").textbox({required: false});
            $("#applType").combobox({required: false});
            $("#fleet").combobox({required: false});
            $('#id_exe_no').text("EO编号：");
            $('#id_exe_ver').text("EO版次：");
            $('#id_deal').hide();
            $('#appMpType').hide();
        } else if (dealOpinion == "EA") {
            $("#dealMeasure").textbox({required: false});
            $("#applType").combobox({required: false});
            $("#fleet").combobox({required: false});
            $('#id_exe_no').text("EA编号：");
            $('#id_exe_ver').text("EA版次：");
            $('#id_deal').hide();
            $('#appMpType').hide();
        } else if (dealOpinion == "MP") {
            $("#dealMeasure").textbox({required: false});
            $("#applyType").combobox({required: false});
            $("#applyModel").combobox({required: false});
            $('#id_exe_no').text("MP项目编号：");
            $('#id_exe_ver').text("文件版次：");
            $('#id_row_apply_type').show();
            $('#appMpType').hide();
            $('#id_deal').hide();
        } else if (dealOpinion == "TB") {
            $("#dealMeasure").textbox({required: false});
            $("#applType").combobox({required: false});
            $("#fleet").combobox({required: false});
            $('#id_exe_no').text("TB编号：");
            $('#id_exe_ver').text("TB版次：");
            $('#id_deal').hide();
            $('#appMpType').hide();
        } else if (dealOpinion == "OTHERS") {
            $('#exeVer').textbox({editable: false, onlyview: true});
            $("#applType").combobox({required: false});
            $("#fleet").combobox({required: false});
            $("#applyType").combobox({required: false});
            $("#applyModel").combobox({required: false});
            $("#ata").combobox({required: false});
            $('#id_exe_no').text("编号：");
            $('#id_exe_ver').text("版次：");
            $('#id_row_apply_type').hide();
            $('#id_row_ata').hide();
            $('#id_deal').show();
            $('#appMpType').hide();
            $("#exeNo").textbox("setValue", "N/A");
        } else if (dealOpinion == "SYBZX") {
            $('#exeNo').textbox({editable: false, onlyview: true});
            $('#exeVer').textbox({editable: false, onlyview: true});
            $("#applType").combobox({required: false});
            $("#fleet").combobox({required: false});
            $("#applyType").combobox({required: false});
            $("#applyModel").combobox({required: false});
            $("#ata").combobox({required: false});
            $("#exeNo").textbox("setValue", "N/A");
            $('#id_exe_no').text("编号：");
            $('#id_exe_ver').text("版次：");
            $('#id_row_apply_type').hide();
            $('#id_row_ata').hide();
            $('#id_deal').show();
            $('#appMpType').hide();
        } else if (dealOpinion == "JYD") {
            $("#dealMeasure").textbox({required: false});
            $("#applType").combobox({required: false});
            $("#applyType").combobox({required: false});
            $("#fleet").combobox({required: false});
            $('#id_exe_no').text("建议单号：");
            $('#id_exe_ver').text("版次：");
            $('#id_deal').hide();
            $('#appMpType').hide();
            $('#man1').hide();
            $('#man2').hide();
        }

        if (dealOpinion == "EO" || dealOpinion == "EA" || dealOpinion == "MP" || dealOpinion == "TB" || dealOpinion == "JYD") {
            $('#exeNo').textbox({
                editable: false,
                onlyview: true
            });

            $('#exeVer').textbox({
                editable: false,
                onlyview: true
            });

            InitFuncCodeRequest_({
                data: {
                    FunctionCode: 'EM_FILE_APPLY_MODEL_EO',
                    evaId: evapkid
                },
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        $('#applyModel').combobox({
                            data: jdata.data,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            panelHeight: '60px',
                            editable: true
                        });
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });

            InitFuncCodeRequest_({
                data: {
                    FunctionCode: 'EM_FILE_APPLY_MODEL_EO',
                    evaId: evapkid
                },
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        $('#fleet').combobox({
                            data: jdata.data,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            panelHeight: '60px',
                            editable: true
                        });
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });

            InitFuncCodeRequest_({
                data: {
                    FunctionCode: 'EM_FILE_APPLY_ATA_EO',
                    evaId: evapkid
                },
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        $('#ata').combobox({
                            data: jdata.data,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            panelHeight: '60px'
                        });
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        }

        if (dealOpinion == "EO" || dealOpinion == "EA" || dealOpinion == "JYD" || dealOpinion == "MP") {
            InitFuncCodeRequest_({
                data: {
                    FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                    domainCode: "EM_APPL_TYPE"
                },
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        $('#applyType').combobox({
                            data: jdata.data.EM_APPL_TYPE,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            panelHeight: '100px',
                            onChange: applyTypeChange
                        });
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        }
        if (dealOpinion == "TB") {
            InitFuncCodeRequest_({
                data: {
                    FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                    domainCode: "EMTB_APPLY_TYPE"
                },
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        $('#applyType').combobox({
                            data: jdata.data.EMTB_APPLY_TYPE,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            panelHeight: '100px',
                            onChange: applyTypeChange
                        });
//                        if (appType.indexOf(",") == -1) {
//                            $("#applyType").combobox("setValue", appType);
//                        }
//                        if (applyModel.indexOf(",") == -1) {
//                            $("#applyModel").combobox("setValue", applyModel);
//                        }

                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        }


        if (workType == 'PN') {
            if (dealOpinion == "EO" || dealOpinion == "EA" || dealOpinion == "MP") {
                $('#applyType').combobox({editable: false, onlyview: true});
                $('#applyType').combobox('setValue', 'PART');
            }
        }

        if (workType == 'PN') {
            if (dealOpinion == "EO" || dealOpinion == "EA") {
                $('#applyModel').combobox({editable: false, onlyview: true});
                $('#applyModel').combobox('setValue', 'CM');
            }
        }
        if (ata.indexOf(",") == -1) {
            $("#ata").combobox("setValue", ata);
        }
        if (dealOpinion == "MP") {
            $('#exeVer').textbox('setValue', '00');
        } else {
            if (dealOpinion == "SYBZX" || dealOpinion == "OTHERS") {
                $('#exeVer').textbox('setValue', 'N/A');
            } else {
                $('#exeVer').textbox('setValue', '0');
            }
        }
        if (pkid) {
            $('#applyType').combobox({editable: false, onlyview: true});
            $('#applyModel').combobox({editable: false, onlyview: true});
            $('#ata').combobox({editable: false, onlyview: true});

            InitDataForm();
        }

        if (appType == "APL") {
            $('#id_con2').hide();
            $('#id_con21').hide();
            $('#id_con3').hide();
            $('#id_con31').hide();
        } else {
            $('#id_con1').hide();
            $('#id_con11').hide();
        }

        initApplic();
        attachList(pkid);
        if(operation == "view"){
            $('#btnId').hide();
            $("#sa1").attr("disabled", true);
            $("#sa2").attr("disabled", true);
        }
    }

    function applyTypeChange() {
        var applyType = $("#applyType").combobox('getValue');
        if (applyType == "PART") {
            $("#applyModel").combobox({disabled: true});
            $("#applyModel").combobox('setValue', 'CM');
        } else {
            InitFuncCodeRequest_({
                data: {
                    FunctionCode: 'EM_FILE_APPLY_MODEL_EO',
                    evaId: evapkid
                },
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if(dealOpinion == 'TB'){
                            $('#applyModel').combobox({
                                data: jdata.data,
                                valueField: 'VALUE',
                                textField: 'TEXT',
                                panelHeight: '60px',
                                multiple: true,
                                editable: true
                            });
                        }else{
                            $('#applyModel').combobox({
                                data: jdata.data,
                                valueField: 'VALUE',
                                textField: 'TEXT',
                                panelHeight: '60px',
                                editable: true
                            });
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
            $("#applyModel").combobox({disabled: false});
        }
    }

    function attachList(pkid) {
        InitSuspend('a.attach', {
            'onmouseover': function (thiz, event, callback) {
                InitFuncCodeRequest_({
                    data: {
                        SOURCE_ID: pkid,
                        CATEGORY: "emFileEvalSf",
                        FunctionCode: 'ATTACHMENT_RSPL_GET'
                    },
                    successCallBack: function (jdata) {
                        if (jdata.code === RESULT_CODE.SUCCESS_CODE) {

                        }
                        var html = "";
                        for (var i = 0; i < jdata.data.length; i++) {
                            html += '<li><a target="_blank" onclick="downFile(' + jdata.data[i].PKID + ')">' + jdata.data[i].ORG_NAME + '</a><span onclick="deleteFile(\'' + jdata.data[i].PKID + '\');return false;" class="icon-cross"></span></li>';
                        }
                        callback(html);
                    }
                });
            }
        })
    }

    function InitDataForm() {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "DM_FILE_SF_BY_PKID",
                pkid: pkid
            },
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    $("#applyModel").combobox('setValue', jdata.data.APPLY_MODEL);
                    rvalues = jdata.data.APPS;
                    exePkid = jdata.data.EXE_PKID;
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function initApplic() {
        if (! pkid) {
            $('#id_applic_text').text("请先保存执行文件信息！");
            $('#lay_left').hide();
            $('#lay_center').hide();
            $('#lay_right').hide();
            return;
        }

        if (dealOpinion == "OTHERS" || dealOpinion == "SYBZX" || dealOpinion == "JYD") {
            initApplicShow();
            return;
        }

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_FILE_EVAL_SF_APPLY_TYPE",
                pkid: pkid
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (appType != jdata.data.APPLY_TYPE) {
                        $('#id_applic_text').show();
                        $('#id_applic_text').text("此执行文件适用类型与评估单不一致不允许设置适用性");
                        $('#lay_left').hide();
                        $('#lay_center').hide();
                        $('#lay_right').hide();
                    } else {
                        initApplicShow();
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    function initApplicShow() {
        $('#id_applic_text').hide();
        $('#lay_left').show();
        $('#lay_center').show();
        $('#lay_right').show();
        InitDataGrid();
        InitDataGrid2();

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_FILE_EVAL_SEG_TASK_GROUP",
                taskId: taskId
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#groupName').combobox({
                        data: jdata.data,
                        valueField: "VALUE",
                        textField: "TEXT",
                        panelHeight: '100px'
                    });
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });

        $('#appConfig').combobox({
            data: [
                {"id": "Config1"},
                {"id": "Config2"},
                {"id": "Config3"}
            ],
            valueField: "id",
            textField: "id",
            panelHeight: '80px'
        });
    }

    function InitDataGrid() {
        var func = "";
        if (appType == "APL") {
            func = "EM_FILE_SF_GROUP_LIST";
        } else if (appType == "PART") {
            func = "EM_FILE_SF_GROUP_PART";
        } else if (appType == "ENG") {
            func = "EM_FILE_SF_GROUP_ENG";
        }
        var params = {
            taskNature: taskNature,
            evapkid: evapkid,
            taskId: taskId,
            exeFlag: exeFlag,
            sfPkid: pkid
        };

        $("#dg").MyDataGrid({
            identity: 'dg',
            sortable: true,
            fitcolumn: true,
            pagination: false,
            resize: function() {
                return {width: 355, height: 346};
            },
            queryParams: params,
            columns: {
                param: {FunctionCode: func}
            },
            loadFilter: function(data) {
                var v = {
                    total: 0,
                    rows: []
                };
                $.each(data.rows, function (i, item) {
                    if (item.SF_NUM == 0) {
                        v.rows.push(item);
                    }
                });
                v.total = v.rows.length;
                return v;
            }
        });
    }

    function InitDataGrid2() {
        var func = "";
        if (appType == "APL") {
            func = "EM_FILE_SF_GROUP_LIST";
        } else if (appType == "PART") {
            func = "EM_FILE_SF_GROUP_PART2";
        } else if (appType == "ENG") {
            func = "EM_FILE_SF_GROUP_ENG";
        }
        var params = {
            taskNature: taskNature,
            evapkid: evapkid,
            taskId: taskId,
            exeFlag: exeFlag,
            sfPkid: pkid
        };

        $("#dg2").MyDataGrid({
            identity: 'dg2',
            sortable: true,
            fitcolumn: true,
            pagination: false,
            resize: function() {
                return {width: 345, height: 346};
            },
            queryParams: params,
            columns: {
                param: {FunctionCode: func}
            },
            loadFilter: function(data) {
                var v = {
                    total: 0,
                    rows: []
                };
                $.each(data.rows, function (i, item) {
                    if (item.SF_NUM > 0) {
                        v.rows.push(item);
                    }
                });
                v.total = v.rows.length;
                return v;
            }
        });
    }

    function searchDg() {
        $('#dg').datagrid('load', {
            taskNature: taskNature,
            evapkid: evapkid,
            taskId: taskId,
            sfPkid: pkid,
            groupName: $('#groupName').combobox('getValue'),
            appConfig: $('#appConfig').combobox('getValue'),
            acno: $('#acno').textbox('getValue'),
            partno: $('#partno').textbox('getValue'),
            serialnum: $('#serialnum').textbox('getValue')
        });
    }

    // 保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (! isValidate) return;

        if (dealOpinion == "EO" || dealOpinion == "EA" || dealOpinion == "JYD" || dealOpinion == "TB") {
            var applyType = $("#applyType").textbox('getValue');
            if (appType == "PART" && applyType != "PART") {
                MsgAlert({content: "部件类评估单只能增加部件类执行文件！", type: 'error'});
                return;
            }
            if (appType == "ENG" && applyType == "APL") {
                MsgAlert({content: "发动机类评估单只能增加发动机或部件类执行文件！", type: 'error'});
                return;
            }
            if (appType == "APL" && applyType == "ENG") {
                MsgAlert({content: "机身类评估单只能增加机身或部件类执行文件！", type: 'error'});
                return;
            }
        }
        var ifMaster = $('#ifMaster').combobox('getValue');
//        if (needMaster && workType == 'GZ') {
//            if (dealOpinion == "EO" && ifMaster != 'Y') {
//                MsgAlert({content: "改装类的EO只能选是主改装！", type: 'error'});
//                $('#ifMaster').combobox('setValue', '');
//                return;
//            }
//        }

        var applyModel = $("#applyModel").textbox('getValue');
        if (!pkid) {
            if (dealOpinion == "JYD") {
                $("#exeNo").textbox('setValue', randomNumberJyd());
            } else if (dealOpinion == "EO" || dealOpinion == "EA" || dealOpinion == "TB") {
                $("#exeNo").textbox('setValue', randomNumber(dealOpinion, applyType, applyModel));
            }
        }
        if (dealOpinion == "OTHERS" || dealOpinion == "SYBZX") {
            dealMeasure = $("#dealMeasure").textbox("getValue");
        }

        var $form = $("#mform");
        var datas = $form.serializeObject();
        if (Array.isArray(datas['applyModel'])) {
            datas['applyModel'] = datas['applyModel'].join(',');
        }
        datas = $.extend({FunctionCode: "EM_FILE_EVAL_STF_SAVE"}, datas, {
            dealOpinion: dealOpinion,
            dealMeasure: dealMeasure,
            taskPkid: taskId,
            pkid: pkid,
            segpkid: segpkid,
            taskNature: taskNature,
            applyType: applyType,
            evapkid: evapkid, // no OTHERS
            appType: appType //MP, no OTHERS
        });
        InitFuncCodeRequest_({
            data: datas,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $("#pkid").val(jdata.data.pkid);
                    pkid = jdata.data.pkid;
                    $('#applyType').combobox({editable: false, onlyview: true});
                    $('#applyModel').combobox({editable: false, onlyview: true});
                    $('#ata').combobox({editable: false, onlyview: true});
                    InitDataForm();

                    exePkid = jdata.data.exePkid;
                    var itemNumber = jdata.data.exeNo;
                    if (dealOpinion == "MP") {
                        $("#exeNo").textbox('setValue', itemNumber);
                    }
                    initApplic();
                    if (exeFlag == "OTHERS") {
                        param.OWindow.reload_7();
                    } else {
                        param.OWindow.reload_("#dg2");
                    }
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    function saveChecks() {
        //序列化列表数据
        var rows = $('#dg').datagrid('getChecked');
        for (i = 0; i < rows.length; i++) {
            rows[i] = toCamelCase(rows[i]);
        }
        var detailData = JSON.stringify(rows);
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_FILE_EVAL_GROUP_SAVE",
                detailData: detailData,
                sfpkid: $('#pkid').val(),
                exePkid: exePkid,
                dealOpinion: dealOpinion,
                applyType: appType,
                opFlag: "SF"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#dg').datagrid('reload');
                    $('#dg2').datagrid('reload');
                    if (exeFlag == "OTHERS") {
                        param.OWindow.reload_7();
                    } else {
                        param.OWindow.reload_("#dg2");
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    function saveChecks2() {
        var rows = $('#dg2').datagrid('getChecked');
        for (i = 0; i < rows.length; i++) {
            rows[i] = toCamelCase(rows[i]);
        }
        var detailData = JSON.stringify(rows);
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_FILE_EVAL_GROUP_DEL",
                detailData: detailData,
                sfpkid: $('#pkid').val(),
                exePkid: exePkid,
                dealOpinion: dealOpinion,
                opFlag: "SF"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#dg').datagrid('reload');
                    $('#dg2').datagrid('reload');
                    if (exeFlag == "OTHERS") {
                        param.OWindow.reload_7();
                    } else {
                        param.OWindow.reload_("#dg2");
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    function randomNumberJyd() {
        var ata = $("#ata").combobox('getValues');
        var fleet = $("#applyModel").combobox('getValue');
        if (Array.isArray(ata)) {
            ata = ata.join(',');
        }
        var num = 1;
        if (ata.indexOf(",") != -1) {
            ata = "MULT";
        }
        var todayDate = new Date();
        var year = todayDate.getFullYear();
        var serialNo = fleet + "-" + ata + "-" + year;
        InitFuncCodeRequest_({
            data: {serialNo: serialNo, FunctionCode: "TD_REVSUG_BY_NO"},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        if (jdata.data.OLDNUM) {
                            num = parseInt(jdata.data.OLDNUM, 10) + 1;
                        }
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

        num = pad(num, 4);
        serialNo = serialNo + num;
        return serialNo;
    }

    function randomNumber(dealOpinion, applyType, applyModel) {
        var num = 1;
        var temp = "";
        var ata = $("#ata").textbox('getValue');

        var datas;
        if (dealOpinion == "EO" || dealOpinion == "EA") {
            if (applyType == "APL") { //EO前缀-机型-2位章节-4位流水号
                temp = applyModel;
            } else if (applyType == "ENG") { //EO前缀-发动机型号（位数不定）-2位章节号-4位流水号
                //评估单的入口暂时不做发动机的新增
                temp = applyModel;
            } else if (applyType == "PART") { //EO前缀-CM-2位章节号-4位流水号
                temp = "CM";
            }
            var serialNo = dealOpinion + "-" + temp + "-" + ata + "-";
            datas = {
                FunctionCode: "TD_EVAL_EO_BY_NO",
                serialNo: serialNo
            };
        } else if (dealOpinion == "TB") {
            var serialNo = dealOpinion + "-" + ata + "-";
            datas = {
                FunctionCode: "TD_EVAL_TB_BY_NO",
                serialNo: serialNo
            };
        }

        InitFuncCodeRequest_({
            data: datas,
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null && jdata.data.OLDNUM) {
                        num = parseInt(jdata.data.OLDNUM, 10) + 1;
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

        num = pad(num, 4);
        serialNo = serialNo + num;
        return serialNo;
    }

    var pad = function () {
        var tbl = [];
        return function (num, n) {
            var len = n - num.toString().length;
            if (len <= 0) return num;
            if (!tbl[len]) tbl[len] = (new Array(len + 1)).join('0');
            return tbl[len] + num;
        }
    }();

    //上传
    function upload() {
        //保存校验
        if (isEmpty(pkid)) {
            alert("请先保存数据！");
            return;
        }
        common_uploadFile({
            identity: 'dg',
            param: {
                cat: "emFileEvalSf",
                sourceId: pkid,
                successCellBack: "",
                fialCellBack: ""
            }
        });
    }

    //上传
    function common_uploadFile(edopt) {
        var title_ = $.i18n.t('common:COMMON_OPERATION.UPLOAD');
        ShowWindowIframe({
            width: 575,
            height: 200,
            title: title_,
            param: $.extend({}, edopt.param),
            url: "/views/data_manager/dm/upload/attachment_add.shtml"
        });
    }

    function reload_() {
        param.OWindow.reload_("#dg2");
    }


</script>
</html>
