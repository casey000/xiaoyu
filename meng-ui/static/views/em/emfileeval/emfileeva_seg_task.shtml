<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>增加分段任务</title>
</head>

<body>
<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <input type="hidden" class="easyui-textbox" id="pkid" name="pkid"/>
                <table class="table table-bordered table-info">
                    <tr>
                        <td  colspan="8" align="right">
                            <p id="tipSave" style="color: red">注意：时限信息需单独点击下方的保存按钮！</p>
                            <input id="bt1" class="btn btn-primary" type="button" onclick="save()" value="保存"
                                   style="width: 50px;margin:10px;"/>
                            <input class="btn btn-primary" type="button" onclick="CloseWindowIframe()" value="关闭"
                                   style="width: 50px;margin:5px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th nowrap class="th" align="right">任务编号：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="taskNo" name="taskNo" style="width:40px"
                                   data-options="onlyview: true,editable:false"/>
                        </td>
                        <th class="th" align="right">工作类型：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="workType" name="workType"
                                   data-options="required:true,editable:false"
                                   style="width:100px"/>
                        </td>
                        <th class="th" align="right">任务性质：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="taskNature" name="taskNature"
                                   data-options="required:true,editable:false" style="width:70px"/>
                        </td>
                        <th id='app' class="th" rowspan="3" align="right">适用对象：</th>
                        <td id='app1' class="tdr" rowspan="3">
                            <ul id="tt"></ul>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right">任务描述：</th>
                        <td class="tdr" colspan="5">
                                <textarea class="easyui-textbox " id="taskDesc" name="taskDesc"
                                          data-options="required:true"
                                          multiline="true"
                                          style="height:100px;width: 85%;border: 1px solid #ddd;border-radius: 5px;"
                                ></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th class="th">备注：</th>
                        <td class="tdr" colspan="5">
                                <textarea class="easyui-textbox " id="evaOpinion" name="evaOpinion"
                                          multiline="true"
                                          style="height:100px;width: 85%;border: 1px solid #ddd;border-radius: 5px;"
                                ></textarea>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
        <div id="tl">
        <div id="sp2" class="easyui-panel" title="首检时限分组" style="width: 980px;padding:10px; ">
            <table width="98%">
                <tr>
                    <td>
                        <input style="width: 50px;margin:5px;" type="button" class="btn btn-primary"
                               onclick="saveFC()" id="saveFc" value="保存">
                        <input style="width: 80px;margin:5px;" type="button" class="btn btn-danger"
                               onclick="resetTl('fc')" id="resetFc" value="重置时限">
                        <input type="checkbox" id="ifFcNote" name="ifFcNote" style="margin-left: 725px" _index="0"
                               onclick="this.value=this.checked?' Y':'N'"/>NOTE
                    </td>
                </tr>
                <tr>
                    <td>
                        <table id="appendTable" width="100%" border="0" cellspacing="0" cellpadding="0">
                            <tr>
                                <td width="80%"><!--第二层的table begin-->
                                    <table  width="100%" border="0" cellspacing="0" cellpadding="0">
                                        <tr>
                                            <td width="95%" style="border:none"><!--第三层的table begin-->
                                                <table  width="100%" border="0" cellspacing="0" cellpadding="0" class="table_sub_1">
                                                    <tr name="fcSgTr">
                                                        <td width="75%" style="border:solid #ccc 1px;">
                                                            <!--首检值table-->
                                                            <table border="1" cellpadding="0" cellspacing="0"
                                                                   bordercolor="#B2C9E0" class="table-zi"
                                                                   style="margin:5px;padding: 5px">
                                                                <tr>
                                                                    <!-- begin if -->
                                                                    <td style="padding: 3px" width="5%"
                                                                        valign="top" name="unit">
                                                                        <select name="vo.complianceTimes[0].eoSub1[0].eoSub2[0].eoSub3[0].startingLabel" class="doc_type" onchange="value_change_first(this)">
                                                                        </select>
                                                                    </td>
                                                                    <!-- nowrap="nowrap"  -->
                                                                    <td style="padding: 3px" width="10%"
                                                                        class="remove_content_td" name="value">
                                                                        <input type="text"
                                                                               class="{rangelength:[0,100]}"
                                                                               name="vo.complianceTimes[0].eoSub1[0].eoSub2[0].eoSub3[0].startingValue"
                                                                               style="width: 90px"/>
                                                                    </td>
                                                                    <td style="padding: 3px" width="15%"
                                                                        name="isPost" class="remove_content_td">
                                                                        <input style="margin-left: 5px"
                                                                               type="checkbox"
                                                                               name="vo.complianceTimes[0].eoSub1[0].eoSub2[0].eoSub3[0].isPost"
                                                                               onclick="postClick(this)">POST
                                                                    </td>

                                                                    <td width="15%" name="post" style="display: none">
                                                                        <input type="text"
                                                                               name="vo.complianceTimes[0].eoSub1[0].eoSub2[0].eoSub3[0].post" style='margin-left: 5px; width: 120px'>"
                                                                    </td>
                                                                    <td width="5%">
                                                                        <div>
                                                                            <img id="del"
                                                                                 onclick="del_query_tr_first(this);return false;"
                                                                                 src="../../../../../css/icons/delete.png"
                                                                                 style="margin-left: 5px;"/>
                                                                        </div>
                                                                    </td>
                                                                </tr>

                                                            </table>
                                                            <!--第四层table begin-->
                                                            <!--第四层table begin-->
                                                        </td>
                                                        <td width="10%" style="border:solid #ccc 1px;">
                                                            <div>
                                                                <img id="add"
                                                                     onclick="add_query_tr_first(this);return false;"
                                                                     src="../../../../../css/icons/add.png"
                                                                     style="margin-left: 10px;"/>
                                                            </div>
                                                        </td>
                                                        <td width="11%">
                                                            <div>
                                                                <ul style="padding-left:0px">
                                                                    <li style="list-style:none">
                                                                        &nbsp;<input name="vo.complianceTimes[0].eoSub1[0].eoSub2[0].firstLast" type="radio" value="XDWZ"  style="height:auto;display:none"/>
                                                                        <span style="display:none">FIRST</span> </li>
                                                                </ul>
                                                                <ul style="padding-left:0px">
                                                                    <li style="list-style:none">
                                                                        &nbsp;<input name="vo.complianceTimes[0].eoSub1[0].eoSub2[0].firstLast" type="radio" value="HDWZ" style="height:auto;display:none"/>
                                                                        <span style="display:none">LAST</span> </li>
                                                                </ul>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div>
                                                                <img id="del"
                                                                     onclick="del_query_tr_second(this);return false;"
                                                                     src="../../../../../css/icons/delete.png"/>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </table>
                                                <!--第三层的table end-->
                                            </td>
                                            <td width="5%" style="border:none">
                                                <div>
                                                    <img id="add"
                                                         onclick="add_query_tr_second(this);return false;"
                                                         src="../../../../../css/icons/add.png"/>
                                                    <!--<input id="add" type="button" onclick="add_query_tr_second(this);return false;">-->
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                    <!--第二层的table end-->
                                </td>
                                <td width="8%" style="border-right:none; border-top:none; border-bottom:none">
                                    <div>
                                        <ul style="padding-left:0px">
                                            <li style="list-style:none">
                                                &nbsp;<input name="vo.complianceTimes[0].eoSub1[0].firstLast" type="radio" style="height:auto;display:none" value="XDWZ"/>
                                                <span style="display:none">FIRST</span> </li>
                                        </ul>
                                        <ul style="padding-left:0px">
                                            <li style="list-style:none">
                                                &nbsp;<input name="vo.complianceTimes[0].eoSub1[0].firstLast" type="radio" value="HDWZ" style="height:auto;display:none"/>
                                                <span style="display:none">LAST</span> </li>
                                        </ul>
                                    </div>
                                </td>
                                <td width="12%" style="border-right:none; border-top:none; border-bottom:none">
		                                <textarea id="fcNote" disabled="disabled" class="{rangelength:[0,1000]}"
                                                  name="fcNote" rows="4" style="width:100%;"></textarea>
                                    <div class="errorMessage"></div>
                                </td>
                            </tr>
                        </table>
                        <!--Threshold end-->
                    </td>
                </tr>
            </table>
        </div>

        <div id="sp3" class="easyui-panel" title="重检时限分组" style="width: 980px;padding:10px; ">
            <table width="98%">
                <tr>
                    <td>
                        <input style="width: 50px;margin:5px;" class="btn btn-primary" type="button"
                               onclick="saveRC()" id="saveRc" value="保存">
                        <input style="width: 80px;margin:5px;" type="button" class="btn btn-danger"
                               onclick="resetTl('rc')" id="resetRc" value="重置时限">
                        <input type="checkbox" id="ifRcNote" name="ifRcNote" style="margin-left: 725px" _index="0"
                               onclick="this.value=this.checked?' Y':'N'"/>NOTE
                    </td>
                </tr>
                <tr>
                    <td>
                        <table id="appendTableRc" width="100%" border="0" cellspacing="0" cellpadding="0">
                            <tr>
                                <td width="80%"><!--第二层的table begin-->
                                    <table  width="100%" border="0" cellspacing="0" cellpadding="0">
                                        <tr>
                                            <td width="95%" style="border:none"><!--第三层的table begin-->
                                                <table  width="100%" border="0" cellspacing="0" cellpadding="0" class="table_sub_1">
                                                    <tr name="rcSgTr">
                                                        <td width="75%" style="border:solid #ccc 1px;">
                                                            <!--重检值table-->
                                                            <table border="1" cellpadding="0" cellspacing="0" bordercolor="#B2C9E0" class="table-zi" style="margin:5px;padding: 5px">
                                                                <tr>
                                                                    <!-- begin if -->
                                                                    <td style="padding: 3px" width="5%" valign="top" name="rcUnit">
                                                                        <select name="vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[0].eoSubRc3[0].rcStartingLabel" class="doc_type" onchange="value_change_first(this)">
                                                                        </select>
                                                                    </td>
                                                                    <!-- nowrap="nowrap"  -->
                                                                    <td style="padding: 3px;width:15%" class="remove_content_td" name="value" valign="top">
                                                                        <input type="text" style="width:90px" class="{rangelength:[0,100]}"
                                                                               name="vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[0].eoSubRc3[0].startingValue"/>
                                                                    </td>
                                                                    <td width="5%">
                                                                        <div>
                                                                            <img id="del"
                                                                                 onclick="del_query_tr_first(this);return false;"
                                                                                 src="../../../../../css/icons/delete.png"
                                                                                 style="margin-left: 5px;"/>
                                                                        </div>
                                                                    </td>
                                                                </tr>

                                                            </table>
                                                            <!--第四层table begin-->
                                                            <!--第四层table begin-->
                                                        </td>
                                                        <td width="10%" style="border:solid #ccc 1px;">
                                                            <div>
                                                                <img id="add"
                                                                     onclick="add_query_tr_first(this);return false;"
                                                                     src="../../../../../css/icons/add.png"
                                                                     style="margin-left: 10px;"/>
                                                            </div>
                                                        </td>
                                                        <td width="11%">
                                                            <div>
                                                                <ul style="padding-left:0px">
                                                                    <li style="list-style:none">
                                                                        &nbsp;<input name="vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[0].firstLast" type="radio" value="XDWZ"  style="height:auto;display:none"/>
                                                                        <span style="display:none">FIRST</span> </li>
                                                                </ul>
                                                                <ul style="padding-left:0px">
                                                                    <li style="list-style:none">
                                                                        &nbsp;<input name="vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[0].firstLast" type="radio" value="HDWZ" style="height:auto;display:none"/>
                                                                        <span style="display:none">LAST</span> </li>
                                                                </ul>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <div>
                                                                <img id="delRc"
                                                                     onclick="del_query_tr_second(this);return false;"
                                                                     src="../../../../../css/icons/delete.png"/>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </table>
                                                <!--第三层的table end-->
                                            </td>
                                            <td width="5%" style="border:none">
                                                <div>
                                                    <img id="addRc"
                                                         onclick="add_query_tr_second(this);return false;"
                                                         src="../../../../../css/icons/add.png"/>
                                                </div>
                                            </td>
                                        </tr>
                                    </table>
                                    <!--第二层的table end-->
                                </td>
                                <td width="8%" style="border-right:none; border-top:none; border-bottom:none">
                                    <div>
                                        <ul style="padding-left:0px">
                                            <li style="list-style:none">
                                                &nbsp;<input name="vo.complianceTimes[0].eoSubRc1[0].firstLast" type="radio" style="height:auto;display:none" value="XDWZ"/>
                                                <span style="display:none">FIRST</span> </li>
                                        </ul>
                                        <ul style="padding-left:0px">
                                            <li style="list-style:none">
                                                &nbsp;<input name="vo.complianceTimes[0].eoSubRc1[0].firstLast" type="radio" value="HDWZ" style="height:auto;display:none"/>
                                                <span style="display:none">LAST</span> </li>
                                        </ul>
                                    </div>
                                </td>
                                <td width="12%" style="border-right:none; border-top:none; border-bottom:none">
		                                <textarea id="rcNote" disabled="disabled" class="{rangelength:[0,1000]}"
                                                  name="rcNote" rows="4" style="width:100%;"></textarea>
                                    <div class="errorMessage"></div>
                                </td>
                            </tr>
                        </table>
                        <!--Threshold end-->
                    </td>
                </tr>
            </table>
        </div>
        </div>
    </div>
</div>
</body>
<link rel="stylesheet" href="/css/datepicker/jquery.ui.all.css">
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript" src="/js/jquery/jquery.ui.core.js"></script>
<script type="text/javascript" src="/js/jquery/jquery.ui.datepicker.js"></script>
<script type="text/javascript" src="/js/jquery/jquery.ui.widget.js"></script>
<script type="text/javascript">
    var param;
    var operation;
    var segpkid;
    var taskId;
    var evapkid;
    var dataType;
    var fcData;
    var rcData;
    var units;
    var runits;
    var isTlShow;
    var applyType;
    var datan;
    var otherData;
    var workType;
    var otherDatan = [];
    var ifAsms; //是否结构类
    function i18nCallBack() {
        param = getParentParam_();
        operation = param.operation;
        segpkid = param.segpkid;
        evapkid = param.evapkid;
        taskId = param.taskId;
        dataType = param.dataType;
        applyType = param.applyType;
        ifAsms=param.ifAsms;
        workType=param.workType;
        isTlShow = (dataType.indexOf("AD") != -1 || dataType.indexOf("CAD") != -1 || dataType.indexOf("AMOC") != -1 || (dataType.indexOf("SB") != -1 && ifAsms && ifAsms=="Y")) ? true : false;
        if (operation == "view") {
            $("#view").hide();
        }
        if(!isTlShow){
            $('#tl').hide();
            $('#tipSave').hide();
        }
        if(taskId && isTlShow){
            initFc(taskId);
            initRc(taskId);
        }
        InitFuncCodeRequest_({
            async: false,
            data: {
                domainCode: "EM_EVAL_WORK_TYPE,EM_EVAL_WORK_TYPE_E,EM_SEG_TASK_NATURE,YESORNO,EM_FILE_EVA_FC_UNIT,EM_FILE_EVA_RC_UNIT",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                    if (applyType == 'APL' || applyType == 'ENG') {
                        $('#workType').combobox({
                            panelHeight: '150px',
                            data: jdata.data.EM_EVAL_WORK_TYPE_E,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            onSelect: function (row) {
                                workChange(row.VALUE)
                            }
                        });
                    } else {
                        $('#workType').combobox({
                            panelHeight: '150px',
                            data: jdata.data.EM_EVAL_WORK_TYPE,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            onSelect: function (row) {
                                workChange(row.VALUE)
                            }
                        });
                    }
                    $('#taskNature').combobox({
                        panelHeight: '50px',
                        data: jdata.data.EM_SEG_TASK_NATURE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //初始化适用对象

                    units = jdata.data['EM_FILE_EVA_FC_UNIT'];
                    for(var i = 0; i<units.length; i++){
                        var opt = "<option value='" + units[i].VALUE + "'>" + units[i].TEXT + "</option>";
                        $("[name$='startingLabel']").append(opt);
                    }

                    runits = jdata.data['EM_FILE_EVA_RC_UNIT'];
                    for (var i = 0; i < runits.length; i++) {
                        var opt = "<option value='" + runits[i].VALUE + "'>" + runits[i].TEXT + "</option>";
                        $("[name$='rcStartingLabel']").append(opt);
                    }
                    initData();
                    if (taskId) {
                        InitDataForm(taskId);
                    } else {
                        InitFuncCodeRequest_({
                            data: {segpkid: segpkid, FunctionCode: "EM_FILE_MAX_TASKNO"},
                            async: false,
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    if (jdata.data != null) {
                                        $('#taskNo').textbox({value: jdata.data.TASKNO + 1});
                                    } else {
                                        $('#taskNo').textbox({value: 1});
                                    }
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                    if(isTlShow && fcData && fcData.fcBg && fcData.fcSgList){
                        initFcForm(fcData);
                    }
                    if(isTlShow && rcData && rcData.rcBg && rcData.rcSgList){
                        initRcForm(rcData);
                    }

                    if (operation == 'view') {
                        $("#bt1").prop("disabled", true);
                        $("#ifFcNote").prop("disabled", true);
                        $("#saveFc").prop("disabled", true);
                        $("#resetFc").prop("disabled", true);
                        $("#ifRcNote").prop("disabled", true);
                        $("#saveRc").prop("disabled", true);
                        $("#resetRc").prop("disabled", true);
                    }
                }

            }
        })
    }


    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "EM_FILE_TASK_BY_PKID"}, async: false, successCallBack: function (jdata) {
                console.log(jdata.code);
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    console.log(jdata.data);
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    var pn = jdata.data.WORK_TYPE;
                    var task = jdata.data.TASK_NATURE;
                    workChange2(pn, task);
                    //note回显
                    if(isTlShow){
                        var ifFcNote = jdata.data.IF_FC_NOTE;
                        var fcNote = jdata.data.FC_NOTE;
                        if(ifFcNote && ifFcNote =='Y'){
                            $('#ifFcNote').prop('checked','checked');
                            $('#fcNote').removeAttr('disabled');
                            $('#fcNote').val(fcNote);

                            $('#appendTable').find('select').attr('disabled','disabled');
                            $('#appendTable').find('input').attr('disabled','disabled');
                        }
                        var ifRcNote = jdata.data.IF_RC_NOTE;
                        var rcNote = jdata.data.RC_NOTE;
                        if(ifRcNote && ifRcNote =='Y'){
                            $('#ifRcNote').prop('checked','checked');
                            $('#rcNote').removeAttr('disabled');
                            $('#rcNote').val(rcNote);

                            $('#appendTableRc').find('select').attr('disabled','disabled');
                            $('#appendTableRc').find('input').attr('disabled','disabled');
                        }
                    }

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    // 保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        var $form = $("#mform");
        var datas = $form.serializeObject();
        var newworkType = $("#workType").combobox('getValue');
        var taskNature = $("#taskNature").combobox('getValue');
        if(newworkType == 'GZ' && taskNature != 'YCX'){
            MsgAlert({content: '工作类型为【改装】时，只能选一次性任务！', type: 'error'});
            return;
        }
        var clearFlag = 'N';
        if(workType == 'GZ' && newworkType != 'GZ'){
            alert("注意：改装任务调整会清空对应执行文件/前营运人执行记录对应‘主改装’属性!");
            clearFlag = 'Y';
        }
        var groups = "";
        datas = $.extend({segpkid: segpkid, groups: groups,clearFlag:clearFlag}, datas, {FunctionCode: 'EM_FILE_SEG_TASK_ADD'});
        InitFuncCodeRequest_({
            data: datas, async: false, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    param.OWindow.InitDataGrid1(segpkid);
                    $("#pkid").textbox('setValue', jdata.data.pkid);
                    taskId = jdata.data.pkid;
                    saveApp();
                    delSfoApp();
                    param.OWindow.reload_("#dg1");
                    param.OWindow.reload_("#dg2");
                    param.OWindow.reload_("#dg3");
                    param.OWindow.reload_("#dg4");
                    param.OWindow.reloadPar("#dg6");
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    //CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }


    function add() {
        ShowWindowIframe({
            width: "1366",
            height: "768",
            param: {pkid: pkid},
            url: "/views/em/emfileeval/emfileeva_add_group.shtml"
        });
    }

    function reload_(dg) {
        $(dg).datagrid("reload");
    }


    //时限START----

    //初始化首检表格
    function initFc(pkid) {
        InitFuncCodeRequest_({
            data: {
                pkid: pkid,
                FunctionCode: "EM_FILE_EVAL_TL_SELECT_FC"
            },
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    console.log(jdata.data);
                    fcData = jdata.data;
                    if(fcData.fcBg && fcData.fcSgList){
                        appendTable(fcData);
                    }else{
                        appendResetTable();
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //初始化重检表格
    function initRc(pkid) {
        InitFuncCodeRequest_({
            data: {
                pkid: pkid,
                FunctionCode: "EM_FILE_EVAL_TL_SELECT_RC"
            },
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    console.log(jdata.data);
                    rcData = jdata.data;
                    if(rcData.rcBg && rcData.rcSgList){
                        appendRcTable(rcData);
                    }else{
                        appendRcResetTable();
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //初始化首检表格数据
    function initFcForm(data) {
        var bgPrinciple = data.fcBg.fcBgPrinciple;
        //设置大组原则
        if(!bgPrinciple){//大组原则为空，隐藏大组原则
            var bgPriNode = $(":radio[name$='vo.complianceTimes[0].eoSub1[0].firstLast']");
            bgPriNode.hide();
            bgPriNode.next('span').hide();
        }else{
            $(":radio[name$='vo.complianceTimes[0].eoSub1[0].firstLast'][value='" + bgPrinciple + "']").prop("checked", "checked");
        }

        var sgList = data.fcSgList;
        for(var i = 0; i< sgList.length; i++) {
            //设置小组原则
            var sgPrinciple = sgList[i].sg.fcSgPrinciple;
            if(!sgPrinciple){//小组原则为空，则隐藏小组原则
                var sgPriNode = $(":radio[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].firstLast']");
                sgPriNode.hide();
                sgPriNode.next('span').hide();
            }else{
                $(":radio[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].firstLast'][value='" + sgPrinciple + "']").prop("checked", "checked");
            }
            var vList = sgList[i].fcVList;
            for (var j = 0; j < vList.length; j++) {
                //设置首检值
                console.log(vList[j].fcUnit);
                console.log(vList[j].fcValue);
                $("[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].startingLabel']").val(vList[j].fcUnit);
                $(":input[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].startingValue']").val(vList[j].fcValue);
                var fcv = $(":input[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].startingValue']");
                var va = $(":input[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].startingValue']");
                var ifPo = $(":input[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].isPost']");
                var ifPost = vList[j].ifPost;
                if (vList[j].fcUnit == 'DATE') {
                    va.datepicker({
                        dateFormat: 'yy-mm-dd',
                        changeMonth: true,
                        changeYear: true,
                        yearRange: 'c-70:c+5'
                    });
                    va.attr('readonly', 'readonly');
                    va.attr('disabled', 'disabled');
                    ifPo.parent().hide();
//                    fcv.parent().hide();
                }
                if(ifPost && ifPost == 'Y'){
                    var ifPostNode = $(":input[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].isPost']");
                    ifPostNode.prop("checked", "checked");
                    var postNode = ifPostNode.parent('td').next();
                    postNode.show();
                    var value = vList[j].postDate ? vList[j].postDate.substr(0, 10) : '';
                    $(":input[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].post']").val(value);

                }

            }
        }
        //首检有数据，NOTE一定未选中
        $('#fcNote').attr('disabled', 'disabled');
    }

    //初始化重检表格数据
    function initRcForm(data) {
        var bgPrinciple = data.rcBg.rcBgPrinciple;
        //设置大组原则
        if(!bgPrinciple){//大组原则为空，则隐藏大组原则
            var bgPriNode = $(":radio[name$='vo.complianceTimes[0].eoSubRc1[0].firstLast']");
            bgPriNode.hide();
            bgPriNode.next('span').hide();
        }else{
            $(":radio[name$='vo.complianceTimes[0].eoSubRc1[0].firstLast'][value='" + bgPrinciple + "']").prop("checked", "checked");
        }
        var sgList = data.rcSgList;
        for(var i = 0; i< sgList.length; i++) {
            //设置小组原则
            var sgPrinciple = sgList[i].rcSg.rcSgPrinciple;
            if(!sgPrinciple){//小组原则为空，则隐藏小组原则
                var sgPriNode = $(":radio[name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[" + i + "].firstLast']");
                sgPriNode.hide();
                sgPriNode.next('span').hide();
            }else{
                $(":radio[name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[" + i + "].firstLast'][value='" + sgPrinciple + "']").prop("checked", "checked");
            }

            var vList = sgList[i].rcVList;
            for (var j = 0; j < vList.length; j++) {
                //设置重检值
                console.log(vList[j].rcUnit);
                console.log(vList[j].rcValue);
                $("[name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[" + i + "].eoSubRc3[" + j + "].rcStartingLabel']").val(vList[j].rcUnit);
                $(":input[name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[" + i + "].eoSubRc3[" + j + "].startingValue']").val(vList[j].rcValue);
            }
        }

        //重检有数据，NOTE一定未选中
        $('#rcNote').attr('disabled', 'disabled');
    }

    //保存首检
    function saveFC() {
        if(!taskId){
            MsgAlert({content : '请先保存任务', type : 'error'});
            return;
        }
        var fcData = '';
        var is = $('#ifFcNote').is(':checked');
        if (is) {
            fcData = $('#fcNote').val();
        } else {
            var obj = [];
            var bgFristLast = $('[name="vo.complianceTimes[0].eoSub1[0].firstLast"]:checked').val();
            //首检小组的个数
            var fgNode = $("[name='fcSgTr']");
            var sgLen = fgNode.length;
            if (sgLen > 1 && !bgFristLast) {
                MsgAlert({content: '请选择大组原则', type: 'error'});
                return;
            }
            var sgParam = [];
            for (var i = 0; i < sgLen; i++) {
                var sgFirstLastV = $("[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].firstLast']:checked").val();
                //首检小组对应的首检值个数
                var sgFirstLast = $("[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].firstLast']");
                var node = sgFirstLast.parent().parent().parent().parent().prev().prev().children();
                var vLen = node.find('tr').length;
                if (vLen > 1 && !sgFirstLastV) {
                    MsgAlert({content: '请选择小组原则', type: 'error'});
                    return;
                }
                var vParams = [];
                for (var j = 0; j < vLen; j++) {
                    var post = $("[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].isPost']");
                    var fcUnit = $("[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].startingLabel']").val();
                    if (!fcUnit) {
                        MsgAlert({content: '请选择首检单位', type: 'error'});
                        return;
                    }
                    var fcV = $("[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].startingValue']").val();
                    if (fcUnit != 'DATE') {
                        if (!fcV) {
                            MsgAlert({content: '请输入首检值', type: 'error'});
                            return;
                        } else {
                            if (fcUnit != 'DATE') {

                                var reg = /^[1-9]\d*$/;
                                if (!reg.test(fcV) || fcV > 999999) {
                                    MsgAlert({content: '首检值为1~999999的整数', type: 'error'});
                                    return;
                                }
                            }
                        }
                    } else {
                        post.prop("checked", true);
                    }

                    var ifPost = $("[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].isPost']").is(':checked') ? 'Y' : 'N';
                    var postDate = $("[name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].post']").val();
                    vParams.push({
                        'ID': j + 1, 'fcUnit': fcUnit, 'fcV': fcV, ifPost: ifPost,
                        postDate: postDate
                    });
                }
                sgParam.push({'ID': i + 1, 'PRINCPLE': sgFirstLastV, 'VALUE_DATA': vParams})
            }
            obj.push({'ID': 1, 'PRINCPLE': bgFristLast, 'SG_DATA': sgParam});
            fcData = JSONstringify(obj);
        }
        InitFuncCodeRequest_({
            data: {
                pkid: taskId, fcData: fcData, noteFlag: is,
                FunctionCode: "EM_FILE_EVAL_TL_FC_ADD"
            },
            async: false,
            successCallBack: function (jdata) {
                ajaxLoadEnd();
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    param.OWindow.reload_("#dg1");
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //保存重检
    function saveRC() {
        if(!taskId){
            MsgAlert({content : '请先保存任务', type : 'error'});
            return;
        }
        var rcData = '';
        var is = $('#ifRcNote').is(':checked');
        if (is) {
            rcData = $("#rcNote").val();
        } else {
            var obj = [];
            var bgFristLast = $('[name="vo.complianceTimes[0].eoSubRc1[0].firstLast"]:checked').val();
            //重检小组的个数
            var fgNode = $("[name='rcSgTr']");
            var sgLen = fgNode.length;
            if (sgLen > 1 && !bgFristLast) {
                MsgAlert({content: '请选择大组原则', type: 'error'});
                return;
            }
            var sgParam = [];
            for (var i = 0; i < sgLen; i++) {
                var sgFirstLastV = $("[name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[" + i + "].firstLast']:checked").val();
                //重检小组对应的重检值个数
                var sgFirstLast = $("[name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[" + i + "].firstLast']");
                var node = sgFirstLast.parent().parent().parent().parent().prev().prev().children();
                var vLen = node.find('tr').length;
                if (vLen > 1 && !sgFirstLastV) {
                    MsgAlert({content: '请选择小组原则', type: 'error'});
                    return;
                }
                var vParams = [];
                for (var j = 0; j < vLen; j++) {
                    var rcUnit = $("[name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[" + i + "].eoSubRc3[" + j + "].rcStartingLabel']").val();
                    if (!rcUnit) {
                        MsgAlert({content: '请选择重检单位', type: 'error'});
                        return;
                    }
                    var rcV = $("[name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[" + i + "].eoSubRc3[" + j + "].startingValue']").val();
                    if (!rcV) {
                        MsgAlert({content: '请输入重检值', type: 'error'});
                        return;
                    } else {
                        var reg = /^[1-9]\d*$/;
                        if (!reg.test(rcV) || rcV > 999999) {
                            MsgAlert({content: '首检值为1~999999的整数', type: 'error'});
                            return;
                        }
                    }
                    vParams.push({'ID': j + 1, 'rcUnit': rcUnit, 'rcV': rcV});
                }
                sgParam.push({'ID': i + 1, 'PRINCPLE': sgFirstLastV, 'VALUE_DATA': vParams})
            }
            obj.push({'ID': 1, 'PRINCPLE': bgFristLast, 'SG_DATA': sgParam});
            rcData = JSONstringify(obj);
        }
        InitFuncCodeRequest_({
            data: {
                pkid: taskId, rcData: rcData, noteFlag : is,
                FunctionCode: "EM_FILE_EVAL_TL_RC_ADD"
            },
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    param.OWindow.reload_("#dg1");
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //重置时限
    function resetTl(type) {
        if(!confirm('确认重置时限？')){
            return;
        }
        InitFuncCodeRequest_({
            data: {pkid: taskId,type: type,FunctionCode: "EM_FILE_TL_RESET_TASKID"},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    param.OWindow.reload_("#dg1");
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
        if(type == 'fc'){
            $('#ifFcNote').prop('checked', false);
            appendResetTable(); //清空页面数据
            loadSelect('fc');
        }else if(type == 'rc'){
            $('#ifRcNote').prop('checked', false);
            appendRcResetTable(); //清空页面数据
            loadSelect('rc');
        }

    }

    //POST选择
    function postClick(obj) {
        var is = $(obj).is(':checked');
        var postNode = $(obj).parent('td').next();
        var _input = postNode.find('input');
        _input.removeAttr('id').removeClass();
        postNode.html('');
        _input.attr("readonly", "readonly");
        if(is){
            _input.datepicker({
                dateFormat: 'yy-mm-dd',
                changeMonth: true,
                changeYear: true,
                yearRange: 'c-70:c+5'
            });
            postNode.append(_input);
            postNode.show();
        }else{
            //清空值
            _input.val('');
            _input.datepicker({
                dateFormat: 'yy-mm-dd',
                changeMonth: true,
                changeYear: true,
                yearRange: 'c-70:c+5'
            });
            postNode.append(_input);
            postNode.hide();
        }
    }

    //绑定NOTE事件
    $(":checkbox").each(function () {
        $(this).change(function () {
            if(!taskId){
                MsgAlert({content: "请先保存任务", type: 'error'});
                $(this).prop("checked", false);
                return;
            }
            let radioName = $(this).attr('name');
            let is = $(this).is(":checked");

            //首检NOTE
            if (radioName == "ifFcNote") {
                if (is) {
                    if (!confirm("切换将清空结构化数据，是否确认？")) {
                        $(this).prop("checked", ifRcNote ? true : false);
                        $(this).removeAttr("checked");
                        return;
                    }
                } else {
                    if (!confirm("切换将清空非结构化数据，是否确认？")) {
                        $(this).prop("checked", ifRcNote ? true : false);
                        $(this).prop("checked", true);
                        return;
                    }
                }

                if (is) {
                    //允许编辑首检说明
                    $('#fcNote').removeAttr('disabled');
                    //删除结构化数据
                    saveNote('fc');
                    appendResetTable(); //清空页面数据
                    loadSelect('fc');
                } else {
                    //清空非结构化数据
                    $('#fcNote').val('');
                    $('#fcNote').attr('disabled', 'disabled');
                    saveNote('fc');
                    appendResetTable(); //清空页面数据
                    loadSelect('fc');
                }
            }

            //重检NOTE
            if (radioName == "ifRcNote") {
                if (is) {
                    if (!confirm("切换将清空结构化数据，是否确认？")) {
                        $(this).prop("checked", ifRcNote ? true : false);
                        $(this).removeAttr("checked");
                        return;
                    }
                } else {
                    if (!confirm("切换将清空非结构化数据，是否确认？")) {
                        $(this).prop("checked", ifRcNote ? true : false);
                        $(this).prop("checked", true);
                        return;
                    }
                }

                if (is) {
                    //允许编辑重检说明
                    $('#rcNote').removeAttr('disabled');
                    //删除结构化数据
                    saveNote('rc');
                    appendRcResetTable();
                    loadSelect('rc');
                } else {
                    //清空非结构化数据
                    $("#rcNote").val('');
                    $('#rcNote').attr('disabled', 'disabled');
                    saveNote('rc');
                    appendRcResetTable();
                    loadSelect('rc');
                }
            }
        });
    });

    //NOTE点击事件保存数据
    function saveNote(type){
        var ifNote;
        if(type == 'fc'){
            ifNote = $('#ifFcNote').is(':checked')? 'Y' : 'N';
        }else{
            ifNote = $('#ifRcNote').is(':checked')? 'Y' : 'N';
        }
        InitFuncCodeRequest_({
            data: {pkid: taskId,type: type, ifNote: ifNote,FunctionCode: "EM_FILE_UPATE_NOTE_TASKID"},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    param.OWindow.reload_("#dg1");
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }


    //------------------------
    //1.最里程操作
    //处理name 需要处理第index个数字值
    function change_name(name,index){
        if(!name) return "";
        var result = name.match(/\[\d+\]/g);
        if(result && result.length!=0){
            result = index==0?result[0]:result[result.length-1];
            result = result.substring(1,result.length-1);
            var position = 0==index?name.indexOf(result):name.lastIndexOf(result);
            return name.substring(0, position) + (parseInt(result) + 1)
                + name.substring(position + result.length);
        }
        return false;
    }


    //最里面的行复制
    function add_query_tr_first(obj){
        var id = $(obj).attr('id');
        var nodeCheckbox;
        if(id == 'add'){ //首检
            nodeCheckbox = $('#ifFcNote');
        }else if(id == 'addRc'){//重检
            nodeCheckbox = $('#ifRcNote');
        }
        var _checkbox = nodeCheckbox.is(':checked');
        if (!_checkbox && operation != 'view') {
            var obj_table = $(obj).parent().parent().prev().find("table");
            var firstLast = $(obj).parent().parent().next();
            var node = obj_table.find("tr").last().clone(true);
            firstLast.find("input[type=radio]").attr("style","height:auto");
            firstLast.find("input[type=radio]").next("span").removeAttr("style");
            node.find("input").val("");
            node.find(".doc_type").val('');
            //node.find(".remove_content_td").html("");
            //最后一层最有一个td内容
            $.each(node.find('.remove_content_td input[name$=startingValue]'),function(){
                $(this).hide();
                $(this).parent().html('').append(this);
            });
            //清空Post
            $.each(node.find('.remove_content_td input[name$=isPost]'),function(){
                $(this).prop("checked", false);
                $(this).parent('td').next().hide();
                //$(this).parent('td').next().next().hide();
            });

            //更改name
            $.each(node.find('input,select'),function(){
                this.value = '';
                var _name = change_name(this.name,1);
                if(_name){
                    //更改name
                    this.name = _name;
                }
            });

            //清除提示信息
            $(node).find('.errorMessage,.error').html('');
            obj_table.append(node);
            $(".field").height($(".field").height()+29);
            //控制lable项的控制
            $('select[name$=incrementLabel]:first',node).change();
        }
    }

    //最里层行删除
    function del_query_tr_first(obj){
        //var _checkbox = $(obj).parents('tr:eq(4)').find(':checkbox[name$=_control]').attr('checked');
        //if(_checkbox){
        var obj_table = $(obj).parents('table:eq(0)');
        if (obj_table.find("tr").length > 1 && operation != 'view') {
            if(!confirm('确定删除?')){
                return;
            }
            //P.$.dialog.confirm("Delete ?",function(){
            $(obj).parents('tr:eq(0)').remove();
            $(".field").height($(".field").height()-29);
            reorder_table_tr_first(obj_table);
            if(obj_table.find("tr").length==1){
                var firstLast = $(obj_table).parents('td:eq(0)').next().next();
                firstLast.find("input[type=radio]").attr("style","height:auto;display:none");
                firstLast.find("input[type=radio]").removeAttr("checked");
                firstLast.find("input[type=radio]").next("span").attr("style","display:none");
            }
            //控制lable项的控制
            $('tr:first select[name$=incrementLabel]:first',obj_table).change();
            //});
        }
        //}
    }

    //重新排序最里层的name值
    function reorder_table_tr_first(table){
        //获取当前table剩余的行数
        var tableLength = table.children().children().length;
        for(var i = 0;i < tableLength; i++){
            //更改每行中的name值
            $.each(table.children().children("tr:eq("+i+")").find('input,select'),function(){
                if(this.name){
                    var _name = "";
                    var result = this.name.match(/\[\d+\]/g);
                    if(result && result.length!=0){
                        result = result[result.length-1];
                        result = result.substring(1,result.length-1);
                        var position = this.name.lastIndexOf(result);
                        _name = this.name.substring(0, position) + i + this.name.substring(position + result.length);
                    }
                    if(_name){
                        //更改name
                        this.name = _name;
                    }
                }
            });
        }
    }

    //更改startingLabel时更改startingValue
    function value_change_first(obj){
        var obj_value = $(obj).val();
        var name = $(obj).attr('name');
        var find_td = $(obj).parent().next();
        _change(obj_value,find_td, name);
    }
    //改变startingValue的内容
    function _change(obj_value,find_td, name){
        //获取默认input
        var _input;
        var appendDateName = '';
        if(name && name.indexOf('postType') != -1){
            var subName1 = name.substr(0, name.lastIndexOf('.'));
            appendDateName = subName1 + "." + "post";
            _input = find_td.find('input[name$=post]');
            _input.removeAttr('readonly').removeClass('no_edit').css('width', '150px').val('');
        }else if(name && ((name.indexOf('startingLabel') != -1)
            || (name.indexOf('rcStartingLabel') != -1))){
            var subName2 = name.substr(0, name.lastIndexOf('.'));
            appendDateName = subName2 + "." + "startingValue";
            _input = find_td.find('input[name$=startingValue]');
            _input.removeAttr('readonly').removeClass('no_edit').css('width', '90px').val('');
        }

        if(_input){
            find_td.html(""); //清空td
            if(obj_value == 'DATE'){
                _input.attr("disabled", "disabled");
                var postTd = find_td.next().next();
                var postDate = postTd.find("input");
                find_td.append(_input.show());

                find_td.hide();
                find_td.next().hide();
                find_td.next().next().show();
                postDate.show();
                postDate.removeAttr('id').removeClass();
                postDate.datepicker({
                    dateFormat: 'yy-mm-dd',
                    changeMonth: true,
                    changeYear: true,
                    yearRange: 'c-70:c+5'
                });
            }else if(obj_value == 'YJJ'){
                _input.val('');
                _input.attr("disabled","disabled");
                find_td.append(_input.show());

                find_td.show();
                find_td.next().show();
            }else{
                _input.removeAttr("disabled");
                find_td.append(_input.show());
                find_td.show();
                find_td.next().show();
            }
        }

    }

    //2.第2层操作
    //搜索xx第index次出现的并累加
    function change_name_second(source,target){
        if(!source || !target) return;
        var _index = source.indexOf(target);
        //前半部分
        var _before = source.substring(0,(_index+target.length));
        var _after = source.substring(_before.length);
        var _order = _after.substring(0,_after.indexOf(']'));
        _after = _after.substring(_order.length);
        return _before + (parseInt(_order)+1) + _after;
    }

    //第二层行添加
    function add_query_tr_second(obj){
        var id = $(obj).attr('id');
        var nodeCheckbox;
        if(id == 'add'){ //首检
            nodeCheckbox = $('#ifFcNote');
        }else if(id == 'addRc'){//重检
            nodeCheckbox = $('#ifRcNote');
        }
        var _checkbox = nodeCheckbox.is(':checked');
        if (!_checkbox && operation != 'view') {
            var obj_table = $(obj).parent().parent().prev().children("table");
            var node = obj_table.children().children().last().clone(true);
            var obj_tr = node.find("table").find("tr");
            var fromNode = $(obj).parents('td:eq(1)').next();
            if(obj_tr.length>1){
                for(var i = 1;i<obj_tr.length;i++){
                    $(obj_tr[i]).remove();
                }
            }
            node.find("input[type!=radio]").val("");
            fromNode.find("input[type=radio]").attr("style","height:auto");
            fromNode.find("input[type=radio]").next("span").removeAttr("style");
            node.find("input[type=radio]").attr("style","height:auto;display:none");
            node.find("input[type=radio]").next("span").attr("style","display:none");
            node.find(".doc_type").val('');
            // node.find(".remove_content_td").html("");
            // node.find("input[type='radio']").removeAttr("checked");
            //设置groupId的_index
            node.find(':radio').removeAttr('checked');
            //设置第一个单选宽选中
            /*$.each(node.find("div:has(ul)"),function(){
                $(this).find('ul:first :radio').attr("checked","checked");
            });*/
            //最后一层最有一个td内容
            $.each(node.find('.remove_content_td input[name$=startingValue]'),function(){
                $(this).hide();
                $(this).parent().html('').append(this);
            });

            //清空Post
            $.each(node.find('.remove_content_td input[name$=isPost]'),function() {
                $(this).prop("checked", false);
                $(this).parent('td').next().hide();
                //$(this).parent('td').next().next().hide();

            });
            //更改name
            $.each(node.find('input,select'),function(){
                var _name;
                if(id == 'add'){
                    _name = change_name_second(this.name,'eoSub2[');
                }else if(id == 'addRc'){
                    _name = change_name_second(this.name,'eoSubRc2[');
                }
                if(_name){
                    //更改name
                    this.name = _name;
                }
            });
            //清除提示信息
            $(node).find('.errorMessage,.error').html('');
            obj_table.append(node);
            $(".field").height($(".field").height()+29);
            //控制label的选择项
            $('select[name$=incrementLabel]:first',node).change();
        }
    }

    //第二层删除
    function del_query_tr_second(obj){
        //var _checkbox = $(obj).parents('tr:eq(3)').find(':checkbox[name$=_control]').attr('checked');
        //if(_checkbox){
        var id = $(obj).attr('id');
        var obj_table = $(obj).parents('table:eq(0)');
        if (obj_table.children().children().length > 1 && operation != 'view') {
            if(!confirm('确定删除?')){
                return;
            }
            $(obj).parents('tr:eq(0)').remove();
            //重新设置第二层表格中的name下标值
            reorder_table_tr_second(obj_table, id);
            $(".field").height($(".field").height()-29);
            if(obj_table.children().children().length ==1){
                var onlyTr = obj_table.parents('td:eq(1)').next();
                onlyTr.find("input[type=radio]").attr("style","height:auto;display:none").removeAttr("checked");
                onlyTr.find("input[type=radio]").next("span").attr("style","display:none");
            }
            //控制lable项的控制
            $('tr:first select[name$=incrementLabel]:first',obj_table).change();

        }
    }
    //重新排序第二层的name值
    function reorder_table_tr_second(table, id){
        //获取当前table剩余的行数
        var tableLength = table.children().children().length;
        for(var i = 0;i < tableLength; i++){
            //更改每行中的name值
            $.each(table.children().children("tr:eq("+i+")").find('input,select'),function(){
                var target;
                if(id=='del'){//首检
                    target = 'eoSub2[';
                }else{
                    target = 'eoSubRc2['
                }
                var source = this.name;
                if(!source || !target) return;
                var _index = source.indexOf(target);
                //前半部分
                var _before = source.substring(0,(_index+target.length));
                var _after = source.substring(_before.length);
                var _order = _after.substring(0,_after.indexOf(']'));
                _after = _after.substring(_order.length);
                var _name = _before + i + _after;
                if(_name){
                    //更改name
                    this.name = _name;
                }
            });
        }
    }

    //首检table
    function appendTable(data) {
        var str = '';
        str = str+"<tr>";
        //小组
        str = str + "<td width='80%'>";
        str = str + "<table  width='100%' border='0' cellspacing='0' cellpadding='0'>";
        str= str + "<tr>";
        str= str + "<td width='95%' style='border:none'>";
        str = str + "<table width='100%' border='0' cellspacing='0' cellpadding='0' class='table_sub_1'>";
        var sgList = data.fcSgList;
        for(var i = 0; i< sgList.length; i++){
            str = str + "<tr name='fcSgTr'>";
            str = str + "<td width='75%' style='border:solid #ccc 1px;'>";
            str = str + "<table border='1' cellpadding='0' cellspacing='0' bordercolor='#B2C9E0' class='table-zi' style='margin:5px;padding: 5px'>";
            var vList = sgList[i].fcVList;
            for(var j=0; j<vList.length; j++){
                str = str + "<tr>" +
                    "<td style='padding: 3px' width='10%'>" +
                    "<select name='vo.complianceTimes[0].eoSub1[0].eoSub2["+i+"].eoSub3["+j+"].startingLabel' class='doc_type' onchange='value_change_first(this)'>" +
                    "</select>" +
                    "</td>" +
                    "<td style='padding: 3px' width='15%' class='remove_content_td'>" + "<input type='text' style='width: 90px' class='{rangelength:[0,100]}'" +
                    "name='vo.complianceTimes[0].eoSub1[0].eoSub2["+i+"].eoSub3["+j+"].startingValue'/>" +
                    "</td>" +
                    "<td style='padding: 3px'  width='15%' name='isPost' class='remove_content_td'>" +
                    "<input type='checkbox' name='vo.complianceTimes[0].eoSub1[0].eoSub2["+i+"].eoSub3["+j+"].isPost' onclick='postClick(this)'>POST" +
                    "</td>" +
                    "<td width='15%' name='post' style='display: none'>" +
                    "<input  type='text' name='vo.complianceTimes[0].eoSub1[0].eoSub2[" + i + "].eoSub3[" + j + "].post' style='margin-left: 5px; width: 120px'>" +
                    "</td>" +
                    "<td width='5%'>" +
                    "<div>" +
                    "<img id='del' onclick='del_query_tr_first(this);return false;' src='../../../../../css/icons/delete.png' style='margin-left: 5px;' />"+
                    "</div>" +
                    "</td>" +
                    "</tr>";

            }
            str = str + "</table>";
            str = str + "</td>";
            str = str + "<td width='10%' style='border:solid #ccc 1px;'>" +
                "<div>" +
                "<img id='add' onclick='add_query_tr_first(this);return false;' src='../../../../../css/icons/add.png' style='margin-left: 10px;'/>"+
                "</div>" +
                "</td>" +
                "<td width='11%'>" +
                "<div>" +
                "<ul style='padding-left:0px'>" +
                "<li style='list-style:none'>" +
                "&nbsp;<input name='vo.complianceTimes[0].eoSub1[0].eoSub2["+i+"].firstLast' type='radio' value='XDWZ'  style='height:auto'/>" +
                "<span>FIRST</span> </li>" +
                "</ul>" +
                "<ul style='padding-left:0px'>" +
                "<li style='list-style:none'>" +
                "&nbsp;<input name='vo.complianceTimes[0].eoSub1[0].eoSub2["+i+"].firstLast' type='radio' value='HDWZ' style='height:auto'/>" +
                "<span>LAST</span> </li>" +
                "</ul>" +
                "</div>" +
                "</td>" +
                "<td>" +
                "<div><img id='del' onclick='del_query_tr_second(this);return false;' src='../../../../../css/icons/delete.png' style='margin-left: 5px;' /></div>" +
                "</td>";
            str = str + "</tr>";

        }
        str = str + "</table>";
        str = str + "</td>";
        str = str + "<td width='5%' style='border:none'>" +
            "<div><img id='add' onclick='add_query_tr_second(this);return false;' src='../../../../../css/icons/add.png' style='margin-left: 10px;'/></div>" +
            "</td>";
        str = str + "</tr>";
        str = str + "</table>";
        str = str + "</td>";
        //大组
        str = str + "<td width='8%' style='border-right:none; border-top:none; border-bottom:none'>" +
            "<div>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSub1[0].firstLast' type='radio' style='height:auto' value='XDWZ'/>" +
            "<span style=''>FIRST</span> </li>" +
            "</ul>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSub1[0].firstLast' type='radio' value='HDWZ' style='height:auto'/>" +
            "<span style=''>LAST</span> </li>" +
            "</ul>" +
            "</div>" +
            "</td>" +
            "<td width='12%' style='border-right:none; border-top:none; border-bottom:none'>" +
            "<textarea id='fcNote' class='{rangelength:[0,1000]}'" +
            "name='vo.complianceTimes[0].eoSub1[0].note' rows='4' style='width:100%;'></textarea>" +
            "<div class='errorMessage'></div>" +
            "</td>";
        str = str + "</tr>";
        console.log(str);
        $('#appendTable').html(str);
        $("input[name$=post]").datepicker({
            dateFormat: 'yy-mm-dd',
            changeMonth: true,
            changeYear: true,
            yearRange: 'c-70:c+5'
        });
        $("input[name$=post]").attr('readonly', 'readonly');
    }

    //首检table重置
    function appendResetTable() {
        $('#appendTable').html("");
        var str = '';
        str = str+"<tr>";
        //小组
        str = str + "<td width='80%'>";
        str = str + "<table  width='100%' border='0' cellspacing='0' cellpadding='0'>";
        str= str + "<tr>";
        str= str + "<td width='95%' style='border:none'>";
        str = str + "<table width='100%' border='0' cellspacing='0' cellpadding='0' class='table_sub_1'>";
        str = str + "<tr name='fcSgTr'>";
        str = str + "<td width='75%' style='border:solid #ccc 1px;'>";
        str = str + "<table border='1' cellpadding='0' cellspacing='0' bordercolor='#B2C9E0' class='table-zi' style='margin:5px;padding: 5px'>";
        str = str + "<tr>" +
            "<td width='10%' style='padding: 3px'>" +
            "<select name='vo.complianceTimes[0].eoSub1[0].eoSub2[0].eoSub3[0].startingLabel' class='doc_type' onchange='value_change_first(this)'>" +
            "</select>" +
            "</td>" +
            "<td width='15%' class='remove_content_td' style='padding: 3px'>" +
            "<input type='text' style='width: 90px' class='{rangelength:[0,100]}'" +
            "name='vo.complianceTimes[0].eoSub1[0].eoSub2[0].eoSub3[0].startingValue'/>" +
            "</td>" +
            "<td style='padding: 3px'  width='15%' name='isPost' class='remove_content_td'>" +
            "<input type='checkbox' name='vo.complianceTimes[0].eoSub1[0].eoSub2[0].eoSub3[0].isPost' onclick='postClick(this)'>POST" +
            "</td>" +
            "<td width='15%' name='post' style='display: none'>" +
            "<input  type='text'  name='vo.complianceTimes[0].eoSub1[0].eoSub2[0].eoSub3[0].post' style='margin-left: 5px; width: 120px'>" +
            "</td>" +
            "<td width='5%'>" +
            "<div>" +
            "<img id='del' onclick='del_query_tr_first(this);return false;' src='../../../../../css/icons/delete.png' style='margin-left: 5px;' />" +
            "</div>" +
            "</td>" +
            "</tr>";
        str = str + "</table>";
        str = str + "</td>";
        str = str + "<td width='10%' style='border:solid #ccc 1px;'>" +
            "<div>" +
            "<img id='add' onclick='add_query_tr_first(this);return false;' src='../../../../../css/icons/add.png' style='margin-left: 10px;'/>" +
            "</div>" +
            "</td>" +
            "<td width='11%'>" +
            "<div>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSub1[0].eoSub2[0].firstLast' type='radio' value='XDWZ'  style='height:auto;display:none'/>" +
            "<span style='display:none'>FIRST</span> </li>" +
            "</ul>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSub1[0].eoSub2[0].firstLast' type='radio' value='HDWZ' style='height:auto;display:none'/>" +
            "<span style='display:none'>LAST</span> </li>" +
            "</ul>" +
            "</div>" +
            "</td>" +
            "<td>" +
            "<div><img id='del' onclick='del_query_tr_second(this);return false;' src='../../../../../css/icons/delete.png' style='margin-left: 5px;' /></div>" +
            "</td>";
        str = str + "</tr>";

        str = str + "</table>";
        str = str + "</td>";
        str = str + "<td width='5%' style='border:none'>" +
            "<div><img id='add' onclick='add_query_tr_second(this);return false;' src='../../../../../css/icons/add.png' style='margin-left: 10px;'/></div>" +
            "</td>";
        str = str + "</tr>";
        str = str + "</table>";
        str = str + "</td>";
        //大组
        str = str + "<td width='8%' style='border-right:none; border-top:none; border-bottom:none'>" +
            "<div>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSub1[0].firstLast' type='radio' style='height:auto;display:none' value='XDWZ'/>" +
            "<span style='display:none'>FIRST</span> </li>" +
            "</ul>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSub1[0].firstLast' type='radio' value='HDWZ' style='height:auto;display:none'/>" +
            "<span style='display:none'>LAST</span> </li>" +
            "</ul>" +
            "</div>" +
            "</td>" +
            "<td width='12%' style='border-right:none; border-top:none; border-bottom:none'>" +
            "<textarea id='fcNote' class='{rangelength:[0,1000]}'" +
            "name='vo.complianceTimes[0].eoSub1[0].note' rows='4' style='width:100%;'></textarea>" +
            "<div class='errorMessage'></div>" +
            "</td>";
        str = str + "</tr>";
        console.log(str);
        $('#appendTable').html(str);
        $("input[name$=post]").datepicker({
            dateFormat: 'yy-mm-dd',
            changeMonth: true,
            changeYear: true,
            yearRange: 'c-70:c+5'
        });
        var is = $('#ifFcNote').is(':checked');
        if(is){
            $('#appendTable').find('select').attr('disabled','disabled');
            $('#appendTable').find('input').attr('disabled','disabled');
            $('#fcNote').removeAttr('disabled');
        }else{
            $('#appendTable').find('select').removeAttr('disabled');
            $('#appendTable').find('input').removeAttr('disabled');
            $('#fcNote').attr('disabled', 'disabled');
        }
    }

    //重检Table
    function appendRcTable(data) {
        var str = '';
        str = str+"<tr>";
        //小组
        str = str + "<td width='80%'>";
        str = str + "<table  width='100%' border='0' cellspacing='0' cellpadding='0'>";
        str= str + "<tr>";
        str= str + "<td width='95%' style='border:none'>";
        str = str + "<table width='100%' border='0' cellspacing='0' cellpadding='0' class='table_sub_1'>";
        var sgList = data.rcSgList;
        for(var i = 0; i< sgList.length; i++){
            str = str + "<tr name='rcSgTr'>";
            str = str + "<td width='75%' style='border:solid #ccc 1px;'>";
            str = str + "<table  width='100%' border='1' cellpadding='0' cellspacing='0' bordercolor='#B2C9E0' class='table-zi' style='margin:5px;padding: 5px'>";
            var vList = sgList[i].rcVList;
            for(var j=0; j<vList.length; j++){
                str = str + "<tr>" +
                    "<td style='padding: 3px' width='10%'>" +
                    "<select name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2["+i+"].eoSubRc3["+j+"].rcStartingLabel' class='doc_type' onchange='value_change_first(this)'>" +
                    "</select>" +
                    "</td>" +
                    "<td style='padding: 3px' width='15%' class='remove_content_td'>" +
                    "<input type='text' style='width: 90px' class='{rangelength:[0,100]}'" +
                    "name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2["+i+"].eoSubRc3["+j+"].startingValue'/>" +
                    "</td>" +
                    "<td width='5%'>" +
                    "<div>" +
                    "<img id='delRc' onclick='del_query_tr_first(this);return false;' src='../../../../../css/icons/delete.png' style='margin-left: 5px;' />" +
                    "</div>" +
                    "</td>" +
                    "</tr>";

            }
            str = str + "</table>";
            str = str + "</td>";
            str = str + "<td width='10%' style='border:solid #ccc 1px;'>" +
                "<div>" +
                "<img id='addRc' onclick='add_query_tr_first(this);return false;' src='../../../../../css/icons/add.png' style='margin-left: 10px;'/>"+
                "</div>" +
                "</td>" +
                "<td width='11%'>" +
                "<div>" +
                "<ul style='padding-left:0px'>" +
                "<li style='list-style:none'>" +
                "&nbsp;<input name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2["+i+"].firstLast' type='radio' value='XDWZ'  style='height:auto'/>" +
                "<span style=''>FIRST</span> </li>" +
                "</ul>" +
                "<ul style='padding-left:0px'>" +
                "<li style='list-style:none'>" +
                "&nbsp;<input name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2["+i+"].firstLast' type='radio' value='HDWZ' style='height:auto'/>" +
                "<span style=''>LAST</span> </li>" +
                "</ul>" +
                "</div>" +
                "</td>" +
                "<td>" +
                "<div><img id='delRc' onclick='del_query_tr_second(this);return false;' src='../../../../../css/icons/delete.png' style='margin-left: 5px;' /></div>" +
                "</td>";
            str = str + "</tr>";

        }
        str = str + "</table>";
        str = str + "</td>";
        str = str + "<td width='5%' style='border:none'>" +
            "<div><img id='addRc' onclick='add_query_tr_second(this);return false;' src='../../../../../css/icons/add.png' style='margin-left: 10px;'/></div>" +
            "</td>";
        str = str + "</tr>";
        str = str + "</table>";
        str = str + "</td>";
        //大组
        str = str + "<td width='8%' style='border-right:none; border-top:none; border-bottom:none'>" +
            "<div>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSubRc1[0].firstLast' type='radio' style='height:auto' value='XDWZ'/>" +
            "<span style=''>FIRST</span> </li>" +
            "</ul>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSubRc1[0].firstLast' type='radio' value='HDWZ' style='height:auto'/>" +
            "<span style=''>LAST</span> </li>" +
            "</ul>" +
            "</div>" +
            "</td>" +
            "<td width='12%' style='border-right:none; border-top:none; border-bottom:none'>" +
            "<textarea id='rcNote' class='{rangelength:[0,1000]}'" +
            "name='vo.complianceTimes[0].eoSubRc1[0].note' rows='4' style='width:100%;'></textarea>" +
            "<div class='errorMessage'></div>" +
            "</td>";
        str = str + "</tr>";
        console.log(str);
        $('#appendTableRc').html(str);
    }

    //重置重检table
    function appendRcResetTable() {
        $('#appendTableRc').html("");
        var str = '';
        str = str+"<tr>";
        //小组
        str = str + "<td width='80%'>";
        str = str + "<table  width='100%' border='0' cellspacing='0' cellpadding='0'>";
        str= str + "<tr>";
        str= str + "<td width='95%' style='border:none'>";
        str = str + "<table width='100%' border='0' cellspacing='0' cellpadding='0' class='table_sub_1'>";
        str = str + "<tr name='rcSgTr'>";
        str = str + "<td width='75%' style='border:solid #ccc 1px;'>";
        str = str + "<table  width='100%' border='1' cellpadding='0' cellspacing='0' bordercolor='#B2C9E0' class='table-zi' style='padding-top:10px'>";
        str = str + "<tr>" +
            "<td style='padding: 3px' width='5%' valign='top'>" +
            "<select name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[0].eoSubRc3[0].rcStartingLabel' class='doc_type' onchange='value_change_first(this)'>" +
            "</select>" +
            "</td>" +
            "<td style='padding: 3px' width='15%' class='remove_content_td' valign='top'>" +
            "<input type='text' style='width:90px' class='{rangelength:[0,100]}'" +
            "name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[0].eoSubRc3[0].startingValue'/>" +
            "</td>" +
            "<td width='5%'>" +
            "<div>" +
            "<img id='delRc' onclick='del_query_tr_first(this);return false;' src='../../../../../css/icons/delete.png' style='margin-left: 5px;' />" +
            "</div>" +
            "</td>" +
            "</tr>";

        str = str + "</table>";
        str = str + "</td>";
        str = str + "<td width='10%' style='border:solid #ccc 1px;'>" +
            "<div>" +
            "<img id='addRc' onclick='add_query_tr_first(this);return false;' src='../../../../../css/icons/add.png' style='margin-left: 10px;'/>"+
            "</div>" +
            "</td>" +
            "<td width='11%'>" +
            "<div>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[0].firstLast' type='radio' value='XDWZ'  style='height:auto;display: none'/>" +
            "<span style='display: none'>FIRST</span> </li>" +
            "</ul>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSubRc1[0].eoSubRc2[0].firstLast' type='radio' value='HDWZ' style='height:auto;display: none'/>" +
            "<span style='display: none'>LAST</span> </li>" +
            "</ul>" +
            "</div>" +
            "</td>" +
            "<td>" +
            "<div><img id='delRc' onclick='del_query_tr_second(this);return false;' src='../../../../../css/icons/delete.png' style='margin-left: 5px;' /></div>" +
            "</td>";
        str = str + "</tr>";

        str = str + "</table>";
        str = str + "</td>";
        str = str + "<td width='5%' style='border:none'>" +
            "<div><img id='addRc' onclick='add_query_tr_second(this);return false;' src='../../../../../css/icons/add.png' style='margin-left: 10px;'/></div>" +
            "</td>";
        str = str + "</tr>";
        str = str + "</table>";
        str = str + "</td>";
        //大组
        str = str + "<td width='8%' style='border-right:none; border-top:none; border-bottom:none'>" +
            "<div>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSubRc1[0].firstLast' type='radio' style='height:auto;display: none' value='XDWZ'/>" +
            "<span style='display: none'>FIRST</span> </li>" +
            "</ul>" +
            "<ul style='padding-left:0px'>" +
            "<li style='list-style:none'>" +
            "&nbsp;<input name='vo.complianceTimes[0].eoSubRc1[0].firstLast' type='radio' value='HDWZ' style='height:auto;display: none'/>" +
            "<span style='display: none;'>LAST</span> </li>" +
            "</ul>" +
            "</div>" +
            "</td>" +
            "<td width='12%' style='border-right:none; border-top:none; border-bottom:none'>" +
            "<textarea id='rcNote' class='{rangelength:[0,1000]}'" +
            "name='vo.complianceTimes[0].eoSubRc1[0].note' rows='4' style='width:100%;'></textarea>" +
            "<div class='errorMessage'></div>" +
            "</td>";
        str = str + "</tr>";
        console.log(str);
        $('#appendTableRc').html(str);
        //fcVTitleShow(param.applyType);
        var is = $('#ifRcNote').is(':checked');
        if(is){
            $('#appendTableRc').find('select').attr('disabled','disabled');
            $('#appendTableRc').find('input').attr('disabled','disabled');
            $('#rcNote').removeAttr('disabled');
        }else{
            $('#appendTableRc').find('select').removeAttr('disabled');
            $('#appendTableRc').find('input').removeAttr('disabled');
            $('#rcNote').attr('disabled', 'disabled');
        }
    }

    function loadSelect(type) {
        //首检单位
        if (type == 'fc') {
            for (var i = 0; i < units.length; i++) {
                var opt = "<option value='" + units[i].VALUE + "'>" + units[i].TEXT + "</option>";
                $("[name$='startingLabel']").append(opt);
            }
        }
        if (type == 'rc') {
            for (var i = 0; i < runits.length; i++) {
                var opt = "<option value='" + runits[i].VALUE + "'>" + runits[i].TEXT + "</option>";
                $("[name$='rcStartingLabel']").append(opt);
            }
        }
    }

    function initData() {
        InitFuncCodeRequest_({
            async: false,
            data: {
                pkid: taskId ? taskId : -1,
                evapkid: evapkid,
                FunctionCode: 'EM_FILE_TASK_GROUP_LIST'
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                    InitTreegrid(jdata.data);
                }
                else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function InitTreegrid(data) {
        if (!data) return;

        let otherDatan1 = [];
        //查询其他标准工时的适用性
        if (otherData) {
            for (let i = 0; i < data.length; i++) {
                otherDatan.push(toCamelCase(otherData[i]));
                if (otherDatan[i].checked == 1) {
                    otherDatan[i].checked = true;
                }

            }

            for (let i = 0; i < otherDatan.length; i++) {
                if (!otherDatan[i].appConfig) {

                    let id = otherDatan[i].id;
                    for (let l = 0; l < otherDatan.length; l++) {
                        if (otherDatan[l].appGroupPkid == id && otherDatan[l].appConfig) {
                            if (!otherDatan[i].children) {
                                let children = [];
                                otherDatan[i].children = children;
                            }
                            otherDatan[i].children.push(otherDatan[l])
                        }
                    }
                    otherDatan1.push(otherDatan[i]);
                }
            }

        }


        //找出已选中的适用性
        let selectedIds = [];
        if (otherDatan1.length > 0) {
            for (let i = 0; i < otherDatan1.length; i++) {
                if (otherDatan1[i].checked) { //父级被选中
                    selectedIds.push(otherDatan1[i].id);
                    if (otherDatan1[i].children && otherDatan1[i].children.length > 0) {
                        for (let j = 0; j < otherDatan1[i].children.length; j++) {
                            selectedIds.push(otherDatan1[i].children[j].id);
                        }
                    }
                } else {//父级未选中
                    let isChildren = false; //标识子级是否被选中
                    if (otherDatan1[i].children && otherDatan1[i].children.length > 0) {
                        for (let j = 0; j < otherDatan1[i].children.length; j++) {
                            if (otherDatan1[i].children[j].checked) {
                                isChildren = true;
                                selectedIds.push(otherDatan1[i].children[j].id);
                            }
                        }
                        if (isChildren) {//子级至少有一个选中时
                            selectedIds.push(otherDatan1[i].id);
                        }

                    }
                }
            }
        }

        datan = [];
        for (let i = 0; i < data.length; i++) {
            datan.push(toCamelCase(data[i]));
            if (datan[i].checked == 1) {
                datan[i].checked = true;
            }

        }
        let datan1 = [];
        for (let i = 0; i < datan.length; i++) {
            if (!datan[i].appConfig) {

                let id = datan[i].id;
                for (let l = 0; l < datan.length; l++) {
                    if (datan[l].appGroupPkid == id && datan[l].appConfig) {
                        if (!datan[i].children) {
                            let children = [];
                            datan[i].children = children;
                        }
                        datan[i].children.push(datan[l])
                    }
                }
                datan1.push(datan[i]);
            }
        }
        console.log(datan1);
        console.log(otherDatan1);
        console.log(selectedIds);


        $('#tt').tree({
            data: datan1,
            checkbox: true,
            idField: 'id',
            treeField: 'groupName',
            columns: [[
                {title: 'Task Name', field: 'groupName', width: 180},
                {field: 'persons', title: 'Persons', width: 60, align: 'right'},
                {field: 'begin', title: 'Begin Date', width: 80},
                {field: 'end', title: 'End Date', width: 80}
            ]],
            onCheck: function (node, checked) {
                console.log(node);
                if (checked) {
                    if (selectedIds.length != 0 && selectedIds.indexOf(node.id) > -1) {
                        $('#tt').tree('uncheck', node.target);
                    }
                }
            }
        });
    }

    function saveApp() {
        let data = {};
        let node = $('#tt').tree('getChecked');
        let appGroup = JSON.stringify(node);
        data = $.extend(data, {
            pkid: taskId,
            evapkid: evapkid,
            appGroup: appGroup
        }, {FunctionCode: 'EM_FILE_TASK_GROUP_ADD'});

        InitFuncCodeRequest_({
            async: false,
            data: data,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_err:ERRMSG.COMMON.SUCCESS_CODE')});
//                    CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //分组变更适用性
    function delSfoApp() {
        var data = $.extend(data, {
            taskId: taskId,
            evaId: evapkid
        }, {FunctionCode: 'EM_FILE_TASK_SFO_DEL_APP'});

        InitFuncCodeRequest_({
            async: false,
            data: data,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function workChange(value) {
        if (value == 'MA' || value == 'PN') {
            $('#tl').hide();
            $('#app').hide();
            $('#app1').hide();
            $('#taskNature').combobox({editable: false, onlyview: true, required: false});
            $("#taskNature").combobox("setValue", "");
        }else if(value == 'JXZ'){
            $('#taskNature').combobox({editable: false, onlyview: true, required: false});
            $("#taskNature").combobox("setValue", "");
        } else {
            if (isTlShow) {
                $('#tl').show();
            }
            $('#app').show();
            $('#app1').show();
            $('#taskNature').combobox({editable: true, onlyview: false, required: true});
        }
    }


    function workChange2(value, task) {
        if (value == 'MA' || value == 'PN') {
            $('#tl').hide();
            $('#app').hide();
            $('#app1').hide();
            $('#taskNature').combobox({editable: false, onlyview: true, required: false});
            $("#taskNature").combobox("setValue", "");
        }else if(value == 'JXZ'){
            $('#taskNature').combobox({editable: false, onlyview: true, required: false});
            $("#taskNature").combobox("setValue", "");
        } else {
            if (isTlShow) {
                $('#tl').show();
            }
            $('#app').show();
            $('#app1').show();
            $('#taskNature').combobox({editable: true, onlyview: false, required: true});
            $("#taskNature").combobox("setValue", task);
        }
    }

</script>
</html>