<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>外部文件接收AD</title>
</head>

<body>
<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <input type="hidden" id="pkid" name="pkid" />
                <input type="hidden" id="createBy" name="createBy" />
                <input type="hidden" id="createTime" name="createTime" />
                <input type="hidden" id="dataSort" name="dataSort" />
                <table class="table table-bordered table-info">
                    <tr id = "view">
                        <td class="tdr" colspan="5" align="left">
                            <input class="btn btn-primary" type="button" onclick="save()" value="保存" style="width: 50px;margin:5px;"/>
                            <!--<input id="upBtn" class="btn btn-primary" type="button" onclick="upload()" value="上传"-->
                                   <!--style="width: 50px;margin:5px;"/>-->
                            <!--<input id="issBtn" class="btn btn-primary" type="button" onclick="issueCheck()" value="发布"-->
                                   <!--style="width: 50px;margin:5px;"/>-->
                            <!--<input id="attBtn" class="btn btn-primary" type="button" onclick="viewAttach()" value="附件查看"-->
                                   <!--style="width: 60px;margin:5px;"/>-->
                            <!--   <input id="disBtn" class="btn btn-primary" type="button" onclick="discard()" value="作废"
                                      style="width: 50px;margin:5px;"/>-->
                            <input class="btn btn-primary" type="button" onclick="CloseWindowIframe();" value="关闭" style="width: 50px;margin:5px;"/>
                        </td>
                        <td>
                            <a onclick="doCopy()">
                                <span id='tips' style="color: #e17009"></span>
                            </a>
                        </td>
                    </tr>
                    <tr id = "view2">
                        <td class="tdr" colspan="6" align="left">
                            <input class="btn btn-primary" type="button" onclick="viewAttach()" value="附件查看" style="width: 60px;margin:5px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">资料类型：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="dataType" name="dataType"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">紧急程度：</th>
                        <td class="tdr" style="width: 180px">
                            <input class="easyui-combobox" id="urgentLevel" name="urgentLevel"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">资料来源：</th>
                        <td class="tdr">
                            <input class="easyui-combogrid" id="dataFrom" name="dataFrom"
                                   data-options="required:true,editable:false"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">资料编号：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-validatebox" id="dataNo" name="dataNo" onblur="checkNo(this.value)"
                                   data-options="required:true"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">资料版次：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-textbox" id="dataVer" name="dataVer" data-options="required:true"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">章节：</th>
                        <td class="tdr">
                            <input class="easyui-combogrid" id="ata" name="ata"
                                   data-options="required:true,editable:false"/>
                        </td>
                    </tr>

                    <tr>
                        <th class="th" align="right" style="width: 80px;">适用类型：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="applyType" name="applyType"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">适用型号：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="applyModel" name="applyModel"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">修正案号：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-textbox" id="dataAmend" name="dataAmend" data-options="required:true"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">标题：</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox" name="dataTitle" id="dataTitle"
                                   data-options="required:true,multiline:true "
                                   style="width: 730px;height:50px"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">生效日期：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-datebox" id="effectDate" name="effectDate"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">颁发日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="issueDate" name="issueDate"
                                   data-options="required:true,editable:false"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">接收日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="dmReceiveDate" name="dmReceiveDate"
                                   data-options="required:true,editable:false"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">专业：</th>
                        <td class="tdr" style="width: 180px;">
                            <input class="easyui-combobox" id="specialize" name="specialize"
                                   data-options="editable:false"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">备注：</th>
                        <td class="tdr" colspan="5">
                            <textarea id="memo" name="memo" data-options="editable:true"
                                      style="width: 730px;height:60px"></textarea>
                        </td>
                    </tr>

                </table>
            </form>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var param;
    var operation;
    var PAGE_DATA = {};
    var mpkid = "";
    var dataType = "";
    var applyTypeFleetDic;
    var applyTypeEngDic;
    var applyTypeEngDic;
    var applyType;
    var namespace;
    var status;
    var daType = "";
    var daNo = "";
    var daVer = "";
    var daAta = "";
    var daLev = "";
    var daFrom = "";
    var daTitle = "";
    var daAppl = "";
    var daModel = "";
    var daKey = "";
    var daFile = "";
    var eeflag = "";
    var ifInit;
    var epkid;
    function i18nCallBack() {
        param = getParentParam_();
        operation = param.operation;
        applyType = param.applyType;
        namespace = param.namespace;
        eeflag = param.eeflag;
        ifInit = param.ifInit;
        epkid = param.epkid;
        var url=window.location.search; //获取url中"?"符后的字串
        if(url.indexOf("?")!=-1){
            dataType = url.substr(url.indexOf("=")+1);
        }
        if (!dataType) {
            dataType = param.dataType;
        }
        var ifEval = 'N';
        InitFuncCodeRequest_({
            data: {dataType: dataType, FunctionCode: 'DM_GET_IF_EVA'},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        ifEval = jdata.data.IF_EVAL;
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
        if (ifEval == 'Y') {
            $("#specialize").combobox({required: true});
        } else {
            $("#specialize").combobox({required: false});
        }
        if (applyType == "PART") {
            $("#applyModel").combobox({disabled: true});
            $("#applyModel").combobox('setValue', "CM");
        } else {
            $("#applyModel").combobox({disabled: false});
        }

        if(operation == "view"){
            $("#view").hide();
            $("#view2").show();
        }else{
            $("#view2").hide();
            $("#view").show();
        }
        InitFuncCodeRequest_({
            data: {
                domainCode: "YESORNO,EM_FILE_SPEC,DM_REC_PRIVIDOR,DM_FILE_EDIT_TYPE,REVSUG_FLEET,DM_DATA_TYPE_TECHNOLOGY,DM_URGENT_LEVEL,EM_APPLY_TYPE,DM_HOW_DEALWITH,DM_ATA,DA_ENG_TYPE",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //文件格式
                    $('#fileEditType').combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_FILE_EDIT_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#specialize').combobox({
                        panelHeight: '135px',
                        data: jdata.data.EM_FILE_SPEC,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#dataType").combobox({
                        panelHeight: '100px',
                        data: jdata.data.DM_DATA_TYPE_TECHNOLOGY,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect:function (row) {setPages(row.VALUE)} ,
                        onHidePanel: function() {
                            validSelectValue_(this, "输入值不存在！");
                        }
                    });
                    $('#applyModel').combobox({
                        panelHeight: '70px',
                        data: jdata.data.REVSUG_FLEET,
                        multiple: true,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#dataFrom').combobox({
                        panelHeight: '70px',
                        data: jdata.data.DM_REC_PRIVIDOR,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#urgentLevel').combobox({
                        panelHeight: '70px',
                        data: jdata.data.DM_URGENT_LEVEL,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#howDealwith').combobox({
                        panelHeight: '50px',
                        data: jdata.data.DM_HOW_DEALWITH,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#applyType').combobox({
                        panelHeight: '70px',
                        data: jdata.data.EM_APPLY_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onChange: applyTypeChange
                    });
                    $('#ata').combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_ATA,
                        multiple: true,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });


                    PAGE_DATA['dataType'] = DomainCodeToMap_(jdata.data["DM_DATA_TYPE_TECHNOLOGY"]);
                    PAGE_DATA['applyModel'] = DomainCodeToMap_(jdata.data["REVSUG_FLEET"]);
                    PAGE_DATA['urgentLevel'] = DomainCodeToMap_(jdata.data["DM_URGENT_LEVEL"]);
                    PAGE_DATA['howDealwith'] = DomainCodeToMap_(jdata.data["DM_HOW_DEALWITH"]);
                    PAGE_DATA['applyType'] = DomainCodeToMap_(jdata.data["EM_APPLY_TYPE"]);
                    PAGE_DATA['ata'] = DomainCodeToMap_(jdata.data["DA_ATA_F"]);
                    PAGE_DATA['dataFrom'] = DomainCodeToMap_(jdata.data["DM_REC_PRIVIDOR"]);
                    applyTypeFleetDic = jdata.data["REVSUG_FLEET"];
                    applyTypeEngDic = jdata.data["DA_ENG_TYPE"];
                }
                ////
                $("#dataType").textbox({onlyview: true, editable: false});
                $("#dataType").textbox('setValue',param.dataType);
                $("#dataNo").textbox({onlyview: true, editable: false});
                $("#dataNo").textbox('setValue',param.dataNo);
                $("#dataVer").textbox('setValue',param.dataVer);
                $("#dataVer").textbox({onlyview: true, editable: false});

                $("#howDealwith").combobox({onlyview:true,editable:false});
                $("#howDealwith").combobox('setValue',"Y");

                $("#dmReceiveDate").datebox({onlyview: true, editable: false});
                //设置资料类型为不可编辑
                $("#dataType").combobox("setValue", 'AD');
                if (param.pkid){
                    $("#dataType").combobox({onlyview:true});
                    InitDataForm(param.pkid);
                } else {
                    $("#dmReceiveDate").datebox("setValue", curDate());
                }

                if (eeflag == 'EE') {
                    $("#upBtn").hide();
                    $("#issBtn").hide();
                    $("#attBtn").hide();
                    $("#disBtn").hide();
                    $("#dataType").combobox({onlyview: true, editable: false});
                    $("#urgentLevel").combobox({onlyview: true, editable: false});
                    $("#dataFrom").combobox({onlyview: true, editable: false});
                    $("#dataNo").textbox({onlyview: true, editable: false});
                    $("#dataVer").textbox({onlyview: true, editable: false});
//                    $("#ata").combobox({onlyview: true, editable: false});
//                    $("#applyType").combobox({onlyview: true, editable: false});
//                    $("#applyModel").combobox({onlyview: true, editable: false});
                    $("#dataAmend").textbox({onlyview: true, editable: false});
                    $("#effectDate").datebox({onlyview: true, editable: false});
                    $("#issueDate").datebox({onlyview: true, editable: false});
                    $("#dmReceiveDate").datebox({onlyview: true, editable: false});
                    $("#memo").textbox({onlyview: true, editable: false});
                }
            }
        })
    }

    function applyTypeChange() {
        var applyType = $("#applyType").combobox('getValue');
        if (applyType == "APL") {
            $('#applyModel').combobox({
                panelHeight: '70px',
                data: applyTypeFleetDic,
                valueField: 'VALUE',
                textField: 'TEXT'
            });

            $("#applyModel").combobox({disabled: false});
            $("#applyModel").combobox('clear');
        } else if (applyType == "ENG") {
            $('#applyModel').combobox({
                panelHeight: '70px',
                data: applyTypeEngDic,
                valueField: 'VALUE',
                textField: 'TEXT'
            });
            $("#applyModel").combobox({disabled: false});
            $("#applyModel").combobox('clear');
        } else if (applyType == "PART") {
            $("#applyModel").combobox({disabled: true});
            $("#applyModel").combobox('setValue', "CM");
        }

    }


    function InitDataForm(pkid) {
        mpkid = pkid;
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "DM_DATA_REC_EXTER_PK"}, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    status = jdata.data.DATA_STATUS;
                    $('#applyModel').combobox({value: jdata.data.APPLY_MODEL});
                    $('#ata').combobox({value: jdata.data.ATA});

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }
    //页面重新加载
    function setPages(dataType){
        if (dataType == "") {

        } else if (dataType == 'CAD') {
            window.location.href = '/views/data_manager/technology_data/cad/cadAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'SB') {
            window.location.href = '/views/data_manager/technology_data/sbsl/sbAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'AD') {
            window.location.href = '/views/data_manager/technology_data/ad/adAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'AMOC') {
            window.location.href = '/views/data_manager/technology_data/amoc/amocAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else if (dataType == 'IN'||dataType == 'NSC') {
            window.location.href = '/views/data_manager/technology_data/nsc/nscAdd.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        } else {
            window.location.href = '/views/data_manager/technology_data/adother/dmExterDetail.shtml?dataType=' + dataType;
            window.resizeTo("850", "500");
        }
    }

    // 保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        /*     var issueDate = $("#issueDate").datebox("getValue");
             var dmReceiveDate = $("#dmReceiveDate").datebox("getValue");
             var now = new Date();
             var year = now.getFullYear(); //得到年份
             var month = now.getMonth();//得到月份
             var date = now.getDate();//得到日期
             month = month + 1;
             if (month < 10) {
                 month = "0" + month
             }
             if (date < 10) {
                 date = "0" + date
             }
             var curDate = year + "-" + month + "-" + date;
             if (issueDate < curDate) {
                 MsgAlert({content: "颁发日期不能小于当前日期！", type: 'error'});
                 $("#issueDate").datebox("setValue", "");
                 return;
             }
             if (dmReceiveDate < curDate) {
                 MsgAlert({content: "接收日期不能小于当前日期！", type: 'error'});
                 $("#dmReceiveDate").datebox("setValue", "");
                 return;
             }*/

        var $form = $("#mform");
        var datas = $form.serializeObject();
        var code = $("#dataNo").val();
        if(code.indexOf("－")!=-1){
            $("#dataNo").val = code.replace("－","-");
        }
        if (Array.isArray(datas['ata'])) {
            datas['ata'] = datas['ata'].join(',');
        }
        if (Array.isArray(datas['applyModel'])) {ques;
            datas['applyModel'] = datas['applyModel'].join(',');
        }
        datas = $.extend({ifInit: ifInit, epkid: epkid}, datas, {FunctionCode: 'EM_ADSB_REC_ADD'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    param.OWindow.searchData();
                    if (param.OWindow.onSearch_) {
                        param.OWindow.onSearch_('dg', '#ffSearch');
                    }
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    CloseWindowIframe();
                } else {
                    if (jdata.msg.indexOf("ORA-00001") != -1) {
                        alert("同一资料类型、编号、版次重复。");
                        return false;
                    }else{
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            }
        });
    }
    //作废
    function discard() {
        //保存校验
        if(isEmpty(mpkid)){
            alert("请先保存数据！");
            return;
        }
        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas = $.extend({}, datas, {mpkid:mpkid,FunctionCode: 'DM_DATA_REC_EXTER_DIS'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if(param.OWindow.onSearch_){
                        param.OWindow.onSearch_('dg', '#ffSearch');
                    }
                    param.OWindow.MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }
    //发布前检验
    function issueCheck() {
        var dataType = $("#dataType").combobox('getValue');
        var applyModel = $("#applyModel").combobox('getValue');
        var applyType = $("#applyType").combobox('getValue');
        //保存校验
        if(isEmpty(mpkid)){
            alert("请先保存数据！");
            return;
        }
        if (!confirm("确定要发布吗，发布后不可再收回？")) {
            return;
        }
        var dflag = 'N';
        InitFuncCodeRequest_({
            data: {dataType: dataType, FunctionCode: 'EM_FILE_GET_EVAL'},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data.COU != null) {
                        if (jdata.data != null) {
                            dflag = jdata.data.IF_EVAL;
                        }
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });

        var ata2 = $("#ata").combobox('getValue');
        var minAta = "";
        var minFleet = "";
        var coueng = 1;
        if (ata2.indexOf(",") != -1) {
            var array = ata2.split(",");
            minAta = array[0];//定义最小值为该数组的第一个数
            for (var i = 0; i < array.length; i++) {
                if (minAta > array[i]) {
                    minAta = array[i];
                }
            }
        } else {
            minAta = ata2;
        }

        if (applyType == 'APL') {
            if (applyModel.indexOf(",") != -1) {
                var array = applyModel.split(",");
                minFleet = array[0];//定义最小值为该数组的第一个数
                for (var i = 0; i < array.length; i++) {
                    if (minFleet > array[i]) {
                        minFleet = array[i];
                    }
                }
            } else {
                minFleet = applyModel;
            }
        } else if (applyType == 'ENG') {
            if (applyModel.indexOf("CFM56") != -1) {
                minFleet = 'CFM56';
            } else if (applyModel.indexOf("CF6") != -1) {
                minFleet = 'CF6';
            } else if (applyModel.indexOf("RB211") != -1) {
                minFleet = 'RB211';
            } else if (applyModel.indexOf("PW4000") != -1) {
                minFleet = 'PW4000';
            }
        } else {
            minFleet = applyModel;
        }
        if (dflag == 'Y') {
            InitFuncCodeRequest_({
                data: {ata: minAta, applyModel: minFleet, FunctionCode: 'EM_FILE_COUNT_ENGER'},
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data.COU != null) {
                            coueng = jdata.data.COU;
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });

            if (coueng == 0) {
                MsgAlert({content: "请先在主数据分工规则配置菜单配置章节工程师！章节为：" + minAta + ";适用型号为：" + minFleet, type: 'error'});
                return;
            }
        }

        var $form = $("#mform");
        var datas = $form.serializeObject();
        //发布前，需先验证是否上传附件，如果没有，则不能发布
        datas = $.extend({}, datas, {CATEGORY:'dmDataRecExter',SOURCE_ID:mpkid,FunctionCode: 'DM_EXTER_ARC'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if(jdata.data.ARC != 0){
                        issue(mpkid, minAta, minFleet, dflag);
                    }else{
                        alert("未上传附件，请先上传附件。");

                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }
    //发布
    function issue(mpkid, minAta, minFleet, dflag) {
        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas = $.extend({}, datas, {
            mpkid: mpkid,
            minAta: minAta,
            minFleet: minFleet,
            dflag: dflag,
            FunctionCode: 'DM_DATA_REC_EXTER_ISS'
        });
        //发布前，需先验证是否上传附件，如果没有，则不能发布
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if(param.OWindow.onSearch_){
                        param.OWindow.onSearch_('dg', '#ffSearch');
                    }
                    param.OWindow.MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }
    function reload_() {

    }
    //上传
    function upload() {
        //保存校验
        if(isEmpty(mpkid)){
            alert("请先保存数据！");
            return;
        }
        common_uploadFile({
            identity: 'dg',
            param: {
                cat: "dmDataRecExter",
                sourceId: mpkid,
                successCellBack: "",
                fialCellBack: ""
            }
        });
    }
    //上传
    function common_uploadFile(edopt) {
        var title_ = $.i18n.t('common:COMMON_OPERATION.UPLOAD');
        ShowWindowIframe({
            width: 575,
            height: 200,
            title: title_,
            param: $.extend({}, edopt.param),
            url: "/views/data_manager/dm/upload/attachment_add.shtml"
        });
    }
    //上传成功后回填路径
    function afterUpload(pkid) {
        InitFuncCodeRequest_({
            data: {
                pkid: pkid,
                catagory: 'dmDataRecExter',
                FunctionCode: 'DM_DATA_REC_EXTER_UPLOAD'
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                }
            }
        });
    }
    //附件查看
    function viewAttach() {
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: mpkid,
                CATEGORY: "dmDataRecExter",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                //为0时提示没有上传附件，无法查看
                if (jdata.data.length==0){
                    MsgAlert({content: "请先上传附件", type: 'error'});

                }else {
                    //打开一个列表页面
                    ShowWindowIframe({
                        width: "515",
                        height: "285",
                        param: {
                            pkid: mpkid,
                            category: "dmDataRecExter",
                            namespace: namespace,
                            status: status,
                            operation: operation
                        },
                        url: "/views/data_manager/dm/upload/editAttach.shtml"
                    });
                }
            }
        });
    }

    function checkAta() {
        var ata = $("#ata").combobox("getValues");
        var strs = ata.sort();
        var atas = strs.join(",");
        $("#ata").combobox("setValue", atas);
    }

    function checkNo(dataNo) {
        InitFuncCodeRequest_({
            data: {dataNo: dataNo, FunctionCode: 'DM_DTAT_CHECK_NO'},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        daType = jdata.data.DATA_TYPE;
                        daNo = jdata.data.DATA_NO;
                        daVer = jdata.data.DATA_VER;
                        daAta = "";
                        daLev = "";
                        daFrom = "";
                        daTitle = "";
                        daAppl = "";
                        daModel = "";
                        daKey = "";
                        daFile = "";

                        var tips = daType + " " + daNo + " " + daVer + " already existed! click [here] to copy!";
                        $("#tips").text(tips);
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    function doCopy() {

    }

    function curDate() {
        var now = new Date();
        var year = now.getFullYear(); //得到年份
        var month = now.getMonth();//得到月份
        var date = now.getDate();//得到日期
        month = month + 1;
        if (month < 10) {
            month = "0" + month
        }
        if (date < 10) {
            date = "0" + date
        }
        var curDate = year + "-" + month + "-" + date;
        return curDate;
    }

</script>
</html>