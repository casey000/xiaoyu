<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="ws_work_flow">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title></title>
</head>
<body class="ibody">
<div id="tabs" style="width: 100%; height: 100%;">
    <div id="tab01" title="业务表单数据" style="">
        <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
            <!-- 业务数据展示 start-->
            <input type="hidden" name="proposer" id="proposer"/>
            <input type="hidden" name="postponeObjectPkid"/>
            <input type="hidden" id="isFirstNode" name="isFirstNode">
            <input type="hidden" id="auditId" name="auditId"/>
            <input type="hidden" id="prooManId" name="prooManId"/>
            <input type="hidden" id="approverId" name="approverId"/>
            <input type="hidden" id="postponeSort" name="postponeSort"/>
            <input type="hidden" id="flag" name="flag">
            <h5 style="margin-bottom: 4px;">任务数据详情</h5>
            <table class="table table-bordered table-info">
                <input type="hidden" name="pkid" id="pkid"
                       data-options="multiline:true, onlyview: true" style="height:25px; width: 70%;"/>
                <tr id="dtype">
                    <th class="tdl">业务流程名称</th>
                    <td class="tdr" colspan="5">
                        <input class="easyui-textbox" name="sort" id="sort"
                               data-options="multiline:true, onlyview: true" style="height:25px; width: 99%;"/>
                    </td>
                </tr>
                <tr>
                    <th class="tdl">延期编号</th>
                    <td class="tdr" colspan="5">
                        <input class="easyui-textbox" name="postponeObjectNo" id="postponeObjectNo"
                               data-options="multiline:true, onlyview: true" style="height:25px; width: 99%;"/>
                    </td>
                </tr>
                <tr id="viewDetail">
                    <td colspan="6" align="center">
                        <a id="view" class="addBtn" onclick="viewDetails()">查看详情</a>
                    </td>
                </tr>
                <tr>
                    <th class="tdl">原日期</th>
                    <td class="tdr">
                        <input class="easyui-textbox" name="originalDeadline" id="originalDeadline"
                               data-options="onlyview: true" style="height:25px; width: 75px"/>
                    </td>
                    <th class="tdl">延期日期</th>
                    <td class="tdr">
                        <input class="easyui-textbox" name="postponeDate" id="postponeDate"
                               data-options="onlyview: true" style="height:25px; width: 75px"/>
                    </td>
                    <th id='sta1' class="tdl">状态</th>
                    <td id='sta2' class="tdr">
                        <input class="easyui-textbox" name="sta" id="sta"
                               data-options="onlyview: true" style="height:25px; width: 75px"/>
                    </td>
                </tr>
                <tr>
                    <th class="tdl">延期原因</th>
                    <td class="tdr" colspan="5">
                                <textarea class="easyui-textbox" id="postponeReason" name="postponeReason"
                                          data-options="validType:['maxLength[1000]']" multiline="true"
                                          style="height:65px;width: 99%"></textarea>
                    </td>
                </tr>
                <tr>
                    <th class="tdl">申请人</th>
                    <td class="tdr" colspan="5">
                        <input class="easyui-textbox" name="applyMan" id="applyMan"
                               data-options="multiline:true, onlyview: true" style="height:25px; width: 99%;"/>
                    </td>
                </tr>
            </table>
            <!-- 业务数据展示end-->
            <h5 style="margin-bottom: 4px;">流程处理</h5>
            <input name="taskId" type="hidden"/>
            <table class="table table-bordered table-info">
                <tbody id="custom_options"></tbody>
            </table>
            <table class="table table-bordered table-info" id="mtable">
                <tr>
                    <th class="tdl"> 处理意见</th>
                    <td class="tdr" colspan="5">
                        <input id="notes" class="easyui-textbox easyui-validatebox" name="notes"
                               data-options="multiline:true, validType:['maxLength[500]'] "
                               style="height:65px; width: 99%;"/>
                    </td>
                </tr>
                <tr>
                    <th id="dbr" class="tdl xmclass"> 下一级代办人</th>
                    <td id="xm" class="tdr xmclass" colspan="5">
                        <input class="easyui-textbox" id="engineerId" name="engineerId"
                               data-options="validType:['maxLength[20]'] " style="height:25px;width: 99%;"/>
                    </td>
                </tr>
                <tr>
                    <td colspan="6" align="center">
                        <a id="canSubmit" class="searchBtn" onclick="doSubmit();">提交</a>
                        <a id="canReturn" class="clearBtn" onclick="doReturn();">驳回</a>
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div title="流程信息" style="">
        <table class="table table-bordered table-info" id="processInfo">
            <tr>
                <th class="tdl" style="width: 145px;">流程业务Key</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="businessKey"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程业务名称</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="executionName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程创建时间</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="createTime"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程创建人</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="userName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务名称</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="nodeName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">是否会签任务</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="isJoint"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
        </table>
        <div id="workflow" style="overflow-x: scroll;"></div>
    </div>
    <div id="tab02" title="历史任务信息" style="">
        <table id="historyDg"></table>
    </div>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
<script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
<script type="text/javascript">
    /**
     * 初始化流程业务处理页面
     * @param resource  业务数据
     * @param execution 流程实例数据
     * @param node 节点配置数据
     * @constructor
     */
    function InitLoadResource(resource, execution, node) {
        var endflag = false;
        //初始化业务数据展示
        resour = resource;
        ParseFormField_(resource, null, null);
        var postponeSort = resource.postponeSort;
        var sort = resource.postponeSort;
        var recordId = resource.postponeObjectPkid;
        var userInfo = getLoginInfo();
        var userId = userInfo.accountId;
        if (sort == 'EM_FILE_EVALUATE') {
            sort = '工程文件评估延期申请';
            $("#sta1").show();
            $("#sta2").show();
        } else if (sort == "EO") {
            sort = 'EO延期申请';
            $("#sta1").hide();
            $("#sta2").hide();
        } else if (sort == "EA") {
            sort = 'EA延期申请';
            $("#sta1").hide();
            $("#sta2").hide();
        } else if (sort == "TB") {
            sort = 'TB延期申请';
            $("#sta1").hide();
            $("#sta2").hide();
        } else if (sort == "MPTK") {
            sort = '定检工卡延期申请';
            $("#sta1").hide();
            $("#sta2").hide();
            endflag = true;
        } else if (sort == "NSTK") {
            sort = '标准非例行工卡延期申请';
            $("#sta1").hide();
            $("#sta2").hide();
            endflag = true;
        } else if (sort == "EOTK") {
            sort = 'EO工卡延期申请';
            $("#sta1").hide();
            $("#sta2").hide();
            endflag = true;
        } else if (sort == "EATK") {
            sort = 'EA工卡延期申请';
            $("#sta1").hide();
            $("#sta2").hide();
            endflag = true;
        }
        var pro = 'N';
        if (sort.indexOf("EO") != -1 || sort.indexOf("EA") != -1) {
            InitFuncCodeRequest_({
                data: {pkid: recordId, FunctionCode: 'EM_FILE_CHECK_EO_DELAY'},
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data != null) {
                            var cou = jdata.data.COU;
                            if (cou > 0) {
                                pro = 'Y';
                            }
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        }
        $("#flag").val(pro);
        $("#sort").textbox('setValue', sort);
        var evaDeadLine = resource.originalDeadline;
        var days = diffDays(evaDeadLine);
        var sta = '';
        if (days < 0) {
            var sta = '红色预警';
        } else if (days >= 0 && days <= 3) {
            var sta = '黄色预警';
        }
        $("#sta").textbox('setValue', sta);
        InitFuncCodeRequest_({
            data: {
                domainCode: "YESORNO",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    // 初始化查询条件

                }
            }
        });
        $("#isFirstNode").val('Y');


        $("#engineerId").MyComboGrid({
            idField: 'ACCOUNT_ID',  //实际选择值
            textField: 'USER_NAME', //文本显示值
            panelHeight: '180px',
            required: true,
            width: 400,
            params: {userId: userId, FunctionCode: 'FLOW_WORK_ACCOUNT'},
            columns: [[
                {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                {field: 'USER_NAME', title: '审核人', width: 50}
            ]],
            onSelect: function (index, row) {
                ACCOUNT_ID = row.ACCOUNT_ID;
                var ifzj = $("#flag").val();
                //当前在审核页面中选择下一位审核人

            }
        });
        $('#notes').textbox({required: true});


        endflag = true;

        if (endflag) {//结束标志
            $(".xmclass").hide();
            $("#engineerId").combogrid({required: false});
        }
    }

    function viewDetails() {
        var operation = 'view';
        var pkid = resour.postponeObjectPkid;
        if (resour.postponeSort == 'EO') {
            InitFuncCodeRequest_({
                data: {pkid: pkid, FunctionCode: 'EM_EO_PKID'},
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data != null) {
                            var value = jdata.data;
                            openDetaiEo("view", value.PKID, value.IF_EVA_PRODUCE, value.EVAL_APPLY_TYPE, value.EO_VER, value.JOB_CATEGORY, value.APPLY_TYPE);
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        } else if (resour.postponeSort == 'EA') {
            InitFuncCodeRequest_({
                data: {pkid: pkid, FunctionCode: 'EM_EO_PKID'},
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data != null) {
                            var eaSort = jdata.data.EA_SORT;
                            var value = jdata.data;
                            if (eaSort == 'ERO' || eaSort == 'APUG' || eaSort == 'QLJG' || eaSort == 'REVERSERG') {
                                openDetaiEro('view', pkid);
                            } else {
                                openDetaiEa("view", pkid, value.IF_EVA_PRODUCE, value.EVAL_APPLY_TYPE, value.EO_VER, value.JOB_CATEGORY, value.APPLY_TYPE);
                            }
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        } else if (resour.postponeSort == 'EM_FILE_EVALUATE') {
            ShowWindowIframe({
                width: "1000",
                height: "650",
                param: {pkid: resour.postponeObjectPkid, operation: operation},
                url: "/views/em/emfileeval/emfileeva_add_edit.shtml"
            });
        } else if (resour.postponeSort == 'MPTK') {
            InitFuncCodeRequest_({
                data: {pkid: pkid, FunctionCode: 'TD_JC_PKID'},
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data != null) {
                            var value = jdata.data;
                            openSmjc("view", value.PKID, value.CMP_ITEM_NO, value.FLEET, value.COMPANY_CODE, value.JC_TYPE, value.JC_NO);
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        } else if (resour.postponeSort == 'EOTK') {
            InitFuncCodeRequest_({
                data: {pkid: pkid, FunctionCode: 'TD_JC_PKID'},
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data != null) {
                            var value = jdata.data;
                            openEojc("view", value.PKID, value.JC_TYPE, value.JC_NO);
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        } else if (resour.postponeSort == 'EATK') {
            InitFuncCodeRequest_({
                data: {pkid: pkid, FunctionCode: 'TD_JC_PKID'},
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data != null) {
                            var value = jdata.data;
                            openEojc("view", value.PKID, value.JC_TYPE, value.JC_NO);
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        } else if (resour.postponeSort == 'NSTK') {
            InitFuncCodeRequest_({
                data: {pkid: pkid, FunctionCode: 'TD_JC_PKID'},
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data != null) {
                            var value = jdata.data;
                            openNsjc("view", value.PKID, value.JC_NO, value.APP_TYPE, value.FLEET, value.CEP_CHECKOUT, value.CEP_FILE_PATH, value.COMPANY_CODE, value.JC_TYPE);
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        }
    }

    //计算当前日期和今天差的天数
    function diffDays(evaDeadLine) {
        var evaDate = stringToDate(evaDeadLine);
        var nowDate = new Date();
        var year = nowDate.getFullYear();
        var month = nowDate.getMonth();
        var day = nowDate.getDate();
        var now = new Date(year, month, day);
        var time_diff = evaDate.getTime() - now.getTime();
        var days = Math.floor(time_diff / (24 * 3600 * 1000));
        // alert('eva:'+evaDate+',now:'+now+',days:'+days);
        return days;
    }

    //字符串转日期
    function stringToDate(str) {
        str = str.substr(0, 10);
        var arr = str.split('-');
        var date = new Date(arr[0], arr[1] - 1, arr[2]);
        return date;
    }

    //打开资料类型详细页面
    function openDetaiEro(operation, pkid) {
        var title_ = $.i18n.t('EA详细页');
        ShowWindowIframe({
            width: "1248",
            height: "720",
            title: title_,
            param: {operation: operation, pkid: pkid},
            url: "/views/em/emea/ero/eroEdit.shtml"
        });
    }

    function openDetaiEa(operation, pkid, ifEvaProduce, evalApplyType, eoVer, jobCategory, applyType) {
        var title_ = $.i18n.t('EA详细页');
        ShowWindowIframe({
            width: "1248",
            height: "720",
            title: title_,
            param: {
                operation: operation,
                pkid: pkid,
                ifEvaProduce: ifEvaProduce,
                evalApplyType: evalApplyType,
                eoVer: eoVer,
                jobCategory: jobCategory,
                applyType: applyType
            },
            url: "/views/em/emea/eaEdit.shtml"
        });
    }

    function openDetaiEo(operation, pkid, ifEvaProduce, evalApplyType, eoVer, jobCategory, applyType) {
        var title_ = $.i18n.t('EO详细页');
        ShowWindowIframe({
            width: "1248",
            height: "720",
            title: title_,
            param: {
                operation: operation,
                pkid: pkid,
                ifEvaProduce: ifEvaProduce,
                evalApplyType: evalApplyType,
                eoVer: eoVer,
                jobCategory: jobCategory,
                applyType: applyType
            },
            url: "/views/em/emeo/eoEdit.shtml"
        });
    }

    //打开工卡详情页
    function openSmjc(operation, pkid, cmpNo, fleet, companyCode, jcType, jcNo, cepCheckout, cepFilePath, appType, status) {
        var title_ = $.i18n.t('定检工卡详情');
        var dataFrom = "";
        if (operation == "cmpadd") {
            dataFrom = "CMP";
        } else {
            dataFrom = "CUS";
        }
        ShowWindowIframe({
            width: "1430",
            height: "750",
            title: title_,
            param: {
                pkid: pkid,
                type: operation,
                from: dataFrom,
                cmpNo: cmpNo,
                fleet: fleet,
                companyCode: companyCode,
                jcType: jcType,
                jcNo: jcNo,
                cepCheckout: cepCheckout,
                cepFilePath: cepFilePath,
                operation: operation,
                appType: appType,
                jcStatus: status
            },
            url: "/views/td/jobcard/smjc/smjcedit/tdSmjcEditDetail.shtml"
        });
    }


    function openEojc(operation, pkid, jcType, jcNo, appType, fleet, companyCode) {
        var title_;
        if ("EOJC" == jcType) {
            title_ = $.i18n.t('EO工卡详情');
        } else if ("EAJC" == jcType) {
            title_ = $.i18n.t('EA工卡详情');
        }
        ShowWindowIframe({
            width: "1100",
            height: "740",
            title: title_,
            param: {
                operation: operation,
                pkid: pkid,
                jcType: jcType,
                jcNo: jcNo,
                appType: appType,
                fleet: fleet,
                companyCode: companyCode,
                title: title_
            },
            url: "/views/td/jobcard/eojc/tdEojcDetail.shtml"
        });
    }

    function openNsjc(operation, pkid, jcNo, appType, fleet, cepCheckout, cepFilePath, companyCode, jcType) {
        var title_ = $.i18n.t('NSJC工卡详情');
        var dataFrom = "";
        if (operation == "cmpadd") {
            dataFrom = "CMP";
        } else {
            dataFrom = "CUS";
        }
        ShowWindowIframe({
            width: "1430",
            height: "750",
            title: title_,
            param: {
                pkid: pkid,
                type: operation,
                from: dataFrom,
                jcNo: jcNo,
                appType: appType,
                fleet: fleet,
                cepCheckout: cepCheckout,
                cepFilePath: cepFilePath,
                companyCode: companyCode,
                jcType: jcType
            },
            url: "/views/td/jobcard/nrcjc/tdNrcjcEditDetail.shtml"
        });
    }


</script>
</body>
</html>