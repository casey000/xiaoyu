<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>SR信息</title>
</head>

<body class="ibody">
<div id="tt" class="ibox float-e-margins" style="width:100%; height: 100%">
    <div class="ibox-content">
        <fieldset class="fieldset_eui">
            <legend>SR基本信息</legend>
            <form id="mform" class="form-horizontal">
                <input type="hidden" id="pkid" name="pkid" />
                <input type="hidden" id="status" name="status" />
                <table class="table table-bordered table-info">
                    <tr id="id_btn_row">
                        <td colspan="9" align="right">
                            <input class="btn btn-primary" type="button" id="saveBtn" onclick="save()" value="保存"/>
                            <input class="btn btn-primary" type="button" onclick="closeW();" value="关闭"
                                   style="margin-left:3px;margin-right: 18px;"/>
                            <br/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">SR编号：</th>
                        <td style="padding: 3px">
                            <input id="srNo" name="srNo"
                                   class="easyui-textbox"
                                   data-options="width:'150px',readonly:true" />
                        </td>
                        <th class="th" align="right" style="width: 100px;">厂家名称：</th>
                        <td colspan="3" style="padding: 3px">
                            <input id="mfrName" name="mfrName"
                                   class="easyui-textbox" style="width: 400px;"
                                   data-options="required:true" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right">厂家联系人：</th>
                        <td style="padding: 3px">
                            <input id="mfrLinkMan" name="mfrLinkMan"
                                   class="easyui-textbox" style="width: 150px;"
                                   data-options="required:true" />
                        </td>
                        <th class="th" align="right">联系人EMAIL：</th>
                        <td colspan="3" style="padding: 3px">
                            <input id="mfrLinkEmail" name="mfrLinkEmail"
                                   class="easyui-textbox" style="width: 400px;"
                                   data-options="required:true" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">抄送人：</th>
                        <td colspan="5" style="padding: 3px;">
                            <input id="ccList" name="ccList"
                                   class="easyui-textbox" style="width: 600px" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">标题：</th>
                        <td colspan="5" style="padding: 3px;">
                            <input id="title" name="title"
                                   class="easyui-textbox" style="width: 600px;height:60px"
                                   data-options="required:true,multiline:true" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">类型：</th>
                        <td style="padding: 3px">
                            <input id="appType" name="appType"
                                   class="easyui-combobox" style="width: 150px;"
                                   data-options="required:true" />
                        </td>
                        <th class="th" align="right">单机/机队：</th>
                        <td style="padding: 3px">
                            <input id="acOrFleet" name="acOrFleet"
                                   class="easyui-combobox" style="width: 150px;" />
                        </td>
                        <th class="th" align="right">型号：</th>
                        <td style="padding: 3px">
                            <input id="model" name="model"
                                   class="easyui-textbox" style="width: 150px;" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right">章节：</th>
                        <td style="padding: 3px">
                            <input id="ata" name="ata"
                                   class="easyui-textbox" style="width: 150px;"
                                   data-options="required:true" />
                        </td>
                        <th class="th" align="right">厂家到期日期：</th>
                        <td style="padding: 3px">
                            <input id="mfrDueDate" name="mfrDueDate"
                                   class="easyui-datebox" style="width: 150px;"
                                   data-options="required:true" />
                        </td>
                        <th class="th" align="right">到期日期：</th>
                        <td style="padding: 3px">
                            <input id="dueDate" name="dueDate"
                                   class="easyui-datebox" style="width: 150px;"
                                   data-options="required:true" />
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
        <fieldset id="id_dg_apl" class="fieldset_eui" style="width: 380px; float: left; display: none">
            <legend>适用机身<span id="id_dg_apl_mark">（必选）</span></legend>
            <table id="dg_apl"></table>
        </fieldset>
        <fieldset id="id_dg_eng" class="fieldset_eui" style="width: 300px; float: left; display: none">
            <legend>适用发动机<span id="id_dg_eng_mark">（必选）</span></legend>
            <table id="dg_eng"></table>
        </fieldset>
        <fieldset id="id_dg_part" class="fieldset_eui" style="width: 200px; display: none;">
            <legend>适用部件<span id="id_dg_part_mark">（必选）</span></legend>
            <table id="dg_part"></table>
        </fieldset>
        <fieldset id="id_dg_content" class="fieldset_eui" style="display: none">
            <legend>正文及反馈</legend>
            <table id="dg_content"></table>
        </fieldset>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
<script type="text/javascript">
    var param; // operation[add,edit,view]
    var pkid = null;//主表PKID
    var op = null;

    function i18nCallBack() {
        param = getParentParam_();
        pkid = param.pkid;
        op = param.operation;

        $('#ccList').MyComboGrid({
            params: {
                FunctionCode: "EM_USER"
            },
            columns: [[
                {field: "ACCOUNT_NO", title: "员工编号", width: 60, sortable: true},
                {field: "NAME", title: "员工姓名", width: 100, sortable: true},
                {field: "EMAIL", title: "员工EMAIL", width: 200, sortable: true}
            ]],
            idField: "EMAIL",
            textField: "EMAIL",
            multiple: true,
            separator: ";",
            pagination: false,
            width: 600
        });
        $('#mfrDueDate').datebox({
            onChange: function (data) {
                var temp = new Date(data);
                temp.setDate(temp.getDate() + 10);
                var dueDate = temp.getFullYear() + "-" + (temp.getMonth() + 1) + "-" + temp.getDate();
                $('#dueDate').datebox('setValue', dueDate);
            }
        });

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "EM_RESPOND_APP_TYPE,EM_SR_AC_OR_FLEET,DA_FLEET,EM_SR_ENG_MODEL,EM_SR_ATA"
            },
            successCallBack: function (jdata) {
                param.EM_SR_AC_OR_FLEET = jdata.data.EM_SR_AC_OR_FLEET;
                param.DA_FLEET = jdata.data.DA_FLEET;
                param.EM_SR_ENG_MODEL = jdata.data.EM_SR_ENG_MODEL;

                $('#appType').combobox({
                    panelHeight: '70px',
                    data: jdata.data.EM_RESPOND_APP_TYPE,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    onSelect: function (item) {
                        selectAppType(item.VALUE);
                    },
                    onChange: function (newValue, oldValue) {
                        var isEngOrPart = newValue == "ENG" || newValue == "PART";
                        isEngOrPart ? $('#id_dg_apl').show() : $('#id_dg_apl').hide();
                        isEngOrPart ? $('#id_dg_eng').show() : $('#id_dg_eng').hide();
                        isEngOrPart ? $('#id_dg_part').show() : $('#id_dg_part').hide();
                        isEngOrPart ? $('#id_dg_content').show() : $('#id_dg_content').hide();

                        $('#id_dg_apl_mark').hide();
                        if (newValue == "ENG") {
                            $('#id_dg_eng_mark').show();
                            $('#id_dg_part_mark').hide();
                        } else if (newValue == "PART") {
                            $('#id_dg_eng_mark').hide();
                            $('#id_dg_part_mark').show();
                        }
                    }
                });
                $('#ata').combobox({
                    panelHeight: '120px',
                    data: jdata.data.EM_SR_ATA,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });

                if (!! pkid) {
                    InitDataForm(pkid);
                }

                initDgApl();
                initDgEng();
                initDgPart();
                initDgContent();
            }
        });
    }

    //回填
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_SR_PKID",
                pkid: pkid
            },
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    selectAppType(jdata.data.APP_TYPE);
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    if ((op == 'edit' && jdata.data.STATUS == 'COMMUNICATION') || op == 'view') {
                        $('#mfrName').textbox('readonly', true);
                        $('#mfrLinkMan').textbox('readonly', true);
                        $('#mfrLinkEmail').textbox('readonly', true);
                        $('#ccList').textbox('readonly', true);
                        $('#title').textbox('readonly', true);
                        $('#appType').textbox('readonly', true);
                        $('#acOrFleet').textbox('readonly', true);
                        $('#model').textbox('readonly', true);
                        $('#ata').textbox('readonly', true);
                    }
                    if (op == 'view') {
                        $('#saveBtn').hide();
                        $('#mfrDueDate').textbox('readonly', true);
                        $('#dueDate').textbox('readonly', true);
                    }

                    jdata.data.AC_OR_FLEET == "FLEET" ? $('#id_dg_apl').hide() : $('#id_dg_apl').show();
                    $('#id_dg_eng').show();
                    $('#id_dg_part').show();
                    $('#id_dg_content').show();
                    jdata.data.AC_OR_FLEET == "AC" ? $('#id_dg_apl_mark').show() : $('#id_dg_apl_mark').hide();
                    jdata.data.APP_TYPE == "ENG" ? $('#id_dg_eng_mark').show() : $('#id_dg_eng_mark').hide();
                    jdata.data.APP_TYPE == "PART" ? $('#id_dg_part_mark').show() : $('#id_dg_part_mark').hide();
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function selectAppType(appType) {
        if (appType == "APL") {
            $('#acOrFleet').combobox({
                panelHeight: '70px',
                data: param.EM_SR_AC_OR_FLEET,
                valueField: 'VALUE',
                textField: 'TEXT',
                required: true,
                readonly: false,
                onChange: function (newValue, oldValue) {
                    if (newValue == "AC") {
                        $('#id_dg_apl').show();
                        $('#id_dg_eng').show();
                        $('#id_dg_part').show();
                        $('#id_dg_content').show();
                        $('#id_dg_apl_mark').show();
                        $('#id_dg_eng_mark').hide();
                        $('#id_dg_part_mark').hide();
                    } else if (newValue == "FLEET") {
                        $('#id_dg_apl').hide();
                        $('#id_dg_eng').show();
                        $('#id_dg_part').show();
                        $('#id_dg_content').show();
                        $('#id_dg_eng_mark').hide();
                        $('#id_dg_part_mark').hide();
                    } else {
                        $('#id_dg_apl').hide();
                        $('#id_dg_eng').hide();
                        $('#id_dg_part').hide();
                        $('#id_dg_content').hide();
                    }
                }
            });
            $('#model').combobox({
                panelHeight: '120px',
                data: param.DA_FLEET,
                valueField: 'VALUE',
                textField: 'TEXT',
                required: true,
                readonly: false,
            });
        } else if (appType == "ENG") {
            $('#acOrFleet').combobox({
                required: false,
                readonly: true
            });
            $('#model').combobox({
                panelHeight: '120px',
                data: param.EM_SR_ENG_MODEL,
                valueField: 'VALUE',
                textField: 'TEXT',
                required: true,
                readonly: false
            });
        } else {
            $('#acOrFleet').combobox({
                required: false,
                readonly: true
            });
            $('#model').combobox({
                required: false,
                readonly: true
            });
        }
    }

    function initDgApl() {
        $("#dg_apl").MyDataGrid({
            identity: 'dg_apl',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 380, height: 120};
            },
            queryParams: {
                srPkid: !! pkid ? pkid : "0"
            },
            columns: {
                param: {FunctionCode: 'EM_SR_APL_LIST'}
            },
            toolbar: [
                {
                    id: "btn-apl-add",
                    text: $.i18n.t('common:COMMON_OPERATION.ADD'),
                    iconCls: "icon-add",
                    handler: function () {
                        if (! pkid) {
                            MsgAlert({
                                content: "请先保存基本信息！",
                                type: "warn"
                            });
                            return;
                        }
                        var url = "/views/em/emsr/em_sr_apl_add.shtml?srPkid=" + pkid;
                        var appType = $('#appType').textbox('getValue');
                        if (appType == "APL") {
                            url += "&model=" + $('#model').textbox('getValue');
                        }

                        ShowWindowIframe({
                            url: url,
                            title: "增加适用机身信息",
                            width: 600,
                            height: 500
                        });
                    }
                }
            ],
            contextMenus: [
                {
                    id: "m-apl-edit",
                    i18nText: "common:COMMON_OPERATION.EDIT",
                    onclick: function () {
                        var rowdata = getDG('dg_apl').datagrid('getSelected');
                        if (!rowdata.PKID) {
                            MsgAlert({content: '请选择记录！', type: 'error'});
                            return;
                        }

                        var url = "/views/em/emsr/em_sr_apl_add.shtml?pkid=" + rowdata.PKID;
                        var appType = $('#appType').textbox('getValue');
                        if (appType == "APL") {
                            url += "&model=" + $('#model').textbox('getValue');
                        }

                        common_add_edit_({
                            url: url,
                            identity: 'dg_apl',
                            isEdit: 1,
                            width: 800,
                            height: 600
                        });
                    }
                },
                {
                    id: "m-apl-delete",
                    i18nText: "common:COMMON_OPERATION.DEL",
                    onclick: function () {
                        var rowData = getDG('dg_apl').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (!confirm("确认删除该记录？")) {
                            return;
                        }
                        InitFuncCodeRequest_({
                            data: {
                                FunctionCode: 'EM_SR_APL_DEL',
                                pkid: rowData.PKID
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    $('#dg_apl').datagrid("reload");
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }
            ],
            onBeforeLoad: function () {
                if (op == "view") {
                    $('div.datagrid-toolbar').hide();
                }
            },
            validAuth: function (row, items) {
                if (op == "view") {
                    items['common:COMMON_OPERATION.EDIT'].display = false;
                    items['common:COMMON_OPERATION.DEL'].display = false;
                }
            }
        });
    }

    function initDgEng() {
        $("#dg_eng").MyDataGrid({
            identity: 'dg_eng',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 300, height: 120};
            },
            queryParams: {
                srPkid: !! pkid ? pkid : "0"
            },
            columns: {
                param: {FunctionCode: 'EM_SR_ENG_LIST'}
            },
            toolbar: [
                {
                    id: "btn-eng-add",
                    text: $.i18n.t('common:COMMON_OPERATION.ADD'),
                    iconCls: "icon-add",
                    handler: function () {
                        if (! pkid) {
                            MsgAlert({
                                content: "请先保存基本信息！",
                                type: "warn"
                            });
                            return;
                        }
                        var url = "/views/em/emsr/em_sr_eng_add.shtml?srPkid=" + pkid;
                        var appType = $('#appType').textbox('getValue');
                        if (appType == "ENG") {
                            url += "&model=" + $('#model').textbox('getValue');
                        }

                        ShowWindowIframe({
                            url: url,
                            title: "增加适用发动机信息",
                            width: 600,
                            height: 500
                        });
                    }
                }
            ],
            contextMenus: [
                {
                    id: "m-eng-edit",
                    i18nText: "common:COMMON_OPERATION.EDIT",
                    onclick: function () {
                        var rowdata = getDG('dg_eng').datagrid('getSelected');
                        if (!rowdata.PKID) {
                            MsgAlert({content: '请选择记录！', type: 'error'});
                            return;
                        }

                        var url = "/views/em/emsr/em_sr_eng_add.shtml?pkid=" + rowdata.PKID;
                        var appType = $('#appType').textbox('getValue');
                        if (appType == "ENG") {
                            url += "&model=" + $('#model').textbox('getValue');
                        }

                        common_add_edit_({
                            url: url,
                            identity: 'dg_eng',
                            isEdit: 1,
                            width: 800,
                            height: 600
                        });
                    }
                },
                {
                    id: "m-eng-delete",
                    i18nText: "common:COMMON_OPERATION.DEL",
                    onclick: function () {
                        var rowData = getDG('dg_eng').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (!confirm("确认删除该记录？")) {
                            return;
                        }
                        InitFuncCodeRequest_({
                            data: {
                                FunctionCode: 'EM_SR_ENG_DEL',
                                pkid: rowData.PKID
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    $('#dg_eng').datagrid("reload");
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }
            ],
            onBeforeLoad: function () {
                if (op == "view") {
                    $('div.datagrid-toolbar').hide();
                }
            },
            validAuth: function (row, items) {
                if (op == "view") {
                    items['common:COMMON_OPERATION.EDIT'].display = false;
                    items['common:COMMON_OPERATION.DEL'].display = false;
                }
            }
        });
    }

    function initDgPart() {
        $("#dg_part").MyDataGrid({
            identity: 'dg_part',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 200, height: 120};
            },
            queryParams: {
                srPkid: !! pkid ? pkid : "0"
            },
            columns: {
                param: {FunctionCode: 'EM_SR_PART_LIST'}
            },
            toolbar: [
                {
                    id: "btn-part-add",
                    text: $.i18n.t('common:COMMON_OPERATION.ADD'),
                    iconCls: "icon-add",
                    handler: function () {
                        if (! pkid) {
                            MsgAlert({
                                content: "请先保存基本信息！",
                                type: "warn"
                            });
                            return;
                        }
                        var url = "/views/em/emsr/em_sr_part_add.shtml?srPkid=" + pkid;

                        ShowWindowIframe({
                            url: url,
                            title: "增加适用部件信息",
                            width: 500,
                            height: 400
                        });
                    }
                }
            ],
            contextMenus: [
                {
                    id: "m-part-edit",
                    i18nText: "common:COMMON_OPERATION.EDIT",
                    onclick: function () {
                        var rowData = getDG('dg_part').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }

                        var url = "/views/em/emsr/em_sr_part_add.shtml?pkid=" + rowData.PKID;

                        ShowWindowIframe({
                            url: url,
                            title: "维护适用部件信息",
                            width: 500,
                            height: 400
                        });
                    }
                },
                {
                    id: "m-part-delete",
                    i18nText: "common:COMMON_OPERATION.DEL",
                    onclick: function () {
                        var rowData = getDG('dg_part').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (!confirm("确认删除该记录？")) {
                            return;
                        }
                        InitFuncCodeRequest_({
                            data: {
                                FunctionCode: 'EM_SR_PART_DEL',
                                pkid: rowData.PKID
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    $('#dg_part').datagrid("reload");
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }
            ],
            onBeforeLoad: function () {
                if (op == "view") {
                    $('div.datagrid-toolbar').hide();
                }
            },
            validAuth: function (row, items) {
                if (op == "view") {
                    items['common:COMMON_OPERATION.EDIT'].display = false;
                    items['common:COMMON_OPERATION.DEL'].display = false;
                }
            }
        });
    }

    function initDgContent() {
        $("#dg_content").MyDataGrid({
            identity: 'dg_content',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 900, height: 150};
            },
            queryParams: {
                srPkid: !! pkid ? pkid : "0"
            },
            columns: {
                param: {FunctionCode: 'EM_SR_CONTENT_LIST'}
            },
            toolbar: [
                {
                    id: "btn-content-add",
                    text: $.i18n.t('common:COMMON_OPERATION.ADD'),
                    iconCls: "icon-add",
                    handler: function () {
                        if (! pkid) {
                            MsgAlert({
                                content: "请先保存基本信息！",
                                type: "warn"
                            });
                            return;
                        }
                        ShowWindowIframe({
                            url: "/views/em/emsr/em_sr_content_add.shtml?operation=add&srPkid=" + pkid,
                            title: "维护适用部件信息",
                            width: 800,
                            height: 600
                        });
                    }
                }
            ],
            contextMenus: [
                {
                    id: "m-content-view",
                    i18nText: "查看",
                    onclick: function () {
                        var rowdata = getDG('dg_content').datagrid('getSelected');
                        if (!rowdata.PKID) {
                            MsgAlert({content: '请选择记录！', type: 'error'});
                            return;
                        }
                        common_add_edit_({
                            url: "/views/em/emsr/em_sr_content_add.shtml?operation=view&pkid=" + rowdata.PKID,
                            identity: 'dg_content',
                            isEdit: 1,
                            width: 800,
                            height: 600
                        });
                    }
                },
                {
                    id: "m-content-reply",
                    i18nText: "回复",
                    onclick: function () {
                        var rowdata = getDG('dg_content').datagrid('getSelected');
                        if (!rowdata.PKID) {
                            MsgAlert({content: '请选择记录！', type: 'error'});
                            return;
                        }
                        common_add_edit_({
                            url: "/views/em/emsr/em_sr_content_add.shtml?operation=reply&pkid=" + rowdata.PKID,
                            identity: 'dg_content',
                            isEdit: 1,
                            width: 800,
                            height: 600
                        });
                    }
                },
                {
                    id: "m-content-edit",
                    i18nText: "common:COMMON_OPERATION.EDIT",
                    onclick: function () {
                        var rowdata = getDG('dg_content').datagrid('getSelected');
                        if (!rowdata.PKID) {
                            MsgAlert({content: '请选择记录！', type: 'error'});
                            return;
                        }
                        common_add_edit_({
                            url: "/views/em/emsr/em_sr_content_add.shtml?operation=edit&pkid=" + rowdata.PKID,
                            identity: 'dg_content',
                            isEdit: 1,
                            width: 800,
                            height: 600
                        });
                    }
                },
                {
                    id: "m-content-delete",
                    i18nText: "common:COMMON_OPERATION.DEL",
                    onclick: function () {
                        var rowData = getDG('dg_content').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (!confirm("确认删除该记录，将同时删除全部附件？")) {
                            return;
                        }
                        InitFuncCodeRequest_({
                            data: {
                                FunctionCode: 'EM_SR_CONTENT_DEL',
                                pkid: rowData.PKID
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    $("#dg_content").datagrid("reload");
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }
            ],
            onBeforeLoad: function () {
                if (op == "view") {
                    $('div.datagrid-toolbar').hide();
                }
            },
            validAuth: function (row, items) {
                var status = row.STATUS; // WRITING, SENT
                // items['关闭'].enable = status == "COMMUNICATION";
                items['common:COMMON_OPERATION.EDIT'].enable = status == "WRITING";
                items['common:COMMON_OPERATION.DEL'].enable = status == "WRITING";

                if (op == "view") {
                    items['回复'].display = false;
                    items['common:COMMON_OPERATION.EDIT'].display = false;
                    items['common:COMMON_OPERATION.DEL'].display = false;
                }
            }
        });
    }

    function save() {
        var isValidate = $('#mform').form('validate');
        if (! isValidate) {
            return;
        }
        var formData = JSON.stringify($('#mform').serializeObject());

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_SR_ADD",
                formData: formData
            },
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    if (! pkid) {
                        pkid = jdata.data.pkid;
                        $('#pkid').val(jdata.data.pkid);
                        $('#status').val(jdata.data.status);
                        $('#dg_apl').datagrid("load", {srPkid: pkid});
                        $('#dg_eng').datagrid("load", {srPkid: pkid});
                        $('#dg_part').datagrid("load", {srPkid: pkid});
                    }

                    param.OWindow.reload_();
                    MsgAlert({
                        content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')
                    });
                } else {
                    MsgAlert({
                        content: jdata.msg,
                        type: 'error'
                    });
                }
            }
        });
    }

    function closeW() {
        CloseWindowIframe();
    }

    /** 刷新列表数据 */
    function reload_() {
        $("#dg").datagrid("reload");
    }

</script>

</html>
