<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="pm_mplanconf">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title data-i18n="RES.EM_ALLOCATE_RULE.TITLE">新增改变量</title>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
</head>
<body class="ibody">
<fieldset class="fieldset_eui">
    <form id="mform" method="post">
        <div id="searchBar">
            <table class="table table-bordered table-info">
                <tr>
                    <td colspan="4" align="right">
                        <a class="searchBtn" data-options="iconCls:'icon-search'"
                           data-i18n="" onclick="save()"
                           >保存</a>
                        <a class="searchBtn" data-options="iconCls:'icon-search'"
                           data-i18n="" onclick="CloseWindowIframe()"
                           >关闭</a>
                    </td>
                </tr>
                <tr>
                    <th data-i18n="" style="width: 90px">EO/EA编号：</th>
                    <td>
                        <input class="easyui-combogrid" name="eoNo" id="eoNo" data-options=""
                               style="width:150px;"/>
                    </td>
                    <th data-i18n="" style="width: 90px">EO/EA版次：</th>
                    <td>
                        <input class="easyui-textbox" name="eoVer" id="eoVer" data-options=""
                               style="width:150px;" disabled="disabled"/>
                    </td>
                    <input type="hidden" id="eoPkid">
                </tr>
                <tr>
                    <th data-i18n="" style="width: 90px">重量变化量：</th>
                    <td>
                        <input class="easyui-textbox" name="weighChange" id="weighChange"
                               style="width:150px;" data-options="min:-10000000,max:10000000,precision:2,required:true" />
                    </td>
                    <th data-i18n="" style="width: 90px">力矩变化量：</th>
                    <td>
                        <input class="easyui-textbox" name="momentChange" id="momentChange"
                               style="width:150px;" data-options="min:-10000000,max:10000000,precision:2,required:true"/>
                    </td>
                </tr>
                <tr>
                    <th style="width: 90px">备注：</th>
                    <td colspan="3">
                        <input class="easyui-textbox" id="memo" name="memo"
                               data-options="multiline:true,editable:false,onlyview:true,validType:['maxLength[1000]'] "
                               style="width: 450px;height: 70px" />
                    </td>
                </tr>
                <tr>
                    <th style="width: 90px">是否累计：</th>
                    <td>
                        <input class="easyui-combobox" name="ifCumulative" id="ifCumulative"
                               style="width:150px;" data-options="required:true,editable:false" />
                    </td>
                </tr>
                <tr id="noCumulativeReasonTr" style="display: none">
                    <th style="width: 90px">不累计原因：</th>
                    <td colspan="3">
                        <input class="easyui-textbox" name="noCumulativeReason" id="noCumulativeReason"
                               style="width:450px; height: 50px" data-options="multiline:true,validType:['maxLength[200]']" />
                    </td>
                </tr>
                <tr>
                    <th data-i18n="" style="width: 90px">确认人：</th>
                    <td>
                        <input class="easyui-textbox" name="confirmMan" id="confirmMan" data-options=""
                               style="width:150px;" disabled="disabled"/>
                    </td>
                    <th data-i18n="" style="width: 90px">确认日期：</th>
                    <td>
                        <input class="easyui-datebox" name="confirmDate" id="confirmDate" data-options=""
                               style="width:150px;" disabled="disabled"/>
                    </td>
                </tr>
            </table>
        </div>
    </form>
</fieldset>
<script type="text/javascript">
var PAGE_DATA = {};
var param;
var reportPkid;
var acno;

var artChanged = false;
var selectRow = null;
var wireRod;

function i18nCallBack() {
    param = getParentParam_();
    reportPkid = param.reportPkid;
    acno = param.acno;
    var userName = getLoginInfo().userName;
    $('#confirmMan').textbox('setValue', userName);
    $('#confirmDate').datebox('setValue',formatterDate(new Date()));
    InitFuncCodeRequest_({
        data: {
            domainCode: "YESORNO",
            FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
        },
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                $('#ifCumulative').combobox({
                    panelHeight: '80px',
                    data: jdata.data.YESORNO,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    onChange: function (newValue, oldValue) {
                        if('Y' == newValue){
                            $('#noCumulativeReasonTr').hide();
                            $('#noCumulativeReason').textbox({onlyview:true, required:false, value:''});
                        }else if('N' == newValue){
                            $('#noCumulativeReasonTr').show();
                            $('#noCumulativeReason').textbox({onlyview:false, required:true});
                        }
                    }
                });

                $("#eoNo").combogrid({
                    panelWidth: 300,
                    //width: 180,
                    idField: 'PKID',  //实际选择值
                    textField: 'EO_NO', //文本显示值
                    editable: true,
                    required: true,
                    pagination: false,
                    tipPosition: 'top',
                    //mode: 'remote',
                    queryParams: {acno: acno},
                    url: Constant.API_URL + 'EM_WB_CHANGE_RELATE_EO',
                    //multiple: true,
                    columns: [[
                        {field: 'EO_NO', title: 'EO/EA编号', width: 120, sortable: true},
                        {field: 'EO_VER', title: 'EO/EA版次', width: 80, sortable: true}
                    ]],
                    onShowPanel: function () {
                        $(this).combogrid('grid').datagrid('reload');

                    },
                    onChange : function (q) {
                        artChanged = true;//记录是否有改变（当手动输入时发生)
                    },
                    onHidePanel: function () {
                        var t = $(this).combogrid('getText');
                        if (artChanged) {
                            if (selectRow == null || t != selectRow.EO_NO) {//没有选择或者选项不相等时清除内容
                                alert('请选择，不要直接输入');
                                $(this).combogrid('setValue', '');
                            } else {
                                //do something...
                            }
                        }
                        artChanged = false;
                        selectRow = null;
                    },
                    onSelect: function (index, row) {
                        selectRow = row;
                        $('#eoVer').textbox('setValue', row.EO_VER);
                        $('#eoPkid').val(row.PKID);
                        $('#weighChange').textbox('setValue', row.WEIGHT_VARIABLE);
                        $('#momentChange').textbox('setValue', row.MOMENT_VARIABLE);
                        $('#memo').textbox('setValue', row.MEMO);
                    },
                    onLoadSuccess: function (result) {
                        wireRod = result;
                    }
                });
            }
            else {
                MsgAlert({content: jdata.msg, type: 'error'});
            }
        }
    });

}

function save() {
    var isValidate = $("#mform").form('validate');
    if (!isValidate) {
        return false;
    }
    var data = $("#mform").serializeObject();
    var eoVer = $('#eoVer').textbox('getValue');
    var eoPkid = $('#eoPkid').val();
    data.eoVer = eoVer;
    data.reportPkid = reportPkid;
    data.eoPkid = eoPkid;
    data.acno = acno;
    data.confirm = "N";
    data = $.extend({}, data, {FunctionCode: 'EM_WB_CHANGE_ADD'});
    InitFuncCodeRequest_({
        data: data,
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                param.OWindow.reload_();
                //$("#mform").form('clear');
                CloseWindowIframe();
            }
            else {
                MsgAlert({content: jdata.msg, type: 'error'});
            }
        }
    });
}


formatterDate = function(date) {
    var day = date.getDate() > 9 ? date.getDate() : "0" + date.getDate();
    var month = (date.getMonth() + 1) > 9 ? (date.getMonth() + 1) : "0"
        + (date.getMonth() + 1);
    return date.getFullYear() + '-' + month + '-' + day;
};

$.extend($.fn.validatebox.defaults.rules, {
    intOrFloat: {// 验证正整数或小数
        validator: function (value) {
            return /^(0\.0*[1-9]+[0-9]*$|[1-9]+[0-9]*\.[0-9]*[0-9]$|[1-9]+[0-9]*$)/.test(value);
        },
        message: '请输入大于0的数字'
    },
    maxValue: {
        validator: function (value) {
            return value <= 9999999999;
        },
        message: '请输入0~9999999999范围的数字'
    },
    comboBoxEditvalid: { //校验下拉菜单
        validator: function (value, param) {
            var $combobox = $("#" + param[0]);
            if (value) {
                if ($combobox.combobox('getValue') == $combobox.combobox('getText'))
                    return false;
                return true;
            }
            return false;

        },
        message: '请选择下拉框选项，不要直接使用输入内容'
    },

});

</script>
</body>
</html>