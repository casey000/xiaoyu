<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="pm_mplanconf">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title data-i18n="RES.EM_ALLOCATE_RULE.TITLE">新增改变量</title>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
</head>
<body class="ibody">
<div id="tabs" style="width: 100%; height: 100%;">
    <div id="tab01" title="业务表单数据" style="">
        <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
            <input type="hidden" id="isFirstNode" name="isFirstNode">
            <input type="hidden" id="auditBy" name="auditBy">
            <input type="hidden" id="approvalBy" name="approvalBy">
            <table class="table table-bordered table-info">
                <tr>
                    <th class="th"  data-i18n="" style="width: 90px">报告编号：</th>
                    <td class="td5" >
                        <input class="easyui-textbox" name="reportNo" id="reportNo" data-options="editable:false"
                               style="width:150px;"/>
                    </td>
                    <th class="th" data-i18n="" style="width: 90px">称重日期：</th>
                    <td class="td5">
                        <input class="easyui-datebox" name="weighDate" id="weighDate" data-options="editable:false,onlyview:true"
                               style="width:150px;" />
                    </td>
                    <th class="th" data-i18n="" style="width: 90px">机号：</th>
                    <td class="td5">
                        <input class="easyui-combobox" name="acno" id="acno" data-options="editable:false,onlyview:true"
                               style="width:150px;"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" data-i18n="" style="width: 90px">称重地点：</th>
                    <td class="td5" colspan="5">
                        <input class="easyui-textbox" name="weighPlace" id="weighPlace" data-options="editable:false"
                               style="width:90%;"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" data-i18n="" style="width: 90px">称重原因：</th>
                    <td class="td5" colspan="5">
                        <input class="easyui-textbox" name="weighReason" id="weighReason" data-options="multiline:true,editable:false"
                               style="width:90%; height: 60px"/>
                    </td>
                </tr>


                <tr>
                    <th class="th" data-i18n="" style="width: 90px">基本空重(LB)：</th>
                    <td class="td5">
                        <input class="easyui-textbox" name="bew" id="bew"
                               style="width:150px;" data-options="editable:false" />
                    </td>
                    <th class="th" data-i18n="" style="width: 90px">基本空重(KG)：</th>
                    <td class="td5">
                        <input class="easyui-textbox" name="bewKg" id="bewKg"
                               style="width:150px;" data-options="editable:false" />
                    </td>
                    <th class="th" data-i18n="" style="width: 90px">力矩(LB.IN)：</th>
                    <td class="td5">
                        <input class="easyui-textbox" name="moment" id="moment"
                               style="width:150px;" data-options="editable:false"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" data-i18n="" style="width: 90px">平衡力臂(IN)：</th>
                    <td class="td5">
                        <input class="easyui-textbox" name="harm" id="harm"
                               style="width:150px;" data-options="" disabled="disabled"/>
                    </td>
                    <th class="th" data-i18n="" style="width: 90px">空气动力弦长：</th>
                    <td class="td5">
                        <input class="easyui-textbox" name="mac" id="mac"
                               style="width:150px;" data-options="" disabled="disabled"/>
                    </td>
                    <th class="th" data-i18n="" style="width: 90px">报告人：</th>
                    <td class="td5">
                        <input class="easyui-textbox" name="reportMan" id="reportMan" data-options=""
                               style="width:150px;" disabled="disabled"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" data-i18n="" style="width: 90px">报告日期：</th>
                    <td class="td5" colspan="5">
                        <input class="easyui-datebox" name="reportDate" id="reportDate" data-options=""
                               style="width:150px;" disabled="disabled"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" data-i18n="" style="width: 90px">附件：</th>
                    <td class="td5" colspan="5">
                        <span id="fileUrls" style="display: block;overflow: hidden"></span>
                    </td>
                </tr>
            </table>
            <h5 style="margin-bottom: 4px;">流程处理：</h5>
            <input name="taskId" type="hidden" />
            <table class="table table-bordered table-info"><tbody id="custom_options"></tbody></table>
            <table class="table table-bordered table-info" id="mtable">
                <tr>
                    <th class="tdl" style="width: 100px;">处理意见：</th>
                    <td class="tdr">
                        <input id="notes" name="notes" class="easyui-textbox easyui-validatebox"
                               data-options="multiline:true,validType:['maxLength[200]']" style="height:55px; width: 100%;"/>
                    </td>
                    <th id="nextTh" class="tdl xmclass" style="width: 100px">下一级办理人：</th>
                    <td id="nextTd" class="tdr xmclass">
                        <input id="authId" class="easyui-textbox easyui-validatebox"
                               data-options="validType:['maxLength[20]'] " style="height:25px; width:150px;"/>
                    </td>
                </tr>
                <tr>
                    <td colspan="6" align="center">
                        <input id="canSubmit" class="btn" disabled="disabled" type="button" onclick="doSubmit();"
                               value="提交"/>
                        <input id="canReturn" class="btn" disabled="disabled" type="button" onclick="doReturn();"
                               value="退回"/>
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div title="流程信息" style="">
        <table class="table table-bordered table-info" id="processInfo">
            <tr>
                <th class="tdl" style="width: 145px;">流程业务Key ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="businessKey"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="executionName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="createTime"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程创建人 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="userName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="nodeName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="isJoint"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务-配置 ：</th>
                <td class="tdr" colspan="3" style="vertical-align: middle;">
                    <input type="checkbox" name="canReturn" value="" disabled/> 可退回
                    <input type="checkbox" name="canTrunTo" value="" disabled/> 可转办
                    <input type="checkbox" name="canTerminate" value="" disabled/> 可终止
                    <input type="checkbox" name="canHangUp" value="" disabled/> 可挂起
                </td>
            </tr>
        </table>
        <div id="workflow" style="overflow-x: scroll;"></div>
    </div>
    <div id="tab02" title="历史任务信息" style="">
        <table id="historyDg"></table>
    </div>
</div>

<script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
<script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
<script src="/js/datagrid_utils.js" type="text/javascript"></script>
<script type="text/javascript">
var PAGE_DATA = {};
var param;
var pkid;
var operation;
var reportNo = '';
var userId;

function InitLoadResource(resource, execution, node) {
    pkid = resource.pkid;
    reportNo = resource.reportNo;
    userId = getLoginInfo().accountId;
    InitFuncCodeRequest_({
        async: false,
        data: {
            domainCode: "DA_ACREG_MAN_ACNO",
            FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
        },
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                PAGE_DATA['acno'] = DomainCodeToMap_(jdata.data["DA_ACREG_MAN_ACNO"]);

                $('#acno').combobox({
                    panelHeight: '140px',
                    data: jdata.data.DA_ACREG_MAN_ACNO,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });

                $("#authId").MyComboGrid({
                    idField: 'ACCOUNT_ID',  //实际选择值
                    textField: 'USER_NAME', //文本显示值
                    panelHeight: '180px',
                    required: true,
                    width: 140,
                    params: {userId: userId, FunctionCode: 'FLOW_WORK_ACCOUNT'},
                    columns: [[
                        {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                        {field: 'USER_NAME', title: '审核人', width: 50}
                    ]],
                    onHidePanel: function () {
                        var t = $(this).combogrid('getValue');
                        if(t != null && t != '' & t != undefined){
                            if (selectRow == null || t != selectRow.ACCOUNT_ID) {//没有选择或者选项不相等时清除内容
                                alert('请选择，不要直接输入！');
                                $(this).combogrid({value:''});
                            }
                        }
                    },
                    onSelect: function (index, row) {
                        selectRow = row;
                        if('task1560926374090' == node.taskPropId) {//任务退回
                            $("#auditBy").val(row.ACCOUNT_ID);
                        }else if('task1560926339237' == node.taskPropId){//审核
                            $("#approvalBy").val(row.ACCOUNT_ID);
                        }
                        /*else if('task1560926358262' == node.taskPropId){//审批
                            $("#ksldBy").val(row.ACCOUNT_ID);
                        }*/

                    }
                });

                ParseFormField_(resource, null, null);

                // 控制退回按钮和退回弹窗
                if('task1560926339237' == node.taskPropId){     //第一个节点
                    $("#isFirstNode").val('Y');
                }else if('task1560926374090' == node.taskPropId){   // 任务退回节点只能提交
                    $("#canReturn").hide();
                    $("#isFirstNode").val('N');
                }else{
                    $("#isFirstNode").val('N');
                }

                if('task1560926339237' == node.taskPropId){//审批
                    $('#authId').combogrid({required:false});
                    $('#nextTh').hide();
                    $('#nextTd').hide();
                }

                /*if('task1560926358262' == node.taskPropId){//审批
                    $('#authId').combogrid({required:false});
                    $('#nextTh').hide();
                    $('#nextTd').hide();
                }*/

                //获取上传的附件信息
                InitFuncCodeRequest_({
                    data: {
                        SOURCE_ID: pkid,
                        CATEGORY:"emWbReport",
                        FunctionCode: 'ATTACHMENT_RSPL_GET'
                    },
                    successCallBack: function (jdata1) {
                        if (jdata1.code == RESULT_CODE.SUCCESS_CODE) {
                            if (jdata1.data != null) {
                                let html = "";
                                for (var i = 0; i < jdata1.data.length; i++) {
                                    html += '<li style="list-style:none;"><a  href="javascript:void(0)" style="display:block;width:90px;font-size: 12px;text-align:center;vertical-align: middle;color:blue;text-decoration: underline" onclick="downFile(' + jdata1.data[i].PKID + ')">' + jdata1.data[i].ORG_NAME + '</a></li>';
                                }
                                $("#fileUrls").html("");
                                $("#fileUrls").append(html);
                            }
                        }
                    }
                });


            }
            else {
                MsgAlert({content: jdata.msg, type: 'error'});
            }
        }
    });
}

</script>
</body>
</html>