<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>EA详情编辑</title>
</head>

<body>
<div style="width: 980px;margin:0 auto;">
    <div id="searchBar">
        <form class="form-horizontal m-t" id="mform">
            <div id="p0" class="easyui-panel" title="EA编辑" style="width: 980px;padding:10px;">
                <table border="0" cellpadding="0" cellspacing="0" style="width: 100%;">
                    <input id="writeManId" name="writeManId" type="hidden">
                    <input style="display: none" id="writeDeadline" disabled="disabled" name="writeDeadline"
                           style="width: 89%"
                           data-options=" validType:['maxLength[20]']  "/>
                    <tr>
                        <td style="width: 500px;">
                            <div style="float: left; padding: 0px; height: auto">
                                <a> 状态：</a><a id="statusTab">编写中 </a>&nbsp;&nbsp;&nbsp;&nbsp;
                                <!--<a> 旧EA编号：</a> <a><span id="oldEoNo"></span> </a>-->
                                <input id="pkid" name="pkid" style="display: none">
                                <input id="status" name="status" style="display: none" value="00" placeholder="01">
                            </div>
                        </td>
                        <td style="text-align: right;">
                            <input id="pdfBtn" class="btn btn-primary" type="button" onclick="print()" value="PDF预览"
                                   style="width: 80px;margin:5px;" auth="EM_EA_PRINT"/>
                            <!--<input class="btn btn-primary" type="button" id="delayid" onclick="delay()" value="延期申请"
                                   style="width: 80px;margin:5px;" />-->
                            <input class="btn btn-primary" type="button" id="saveId" onclick="save()" value="保存"
                                   style="width: 50px;margin:5px;"/>
                            <!--<a href="javascript:void(0)" class="btn btn-primary" id="tranEoid" onclick="tranEo()">转发</a>-->
                            <input class="btn btn-primary" type="button" onclick="tranEo()" value="转发" id="tranEoid"
                                   style="width: 50px;margin:5px;" auth="EM_EA_TRANSMIT"/>
                            <input class="btn btn-primary" type="button" onclick="rejectEo()" value="驳回" id="reject"
                                   style="width: 50px;margin:5px;display: none" />
                            <input class="btn btn-primary" type="button" id="issueCheckid" onclick="issueCheck()"
                                   value="提交"
                                   style="width: 50px;margin:5px;" auth="EM_EA_SUBMIT"/>
                            <!--<input class="btn btn-primary" type="button" id="newAcDealBtn" onclick="newAcDeal()"
                                   value="处理"
                                   style="width: 50px;margin:5px;display: none;" />-->
                        </td>
                    </tr>
                    <tr id="view">
                        <td class="tdr" colspan="6" align="right">
                            <a> 基本信息 </a>
                        </td>
                    </tr>
                </table>
                <table class="table table-bordered table-info">
                    <tr>
                        <th class="td" align="right" style="width: 90px;">EA编号：</th>
                        <td class="td5">
                            <input class="easyui-textbox" style="width: 110px" id="eoNo" name="eoNo"
                                   data-options="editable:false,onlyview:true"/>
                            R<input class="easyui-textbox" style="width: 25px" id="eoVer" name="eoVer"
                                    data-options="editable:false,onlyview:true"/>

                        </td>
                        <th align="right" style="width: 80px;">机型：</th>
                        <td class="td5">
                            <input class="easyui-combobox" style="width: 115px" id="applyModel" name="applyModel"
                                   data-options="required:true,editable:true,validType:'comboBoxEditvalid[\'applyModel\']'"/>
                        </td>
                        <th align="right" style="width: 80px;">机号：</th>
                        <td class="td5">
                            <input class="easyui-combobox" style="width: 115px" id="acid" name="acid"
                                   data-options="required:true,editable:true"/>
                        </td>
                        <th class="td" align="right" style="width: 80px;">章节：</th>
                        <td class="td5">
                            <input class="easyui-combogrid" style="width: 115px" id="ata" name="ata"
                                   data-options="required:true,validType:'comboBoxEditvalid[\'ata\']'"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 90px;">EA类别：</th>
                        <td class="td5">
                            <input class="easyui-combobox" style="width: 150px" id="eaSort" name="eaSort"
                                   data-options="required:true,editable:true,validType:'comboBoxEditvalid[\'eaSort\']'"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">位置：</th>
                        <td class="td5">
                            <input class="easyui-combobox" style="width: 115px" id="position"
                                   name="position"
                                   data-options="required:true,editable:true,validType:'comboBoxEditvalid[\'position\']'"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">计划属性：</th>
                        <td class="td5">
                            <input class="easyui-combobox" style="width: 115px" id="planAttri"
                                   name="planAttri"
                                   data-options="required:true,editable:true,validType:'comboBoxEditvalid[\'planAttri\']'"/>
                        </td>

                        <th class="th" align="right" style="width: 80px;">拆换类型：</th>
                        <td class="td5">
                            <input class="easyui-combobox" style="width: 115px" id="replacementType" name="replacementType"
                                   data-options="required:true,editable:true,validType:'comboBoxEditvalid[\'replacementType\']'"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 90px;">拆下处置方式：</th>
                        <td class="td5">
                            <input class="easyui-combobox" style="width: 150px" id="removeDeal" name="removeDeal"
                                   data-options="required:true,editable:true,validType:'comboBoxEditvalid[\'removeDeal\']'"/>
                        </td>
                        <td class="td5" colspan="6">
                            <input class="easyui-textbox" style="width: 100%" id="removeDealDes" name="removeDealDes"
                                   data-options="required:false,editable:false,onlyview:true"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 90px;">Mark：</th>
                        <td colspan="7">
                            <!--<div style="float:left;margin:5px;" id="adChoose">
                                <input type="checkbox" id="ad" name="mark" value="AD"/> AD&nbsp;&nbsp;
                            </div>-->
                            <div style="float:left;margin:5px;" id="ewisChoose">
                                <input type="checkbox" id="ewis" name="mark" data-options="" value="EWIS"/>EWIS&nbsp;&nbsp;
                            </div>
                            <div style="float:left;margin:5px;" id="ftsChoose">
                                <input type="checkbox" id="fts" name="mark" data-options="" value="FTS"/>FTS&nbsp;&nbsp;
                            </div>
                            <div style="float:left;margin:5px;" id="dmChoose">
                                <input type="checkbox" id="dm" name="mark" data-options="" value="DM" onclick="chooseDm(this)"/>DM&nbsp;&nbsp;
                            </div>
                            <div id="ifsdChoose" style="float:left;margin:5px;">
                                <input type="checkbox" id="ifsd" name="mark" value="IFSD" onclick="chooseIfsd(this)"/> IFSD&nbsp;&nbsp;
                            </div>
                            <div style="float:left;margin:5px;" id="cpcpChoose">
                                <input type="checkbox" id="cpcp" name="mark" data-options="" value="CPCP"/>CPCP&nbsp;&nbsp;
                            </div>
                            <div style="float:left;margin:5px;" id="cdcclChoose">
                                <input type="checkbox" id="cdccl" name="mark" data-options="" value="CDCCL"/>CDCCL&nbsp;&nbsp;
                            </div>
                            <div style="float:left;margin:5px;" id="rciChoose">
                                <input type="checkbox" id="rci" name="mark" data-options="" value="RCI"/>RCI&nbsp;&nbsp;
                            </div>
                            <div style="float:left;margin:5px;" id="riiChoose">
                                <input type="checkbox" id="rii" name="mark" data-options="" value="RII"/>RII&nbsp;&nbsp;
                            </div>
                            <div style="float:left;margin:5px;" id="rscChoose">
                                <input type="checkbox" id="rsc" name="mark" data-options="" value="RSC"/>RSC&nbsp;&nbsp;
                            </div>
                            <div style="float:left;margin:5px;" id="acChoose">
                                <input type="checkbox" id="ac" name="mark" data-options="" value="OFF-AC"/>OFF-AC&nbsp;&nbsp;
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <th id="checkMqTh" class="th" align="right" style="width: 80px;"><input class="btn btn-primary"
                                                                                                type="button"
                                                                                                id="checkMqBtn"
                                                                                                onclick="checkMq()"
                                                                                                value="选择工卡"
                                                                                                style="width: 80px;margin:5px;"/>
                        </th>
                        <td id="eojcNoTd" class="td5" colspan="5">
                            <input class="easyui-textbox" style="width: 97%" id="eojcNo" name="eojcNo"
                                   data-options="required:true,editable:true,disabled:true"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">中文标题：</th>
                        <td class="tdr" colspan="9">
                        <textarea class="easyui-textbox" id="cnName" name="cnTitle"
                                  data-options="required:true,editable:true,multiline:true"
                                  style="width: 98%;height:50px"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 80px;">英文标题：</th>
                        <td class="tdr" colspan="9">
                        <textarea class="easyui-textbox" id="enName" name="enTitle"
                                  data-options="required:true,editable:true,multiline:true"
                                  style="width: 98%;height:50px"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 90px;">拆下件号：</th>
                        <td class="td5">
                            <input class="easyui-textbox" style="width: 150px" id="removePn" name="removePn"
                                   data-options="editable:false,onlyview:true"/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">拆下序号：</th>
                        <td class="td5">
                            <input class="easyui-textbox" style="width: 100px" id="removeSn"
                                   name="removeSn"
                                   data-options="editable:false,onlyview:true"/>
                            <input class="btn btn-primary" type="button" onclick="removePnSn()" value="选择" id="remove"
                                   style="width: 40px;margin:5px;" />
                        </td>

                        <th class="th" align="right" style="width: 80px;">装上件号：</th>
                        <td class="td5">
                            <input class="easyui-textbox" style="width: 115px" id="installPn"
                                   name="installPn"
                                   data-options="editable:false,onlyview:true"/>
                        </td>

                        <th class="th" align="right" style="width: 80px;">装上序号：</th>
                        <td class="td5">
                            <input class="easyui-textbox" style="width: 100px" id="installSn" name="installSn"
                                   data-options="editable:false,onlyview:true"/>
                            <input class="btn btn-primary" type="button" onclick="installPnSn()" value="选择" id="install"
                                   style="width: 40px;margin:5px;" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 90px;">拆换原因：</th>
                        <td class="tdr" colspan="9">
                        <textarea class="easyui-textbox" id="removeReason" name="removeReason"
                                  data-options="required:true,editable:true,multiline:true"
                                  style="width: 100%;height:200px"></textarea>
                        </td>
                    </tr>
                </table>
                <div id="emEoAppDiv"></div>
            </div>

            <div id="ps1Div" name="ps1Div" class="easyui-panel" title="时限部分" style="width: 980px;padding:10px; ">
                <div id="eoUpdateDiv">
                    <table>
                        <tr>
                            <td>
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <input class="easyui-textbox" style="width: 115px" id="tsn" name="tsn"
                                       data-options="editable:true,validType:['numberFh']"/>FH
                            </td>
                            <td>
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <input class="easyui-textbox" style="width: 115px" id="csn" name="csn"
                                       data-options="editable:true,validType:['numberFc']"/>FC
                            </td>
                            <td>
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                <input class="easyui-datebox" style="width: 115px" id="deadline" name="deadline"
                                       data-options="editable:false"/>日历
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                            </td>
                            <td>
                                <div style="float:left;margin:5px;" id="firstDiv">
                                    <input type="checkbox" id="first" name="contrastPrinciple" data-options="" value="FIRST" onclick="firstOn(this)"/>FIRST&nbsp;&nbsp;&nbsp;&nbsp;
                                </div>
                                <div style="float:left;margin:5px;" id="lastDiv">
                                    <input type="checkbox" id="last" name="contrastPrinciple" data-options="" value="LAST" onclick="lastOn(this)"/>LAST&nbsp;&nbsp;
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </form>
    </div>
    <div id="ps2Div" name="ps2Div" class="easyui-panel" title="航材列表" style="width: 980px;height:350px;padding:10px; ">
        <table border="0" cellpadding="0" cellspacing="0" style="width: 100%;">
            <tr>
                <td style="text-align: right; width: 130px; margin-left: 5px">
                    <input class="btn btn-primary" id="saveHc" type="button" onclick="openDetaiHc('add')" value="增加"
                           style="width: 50px;margin:5px;"/>
                </td>
            </tr>
        </table>
        <table id="hc" style="width: 950px;height: 350px;padding:10px;"></table>
    </div>
    <div id="ps3Div" name="ps2Div" class="easyui-panel" title="工时信息" style="width: 980px;height:250px;padding:10px; ">
        <table border="0" cellpadding="0" cellspacing="0" style="width: 100%;">
            <tr>
                <td style="text-align: right; width: 130px; margin-left: 5px">
                    <input class="btn btn-primary" id="saveGs" type="button" onclick="addGs()" value="增加"
                           style="width: 50px;margin:5px;"/>
                </td>
            </tr>
        </table>
        <table id="gs" style="width: 950px;padding:10px;"></table>
    </div>
    <div id="ps4Div" name="ps4Div" class="easyui-panel" title="执行方式" style="width: 980px;height:200px;padding:10px; ">
        <table border="0" cellpadding="0" cellspacing="0" style="width: 100%;">
            <tr>
                <td style="text-align: right; width: 130px; margin-left: 5px">
                    <input class="btn btn-primary" id="saveJc" type="button" onclick="openDetaiJc('add')" value="增加"
                           style="width: 50px;margin:5px;"/>
                </td>
            </tr>
        </table>
        <table id="jc" style="width: 950px;padding:10px;"></table>
    </div>
    <div id="ps5Div" name="ps5Div" class="easyui-panel" title="附加执行工卡" style="width: 980px;height:350px;padding:10px; ">
        <table border="0" cellpadding="0" cellspacing="0" style="width: 100%;">
            <tr>
                <td style="text-align: right; width: 130px; margin-left: 5px">
                    <input class="btn btn-primary" id="saveJcAdd" type="button" onclick="openDetaiJcAdd('add')" value="增加"
                           style="width: 50px;margin:5px;"/>
                </td>
            </tr>
        </table>
        <table id="jcAdd" style="width: 950px;padding:10px;"></table>
    </div>

</div>

<!--<div id="mm2" style="z-index: 9999; position: fixed ! important; left: 10px; top: 200px;">
    <div id="mm1" class=" menu-top menu" style="width: 114px;  display: block; z-index: 110005;">
        <div class="menu-item" data-id="p0" onclick="goToFunc('p0')" style="height: 20px;">
            <div class="menu-text" style="height: 20px; line-height: 20px;">基本信息</div>
        </div>
    </div>
</div>-->

</body>
<!-- 配置文件 -->
<script type="text/javascript" src="/js/ueditor/ueditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script type="text/javascript" src="/js/ueditor/ueditor.all.min.js"></script>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
var param;
var operation;
var pkid;
var eroFlag;
var PAGE_DATA = [];
var eoMhourCoeff;
var accountId;
var eoNoCount; //EO号的个数
function i18nCallBack() {
    param = getParentParam_();
    operation = param.operation;
    pkid = param.pkid;
    eroFlag = param.eroFlag;
    if(!pkid){
        pkid = -1;
    }
    if (param.isFlow) {
        $("#issueCheckid").hide();
        $("#tranEoid").hide();
        //$("#delayid").hide();
        accountId = param.accountId;
    }else{
        if (eroFlag == 'EOJC' || eroFlag == 'EAJC') {
            accountId = param.userLogin;
        } else {
            accountId = getLoginInfo().accountId;
        }
    }
    if('view' == operation){
        $('.btn-primary').attr('disabled', true);
        $('#pdfBtn').attr('disabled', false);
    }
    InitFuncCodeRequest_({
        data: {
            domainCode: "EM_EA_ERO_APPLYMODEL,EMTB_ATA,EM_EA_SORT_ERO,EM_EA_ERO_PLAN,EM_EA_ERO_REPLACE_TYPE,EM_EA_ERO_REMOVE_DEAL," +
                "EM_EA_ERO_POSITION_A,EM_EA_ERO_POSITION_B,EM_EA_ERO_POSITION_C,EM_EA_ERO_POSITION_D," +
                "EM_EA_ERO_POSITION_E,EM_EA_ERO_POSITION_F,EM_EA_ERO_POSITION_G,EM_EA_WRITE_MAN,EM_EA_QUA_MAN,YESORNO,EM_EO_STATUS,"+
                "TD_JC_MATER_SORT,QUANTITY_IF_DEMAND,QUANTITY_IF_DEMAND,TD_JC_MATER_MA_UNS_UNIT,TD_JC_STATUS,EM_EA_ERO_EXE_OBJ,EM_EO_COEFFICIENT_VALUE,DA_ACREG_MAN_ACNO",
            FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
        },async:false,
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                //机型
                $('#applyModel').combobox({
                    panelHeight: 'auto',
                    data: jdata.data.EM_EA_ERO_APPLYMODEL,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    onChange: function (newValue, oldValue) {
                        if(operation == 'add'){
                            setAcnos(newValue);
                        }
                        var eaSort = $('#eaSort').combobox('getValue');
                        setPosition(newValue, eaSort, jdata.data);
                    }
                });

                //章节
                $('#ata').combobox({
                    panelHeight: '100px',
                    data: jdata.data.EMTB_ATA,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });
                //EA类别
                $('#eaSort').combobox({
                    panelHeight: 'auto',
                    data: jdata.data.EM_EA_SORT_ERO,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    onChange: function (newValue, oldValue) {
                        var applyModel = $('#applyModel').combobox('getValue');
                        setPosition(applyModel, newValue, jdata.data);
                        clearPnSn();
                    },
                    onSelect: function (item) {
                        var newValue = item.VALUE;
                        if(newValue == 'APUG' || newValue == 'ERO'){
                            MsgAlert({content: "该类别只能发动机管理换发计划模块下发！", type: 'warn'});
                            $('#eaSort').combobox('setValue','');
                            return;
                        }
                    }
                });

                //计划属性
                $('#planAttri').combobox({
                    panelHeight: '100px',
                    data: jdata.data.EM_EA_ERO_PLAN,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });

                //拆换类别
                $('#replacementType').combobox({
                    panelHeight: '100px',
                    data: jdata.data.EM_EA_ERO_REPLACE_TYPE,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });

                //拆下处置方式
                $('#removeDeal').combobox({
                    panelHeight: 'auto',
                    data: jdata.data.EM_EA_ERO_REMOVE_DEAL,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    onChange: function (newValue, oldValue) {
                        if('QT' == newValue){
                            $('#removeDealDes').textbox({required:true, editable:true,onlyview: false});
                        }else{
                            $('#removeDealDes').textbox('setValue', '');
                            $('#removeDealDes').textbox({required:false, editable:false,onlyview:true});
                        }
                    }
                });
                // 状态status
                /*$('#status').combobox({
                    panelHeight: '100px',
                    data: jdata.data.EM_EO_STATUS,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    value: '00'
                });*/

                $('#writeMan').combobox({
                    panelHeight: '140px',
                    data: jdata.data.EM_EA_WRITE_MAN,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    value : name
                });

                $('#quaMan').combobox({
                    panelHeight: '140px',
                    data: jdata.data.EM_EA_QUA_MAN,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                });

                $('#ifEvaProduce').combobox({
                    panelHeight: '140px',
                    data: jdata.data.YESORNO,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                });
                if (jdata.data && jdata.data.EM_EO_COEFFICIENT_VALUE && jdata.data.EM_EO_COEFFICIENT_VALUE.length != 0) {
                    eoMhourCoeff = jdata.data.EM_EO_COEFFICIENT_VALUE[0].TEXT;
                } else {
                    eoMhourCoeff = 1
                }
                PAGE_DATA['status'] = DomainCodeToMap_(jdata.data["EM_EO_STATUS"]);
                PAGE_DATA['yesorno'] = DomainCodeToMap_(jdata.data["YESORNO"]);
                PAGE_DATA['TD_JC_MATER_SORT'] = DomainCodeToMap_(jdata.data["TD_JC_MATER_SORT"]);
                PAGE_DATA['QUANTITY_IF_DEMAND'] = DomainCodeToMap_(jdata.data["QUANTITY_IF_DEMAND"]);
                PAGE_DATA['TD_JC_MATER_MA_UNS_UNIT'] = DomainCodeToMap_(jdata.data["TD_JC_MATER_MA_UNS_UNIT"]);
                PAGE_DATA['TD_JC_STATUS'] = DomainCodeToMap_(jdata.data["TD_JC_STATUS"]);
                PAGE_DATA['EM_EA_ERO_EXE_OBJ'] = DomainCodeToMap_(jdata.data["EM_EA_ERO_EXE_OBJ"]);

                InitDataGridHc(pkid);
                InitDataGridGs(pkid);
                InitDataGridJc(pkid);
                InitDataGridJcAdd(pkid);
                if(pkid != -1){
                    InitDataForm(pkid, jdata.data);
                }

            } else {
                MsgAlert({content: jdata.msg, type: 'error'});
            }
        }
    });
}

/**
 * 初始化数据
 * @param pkid
 * @constructor
 */
function InitDataForm(pkid, data) {
    InitFuncCodeRequest_({
        async: false,
        data: {pkid: pkid, FunctionCode: "EM_EO_PKID"}, successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                inputInit();
                ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                setAcnos(jdata.data.APPLY_MODEL);
                setPosition(jdata.data.APPLY_MODEL, jdata.data.EA_SORT, data);
                eoCounut(pkid);
                //改版后机号和EA类别不可编辑
                if (eoNoCount > 1) {
                    $('#acid').combobox({onlyview: true, editable: false, value:jdata.data.ACID});
                    $('#eaSort').combobox({onlyview: true, editable: false, value: jdata.data.EA_SORT});
                }
                $('#position').combobox('setValue', jdata.data.POSITION);
                $('#removeSn').textbox('setValue', jdata.data.REMOVE_SN);
                $('#removePn').textbox('setValue', jdata.data.REMOVE_PN);
                $('#installPn').textbox('setValue', jdata.data.INSTALL_PN);
                $('#installSn').textbox('setValue', jdata.data.INSTALL_SN);
                $('#acid').combobox('setValue', jdata.data.ACID);
                //oriApplyType = $("#applyType").combobox("getValue");
                /*$(":radio").each(function () {
                    let radioName = $(this).attr('name').toUpperCase();
                    let num = jdata.data[radioName];
                    $("input[name='" + $(this).attr('name') + "']").eq(num).attr('checked', 'true');
                    if ($(this).attr('name') == "srefit") {
                        if (num !== null && num !== undefined) {
                            let input = $('input[name="sremodel"]');
                            input.attr("disabled", false);
                        }
                    }
                });*/
                $(":checkbox").each(function () {
                    /*if($(this).attr('name') != 'mark'){
                        var radioName = toLine($(this).attr('name')).toUpperCase();
                        var num = jdata.data[radioName];
                        $(this).prop("checked", num == "Y" ? true : false);
                    }*/
                    if($(this).attr('name') == 'mark'){
                        var str = jdata.data.MARK;
                        if(str){
                            $(str.split(",")).each(function (i,dom){
                                $(":checkbox[value='"+dom+"']").prop("checked",true);
                            });
                        }
                    }
                    if($(this).attr('name') == 'contrastPrinciple'){
                        var str1 = jdata.data.CONTRAST_PRINCIPLE;
                        if(str1){
                            $(str1.split(",")).each(function (i,dom){
                                $(":checkbox[value='"+dom+"']").prop("checked",true);
                            });
                        }
                    }

                });

                if (jdata.data.STATUS) {
                    $('#statusTab').html(PAGE_DATA['status'][jdata.data.STATUS]);
                }

                /*checkIsReject(pkid);
                if(isReject > 0 && !param.isFlow){
                    $('#reject').show();
                }*/
                $('#oldEoNo').text(jdata.data.OLD_EO_NO);
            } else {
                MsgAlert({content: jdata.msg.replace("msg_err:", ""), type: 'error'});
            }
        }
    });
}

//航材列表
function InitDataGridHc(pkid) {
    $("#hc").MyDataGrid({
        identity: 'hc',
        sortable: true,
        singleSelect: true,
        pagination: false,
        fit: false,
        resize: function () {
            return {width: '100%', height: 260};
        },
        queryParams: {eoPkid: pkid},
        columns: {
            param: {FunctionCode: "EM_EA_ERO_MATERIAL_TOOL_LIST"},
            alter: {
                MT_TYPE: {
                    formatter: function (value) {
                        return PAGE_DATA['TD_JC_MATER_SORT'][value];
                    }
                },
                WORK_DEPENDS: {
                    formatter: function (value) {
                        return PAGE_DATA['QUANTITY_IF_DEMAND'][value];
                    }
                },
                UNIT: {
                    formatter: function (value) {
                        return PAGE_DATA['TD_JC_MATER_MA_UNS_UNIT'][value];
                    }
                },
                QTY_DEMAND: {
                    formatter: function (value) {
                        return PAGE_DATA['QUANTITY_IF_DEMAND'][value];
                    }
                }
            }
        },
        contextMenus: [
            {
                id: "m-edit", i18nText: "编辑", auth: "",
                onclick: function () {
                    var rowData = getDG('hc').datagrid('getSelected');
                    if (!rowData.PKID) {
                        MsgAlert({content: "请选择数据！", type: 'error'});
                        return;
                    }
                    openDetaiHc('edit', pkid, rowData.PKID);
                }
            },

            {
                id: "m-edit", i18nText: "删除", auth: "",
                onclick: function () {
                    var rowData = getDG('hc').datagrid('getSelected');
                    if (!rowData.PKID) {
                        MsgAlert({content: "请选择数据！", type: 'error'});
                        return;
                    }
                    if(!confirm("确定删除数据")){
                        return;
                    }

                    InitFuncCodeRequest_({
                        async : false,
                        data: {pkid: rowData.PKID, FunctionCode: "EM_EO_MATERIAL_TOOL_DEL"},
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                InitDataGridHc(pkid);
                            } else {
                                MsgAlert({content: jdata.msg, type: 'error'});
                            }
                        }
                    });
                }
            }
        ],
        validAuth: function (row, items) {
            if (operation == 'view') {
                items['编辑'].display = false;
                items['删除'].display = false;
            }
            return items;
        },
        onLoadSuccess: function () {

        },
        onClickRow: function (rowIndex, rowData) {
        },
        onDblClickRow: function (index, field, value) {
            var rowData = getDG('hc').datagrid('getSelected');
            if (!rowData.PKID) {
                MsgAlert({content: "请选择数据！", type: 'error'});
                return;
            }
            flag = "V";
            //openDetaiHc('view', rowData.PKID);

        }
    });
}

//工时信息
function InitDataGridGs(pkid) {
    $("#gs").MyDataGrid({
        identity: 'gs',
        enableLineEdit:true,
        sortable: true,
        singleSelect: true,
        pagination: false,
        fit: false,
        resize: function () {
            return {width: '100%', height: 150};
        },
        queryParams: {eoPkid: pkid},
        columns: {
            param: {FunctionCode: "EM_EA_ERO_MAN_HOUR_LIST"},
            alter: {
                THEORY_MAN_HOUR: {
                    editor: {type: 'numberbox', options: {required: true,min:0,precision:2}}
                }
            }

        },
        contextMenus: [
            {
                id: "m-delete1", i18nText: "删除",
                onclick: function () {
                    var rowData = $("#gs").datagrid('getSelected');
                    if (!rowData.PKID) {
                        MsgAlert({content: '请选择数据',type:'error'});
                        return;
                    }
                    common_delete_({
                        identity: 'gs',
                        cfmI18next: "确认删除吗",
                        param: {data: {pkid: rowData.PKID}},
                        FunctionCode: "EM_EO_MAN_HOUR_DEL"
                    })
                }
            }
        ],
        onEndEdit: function(index, row, changes){
            var data = [];
            var theoryManHour = row.THEORY_MAN_HOUR;
            var standardManHour = theoryManHour * eoMhourCoeff;
            var eoPkid = $('#pkid').val();
            data['pkid'] = row.PKID;
            data['eoPkid'] = eoPkid;
            data['theoryManHour'] = theoryManHour;
            data['standardManHour'] = standardManHour;
            data = $.extend({}, data, {FunctionCode: 'EM_EO_MAN_HOUR_ADD'});
            InitFuncCodeRequest_({
                data: data,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        InitDataGridGs(eoPkid);
                    }else{
                        InitDataGridGs(eoPkid);
                        MsgAlert({content:jdata.msg.substring(8),type:'error'});
                    }
                }
            });
        },
        validAuth: function (row, items) {
            if (operation == 'view') {
                items['删除'].display = false;
            }
            return items;
        },
        onLoadSuccess: function () {

        },
        onClickRow: function (rowIndex, rowData) {
        },
        onDblClickRow: function (index, field, value) {
            var rowData = getDG('dg').datagrid('getSelected');
            if (!rowData.PKID) {
                MsgAlert({content: "请选择数据！", type: 'error'});
                return;
            }
            flag = "V";
            //openDetai('view', rowData.PKID);
        }
    });
}

//执行方式
function InitDataGridJc(pkid) {
    $("#jc").MyDataGrid({
        identity: 'jc',
        sortable: true,
        singleSelect: true,
        pagination: false,
        fit: false,
        resize: function () {
            return {width: '100%', height: 100};
        },
        queryParams: {eoPkid : pkid},
        columns: {
            param: {FunctionCode: "EM_EA_ERO_JC_RELATE_LIST"},
            alter: {
                STATUS: {
                    formatter: function (value) {
                        return PAGE_DATA['TD_JC_STATUS'][value];
                    }
                }
            }
        },
        validAuth: function (row, items) {
            if (operation == 'view') {
                items['编辑'].display = false;
                items['删除'].display = false;
            }
            return items;
        },
        onLoadSuccess: function () {

        },
        onClickRow: function (rowIndex, rowData) {
        },
        onDblClickRow: function (index, field, value) {
            var rowData = getDG('dg').datagrid('getSelected');
            if (!rowData.PKID) {
                MsgAlert({content: "请选择数据！", type: 'error'});
                return;
            }
            flag = "V";
            //openDetai('view', rowData.PKID);

        }
    });
}

//附加执行工卡
function InitDataGridJcAdd(pkid) {
    $("#jcAdd").MyDataGrid({
        identity: 'jcAdd',
        sortable: true,
        singleSelect: true,
        pagination: false,
        fit: false,
        resize: function () {
            return {width: '100%', height: 200};
        },
        queryParams: {eoPkid: pkid},

        columns: {
            param: {FunctionCode: "EM_EA_ERO_ADD_JC_RELATE_LIST"},
            alter: {
                EXE_OBJ: {
                    formatter: function (value) {
                        return PAGE_DATA['EM_EA_ERO_EXE_OBJ'][value];
                    }
                }
            }
        },
        contextMenus: [
            {
                id: "m-edit", i18nText: "编辑", auth: "",
                onclick: function () {
                    var rowData = getDG('jcAdd').datagrid('getSelected');
                    if (!rowData.PKID) {
                        MsgAlert({content: "请选择数据！", type: 'error'});
                        return;
                    }
                    openDetaiJcAdd('edit', pkid, rowData.PKID);
                }
            },

            {
                id: "m-edit", i18nText: "删除", auth: "",
                onclick: function () {
                    var rowData = getDG('jcAdd').datagrid('getSelected');
                    if (!rowData.PKID) {
                        MsgAlert({content: "请选择数据！", type: 'error'});
                        return;
                    }
                    if(!confirm("确定删除数据")){
                        return;
                    }

                    InitFuncCodeRequest_({
                        async : false,
                        data: {pkid: rowData.PKID, FunctionCode: "EM_EO_JC_RELATE_DEL"},
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                InitDataGridJcAdd(pkid);
                            } else {
                                MsgAlert({content: jdata.msg, type: 'error'});
                            }
                        }
                    });
                }
            }
        ],
        validAuth: function (row, items) {
            if (operation == 'view') {
                items['编辑'].display = false;
                items['删除'].display = false;
            }
            return items;
        },
        onLoadSuccess: function () {

        },
        onClickRow: function (rowIndex, rowData) {
        },
        onDblClickRow: function (index, field, value) {
            var rowData = getDG('dg').datagrid('getSelected');
            if (!rowData.PKID) {
                MsgAlert({content: "请选择数据！", type: 'error'});
                return;
            }
            flag = "V";
            //openDetai('view', rowData.PKID);

        }
    });
}

//根据适用型号查询机号
function setAcnos(applyModel){
    var datas2 = $.extend({actype: applyModel}, {FunctionCode: 'SELECT_ACNO_BY_ACTYPE_ERO'});
    InitFuncCodeRequest_({
        async: false,
        data: datas2, successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                $('#acid').combobox({
                    panelHeight: '150px',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data
                });
            } else {
                MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
            }
        }
    });
}

function setPosition(applyModel, eaSort,data){
    $('#position').combobox('clear');
    if(applyModel && eaSort){
        if(eaSort == 'ERO'){
            if(applyModel == 'B747'){
                $('#position').combobox({
                    panelHeight: 'auto',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data:data.EM_EA_ERO_POSITION_A
                });
            }
            if(applyModel == 'B737' || applyModel == 'B757' || applyModel == 'B767'){
                $('#position').combobox({
                    panelHeight: 'auto',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data:data.EM_EA_ERO_POSITION_B
                });
            }
        }
        if(eaSort == 'APUG'){
            $('#position').combobox({
                panelHeight: 'auto',
                valueField: 'VALUE',
                textField: 'TEXT',
                data:data.EM_EA_ERO_POSITION_C
            });
        }
        if(eaSort == 'QLJG'){
            if(applyModel == 'B747'){
                $('#position').combobox({
                    panelHeight: 'auto',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data:data.EM_EA_ERO_POSITION_D
                });
            }
            if(applyModel == 'B737' || applyModel == 'B757' || applyModel == 'B767'){
                $('#position').combobox({
                    panelHeight: 'auto',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data:data.EM_EA_ERO_POSITION_E
                });
            }
        }

        if(eaSort == 'REVERSERG'){
            if(applyModel == 'B747'){
                $('#position').combobox({
                    panelHeight: 'auto',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data:data.EM_EA_ERO_POSITION_F
                });
            }
            if(applyModel == 'B737' || applyModel == 'B757' || applyModel == 'B767'){
                $('#position').combobox({
                    panelHeight: 'auto',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data:data.EM_EA_ERO_POSITION_G
                });
            }
        }

    }
}

// 保存
function save() {
    var isValidate = $("#mform").form('validate');
    if (!isValidate) return;

    var $form = $("#mform");
    var datas = $form.serializeObject();
    if (Array.isArray(datas['ata'])) {
        datas['ata'] = datas['ata'].join(',');
    }

    //拆下装上件序号校验
    var replacementType = $('#replacementType').combobox('getValue');
    var removeSn = $('#removeSn').textbox('getValue');
    var installSn = $('#installSn').textbox('getValue');
    if(replacementType == 'REPLACE'){//仅拆下
        if(!removeSn){
            MsgAlert({content: '拆换类型为仅拆下，请选择拆下件序号', type: 'error'});
            return;
        }
        if(installSn){
            MsgAlert({content: '拆换类型为仅拆下，不能存在装上件序号', type: 'error'});
            return;
        }
    }else if(replacementType == 'INSTALL'){//仅装上
        if(!installSn){
            MsgAlert({content: '拆换类型为仅装上，请选择装上件序号', type: 'error'});
            return;
        }
        if(removeSn){
            MsgAlert({content: '拆换类型为仅装上，不能存在拆下件序号', type: 'error'});
            return;
        }
    }else{//装上和拆下
        if(!removeSn || !installSn){
            MsgAlert({content: '拆换类型为拆下装上，请选择拆下和装上件序号', type: 'error'});
            return;
        }
    }

    var installPn = $('#installPn').textbox('getValue');
    //var installSn = $('#installSn').textbox('getValue');
    var removePn = $('#removePn').textbox('getValue');
    //var removeSn = $('#removeSn').textbox('getValue');
    if(replacementType == 'REP_IN' && installPn == removePn && installSn == removeSn){
        MsgAlert({content: '拆下件序号不能和装上件序号相同', type: 'error'});
        return;
    }

    //时限校验
    var tsn = $('#tsn').textbox('getValue');
    var csn = $('#csn').textbox('getValue');
    var deadline = $('#deadline').datebox('getValue');
    var isFirst = $('#first').is(':checked');
    var isLast = $('#last').is(':checked');
    if(!tsn && !csn && !deadline){
        MsgAlert({content: '至少填写一个时限', type: 'error'});
        return;
    }else{
        if((tsn && !csn && !deadline) || (!tsn && csn && !deadline)||
            (!tsn && !csn && deadline)){ //只选择了一个时限，则原则不不能选择
            if(isFirst || isLast){
                MsgAlert({content: '只有一个时限，不需要选择原则', type: 'error'});
                return;
            }
        }else{
            if(!isFirst && !isLast){
                MsgAlert({content: '多个时限，需要选择一组原则', type: 'error'});
                return;
            }
        }
    }


    //mark标识
    var mark_value =[];
    $('input[name="mark"]:checked').each(function(){
        mark_value.push($(this).val());
    });
    if(mark_value.length != 0){
        datas['mark'] = mark_value.join(',');
    }


    var contrastPrinciple_value = [];
    $('input[name="contrastPrinciple"]:checked').each(function(){
        contrastPrinciple_value.push($(this).val());
    });
    if(contrastPrinciple_value.length != 0){
        datas['contrastPrinciple'] = contrastPrinciple_value.join(',');
    }


    var radis = {};
    $(":radio").each(function () {
        var radioName = $(this).attr('name');
        radis[radioName] = $("input[name='" + radioName + "']:checked").val();
    });

    datas.applyType = 'APL';
    var addFlag = false;
    if ("add" == operation) {
        datas.eoVer = 0;
        datas.eoNo = randomNumber(datas.applyType, datas.applyModel);
        datas.status = "00"
    }else{
        datas.eoNo = $('#eoNo').textbox('getValue');
    }
    ///
    var isDm = $('#dm').is(':checked');
    var isIfsd = $('#ifsd').is(':checked');
    var eojcNo = $("#eojcNo").textbox('getValue');
    if (!isDm && !isIfsd && eojcNo) {
        MsgAlert({content: '请选中MARK中的DM或IFSD，或删除关联工卡数据', type: 'error'});
        return;
    }
    if ((isDm || isIfsd) && !eojcNo) {
        MsgAlert({content: '已请选中MARK中的DM或IFSD，请关联工卡', type: 'error'});
        return;
    }
    if (eojcNo) {
        datas.eojcNo = eojcNo;
    }
    ////
    datas.eoEa = "EA";
    datas.applyModel = $('#applyModel').combobox('getValue');
    datas = $.extend({msgData: param.msgData, msgpkid: param.msgpkid},
        datas, radis, {FunctionCode: 'EM_EO_ADD'});
    InitFuncCodeRequest_({
        async: false,
        data: datas, successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                if (param.OWindow && param.OWindow.onSearch_) {
                    param.OWindow.onSearch_('dg', '#ffSearch');
                }
                // param.OWindow.MsgAlert({content: jdata.msg.replace("msg_err:", "") ? jdata.msg.replace("msg_err:", "") : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                MsgAlert({content: jdata.msg.replace("msg_err:", "") ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                mpkid = jdata.data.pkid;
                if (operation == "add") {
                    $("#pkid").val(mpkid);
                    $("#writeManId").val(jdata.data.writeManId);
                    //$("#applyType").attr("disabled", true);
                    $("#eoNo").textbox('setValue', jdata.data.eoNo);
                    $("#eoVer").textbox('setValue', '0');
                }
                inputInit();
                operation = "edit";

                $('#applyModel').combobox('setValue', jdata.data.applyModel);
                $('#ata').combobox('setValue', jdata.data.ata);
                $('#acid').combobox('setValue', jdata.data.acid);
                $('#position').combobox('setValue', jdata.data.position);
                pkid = mpkid;
                /*if (msgData) {
                    param.OWindow.reloadTodo();
                }*/
                InitDataGridJc(pkid);
            } else {
                MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
            }
        }
    });
}

//添加航材
function  openDetaiHc(operation, eoPkid, hcPkid) {
    if(operation == 'add'){
        eoPkid = pkid;
    }
    if(!eoPkid || eoPkid == -1){
        MsgAlert({content: '请先保存数据', type: 'error'});
        return
    }
    var title_ = $.i18n.t('ERO航材');
    ShowWindowIframe({
        width: "1248",
        height: "720",
        title: title_,
        param: {operation: operation, eoPkid: eoPkid, pkid: hcPkid},
        url: "/views/em/emea/ero/EmEroMaterialToolEdit.shtml"
    });
}

//添加执行方式
//打开添加工卡页面
function openDetaiJc(operation) {
    if (!pkid || pkid == -1) {
        MsgAlert({content: '请先保存EO基本信息', type: 'error'});
        return;
    }

    var datas = {eoPkid: pkid, jcType: "EAJC", FunctionCode: 'EM_EO_JC_RELATE_CONUT'};
    InitFuncCodeRequest_({
        async: false,
        data: datas,
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                if (jdata.data.NUMB > 0) {
                    MsgAlert({content: "已存在EAJC，请不要重复添加", type: "error"});
                } else {
                    var applyModel = $('#applyModel').combobox('getValue');
                    var eoNo = $('#eoNo').textbox('getValue');
                    var title_ = $.i18n.t('EA工卡');
                    ShowWindowIframe({
                        width: "800",
                        height: "400",
                        title: title_,
                        param: {
                            operation: operation,
                            applyModel: applyModel,
                            eoNo: eoNo,
                            pkid: pkid,
                            eoPkid: pkid,
                            applyType: 'APL'
                        },
                        url: ""
                    });
                }
            } else {
                MsgAlert({content: jdata.msg, type: "error"});
            }
        }
    })

}

//添加附加执行工卡
function openDetaiJcAdd(operation, eoPkid, jcAddPkid) {
    if(operation == 'add'){
        eoPkid = pkid;
    }
    if(!eoPkid || eoPkid == -1){
        MsgAlert({content: '请先保存数据', type: 'error'});
        return
    }
    var title_ = $.i18n.t('ERO航材');
    ShowWindowIframe({
        width: "1248",
        height: "720",
        title: title_,
        param: {operation: operation, eoPkid: eoPkid, pkid: jcAddPkid},
        url: "/views/em/emea/ero/EmEroJcRelateNrcList.shtml"
    });
}

//增加行
function addGs() {
    var eoPkid;
    if(operation == 'add'){
        eoPkid = pkid;
    }else{
        eoPkid = $('#pkid').val();
    }
    if(!eoPkid || eoPkid == -1){
        MsgAlert({content: '请先保存数据', type: 'error'});
        return;
    }
    var rows = $('#gs').datagrid('getRows');
    if(rows.length != 0){
        MsgAlert({content: '只能有一组工时', type: 'error'});
        return;
    }
    $('#gs').datagrid('appendRow', {});
}

//打印
function print() {
    if (!pkid || pkid == -1) {
        MsgAlert({content: "请先保存", type: 'error'});
        return;
    }
    ajaxLoading();
    InitFuncCodeRequest_({
        data: {pkid: pkid, FunctionCode: 'EM_EO_PRINT'},
        successCallBack: function (jdata) {
            ajaxLoadEnd();
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                var urls = jdata.data;
                if (urls.indexOf(":") != -1) {
                    urls = urls.substring(urls.indexOf(":") + 1).replace("//", "/");
                }
                jcPreview(urls);
            } else {
                MsgAlert({content: jdata.msg, type: "error"});
            }
        }
    });
}

//转发
function tranEo() {
    if (operation == "add") {
        MsgAlert({content: "请先保存"});
        return;
    }
    var evaId = $("#writeManId").val();
    var traFlag = "Y";//任务页面进行的转发，第二次转发
    ShowWindowIframe({
        width: 450,
        height: 150,
        title: "转发",
        param: {accId: evaId, pkid: pkid, traFlag: traFlag, msgpkid: param.msgpkid},
        url: '/views/em/emeo/emEo_filetrans.shtml'
    });
}

//EO驳回
function rejectEo(){
    ShowWindowIframe({
        width: "450",
        height: "200",
        param: {
            eoPkid: pkid
        },
        url: "/views/em/emeo/em_eo_reject.shtml"
    });
}

/**
 * 提交
 */
function issueCheck() {
    if (!pkid || pkid == -1) {
        MsgAlert({content: "请先保存数据", type:'error'});
        return;
    }

    var isValidate = $("#mform").form('validate');
    if (!isValidate) {
        MsgAlert({content: '请完整填写页面必填内容保存后再进行该操作', type: 'error'});
        return;
    }

    //拆下装上件序号校验
    var replacementType = $('#replacementType').combobox('getValue');
    var removeSn = $('#removeSn').textbox('getValue');
    var installSn = $('#installSn').textbox('getValue');
    if(replacementType == 'REPLACE'){//仅拆下
        if(!removeSn){
            MsgAlert({content: '拆换类型为仅拆下，请选择拆下件序号', type: 'error'});
            return;
        }
        if(installSn){
            MsgAlert({content: '拆换类型为仅拆下，不能存在装上件序号', type: 'error'});
            return;
        }
    }else if(replacementType == 'INSTALL'){//仅装上
        if(!installSn){
            MsgAlert({content: '拆换类型为仅装上，请选择装上件序号', type: 'error'});
            return;
        }
        if(removeSn){
            MsgAlert({content: '拆换类型为仅装上，不能存在拆下件序号', type: 'error'});
            return;
        }
    }else{//装上和拆下
        if(!removeSn || !installSn){
            MsgAlert({content: '拆换类型为拆下装上，请选择拆下和装上件序号', type: 'error'});
            return;
        }
    }

    var installPn = $('#installPn').textbox('getValue');
    //var installSn = $('#installSn').textbox('getValue');
    var removePn = $('#removePn').textbox('getValue');
    //var removeSn = $('#removeSn').textbox('getValue');
    if(replacementType == 'REP_IN' && installPn == removePn && installSn == removeSn){
        MsgAlert({content: '拆下件序号不能和装上件序号相同', type: 'error'});
        return;
    }

    //时限校验
    var tsn = $('#tsn').textbox('getValue');
    var csn = $('#csn').textbox('getValue');
    var deadline = $('#deadline').datebox('getValue');
    var isFirst = $('#first').is(':checked');
    var isLast = $('#last').is(':checked');
    if(!tsn && !csn && !deadline){
        MsgAlert({content: '至少填写一个时限', type: 'error'});
        return;
    }else{
        if((tsn && !csn && !deadline) || (!tsn && csn && !deadline)||
            (!tsn && !csn && deadline)){ //只选择了一个时限，则原则不不能选择
            if(isFirst || isLast){
                MsgAlert({content: '只有一个时限，不需要选择原则', type: 'error'});
                return;
            }
        }else{
            if(!isFirst && !isLast){
                MsgAlert({content: '多个时限，需要选择一组原则', type: 'error'});
                return;
            }
        }
    }

    var $form = $("#mform");
    var datas = $form.serializeObject();
    if (Array.isArray(datas['ata'])) {
        datas['ata'] = datas['ata'].join(',');
    }
    var mark_value =[];
    $('input[name="mark"]:checked').each(function(){
        mark_value.push($(this).val());
    });
    if(mark_value.length != 0){
        datas['mark'] = mark_value.join(',');
    }
    var contrastPrinciple_value = [];
    $('input[name="contrastPrinciple"]:checked').each(function(){
        contrastPrinciple_value.push($(this).val());
    });
    if(contrastPrinciple_value.length != 0){
        datas['contrastPrinciple'] = contrastPrinciple_value.join(',');
    }


    var radis = {};
    $(":radio").each(function () {
        var radioName = $(this).attr('name');
        radis[radioName] = $("input[name='" + radioName + "']:checked").val();
    });

    datas.applyType = 'APL';
    if ("add" == operation) {
        datas.eoVer = 0;
        datas.eoNo = randomNumber(datas.applyType, datas.applyModel);
        datas.status = "00"
    }else{
        datas.eoNo = $('#eoNo').textbox('getValue');
    }
    datas.eoEa = "EA";
    datas.applyModel = $('#applyModel').combobox('getValue');

    var applyMode = $('#applyModel').combobox('getValue');
    var ata = $('#ata').combobox('getValue');
    var applyType = 'APL';
    datas = $.extend(datas, radis, {FunctionCode: 'EM_EO_STATUS'});
    InitFuncCodeRequest_({
        data: datas,
        successCallBack: function (jdata) {
            if (jdata.code != null) {
                ajaxLoading();
                var datasss = $.extend(datas, radis, {FunctionCode: 'EM_ERO_CHECKDATA', list:'N'});
                InitFuncCodeRequest_({
                    data: datasss,
                    successCallBack: function (jdata) {
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                            var model = '';
                            if(applyType != 'PART'){
                                model = applyMode;
                            }else{
                                model = 'CM';
                            }
                            checkSumitQua(model, ata);
                            if(!checkQua){
                                if(!confirm('当前用户无提资质，请选择资质人?')){
                                    ajaxLoadEnd();
                                    return;
                                }
                                chooseQua(model, ata, pkid, 'edit');
                            }else{
                                common_add_edit_({
                                    identity: '', isEdit: '', width: 520, height: 300, title: $.i18n.t('选择审批人'),
                                    param: {
                                        roleId: '',
                                        otherParam: datas.pkid,
                                        msgpkid: param.msgpkid,
                                        FunctionCode_: 'EM_EA_START',
                                        successCallback: sumbitReload
                                    },
                                    url: "/views/flow/work_flow_account_select.shtml"
                                });
                            }

                        } else {
                            hints(jdata.msgData[0]);
                        }
                        ajaxLoadEnd();

                    }
                });
            } else {
                MsgAlert({content: "该数据已被提交过了。", type: 'error'});
            }

        }
    });

}

function removePnSn() {
    var eaSort = $('#eaSort').combobox('getValue');
    if(!eaSort){
        MsgAlert({content: '请先选择EA类别', type:'error'});
        return;
    }
    var pn = $('#removePn').textbox('getValue');
    var sn = $('#removeSn').textbox('getValue');
    if(eaSort){
        if(eaSort == 'APUG'){
            eaSort = 'APU';
        }else if(eaSort == 'QLJG'){
            eaSort = 'LG'
        }else if(eaSort == 'ERO'){
            eaSort = 'ENGINE'
        }else{
            eaSort = '';
        }
    }else{
        eaSort = '';
    }
    ShowWindowIframe({
        width: "800",
        height: "500",
        param: {
            pn: pn, sn: sn, type: 'remove', eaSort: eaSort
        },
        url: "/views/em/emea/ero/EmEroPnSnList.shtml"
    });
}

function installPnSn() {
    var eaSort = $('#eaSort').combobox('getValue');
    if(!eaSort){
        MsgAlert({content: '请先选择EA类别', type:'error'});
        return;
    }
    var pn = $('#installPn').textbox('getValue');
    var sn = $('#installSn').textbox('getValue');
    if(eaSort){
        if(eaSort == 'APUG'){
            eaSort = 'APU';
        }else if(eaSort == 'QLJG'){
            eaSort = 'LG'
        }else if(eaSort == 'ERO'){
            eaSort = 'ENGINE'
        }else{
            eaSort = '';
        }
    }else{
        eaSort = '';
    }
    ShowWindowIframe({
        width: "800",
        height: "500",
        param: {
            pn: pn, sn: sn, type: 'install', eaSort: eaSort
        },
        url: "/views/em/emea/ero/EmEroPnSnList.shtml"
    });
}

function setPnSn(pn, sn, type) {
    if(type == 'install'){
        $('#installPn').textbox('setValue', pn);
        $('#installSn').textbox('setValue', sn);
    }else if(type == 'remove'){
        $('#removePn').textbox('setValue', pn);
        $('#removeSn').textbox('setValue', sn);
    }
}

function clearPnSn() {
    $('#installPn').textbox('setValue', '');
    $('#installSn').textbox('setValue', '');
    $('#removePn').textbox('setValue', '');
    $('#removeSn').textbox('setValue', '');
}

//Ero提交资质检查
function checkSumitQua(applyModel, ata) {
    InitFuncCodeRequest_({
        async : false,
        data: {FunctionCode: 'EM_EO_SUBMIT_QUA_CHECK',
            applyModel: applyModel, ata: ata, taskType:'EMFILEEVAL', divisionQua: 'QUA', accountId : accountId},
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                if(jdata.data.CHECK_COUNT && jdata.data.CHECK_COUNT > 0){
                    checkQua = true;
                }else{
                    checkQua = false;
                }
            }
            else {
                MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                checkQua = false;
            }
        }
    });
}

//选择有资质的人
function chooseQua(applyModel, ata, eoPkid, type) {
    var title_ = '资质人选择';
    ShowWindowIframe({
        width: 600,
        height: 700,
        title: title_,
        param: {applyModel: applyModel, ata: ata, taskType:'EMFILEEVAL', divisionQua: 'QUA', eoPkid: eoPkid, type: type},
        url: "/views/em/emeo/em_eo_qua_list.shtml"
    });
}

function reloadTo() {
    if (param.OWindow.reloadTodo) {
        param.OWindow.reloadTodo();
    }
    if (param.OWindow.reload_) {
        param.OWindow.reload_();
    }

}

function sumbitReload() {
    CloseWindowIframe();
    param.OWindow.reload_();
}

//FIRST和LAST互斥
function firstOn(first) {
    var isFirst = $(first).is(':checked');
    if(isFirst){
        $('#last').prop('checked', false);
    }
}

//输入框初始化 禁用
function inputInit() {
    $("#ata").combobox({editable:false, onlyview:true});
    $("#applyModel").combobox({editable:false, onlyview:true});
    $("#acid").combobox({editable: false, onlyview: true, required: false});
}

function lastOn(last) {
    var isLast = $(last).is(':checked');
    if(isLast){
        $('#first').prop('checked', false);
    }
}

function eoCounut(pkid){
    InitFuncCodeRequest_({
        async: false,
        data: {pkid: pkid, FunctionCode: 'EM_EO_NO_COUNT'},
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                eoNoCount = jdata.data.EO_NO_COUNT;
            } else {
                MsgAlert({content: jdata.msg, type: "error"});
            }

        }
    });
}

//MARK DM和IFSD互斥
function chooseDm(dm) {
    var isDm = $(dm).is(':checked');
    if(isDm){
//        $('#ifsd').prop('checked', false);
        /*$('#eojcTh').css('visibility', 'visible');
        $('#eojcTd').css('visibility', 'visible');
        $('#eojcNo').textbox('setValue', '');*/
    }
    /*else{
        $('#eojcTh').css('visibility', 'hidden');
        $('#eojcTd').css('visibility', 'hidden');
    }*/

}

function chooseIfsd(ifsd) {
    var isIfsd = $(ifsd).is(':checked');
    if(isIfsd){
//        $('#dm').prop('checked', false);
        /*$('#eojcTh').css('visibility', 'visible');
        $('#eojcTd').css('visibility', 'visible');
        $('#eojcNo').textbox('setValue', '');*/
    }/*else{
        $('#eojcTh').css('visibility', 'hidden');
        $('#eojcTd').css('visibility', 'hidden');
    }*/

}

function randomNumber(applyType, applyModel) {
    var num = 1;
    var temp = "";
    var ata = $("#ata").textbox('getValue');
    if (applyType == "APL" || applyType == "ENG") {
        //EO前缀-机型-2位章节-4位流水号
        //EO前缀-发动机型号（位数不定）-2位章节号-4位流水号
        temp = applyModel;
    } else if (applyType == "PART") {
        //EO前缀-CM-2位章节号-4位流水号
        temp = "CM";
    }

    var serialNo = "EA-" + temp + "-" + ata + "-";
    InitFuncCodeRequest_({
        data: {serialNo: serialNo, FunctionCode: "TD_EVAL_EO_BY_NO"},
        async: false,
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                if (jdata.data != null) {
                    if (jdata.data.OLDNUM) {
                        num = parseInt(jdata.data.OLDNUM, 10) + 1;
                    }
                }
            } else {
                MsgAlert({content: jdata.msg.replace("msg_err:", ""), type: 'error'});
            }
        }
    });

    num = pad(num, 4);
    serialNo = serialNo + num;
    return serialNo;
}

var pad = function () {
    var tbl = [];
    return function (num, n) {
        var len = n - num.toString().length;
        if (len <= 0) return num;
        if (!tbl[len]) tbl[len] = (new Array(len + 1)).join('0');
        return tbl[len] + num;
    }
}();

//下拉框校验
$.extend($.fn.validatebox.defaults.rules, {
    comboBoxEditvalid: { //校验下拉菜单
        validator: function (value, param) {
            var $combobox = $("#" + param[0]);
            if (value) {
                /*if ($combobox.combobox('getValue') == $combobox.combobox('getText'))
                    return false;*/
                var result = true;
                var allData = $combobox.combobox('getData');
                for(var i = 0; i< allData.length; i++){
                    if(value == allData[i].TEXT){
                        result = false;
                        break;
                    }
                }
                if(result){
                    return false;
                }else{
                    return true;
                }

            }
            return false;

        },
        message: '请选择下拉框选项，不要直接使用输入内容'
    },
    numberFc:{
        validator : function(value){
            return /^[1-9]\d*$/.test(value) && value.length <= 20;
        },
        message : '请输输入正整数'
    },
    numberFh:{
        validator : function(value){
            return value > 0 && value.length <= 20;
        },
        message : '请输输入大于0的实数'
    }
});

function checkMq() {
    var mark_value = [];
    $('input[name="mark"]:checked').each(function () {
        mark_value.push($(this).val());
    });
    var is = false;
    for (var i = 0; i < mark_value.length; i++) {
        if (mark_value[i] == 'DM' || mark_value[i] == 'IFSD') {
            is = true;
        }
    }
    if (!is) {
        MsgAlert({content: "请选择DM或IFSD", type: 'error'});
        return;
    }
    var eojcNo = $('#eojcNo').textbox('getValue');
    ShowWindowIframe({
        width: 800,
        height: 550,
        param: {eojcNo: eojcNo},
        title: "工卡选择",
        url: "/views/em/emeo/add/EmEomarkQEdit.shtml"
    });
}

function setEojcNo(eojcNo) {
    $("#eojcNo").textbox('setValue', eojcNo);
}

function jcPreview(url) {
    ShowWindowIframe({
        width: 1200,
        height: 650,
        param: {url: url},
        title: "EA预览PDF",
        url: "/views/em/emeo/emeo_add_pdf.shtml"
    });
}
</script>
</html>