<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="ws_work_flow">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
    <script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
    <title></title>
    <script id="tempCombobox" type="text/html">
        <tr>
            <th class="tdl">{{d.titleName }} ：</th>
            <td class="tdr">
                <select name="{{d.fieldName}}" class="easyui-combobox"
                        data-options="required:true, editable: false" panelHeight="120" style="width:180px">
                    {{#
                    for(var i = 0; i < d.options.length; i++){
                    }}
                    <option value="{{d.options[i]['value']}}">{{d.options[i]['text']}}</option>
                    {{# } }}
                </select>
            </td>
        </tr>
    </script>
    <script id="tempTextbox" type="text/html">
        <tr>
            <th class="tdl">{{d.titleName }} ：</th>
            <td class="tdr">
                <input name="{{d.fieldName}}" class="easyui-textbox"
                       data-options="required:true, editable: true" style="width:180px"/>
            </td>
        </tr>
    </script>
</head>
<body class="ibody">

<div id="tabs" style="width: 100%; height: 100%;">
    <div id="tab01" title="业务表单数据" style="">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
                    <div style="height: 640px;" id="pdf">

                    </div>

                    <div style="height: 640px;" id="noPdf">
                        <iframe scrolling="auto" id="iframe01" frameborder="0" src=""
                                style="width:100%;height:100%;"></iframe>
                    </div>

                    <!-- 业务数据展示 start-->
                    <input type="hidden" name="proposer" id="proposer"/>
                    <input type="hidden" id="isFirstNode" name="isFirstNode">
                    <!--<h5 style="margin-bottom: 4px;">任务数据详情：</h5>-->
                    <table class="table table-bordered table-info" style="display: none">
                        <tr>
                            <th class="tdl" style="width: 145px;">EA编号 ：</th>
                            <td class="tdr">
                                <input type="hidden" id="sentTo" name="sendTo">
                                <input class="easyui-textbox easyui-validatebox" name="eoNoR" id="eoNoR"
                                       data-options="multiline:true, onlyview: true" style="height:25px; width: 60%;"/>
                            </td>
                        </tr>
                        <tr>
                            <th class="tdl">EA名称 ：</th>
                            <td class="tdr">
                                <input class="easyui-textbox easyui-validatebox" name="titleCn" id="titleCn"
                                       data-options="multiline:true, onlyview: true" style="height:25px; width: 60%;"/>
                            </td>
                        </tr>

                    </table>
                    <!-- 业务数据展示end-->

                    <h5 style="margin-bottom: 4px;">流程处理：</h5>

                    <input name="taskId" type="hidden"/>
                    <table class="table table-bordered table-info">
                        <tbody id="custom_options"></tbody>
                    </table>
                    <table class="table table-bordered table-info" id="mtable">
                        <tr>
                            <th class="tdl"> 处理意见：</th>
                            <td class="tdr">
                                <input id="notes" class="easyui-textbox easyui-validatebox" name="notes"
                                       data-options="multiline:true, validType:['maxLength[500]'] "
                                       style="height:65px; width: 90%;"/>
                            </td>
                            <th id="dbr" class="tdl" style="width: 100px"> 下一级办理人：</th>
                            <td id="xm" colspan="8" class="tdr">
                                <!-- <input id="authId" class="easyui-textbox" name="authId"
                                        data-options="required:true,validType:['maxLength[20]']"
                                        style="height:30px; width:150px;"/>-->
                                <input id="engineerIdSp" class="easyui-textbox" name="engineerIdSp"
                                       data-options="required:true,validType:['maxLength[20]']"
                                       style="height:30px; width:150px;"/>

                            </td>

                        </tr>

                        <tr>
                            <td colspan="6" align="center">
                                <input id="canSubmit" class="btn" disabled="disabled" type="button"
                                       onclick="doSubmit();" value="提交"/>
                                <input id="canTrunTo" class="btn" disabled="disabled" type="button"
                                       onclick="doTurnTo();" value="转办"/>
                                <input id="canReturn" class="btn" disabled="disabled" type="button"
                                       onclick="doReturn();" value="退回"/>
                                <input id="view" class="btn btn-primary " style="display: none" type="button"
                                       onclick="viewDetails()"
                                       value="查看详情">
                                <input id="canTerminate" class="btn" disabled="disabled" type="button"
                                       onclick="javascript: " value="终止"/>
                                <input id="canHangUp" class="btn" disabled="disabled" type="button"
                                       onclick="javascript: " value="挂起"/>
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>
    <div title="流程信息" style="">
        <table class="table table-bordered table-info" id="processInfo">
            <tr>
                <th class="tdl" style="width: 145px;">流程业务Key ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="businessKey"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="executionName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="createTime"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程创建人 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="userName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="nodeName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
                <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="isJoint"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务-配置 ：</th>
                <td class="tdr" colspan="3" style="vertical-align: middle;">
                    <input type="checkbox" name="canReturn" value="" disabled/> 可退回
                    <input type="checkbox" name="canTrunTo" value="" disabled/> 可转办
                    <input type="checkbox" name="canTerminate" value="" disabled/> 可终止
                    <input type="checkbox" name="canHangUp" value="" disabled/> 可挂起
                </td>
            </tr>
        </table>
        <div id="workflow" style="overflow-x: scroll;"></div>
    </div>
    <div id="tab02" title="历史任务信息" style="">
        <table id="historyDg"></table>
    </div>
</div>
<script type="text/javascript" src="/js/pdfobject.js"></script>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    /**
     * 初始化流程业务处理页面
     * @param resource  业务数据
     * @param execution 流程实例数据
     * @param node 节点配置数据
     * @constructor
     */
    var resour;
    var eoPkid;
    var eaSort;
    var applyType;
    var jobCategory;
    var eoVer;
    var evalApplyType;
    var ifEvaProduce;
    var accountId = getLoginInfo().accountId;

    function InitLoadResource(resource, execution, node) {
        window.resizeTo("1280", "1200");
        resour = resource;
        eoPkid = resour.pkid;
        eaSort = resour.eaSort;
        applyType = resour.applyType;
        jobCategory = resour.jobCategory;
        eoVer = resour.eoVer;
        isEvalProduce(eoPkid, applyType);

        var roleId = queryNodeRole(eoPkid,"EM_EO").ROLE_ID;
        if(roleId == null || typeof (roleId) == 'undefined'){
            roleId = '';
        }

        ParseFormField_(resource, null, null);
        $("#eoNoR").textbox({value: resource.eoNo + "R" + resource.eoVer});
        var type = "view";

        if ('task1557466404133' == node.taskPropId) {//当前节点为退回
            type = "edit";
            if(eaSort == 'ERO' || eaSort == 'APUG' || eaSort == 'QLJG' || eaSort == 'REVERSERG'){
                $("#iframe01").attr("src", "/views/em/emea/ero/eroEdit.shtml?pkid=" + eoPkid + "&eoVer="+eoVer+
                    "&operation=" + type + "&isFlow=true"+"&accountId="+accountId);
            }else{
                $("#iframe01").attr("src", "/views/em/emea/eaEdit.shtml?pkid=" + eoPkid + "&applyType="+applyType + "&jobCategory="+ jobCategory+"&eoVer="+eoVer+
                    "&ifEvaProduce="+ifEvaProduce+"&evalApplyType="+evalApplyType+"&operation=" + type + "&isFlow=true"+"&accountId="+accountId);
            }

            $("#pdf").hide();
        } else {
            //cPdf();
            //$("#noPdf").hide();
            if(eaSort == 'ERO' || eaSort == 'APUG' || eaSort == 'QLJG' || eaSort == 'REVERSERG'){
                $("#iframe01").attr("src", "/views/em/emea/ero/eroEdit.shtml?pkid=" + eoPkid +"&eoVer="+eoVer+
                    "&operation=" + type + "&isFlow=true"+"&accountId="+accountId);
            }else{
                $("#iframe01").attr("src", "/views/em/emea/eaEdit.shtml?pkid=" + eoPkid + "&applyType="+applyType + "&jobCategory="+ jobCategory+"&eoVer="+eoVer+
                    "&ifEvaProduce="+ifEvaProduce+"&evalApplyType="+evalApplyType+"&operation=" + type + "&isFlow=true"+"&accountId="+accountId);
            }

            $("#pdf").hide();
        }
        //   $("#iframe01").attr("src", "/views/em/emea/eoEdit.shtml?pkid=" + eoPkid);
        //下个审批人选择初始化
        var selectRow;
        $("#engineerIdSp").MyComboGrid({
            idField: 'ACCOUNT_ID',  //实际选择值
            textField: 'USER_NAME', //文本显示值
            panelHeight: '180px',
            required: true,
            width: 140,
            params: {userId: accountId,roleId:roleId, FunctionCode: 'FLOW_WORK_ACCOUNT'},
            columns: [[
                {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                {field: 'USER_NAME', title: '审核人', width: 50}
            ]],
            onHidePanel: function () {
                var t = $(this).combogrid('getValue');
                if (t != null && t != '' & t != undefined) {
                    if (selectRow == null || selectRow == undefined || t != selectRow.ACCOUNT_ID) {//没有选择或者选项不相等时清除内容
                        alert('请选择，不要直接输入！');
                        $(this).combogrid({value: ''});
                    }
                }
            },
            onSelect: function (index, row) {
                selectRow = row;
                //当前在审核页面中选择下一位审核人
                if ('task1553238948041' == node.taskPropId) {//任务退回提交
                    $("#reviewedBy").val(row.ACCOUNT_ID);
                }
                else if ('task1553238924887' == node.taskPropId) {
                    $("#approvedBy").val(row.ACCOUNT_ID);
                }
                // else if('task1553239018504' == node.taskPropId){
                //     $("#checkBy").val(row.ACCOUNT_ID);
                // }
                //当在审批节点时
                if ('task1553238936318' == node.taskPropId) {
                    //判断是否提交可靠委
                    if (ifReportRe == 'Y') {
                        $("#checkBy").val(row.ACCOUNT_ID);
                    }
                }
            }
        });
        if ('task1557450296275' == node.taskPropId) {     //第一个节点
            $("#isFirstNode").val('Y');
        } else if ('task1557466404133' == node.taskPropId) {   // 任务退回节点只能提交
            $("#canReturn").hide();
            //$("#isFirstNode").val('N');
            $("#isFirstNode").val('Y');
        } else {
            //$("#isFirstNode").val('N');
            $("#isFirstNode").val('Y');
        }

        if (node.taskPropId == "task1557466404133") { //退回

            $("#canReturn").hide();

        } else if (node.taskPropId == "task1557450329906") { //审批

            $('#engineerIdSp').combobox({required: false});
            $('#engineerIdSp').hide();
            $("#dbr").hide();
            $("#xm").hide();
        } else if (node.taskPropId == "task1557450296275") { //审核

            if (eaSort != "ERO" && eaSort != "APUG" && eaSort != "QLJG" && eaSort != "REVERSERG") {
                $('#engineerIdSp').combobox({required: false});
                $('#engineerIdSp').hide();
                $("#dbr").hide();
                $("#xm").hide();
            }

        }
    }

    //生成pdf
    function cPdf() {
        ajaxLoading();
        InitFuncCodeRequest_({
            data: {pkid: eoPkid, FunctionCode: 'EM_EO_PRINT'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    let urls = jdata.data;
                    if (urls.indexOf(":") != -1) {
                        urls = urls.substring(urls.indexOf(":") + 1).replace("//", "/");
                    }
                    if (urls) {
                        urls = "http://" + window.location.host + urls;
                        var success = new PDFObject({url: urls}).embed("pdf");
                        /* PDFObject.embed(url, "#pdf");*/
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: "error"});
                }
                ajaxLoadEnd();
            }
        });
    }
    function viewDetails() {
        ShowWindowIframe({
            identity: "",
            isEdit: 1,
            width: 1260,
            height: 660,
            param: {
                pkid: eoPkid, operation: "view"
            },
            url: '/views/em/emea/eaEdit.shtml'
        });
        /* console.log(resour.pkid);
         InitFuncCodeRequest_({
             data: {SOURCE_ID: resour.pkid, CATEGORY: "EM_EO", FunctionCode: 'ATTACHMENT_RSPL_GET'},
             successCallBack: function (jdata) {
                 for (var i = 0; i < jdata.data.length; i++) {
                     downFileLocal(jdata.data[i].PKID);
                 }
             }
         });*/
    }

    function isEvalProduce(pkid, applyType) {
        InitFuncCodeRequest_({
            async: false,
            data: {eoPkid: pkid, eoEa: 'EA', applyType: applyType ,FunctionCode: 'EM_EO_EVALFILE_TYPE'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    evalApplyType = jdata.data.EVAL_COUNT;
                    if(evalApplyType == 0){
                        ifEvaProduce = 'N';
                    }else{
                        ifEvaProduce = 'Y';
                    }
                }
            }
        });
    }

</script>
</body>
</html>