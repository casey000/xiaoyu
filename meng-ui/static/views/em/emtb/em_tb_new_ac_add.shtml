<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>TB失效维护</title>
</head>

<body class="ibody">
<div id="tt" class="ibox  float-e-margins" style="width:100%; height: 380px">
    <div class="ibox-content">
        <form class="form-horizontal m-t" id="mform">
            <input type="hidden" id="pkid" name="pkid"/>

            <table class="table table-bordered table-info">
                <tr id="id_btn_row">
                    <td colspan="9" align="right">
                        <input class="btn btn-primary" type="button" id="saveBtn" onclick="save()" value="保存"/>
                        <input class="btn btn-primary" type="button" id="submitBtn" onclick="commit();" value="提交" />
                        <input class="btn btn-primary" type="button" id="closeBtn" onclick="closeW()" value="关闭"
                               style="margin-left:3px;margin-right: 18px;" />
                    </td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 80px;">评估单号：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" style="width: 150px;"
                               id="evaNo" name="evaNo" data-options="readonly:true,onlyview:true" />
                    </td>
                    <th class="th" align="right" id="fleetTh" style="width: 80px;">机队：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" style="width: 150px;"
                               id="fleet" name="fleet" data-options="readonly:true,onlyview:true" />
                    </td>
                    <th class="th" align="right" style="width: 80px;">章节：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" style="width: 150px;"
                               id="ata" name="ata" data-options="readonly:true,onlyview:true" />
                    </td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 80px;">任务类型：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" style="width: 150px;"
                               id="taskType" name="taskType" data-options="readonly:true,onlyview:true" />
                    </td>
                    <th class="th" align="right" id="msnTh" style="width: 80px;">MSN：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" style="width: 150px;"
                               id="msn" name="msn" data-options="readonly:true,onlyview:true" />
                    </td>
                    <th class="th" align="right" style="width: 80px;">状态：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" style="width: 150px;"
                               id="status" name="status" data-options="readonly:true,onlyview:true" />
                    </td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 80px;">备注：</th>
                    <td colspan="5" style="padding: 3px;">
                        <input class="easyui-textbox" style="width: 860px;height:80px"
                               id="memo" name="memo"
                               data-options="multiline:true" />
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div id='dealbtn'>
        <table style="width: 30%;float: left">
            <tr>
                <td align="right">
                    <input id="btnApp1" class="btn btn-primary" type="button" value="改版" onclick="isApp('Y')"/>&nbsp;&nbsp;
                    <input id="btnApp2" class="btn btn-primary" type="button" onclick="isApp('N')" value="无需处理"/>
                </td>
            </tr>
        </table>
        <table style="width: 67%;">
            <tr>
                <td align="right">
                    <input id="btnApp3" class="btn btn-primary" type="button" onclick="isApp('R')" value="移除"/>
                </td>
            </tr>
        </table>
    </div>
    <div id="mlayout" class="easyui-layout" style="height: 440px;">
        <div id="lay_left" data-options="region:'west',split:false" style="width: 30%;">
            <fieldset class="fieldset_eui">
                <legend>未选择TB</legend>
                <table class="table table-bordered table-info">
                    <tr>
                        <th data-i18n="" style="width:60px;" align="right">TB编号：</th>
                        <td style="width: 90px">
                            <input class="easyui-textbox" name="tbNo" id="tbNo" style="width:90px"/>
                        </td>
<!--                        <th align="right" data-i18n="" style="width:55px;">适用性：</th>-->
<!--                        <td style="width:90px">-->
<!--                            <input class="easyui-textbox" name="app" id="app" style="width:90px"/>-->
<!--                        </td>-->
                        <td>
                            <a href="javascript:void(0)" class="searchBtn" data-options="iconCls:'icon-search'"
                               onclick="searchDg1()"><span
                                    data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>
                        </td>
                    </tr>
                </table>
                <table id="dg1"></table>
            </fieldset>
        </div>
        <div id="lay_right" data-options="region:'east'" style="width: 67%">
            <fieldset class="fieldset_eui">
                <legend>已选择TB</legend>
                <table class="table table-bordered table-info">
                    <tr>
                        <th data-i18n="" style="width:65px;" align="right">处理方式：</th>
                        <td style="width: 100px">
                            <input class="easyui-combobox" name="proMode" id="proMode" style="width:100px"/>
                        </td>
<!--                        <th align="right" data-i18n="" style="width:60px;">适用性：</th>-->
<!--                        <td style="width:100px">-->
<!--                            <input class="easyui-textbox" name="app2" id="app2" style="width:100px"/>-->
<!--                        </td>-->
                        <td>
                            <a href="javascript:void(0)" class="searchBtn" data-options="iconCls:'icon-search'"
                               onclick="query2()"><span
                                    data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>
                        </td>
                    </tr>
                </table>
                <table id="dg2"></table>
            </fieldset>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var PAGE_DATA = {};
    var param;
    var op = null;// operation[add,edit,view,flow]
    var pkid = null;//主表PKID

    function i18nCallBack() {
        param = getParentParam_();
        op = param.operation;
        pkid = param.recordId;

        if (op == "view") {
            $('#saveBtn').hide();
            $('#submitBtn').hide();
            $('#btnApp1').hide();
            $('#btnApp2').hide();
            $('#btnApp3').hide();
        } else if (op == "flow" ) {
            var taskPropId = param.taskPropId;
            if (taskPropId == "taskEmAcEeeoeatb2") {
                $('#submitBtn').hide();
                $('#closeBtn').hide();
            } else {
                $('#id_btn_row').hide();
                $('#btnApp1').hide();
                $('#btnApp2').hide();
                $('#btnApp3').hide();
            }
        }

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "EM_AC_PRO_MODE_TB,EM_AC_STATUS"
            },
            async: false,
            successCallBack: function (jdata) {
                PAGE_DATA['proMode'] = DomainCodeToMap_(jdata.data.EM_AC_PRO_MODE_TB);
                $('#status').combobox({
                    data: jdata.data.EM_AC_STATUS,
                    valueField: "VALUE",
                    textField: "TEXT"
                });
                $('#proMode').combobox({
                    data: jdata.data.EM_AC_PRO_MODE_TB,
                    panelHeight: '100px',
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });
            }
        });

        InitDataForm(pkid);
        InitDataGrid1(pkid);
        InitDataGrid2(pkid);
    }

    //回填
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_AC_EEEOEATB_EVA_PKID",
                pkid: pkid
            },
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    if (jdata.data.IMP_TYPE == "ENG") {
                        $("#fleetTh").text("件号：");
                        $("#fleet").textbox("setValue", jdata.data.PART_NO);
                        $("#msnTh").text("序号：");
                        $("#msn").textbox("setValue", jdata.data.ITEM_NUM);
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function InitDataGrid1(pkid) {
        $('#dg1').MyDataGrid({
            queryParams: {
                evaPkid: pkid
            },
            columns: {
                param: {FunctionCode: "EM_AC_EEEOEATB_TB1"},
                alter: {
                    TB_NO: {
                        formatter: function (value, row) {
                            return "<a href='javascript:void(0)' onclick='openTbWeb(\"" + row.NEW_TB_PKID + "\")'>" + value + "</a>";
                        }
                    }
                }
            },
            resize: function () {
                return {width: 270, height: 382};
            }
        });
    }

    function InitDataGrid2(pkid) {
        $('#dg2').MyDataGrid({
            queryParams: {
                evaPkid: pkid
            },
            columns: {
                param: {FunctionCode: "EM_AC_EEEOEATB_TB2"},
                alter: {
                    PRO_MODE: {
                        formatter: function (value) {
                            return PAGE_DATA['proMode'][value];
                        }
                    },
                    TB_NO: {
                        formatter: function (value, row) {
                            return "<a href='javascript:void(0)' onclick='openTbWeb(\"" + row.NEW_TB_PKID + "\")'>" + value + "</a>";
                        }
                    }
                }
            },
            resize: function () {
                return {width: 630, height: 382};
            },
            contextMenus: [
                {
                    i18nText: "维护备注", auth: "",
                    onclick: function () {
                        var row = $('#dg2').datagrid('getSelected');
                        if (!row.PKID) {
                            MsgAlert({content: '请选择记录！', type: 'error'});
                            return;
                        }
                        addMemo(row.PKID);
                    }
                },
            ],
            onClickRow: function (rowIndex, rowData) {
            },
            validAuth: function (row, items) {
                if(row.PRO_MODE != 'WXCL'){
                    items['维护备注'].display = false;
                }
                return items;
            },
            onDblClickRow: function (index, field, value) {
            }
        });
    }

    function openTbWeb(tbPkid) {
        common_add_edit_({
            url: "/views/em/emtb/View.shtml?pkid=" + tbPkid,
            title: "TB查看",
            width: 940,
            height: 600
        });
    }

    function searchDg1() {
        $('#dg1').datagrid('load', {
            evaPkid: pkid,
            tbNo: $('#tbNo').textbox('getValue')
        });
    }

    function query2() {
        $('#dg2').datagrid('load', {
            evaPkid: pkid,
            proMode: $('#proMode').combobox('getValue')
        });
    }

    function isApp(flag) {
        var id = flag == "R" ? "#dg2" : "#dg1";
        var rows = $(id).datagrid("getChecked");
        if (! rows || rows.length == 0) {
            MsgAlert({content: "请至少选择一条数据", type: "error"});
            return;
        }

        var pkids = [];
        for (var i = 0; i < rows.length; i++) {
            pkids.push(rows[i].PKID);
        }

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_AC_EEEOEATB_APP",
                pkids: pkids.join(";"),
                flag: flag
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    searchDg1();
                    query2();
                }
            }
        });
    }

    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate) return;

        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas.pkid = pkid;
        datas = $.extend({}, datas, {FunctionCode: 'EM_AC_EEEOEATB_EVA_SAVE'});
        InitFuncCodeRequest_({
            data: datas,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_err:ERRMSG.COMMON.SUCCESS_CODE')});
                } else {
                    MsgAlert({content: '保存失败',type: 'error'});
                }
            }
        });
    }

    function commit() {
        if ($('#dg1').datagrid('getRows').length > 0) {
            MsgAlert({
                content: "请先对全部未选择TB进行适用性判定！",
                type: "warn"
            });
            return;
        }
        var reqCou = 0;
        InitFuncCodeRequest_({
            data: {evaId: pkid, FunctionCode: 'EM_NEW_AC_WXCL'},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        reqCou = jdata.data.COU;
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
        if (reqCou > 0) {
            MsgAlert({content: "【无需处理】，请右键在备注中填写原因！！", type: 'error'});
            return;
        }
        $.messager.confirm("", "是否确认提交？", function (r) {
            if (r) {
                common_add_edit_({
                    url: "/views/flow/work_flow_account_select.shtml",
                    param: {
                        FunctionCode_: 'EM_AC_NEW_SUBMIT',
                        otherParam: pkid,
                        msgpkid: param.msgpkid,
                        flag: "newac",
                        successCallback: closeW
                    },
                    title: $.i18n.t('选择审批人'),
                    width: 520,
                    height: 300
                });
            }
        });
    }

    function closeW() {
        param.OWindow.reloadTodo();
        CloseWindowIframe();
    }

    function addMemo(pkid){
        var title_ = $.i18n.t('维护备注');
        ShowWindowIframe({
            width: "800",
            height: "500",
            param: {
                pkid:pkid
            },
            url: "/views/em/emfileeval/emfileeva_new_ac_add_memo.shtml"
        });
    }

</script>

</html>
