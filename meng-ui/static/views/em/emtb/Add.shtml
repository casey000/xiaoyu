<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>TB编写</title>
</head>

<body>
<div>
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <input type="hidden" id="pkid" name="pkid" />
                <input type="hidden" id="status" name="status"/>
                <input type="hidden" id="writeManId" name="writeManId"/>
                <table class="table table-bordered table-info" >
                    <tr id = "view1" style="display: none">
                        <td  colspan="8" align="right" >
                            <input class="btn btn-primary" type="button" onclick="pdfView()" value="PDF预览" style="width: 70px;"/>
                        </td>
                    </tr>
                    <tr id = "view">
                        <td  colspan="8" align="right" >
                            <input class="btn btn-primary" id="pdf" type="button" onclick="pdfView()" value="PDF预览" style="width: 70px;"/>
                            <input class="btn btn-primary" type="button" onclick="upload()" value="上传附件" style="width: 70px;"/>
                            <input class="btn btn-primary" type="button" onclick="viewAttach()" value="查看附件" style="width: 70px;"/>
                            <input class="btn btn-primary" type="button" onclick="save()" value="保存" style="width: 70px;"/>
                            <input class="btn btn-primary" type="button" onclick="issue()" value="提交"
                                   style="width: 70px;"/>
                            <input class="btn btn-primary" id="turnBtn" type="button" onclick="turnTb()" value="驳回"
                                   style="width: 70px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" >旧TB编号：</th>
                        <td class="tdr" >
                            <input class="easyui-textbox" id="oldTbNo" disabled="disabled" name="oldTbNo"
                                   style="width: 120px;" readonly/>
                        </td>
                        <th class="th" align="right" >有效期：</th>
                        <td class="tdr" >
                            <input class="easyui-datebox" id="effectDate" name="effectDate"
                                   style="width: 120px;" data-options="required:true,editable:false"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" >TB编号：</th>
                        <td class="tdr" >
                            <input class="easyui-textbox" id="tbNo" disabled="disabled" name="tbNo"
                                   style="width: 120px;" readonly/>
                        </td>
                        <th class="th" align="right" >TB版次：</th>
                        <td class="tdr" >
                            <input class="easyui-textbox" data-options="required:true" disabled="disabled" id="tbVer"
                                   name="tbVer" readonly
                                   style="width: 120px;" value="0"/>
                        </td>
                        <th class="th" align="right" style="width: 180px">ATA：</th>
                        <td class="tdr" >
                            <input class="easyui-combobox" data-options="required:true,editable:false" id="ata"
                                   name="ata"
                                   style="width: 70px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 110px;">适用类型：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" data-options="required:true,editable:false" id="applyType"
                                   name="applyType" style="width: 70px;"/>
                        </td>
                        <th align="right" class="th">适用型号：</th>
                        <td class="tdr" >
                            <input class="easyui-combobox"
                                   data-options="required:true,editable:false"
                                   id="applyModel"
                                   name="applyModel"
                                   style="width: 120px;"/>
                        </td>
                        <th id="id_ifInfluenceTb1" class="th" align="right" style="width: 180px">新飞机/发动机引进影响本TB：</th>
                        <td id="id_ifInfluenceTb2" class="tdr" >
                            <input class="easyui-combobox"
                                   id="ifInfluenceTb"
                                   name="ifInfluenceTb"
                                   data-options="required:true,editable:false"
                                   style="width: 70px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th class="th" align="right">中文标题：</th>
                        <td class="tdr" colspan="7">
                            <input class="easyui-textbox " id="cnTitle" name="cnTitle" multiline="true"
                                   data-options="required:true"
                                   style="width: 100%;height:50px" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" >英文标题：</th>
                        <td class="tdr"  colspan="7">
                            <input class="easyui-textbox" id="enTitle" name="enTitle"
                                   data-options="multiline:true"
                                   style="width: 100%; height:50px" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" >改版原因：</th>
                        <td class="tdr" colspan="7">
                            <input class="easyui-textbox" id="revReason" name="revReason"
                                   data-options="multiline:true"
                                   style="width: 100%; height:50px">
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right">来源文件:</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox"
                                   id="yjFile" name="yjFile"
                                   style="width: 92%"
                                   disabled="disabled"
                                   readonly/>
                            <input type="button"
                                   id="id_yj" class="btn btn-primary"
                                   value="浏览"
                                   onclick="checkFile('YJ')"
                                   style="width: 50px;" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right">相关工程文件:
                        </th>
                        <td class="tdr"  colspan="5">
                            <input class="easyui-textbox"
                                   id="xgFile" name="xgFile"
                                   style="width: 92%"
                                   disabled="disabled"
                                   readonly/>
                            <input type="button" id="liulan2"
                                   class="btn btn-primary"
                                   value="浏览"
                                   onclick="checkFile('XG')"
                                   style="width: 50px;" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" >分类：</th>
                        <td class="tdr"  colspan="5">
                            <input id="tbClassification1" name="tbClassification1" type="checkbox" onclick="chooseMa(this)"/>&nbsp;维修规范&nbsp;&nbsp;
                            <input id="tbClassification2" name="tbClassification2" type="checkbox" onclick="chooseMa(this)"/>&nbsp;维修/操作提示&nbsp;&nbsp;
                            <input id="tbClassification3" name="tbClassification3" type="checkbox" onclick="chooseMa(this)"/>&nbsp;运行要求&nbsp;&nbsp;
                            <input id="tbClassification4" name="tbClassification4" type="checkbox" onclick="chooseMa(this)"/>&nbsp;其它&nbsp;&nbsp;
                            <input id="tbClassification5" name="tbClassification5" type="checkbox" onclick="chooseMa(this)"/>&nbsp;构型变更&nbsp;&nbsp;
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 110px;">适用性类型：</th>
                        <td>
                            <input class="easyui-combobox"
                                   id="appType"
                                   name="appType"
                                   data-options="required:true,editable:false"
                                   style="width: 120px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width:80px">适用性:</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox"
                                   id="app"
                                   name="app"
                                   style="width: 92%"
                                   disabled="disabled"
                                   readonly/>
                            <input type="button" id = "liulan3"
                                   class="btn btn-primary"
                                   value="浏览"
                                   onclick="applic()"
                                   style="width: 50px;" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right">插页要求：</th>
                        <td class="tdr" >
                            <input class="easyui-combobox" name="ifInset" id="ifInset" style="width: 120px;"
                                   data-options="required:true"/>
                            <input id ="add1" class="btn btn-primary" onclick="addPage()" style="width: 50px;" type="button"
                                   value="增加"/>
                        </td>
                        <td class="tdr"  colspan="6">
                            <p style="font-size: 14px;color: #cd0a0a">注意部分新飞机的手册暂未合并至顺丰手册中，可能需要<br>对波音网的上个营运人进行插页提醒</p>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right">插页要求：</th>
                        <td class="tdr"  colspan="7">
                            <table id="dg"></table>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right">发往维修体系：</th>
                        <td class="tdr" id="sendTd1" colspan="7" style="width: 120px;"></td>
                    </tr>
                    <tr>
                        <th class="th" align="right">发往部门负责人：</th>
                        <td class="tdr" id="sendTd2" colspan="7" style="width: 120px;"></td>
                    </tr>
                    <tr>
                        <th class="th" align="right">背景：</th>
                        <td class="tdr" colspan="7">
                            <div id="background" name="background" type="text/plain" style="width: 100%;height: 300px"></div>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" >措施：</th>
                        <td class="tdr" colspan="7">
                            <div id="measure" name="measure" type="text/plain" style="width: 100%;height: 300px"></div>
                        </td>
                    </tr>

                </table>
            </form>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<!-- 配置文件 -->
<script type="text/javascript" src="/js/ueditor/ueditor.config.js"></script>
<!-- 编辑器源码文件 -->
<script type="text/javascript" src="/js/ueditor/ueditor.all.min.js"></script>
<script type="text/javascript">
    var param;
    var operation;
    var PAGE_DATA = {};
    var dataType = "";
    var ubackground;
    var umeasure;
    var appType;
    var applyType;
    var msgData;
    var pkid;
    var cou;
    var isFlow;
    var taskId;
    var ifEva = 'N';
    var eflag = '';
    var ifQua = '';//第一个人的资质
    var selectRow=null;
    var accountId = getLoginInfo().accountId;
    function i18nCallBack() {
        param = getParentParam_();
        isFlow = param.isFlow;
        taskId = param.taskId;
        operation = param.operation;
        msgData = param.msgData;
        cou = param.cou;
        if(isFlow && taskId != 'task1515208598367'){
            operation = 'view';
        }
        if (cou == 0) {
            $("#turnBtn").hide();
        } else {
            $("#turnBtn").show();
        }
        if (msgData) {
            pkid = param.recordId;
        } else {
            pkid = param.pkid;
        }
        ubackground = UE.getEditor('background', {
            toolbars: [['undo', 'redo', 'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
                'rowspacingtop', 'rowspacingbottom', 'lineheight', '|', 'customstyle', 'paragraph', 'fontfamily', 'fontsize', 'indent', '|', 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|', 'touppercase', 'tolowercase', '|',
                'link', 'unlink', 'anchor', '|', 'searchreplace', /*'simpleupload', 'insertimage',*/ 'emotion', '|', 'horizontal', 'date', 'time', '|', 'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', '|',
                'spechars', 'preview']]
        });
        umeasure = UE.getEditor('measure', {
            toolbars: [['undo', 'redo', 'bold', 'italic', 'underline', 'fontborder', 'strikethrough', 'superscript', 'subscript', 'removeformat', 'formatmatch', 'autotypeset', 'blockquote', 'pasteplain', '|', 'forecolor', 'backcolor', 'insertorderedlist', 'insertunorderedlist', 'selectall', 'cleardoc', '|',
                'rowspacingtop', 'rowspacingbottom', 'lineheight', '|', 'customstyle', 'paragraph', 'fontfamily', 'fontsize', 'indent', '|', 'justifyleft', 'justifycenter', 'justifyright', 'justifyjustify', '|', 'touppercase', 'tolowercase', '|',
                'link', 'unlink', 'anchor', '|', 'searchreplace', /*'simpleupload', 'insertimage',*/ 'emotion', '|', 'horizontal', 'date', 'time', '|', 'inserttable', 'deletetable', 'insertparagraphbeforetable', 'insertrow', 'deleterow', 'insertcol', 'deletecol', 'mergecells', 'mergeright', 'mergedown', 'splittocells', 'splittorows', 'splittocols', '|',
                'spechars', 'preview']]
        });

        if ("add" == operation) {
            $("#applyType").attr("disabled", false);
            initEffectDate();

        }else{
            $("#ata").combobox({required: false, onlyview: true});
            $("#applyType").combobox({required: false, onlyview: true});
            $("#applyModel").combobox({required: false, onlyview: true});
        }

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode:
                    "TB_SYS_ORG_LIST," +
                    "APP_TYPE," +
                    "EMTB_APPLY_TYPE," +
                    "EMTB_APPLY_MODEL," +
                    "EMTB_YESORNO," +
                    "EMTB_ATA," +
                    "DA_ENG_MODEL,EM_INSERT_MANUAL,EM_INSERT_MANUAL_NO"
            },
            successCallBack: function (jdata) {
                if (jdata.code !== RESULT_CODE.SUCCESS_CODE) {
                    return;
                }
                PAGE_DATA['insertManual'] = DomainCodeToMap_(jdata.data["EM_INSERT_MANUAL"]);
                $('#applyType').combobox({
                    panelHeight: 'auto',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data.EMTB_APPLY_TYPE,
                    onSelect: function (item) {
                        if (applyType) {
                            if (!confirm("选择会在保存后清空适用性数据，是否确认？")) {
                                $(this).combobox("setValue", applyType);
                                return;
                            }
                        }

                        $('#applyModel').combobox('clear');
                        $('#applyModel').combobox({
                            panelHeight: 'auto',
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            multiple: true,
                            data: item.VALUE == "APL" ? jdata.data.EMTB_APPLY_MODEL : jdata.data.DA_ENG_MODEL
                        });
                        $('#app').textbox('clear');
                    }
                });
                $('#appType').combobox({
                    panelHeight: 'auto',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data.APP_TYPE,
                    onSelect: function (row) {
                        if (appType) {
                            if (!confirm("选择会清空适用性数据？")) {
                                $(this).combobox("setValue", appType);
                                return;
                            }
                        }
                        $('#app').textbox('clear');
                    }
                });
                $('#ata').combobox({
                    panelHeight: '150px',
                    data: jdata.data.EMTB_ATA,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });
                $('#ifInfluenceTb').combobox({
                    data: jdata.data.EMTB_YESORNO,
                    valueField: "VALUE",
                    textField: "TEXT",
                    panelHeight: "auto"
                });
                $('#ifInset').combobox({
                    panelHeight: 'auto',
                    data: jdata.data.EMTB_YESORNO,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    onSelect: function (item) {
                        var temp = item.VALUE;
                        if(temp == 'N'){
                            delInsert();
                        }
                    }
                });
                var orgList = jdata.data.TB_SYS_ORG_LIST;
                for (var i = 0; i < orgList.length; i++) {
                    var html = `<input id="send_${orgList[i].ORG_ID}" data-send="${orgList[i].ORG_ID}" name="send" type="checkbox"  onclick="chooseSend(this)"/>&nbsp;${orgList[i].ORG_NAME}&nbsp;&nbsp; `;
                    if (orgList[i].NOTIFY_ENTIRE_DEPT === "Y") {
                        $("#sendTd1").append(html);
                    } else {
                        $("#sendTd2").append(html);
                    }
                }
                if(operation == 'view'){
                    $('#view1').show();
                    $('#view').hide();
                    $('#id_yj').attr("disabled", true);
                    $('#liulan2').attr("disabled", true);
                    $('#liulan3').attr("disabled", true);
                    $('#add1').attr("disabled", true);
                }
                if (pkid) {
                    InitDataForm(pkid);
                    InitDataGrid(pkid);
                } else {
                    $('#ifInset').combobox('setValue', 'N');
                    InitDataGrid(-1);
                }
            }
        });
    }

    //初始化页面数据
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EMTB_PKID",
                pkid: pkid
            },
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    $('#applyType').combobox('select', jdata.data.APPLY_TYPE);
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    ifEva = jdata.data.FROM_EVA;

                    if (jdata.data.FROM_EVA === "Y") {
                        $('#id_yj').attr("disabled", true);
                        $('#id_ifInfluenceTb1').hide();
                        $('#id_ifInfluenceTb2').hide();
                        //去掉必填
                        $('#ifInfluenceTb').combobox({required: false});
                    } else {
                        $('#id_ifInfluenceTb1').show();
                        $('#id_ifInfluenceTb2').show();
                        $('#ifInfluenceTb').combobox({required: true});
                    }
                    $('#ifInfluenceTb').combobox({value: jdata.data.IF_INFLUENCE_TB});

                    $(":checkbox").each(function () {
                        var radioName = toLine($(this).attr('name')).toUpperCase();
                        var num = jdata.data[radioName];
                        $(this).prop("checked", num === "Y");
                    });
                    appType = $("#appType").combobox('getValue');
                    applyType = $("#applyType").combobox("getValue");
                    if (jdata.data.SEND && 0 < jdata.data.SEND.length) {
                        var send = jdata.data.SEND.split(",");
                        for (var i = 0; i < send.length; i++) {
                            $("#send_" + send[i]).prop("checked", true);
                        }
                    }
                    if (jdata.data.APPLY_MODEL) {
                        $("#applyModel").combobox("setValues", jdata.data.APPLY_MODEL.split(","))
                    }

                    if ('MX' === jdata.data.APP_TYPE) {
                        if ('APL' === jdata.data.APPLY_TYPE) {
                            $("#app").textbox("setValue", jdata.data.APL_APP)
                        } else {
                            $("#app").textbox("setValue", jdata.data.ENG_APP)
                        }
                    } else {
                        $("#app").textbox("setValue", jdata.data.APL_MODEL)
                    }

                    ubackground.ready(function () {
                        if (jdata.data.BACKGROUND) {
                            ubackground.setContent(jdata.data.BACKGROUND);
                        }

                    });
                    umeasure.ready(function () {
                        if (jdata.data.MEASURE) {
                            umeasure.setContent(jdata.data.MEASURE);
                        }

                    });
                    //设置子页面数据
                    //  setSubData(jdata.data)
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function InitDataGrid(tbPkid) {
        var identity = 'dg';
        $("#dg").MyDataGrid({
            identity: identity,
            sortable: true,
            firstLoad: true,
            singleSelect: true,
            pagination: false,
            enableLineEdit: true,
            enableCellEdit: false,
            resize: function () {
                return {
                    height: 200,
                    width: 815
                };
            },
            queryParams: {tbPkid: tbPkid},
            columns: {
                param: {FunctionCode: 'EMTBINSET_LIST'},
                alter: {
                    INSET_MANUAL: {
                        editor: {
                            type: 'combobox',
                            options: {
                                editable: false,
                                panelHeight: '150px',
                                valueField: 'VALUE',
                                textField: 'TEXT',
                                queryParams: {domainCode: "EM_INSERT_MANUAL"},
                                url: Constant.API_URL + 'ANALYSIS_DOMAIN_BYCODE',
                                required: true,
                                loadFilter: function (jdata) {
                                    var v = eval("jdata.data." + "EM_INSERT_MANUAL");
                                    return v;
                                },
                                tipPosition: 'top'
                            }
                        }, formatter: function (value) {
                            return PAGE_DATA['insertManual'][value];
                        }
                    },
                    MANUAL_NO: {
                        editor: {
                            type: 'combobox',
                            options: {
                                editable: true,
                                panelHeight: '150px',
                                valueField: 'VALUE',
                                textField: 'TEXT',
                                queryParams: {domainCode: "EM_INSERT_MANUAL_NO"},
                                url: Constant.API_URL + 'ANALYSIS_DOMAIN_BYCODE',
                                required: true,
                                loadFilter: function (jdata) {
                                    var v = eval("jdata.data." + "EM_INSERT_MANUAL_NO");
                                    return v;
                                },
                                onHidePanel: function () {
                                    var t = $(this).combobox('getValue');
                                    if (selectRow==null || t!=selectRow.VALUE) {//没有选择或者选项不相等时清除内容
                                        alert('请选择手册编号，不要直接输入！');
                                        $(this).combobox({value: ''});
                                    }
                                },
                                onSelect: function (obj) {
                                    selectRow = obj;
                                },
                                tipPosition: 'top'
                            },

                        }, formatter: function (value) {
                            return value;
                        }
                    },
                    INSET_POSITION: {
                        editor: {
                            type: 'textbox'
                        }
                    },
                    INSET_MEMO: {
                        editor: {
                            type: 'textbox'
                        }
                    }
                }
            },
            contextMenus: [
                {
                    id: "m-delete",
                    i18nText: "删除",
                    auth: "",
                    onclick: function () {
                        var rowdata = getDG('dg').datagrid('getSelected');
                        if (!rowdata.PKID) {
                            MsgAlert({content: '请选择记录！', type: 'error'});
                            return;
                        }

                        InitFuncCodeRequest_({
                            data: {
                                FunctionCode: "EM_TB_INSET_DEL",
                                pkid : rowdata.PKID
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    $('#dg').datagrid('reload');
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }
            ],
            onLoadSuccess: function (data) {
                $("#dg").datagrid('doCellTip', {'max-width': '400px', 'delay': 500});
            },
            onEndEdit: function (index, row, changes) {
                if (! row.INSET_MANUAL || ! row.INSET_POSITION) {
                    MsgAlert({
                        content: "【插页手册】和【插页位置】 都不能为空！",
                        type: "warn"
                    });
                    return;
                }
                row = $.extend({
                    tbPkid: $("#pkid").val(),
                    FunctionCode: "EM_TB_INSET_SAVE"
                }, row);
                InitFuncCodeRequest_({
                    data: row,
                    successCallBack: function (jdata) {
                        if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                            MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                            $('#dg').datagrid('load', {tbPkid: $('#pkid').val()});
                        } else {
                            MsgAlert({content: jdata.msg, type: 'error'});
                        }
                    }
                });
            }
        });
    }
    //默认有效期为1年
    function initEffectDate(){
        var d2 = new Date();
        d2.setFullYear(d2.getFullYear()+1);
        d2.setDate(d2.getDate()-1);
        var maxDate = d2.Format('yyyy-MM-dd');
        $("#effectDate").datebox('setValue', maxDate);
    }

    function setApplyModel(applyType) {
        var datas2 = $.extend({applyType: applyType}, {FunctionCode: 'EMTB_APPLY_MODEL'});
        InitFuncCodeRequest_({
            data: datas2, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#applyModel').combobox({
                        panelHeight: '150px',
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        data: jdata.data
                    });
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    // 保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate) return;

        var $form = $("#mform");
        var datas = $form.serializeObject();
        var effectDate = datas.effectDate;
        var curDate = new Date().Format('yyyy-MM-dd');
        var d2 = new Date();
        d2.setFullYear(d2.getFullYear()+1);
        d2.setDate(d2.getDate()-1);
        var maxDate = d2.Format('yyyy-MM-dd');
        if(effectDate <= curDate){
            MsgAlert({
                content: "有效期不能小于等于当前日期！",
                type: "warn"
            });
            return;
        }
        if(effectDate > maxDate){
            MsgAlert({
                content: "有效期不能超过一年！",
                type: "warn"
            });
            return;
        }
        var radis = {};
        var send = [];
        $(":checkbox").each(function () {
            if ('send' == $(this).attr('name')) {
                if ($(this).is(':checked')) {
                    send.push($(this).attr('data-send'))
                }
            } else {
                radis[$(this).attr('name')] = $(this).is(':checked') ? "Y" : "N";
            }

        });

        if ("add" == operation) {
            let tbno = randomNumber("TB");
            $("#tbNo").textbox('setValue', tbno);
            datas.tbNo = tbno;
            datas.tbVer = 0;
        }

        datas.background = ubackground.getContent();
        datas.measure = umeasure.getContent();

        datas.applyModel = $("#applyModel").combobox('getValues').join(",");
        datas = $.extend({msgpkid: param.msgpkid}, datas, radis, {FunctionCode: 'EMTB_SAVE'});
        var sendStr = send.join(',');
        datas.send = sendStr;

        ajaxLoading();
        InitFuncCodeRequest_({
            data: datas,
            successCallBack: function (jdata) {
                ajaxLoadEnd();
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    applyType = $("#applyType").combobox("getValue");
                    if (param.OWindow) {
                        if (param.OWindow.reload_) {
                            param.OWindow.reload_()
                        }
                    }

                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    $("#ata").attr("disabled", false);
                    $("#pkid").val(jdata.data.pkid);
                    $("#status").val(jdata.data.status);
                    $("#writeManId").val(jdata.data.writeManId);
                    pkid = jdata.data.pkid;
                    operation = "edit";
                    $("#ata").combobox({required: false, onlyview: true});
                    $("#ata").combobox('setValue', datas.ata);
                    $("#applyType").combobox({required: false, onlyview: true});
                    $("#applyType").combobox('setValue', datas.applyType);
                    $("#applyModel").combobox({required: false, onlyview: true});
                    $("#applyModel").combobox('setValue', datas.applyModel);
                    if (msgData) {
                        param.OWindow.reloadTodo();
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    //插入分页表格 新增数据
    function addPage() {
        var pkid = $("#pkid").val();

        if (pkid === "" || pkid == -1) {
            MsgAlert({content: '请先创建保存TB', type: 'error'});
            return;
        }

        var ifInset = $('#ifInset').combobox('getValue');
        if (ifInset == "N") {
            MsgAlert({content: '插页要求为否时不能增加', type: 'error'});
            return;
        }

        $('#dg').datagrid('appendRow', {});
    }

    //提交
    function issue() {
        //保存校验
        var pkid = $("#pkid").val();
        if (pkid == -1 || pkid == "") {
            MsgAlert({content: '请先创建保存TB', type: 'error'});
            return;
        }
        var isValidate = $("#mform").form('validate');
        if (!isValidate) return;

        if (!confirm("请确认表单数据已保存")) return;
        var radis = {};
        var send = [];
        $(":checkbox").each(function () {
            if ('send' == $(this).attr('name')) {
                if ($(this).is(':checked')) {
                    send.push($(this).attr('data-send'))
                }
            } else {
                radis[$(this).attr('name')] = $(this).is(':checked') ? "Y" : "N";
            }

        });

        var sendStr = send.join(',');
        if(sendStr){
            if((sendStr.indexOf("11") != -1 || sendStr.indexOf("12") != -1 || sendStr.indexOf("13") != -1
                || sendStr.indexOf("16") != -1) && sendStr.indexOf("17") == -1){
                MsgAlert({
                    content: "勾选发往部门负责人时，必须勾选【运行标准部】！",
                    type: "warn"
                });
                return;
            }
        }

        var status = $("#status").val();
        if (status != "00") {
            MsgAlert({content: "只有编写状态才能提交！", type: 'error'});
            return;
        }

        var app = $("#app").textbox('getValue');
        if (! app) {
            MsgAlert({content: "提交前必须维护适用性！", type: 'error'});
            return;
        }
        if(ifEva == 'Y'){
            var reqCou = 0;
            InitFuncCodeRequest_({
                data: {tbPkid: pkid, FunctionCode: 'EM_EVA_TB_CHECK_APP'},
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data != null) {
                            reqCou = jdata.data.COU;
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
            if (reqCou > 0) {
                MsgAlert({content: "评估单产生的TB的适用性必须包含关联评估单的适用性！", type: 'error'});
                return;
            }
        }

        checkQua(pkid);
    }

    function checkQua(pkid) {
        var ata = $("#ata").combobox("getValue");
        var writeManId = $("#writeManId").val();
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: 'EM_TB_CHECK_QUA'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    eflag = jdata.data.eflag;
                    ifQua = jdata.data.ifQua;
                    var tips = '';
                    if (eflag == "NO") {
                        tips = "当前用户没有该评估单的资质，请提交给有资质的用户！";
                    } else if (eflag == "PART") {
                        tips = "当前用户资质不全，请提交给其他有资质的用户进行联合评估！";
                    }
                    var flowKey = "tbshenhe";
                    if (eflag == "ALL") {
                        let datas = $.extend({}, {}, {FunctionCode: 'EM_TB_CHECKDATA', pkid: pkid});
                        InitFuncCodeRequest_({
                            data: datas,
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    common_add_edit_({
                                        identity: '',
                                        isEdit: '',
                                        width: 520,
                                        height: 300,
                                        title: $.i18n.t('选择审批人'),
                                        param: {
                                            roleId: '',
                                            otherParam: pkid,
                                            FunctionCode_: 'EM_TB_STATUS',
                                            successCallback: reloadCole,
                                            flowKey: flowKey
                                        },
                                        url: "/views/flow/work_flow_account_select.shtml"
                                    });
                                } else {
                                    hints(jdata.msgData[0]);
                                }
                            }
                        });
                    } else {
                        $.messager.confirm('', tips, function (r) {
                            if (r) {
                                ShowWindowIframe({
                                    width: 550,
                                    height: 250,
                                    title: "联合评估",
                                    param: {
                                        accId: writeManId,
                                        pkid: pkid,
                                        ata: ata,
                                        cflag: "commit",
                                        fluflag: "add",
                                        accountId: accountId,
                                        ifQua: ifQua,
                                        eflag: eflag
                                    },
                                    url: '/views/em/emtb/em_tb_filetrans.shtml'
                                });
                            }
                        });
                    }
                } else {
                    MsgAlert({content: $.i18n.t(jdata.msg), type: 'error'});
                }
            }
        });
    }

    //关闭页面刷新父页面
    function reloadCole() {
        param.OWindow.reload_();
        reload_();
        CloseWindowIframe();
    }

    //上传
    function upload() {
        let pkid = $("#pkid").val();

        if (pkid == -1 || pkid == "") {
            MsgAlert({content: '请先创建保存TB', type: 'error'});
            return;
        }

        common_uploadFile({
            identity: 'dg',
            param: {
                cat: 'emTb',
                sourceId: pkid,
                successCellBack: "",
                fialCellBack: ""
            }
        });
    }

    //上传附件之后调用
    function reload_() {
        let pkid = $("#pkid").val();
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "EMTB_PKID"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    $("#xgFile").textbox("setValue", jdata.data.XG_FILE);
                    $("#yjFile").textbox("setValue", jdata.data.YJ_FILE);
                    let appType = $("#appType").combobox("getValue");
                    let applyType = $("#applyType").combobox("getValue");
                    if ('MX' == appType) {
                        if ('APL' == applyType) {
                            $("#app").textbox("setValue", jdata.data.APL_APP)
                        } else {
                            $("#app").textbox("setValue", jdata.data.ENG_APP)
                        }
                    } else {
                        $("#app").textbox("setValue", jdata.data.APL_MODEL)
                    }
                    if (param.OWindow.reload_()) {
                        param.OWindow.reload_()
                    }


                    //设置子页面数据
                    //  setSubData(jdata.data)
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //附件查看
    function viewAttach() {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: 'ATTACHMENT_RSPL_GET',
                CATEGORY: "emTb",
                SOURCE_ID: pkid
            },
            successCallBack: function (jdata) {
                //为0时提示没有上传附件，无法查看
                if (jdata.data.length === 0) {
                    MsgAlert({content: "请先上传附件", type: 'error'});
                } else {
                    //打开一个列表页面
                    ShowWindowIframe({
                        width: "515",
                        height: "285",
                        param: {pkid: pkid, category: "emTb"},
                        url: "/views/data_manager/dm/upload/editAttach.shtml"
                    });
                }
            }
        });
    }

    function randomNumber(dealOpinion) {
        var num = 1;
        var temp = "";
        var ata = $("#ata").textbox('getValue');

        var serialNo = dealOpinion + "-" + ata + "-";
        InitFuncCodeRequest_({
            data: {serialNo: serialNo, FunctionCode: "TD_EVAL_TB_BY_NO"},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        if (jdata.data.OLDNUM) {
                            num = parseInt(jdata.data.OLDNUM, 10) + 1;
                        }
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

        num = pad(num, 4);
        serialNo = serialNo + num;
        return serialNo;
    }

    var pad = function () {
        var tbl = [];
        return function (num, n) {
            var len = n - num.toString().length;
            if (len <= 0) return num;
            if (!tbl[len]) tbl[len] = (new Array(len + 1)).join('0');
            return tbl[len] + num;
        }
    }();

    function checkFile(fileSort) {
        var pkid = $("#pkid").val();
        if (pkid == -1 || pkid == "") {
            MsgAlert({content: '请先创建保存TB', type: 'error'});
            return;
        }

        var title = "YJ" == fileSort ? "依据文件选择" : "相关文件选择";
        ShowWindowIframe({
            width: 920,
            height: 600,
            title: title,
            url: "/views/em/emtb/EmYjEdit.shtml",
            param: {
                fileSort: fileSort,
                tbPkid: pkid
            }
        });
    }

    function applic() {
        var pkid = $("#pkid").val();
        if (pkid == -1 || pkid == "") {
            MsgAlert({content: '请先创建保存TB', type: 'error'});
            return;
        }

        var applyType = $("#applyType").combobox("getValue");
        var applyModel = $("#applyModel").combobox("getValue");
        var appType = $("#appType").combobox("getValue");
        if (! applyType || ! applyModel || ! appType) {
            MsgAlert({content: '请先维护【适用类型】、【适用型号】、【适用性类型】字段！', type: 'error'});
            return;
        }

        save();
        if ("XH" == appType) {
            checkFlag();
            MsgAlert({content: '添加成功'});
            return;
        }

        var title = "维护适用性";
        var url = "";
        if ("APL" == applyType) {
            url = '/views/em/emtb/applic/addTbFleetApplic.shtml';
        } else {
            url = '/views/em/emtb/applic/addTbEngSeriApplic.shtml';
        }
        ShowWindowIframe({
            width: 920,
            height: 550,
            title: title,
            url: url,
            param: {tbPkid: pkid, applyModel: applyModel}
        });
    }

    function setFileNo(fileNo, fileType) {
        if ("YJ" == fileType) {
            $("#basisFile").textbox("setValue", fileNo);
        } else {
            $("#engFile").textbox("setValue", fileNo);
        }
    }

    //驼峰转下划线
    function toLine(name) {
        return name.replace(/([A-Z])/g, "_$1").toLowerCase();
    }

    function pdfView() {
        let pkid = $("#pkid").val();

        if (pkid == -1 || pkid == "") {
            MsgAlert({content: '请先创建保存TB', type: 'error'});
            return;
        }

        if(!isFlow){
            ajaxLoading();
        }
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: 'EM_TB_PRINT'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    let urls = jdata.data;
                    if (urls.indexOf(":") != -1) {
                        urls = urls.substring(urls.indexOf(":") + 1).replace("//", "/");
                    }
                    jcPreview(urls);
                } else {
                    MsgAlert({content: jdata.msg, type: "error"});
                }
                if(!isFlow){
                    ajaxLoadEnd();
                }
            }
        });
    }

    function jcPreview(url) {
        ShowWindowIframe({
            width: 1200,
            height: 650,
            param: {url: url},
            title: "TB预览PDF",
            url: "/views/em/emeo/tb_pdf.shtml"
        });
    }

    //设置适用性类型 清空适用性数据
    function checkFlag() {
        var pkid = $("#pkid").val(); //保存校验

        if (pkid == -1 || pkid == "") {
            MsgAlert({content: '请先创建保存TB', type: 'error'});
            return;
        }

        InitFuncCodeRequest_({
            data: {
                FunctionCode: 'EM_ET_APP_DELALL',
                tbPkid: pkid
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    var appType = $("#appType").combobox("getValue");
                    if ("XH" == appType) {
                        InitFuncCodeRequest_({
                            data: {
                                FunctionCode: 'EM_TB_APP_SAVE',
                                tbPkid: pkid
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    reload_()
                                } else {
                                    MsgAlert({content: jdata.msg, type: "error"});
                                }
                            }
                        });
                    } else {
                        reload_()
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: "error"});
                }
            }
        });
    }

    function hints(mgs) {
        ShowWindowIframe({
            width: 300,
            height: 300,
            param: {mgs: mgs},
            title: "TB提示",
            url: "/views/em/emeo/eoHints.shtml"
        });
    }

    function turnTb() {
        var ata = $("#ata").combobox("getValue");
        var evaManId = $("#writeManId").val();
        var pkid = $("#pkid").val();
        var cflag = "turn";
        ShowWindowIframe({
            width: 550,
            height: 250,
            title: "驳回",
            param: {accId: evaManId, pkid: pkid, cflag: cflag, ata: ata, accountId: accountId},
            url: '/views/em/emtb/em_tb_filetrans.shtml'
        });
    }

    function changeIfInset() {
        //处理控件初始化问题
        var options = $(this).combobox('options');
        if (options.stopFirstChangeEvent) {
            options.stopFirstChangeEvent = false;
            // return;
        } else {
            $.messager.confirm('', '切换插页要求将会删除插页表格内容，是否继续？', function (r) {
                if (r) {
                    //删除适用性和间隔数据
                    InitFuncCodeRequest_({
                        data: {tbPkid: pkid, FunctionCode: "EMTBINSET_DEL"},
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                reloadInsert();
                            }
                        }
                    });
                } else {

                }
            });
        }

    }

    /** 刷新列表数据 */
    function reloadInsert() {
        $("#dg").datagrid("reload");
    }

    function reloadTo2() {
        if (msgData == "emTbQua") {
            param.OWindow.reloadTodo();
        } else {
            param.OWindow.reload_();
        }
    }

    function delInsert(){
        if (confirm("切换后将删除插页要求列表数据，是否确认？")) {
            InitFuncCodeRequest_({
                data: {tbPkid: pkid, FunctionCode: "EMTBINSET_DEL"},async:false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        reloadInsert();
                        MsgAlert({content: "操作成功"});
                    }
                }
            });
        }else{
            $("#ifInset").combobox("setValue", "Y");
        }
    }


    function chooseMa(temp){
        var ma = temp.id;
        if(ma == 'tbClassification1' || ma == 'tbClassification3' || ma == 'tbClassification4'|| ma == 'tbClassification5'){
            $(':checkbox[name=tbClassification2]').prop('checked', false);
        }else{
            $(':checkbox[name=tbClassification1]').prop('checked', false);
            $(':checkbox[name=tbClassification3]').prop('checked', false);
            $(':checkbox[name=tbClassification4]').prop('checked', false);
            $(':checkbox[name=tbClassification5]').prop('checked', false);
        }
    }

    function chooseSend(temp){
        var ma = temp.id;
        if((ma == 'send_11' || ma == 'send_12' || ma == 'send_13'|| ma == 'send_16') && temp.checked){
            $(':checkbox[id=send_17]').prop('checked', true);
        }
    }
</script>
</html>