<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html
        xmlns="http://www.w3.org/1999/html">
<head id="i18n_" module="emmpdeval">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>增加间隔</title>
</head>
<body>
<div style="">
    <div class="ibox float-e-margins" id="div2">
        <form class="form-horizontal m-t" id="mform">
            <input type="hidden" id="pkid" name="pkid">
            <input type="hidden" id="evalNo" name="evalNo">
            <input type="hidden" id="intervalType" name="intervalType" value="NORMAL">
            <fieldset class="fieldset_eui" style="width:100%;margin-right:5px;">
                <div class="ibox-content">
                    <table class="table table-bordered table-info" style="width:100%;">
                        <tr>
                            <td align="right">
                                <input class="btn btn-primary" type="button" id="saveBtn" value="保存" onclick="save();"
                                       style="margin:5px;"/>
                                <input class="btn btn-primary" value="关闭" type="button" onclick="closeAdd();"
                                       style="margin:5px;"/>
                            </td>
                        </tr>
                    </table>
                </div>

                <fieldset class="fieldset_eui" id="tdiv" style="float:left;width:55%;height:270px">
                    <table style="width:80%;">
                        <legend>首检</legend>
                        <tr>
                            <td align="right" class="td1">
                                监控方法：
                            </td>
                            <td colspan="6" class="tdr">
                                <input class="easyui-combobox" id="tIntervalRule"
                                       name="tIntervalRule"
                                       style="width:100px;height:30px;"
                                       data-options="required:false,onChange:tIntervalRuleChange,editable:false"/>
                            </td>
                        </tr>
                        <tr>
                            <td class="td1" align="right" style="width:150px;">首检参数1：</td>
                            <td class="tdr" style="width:100px;">
                                <input class="easyui-textbox" id="tFh" name="tFh"
                                       style="width:100px;height:30px;"
                                       data-options="validType:['positive'],onChange:fhChange"/>
                            </td>
                            <td align="left"> FH</td>
                            <td align="right" style="width:15px;">
                                <input type="checkbox" id="tFhIfSince" name="tFhIfSince" class="checkJ">
                            </td>
                            <td style="width:40px;">
                                <legend>Since</legend>
                            </td>
                            <td id="tFhSinceTd" class="tdr" style="width:65px;">
                                <input class="easyui-combobox" id="tFhSince"
                                       name="tFhSince" style="width:80px"
                                       data-options="onChange:fhChange,editable:false"/>
                            </td>
                        </tr>
                        <tr>
                            <td class="td1" align="right">首检参数2：</td>
                            <td class="tdr">
                                <input class="easyui-textbox" id="tFc" name="tFc"
                                       style="width:100px;height:30px;"
                                       data-options="validType:['positive'],onChange:fcChange"/>
                            </td>
                            <td style="width:50px;" align="left"> FC</td>
                            <td align="right">
                                <input type="checkbox" id="tFcIfSince" name="tFcIfSince" class="checkJ">
                            </td>
                            <td>
                                <legend>Since</legend>
                            </td>
                            <td id="tFcSinceTd" class="tdr">
                                <input class="easyui-combobox" id="tFcSince"
                                       name="tFcSince" style="width:80px"
                                       data-options="onChange:fcChange,editable:false"/>
                            </td>
                        </tr>
                        <tr>
                            <td class="td1" align="right">首检参数3：</td>
                            <td class="tdr">
                                <input class="easyui-textbox" id="tCal" name="tCal"
                                       style="width:100px;height:30px"
                                       data-options="validType:['positive'],onChange:tcalChange"/>
                            </td>
                            <td class="tdr">
                                <input class="easyui-combobox" id="tCalUnit" name="tCalUnit"
                                       style="width:60px;height:30px"
                                       data-options="onChange:tcalChange,editable:false"/>
                            </td>
                            <td align="right">
                                <input type="checkbox" id="tCalIfSince" name="tCalIfSince" class="checkJ">
                            </td>
                            <td>
                                <legend>Since</legend>
                            </td>

                            <td id="tCalSinceTd" class="tdr">
                                <input class="easyui-combobox" id="tCalSince"
                                       name="tCalSince" style="width:80px"
                                       data-options="onChange:tcalChange,editable:false"/>
                            </td>
                        </tr>

                        <tr>
                            <td class="td1" align="right">截止日期：</td>
                            <td class="tdr">
                                <input class="easyui-datebox" id="tLimitedDay" name="tLimitedDay"
                                       style="width:100px;height:30px"
                                       data-options="onChange:tLimitedDayChange,editable:false"/>
                            </td>
                        </tr>
                    </table>
                </fieldset>
                <fieldset class="fieldset_eui" style="float:left;width:30%;height:270px">

                    <table style="width:100%;height:100%">
                        <legend>首检说明 <input type="checkbox" id="tIfNote" name="tIfNote">NOTE</legend>
                        <td>
                            <input class="easyui-textbox" id="thresholdDesc"
                                   name="thresholdDesc"
                                   style="width:100%;height:93%;border: 1px solid #ddd;border-radius: 5px;"
                                   data-options="multiline:true,editable:false,onlyview:true"/>
                        </td>
                    </table>
                </fieldset>
                <!--重检-->
                <fieldset class="fieldset_eui" id="ivdiv" style="float:left;width:55%;height:230px">
                    <table style="width:55%;">
                        <legend>重检</legend>
                        <tr>
                            <td align="right" class="td1">
                                监控方法：
                            </td>
                            <td colspan="6" class="tdr">
                                <input class="easyui-combobox" id="ivIntervalRule"
                                       name="ivIntervalRule"
                                       style="width:100px;height:30px;"
                                       data-options="required:false,onChange:ivIntervalRule,editable:false"/>
                            </td>
                        </tr>
                        <tr>
                            <td class="td1" align="right" style="width:150px;">间隔参数1：</td>
                            <td class="tdr" style="width:100px;">
                                <input class="easyui-textbox" id="ivFh" name="ivFh"
                                       style="width:100px;height:30px;"
                                       data-options="validType:['positive'],onChange:ivFhChange"/>
                            </td>
                            <td align="left"> FH</td>
                        </tr>
                        <tr>
                            <td class="td1" align="right">间隔参数2：</td>
                            <td class="tdr">
                                <input class="easyui-textbox" id="ivFc" name="ivFc"
                                       style="width:100px;height:30px;"
                                       data-options="validType:['positive'],onChange:ivFcChange"/>
                            </td>
                            <td style="width:50px;" align="left"> FC</td>
                        </tr>
                        <tr>
                            <td class="td1" align="right">间隔参数3：</td>
                            <td class="tdr">
                                <input class="easyui-textbox" id="ivCal" name="ivCal"
                                       style="width:100px;height:30px"
                                       data-options="validType:['positive'],onChange:ivCalChange"/>
                            </td>
                            <td class="tdr">
                                <input class="easyui-combobox" id="ivCalUnit" name="ivCalUnit"
                                       style="width:60px;height:30px"
                                       data-options="onChange:ivCalChange,editable:false"/>
                            </td>
                        </tr>
                    </table>
                </fieldset>
                <fieldset class="fieldset_eui" style="float:left;width:30%;height:230px">
                    <table style="width:100%;height:100%">
                        <legend>重检说明 <input type="checkbox" id="ivIfNote" name="ivIfNote">NOTE
                            &nbsp;&nbsp;&nbsp;&nbsp;
                            <input type="checkbox" id="ifTbd" name="ifTbd">TBD
                        </legend>
                        <td class="tdr">
                            <input class="easyui-textbox" id="intervalDesc"
                                   name="intervalDesc"
                                   style="width: 100%;height:95%;border: 1px solid #ddd;border-radius: 5px;"
                                   data-options="multiline:true,editable:false,onlyview:true"/>
                        </td>
                    </table>
                </fieldset>
            </fieldset>

        </form>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var isEdit_;
    var evalNo;
    var type;
    var Add;
    var fleet;
    var appltype;
    function i18nCallBack() {
        param = getParentParam_();
        isEdit_ = param.isEdit || $("#pkid").val();//页面存在值的时候再点保存变更新
        evalNo = param.evalNo;
        fleet = param.fleet;
        Add = param.Add;
        pkid = param.pkid;
        if (pkid) {
            $("#pkid").val(pkid);
        }
        type = param.type;
        appltype = param.appltype;
        if (type == "view") {
            $("#saveBtn").hide();
        }
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "EM_MP_UNIT,EM_IF_APPL,EM_INTERVAL_TYPE,EM_MP_INTERVAL_RULE,EM_APL_INTERVAL_TYPE,EM_T_CAL_SINCE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //jdata.data.EM_T_CAL_SINCE.unshift({TEXT: "-select-", VALUE: ""});
                    $('#tFhSince').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_T_CAL_SINCE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    $('#tFcSince').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_T_CAL_SINCE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    $('#tCalSince').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_T_CAL_SINCE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    // $('#intervalType').combobox({
                    //     panelHeight: '120px',
                    //     data: jdata.data.EM_APL_INTERVAL_TYPE,
                    //     valueField: 'VALUE',
                    //     textField: 'TEXT',
                    // });
                    // $("#intervalType").combobox("setValue", 'NORMAL');
                    jdata.data.EM_MP_INTERVAL_RULE.unshift({TEXT: "-select-", VALUE: ""});
                    $('#tIntervalRule').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_MP_INTERVAL_RULE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    $('#ivIntervalRule').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_MP_INTERVAL_RULE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    // jdata.data.EM_MP_TICHK_UNIT.unshift({TEXT: "-select-", VALUE: ""});
                    $('#tCheckUnit').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_MP_TICHK_UNIT,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    jdata.data.EM_MP_UNIT.unshift({TEXT: "-select-", VALUE: ""});
                    $('#ivCalUnit').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_MP_UNIT,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    $('#ivCheckUnit').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_MP_TICHK_UNIT,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    $('#tCalUnit').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_MP_UNIT,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    //隐藏Since
                    // $('#tFhSince').next().hide();
                    // $('#tFcSince').next().hide();
                    // $('#tCalSince').next().hide();
                    $("#evalNo").val(evalNo);
                    // InitEditForm_();
                    // InitDataGrid();
                    // filetheappldesc();
                    // initForm();
                    if (pkid != "") {
                        InitDataForm(pkid);
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }

            }
        });

    }

    //是否使用首检说明note
    $("#tIfNote").change(function () {
        a.splice(0, a.length);
        var tIfNote = $("#tIfNote").is(":checked");
        if (tIfNote) {
            //允许编辑首检说明
            $("#thresholdDesc").textbox({editable: true, onlyview: false, multiline: true});
            $("#tdiv").find("input").each(function (k, it) {
                if ($(it).hasClass("combobox-f")) {
                    $(it).combobox({required: false, editable: false, onlyview: true});
                    $(it).combobox("setValue", '');
                } else if ($(it).hasClass("textbox-f")) {
                    $(it).textbox('setValue', '');
                    $(it).textbox({required: false, editable: false, onlyview: true});
                } else if ($(it).hasClass("checkJ")) {
                    $(it).removeAttr("checked");
                    $(it).prop('disabled', true);
                }
            });

            $("#thresholdDesc").textbox('setValue', '');
            $("#tLimitedDay").datebox({disabled: true});
            $("#tCal").textbox({required: false, editable: false, onlyview: true});
        } else {
            $("#thresholdDesc").textbox({editable: false, onlyview: true, multiline: true});
            $("#tdiv").find("input").each(function (k, it) {
                if ($(it).hasClass("combobox-f")) {
                    $(it).combobox({required: true, onlyview: false});
                } else if ($(it).hasClass("textbox-f")) {
                    $(it).textbox({required: false, editable: true, onlyview: false});
                } else if ($(it).hasClass("checkJ")) {
                    $(it).attr("checked", true);
                    $(it).prop('disabled', false);
                }
            });
            $("#tIntervalRule").combobox('setValue', '');
            $("#tIntervalRule").combobox({required: false, onlyview: false});
            $("#thresholdDesc").textbox('setValue', '');
            $("#tFhSince").combobox({required: false, onlyview: false});
            $("#tFhSince").combobox('setValue', '');
            $("#tFcSince").combobox({required: false, onlyview: false});
            $("#tFcSince").combobox('setValue', '');
            $("#tCalUnit").combobox({required: false, onlyview: false});
            $("#tCalUnit").combobox('setValue', '');
            document.getElementById('tCalIfSince').checked = false;
            $("#tCalSince").combobox({required: false, onlyview: false});
            $("#tCalSince").combobox('setValue', '');
            $("#tCal").textbox({required: false});

            $("#tLimitedDay").datebox({disabled: false});
        }
    });
    //是否使用重检说明note
    $("#ivIfNote").change(function () {
        var ivIfNote = $("#ivIfNote").is(":checked");
        $("#ifTbd").attr("checked", false);
        ivIfNoteChange(ivIfNote);

    });

    $("#ifTbd").change(function () {
        var ifTdb = $("#ifTbd").is(":checked");
        $("#ivIfNote").attr("checked", false);
        ivIfNoteChange(ifTdb);

    });
    function ivIfNoteChange(ivIfNote){
        //清空
        b.splice(0, b.length);
        if (ivIfNote) {
            $("#ivIntervalRule").combobox({required: false, editable: false, onlyview: true});
            $("#ivIntervalRule").combobox('setValue', '');
            $("#ivFh").textbox('setValue', '');
            $("#ivFh").textbox({required: false, editable: false, onlyview: true});
            $("#ivFc").textbox('setValue', '');
            $("#ivFc").textbox({required: false, editable: false, onlyview: true});
            $("#ivCal").textbox('setValue', '');
            $("#ivCal").textbox({required: false, editable: false, onlyview: true});
            $("#ivCalUnit").combobox({required: false, editable: false, onlyview: true});
            $("#ivCalUnit").combobox('setValue', '');
            if($("#ivIfNote").is(":checked")){
                $("#intervalDesc").textbox({editable: true, onlyview: false, multiline: true});
                $("#intervalDesc").textbox('setValue', '');
            }
            if($("#ifTbd").is(":checked")){
                $("#intervalDesc").textbox({editable: false, onlyview: true});
                $("#intervalDesc").textbox('setValue', 'TBD');
            }
        } else {
            $("#intervalDesc").textbox({editable: false, onlyview: true, multiline: true});
            $("#intervalDesc").textbox('setValue', '');
            $("#ivIntervalRule").combobox({required: false, onlyview: false});
            $("#ivIntervalRule").combobox('setValue', '');
            $("#ivFh").textbox({required: false, editable: true, onlyview: false});
            $("#ivFc").textbox({required: false, editable: true, onlyview: false});
            $("#ivCal").textbox({required: false, editable: true, onlyview: false});
            $("#ivCalUnit").combobox({required: false, onlyview: false});
            $("#ivCalUnit").combobox('setValue', '');
        }
    }
    //是否选中tFhIfSince
    $("#tFhIfSince").change(function () {
        var tFhIfSince = $("#tFhIfSince").is(":checked");
        var tFh = $("#tFh").textbox("getValue");
        var tFhSince = $("#tFhSince").combobox("getValue");
        if (tFhIfSince) {
            if (tFh == "") {
                $("#tFh").textbox({required: true});
            }
            // if (tFhSince == "") {
            //     $("#tFhSince").combobox({required: true});
            // }
        } else {
            if (tFh == "") {
                $("#tFh").textbox({required: false});
            }
            $("#tFhSince").combobox({required: false});
            fhChange();
        }
    });
    //是否选中tFcIfSince
    $("#tFcIfSince").change(function () {
        var tFcIfSince = $("#tFcIfSince").is(":checked");
        var tFc = $("#tFc").textbox("getValue");
        var tFcSince = $("#tFcSince").combobox("getValue");
        if (tFcIfSince) {
            if (tFc == "") {
                $("#tFc").textbox({required: true});
            }
            // if (tFcSince == "") {
            //     $("#tFcSince").combobox({required: true});
            // }
        } else {
            if (tFc == "") {
                $("#tFc").textbox({required: false});
            }
            $("#tFcSince").combobox({required: false});
            fcChange();
        }
    });
    //是否选中tCalIfSince
    $("#tCalIfSince").change(function () {
        var tCalIfSince = $("#tCalIfSince").is(":checked");
        var tCal = $("#tCal").textbox("getValue");
        var tCalSince = $("#tCalSince").combobox("getValue");
        if (tCalIfSince) {
            if (tCal == "") {
                $("#tCal").textbox({required: true});
            }
            // if (tCalSince == "") {
            //     $("#tCalSince").combobox({required: true});
            // }
        } else {
            if (tCal == "") {
                $("#tCal").textbox({required: false});
            }
            $("#tCalSince").combobox({required: false});
            tcalChange();
        }
    });

    //用于验证单位必填
    function ivCal(a, b) {
        if (a) {
            $('#ivCalUnit').combobox({required: true});
        } else {
            $('#ivCalUnit').combobox({required: false});
        }

    }

    function tCal(a, b) {
        if (a) {
            $('#tCalUnit').combobox({required: true});
        } else {
            $('#tCalUnit').combobox({required: false});
        }

    }

    function ivCheck(a, b) {
        if (a) {
            $('#ivCheckUnit').combobox({required: true});
        } else {
            $('#ivCheckUnit').combobox({required: false});
        }

    }


    //用于回填首重检描述的值
    var a = [];
    var b = [];

    function tIntervalRuleChange() {
        var value = $("#tIntervalRule").combobox("getValue");
        index = 0;
        if (value == '') {
            var v = '';
            $('#thresholdDesc').textbox({value: v});
            a[index] = value;
        }else {
            a[index] = value=="F"?"先到为准":"后到为准";
        }
        var v = '';
        $.each(a, function (k, item) {
            if (item == " ") {
                v = v;
            } else {
                v += item ? item + "\r\n" : '';
            }
        });
        $('#thresholdDesc').textbox({value: v});
    }

    function fhChange() {
        index = 1;
        //获取FH
        var tFh = $("#tFh").textbox("getValue");
        tFh = tFh ? tFh + ('FH') : '';
        var tFhSince = $("#tFhSince").combobox("getValue");
        //当tFhSince不为空，则勾选上checkbox，并且设置tfh为必填
        if (tFhSince != "") {
            //since对应值有且只能选择一次
            var tFcSince = $("#tFcSince").combobox("getValue");
            var tCalSince = $("#tCalSince").combobox("getValue");
            if(tFcSince !=""||tCalSince!=""){
                MsgAlert({content: 'since对应值有且只能选择一次', type: 'error'});
                $("#tFhSince").combobox("setValue",'');
                return;
            }
            document.getElementById('tFhIfSince').checked = 'checked';
            if (tFh == "") {
                $("#tFh").textbox({required: true});
            }
        }
        tFh = tFh + ($("#tFhIfSince").is(":checked") ? " Since " : " ") + tFhSince;
        // tFh = tFh + ' ' + "Since" + ' ' + tFhSince;
        a[index] = tFh;
        var v = '';
        $.each(a, function (k, item) {
            if (item == " ") {
                v = v;
            } else {
                v += item ? item + "\r\n" : '';
            }
        });
        $('#thresholdDesc').textbox({value: v});

    }

    function fcChange() {
        index = 2;
        //获取FC
        var tFc = $("#tFc").textbox("getValue");
        tFc = tFc ? tFc + ('FC') : '';
        var tFcSince = $("#tFcSince").combobox("getValue");
        //当tFcSince不为空，则勾选上checkbox，并且设置tfh为必填
        if (tFcSince != "") {
            //since对应值有且只能选择一次
            var tFhSince = $("#tFhSince").combobox("getValue");
            var tCalSince = $("#tCalSince").combobox("getValue");
            if(tFhSince !=""||tCalSince!=""){
                MsgAlert({content: 'since对应值有且只能选择一次', type: 'error'});
                $("#tFcSince").combobox("setValue",'');
                return;
            }
            document.getElementById('tFcIfSince').checked = 'checked';
            if (tFc == "") {
                $("#tFc").textbox({required: true});
            }
        }
        tFc = tFc + ($("#tFcIfSince").is(":checked") ? " Since " : " ") + tFcSince;
        // tFc = tFc + ' ' + "Since" + ' ' + tFcSince;
        a[index] = tFc;
        var v = '';
        $.each(a, function (k, item) {
            if (item == " ") {
                v = v;
            } else {
                v += item ? item + "\r\n" : '';
            }
        });
        $('#thresholdDesc').textbox({value: v});
    }

    function tcalChange() {
        index = 3;
        //获取tCal
        var tCal = $("#tCal").textbox("getValue");
        var tCalUnit = $("#tCalUnit").combobox("getValue");
        //当录入参数3时，需选择对应单位
        if (tCal != "" || tCalUnit != "") {
            $("#tCalUnit").combobox({required: true, value: tCalUnit});
            $("#tCal").textbox({required: true});
        } else {
            $("#tCalUnit").combobox({required: false, value: ""});
            $("#tCal").textbox({required: false});
        }
        var tCalSince = $("#tCalSince").combobox("getValue");
        //当tCalSince不为空，则勾选上checkbox，并且设置tfh为必填
        if (tCalSince != "") {
            //since对应值有且只能选择一次
            var tFcSince = $("#tFcSince").combobox("getValue");
            var tFhSince = $("#tFhSince").combobox("getValue");
            if(tFhSince !=""||tFcSince!=""){
                MsgAlert({content: 'since对应值有且只能选择一次', type: 'error'});
                $("#tCalSince").combobox("setValue",'');
                return;
            }
            document.getElementById('tCalIfSince').checked = 'checked';
            if (tCal == "") {
                $("#tCal").textbox({required: true});
            }
        }
        tCal = tCal + tCalUnit + ($("#tCalIfSince").is(":checked") ? " Since " : " ") + tCalSince;
        // tCal = tCal + tCalUnit + ' ' + "Since" + ' ' + tCalSince;
        a[index] = tCal;
        var v = '';
        $.each(a, function (k, item) {
            if (item == " ") {
                v = v;
            } else {
                v += item ? item + "\r\n" : '';
            }
        });
        $('#thresholdDesc').textbox({value: v});
    }

    function tLimitedDayChange(value) {
        index = 4;
        //获取tCal
        var tLimitedDay = $("#tLimitedDay").datebox("getValue");
        a[index] = tLimitedDay;
        var v = '';
        $.each(a, function (k, item) {
            if (item == " ") {
                v = v;
            } else {
                v += item ? item + "\r\n" : '';
            }
        });
        $('#thresholdDesc').textbox({value: v});
    }

    function ivIntervalRule() {
        var value = $("#ivIntervalRule").combobox("getValue");
        index = 0;
        if (value == '') {
            var v = '';
            $('#intervalDesc').textbox({value: v});
            b[index] = value;
        }else {
            b[index] = value=="F"?"先到为准":"后到为准";
        }
        var v = '';
        $.each(b, function (k, item) {
            if (item == " ") {
                v = v;
            } else {
                v += item ? item + "\r\n" : '';
            }
        });
        $('#intervalDesc').textbox({value: v});
    }

    function ivFhChange(value) {
        index = 1;
        //获取ivFh
        var ivFh = $("#ivFh").textbox("getValue");
        ivFh = ivFh ? ivFh + ('FH') : '';
        b[index] = ivFh;
        var v = '';
        $.each(b, function (k, item) {
            if (item == " ") {
                v = v;
            } else {
                v += item ? item + "\r\n" : '';
            }
        });
        $('#intervalDesc').textbox({value: v});

    }

    function ivFcChange(value) {
        index = 2;
        //获取ivFc
        var ivFc = $("#ivFc").textbox("getValue");
        ivFc = ivFc ? ivFc + ('FC') : '';
        b[index] = ivFc;
        var v = '';
        $.each(b, function (k, item) {
            if (item == " ") {
                v = v;
            } else {
                v += item ? item + "\r\n" : '';
            }
        });
        $('#intervalDesc').textbox({value: v});
    }

    function ivCalChange(value) {
        index = 3;
        //获取ivCal
        var ivCal = $("#ivCal").textbox("getValue");
        var ivCalUnit = $("#ivCalUnit").combobox("getValue");
        //当录入参数3时，需选择对应单位
        if (ivCal != "" || ivCalUnit != "") {
            $("#ivCal").textbox({required: true});
            $("#ivCalUnit").combobox({required: true, value: ivCalUnit});
        } else {
            $("#ivCal").textbox({required: false});
            $("#ivCalUnit").combobox({required: false, value: ""});
        }
        ivCal = ivCal + ivCalUnit;
        b[index] = ivCal;
        var v = '';
        $.each(b, function (k, item) {
            if (item == " ") {
                v = v;
            } else {
                v += item ? item + "\r\n" : '';
            }
        });
        $('#intervalDesc').textbox({value: v});
    }

    //回显数据
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "EM_MPD_EVAL_INTERVAL_PKID"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    $('#tIntervalRule').combobox({value: jdata.data.T_INTERVAL_RULE});
                    $('#tCalUnit').combobox({value: jdata.data.T_CAL_UNIT});
                    $('#ivCalUnit').combobox({value: jdata.data.IV_CAL_UNIT});
                    $('#ivIntervalRule').combobox({value: jdata.data.IV_INTERVAL_RULE});
                    $('#tFhSince').combobox({value: jdata.data.T_FH_SINCE});
                    $('#tFcSince').combobox({value: jdata.data.T_FC_SINCE});
                    $('#tCalSince').combobox({value: jdata.data.T_CAL_SINCE});

                    if (jdata.data.T_FH_IF_SINCE == "Y") {
                        $("#tFhIfSince").attr("checked", true);
                    }
                    if (jdata.data.T_FC_IF_SINCE == "Y") {
                        $("#tFcIfSince").attr("checked", true);
                    }
                    if (jdata.data.T_CAL_IF_SINCE == "Y") {
                        $("#tCalIfSince").attr("checked", true);
                    }
                    if (jdata.data.T_IF_NOTE == "Y") {
                        $("#tIfNote").attr("checked", true);
                        $("#tIfNote").change();
                        $("#thresholdDesc").textbox('setValue', jdata.data.THRESHOLD_DESC);
                    }
                    if (jdata.data.IV_IF_NOTE == "Y") {
                        $("#ivIfNote").attr("checked", true);
                        $("#ivIfNote").change();
                        $("#intervalDesc").textbox('setValue', jdata.data.INTERVAL_DESC);
                    }
                    if (jdata.data.IF_TBD == "Y") {
                        $("#ifTbd").attr("checked", true);
                        $("#ifTbd").change();
                        $("#intervalDesc").textbox('setValue', jdata.data.INTERVAL_DESC);
                    }
                }
            }
        });
    }
    function InitEditForm_() {
        var $form = $("#mform");
        $form.form({
            onSubmit: function () {
                //var datas = $form.serializeObject();
                isEdit_ = param.isEdit || $("#pkid").val();
                var data = $form.serializeObject();
                if (!isEdit_ || $("#pkid").val()) {
                    data.evalNo = evalNo;
                }
                data = $.extend({}, data, {
                    FunctionCode: (isEdit_ ? 'EM_MPD_EVAL_INTERVAL_EDIT' : 'EM_MPD_EVAL_INTERVAL_ADD')
                });
                InitFuncCodeRequest_({
                    data: data,
                    successCallBack: function (jdata) {
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                            if (!isEdit_) {
                                alertMassage();
                            } //弹出信息提示首次加间隔需要录入适用性
                            $('#ZJ').removeAttr("disabled");
                            $('#YL').removeAttr("disabled");
                            setTimeout(reload_(), 100);
                            param.OWindow.reloadg3();
                            $("#pkid").val(jdata.data.pkid);
                            param.isEdit = 1;
                            // MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        } else {
                            MsgAlert({content: jdata.msg, type: 'error'});
                        }
                    }
                });
                return false;
            }
        });
    }

    //关闭窗口
    function closeAdd() {
        $.messager.confirm('', '是否关闭', function (r) {
            if (r) {
                subMitData();
                CloseWindowIframe();
                param.OWindow.reload_();
                $("#dg2").form('clear');
            }
        });
    }

    //预览适用性
    function viewAppl() {
        ShowWindowIframe({
            width: 830,
            height: 370,
            param: {evalNo: evalNo, appltype: appltype, fleet: fleet},
            title: "增加适用性",
            url: "/views/em/emmpdeval/em_mpdeval.previewApp.shtml"
        });
    }

    function alertMassage() {
        $.messager.confirm('', '数据保存成功，若为新增数据，请至少增加一条适用性！', function (r) {
            if (r) {
            }
        });
    }

    //后一页面保存成功后自动保存前一页面
    function subMitData() {
        setTimeout($("#mform").submit(), 1000);
    }

    /** 刷新列表数据 */
    function reload_(timeS) {
        /* if(timeS==1){
             subMitData();
         }*/
        // filetheappldesc();
        param.OWindow.reloadg3();
        // InitDataGrid();//后一页面加载成功时重新初始化页面数据
        $("#dg2").datagrid("reload");
    }

    function addappl() {
        if (pkid == -1) {
            pkid = $("#pkid").val();
        }
        ShowWindowIframe({
            width: 830,
            height: 370,
            param: {pkid: pkid, fleet: fleet},
            title: "增加适用性",
            url: "/views/em/emmpdeval/em_mpdeval.addApp.shtml"
        });
    }

    function viewappl() {
        ShowWindowIframe({
            width: 1000,
            height: 540,
            param: {pkid: pkid},
            title: "增加预览",
            url: "/views/em/emmpdeval/em_mpdeval.previewApp.shtml"
        });
    }

    function evalMemo() {
        ShowWindowIframe({
            width: 1100,
            height: 550,
            param: {},
            title: "评估",
            url: "/views/em/emmpdeval/em.mpdeval.evalnote.shtml"
        });
    }

    function saveCheck() {
        var isValidate = $("#mform").form('validate');
        var $form = $("#mform");
        var datas = $form.serializeObject();
        var t=0;
        var iv=0;
        if (!isValidate)
            return true;
        //判断首检说明和重检说明是否有值
        var thresholdDesc = $("#thresholdDesc").textbox("getValue");
        var intervalDesc = $("#intervalDesc").textbox("getValue");
        if (thresholdDesc == "" || intervalDesc == "") {
            MsgAlert({content: '首检、重检说明存在空值!', type: 'error'});
            return true;
        } else {
            //首检校验
            if (datas.tFh !=""){
                t=t+1;
            }
            if (datas.tFc !=""){
                t=t+1;
            }
            if (datas.tCal !=""){
                t=t+1;
            }
            if (datas.tLimitedDay !=""){
                t=t+1;
            }
            if (datas.tIntervalRule!=""){
                if (t<2){
                    MsgAlert({content: '单个参数不允许选择首检类型!', type: 'error'});
                    return true;
                }
            }else{
                if (t>1){
                    MsgAlert({content: '多个参数需选择首检类型!', type: 'error'});
                    return true;
                }
            }
            //重检校验
            if (datas.ivFh !=""){
                iv=iv+1;
            }
            if (datas.ivFc !=""){
                iv=iv+1;
            }
            if (datas.ivCal !=""){
                iv=iv+1;
            }
            if (datas.ivIntervalRule!=""){
                if (iv<2){
                    MsgAlert({content: '单个参数不允许选择重检类型!', type: 'error'});
                    return true;
                }
            }else{
                if (iv>1){
                    MsgAlert({content: '多个参数需选择重检类型!', type: 'error'});
                    return true;
                }
            }
            //save();
        }
        if (datas.tCal != "" || datas.tCalUnit != "") {
            if (datas.tCal == "" || datas.tCalUnit == "") {
                MsgAlert({content: '【首检参数3】、【首检参数3单位】必须选择!', type: 'error'});
                return true;
            }
        }
        if (datas.ivCal != "" || datas.ivCalUnit != "") {
            if (datas.ivCal == "" || datas.ivCalUnit == "") {
                MsgAlert({content: '【间隔参数3】、【间隔参数3单位】必须选择!', type: 'error'});
                return true;
            }
        }
        return false;
    }
    //保存
    function save() {
        if (saveCheck()) {
            return;
        }
        var $form = $("#mform");
        var datas = $form.serializeObject();
        //判断该间隔类型是否已存在。
        var dataCheck;
        var intervalType = $("#intervalType").val();
        if (pkid) {
            dataCheck = $.extend({}, {
                evalNo: evalNo,
                intervalType: intervalType,
                pkid: pkid
            }, {FunctionCode: 'EM_MPD_EVAL_INTERVAL_EDIT_CHECK'});
        } else {
            dataCheck = $.extend({}, {
                evalNo: evalNo,
                intervalType: intervalType
            }, {FunctionCode: 'EM_MPD_EVAL_INTERVAL_ADD_CHECK'});
        }
        InitFuncCodeRequest_({
            data: dataCheck, async: false, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data.length > 0) {
                        MsgAlert({content: '已存在该间隔类型，不可重复添加', type: 'error'});

                    } else {
                    var $tFhIfSince = document.getElementById('tFhIfSince');
                    var $tFcIfSince = document.getElementById('tFcIfSince');
                    var $tCalIfSince = document.getElementById('tCalIfSince');
                    var $tIfNote = document.getElementById('tIfNote');
                    var $ivIfNote = document.getElementById('ivIfNote');
                    var $ifTbd = document.getElementById('ifTbd');
                    var datas = $form.serializeObject();
                    datas.tFhIfSince = $tFhIfSince.checked ? "Y" : "N";
                    datas.tFcIfSince = $tFcIfSince.checked ? "Y" : "N";
                    datas.tCalIfSince = $tCalIfSince.checked ? "Y" : "N";
                    datas.tIfNote = $tIfNote.checked ? "Y" : "N";
                    datas.ivIfNote = $ivIfNote.checked ? "Y" : "N";
                    datas.ifTbd = $ifTbd.checked ? "Y" : "N";
                    datas = $.extend({}, datas, {FunctionCode: 'EM_MPD_EVAL_INTERVAL_SAVE'});
                    InitFuncCodeRequest_({
                        data: datas, successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                pkid = jdata.data.pkid;
                                $("#pkid").val(jdata.data.pkid);
                                reload_('wholeTable');
                                param.OWindow.reloadg2_();
                            } else {
                                MsgAlert({content: jdata.msg, type: 'error'});
                            }
                        }
                    });
                }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }
    $.extend($.fn.validatebox.defaults.rules, {
        positive: {
            //正数且保留两位小数
            validator: function(value, param){
                if( /^(?!0+(?:\.0+)?$)(?:[1-9]\d*|0)(?:\.\d{1,2})?$/.test(value) ){
                    return true;
                } else {
                    return false;
                }
                // return value.length >= param[0];
            },
            message: '请输入正数'
        }
    });
</script>
</html>


