<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="emmpdeval">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title data-i18n="">MPD评估</title>
    <style>
        a {
            color: #0000cc;
            font-weight: bold;
        }

        .datagrid-toolbar table {
            float: right;
        }

        .datagrid-mask-msg {
            position: fixed;
            /*margin-top: -20px;*/
            padding: 5px 5px 5px 5px;
            width: auto;
            height: 16px;
            border-width: 2px;
            border-style: solid;
            display: none;
            background: #ffffff;
            border-color: #D4D4D4;
            /*opacity: 0.7;*/
        }

        .datagrid-mask {
            position: fixed;
            /*left: 0;*/
            /*top: 0;*/
            width: 100%;
            height: 100%;
            opacity: 0; /*透明度*/
            filter: alpha(opacity=30);
            display: none;
        }

        span1{
            color:red;

        }


    </style>

</head>
<body class="ibody">
<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <input type="hidden" id="checker" name="checker">
                <input type="hidden" id="count" name="count">
                <input type="hidden" id="ifPse" name="ifPse">
                <input type="hidden" id="docType" name="docType">
                <input type="hidden" id="docSource" name="docSource">
                <input type="hidden" id="pkid" name="pkid">
                <!--<input type="hidden" id="fleet" name="fleet">-->
                <input type="hidden" id="itemPkid" name="itemPkid">
                <input type="hidden" id="docVer" name="docVer">
                <input type="hidden" id="ata" name="ata">
                <input type="hidden" id="evalNo" name="evalNo">
                <input type="hidden" id="evalBy" name="evalBy">
                <input type="hidden" id="evalState" name="evalState">
                <input type="hidden" id="itemNumber" name="itemNumber">
                <input type="hidden" id="ifLatest" name="ifLatest">
                <input type="hidden" id="createDate" name="createDate">
                <input type="hidden" id="mpdNo" name="mpdNo">
                <input type="hidden" id="ifApproval" name="ifApproval">
                <table class="table table-bordered table-info">
                    <table class="table table-bordered table-info">
                        <tr>

                            <th class="td1" style="width:80px">修订标识：</th>
                            <td class="tdr">
                                <input class="easyui-textbox" id="revCode1" name="revCode1"
                                       style="width:100px"
                                       data-options="required:true,editable:false,onlyview:false"/>
                                <input class="easyui-textbox" id="revCode" name="revCode"
                                       style="width:100px"/>
                                <span id="preview"></span>
                                <span style="color:red">点击项目号，可查看与前版具体差异</span>
                            </td>
                            <td class="tdr">
                            </td>
                            <td id="baocun" align="right" style="width:20% ">
                                <input class="btn btn-primary" type="button" id="submit" onclick="save()" value="保存"/>
                                <input class="btn btn-primary" type="button" id="submitFlow" onclick="checkIfAppl('a')"
                                       value="提交校对"/>
                                <input class="btn btn-primary" type="button" id="close" onclick=" CloseWindowIframe()"
                                       value="关闭"/>
                            </td>
                        </tr>
                    </table>
                    <fieldset class="fieldset_eui" style="width:99%;margin-right:5px">
                        <legend data-i18n="">评估小结</legend>
                        <table class="table table-bordered table-info">
                            <tr>
                                <th class="tdl" style="width:150px">是否适用：</th>
                                <td class="tdr">
                                    <input class="easyui-combobox" id="ifAppl" name="ifAppl"
                                           style="width:130px"
                                           data-options="required:true,onChange:changeIfAppl,editable: false"/>
                                </td>
                                <th class="tdl" style="width:100px">是否修订MP：</th>
                                <td class="tdr">
                                    <input class="easyui-combobox" id="ifRevCmp" name="ifRevCmp"
                                           style="width:160px"
                                           data-options="required:true,onChange:changeIfRevCmp,editable: false"/>
                                </td>
                                <th class="tdl" style="width:100px">MP编号：</th>
                                <td class="tdr">
                                    <input class="easyui-textbox" id="cmpNo" name="cmpNo"
                                           style="width:180px"
                                           data-options="required:true"/>
                                </td>
                                <th class="tdl" style="width:100px">顺丰原编号：</th>
                                <td class="tdr">
                                    <input class="easyui-textbox" id="sfnItemNumber" name="sfnItemNumber"
                                           style="width:129px"
                                           data-options="required:false,editable: false,onlyview:true"/>
                                </td>
                            </tr>
                            <tr>
                                <th class="tdl" style="width:150px">是否合并：</th>
                                <td class="tdr">
                                    <input class="easyui-combobox" id="ifMerge" name="ifMerge"
                                           style="width:130px"
                                           data-options="onChange:ifMerge,editable: false,onlyview:true"/>
                                </td>
                                <th class="tdl" style="width:100px">合并到MP编号：</th>
                                <td class="tdr">
                                    <input class="easyui-textbox" id="mergeTo" name="mergeTo"
                                           style="width:160px"
                                           data-options="onChange:changeMergeTo,onlyview:true,editable:false"/>
                                    <a href="javascript:" id="openCmpNoList" onclick="openCmpNoList();"
                                       class="easyui-linkbutton"
                                       iconCls="icon-search"></a>
                                </td>
                                <th class="tdl" style="width:150px">机队：</th>
                                <td class="tdr" colspan="3">
                                    <input class="easyui-textbox" id="fleet" name="fleet"
                                           data-options="editable: false,onlyview:true "
                                           style="width:180px"/>
                                </td>
                            </tr>
                            <tr>
                                <th class="tdl" style="width:150px">评估意见：</th>
                                <td class="tdr" colspan="3">
                                    <input class="easyui-textbox" id="evalNote" name="evalNote"
                                           data-options="required:true,multiline:true "
                                           style="height:60px;width:550px;"/>
                                </td>
                                <th class="tdl" style="width:100px">评估小结：</th>
                                <td class="tdr" colspan="3">
                                    <input class="easyui-textbox" id="evalSummary" name="evalSummary"
                                           data-options="multiline:true,editable:false,onlyview:true "
                                           style="height:60px;  width:435px;"/>
                                </td>

                            </tr>
                            <tr>
                                <th id="againEva" class="tdl" align="right">设定重评：</th>
                                <td class="tdr">
                                    <input class="easyui-combobox" id="ifAgainEva" data-options="required:true"
                                           name="ifAgainEva"
                                           style="width:130px;"/>
                                </td>
                                <th id="again1" class="tdl" align="right">重评时间：</th>
                                <td id="again2" class="tdr">
                                    <input class="easyui-datebox" style="width:163px;" id="againEvaDate" name="againEvaDate"
                                           data-options="editable:false"/>
                                </td>
                                <th id="again3" class="tdl" align="right">重评间隔：</th>
                                <td id="again4" class="tdr" colspan="3">
                                    <input class="easyui-textbox" id="againEvaInterval"
                                           name="againEvaInterval" data-options="editable:true,events:{blur:checkNum}"/>天
                                </td>
                            </tr>
                            <tr id="again5">
                                <th class="tdl">设定重评原因：</th>
                                <td class="tdr" colspan="7">
                                    <textarea class="easyui-textbox" id="againEvaReason" name="againEvaReason"
                                              data-options="multiline:true"
                                              style="height:60px;width: 1160px;border: 1px solid #ddd;border-radius: 5px;"></textarea>
                                </td>
                            </tr>
                            <tr>
                                <th class="tdl" style="width:150px">修订说明：</th>
                                <td class="tdr" colspan="7">
                                    <input class="easyui-textbox" name="revCnDesc" id="revCnDesc"
                                           data-options="required:true,multiline:true "
                                           style="height:60px; width:1160px;"/>
                                </td>
                            </tr>
                            <tr>
                                <th class="tdl" style="width:150px">HIGHTLIGHT：</th>
                                <td class="tdr" colspan="7">
                                    <input class="easyui-textbox" name="hightlight" id="hightlight"
                                           data-options="required:false,multiline:true,editable:false,onlyview:true "
                                           style="height:60px; width:1160px;"/>
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                    <div id="div2">
                        <fieldset class="fieldset_eui" style="width:99%;margin-right:5px">
                            <legend data-i18n="">MP信息</legend>
                            <table class="table table-bordered table-info">
                                <tr>
                                    <th class="tdl" style="width:110px">项目分类：</th>
                                    <td class="tdr">
                                        <input class="easyui-combobox" id="itemType" name="itemType"
                                               style="width:100px"
                                               data-options="required:true,stopFirstChangeEvent:true,onChange:changeItemType,editable: false"/>
                                    </td>
                                    <th class="tdl" style="width:100px">适用性类型：</th>
                                    <td class="tdr">
                                        <input class="easyui-combobox" id="applType" name="applType"
                                               style="width:120px"
                                               data-options="required:true,stopFirstChangeEvent:true,onChange:changeApplType,editable: false"/>
                                    </td>
                                    <th class="tdl" id="ctlTypeTh" style="width:100px">控制类型：</th>
                                    <td class="tdr" id="ctlTypeTd">
                                        <input class="easyui-combobox" id="ctlType" name="ctlType"
                                               style="width:120px"
                                               data-options="required:true,editable: false"/>
                                    </td>

                                    <th class="tdl" id="ctlTypeMonitorTh" style="width:100px">机会类型：</th>
                                    <td class="tdr" id="ctlTypeMonitorTd">
                                        <input class="easyui-combobox" id="ctlTypeMonitor" name="ctlTypeMonitor"
                                               style="width:120px"
                                               data-options="required:true,editable: false"/>
                                    </td>
                                    <th class="tdl" id="limitTypeTh" style="width:100px">时控类型：</th>
                                    <td class="tdr" id="limitTypeTd">
                                        <input class="easyui-combobox" id="limitType" name="limitType"
                                               style="width:120px"
                                               data-options="required:true,onChange:changeLimitType,editable: false"/>
                                    </td>

                                    <th class="tdl" id="ratioTh" style="width:150px">Engine LLP Ratio：</th>
                                    <td class="tdr" id="goCycleTd">
                                        <input class="easyui-textbox" id="goCycle" name="goCycle"
                                               style="width:80px"
                                               data-options="required:true"/>:
                                        <input class="easyui-textbox" id="normalCycle" name="normalCycle"
                                               style="width:50px"
                                               data-options="required:true"/>
                                    </td>
                                </tr>
                                <tr>
                                    <!-- <th class="tdl" id="ammRefTh" style="width:100px">参考手册：</th>
                                     <td class="tdr" id="ammRefTd">
                                         <input class="easyui-textbox" id="ammRef" name="ammRef"
                                                style="width:120px"
                                                data-options=""/>
                                     </td>-->
                                    <!--<th class="tdl" id="engLocationTh" style="width:100px">发动机位置：</th>
                                    <td class="tdr" id="engLocationTd">
                                        <input class="easyui-combobox" id="engLocation"
                                               name="engLocation"
                                               style="width:120px"
                                               data-options=""/>-->
                                    </td>
                                    <th id="standardMhth" class="tdl" style="width:100px">CAT：</th>
                                    <td id="standardMhtd" class="tdr">
                                        <input class="easyui-textbox" id="cat" name="cat"
                                               style="width:120px"
                                               data-options=""/>
                                    </td>

                                    <th class="tdl" id="zoneTh" style="width:100px">ZONE：</th>
                                    <td class="tdr" id="zoneTd">
                                        <input class="easyui-textbox" id="zone" name="zone"
                                               style="width:120px"
                                               data-options=""/>
                                    </td>
                                    <div id="zoneStr">
                                        <th class="tdl"  id="zoneBindTh" style="width:100px">ZONE：</th>
                                        <td class="tdr" id="zoneBindTd">
                                            <input id="zoneBind" class="easyui-combotree"    data-options="multiple:true"  style="width:120px">
                                            <input id="zoneSaveId" class="btn btn-primary" type="button" onclick="bindZoneSave()" value="挂接"
                                                   style="width: 60px;margin:5px;"/>
                                        </td>
                                    </div>

                                    <th class="tdl" id="monitorStatusTh" style="width:100px"> 监控状态：</th>
                                    <td class="tdr" id="monitorStatusTd">
                                        <input class="easyui-combobox" id="monitorStatus"
                                               name="monitorStatus"
                                               style="width:120px"
                                               data-options="required:true,editable: false"/>
                                    </td>
                                    <th class="tdl" id="repairLevalTh" style="width:100px"> 修理级别：</th>
                                    <td class="tdr" id="repairLevalTd">
                                        <input class="easyui-combobox" id="repairLeval"
                                               name="repairLeval"
                                               style="width:120px"
                                               data-options="required:true,editable: false"/>
                                    </td>
                                </tr>
                                <tr>
                                    <th class="tdl" style="width:90px">PGM：</th>
                                    <td class="tdr">
                                        <input class="easyui-combobox" id="pgm" name="pgm"
                                               data-options=""
                                               style="width:120px"/>
                                    </td>
                                    <!--<th class="tdl" style="width:90px">接近盖板：</th>
                                    <td class="tdr">
                                        <input class="easyui-textbox" id="accesses" name="accesses"
                                               data-options=""
                                               style="width:120px"/>
                                    </td>-->
                                    <th class="tdl" style="width:90px">理论工时：</th>
                                    <td class="tdr">
                                        <input class="easyui-textbox" id="manHours" name="manHours"
                                               data-options=""
                                               style="width:120px"/>
                                    </td>
                                    <th class="tdl" style="width:90px">工作类型：</th>
                                    <td class="tdr">
                                        <input class="easyui-textbox" id="taskCode" name="taskCode"
                                               data-options="editable: false"
                                               style="width:120px"/>
                                    </td>
                                    <th class="tdl" id="executeRequireTh" style="width:100px"> 执行要求：</th>
                                    <td class="tdr" id="executeRequireTd">
                                        <input class="easyui-combobox" id="executeRequire"
                                               name="executeRequire"
                                               style="width:120px"
                                               data-options="required:true,editable: false"/>
                                    </td>
                                    <td colspan="4"></td>
                                </tr>
                                <tr>
                                    <th class="tdl" style="width:90px">SOURCE：</th>
                                    <td class="tdr" colspan="9">
                                        <input class="easyui-textbox" id="sources" name="sources"
                                               data-options="editable:false,onlyview:true"
                                               style="height:30px;width:1095px;"/>
                                        <a id="sourceSelect" href="javascript:void(0)" class="easyui-linkbutton"
                                           data-options="iconCls:'icon-add'"
                                           onclick="addSource()"><span>选择</span></a>
                                    </td>
                                </tr>

                                <tr>
                                    <th class="tdl" style="width:90px">英文描述：</th>
                                    <td class="tdr" colspan="9">
                                        <input class="easyui-textbox" id="enTaskDesc" name="enTaskDesc"
                                               data-options="required:true,multiline:true "
                                               style="height:60px;width: 98%"/>
                                    </td>
                                </tr>


                                <tr>
                                    <th class="tdl" style="width:100px">中文描述：</th>
                                    <td class="tdr" colspan="9">
                                        <input class="easyui-textbox" name="chTaskDesc" id="chTaskDesc"
                                               data-options="required:true,multiline:true "
                                               style="height:60px; width:98%;"/>
                                    </td>
                                </tr>
                                <tr>
                                    <th class="tdl" style="width:76px">是否过渡：</th>
                                    <td class="tdr">
                                        <input class="easyui-combobox" id="ifTmp" name="ifTmp"
                                               style="width:60px"
                                               data-options="onChange:changeFormatForGuodu,stopFirstChangeEvent:true,editable: false"/>
                                    </td>
                                </tr>
                                <tr id="guodu1">

                                    <th class="tdl" style="width:80px">过渡FH：</th>
                                    <td class="tdr">
                                        <input class="easyui-textbox" id="tmpFh" name="tmpFh"
                                               style="width:120px"
                                               data-options="required: false,editable: true,onlyview:true"/>
                                    </td>
                                    <th class="tdl" style="width:80px">过渡FC：</th>
                                    <td class="tdr">
                                        <input class="easyui-textbox" id="tmpFc" name="tmpFc"
                                               style="width:120px"
                                               data-options="required: false,editable: true"/>
                                    </td>

                                    <th class="tdl" style="width:80px">过渡日历日：</th>
                                    <td class="tdr">
                                        <input class="easyui-textbox" id="tmpCal" name="tmpCal"
                                               style="width:80px"
                                               data-options="required: false,editable: true"/>

                                        <input class="easyui-combobox" id="tmpCalUnit"
                                               name="tmpCalUnit"
                                               style="width:60px"
                                               data-options="required: false,editable: true"/>
                                    </td>
                                    <th class="tdl" style="width:100px">过渡监控方法：</th>
                                    <td class="tdr">
                                        <input class="easyui-combobox" id="tmpIntervalRule"
                                               name="tmpIntervalRule" style="width:80px"
                                               data-options="required: false,editable: true"/>
                                    </td>
                                </tr>
                                <tr id="guodu3">

                                    <th class="tdl" style="width:80px">过渡级别(仅部件)：</th>
                                    <td class="tdr">
                                        <input class="easyui-combobox" id="tempLevel" name="tempLevel"
                                               style="width:120px"
                                               data-options="required: false,editable: true"/>
                                    </td>
                                    <th class="tdl" style="width:80px">过渡截止日期：</th>
                                    <td class="tdr">
                                        <input class="easyui-datebox" id="tempLimitDate" name="tempLimitDate"
                                               style="width:120px"
                                               data-options="required: false,editable: true"/>
                                    </td>
                                </tr>
                                <tr id="guodu2">
                                    <th class="tdl" style="width:100px">过渡要求：</th>
                                    <td class="tdr" colspan="3">
                                        <input class="easyui-textbox" name="tmpRequire" id="tmpRequire"
                                               data-options="multiline:true ,required: false,editable: true"
                                               style="height:60px; width:480px;"/>
                                    </td>
                                    <th class="tdl" style="width:100px">过渡对象：</th>
                                    <td class="tdr" colspan="5">
                                        <input class="easyui-textbox" name="tmpFleets" id="tmpFleets"
                                               data-options="multiline:true,editable:false,onlyview:true "
                                               style="height:60px; width:450px;"/>
                                        <a href="javascript:void(0)" class="easyui-linkbutton"
                                           data-options="iconCls:'icon-add'"
                                           onclick="addTmpFleet()"><span>选择</span></a>
                                    </td>
                                </tr>

                                <tr>
                                    <th class="tdl" style="width:110px;" nowrap>MARK信息：</th>
                                    <td class="tdr" colspan="9">
                                        <input class="easyui-textbox" id="attachOption" name="attachOption"
                                               data-options="multiline:true,editable:false,onlyview:true"
                                               style="height:30px;width:1095px;"/>
                                        <a id="xz" href="javascript:void(0)" class="easyui-linkbutton"
                                           data-options="iconCls:'icon-add'"
                                           onclick="addAttachOption()"><span>选择</span></a>
                                    </td>
                                </tr>
                                <tr>
                                    <th class="tdl" style="width:100px">备注：</th>
                                    <td class="tdr" colspan="9">
                                        <input class="easyui-textbox" name="memo" id="memo"
                                               data-options="required:false,multiline:true "
                                               style="height:60px;width:1165px;"/>
                                    </td>
                                </tr>
                            </table>
                            <div id="zoneInfo">
                                <table id='zoneList'  style="width:100%;height:200px">
                                </table>
                            </div>
                            <!--                            <div id="structuralEeZoneListMenu" class="easyui-menu" style="width: 100px;">
                                                            <div  id="structuralEeZoneListDel" onclick="deleteStruEEZone()" >删除</div>
                                                            <input id="structuralEeZoneListDelView" class="btn btn-primary view-menu" value="删除" disabled/>
                                                        </div>-->
                            <table id="dg"></table>
                        </fieldset>
                    </div>
                    <div id="div4">
                        <fieldset class="fieldset_eui" style="float:left;width:90%;height:230px; margin-right:5px">
                            <legend data-i18n="" id="intervalDgText">维修间隔--机身</legend>
                            <table cellspacing="0" cellpadding="2">
                            </table>
                            <table id="intervalDg"></table>
                        </fieldset>
                    </div>
                    <div id="div6">
                        <fieldset class="fieldset_eui" style="float:left;width:100%;height:230px; margin-right:5px">
                            <legend data-i18n="" id="applicabilityDgText">适用性--机身 <span1 color='red'>（多组适用性取合集）</span1></legend>
                            <table cellspacing="0" cellpadding="2">
                            </table>
                            <table id="applicabilityDg"></table>
                        </fieldset>
                    </div>
                    <div id="div7">
                        <fieldset class="fieldset_eui" style="float:left;width:100%;height:230px; margin-right:5px">
                            <legend data-i18n="">工卡关联关系</legend>
                            <table cellspacing="0" cellpadding="2">
                            </table>
                            <table id="jobCardDg"></table>
                        </fieldset>
                    </div>
                    <div id="tt" class="easyui-tabs" style="float:left;width:100%;height:300px;margin-right:5px">
                        <div title="替代项目" style="display:none;">
                            <table id="replaceItemDg"></table>
                        </div>
                        <div title="历史评估记录" style="display:none;">
                            <table class="table table-bordered table-info">

                            </table>
                            <table id="lspg"></table>
                        </div>
                    </div>
                </table>
                <table id="wholeTable"></table>
            </form>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<!--<script type="text/javascript" src="/js/common.js"></script>-->
<script type="text/javascript">
    var PAGE_DATA = {};
    var param;
    var isUdf, isEdit;
    var evalNo;
    var intervalDgFunctionCode;
    var applicabilityDgFunctionCode;
    var fleet;
    var revCode;
    var type;
    var isItemType;
    var isApplType = false;
    var ifBxDic;
    var msgData;
    var fleetPass;
    var EM_MPD_CTL_TYPE2;
    var EM_MPD_CTL_TYPE;
    var modelType;//子机型
    var asmsPro;

    function i18nCallBack() {
        param = getParentParam_();
        type = param.type;
        fleetPass = param.fleetPass;
        msgData = param.msgData;
        if (msgData) {
            evalNo = param.recordId;
        } else {
            evalNo = param.evalNo;
        }
        $("#openCmpNoList").hide();
        $("#revCode").next().hide();
        InitFuncCodeRequest_({
            data: {
                domainCode: "EM_MPD_PGM,EM_MPD_CTL_TYPE2,EM_MPD_EXECUTE_REQUIRE,EM_APL_INTERVAL_TYPE,EM_IF_APPL,EM_IF_REV_CMP,EM_APPL_TYPE,EM_MPD_ITEM_TYPE,EM_ENG_LOCATION,EM_MPD_CTL_TYPE,EM_MPD_IF_TMP,EM_MP_UNIT,EM_INTERVAL_RULE," +
                "EM_MPD_CTL_TYPE_MONITOR,EM_CTL_TYPE_MONITOR,EM_RANGE_TYPE,EM_LIMIT_TYPE,EM_MPD_REPAIR_LEVAL,YESORNO,EM_MONITOR_STATUS,EM_MPD_EVAL_TASK,EM_MPD_REV_CODE,EM_MPD_EVAL_TASK_FOR_737",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#ifAgainEva').combobox({
                        panelHeight: '50px',
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        data: jdata.data.YESORNO,
                        onSelect: function (data) {
                            againChange(data.VALUE);
                        }
                    });
                    //执行要求
                    $('#executeRequire').combobox({
                        panelHeight: '135px',
                        data: jdata.data.EM_MPD_EXECUTE_REQUIRE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //型号
                    // PAGE_DATA['acengModel'] = DomainCodeToMap_(jdata.data["DA_FLEET"]);
                    $('#repairLeval').combobox({
                        panelHeight: '135px',
                        data: jdata.data.EM_MPD_REPAIR_LEVAL,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //间隔类型
                    $('#monitorStatus').combobox({
                        panelHeight: '135px',
                        data: jdata.data.EM_MONITOR_STATUS,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#limitType').combobox({
                        panelHeight: '135px',
                        data: jdata.data.EM_LIMIT_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#ifAppl').combobox({
                        panelHeight: '135px',
                        data: jdata.data.EM_IF_APPL,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#ifRevCmp').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_IF_REV_CMP,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    $('#applType').combobox({
                        panelHeight: '120px',
                        width: 120,
                        data: jdata.data.EM_APPL_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#itemType').combobox({
                        panelHeight: '120px',
                        width: 120,
                        data: jdata.data.EM_MPD_ITEM_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#pgm').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_MPD_PGM,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    // if (isEmpty(isEdit)) {
                    //     $('#applType').combobox("setValue", "APL");
                    // }
                    /* $('#engLocation').combobox({
                         panelHeight: '100px',
                         data: jdata.data.EM_ENG_LOCATION,
                         valueField: 'VALUE',
                         textField: 'TEXT'
                     });*/
                    var isCtlType = true;
                    $('#ctlType').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_MPD_CTL_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onChange(newVal, oldVal) {
                            // alert(newVal+"+"+oldVal+isCtlType)
                            var revCode = $("#revCode").textbox("getValue");
                            if (revCode == "R") {
                                //改版系统禁止 定检项目、机会项目’调整成‘航线项目、无需控制’
                                if (isCtlType) {
                                    isCtlType = false;
                                    return;
                                }
                                if (newVal == 'CHECK') {
                                    if (oldVal == 'LINE') {
                                        MsgAlert({content: "改版条目不可将航线项目切换成定检项目！", type: 'error'});
                                        isCtlType = true;
                                        $('#ctlType').combobox("select", oldVal);

                                        return;
                                    }
                                    if (oldVal == 'NONE') {
                                        MsgAlert({content: "改版条目不可将无需控制切换成定检项目！", type: 'error'});
                                        isCtlType = true;
                                        $('#ctlType').combobox("setValue", oldVal);

                                        return;
                                    }

                                }
                                if (newVal == 'MON') {
                                    if (oldVal == 'LINE') {
                                        MsgAlert({content: "改版条目不可将航线项目切换成机会项目！", type: 'error'});
                                        isCtlType = true;
                                        $('#ctlType').combobox("setValue", oldVal);

                                        return;
                                    }
                                    if (oldVal == 'NONE') {
                                        MsgAlert({content: "改版条目不可将无需控制切换成机会项目！", type: 'error'});
                                        isCtlType = true;
                                        $('#ctlType').combobox("setValue", oldVal);

                                        return;
                                    }

                                }

                                if (newVal == 'LINE') {
                                    if (oldVal == 'CHECK') {
                                        MsgAlert({content: "改版条目不可将定检项目切换成航线项目！", type: 'error'});
                                        isCtlType = true;
                                        $('#ctlType').combobox("select", oldVal);

                                        return;
                                    }
                                    if (oldVal == 'MON') {
                                        MsgAlert({content: "改版条目不可将机会项目切换成航线项目！", type: 'error'});
                                        isCtlType = true;
                                        $('#ctlType').combobox("setValue", oldVal);

                                        return;
                                    }

                                }

                                if (newVal == 'NONE') {
                                    if (oldVal == 'CHECK') {
                                        MsgAlert({content: "改版条目不可将定检项目切换成无需控制！", type: 'error'});
                                        isCtlType = true;
                                        $('#ctlType').combobox("setValue", oldVal);

                                        return;
                                    }
                                    if (oldVal == 'MON') {
                                        MsgAlert({content: "改版条目不可将机会项目切换成无需控制！", type: 'error'});
                                        isCtlType = true;
                                        $('#ctlType').combobox("setValue", oldVal);

                                        return;
                                    }

                                }
                                changeCtlType();
                            } else {
                                changeCtlType();
                            }

                        }
                    });
                    EM_MPD_CTL_TYPE = jdata.data.EM_MPD_CTL_TYPE;
                    EM_MPD_CTL_TYPE2 = jdata.data.EM_MPD_CTL_TYPE2;
                    $('#ctlTypeMonitor').combobox({
                        panelHeight: '100px',
                        panelWidth: '120px',
                        data: jdata.data.EM_CTL_TYPE_MONITOR,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#ifTmp').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_MPD_IF_TMP,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    jdata.data.EM_MP_UNIT.unshift({TEXT: "-select-", VALUE: ""});
                    $('#tmpCalUnit').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_MP_UNIT,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    jdata.data.EM_INTERVAL_RULE.unshift({TEXT: "-select-", VALUE: ""});
                    $('#tmpIntervalRule').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_INTERVAL_RULE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#ifMerge').combobox({
                        panelHeight: '100px',
                        data: jdata.data.YESORNO,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#tempLevel').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_MPD_REPAIR_LEVAL,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
//                    jdata.data.EM_MPD_EVAL_TASK_FOR_737.unshift({TEXT: "-select-", VALUE: ""});
//                    jdata.data.EM_MPD_EVAL_TASK.unshift({TEXT: "-select-", VALUE: ""});
                    $('#taskCode').combobox({
                        panelHeight: '100px',
                        data: fleetPass == "B737" ? jdata.data.EM_MPD_EVAL_TASK_FOR_737 : jdata.data.EM_MPD_EVAL_TASK,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //当状态为流程编辑时，隐藏提交流程和关闭按钮
                    if (type == "flowEdit") {
                        $("#submitFlow").hide();
                        $("#close").hide();
                    }
                    PAGE_DATA['intervalType'] = DomainCodeToMap_(jdata.data["EM_APL_INTERVAL_TYPE"]);
                    PAGE_DATA['rangeType'] = DomainCodeToMap_(jdata.data["EM_RANGE_TYPE"]);
                    PAGE_DATA['yesorno'] = DomainCodeToMap_(jdata.data["YESORNO"]);
                    PAGE_DATA['emMpdRevCode'] = DomainCodeToMap_(jdata.data["EM_MPD_REV_CODE"]);
                    PAGE_DATA['taskCode'] = fleetPass == "B737" ? DomainCodeToMap_(jdata.data["EM_MPD_EVAL_TASK_FOR_737"]) : DomainCodeToMap_(jdata.data["EM_MPD_EVAL_TASK"]);
                    ifBxDic = jdata.data["YESORNO"];
                    $("#evalNo").val(evalNo);
                    // 初始化隐藏控件
                    $("#ctlTypeMonitorTh").hide();
                    $("#ctlTypeMonitorTd").hide();
                    $("#ctlTypeMonitor").combobox({required: false});
                    $("#limitTypeTh").hide();
                    $("#limitTypeTd").hide();
                    $("#limitType").combobox({required: false});
                    $("#ratioTh").hide();
                    $("#goCycleTd").hide();
                    $("#goCycle").textbox({required: false});
                    $("#normalCycle").textbox({required: false});
                    //隐藏修理级别
                    $("#repairLevalTh").hide();
                    $("#repairLevalTd").hide();
                    $("#repairLeval").combobox({required: false});
                    //隐藏执行要求
                    $("#executeRequireTh").hide();
                    $("#executeRequireTd").hide();
                    $("#executeRequire").combobox({required: false});
                    //隐藏间隔类型
                    $("#monitorStatusTh").hide();
                    $("#monitorStatusTd").hide();
                    $("#monitorStatus").combobox({required: false});
                    //设置需要过渡为否，并且禁用相关控件
                    // $('#ifTmp').combobox('setValue', 'N');
                    //维修间隔表格初始化
                    intervalDgFunctionCode = "EM_MPD_EVAL_INTERVAL_APL_LIST";
                    //InitIntervalDgGrid();
                    //适用性表格初始化
                    applicabilityDgFunctionCode = "EM_MPD_EVAL_APPLIC_APL_LIST";
                    //关联关系表格初始化
                    InitJobCardDgGrid();

                    //InitApplicabilityDgGrid();
                    InitDataForm();
                    //初始化评估历史
                    InitDataGrid5();
                    //初始化替代项目
                    InitDataGrid6();
                    //项目差异超链接
                    listPreview();
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }

            }
        });

        queryAsmsConfigUrl(); //查询ASMS地址
        initZoneList(); //区域信息
    }
    $('#zone').textbox({
        inputEvents: $.extend({}, $.fn.textbox.defaults.inputEvents, {
            mouseover: function (event) {
                var msg = $(this).val();
                if (msg) {
                    var zone = document.getElementById("zoneTd");
                    var pos = zone.getBoundingClientRect();
                    $("body").append("<div id='textboxDiv' style='height:20px'></div>");
                    var id = "#textboxDiv";
                    var left = pos.left + 128;
                    var top = pos.bottom - 15;
                    var height = 20;
                    $("<div class=\"datagrid-mask\"></div>").css({
                        display: "block",
                        width: "100%",
                        height: height
                    }).appendTo(id);
                    $("<div class=\"datagrid-mask-msg\"></div>").html(msg).appendTo(id).css({
                        display: "block",
                        left: left,
                        top: top
                    });
                }
            },
            mouseout: function (event) {
                $("#textboxDiv").remove();
            }
        })
    });

    function getTop(e) {
        var offset = e.offsetTop;
        if (e.offsetParent != null) offset += getTop(e.offsetParent);
        return offset;
    }

    function listPreview() {
        InitFuncCodeRequest_({
            data: {evalNo: evalNo, FunctionCode: "EM_MPD_PREVIEW_SOURCE"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    var html = "";
                    for (var i = 0; i < jdata.data.length; i++) {
                        html += '<a href="javascript:void(0)" onclick="chakan(\''+jdata.data[i].TYPE+"\','" + jdata.data[i].SOURCE_NO + '\')" style="width:100px"> ' + jdata.data[i].SOURCE_NO + '</a>';
                    }
                    document.getElementById("preview").innerHTML = html;
                }
            }
        });
    }

    function changeLimitType() {
        var applType = $('#applType').combobox('getValue');
        var limitType = $('#limitType').combobox('getValue');
        if (applType == "PART" && limitType == "LLP") {
            $("#ratioTh").show();
            $("#goCycleTd").show();
        } else {
            $("#ratioTh").hide();
            $("#goCycleTd").hide();
        }
    }

    //维修间隔
    function InitIntervalDgGrid() {
        $("#intervalDg").MyDataGrid({
            identity: 'intervalDg',
            sortable: true,
            singleSelect: true,
            pageSize: 15,
            queryParams: {evalNo: evalNo},
            pagination: false,
            resize: function () {
                return tabs_standard_resize($('#tt'), 0.10, 0.01, 10, -6);
            },
            columns: {
                // param: {FunctionCode: intervalDgFunctionCode},
                param: {FunctionCode: "EM_MPD_EVAL_INTERVAL_APL_LIST"},
                alter: {
                    INTERVAL_TYPE: {
                        formatter: function (value) {
                            return PAGE_DATA['intervalType'][value];
                        }
                    }
                }
            },
            onLoadSuccess: function () {

            },
            validAuth: function (row, items) {
                items['编辑'].enable = true;
                items['删除'].enable = true;
                return items;
            },
            contextMenus: [
                {
                    id: "m-edit",
                    i18nText: "编辑",
                    onclick: function () {
                        var rowData = getDG('intervalDg').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        addInteval('edit', rowData.PKID);
                    }
                },
                {
                    id: "",
                    i18nText: "删除",
                    onclick: function () {
                        var rowData = getDG('intervalDg').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (confirm("是否确认删除？")) {
                            InitFuncCodeRequest_({
                                data: {FunctionCode: 'EM_MPD_INTERVAL_DELETE', pkid: rowData.PKID},
                                successCallBack: function (jdata) {
                                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                        MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                        reloadg2_();
                                    }
                                }
                            });
                        }
                    }
                }
            ],
            toolbar: [{
                id: 'btnAdd',
                text: $.i18n.t('增加'),
                iconCls: 'icon-add',
                handler: function () {
                    addInteval('add', '');
                }
            }],
            onClickRow: function (rowIndex, rowData) {
            },
            onDblClickRow: function (index, field, value) {
                addInteval('view', value.PKID);
            }
        });
    }

    //适用性
    function InitApplicabilityDgGrid() {
        $("#applicabilityDg").MyDataGrid({
            identity: 'applicabilityDg',
            sortable: true,
            singleSelect: true,
            fit: true,
            //pagination: false,
            resize: function () {
                return tabs_standard_resize($('#tt'), 0.10, 0.01, 10, -6);
            },
            queryParams: {evalNo: evalNo},
            //pageSize: 15,
            columns: {
                // param: {FunctionCode: applicabilityDgFunctionCode},
                param: {FunctionCode: "EM_MPD_EVAL_APPLIC_APL_LIST"},

                alter: {
                    RANGE_TYPE: {
                        formatter: function (value) {
                            return PAGE_DATA['rangeType'][value];
                        }
                    }
                }
            },
            onLoadSuccess: function () {
            },
            validAuth: function (row, items) {
            },
            contextMenus: [
                {
                    id: "m-edit",
                    i18nText: "编辑",
                    onclick: function () {
                        var rowData = getDG('applicabilityDg').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        editApplic('edit', rowData.RANGE_TYPE, rowData.PKID);
                    }
                },
                {
                    id: "",
                    i18nText: "删除",
                    onclick: function () {
                        var rowData = getDG('applicabilityDg').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (confirm("是否确认删除？")) {
                            InitFuncCodeRequest_({
                                data: {FunctionCode: 'EM_MPD_EVAL_APPLIC_DEL', pkid: rowData.PKID},
                                successCallBack: function (jdata) {
                                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                        MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                        reloadg3();
                                    }
                                }
                            });
                        }
                    }
                }
            ],
            toolbar: [{
                id: 'btnAdd',
                text: $.i18n.t('增加'),
                iconCls: 'icon-add',
                handler: function () {
                    addApplic('add', '');
                }
            }, {
                id: 'btnView',
                text: $.i18n.t('适用性预计算'),
                iconCls: 'icon-edit',
                handler: function () {
                    viewAppl();
                }
            },
                {
                    id: 'btnView2',
                    text: $.i18n.t('当前条目适用性查看'),
                    iconCls: 'icon-edit',
                    handler: function () {
                        viewApplCurrent();
                    }
                }
            ],
            onClickRow: function (rowIndex, rowData) {
            },
            onDblClickRow: function (index, field, value) {
                editApplic('view', value.RANGE_TYPE, value.PKID);
            }
        });
    }

    var isDisable = true;

    //工卡关联关系
    function InitJobCardDgGrid() {
        $("#jobCardDg").MyDataGrid({
            identity: 'jobCardDg',
            sortable: true,
            singleSelect: true,
            enableLineEdit: true,
            fit: true,
            // enableCellEdit: true,
            // pagination: false,
            resize: function () {
                return tabs_standard_resize($('#tt'), 0.10, 0.01, 10, -6);
            },
            queryParams: {evalNo: evalNo},
            // pageSize: 15,
            columns: {
                param: {FunctionCode: 'EM_MPD_JOB_CARD_LIST'},
                alter: {
                    CARD_NO: {
                        editor: {
                            type: 'textbox',
                        }
                    },
                    // IF_BX: {
                    //     editor: {
                    //         type: 'combobox',
                    //         options: {
                    //             data: ifBxDic,
                    //             panelHeight: '80px',
                    //             valueField: 'VALUE',
                    //             textField: 'TEXT',
                    //             singleSelect: true,
                    //         }
                    //     },
                    //     formatter: function (value) {
                    //         return PAGE_DATA['yesorno'][value];
                    //     }
                    // },
                    MEMO: {
                        editor: {
                            type: 'textbox',
                        }
                    },
                    REV_CODE: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['emMpdRevCode'][value];
                        }
                    }
                }
            },
            onLoadSuccess: function (data) {
            },
            validAuth: function (row, items) {
                //无需编卡
                if (row.REV_CODE == "M") {
                    items['无需编卡'].enable = false;
                    items['需要编卡'].enable = true;
                    items['改版'].enable = false;
                    items['作废'].enable = false;
                    items['取消变更'].enable = false;
                    items['删除'].enable = false;
                }

                //不变
                if (row.REV_CODE == "U") {
                    items['无需编卡'].enable = false;
                    items['需要编卡'].enable = false;
                    items['改版'].enable = true;
                    items['作废'].enable = true;
                    items['取消变更'].enable = true;
                    items['删除'].enable = false;
                }
                //改版
                if (row.REV_CODE == "R") {
                    items['无需编卡'].enable = false;
                    items['需要编卡'].enable = false;
                    items['改版'].enable = false;
                    items['作废'].enable = false;
                    items['取消变更'].enable = true;
                    items['删除'].enable = false;
                }
                //作废
                if (row.REV_CODE == "D") {
                    items['无需编卡'].enable = false;
                    items['需要编卡'].enable = false;
                    items['改版'].enable = true;
                    items['作废'].enable = false;
                    items['取消变更'].enable = true;
                    items['删除'].enable = false;
                }
                //来源MPD
                if (row.TC_NO) {
                    items['删除'].enable = false;
                    //启用D ->N
                    if (row.REV_CODE == "N") {
                        items['无需编卡'].enable = true;
                        items['需要编卡'].enable = false;
                        items['改版'].enable = false;
                        items['作废'].enable = false;
                        items['取消变更'].enable = false;
                    }

                } else {
                    //来源非MPD
                    if (row.REV_CODE == "N") {
                        items['无需编卡'].enable = false;
                        items['需要编卡'].enable = false;
                        items['取消变更'].enable = false;
                        items['作废'].enable = false;
                        items['改版'].enable = false;
                        items['删除'].enable = true;
                    }
                    if (!row.REV_CODE) {
                        items['无需编卡'].enable = false;
                        items['需要编卡'].enable = false;
                        items['取消变更'].enable = false;
                        items['作废'].enable = false;
                        items['改版'].enable = false;
                        items['删除'].enable = true;
                    }
                }
                return items;
            },
            onBeginEdit: function (index, row) {
                if (row.REV_CODE != "N" && row.REV_CODE != undefined) {
                    isDisable = true;
                    var ed1 = getDG('jobCardDg').datagrid('getEditor', {index: index, field: 'CARD_NO'});
                    $(ed1.target).textbox({editable: false, onlyview: true, required: false});
                } else {
                    isDisable = false;
                }

            },
            onEndEdit: function (index, row, changes) {
                //if (!isDisable) {
                editDate(index, row, changes);
                //}
                // if (row.REV_CODE != "N" && row.REV_CODE != undefined) {
                //     // MsgAlert({content: '', type: 'error'});
                // }else{
                //     editDate(index, row, changes);
                // }

            },
            contextMenus: [
                {
                    id: "m-ncard", i18nText: "无需编卡", auth: "",
                    onclick: function () {
                        var row = $('#jobCardDg').datagrid('getSelected');
                        var rowIndex = $('#jobCardDg').datagrid('getRowIndex', row);
                        revCode = "M";
                        InitFuncCodeRequest_({
                            data: {
                                pkid: row.PKID,
                                revCode: revCode,
                                FunctionCode: 'EM_MPD_JOB_CARD_REV_CODE'
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    reloadg4();
                                    // i18nCallBack();
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                },
                {
                    id: "m-card", i18nText: "需要编卡", auth: "",
                    onclick: function () {
                        var row = $('#jobCardDg').datagrid('getSelected');
                        var rowIndex = $('#jobCardDg').datagrid('getRowIndex', row);
                        revCode = "N";
                        InitFuncCodeRequest_({
                            data: {
                                pkid: row.PKID,
                                revCode: revCode,
                                FunctionCode: 'EM_MPD_JOB_CARD_REV_CODE'
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    reloadg4();
                                    // i18nCallBack();
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                },
                {
                    id: "m-rev", i18nText: "改版", auth: "",
                    onclick: function () {
                        var row = $('#jobCardDg').datagrid('getSelected');
                        var rowIndex = $('#jobCardDg').datagrid('getRowIndex', row);
                        revCode = "R";
                        InitFuncCodeRequest_({
                            data: {
                                pkid: row.PKID,
                                revCode: revCode,
                                FunctionCode: 'EM_MPD_JOB_CARD_REV_CODE'
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    reloadg4();
                                    // i18nCallBack();
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }, {
                    id: "m-start", i18nText: "取消变更", auth: "",
                    onclick: function () {
                        var row = $('#jobCardDg').datagrid('getSelected');
                        var rowIndex = $('#jobCardDg').datagrid('getRowIndex', row);
                        //仅针对本次修订中，用户已操作的修订标识变更进行回滚
                        InitFuncCodeRequest_({
                            data: {
                                pkid: row.PKID,
                                evalNo: evalNo,
                                FunctionCode: 'EM_MPD_JOB_CARD_CANCEL_CHANGE'
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    reloadg4();
                                    // i18nCallBack();
                                } else {
                                    MsgAlert({content: '系统错误', type: 'error'});
                                }
                            }
                        });
                    }
                }, {
                    id: "m-delete", i18nText: "作废", auth: "",
                    onclick: function () {
                        var row = $('#jobCardDg').datagrid('getSelected');
                        var rowIndex = $('#jobCardDg').datagrid('getRowIndex', row);
                        revCode = "D";
                        InitFuncCodeRequest_({
                            data: {
                                pkid: row.PKID,
                                revCode: revCode,
                                FunctionCode: 'EM_MPD_JOB_CARD_REV_CODE'
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    reloadg4();
                                    // i18nCallBack();
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }, {
                    id: "m-delete", i18nText: "删除", auth: "",
                    onclick: function () {
                        var row = $('#jobCardDg').datagrid('getSelected');
                        var rowIndex = $('#jobCardDg').datagrid('getRowIndex', row);
                        if (!row.PKID) {
                            //如果没有保存，直接在datagrid移除该行
                            $('#jobCardDg').datagrid('deleteRow', rowIndex);
                        } else {
                            InitFuncCodeRequest_({
                                data: {
                                    pkid: row.PKID,
                                    FunctionCode: 'EM_MPD_JOB_CARD_DEL'
                                },
                                successCallBack: function (jdata) {
                                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                        $('#jobCardDg').datagrid('deleteRow', rowIndex);
                                        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                        // reload_();
                                        // i18nCallBack();
                                    } else {
                                        MsgAlert({content: jdata.msg, type: 'error'});
                                    }
                                }
                            });
                        }
                    }
                }],
            toolbar: [{
                id: 'btnAdd',
                text: $.i18n.t('增加'),
                iconCls: 'icon-add',
                handler: function () {
                    addDatagridRow('add');
                }
            }
                , {
                    id: 'btnAddRef',
                    text: $.i18n.t('关联工卡'),
                    iconCls: 'icon-add',
                    handler: function () {
                        addJcRef();
                    }
                }
            ],
            onClickRow: function (rowIndex, rowData) {
            },
            onDblClickRow: function (index, field, value) {
                // openDetai("view", value.PKID);
            }
        });
    }

    function addJcRef() {
        var applType = $('#applType').combobox('getValue');
        if (!(applType == "PART")) {
            MsgAlert({content: '只有部件类型方可关联工卡。', type: 'error'});
            return;
        }
        ShowWindowIframe({
            width: 1000,
            height: 600,
            param: {evalNo: evalNo},
            url: "/views/em/emmpdeval/emMpdJcRelateNrcList.shtml"
        });
    }

    //行编辑事件
    function editDate(index, row, changes) {
        row = toCamelCase(row);
        // if (row.ifBx == "") {
        //     MsgAlert({content: $.i18n.t("【是否编卡】不能为空。")});
        //     return;
        // }
        // if (row.ifBx == "N" && row.memo == "") {
        //     MsgAlert({content: $.i18n.t("【是否编卡】为否，请填写备注信息。")});
        //     return;
        // }
        // if (row.ifBx == "N" && row.cardNo != "") {
        //     MsgAlert({content: $.i18n.t("【是否编卡】为否，不能填写工卡号。")});
        //     return;
        // }
        // if (row.ifBx == "Y" && row.cardNo == "") {
        //     MsgAlert({content: $.i18n.t("【是否编卡】为是，请填写工卡号。")});
        //     return;
        // }

        if (row.cardNo != "") {
            var jobCardDg = $("#jobCardDg").datagrid("getRows");
            for (var i = 0; i < jobCardDg.length, i != index; i++) {
                jobCardDg[i].CARD_NO = jobCardDg[i].CARD_NO.replace(/[]/g, "");
                if (jobCardDg[i].CARD_NO == row.cardNo) {
                    MsgAlert({content: $.i18n.t("【工卡号】重复，请重新填写工卡号。")});
                    return;
                }
            }
        }
        /*if(row.tcNo == ""){
            if(row.ifBx == "N"){
                MsgAlert({content: $.i18n.t("【TC号】为否，【是否编卡】必须为【是】。")});
                return;
            }
            if(row.cardNo == ""){
                MsgAlert({content: $.i18n.t("【TC号】为否，【工卡号】不为能空。")});
                return;
            }
        }*/
        var url = $.extend({}, {evalNo: evalNo}, row, {FunctionCode: 'EM_MPD_JOB_CARD_SAVE'});
        InitFuncCodeRequest_({
            data: url,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    reloadg4();
                }else{
                    MsgAlert({content: '其他评估单存在重复的工卡号，请重新编辑', type: 'error'});
                }
            }
        });

    }

    //是否适用  判断修订标识并提示
    function changeIfAppl() {
        //是否适用
        var d1 = $('#ifAppl').combobox('getValue');
        //是否修订MP
        var d2 = $('#ifRevCmp').combobox('getValue');
        if (d1 != "Y") {
            //去掉必填项
            $("#div2 [textboxname]").each(function (k, it) {

                if ($(it).hasClass("combobox-f")) {
                    $(it).combobox({required: false});
                } else if ($(it).hasClass("textbox-f")) {
                    $(it).textbox({required: false});
                } else {
                    $(it).datetimebox({required: false});
                }
            });
            //隐藏id为div2 的div
            $("#div2").hide();//CMP信息
            // $("#div3").hide();//部件信息--部件
            $("#div4").hide();//维修间隔--机身
            $("#div6").hide();
            // $("#div7").hide();//工卡关联关系
            //设置是否修订MP为否，并禁用

            // $("#ifRevCmp").combobox({editable: false, onlyview: true});
            // $("#ifRevCmp").combobox("setValue", "N");
            $("#ifMerge").combobox("setValue", "N");
        }
        if (d1 == "Y") {

            $("#ifRevCmp").combobox({editable: false, onlyview: false});
            d2 = $('#ifRevCmp').combobox('getValue');
            if (d2 == "Y") {
                $("#div2 [textboxname]").each(function (k, it) {
                    if($(it).hasClass("subType-info")){//子机型信息需要操作
                        $(it).combobox({required: false, onlyview: false});
                        return;
                    }
                    if ($(it).hasClass("combobox-f")) {
                        $(it).combobox({required: true, onlyview: false});
                    } else if ($(it).hasClass("textbox-f")) {
                        $(it).textbox({required: true, editable: true, onlyview: false});
                    } else {
                        $(it).datetimebox({required: true, editable: true, onlyview: false});
                    }
                });
                $('#enTaskDesc').textbox({editable: true, onlyview: false, required: false});
                //todo..
                changeFormatForGuodu();
            }
            // $("#ifRevCmp").combobox("setValue","N");
            $("#div2").show();
            $("#div4").show();//维修间隔--机身
            $("#div6").show();
            InitIntervalDgGrid();
            //$("#intervalDg").datagrid("reload");
            //$("#applicabilityDg").datagrid("reload");
            InitApplicabilityDgGrid();
            InitJobCardDgGrid();
        }
        //$("#engLocation").combobox({required: false});
        $("#cat").textbox({required: false});
        $("#zone").textbox({required: false});
        $("#pgm").combobox({required: false});
        //$("#accesses").textbox({required: false});
        $("#manHours").textbox({required: false});
        $("#taskCode").textbox({required: false});
        $("#goCycle").textbox({required: false});
        $("#normalCycle").textbox({required: false});
        $("#ctlTypeMonitor").combobox({required: false});
        $("#limitType").combobox({required: false});

        $("#repairLeval").combobox({required: false});
        $("#executeRequire").combobox({required: false});
        $("#monitorStatus").combobox({required: false});

        $('#attachOption').textbox({editable: false, onlyview: true, required: false});
        $('#chTaskDesc').textbox({editable: true, onlyview: false, required: false});
        $('#enTaskDesc').textbox({editable: true, onlyview: false, required: false});
        $('#sources').textbox({editable: false, onlyview: true, required: false});
        $('#memo').textbox({required: false});
    }

    //是否修订MP
    function changeIfRevCmp() {
        //修订mp
        var d1 = $('#ifRevCmp').combobox('getValue');
        //是否适用
        var d2 = $('#ifAppl').combobox('getValue');
        if (d2 == "Y") {
            if (d1 == "N") {
                $("#div2 [textboxname]").each(function (k, it) {
                    if ($(it).hasClass("combobox-f")) {
                        $(it).combobox({required: false, onlyview: true});
                    } else if ($(it).hasClass("textbox-f")) {
                        $(it).textbox({required: false, editable: false, onlyview: true});
                    }
                    // else {
                    //     $(it).datetimebox({required: false, editable: false, onlyview: true});
                    // }
                });

            }
            if (d1 == "Y") {
                $("#div2 [textboxname]").each(function (k, it) {
                    if($(it).hasClass("subType-info")){//子机型信息需要操作
                        $(it).combobox({required: false, onlyview: false});
                        return;
                    }
                    if ($(it).hasClass("combobox-f")) {
                        $(it).combobox({required: true, onlyview: false});
                    } else if ($(it).hasClass("textbox-f")) {
                        $(it).textbox({required: true, editable: true, onlyview: false});
                    }
                    // else {
                    //     $(it).datetimebox({required: true, editable: true, onlyview: false});
                    // }
                    //todo..
                    changeFormatForGuodu();
                });
                //$("#engLocation").combobox({required: false});
                $("#cat").textbox({required: false});
                $("#pgm").combobox({required: false});
                //$("#accesses").textbox({required: false});
                $("#manHours").textbox({required: false});
                $("#taskCode").textbox({required: false});
                $("#zone").textbox({required: false});
                $("#goCycle").textbox({required: false});
                $("#normalCycle").textbox({required: false});
                $("#limitType").combobox({required: false});
                $("#repairLeval").combobox({required: false});
                $("#executeRequire").combobox({required: false});
                $("#monitorStatus").combobox({required: false});
                $("#ctlTypeMonitor").combobox({required: false});
                $("#ctlType").combobox({required: true});
                // $('#enTaskDesc').textbox({editable: true, onlyview: false, required: false});
                changeZone();
            }

        } else {
            $("#div2 [textboxname]").each(function (k, it) {
                if ($(it).hasClass("combobox-f")) {
                    $(it).combobox({required: false, editable: false, onlyview: true});
                } else if ($(it).hasClass("textbox-f")) {
                    $(it).textbox({required: false, editable: false, onlyview: true});
                }
                // else {
                //     $(it).datetimebox({required: false, editable: false, onlyview: true});
                // }
            });

        }
        $('#attachOption').textbox({editable: false, onlyview: true, required: false});
        // $('#chTaskDesc').textbox({editable: true, onlyview: false, required: false});
        $('#sources').textbox({editable: false, onlyview: true, required: false});
        $('#memo').textbox({required: false});
        //默认机身
        // if($('#applType').combobox("getValue")==""){
        //     $('#applType').combobox("setValue","APL");
        // }
    }

    var applType = {};

    //项目分类和适用性类型联动
    function changeItemType() {
        var type;
        var itemType = $('#itemType').combobox('getValue');
        // 项目分类为“系统”时，适用性类型只能选择“机身”，“发动机”；  B
        // 项目分类为“结构”、“区域”时，适用性类型只能选择“机身”  A
        // 项目分类为“CPCP”时，适用性类型只能选择“机身”； A
        // 项目分类为“部件”时，适用性类型只能选择“部件” D
        if (itemType == "1") {
            type = "B";
        } else if (itemType == "2" || itemType == "3") {
            type = "A";
        } else if (itemType == "4") {
            type = "A";
        } else if (itemType == "5") {
            type = "D";
        }

        InitFuncCodeRequest_({
            data: {mark: type, FunctionCode: "EM_APPL_DOMAIN_TYPE"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    applType = jdata.data;
                    $('#applType').combobox({
                        panelHeight: '100px',
                        data: applType,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        // onChange:changeApplType
                    });
                    var options = $("#itemType").combobox('options');
                    if (isItemType) {
                        options.stopFirstChangeEvent = false;
                    }
                    if (options.stopFirstChangeEvent) {
                        options.stopFirstChangeEvent = false;
                    } else {
                        if (isApplType) {
                            $("#applType").combobox('setValue', 'APL');
                            isApplType = false;
                        }
                        var appl = $("#applType").combobox('getValue');
                        // if (appl==""){
                        //     $("#applType").combobox('setValue','APL');
                        // }
                        // $("#applType").combobox('clear');
                        $("#applType").combobox('setValue', '');
                    }
                }
            }
        });

        changeCtlType();
        changeZone();

    }

    function changeApplType() {

        //处理控件初始化问题
        var options = $(this).combobox('options');
        if (options.stopFirstChangeEvent) {
            options.stopFirstChangeEvent = false;
            // return;
        } else {
            $.messager.confirm('', '切换类型将清空间隔和适用性数据', function (r) {
                if (r) {
                    //删除适用性和间隔数据
                    InitFuncCodeRequest_({
                        data: {evalNo: evalNo, FunctionCode: "EM_MPD_CHANGE_APPLTYPE"},
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                changeApplType2();
                            }
                        }
                    });
                }
            });
        }

    }

    //适用性类型切换
    function changeApplType2() {

        var d5 = $('#applType').combobox('getValue');
        //部件
        if (d5 == "PART") {
            $("#div6").show();//显示适用性
            $("#intervalDgText").text(" 维修间隔--部件");
            $("#applicabilityDgText").html("适用性--部件 <span1 color='red'>（多组适用性取合集）</span1>");
            //维修间隔表格初始化
            InitIntervalDgGrid();
            //$("#intervalDg").datagrid("reload");
            //适用性表格初始化
            InitApplicabilityDgGrid();
            // $("#applicabilityDg").datagrid("reload");
            //隐藏控制类型、监控航线类型
            $("#ctlTypeTh").hide();
            $("#ctlTypeTd").hide();
            $("#ctlType").combobox({required: false});
            $("#ctlTypeMonitorTh").hide();
            $("#ctlTypeMonitorTd").hide();
            $("#ctlTypeMonitor").combobox({required: false});
            //显示时限类型
            $("#limitTypeTh").show();
            $("#limitTypeTd").show();
            $("#limitType").combobox({required: true});
            //隐藏参考手册、发动机位置
            //$("#ammRefTh").hide();
            //$("#ammRefTd").hide();
            //$("#ammRef").textbox({required: false});
            //$("#engLocationTh").hide();
            //$("#engLocationTd").hide();
            //$("#engLocation").combobox({required: false});
            //显示zone
            // $("#zoneTh").show();
            // $("#zoneTd").show();
            //显示修理级别
            $("#repairLevalTh").show();
            $("#repairLevalTd").show();
            $("#repairLeval").combobox({required: true});
            //显示执行要求
            $("#executeRequireTh").show();
            $("#executeRequireTd").show();
            $("#executeRequire").combobox({required: true});
            //显示间隔类型
            $("#monitorStatusTh").show();
            $("#monitorStatusTd").show();
            $("#monitorStatus").combobox({required: true});
            //显示zone
            changeZone();
        }
        //发动机
        if (d5 == "ENG") {
            $("#div6").show();//显示适用性
            $("#intervalDgText").text(" 维修间隔--发动机");
            $("#applicabilityDgText").html("适用性--发动机 <span1 color='red'>（多组适用性取合集）</span1>");
            //维修间隔表格初始化
            InitIntervalDgGrid();
            // $("#intervalDg").datagrid("reload");
            //适用性表格初始化
            InitApplicabilityDgGrid();
            // $("#applicabilityDg").datagrid("reload");
            //显示zone
            // $("#zoneTh").show();
            // $("#zoneTd").show();
            //隐藏修理级别
            $("#repairLevalTh").hide();
            $("#repairLevalTd").hide();
            $("#repairLeval").combobox({required: false});
            //隐藏执行要求
            $("#executeRequireTh").hide();
            $("#executeRequireTd").hide();
            $("#executeRequire").combobox({required: false});
            //隐藏间隔类型
            $("#monitorStatusTh").hide();
            $("#monitorStatusTd").hide();
            $("#monitorStatus").combobox({required: false});
            //显示参考手册、发动机位置
            //$("#ammRefTh").show();
            //$("#ammRefTd").show();
            //$("#engLocationTh").show();
            //$("#engLocationTd").show();
            //隐藏时限类型、Engine LLP Ratio
            $('#limitType').combobox('setValue', '');
            $("#limitTypeTh").hide();
            $("#limitTypeTd").hide();
            $("#limitType").combobox({required: false});
            $("#ratioTh").hide();
            $("#goCycleTd").hide();
            $("#goCycle").textbox({required: false});
            $("#normalCycle").textbox({required: false});
            $("#goCycle").textbox("setValue", '');
            $("#normalCycle").textbox("setValue", '');
            //显示控制类型
            $("#ctlTypeTh").show();
            $("#ctlTypeTd").show();
            $("#ctlType").combobox({required: true});
            $("#ctlTypeMonitor").combobox({required: false});
            //设置控制类型只能选择定检类型
            $('#ctlType').combobox({
                panelHeight: '100px',
                data: EM_MPD_CTL_TYPE2,
                valueField: 'VALUE',
                textField: 'TEXT'
            });
            //显示zone
            changeZone();
        }

        if (d5 == "APL") {
            $("#div6").show();//显示适用性
            $("#intervalDgText").text(" 维修间隔--机身");
            $("#applicabilityDgText").html("适用性--机身 <span1 color='red'>（多组适用性取合集）</span1>");
            //维修间隔表格初始化
            InitIntervalDgGrid();
            // $("#intervalDg").datagrid("reload");
            //适用性表格初始化
            InitApplicabilityDgGrid();
            // $("#applicabilityDg").datagrid("reload");
            //显示zone
            // $("#zoneTh").show();
            // $("#zoneTd").show();
            //隐藏修理级别
            $("#repairLevalTh").hide();
            $("#repairLevalTd").hide();
            $("#repairLeval").combobox({required: false});
            //隐藏执行要求
            $("#executeRequireTh").hide();
            $("#executeRequireTd").hide();
            $("#executeRequire").combobox({required: false});
            //隐藏间隔类型
            $("#monitorStatusTh").hide();
            $("#monitorStatusTd").hide();
            $("#monitorStatus").combobox({required: false});
            //显示参考手册、发动机位置
            //$("#ammRefTh").show();
            //$("#ammRefTd").show();
            //$("#engLocationTh").show();
            //$("#engLocationTd").show();
            // $("#engLocation").combobox({required:true});
            //隐藏时限类型、Engine LLP Ratio
            $('#limitType').combobox('setValue', '');
            $("#limitTypeTh").hide();
            $("#limitTypeTd").hide();
            $("#limitType").combobox({required: false});
            $("#ratioTh").hide();
            $("#goCycleTd").hide();
            $("#goCycle").textbox({required: false});
            $("#normalCycle").textbox({required: false});
            $("#goCycle").textbox("setValue", '');
            $("#normalCycle").textbox("setValue", '');
            //显示控制类型
            $("#ctlTypeTh").show();
            $("#ctlTypeTd").show();
            $("#ctlType").combobox({required: true});
            //设置监控航线
            $("#ctlTypeMonitor").combobox({required: false});
            $('#ctlType').combobox({
                panelHeight: '100px',
                data: EM_MPD_CTL_TYPE,
                valueField: 'VALUE',
                textField: 'TEXT'
            });
            //显示zone
            changeZone();

        }
    }

    function changeZone(){
        var itemType = $('#itemType').combobox('getValue');
        var sources = $("#sources").textbox("getValue");
        if( ( itemType=="2"|| itemType == "3" || itemType == "4")  &&
            sources.indexOf("DTE-") == -1){
            $("#zoneTh").hide();
            $("#zoneTd").hide();
            $("#zoneBindTh").show();
            $("#zoneBindTd").show();
            /*            $("#subTypeTh").show();
                        $("#subTypeTd").show();*/
            getModel(evalNo);
        }else{
            $("#zoneBindTh").hide();
            $("#zoneBindTd").hide();
            /*            $("#subTypeTh").hide();
                        $("#subTypeTd").hide();*/
            $("#zoneTh").show();
            $("#zoneTd").show();
        }
    }
    // 查询ASMS配置地址
    function queryAsmsConfigUrl(){
        $.ajax({
            type: "get",
            url: "/modelProperty/queryAsmsConfigUrl",
            contentType: "application/json;charset=utf-8",
            async:false,
            success: function (rst) {
                if (rst.code === 200) {
                    asmsPro = rst.data;
                }else {
                    MsgAlert({content: result.msg , type: 'error'});
                }
            },
            error: function (result) {
                alert("获取ASMS根路径失败！");
            }
        });
    }
    function getModel(evaNO) {
        $.ajax({
            type: "get",
            url: "/api/v1/em/emMpdEval/queryModelSeriesByModel/"+evaNO,
            contentType: "application/json;charset=utf-8",
            async: false,
            success: function (result) {
                if(!result.data || result.data.length == 0){
                    return;
                }
                //除737取737-400，其他只会返回一条记录
                var model = result.data[0];
                if(model =="B737-300"){
                    model = "B737-400";
                }
                modelType = model;
                getZoneTreeInfo(model)
            },
            error: function (data) {
                MsgAlert({content: "字机型信息查询失败！", type: 'error'});
            }
        })
    }

    function getZoneTreeInfo(model){
        $("#zoneBind").combotree('clear');
        $.ajax({
            type: "get",
            url:asmsPro+ "/zone/queryZoneTree/"+model,
            contentType: "application/json;charset=utf-8",
            async: false,
            success: function (data) {
                var data = data.result;

                data.forEach(function(item){
                    item.id = item.UUID;
                    item.text=item.Name;
                    item.children = item.ChildZone;
                    item.children.forEach(function(val){
                        val.id = val.UUID;
                        val.text=val.Name;
                        val.children = val.ChildZone;
                        val.children.forEach(function(child){
                            child.id = child.UUID;
                            child.text=child.Name;
                        })
                    })
                });
                $("#zoneBind").combotree('loadData',data);
                getSelectZoneList(evalNo,"MP","query");
            },
            error: function (data) {

            }
        })
    }



    /**
     *  功能描述:  获取转换后的区域
     *     1、判断是否一级区域，为是时，判断一级下的三级是否全部选中，全部选中，区域显示为一级；部分没选中，没选中一级下的二级的显示三级，其他的显示二级。
     *     2、判断是否为二级区域，为是时，判断二级下的三级是否全部选中，全部选中，区域显示为二级；存在一条没选中，显示三级。不是一级、二级区域时，显示为三级。
     */
    function getChangeZone(){
        var zone = $('#zoneBind').combotree('tree').tree('getChecked');
        var zoneTree = $('#zoneBind').combotree('tree');
        if(!zone || zone.length == 0){
            MsgAlert({content: "请先选择区域", type: 'error'});
            return;
        }
        cmpNo = $("#cmpNo").textbox('getValue');
        var changeZone = [];
        for(var i in zone){
            var first = zone[i];
            var firstChildZone = first.ChildZone;
            var firstArr = [];
            if( ( first.Type != "zoneFirst" && (!firstChildZone || firstChildZone.length == 0))
                || first.Type != "zoneFirst"){
                //过滤父级被选中的数据
                var parent = zoneTree.tree('getParent', first.target);
                if(!parent){
                    continue;
                }
                if (parent.checked){
                    continue;
                }
            }else{
                firstArr = getChildZone(firstChildZone,zoneTree);
            }
            var zoneFirst = { "Name": first.Name, "Type": first.Type, "UUID": first.UUID,"ChildZone": firstArr};
            changeZone.push(zoneFirst);
        }
        var zones = [];
        for(var i in changeZone){
            zones.push(changeZone[i].UUID);
        }
        return zones.join(',');
    }


    /**
     *  功能描述: 过滤子级区域
     *  01379392(王大桥)
     *  2020/6/5
     * @return
     */
    function  getChildZone(firstChildZone,zoneTree){
        var firstArr = [];
        for(var j in firstChildZone){
            var sencod = firstChildZone[j];
            var sencodArr = [];
            var sencodChildZone = sencod.ChildZone;
            var parent = zoneTree.tree('getParent', sencod.target);
            //过滤父级被选中的数据
            if(!parent){
                continue;
            }
            if (parent.checked){
                continue;
            }
            if(!sencodChildZone || sencodChildZone.length == 0){
                var zoneSencod = { "Name":sencod.Name,"Type":sencod.Type,"UUID":sencod.UUID, "ChildZone":[] };
                firstArr.push(zoneSencod);
                continue;
            }
            for(var k in sencodChildZone){
                var three = sencodChildZone[j];
                var zoneThree = { "Name":three.Name,"Type":three.Type, "UUID":three.UUID};
                sencodArr.push(zoneThree);
            }
            var zoneSencod = {"Name":sencod.Name, "Type":sencod.Type,"UUID":sencod.UUID, "ChildZone":sencodArr};
            firstArr.push(zoneSencod)
        }
        return firstArr;
    }


    //挂接区域
    function bindZoneSave(){
        var zone = $('#zoneBind').combotree('getValues');
        if(!zone ||zone==''){
            MsgAlert({content: "请先选择区域", type: 'error'});
            return;
        }
        cmpNo = $("#cmpNo").textbox('getValue');
        var zoneVo = {
            "businessNo":cmpNo,
            "businessId":evalNo ,
            "businessType": "MP",
            "subType": modelType,
            "zoneThirdList":zone
        };
        $.ajax({
            type: "post",
            url: asmsPro + "/relation/business/insertZoneModelBySubtype",
            contentType: "application/json;charset=utf-8",
            async: false,
            data:JSON.stringify(zoneVo),
            dataType: "json",
            success: function (data) {
                getSelectZoneList(evalNo,"MP","action");

            },
            error: function (data) {

            }
        })
    }
    //查询已选择区域
    function getSelectZoneList(id,type,oprate){
        $.ajax({
            type: "get",
            url: asmsPro + "/relation/zone/selectZoneInfoByBusinessId/" + id + '/' + type,
            contentType: "application/json;charset=utf-8",
            async: false,
            dataType: "json",
            success: function (data) {
                if(data.result.length){
                    $("#zoneInfo").show();
                    $("#zoneList").datagrid("loadData",{ rows:data.result });
                    var zoneNew = [];
                    var rows = data.result;
                    for (var i in rows) {
                        if (zoneNew.indexOf(rows[i].zoneThird) > -1) {
                            continue;
                        }
                        zoneNew.push(rows[i].zoneThird);
                    }
                    if (oprate === "action") {
                        var zone = getChangeZone();
                        updateZone(zone)
                    }
                    $('#zoneBind').combotree('setValues',zoneNew);
                }else{
                    if (oprate === "action") {
                        $('#zoneBind').combotree('setValues', []);//全部删除区域置空
                    }
                    $("#zoneInfo").hide();
                }
            },
            error: function (data) {

            }
        })

    }

    function updateZone(zone) {
        $.ajax({
            type: "get",
            url: "/api/v1/em/emMpdEval/updateZone/"+evalNo+"/"+zone,
            contentType: "application/json;charset=utf-8",
            async: true,
            success: function (result) {
                $("#zone").textbox('setValue', zone);
            },
            error: function (data) {
            }
        })
    }

    function initZoneList() {
        $("#zoneList").datagrid({
            columns: [[
                {field:'model', title: '机型', width: "100"},
                {field:'subType', title: '子机型', width: "130"},
                {field:'zoneFirst', title: '一级区域', width:"100"},
                {field:'zoneSecond', title: '二级区域', width: "100"},
                {field:'zoneThird', title: '三级区域', width: "100"},
                {field:'remark', title: '备注', width: "150"},
            ]],
            rownumbers:true,
            singleSelect:true,
            // fitColumns:true,
            onLoadSuccess:function(data){
            },
            onRowContextMenu: onRowContextZoneMenu

        })
    }

    //添加右击菜单内容
    function onRowContextZoneMenu(e, rowIndex, rowData) {
        e.preventDefault();
        $(this).datagrid('selectRow', rowIndex); //选中当前行
        $("#structuralEeZoneListDel").show();
        $("#structuralEeZoneListDelView").hide();

        $('#structuralEeZoneListMenu').menu('show', {
            left: e.pageX,
            top: e.pageY
        });
    }

    // 删除区域
    function deleteStruEEZone(){
        if (!confirm("是否确认删除？")) {
            return;
        }
        var row = $("#zoneList").datagrid('getSelected');
        var params = { "businessId":evalNo,"businessType":"MP","subtype":row.subType,"zone":row.zoneThird };
        $.ajax({
            url: "/api/v1/ee/emFileStructurePara/deleteByBusinessIdTypeSubTypeAndZone",
            type: 'post',
            contentType: "application/json;charset=utf-8",
            data:JSON.stringify(params),
            dataType: "json",
            success: function (data) {
                if (data.code === RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: '删除成功'});
                    getSelectZoneList(evalNo,"MP","action");
                } else {
                    MsgAlert({content: data.msg , type: 'error'});
                }
            }
        });

    }


    //特殊控制要求和航线项目联动
    function changeCtlType() {
        var type = 'A';
        var ctlType = $('#ctlType').combobox('getValue');
        if (ctlType == "NONE" || ctlType == "CHECK") {
            //隐藏监控/航线类型
            $("#ctlTypeMonitorTh").hide();
            $("#ctlTypeMonitorTd").hide();
            $("#ctlTypeMonitor").combobox({required: false, multiple: true, value: ""});
        } else if (ctlType == "MON") {
            $("#ctlTypeMonitorTh").show();
            $("#ctlTypeMonitorTd").show();
            $("#ctlTypeMonitor").combobox({required: true, multiple: true, value: ""});
            type = "A";
            $("#ctlTypeMonitorTh").text("机会类型")
//     机会检如果控制类型选择为【监控项目】时，需要指定机会检类型。
        } else if (ctlType == "LINE") {
            $("#ctlTypeMonitorTh").show();
            $("#ctlTypeMonitorTd").show();
            $("#ctlTypeMonitor").combobox({required: true, multiple: true, value: ""});
            // 如果控制类型为【航线项目】时，需要指定【航线类型（航前、航后、短停）】
            type = "B";
            $("#ctlTypeMonitorTh").text("航线类型")
        }
        InitFuncCodeRequest_({
            data: {mark: type, FunctionCode: "EM_CTL_TYPE_MONITOR_DOMAIN"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    applType = jdata.data;
                    $('#ctlTypeMonitor').combobox({
                        panelHeight: '100px',
                        panelWidth: '120px',
                        data: applType,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    // $("#ctlTypeMonitor").combobox('clear');
                }
            }
        });
    }

    //是否需要过渡
    function changeFormatForGuodu() {
        //已取消
        var ifTmp = $('#ifTmp').combobox('getValue');
        if (ifTmp == "Y") {
            $("#guodu1").show();
            $("#guodu2").show();
            $("#guodu3").show();
            $('#tmpCalUnit').combobox({onlyview: false, required: false, editable: false});
            $('#tmpFh').textbox({editable: true, onlyview: false, required: false});
            $('#tmpFc').textbox({editable: true, onlyview: false, required: false});
            $('#tmpCal').textbox({editable: true, onlyview: false, required: false});
            $('#tmpIntervalRule').combobox({onlyview: false, required: false});
            $('#tmpRequire').textbox({editable: true, onlyview: false, required: false});
            $('#tmpFleets').textbox({editable: false, onlyview: true, required: false});
            $('#tempLevel').combobox({editable: true, onlyview: false, required: false});
            $('#tempLimitDate').datebox({editable: true, onlyview: false, required: false});
        } else {
            $('#tmpCalUnit').combobox({onlyview: true, required: false, value: ''});
            $('#tmpFh').textbox({editable: false, onlyview: true, required: false, value: ''});
            $('#tmpFc').textbox({editable: false, onlyview: true, required: false, value: ''});
            $('#tmpCal').textbox({editable: false, onlyview: true, required: false, value: ''});
            $('#tmpIntervalRule').combobox({editable: false, onlyview: true, required: false, value: ''});
            $('#tmpRequire').textbox({editable: false, onlyview: true, required: false, value: ''});
            $('#tmpFleets').textbox({editable: false, onlyview: true, required: false});
            $('#tempLevel').combobox({editable: false, onlyview: true, required: false});
            $('#tempLimitDate').datebox({editable: false, onlyview: true, required: false});
            $('#tmpFleets').textbox("setValue", "");
            $("#guodu1").hide();
            $("#guodu2").hide();
            $("#guodu3").hide();


        }
    }

    function deleteTmpFleet() {
        //删除过渡飞机数据
        InitFuncCodeRequest_({
            data: {evalNo: evalNo, FunctionCode: "EM_MPD_EVAL_TRANSITON_ACNO_DEL"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                }
            }
        });
    }

    //增加间隔
    function addInteval(type, pkid) {
        //判断是否修订mp
        var ifRevCmp = $('#ifRevCmp').combobox('getValue');
        if (ifRevCmp == "N") {
            return;
        }

        evalNo = $("#evalNo").val();
        fleet = $("#fleet").val();
        var applType = $('#applType').combobox('getValue');
        if (applType == "") {
            MsgAlert({content: '请先选择适用性类型', type: 'error'});
        }
        var intervalDgrows = $("#intervalDg").datagrid("getRows");
        // if (intervalDgrows.length == 2 && type != "edit") {
        if (intervalDgrows.length == 2 && type == "add") {
            alert("已经存在正常间隔、低利用率间隔，不可再增加间隔。");
            return;
        }
        var ctlType = $('#ctlType').combobox('getValue');
        if (applType == "APL") {
            if (ctlType == "MON") {
                MsgAlert({content: '机会项目不可添加间隔信息', type: 'error'});
                return;
            }
            //获取控制类型
            ShowWindowIframe({
                width: 1050,
                height: 730,
                param: {evalNo: evalNo, fleet: fleet, type: type, appltype: applType, Add: "1", pkid: pkid},
                title: "间隔增加",
                url: "/views/em/emmpdeval/interval/addAplInterval.shtml"
            });
        }
        if (applType == "ENG") {
            if (ctlType == "MON") {
                MsgAlert({content: '机会项目不可添加间隔信息', type: 'error'});
                return;
            }
            ShowWindowIframe({
                width: 1050,
                height: 730,
                param: {evalNo: evalNo, fleet: fleet, type: type, appltype: applType, Add: "1", pkid: pkid},
                title: "间隔增加",
                url: "/views/em/emmpdeval/interval/addEngInterval.shtml"
            });
        }
        if (applType == "PART") {
            ShowWindowIframe({
                width: 1050,
                height: 660,
                param: {evalNo: evalNo, fleet: fleet, type: type, appltype: applType, Add: "1", pkid: pkid},
                title: "间隔增加",
                url: "/views/em/emmpdeval/interval/addPartInterval.shtml"
            });
        }
    }

    //增加适用性
    function addApplic(type, editType) {
        //判断是否修订mp
        var ifRevCmp = $('#ifRevCmp').combobox('getValue');
        if (ifRevCmp == "N") {
            return;
        }
        evalNo = $("#evalNo").val();
        fleet = $("#fleet").val();
        var applType = $('#applType').combobox('getValue');
        if (applType == "PART") {
            ShowWindowIframe({
                width: 1100,
                height: 630,
                param: {evalNo: evalNo, type: type, applType: applType, fleet: fleet, rangeType: 'PN'},
                title: "增加适用性",
                url: "/views/em/emmpdeval/applic/addPnApplic.shtml"
            });
        } else {
            ShowWindowIframe({
                width: 420,
                height: 470,
                param: {evalNo: evalNo, type: type, applType: applType, fleet: fleet},
                title: "增加适用性",
                url: "/views/em/emmpdeval/applic/addAllApplic.shtml"
            });
        }

    }

    //编辑适用性
    function editApplic(type, rangeType, pkid) {
        //判断是否修订mp
        var ifRevCmp = $('#ifRevCmp').combobox('getValue');
        if (ifRevCmp == "N") {
            return;
        }
        evalNo = $("#evalNo").val();
        fleet = $("#fleet").val();
        var applType = $('#applType').combobox('getValue');
        if (rangeType == 'ALL') {
            ShowWindowIframe({
                width: 420,
                height: 470,
                param: {evalNo: evalNo, type: type, pkid: pkid, applType: applType, fleet: fleet},
                title: "增加适用性",
                url: "/views/em/emmpdeval/applic/addAllApplic.shtml"
            });
        } else if (rangeType == 'DESC') {
            ShowWindowIframe({
                width: 670,
                height: 600,
                param: {evalNo: evalNo, type: type, pkid: pkid, applType: applType, fleet: fleet},
                title: "增加适用性",
                url: "/views/em/emmpdeval/applic/addDescApplic.shtml"
            });
        } else if (rangeType == 'PRE' || rangeType == 'POST') {
            ShowWindowIframe({
                width: 440,
                height: 470,
                param: {evalNo: evalNo, type: type, pkid: pkid, applType: applType, fleet: fleet},
                title: "增加适用性",
                url: "/views/em/emmpdeval/applic/addPostApplic.shtml"
            });
        } else if (rangeType == 'PN') {
            ShowWindowIframe({
                width: 880,
                height: 630,
                param: {evalNo: evalNo, type: type, pkid: pkid, applType: applType, fleet: fleet},
                title: "增加适用性",
                url: "/views/em/emmpdeval/applic/addPnApplic.shtml"
            });
        } else if (rangeType == 'SN') {
            ShowWindowIframe({
                width: 880,
                height: 630,
                param: {evalNo: evalNo, type: type, pkid: pkid, applType: applType, fleet: fleet},
                title: "增加适用性",
                url: "/views/em/emmpdeval/applic/addSnApplic.shtml"
            });
        } else if (rangeType == 'ENGSERI') {
            ShowWindowIframe({
                width: 1060,
                height: 640,
                param: {evalNo: evalNo, type: type, pkid: pkid, applType: applType, fleet: fleet},
                title: "增加适用性",
                url: "/views/em/emmpdeval/applic/addEngSeriApplic.shtml"
            });
        } else if (rangeType == 'LINENO') {
            ShowWindowIframe({
                width: 670,
                height: 600,
                param: {evalNo: evalNo, type: type, pkid: pkid, applType: applType, fleet: fleet},
                title: "增加适用性",
                url: "/views/em/emmpdeval/applic/addLineNoApplic.shtml"
            });
        } else if (rangeType == 'SYS') {
            ShowWindowIframe({
                width: 820,
                height: 600,
                param: {evalNo: evalNo, type: type, pkid: pkid, applType: applType, fleet: fleet},
                title: "增加适用性",
                url: "/views/em/emmpdeval/applic/addConfigApplic.shtml"
            });
        }
        else {
            ShowWindowIframe({
                width: 420,
                height: 470,
                param: {evalNo: evalNo, type: type, pkid: pkid, applType: applType, fleet: fleet},
                title: "增加适用性",
                url: "/views/em/emmpdeval/applic/addFleetApplic.shtml"
            });
        }

    }

    function addAttachOption() {
        //当是否修订MP为否时，禁用选择按钮
        var ifRevCmp = $("#ifRevCmp").combobox("getValue");
        if (ifRevCmp == 'N') {
            return;
        }
        //源文件中有AD的 默认MARK信息勾选AD,源文件中有CMR的 默认MARK信息勾选CMR
        var sources = $("#sources").textbox("getValue");
        var attachOption = $("#attachOption").val();
        ShowWindowIframe({
            width: 500,
            height: 600,
            param: {attachOption: attachOption, evalNo: evalNo, sources: sources},
            title: "MARK信息",
            url: "/views/em/emmpdeval/emMpdAttachOption.shtml"
        });
    }

    function addSource() {
        //当是否修订MP为否时，禁用选择按钮
        var ifRevCmp = $("#ifRevCmp").combobox("getValue");
        if (ifRevCmp == 'N') {
            return;
        }
        fleet = $("#fleet").val();
        ShowWindowIframe({
            width: 880,
            height: 600,
            param: {fleet: fleet, evalNo: evalNo},
            title: "Source信息",
            url: "/views/em/emmpdeval/emMpdSource.shtml"
        });
    }

    function refreshAttachOption(attachOptions) {
        $("#attachOption").textbox({value: attachOptions});
    }

    function refreshAcnos(acnos) {
        $("#tmpFleets").textbox({value: acnos});
    }

    function refreshSources(sources) {
        $("#sources").textbox({value: sources});

    }

    //工卡新增
    function addDatagridRow() {
        //判断是否修订mp
        var ifRevCmp = $('#ifRevCmp').combobox('getValue');
        if (ifRevCmp == "N") {
            return;
        }
        var ctlType = $('#ctlType').combobox('getValue');
        if (ctlType == "NONE" || ctlType == "LINE") {
            alert("航线项目和无需控制无需编卡。");
            return;
        }
        var tableDg=$('#jobCardDg').datagrid("getRows");
        var tableCnt=tableDg.length;
        var rowNoIndex=0;
        if(tableCnt){
            tableDg.sort(function (a, b) {
                var c =a.CARD_NO,d=b.CARD_NO;
                return (c.substring(c.lastIndexOf("-")+1)-d.substring(d.lastIndexOf("-")+1))
            });
            var endRowNo = tableDg[tableCnt-1].CARD_NO;
            rowNoIndex=endRowNo.substring(endRowNo.lastIndexOf("-")+1);
        }
        rowNoIndex++;
        if(rowNoIndex<=9){
            rowNoIndex = "0" +rowNoIndex;
        }
        var fleet = $('#fleet').textbox('getValue');
        var cmpNo = $('#cmpNo').textbox('getValue');
        var cardNo = "MPJC" + "-" + fleet + "-" + cmpNo+"-"+rowNoIndex;
        $('#jobCardDg').datagrid('appendRow', {REV_CODE: 'N', CARD_NO: cardNo});
    }

    function saveCheck() {
        var $form = $("#mform");
        var isValidate = $form.form('validate');
        if (!isValidate) {
            return true;
        }

        var ifagain = $("#ifAgainEva").combobox('getValue');
        if (ifagain == 'Y') {
            var againEvaDate = $("#againEvaDate").datebox("getValue");
            var againEvaInterval = $("#againEvaInterval").textbox("getValue");
            if (againEvaDate == "" && againEvaInterval == "") {
                MsgAlert({content: "重评时间和间隔不允许都为空！", type: 'error'});
                return true;
            }
            if (againEvaDate != "" && againEvaInterval != "") {
                MsgAlert({content: "重评时间和间隔只能二选一！", type: 'error'});
                return true;
            }
            var now = new Date();
            var year = now.getFullYear(); //得到年份
            var month = now.getMonth();//得到月份
            var date = now.getDate();//得到日期
            month = month + 1;
            if (month < 10) {
                month = "0" + month
            }
            if (date < 10) {
                date = "0" + date
            }
            var curDate = year + "-" + month + "-" + date;
            if (againEvaDate != "") {
                if (againEvaDate < curDate) {
                    MsgAlert({content: "重评日期不能小于当前日期！", type: 'error'});
                    $("#againEvaDate").datebox("setValue", "");
                    return true;
                }
            }
            var r = /^\+?[1-9][0-9]*$/;　　//正整数
            var flag = r.test(againEvaInterval);
            if (againEvaInterval != "") {
                if (!flag) {
                    MsgAlert({content: "重评间隔只能是正整数！", type: 'error'});
                    $("#againEvaInterval").textbox("setValue", "");
                    return true;
                }
            }
        }
        var mainData = $form.serializeObject();
        if (mainData.ifTmp == "Y") {
            var t = 0;
            if (mainData.tmpFh != "") {
                t = t + 1;
            }
            if (mainData.tmpFc != "") {
                t = t + 1;
            }
            if (mainData.tmpCal != "") {
                t = t + 1;
            }
            if (mainData.tempLevel != "") {
                t = t + 1;
            }
            if (mainData.tempLimitDate != "") {
                t = t + 1;
            }
            if (t == 0 && mainData.tmpRequire == "") {
                MsgAlert({content: '过渡时限参数不能为空!', type: 'error'});
                return true;
            }
            if (mainData.tmpCal != "" && mainData.tmpCalUnit == "") {
                MsgAlert({content: '过渡日历日单位不能为空!', type: 'error'});
                return true;
            }
            if (mainData.tmpCal == "" && mainData.tmpCalUnit != "") {
                MsgAlert({content: '过渡日历日参数不能为空!', type: 'error'});
                return true;
            }
            if (mainData.tmpIntervalRule != "") {
                if (t < 2) {
                    MsgAlert({content: '单个参数不允许选择过渡监控方法!', type: 'error'});
                    return true;
                }
            } else {
                if (t > 1) {
                    MsgAlert({content: '多个参数需选择过渡监控方法!', type: 'error'});
                    return true;
                }
            }
            if ((mainData.tmpFh != "" || mainData.tmpFc != "" || mainData.tempLevel != "" || mainData.tempLimitDate != "" || mainData.tmpCal != "") && mainData.tmpRequire != "") {
                MsgAlert({content: '过渡结构化时限（FH、FC、日历日、过渡级别、过渡截止日期）与【过渡要求】不能同时填写!', type: 'error'});
                return true;
            }

        }
        var ifAppl = $("#ifAppl").combobox("getValue");
        // if (ifAppl != "Y") {
        //     //判断工卡标志是否全部为D，不为D,则提示作废工卡
        //     var rows = $("#jobCardDg").datagrid("getRows");
        //     for (var i = 0; i < rows.length; i++) {
        //         if (rows[i].REV_CODE != 'D') {
        //             alert("存在未作废的工卡，请先作废工卡。");
        //             return true;
        //         }
        //     }
        // }
        var sameCmpNo = false;
        var evalNo = $("#evalNo").val();
        var cmpNo = $("#cmpNo").textbox("getValue");
        var fleet = $("#fleet").val();
        InitFuncCodeRequest_({
            data: {
                evalNo: evalNo,
                cmpNo: cmpNo,
                fleet: fleet,
                FunctionCode: "EM_MPD_EVAL_CMP_NO_UNIQUE"
            },
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data[0].NUM > 1) {
                        sameCmpNo = true;
                    }
                }
            }
        });
        if (sameCmpNo) {
            MsgAlert({content: '已存在该mp编号！', type: 'error'});
            return sameCmpNo;
        }
        return false;
        //save();
    }

    //保存
    function save() {
        var $form = $("#mform");
        var isValidate = $form.form('validate');
        if (!isValidate) {
            return false;
        }
        if (saveCheck()) {
            return;
        }
        //删除过渡飞机
        var ifTmp = $('#ifTmp').combobox('getValue');
        if (ifTmp == "N") {
            deleteTmpFleet();
        }
        // var mainData = JSON.stringify($('#mform').serializeObject());

        var mainData = $('#mform').serializeObject();
        var itemType = $('#itemType').combobox('getValue');
        if(itemType=="2"|| itemType == "3" || itemType == "4") {
            var zoneNew = $('#zone').val();
            if(zoneNew && zoneNew != null && zoneNew !=""){
                mainData.zone = zoneNew;
            }
        }
        console.log(mainData);
        //校验编号唯一性
        var evalNo = $("#evalNo").val();
        var cmpNo = $("#cmpNo").textbox("getValue");

        if (Array.isArray(mainData['ctlTypeMonitor'])) {
            mainData['ctlTypeMonitor'] = mainData['ctlTypeMonitor'].join(',');
        }
        mainData = JSON.stringify(mainData);
        InitFuncCodeRequest_({
            data: {
                type: type,
                mainData: mainData,
                msgpkid: param.msgpkid,
                FunctionCode: "EM_MPD_EVAL_SAVE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    // InitDataForm();
                    InitDataGrid5();
                    param.OWindow.reload_();
                    if (msgData) {
                        param.OWindow.reloadTodo();
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //间隔
    function reloadg2_() {
        $("#intervalDg").datagrid("reload");
    }

    // 适用性
    function reloadg3() {
        $("#applicabilityDg").datagrid("reload");
    }

    // 工卡关联关系
    function reloadg4() {
        $("#jobCardDg").datagrid("reload");
    }

    function reloadFrom() {
        InitDataForm();
    }

    function InitDataForm() {
        InitFuncCodeRequest_({
            data: {evalNo: evalNo, FunctionCode: "EM_MPD_EVAL_PKID"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    // $('#attachOption').textbox({editable: false, onlyview: true, required: false});
                    // $('#chTaskDesc').textbox({editable: true, onlyview: false, required: false});
                    if (jdata.data) {
                        ParseFormField_(jdata.data, null, Constant.CAMEL_CASE);
                        if (jdata.data.ITEM_TYPE == undefined) {
                            isItemType = true;
                        }
                        if (jdata.data.APPL_TYPE == undefined) {
                            isApplType = true;
                        }
                        // itemNumber = jdata.data.ITEM_NUMBER;
                        //$('#itemNumber2').text(jdata.data.ITEM_NUMBER);
                        $("#revCode1").textbox('setValue', jdata.data.REV_CODE == "N" ? "新增" : (jdata.data.REV_CODE == 'R' ? "改版" : "失效"));
                        //项目分类
                        $('#itemType').combobox({value: jdata.data.ITEM_TYPE});
                        $('#applType').combobox({value: jdata.data.APPL_TYPE});
                        $('#ifAppl').combobox({value: jdata.data.IF_APPL});
                        $('#ifRevCmp').combobox({value: jdata.data.IF_REV_CMP});
                        $('#pgm').combobox({value: jdata.data.PGM});
                        if(null != jdata.data.ZONE  &&  jdata.data.ZONE != "" ){
                            $('#zoneBind').combotree('setValues',jdata.data.ZONE);
                        }

                        $('#taskCode').combobox({value: jdata.data.TASK_CODE});
                        changeIfAppl();
                        changeIfRevCmp();
                        changeApplType2();
                        $('#monitorStatus').combobox({value: jdata.data.MONITOR_STATUS});
                        $('#ctlType').combobox({value: jdata.data.CTL_TYPE});
                        changeCtlType();
                        //监控/航线类型
                        $('#ctlTypeMonitor').combobox({value: jdata.data.CTL_TYPE_MONITOR});
                        //$('#engLocation').combobox({value: jdata.data.ENG_LOCATION});
                        $('#limitType').combobox({value: jdata.data.LIMIT_TYPE});
                        changeLimitType();
                        $('#repairLeval').combobox({value: jdata.data.REPAIR_LEVAL});
                        $('#executeRequire').combobox({value: jdata.data.EXECUTE_REQUIRE});
                        $('#ifTmp').combobox({value: jdata.data.IF_TMP});
                        $('#ifMerge').combobox({value: jdata.data.IF_MERGE});
                        //设置是否需要过渡
                        setTmpData(jdata.data);
                        $('#taskCode').combobox({value: jdata.data.TASK_CODE});
                        //非首版MP评估界面，‘MP编号’不允许修改
                        if (jdata.data.REV_CODE != "N") {
                            $("#cmpNo").textbox({editable: false, onlyview: true});
                        }

                        var again = $("#ifAgainEva").combobox('getValue');
                        againChange(again);
                    }
                }
            }
        });
    }

    function setTmpData(data) {

        if (data.IF_TMP == "Y") {

            $('#tmpCalUnit').combobox({onlyview: false, editable: true, required: false});
            $('#tmpFh').textbox({editable: true, onlyview: false, required: false});
            $('#tmpFc').textbox({editable: true, onlyview: false, required: false});
            $('#tmpCal').textbox({editable: true, onlyview: false, required: false});
            $('#tmpIntervalRule').combobox({onlyview: false});
            $('#tmpRequire').textbox({editable: true, onlyview: false, required: false});

            $('#tmpFleets').textbox({editable: false, onlyview: true, required: false});

            $('#ifTmp').combobox({value: data.IF_TMP});
            $('#tmpCalUnit').combobox({value: data.TMP_CAL_UNIT});
            $('#tmpFh').textbox({value: data.TMP_FH});
            $('#tmpFc').textbox({value: data.TMP_FC});
            $('#tmpCal').textbox({value: data.TMP_CAL});
            $('#tmpIntervalRule').combobox({value: data.TMP_INTERVAL_RULE});
            $('#tmpRequire').textbox({value: data.TMP_REQUIRE});
            $('#tmpFleets').textbox({value: data.TMP_FLEETS});
            $('#tempLevel').combobox({value: data.TEMP_LEVEL});
            $('#tempLimitDate').datebox({value: data.TEMP_LIMIT_DATE});
        }
        changeFormatForGuodu();
    }

    function valid() {
        var ifAppl = $("#ifAppl").combobox("getValue");
        var ifMerge = $("#ifMerge").combobox("getValue");
        var ctlType = $("#ctlType").combobox("getValue");
        var hasNormal = false;

        if (ifAppl == "Y" && ifMerge != "Y") {
            var applicabilityDgrows = $("#applicabilityDg").datagrid("getRows");
            var intervalDgrows = $("#intervalDg").datagrid("getRows");
            //评估结论为适用，且不被合并，适用性必填
            if (applicabilityDgrows.length <= 0) {

                MsgAlert({content: '请填写适用性。', type: 'error'});
                return true;

                //时限在适用性必填逻辑上增加，如是定检条目必须有 正常时限，无需控制和航线项目，不限制，机会检不能有时限
            } else if (ctlType == "MON" && intervalDgrows.length > 0) {

                MsgAlert({content: '机会检项目不能有时限。', type: 'error'});
                return true;

            } else if (ctlType == "CHECK") {
                if (intervalDgrows.length <= 0) {
                    MsgAlert({content: '定检项目必须有时限。', type: 'error'});
                    return true;
                } else {
                    for (var i = 0; i < intervalDgrows.length; i++) {
                        if (intervalDgrows[i].INTERVAL_TYPE == "NORMAL") {
                            hasNormal = true;
                        }
                    }
                    if (!hasNormal) {
                        MsgAlert({content: '定检项目必须正常时限。', type: 'error'});
                        return true;
                    }
                }
            }
        }
        return false;
    }

    function checkIfAppl(type) {

        var $form = $("#mform");
        var isValidate = $form.form('validate');
        if (!isValidate) {
            return false;
        }
        if (saveCheck()) {
            return;
        }
        //删除过渡飞机
        var ifTmp = $('#ifTmp').combobox('getValue');
        if (ifTmp == "N") {
            deleteTmpFleet();
        }
        //提交时验证是否有过渡飞机
        if (ifTmp == "Y") {
            var tmpFleets = $('#tmpFleets').textbox('getValue');
            if (tmpFleets == "") {
                MsgAlert({content: "【是否过渡】为是，则过渡对象不能为空。", type: 'error'});
                return;
            }
        }
        if (valid()) {
            return;
        }
        //获取是否适用
        var ifAppl = $("#ifAppl").combobox("getValue");
        var fleet = $("#fleet").val();
        var cmpNo = $("#cmpNo").textbox("getValue");
        var mainData = JSON.stringify($('#mform').serializeObject());
        var itemType = $('#itemType').combobox('getValue');
        var taskId;
        InitFuncCodeRequest_({
            data: {
                evalNo: evalNo,
                FunctionCode: "EM_MPD_EVAL_QUERY_TASK_ID"
            },
            async:false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    console.info(jdata);
                    taskId = jdata.data.TASK_ID;
                }
            }
        });
        //alert(taskId)
        if (ifAppl != "Y") {
            //判断是否有上一版
            InitFuncCodeRequest_({
                data: {
                    cmpNo: cmpNo,
                    fleet: fleet,
                    evalNo: evalNo,
                    FunctionCode: "EM_MPD_EVAL_CHECK_REV_UNIQUE"
                },
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data.length != 0) {
                            //判断是否有上一版（CMP 机型 并且适用）  提醒所有的工卡标识将改为D
                            var rows = $('#jobCardDg').datagrid('getRows');
                            for (i = 0; i < rows.length; i++) {
                                // rows[i] = toCamelCase(rows[i]);
                                if (rows[i].REV_CODE != "D") {
                                    MsgAlert({content: '请修改工卡关系', type: 'error'});
                                    rows = "";
                                    return;
                                }
                            }
                            ifApproval(taskId);
                            // $.messager.confirm('', '继续将会修改工卡标识，是否继续？', function (r) {
                            //     if (r) {
                            //         //将工卡标识改为D
                            //         datas = $.extend({}, {}, {
                            //             FunctionCode: 'EM_MPD_UPDATE_JOB_CARD_REVCODE',
                            //             evalNo: evalNo
                            //         });
                            //         InitFuncCodeRequest_({
                            //             data: datas, successCallBack: function (jdata) {
                            //                 if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                            //                     ifApproval();
                            //                 } else {
                            //                     MsgAlert({content: jdata.msg, type: 'error'});
                            //                 }
                            //             }
                            //         });
                            //     }
                            // });
                        } else {
                            //如果没有上一版   就直接保存，不提示工卡是否有值 和标识改为D
                            // 需工程人工将MP与JC关系由系统默认’新增‘修改成’无需编卡‘
                            //序列化列表数据
                            var rows = $('#jobCardDg').datagrid('getRows');
                            for (i = 0; i < rows.length; i++) {
                                // rows[i] = toCamelCase(rows[i]);
                                if (rows[i].REV_CODE == "N") {
                                    MsgAlert({content: '请修改工卡关系', type: 'error'});
                                    rows = "";
                                    return;
                                }
                            }

                            InitFuncCodeRequest_({
                                data: {
                                    mainData: mainData,
                                    FunctionCode: "EM_MPD_EVAL_SAVE"
                                },
                                successCallBack: function (jdata) {
                                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                        //提交流程

                                        //校验是否提交过流程
                                        if (!confirm("确认提交该记录？")) {
                                            return;
                                        }
                                        datas = $.extend({}, {}, {
                                            FunctionCode: 'EM_MPD_EVAL_STATUS',
                                            evalNo: evalNo
                                        });
                                        var url = "/views/em/emmpdeval/workflow/ifApproval.shtml";
                                        if (type == "workflow") {
                                            url = "/views/em/emmpdeval/workflow/ifApprovalBack.shtml";
                                        }
                                        InitFuncCodeRequest_({
                                            data: datas, successCallBack: function (jdata) {
                                                if (jdata.data != null) {
                                                    ShowWindowIframe({
                                                        width: 600,
                                                        height: 390,
                                                        param: {evalNo: evalNo,taskId:taskId},
                                                        title: "是否提交可靠委员",
                                                        url: url
                                                    });
                                                } else {
                                                    MsgAlert({content: "该数据已被提交过了。", type: 'error'});
                                                }
                                            }
                                        });
                                        //
                                    } else {
                                        MsgAlert({content: jdata.msg, type: 'error'});
                                    }
                                }
                            });
                        }
                    } else {
                        MsgAlert({content: jdata.msg, type: 'error'});
                    }
                }
            });
        } else {
            ifApproval(taskId, type);
        }
    }

    function ifApproval(taskId, type) {

        //保存
        //var mainData = JSON.stringify($('#mform').serializeObject());
        var mainData = $('#mform').serializeObject();
        if (Array.isArray(mainData['ctlTypeMonitor'])) {
            mainData['ctlTypeMonitor'] = mainData['ctlTypeMonitor'].join(',');
        }
        mainData = JSON.stringify(mainData);
        //校验编号唯一性
        var evalNo = $("#evalNo").val();
        var cmpNo = $("#cmpNo").textbox("getValue");


        /*var ifTmp = $('#ifTmp').combobox('getValue');
        if (ifTmp=="N"){
            deleteTmpFleet();
        }*/
        InitFuncCodeRequest_({
            data: {
                mainData: mainData,
                FunctionCode: "EM_MPD_EVAL_SAVE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //提交流程
                    //校验该评估单是否已有工卡
                    InitFuncCodeRequest_({
                        data: {evalNo: evalNo, FunctionCode: "EM_MPD_CHECK_JOBCARD"},
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                var ctlType = $('#ctlType').combobox('getValue');
                                var applType = $('#applType').combobox('getValue');
                                /*if(ctlType=="NONE"||ctlType=="LINE"){
                                    alert("航线项目和无需控制无需编卡。");
                                    return;
                                }*/
                                if (jdata.data.length == 0 && (ctlType == "MON" || ctlType == "CHECK") && applType != "PART") {
                                    MsgAlert({content: '请先填写工卡关联关系', type: 'error'});

                                } else {
                                    //校验是否提交过流程
                                    if (!confirm("确认提交该记录？")) {
                                        return;
                                    }
                                    datas = $.extend({}, {}, {
                                        FunctionCode: 'EM_MPD_EVAL_STATUS',
                                        evalNo: evalNo
                                    });
                                    var url = "/views/em/emmpdeval/workflow/ifApproval.shtml";
                                    if (type == "workflow") {
                                        url = "/views/em/emmpdeval/workflow/ifApprovalBack.shtml";
                                    }
                                    InitFuncCodeRequest_({
                                        data: datas, successCallBack: function (jdata) {
                                            if (jdata.data != null) {
                                                ShowWindowIframe({
                                                    width: 600,
                                                    height: 390,
                                                    param: {evalNo: evalNo,taskId:taskId},
                                                    title: "是否提交可靠委员",
                                                    url: url
                                                });
                                            } else {
                                                MsgAlert({content: "该数据已被提交过了。", type: 'error'});
                                            }
                                        }
                                    });
                                }
                            } else {
                                MsgAlert({content: jdata.msg, type: 'error'});
                            }
                        }
                    });
                    //
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

    }

    //用于超链接通过判断给用户展示对应的页面
    function chakan(type,value) {
        //暂时取消
        var FLEET = $("#fleet").val();
        var docType = $("#docType").val();
        var itemType = $("#itemType").val();
        var docType = $("#docType").val();
        var awlType = $("#awlType").val();
        var ifPse = $("#ifPse").val();
        var docSource = $("#docSource").val();
        itemNumber = $("#itemNumber").val();
        ShowWindowIframe({
            width: 1300,
            height: 340,
            param: {evalNo: evalNo,type:type, itemNumber: value, fleet: FLEET},
            title: "项目展示",
            url: "/views/em/emmpdeval/emMpdFilesHistory.shtml"
        });
    }

    //预览适用性
    function viewAppl() {
        var appltype = $('#applType').combobox('getValue');
        /*var $identity = '#applicabilityDg';
        var row = $($identity).;
        if(!row){
            alert("请选择间隔数据。");
            return;
        }*/
        // if (appltype != "APL") {
        //     MsgAlert({content: '非机身不能预览适用性', type: 'error'});
        //     return;
        // }
        var url = "/views/em/emmpdeval/em_mpdeval.previewApp.shtml";
        if (appltype == "ENG") {
            url = "/views/em/emmpdeval/em_mpdeval.previewEng.shtml";
        }
        if (appltype == "PART") {
            url = "/views/em/emmpdeval/em_mpdeval.previewPart.shtml";
        }
        fleet = $("#fleet").val();
        ShowWindowIframe({
            width: 530,
            height: 440,
            param: {evalNo: evalNo, appltype: appltype, fleet: fleet},
            url: url
        });
    }

    function viewApplCurrent() {
        var appltype = $('#applType').combobox('getValue');
        var url = "/views/em/emmpdeval/em_mpdeval.previewCurrentApp.shtml";
        if (appltype == "ENG") {
            url = "/views/em/emmpdeval/em_mpdeval.previewCurrentEng.shtml";
        }
        if (appltype == "PART") {
            url = "/views/em/emmpdeval/em_mpdeval.previewCurrentPart.shtml";
        }
        fleet = $("#fleet").val();
        ShowWindowIframe({
            width: 530,
            height: 440,
            param: {evalNo: evalNo, appltype: appltype, fleet: fleet},
            url: url
        });
    }
    //过渡性飞机
    function addTmpFleet() {
        //当是否修订MP为否时，禁用选择按钮
        var ifRevCmp = $("#ifRevCmp").combobox("getValue");
        if (ifRevCmp == 'N') {
            return;
        }
        //需要过渡且适用性为机身才可以选择过渡飞机
        var ifTmp = $('#ifTmp').combobox('getValue');
        var appltype = $('#applType').combobox('getValue');
        // if (ifTmp != "Y" || appltype != "APL") {
        //     return;
        // }
        if (ifTmp != "Y") {
            return;
        }
        var url = "/views/em/emmpdeval/emMpdTmpFleet.shtml";
        if (appltype == "ENG") {
            url = "/views/em/emmpdeval/emMpdTmpEng.shtml";
        }
        if (appltype == "PART") {
            url = "/views/em/emmpdeval/emMpdTmpPart.shtml";
        }
        var tmpFleets = $('#tmpFleets').textbox('getValue');
        fleet = $("#fleet").val();
        ShowWindowIframe({
            width: 530,
            height: 500,
            param: {evalNo: evalNo, appltype: appltype, fleet: fleet, tmpFleets: tmpFleets},
            url: url
        });
    }

    function closWindow() {
        param.OWindow.reload_();
        CloseWindowIframe();
    }

    //历史评估记录数据展示
    function InitDataGrid5() {
        var identity = 'lspg';
        $("#lspg").MyDataGrid({
            identity: identity,
            resize: function () {
                return tabs_standard_resize($('#tt'), -10, 0, 0.1, 0.1);
            },
            queryParams: {evalNo: evalNo},
            columns: {
                param: {FunctionCode: 'EM_MPD_EVAL_HISTORY_LIST'},
                alter: {}
            },
            contextMenus: []
        });
    }

    //代替数据展示
    function InitDataGrid6() {
        var identity = 'replaceItemDg';
        $("#replaceItemDg").MyDataGrid({
            identity: identity,
            resize: function () {
                return tabs_standard_resize($('#tt'), -10, 0, 0.1, 0.1);
            },
            queryParams: {evalNo: evalNo, fleet: fleetPass},
            columns: {
                param: {FunctionCode: 'EM_MPD_EVAL_REPLACEITEM_LIST'},
                alter: {}
            },
            contextMenus: []
        });
    }

    //是否合并
    function ifMerge() {
        //当选择为是时，设置合并mp编号为必填
        var ifMerge = $("#ifMerge").combobox("getValue");
        if (ifMerge == "Y") {
            //$("#cmpNo").textbox('setValue', '');
            $("#mergeTo").textbox({required: true});
        } else {
            $("#mergeTo").textbox({required: false});
            $("#mergeTo").textbox('setValue', '');
        }
    }

    function openCmpNoList() {
        var ifMerge = $("#ifMerge").combobox("getValue");
        if (ifMerge == "Y") {
            var fleet = $("#fleet").val();
            var title_ = $.i18n.t('mp编号列表');
            ShowWindowIframe({
                width: "600",
                height: "400",
                title: title_,
                param: {fleet: fleet},
                url: "/views/em/emmpdeval/cmpList.shtml"
            });
        }
        else {
            MsgAlert({content: "请先选择确定合并", type: 'error'});
        }
    }

    function changeMergeTo() {

    }

    $.extend($.fn.validatebox.defaults.rules, {
        positive: {
            //正数且保留两位小数
            validator: function (value, param) {
                if (/^(?!0+(?:\.0+)?$)(?:[1-9]\d*|0)(?:\.\d{1,2})?$/.test(value)) {
                    return true;
                } else {
                    return false;
                }
                // return value.length >= param[0];
            },
            message: '请输入正数'
        }
    });

    function refreshMark(source) {
        var mark = $("#attachOption").textbox("getValue");
        if (source.indexOf("AD") > -1) {
            if (!(mark.indexOf("AD") > -1)) {
                if (mark) {
                    mark = mark + ",AD";
                } else {
                    mark = "AD";
                }

            }
        }
        if (source.indexOf("CMR") > -1) {
            if (!(mark.indexOf("CMR") > -1)) {
                if (mark) {
                    mark = mark + ",CMR";
                } else {
                    mark = "CMR";
                }

            }
        }
        $("#attachOption").textbox("setValue", mark);
        var attachOption = $("#attachOption").textbox("getText");
        //保存
        InitFuncCodeRequest_({
            data: {evalNo: evalNo, attachOption: attachOption, FunctionCode: 'EM_MPD_ATTACH_OPTIONS_EDIT'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    // param.OWindow.refreshAttachOption(attachOptions.join(","));
                    // MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    // CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function setIfApproval(ifApproval) {
        parent.setIfApproval(ifApproval);
        parent.doSubmit();
        // param.OWindow.setIfApproval(ifApproval);
        // $("#ifReportRe").val(ifApproval);
    }

    function againChange(dealOption) {
        if (dealOption == "Y") {
            $("#againEvaReason").textbox({editable: true, required: true});
            $("#again1").show();
            $("#again2").show();
            $("#again3").show();
            $("#again4").show();
            $("#again5").show();
        } else {
            $("#againEvaReason").textbox({required: false});

            $('#againEvaDate').textbox('setValue', '');
            $('#againEvaInterval').textbox('setValue', '');
            $('#againEvaReason').textbox('setValue', '');
            $("#again1").hide();
            $("#again2").hide();
            $("#again3").hide();
            $("#again4").hide();
            $("#again5").hide();
        }
    }

    function checkNum() {
        var str = $(this).val();
        if (isNaN(Number(str))) {
            alert('请输入数字！');
            $(this).val('');

        }
    }

</script>
</html>


