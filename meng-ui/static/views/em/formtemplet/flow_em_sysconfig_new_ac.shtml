<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="ws_work_flow">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
    <script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
    <title>新飞机引进-系统构型审核流程</title>
</head>
<body class="ibody">
<div id="tabs" style="width: 100%; height: 100%;">
    <div id="tab01" title="业务表单数据" style="">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
                    <input type="hidden" name="pkid" id="pkid"/>
                    <input type="hidden" name="isFirstNode" id="isFirstNode"/>
                    <input type="hidden" name="approvedBy" id="approvedBy"/>

                    <div style="height: 700px">
                        <iframe id="iframe01" frameborder="0" style="width: 100%; height: 700px"></iframe>
                    </div>

                    <h5 style="margin-bottom: 4px;">流程处理：</h5>
                    <input name="taskId" type="hidden"/>
                    <table class="table table-bordered table-info" id="mtable">
                        <tr>
                            <th class="tdl"> 处理意见：</th>
                            <td class="tdr">
                                <input id="notes" class="easyui-textbox easyui-validatebox" name="notes"
                                       data-options="multiline:true, required:true,validType:['maxLength[500]'] "
                                       style="height:65px; width: 90%;"/>
                            </td>
                            <th class="tdl xmclass" style="width: 100px">下一级办理人：</th>
                            <td class="tdr xmclass">
                                <input id="authId" name="authId" class="easyui-textbox easyui-validatebox"
                                       data-options="validType:['maxLength[20]'] " style="height:25px; width:150px;"/>
                            </td>
                        </tr>

                        <tr>
                            <td colspan="4" align="center">
                                <input id="canSubmit" class="btn" type="button" onclick="javascript:submitCheck()" value="提交"/>
                                <input id="canReturn" class="btn" type="button" onclick="javascript:doReturn()" value="退回"/>
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>
    <div title="流程信息">
        <table class="table table-bordered table-info" id="processInfo">
            <tr>
                <th class="tdl" style="width: 145px;">流程业务Key ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="businessKey"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="executionName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="createTime"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程创建人 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="userName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="nodeName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
                <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="isJoint"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
            </tr>
        </table>
        <div id="workflow" style="overflow-x: scroll;"></div>
    </div>
    <div id="tab02" title="历史任务信息" style="">
        <table id="historyDg"></table>
    </div>
</div>

<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var pkid;
    var flowNode;

    /**
     * 初始化流程业务处理页面
     * @param resource  业务数据
     * @param execution 流程实例数据
     * @param node 节点配置数据
     * @constructor
     */
    function InitLoadResource(resource, execution, node) {
        pkid = resource.pkid;
        $('#pkid').val(pkid);
        var oper = 'flow';
        var flag = false;
        var userInfo = getLoginInfo();
        var accountId = userInfo.accountId;
        //当前节点为回退节点
        if (node.taskPropId == "taskEmSysconfigNewAc2"){
            oper = 'return';
            flowNode = 'return';
            $("#canReturn").remove();
        }else if(node.taskPropId == "taskEmSysconfigNewAc1"){
            flag = true;
        }

        //下个审批人选择初始化
        $("#authId").MyComboGrid({
            idField: 'ACCOUNT_ID',  //实际选择值
            textField: 'USER_NAME', //文本显示值
            panelHeight: '180px',
            required: true,
            width: 140,
            params: {userId: accountId, FunctionCode: 'FLOW_WORK_ACCOUNT'},
            columns: [[
                {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                {field: 'USER_NAME', title: '审核人', width: 50}
            ]],
            onHidePanel: function () {
                var t = $(this).combogrid('getValue');
                if (t != null && t != '' & t != undefined) {
                    if (selectRow == null || t != selectRow.ACCOUNT_ID) {//没有选择或者选项不相等时清除内容
                        alert('请选择，不要直接输入！');
                        $(this).combogrid({value: ''});
                    }
                }
            },
            onSelect: function (index, row) {
                selectRow = row;
                //当前在审核页面中选择下一位审核人
                if ('taskEmSysconfigNewAc2' == node.taskPropId) {//任务退回提交
                    $("#approvedBy").val(row.ACCOUNT_ID);
                }
            }
        });
        if (flag) {//结束标志
            $(".xmclass").hide();
            $("#authId").combogrid({required: false});
        }

        $('#iframe01').attr('src', '/views/em/emsysconfig/em_sysconfig_new_ac_add.shtml?operation='+oper+'&pkid=' + pkid + "&taskPropId=" + node.taskPropId);


        $('#isFirstNode').val(node.taskPropId === "taskEmSysconfigNewAc1" ? "Y" : "N");
    }

    function submitCheck(){
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_SYSCONFIG_NEW_AC_CONFIG_SUM",
                newAcId: pkid
            },
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data.NUM > 0) {
                        MsgAlert({
                            content: "还有 " + jdata.data.NUM + " 个构型数据未判断，无法提交！", type: 'error'
                        });
                        return;
                    } else {
                        doSubmit();
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }

            }
        });
    }
</script>
</body>
</html>
