<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="ws_work_flow">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
    <script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
    <title>系统构型审核流程</title>
</head>
<body class="ibody">
<div id="tabs" style="width: 100%; height: 100%;">
    <div id="tab01" title="业务表单数据" style="">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
                    <input type="hidden" name="pkid" id="pkid"/>
                    <input type="hidden" name="authId" id="authId"/>
                    <input type="hidden" name="isFirstNode" id="isFirstNode"/>

                    <div style="height: 500px">
                        <iframe id="iframe01" frameborder="0" style="width: 100%; height: 100%"></iframe>
                    </div>

                    <h5 style="margin-bottom: 4px;">流程处理：</h5>
                    <input name="taskId" type="hidden"/>
                    <table class="table table-bordered table-info" id="mtable">
                        <tr id="noteTr">
                            <th class="tdl"> 处理意见：</th>
                            <td class="tdr">
                                <input id="notes" class="easyui-textbox easyui-validatebox" name="notes"
                                       data-options="multiline:true, required:false,validType:['maxLength[500]'] "
                                       style="height:65px; width: 90%;"/>
                            </td>
                        </tr>

                        <tr>
                            <td colspan="2" align="center">
                                <input id="canSubmit" class="btn" type="button" onclick="doSubmit_()" value="提交"/>
                                <input id="canReturn" class="btn" type="button" onclick="doReturn()" value="退回"/>
<!--                                <input id="view" class="btn btn-primary " type="button" onclick="viewDetails()" value="查看详情">-->
                                <!--<input id="canTerminate" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="终止"/>
                                <input id="canHangUp" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="挂起"/>-->
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>
    <div title="流程信息">
        <table class="table table-bordered table-info" id="processInfo">
            <tr>
                <th class="tdl" style="width: 145px;">流程业务Key ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="businessKey"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="executionName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="createTime"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程创建人 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="userName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="nodeName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
                <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="isJoint"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
                </td>
            </tr>
            <!--<tr>
              <th class="tdl" style="width: 145px;">流程任务-配置 ：</th>
              <td class="tdr" colspan="3" style="vertical-align: middle;">
                <input type="checkbox" name="canReturn" value="" disabled/> 可退回
                <input type="checkbox" name="canTrunTo" value="" disabled/> 可转办
                <input type="checkbox" name="canTerminate" value="" disabled/> 可终止
                <input type="checkbox" name="canHangUp" value="" disabled/> 可挂起
              </td>
            </tr>-->
        </table>
        <div id="workflow" style="overflow-x: scroll;"></div>
    </div>
    <div id="tab02" title="历史任务信息" style="">
        <table id="historyDg"></table>
    </div>
</div>

<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">

    var pkid;
    var flowNode;
    var taskPropId;

    /**
     * 初始化流程业务处理页面
     * @param resource  业务数据
     * @param execution 流程实例数据
     * @param node 节点配置数据
     * @constructor
     */
    function InitLoadResource(resource, execution, node) {
        pkid = resource.pkid;
        taskPropId = node.taskPropId;
        $('#pkid').val(pkid);

        $('#iframe01').attr('src', '/views/em/emrespond/em_respond_add.shtml?operation=flow&pkid=' + pkid + "&taskPropId=" + node.taskPropId);

        if (node.taskPropId === "taskEmRespond1") {
            $('#isFirstNode').val("Y");
            //处理意见设为非必填
            $("#notes").textbox({required: false});

        } else {
            $('#isFirstNode').val("N")
        }
        if (node.taskPropId === "taskEmRespond2") {
            flowNode = 'return';
            $("#canReturn").remove();
            $("#notes").textbox({required: false});
            $("#noteTr").hide();

            //处理意见设为非必填
            // $("#notes").textbox({required: false});
        }
    }

    function initForm(resource){
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "EM_SYSCONFIG_APP_TYPE"
            },
            successCallBack: function (jdata) {
                $('#appType').combobox({
                    panelHeight: "135px",
                    data: jdata.data.EM_SYSCONFIG_APP_TYPE,
                    valueField: "VALUE",
                    textField: "TEXT"
                });

                InitFuncCodeRequest_({
                    data: {
                        FunctionCode: "EM_SYSCONFIG_REG_PKID",
                        pkid: resource.pkid
                    },
                    successCallBack: function (jdata) {
                        if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                            ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                            $('#ifSendFlight').attr('checked', jdata.data.IF_SEND_FLIGHT == "Y");
                            $('#ifSendMart').attr('checked', jdata.data.IF_SEND_MART == "Y");
                            $('#ifSendMcc').attr('checked', jdata.data.IF_SEND_MCC == "Y");
                            $('#ifSendOcc').attr('checked', jdata.data.IF_SEND_OCC == "Y");
                        } else {
                            MsgAlert({content: jdata.msg, type: 'error'});
                        }

                        InitDataGrid(resource.pkid);
                    }
                });
            }
        });
    }

    function InitDataGrid(pkid) {
        $("#dg").MyDataGrid({
            identity: 'dg',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 780, height: 250};
            },
            queryParams: {configId: pkid},
            columns: {
                param: {FunctionCode: 'EM_SYSCONFIG_LIST_LIST'},
                alter: {
                    REF_GRAPHIC: {
                        formatter: function (value, row, index) {
                            if (! value) {
                                return "";
                            }

                            var attachments = value.split(',');
                            if (attachments.length == 0) {
                                return "";
                            }

                            var result = ['<ul>'];
                            for (var i = 0; i < attachments.length; i++) {
                                var attachment = attachments[i].split('/');
                                var fileId = attachment[0];
                                var filename = attachment[1];
                                result.push('<li><a onclick="downFile(' + fileId + ')" href="javascript:void(0);">' + filename + '</a></li>');
                            }
                            result.push('</ul>');
                            return result.join('');
                        }
                    }
                }
            }
        });
    }

    function doSubmit_() {
        if (taskPropId === "taskEmRespond2") {
            var ret = $('#iframe01')[0].contentWindow.save();
            if (ret === "false") {
                MsgAlert({
                    content: "【处理结果】为必填项，不能为空！",
                    type: "error"
                });
                return;
            }
        }
        doSubmit();
    }
</script>
</body>
</html>
