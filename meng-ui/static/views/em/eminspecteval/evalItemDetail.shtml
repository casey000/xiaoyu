<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>评估</title>
</head>

<body>
<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content" id="div">
            <form class="form-horizontal m-t" id="mform">
                <input type="hidden" id="pkid" name="pkid"/>
                <input type="hidden" id="parentPkid" name="parentPkid"/>
                <input type="hidden" id="revCode" name="revCode"/>
                <table class="table table-bordered table-info">
                    <tr>
                        <td colspan="6" align="right">
                            <input class="btn btn-primary" type="button" id="saveBtn" onclick="save()" value="保存"/>
                            <input class="btn btn-primary" type="button" onclick="closeW();" value="关闭"
                                   style="margin-right: 80px;"/>
                            <br/>
                        </td>
                    </tr>
                </table>
                <fieldset class="fieldset_eui" style="width:100%;margin-right:5px">
                    <legend data-i18n="">前营运人信息</legend>
                    <table class="table table-bordered table-info">
                        <tr>
                            <th class="th" align="right" style="width: 60px;">方案号：</th>
                            <td class="tdr">
                                <input class="easyui-textbox" id="formerMpNo" name="formerMpNo" style="width: 215px"
                                       data-options="required:true,editable:true,onlyview: false"/>
                            </td>
                            <th class="th" align="right" style="width: 60px;">类型：</th>
                            <td class="tdr">
                                <input class="easyui-combobox" id="type" name="type" style="width: 215px"
                                       data-options="required:true,editable:true,onlyview: false,onChange:changeType"/>
                            </td>
                        </tr>
                        <tr>
                            <th class="tdl">来源文件：</th>
                            <td class="tdr">
                                <input class="easyui-textbox" name="formerSource" id="formerSource" data-options="multiline:true,
                                required:false,editable:true,onlyview: false" style="height:60px; width:89%;"/>
                            </td>
                            <th class="th" align="right" style="width: 60px;">章节：</th>
                            <td class="tdr">
                                <input class="easyui-combobox" id="ata" name="ata"
                                       data-options="required:true,editable:true" style="width: 215px;"/>
                            </td>
                        </tr>
                        <tr>
                            <th class="tdl">适用性：</th>
                            <td colspan="3" class="tdr">
                                <input class="easyui-textbox" name="formerAppl" id="formerAppl"
                                       data-options="multiline:true,required:false,editable:true,onlyview: false"
                                       style="height:60px; width:89%;"/>
                            </td>
                        </tr>
                        <tr>

                            <th class="th" align="right" style="width: 60px;">首检：</th>
                            <td colspan="1" class="tdr">
                                <input class="easyui-textbox" name="formerThresholdDesc" id="formerThresholdDesc"
                                       data-options="multiline:true,required:false,editable:true,onlyview: false"
                                       style="height:60px; width: 74%;"/>
                            </td>
                            <th class="th" align="right" style="width: 60px;">重检 ：</th>
                            <td colspan="1" class="tdr">
                                <input class="easyui-textbox" name="formerIntervalDesc" id="formerIntervalDesc"
                                       data-options="multiline:true,required:false,editable:true,onlyview: false"
                                       style="height:60px; width: 74%;"/>
                            </td>
                        </tr>
                        <tr>
                            <th class="tdl">任务描述：</th>
                            <td colspan="5" class="tdr">
                                <input class="easyui-textbox" name="formerTaskDesc" id="formerTaskDesc"
                                       data-options="multiline:true,required:false,editable:true,onlyview: false"
                                       style="height:60px; width:89%;"/>
                            </td>
                        </tr>
                        <tr>
                            <th class="tdl">工卡号：</th>
                            <td colspan="3" class="tdr">
                                <input class="easyui-textbox" id="formerTaskNo" name="formerTaskNo"
                                       data-options="multiline:true,required:false,editable:true,onlyview:false"
                                       style="height:40px; width:89%;"/>
                            </td>
                        </tr>
                    </table>
                </fieldset>
                <fieldset class="fieldset_eui" style="width:100%;margin-right:5px">
                    <legend data-i18n="">评估信息</legend>
                    <table class="table table-bordered table-info">
                        <tr>
                            <th class="th" align="right" style="width: 60px;">顺丰MP号：</th>
                            <td class="tdr">
                                <input class="easyui-combogrid" id="itemNumber" name="itemNumber" style="width: 215px"
                                       data-options="required:true,editable:true"/>
                            </td>
                            <th class="th" align="right" style="width: 100px;">是否修订现有MP：</th>
                            <td class="tdr">
                                <input style="width: 200px" class="easyui-comboxbox" id="ifRevCmp" name="ifRevCmp"
                                       data-options="required:true,editable:true"/>
                            </td>
                        </tr>
                        <tr id="showArea">
                            <th class="th" align="right" style="width: 60px;">项目分类：</th>
                            <td class="tdr">
                                <input class="easyui-textbox" id="itemType" name="itemType" style="width: 215px"
                                       data-options="required:true,editable:true"/>
                            </td>
                            <th class="th" align="right" style="width: 100px;">适用类型：</th>
                            <td class="tdr">
                                <input style="width: 200px" class="easyui-textbox" id="applType" name="applType"
                                       data-options="required:true,editable:true"/>
                            </td>
                        </tr>
                        <tr>

                            <th class="th" align="right" style="width: 60px;">首检：</th>
                            <td colspan="1" class="tdr">
                                <input class="easyui-textbox" name="thresholdDesc" id="thresholdDesc"
                                       data-options="multiline:true,required:false,editable:true"
                                       style="height:60px; width: 74%;"/>
                            </td>
                            <th class="th" align="right" style="width: 60px;">重检 ：</th>
                            <td colspan="1" class="tdr">
                                <input class="easyui-textbox" name="intervalDesc" id="intervalDesc"
                                       data-options="multiline:true,required:false,editable:true"
                                       style="height:60px; width: 74%;"/>
                            </td>
                        </tr>
                        <tr>
                            <th class="th" align="right" style="width: 60px;">评估结论：</th>
                            <td class="tdr">
                                <input style="width: 219px" class="easyui-combobox" id="evalResult" name="evalResult"
                                       data-options="required:true,editable:true,onChange:changeItemNumber"/>
                            </td>
                            <th class="th" align="right" style="width: 60px;">过渡措施：</th>
                            <td class="tdr">
                                <input style="width: 200px" class="easyui-combobox" id="tempMeasures"
                                       name="tempMeasures"
                                       data-options="required:true,editable:true"/>
                            </td>
                        </tr>
                        <tr>
                            <th class="tdl">评估分析：</th>
                            <td colspan="3" class="tdr">
                                <input class="easyui-textbox" name="evalAnalysis" id="evalAnalysis"
                                       data-options="multiline:true,required:false,editable:true"
                                       style="height:60px; width:89%;"/>
                            </td>
                        </tr>
                        <tr>
                            <th class="tdl">工卡号：</th>
                            <td colspan="3" class="tdr">
                                <input class="easyui-textbox" name="taskNo" id="taskNo"
                                       data-options="multiline:true,required:false,editable:true,onlyview:false"
                                       style="height:40px; width:89%;"/>
                            </td>
                        </tr>
                    </table>
                </fieldset>
            </form>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var param;
    var PAGE_DATA = {};
    var pkid = null;//主表PKID
    var datetype = null;
    var operatioin = null;
    var parentPkid = null;
    var fleet = null;

    function i18nCallBack() {
        param = getParentParam_();
        pkid = param.pkid;
        datetype = param.type;
        operatioin = param.operatioin;
        parentPkid = param.parentPkid;
        fleet = param.fleet;
        $("#pkid").val(pkid);
        if(datetype == 'ADD'){
            $("#parentPkid").val(parentPkid);
        }

        InitFuncCodeRequest_({
            data: {
                domainCode: "EM_AC_IN_CHECK_EVAL_RESULT,EM_AC_IN_CHECK_TEMP_MEASUTRS,YESORNO,EM_AC_IN_CHECK_TYPE,DM_ATA",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#evalResult').combobox({
                        panelHeight: '100',
                        editable: false,
                        data: jdata.data.EM_AC_IN_CHECK_EVAL_RESULT,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#type').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_AC_IN_CHECK_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#ata').combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_ATA,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#tempMeasures').combobox({
                        panelHeight: '100',
                        editable: false,
                        data: jdata.data.EM_AC_IN_CHECK_TEMP_MEASUTRS,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#ifRevCmp').combobox({
                        panelHeight: '100',
                        editable: false,
                        data: jdata.data.YESORNO,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    pkid = $("#pkid").val();
                    if (pkid) {
                        InitDataForm(pkid);
                    }
                    if (datetype == "EMR") {
                        $("#itemType").textbox({required: false});
                        $("#applType").textbox({required: false});
                        $("#showArea").hide();
                    }
                    if (datetype == "VIEM") {
                        $("#saveBtn").hide();
                    }
                    if(datetype == "ADD"){
                        $("#revCode").val("N");
                    }

                    $("#itemNumber").MyComboGrid({
                        idField: 'ITEM_NUMBER',  //实际选择值
                        textField: 'ITEM_NUMBER', //文本显示值
                        panelHeight: '220px',
                        width: 150,
                        params: {FunctionCode: 'EM_AC_IN_CHECK_ITEM_SELECT_MP',fleet:fleet},
                        columns: [[
                            {field: 'ITEM_NUMBER', title: 'MP编号', width: 50}
                        ]],
                        onHidePanel: function () {
                            var t = $("#itemNumber").val();
                            if (selectRow == null || t != selectRow.ITEM_NUMBER) {//没有选择或者选项不相等时清除内容
                                alert('请选择，不要直接输入！');
                                $(this).combogrid({value: ''});
                            }
                        },
                        onSelect: function (index, row) {
                            selectRow = row;
                            $("#itemNumber").val(row.ITEM_NUMBER);
                            $("#thresholdDesc").textbox("setValue",row.THRESHOLD_DESC);
                            $("#intervalDesc").textbox("setValue",row.INTERVAL_DESC);

                        }
                    });
                }
            }
        })
    }
    function changeType(){
        if ($('#type').combobox('getValue')=="EMR") {
            $("#itemType").textbox({required: false});
            $("#applType").textbox({required: false});
            $("#showArea").hide();
        } else {
            $("#itemType").textbox({required: true});
            $("#applType").textbox({required: true});
            $("#showArea").show();
        }
    }

    function changeItemNumber(){

        //评估结论：顺丰有且一致/顺丰有但间隔不一致时，MP号为必填，其他情况为非必填
        var evalResult = $('#evalResult').combobox("getValue");
        var itemNumber = $('#itemNumber').combogrid("getValue");
        if(evalResult=="EQU"||evalResult=="EQUBINTV"){
            $("#itemNumber").combogrid({required: true});
            $("#itemNumber").combogrid({required: true});
        }else{
            $("#itemNumber").combogrid({required: false});
            $("#itemNumber").combogrid({required: false});
        }
        $('#itemNumber').combogrid({value: itemNumber});
    }
    //回填
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "EM_AC_IN_CHECK_ITEM_EDIT"}, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    $('#evalResult').combobox({value: jdata.data.EVAL_RESULT});
                    $('#itemNumber').combogrid({value: jdata.data.ITEM_NUMBER});
                    $('#type').combobox({value: jdata.data.TYPE});
                    $('#tempMeasures').combobox({value: jdata.data.TEMP_MEASURES});
                    $('#ata').combobox({value: jdata.data.ATA});
                    if (!jdata.data.IF_REV_CMP == "Y" || jdata.data.IF_REV_CMP == undefined) {
                        $('#ifRevCmp').combobox({value: "N"});
                    }
                    if (datetype == "VIEM") {
                        $("#div [textboxname]").each(function (k, it) {
                            if ($(it).hasClass("combobox-f")) {
                                $(it).combobox({required: false, editable: false, onlyview: true});
                            } else if ($(it).hasClass("textbox-f")) {
                                $(it).textbox({required: false, editable: false, onlyview: true});
                            } else {
                                $(it).datetimebox({required: false, editable: false, onlyview: true});
                            }
                        });
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }
    function validData(){
        //顺丰有且一致时，过渡措施禁选过渡检需执行
        var evalResult = $('#evalResult').combobox("getValue");
        var tempMeasures = $('#tempMeasures').combobox("getValue");
        if(evalResult=="EQU" && tempMeasures=="EXEC"){
            alert("【评估结论】为'顺丰有完全一致的对应条目'则【过渡措施】不可选择'过渡检需执行'。");
            return false;
        }
        return true;
    }
    // 保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        if(!validData()){
            return;
        }
        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas = $.extend({}, datas, {FunctionCode: 'EM_AC_IN_CHECK_ITEM_SAVE'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    param.OWindow.emrDgReload();
                    param.OWindow.MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    function closeW() {
        CloseWindowIframe();
    }
</script>

</html>