<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>评估时限</title>
</head>

<body>
<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <input type="hidden" id="pkid" name="pkid"/>
                <input type="hidden" id="status" name="status"/>
                <table class="table table-bordered table-info">
                    <tr>
                        <td id="baocun" align="right" style="width:20% ">
                            <input class="btn btn-primary" type="button" id="submit" onclick="save()" value="保存"/>
                            <input class="btn btn-primary" type="button" id="submitFlow" onclick="commit()"
                                   value="提交校对"/>
                            <input class="btn btn-primary" type="button" id="close" onclick=" CloseWindowIframe()"
                                   value="关闭"/>
                        </td>
                    </tr>
                </table>
                <fieldset class="fieldset_eui" style="width:100%;margin-right:5px">
                    <legend data-i18n="">时限信息</legend>
                    <table class="table table-bordered table-info">
                        <tr>
                            <th class="th" align="right" style="width: 80px;">机号：</th>
                            <td class="tdr">
                                <input class="easyui-textbox" id="acno" name="acno" style="width: 120px"
                                       data-options="required:true,editable:false,onlyview: true"/>
                            </td>
                            <th class="th" id="ataTh" align="right" style="width: 80px;">上一营运人 ：</th>
                            <td class="tdr" id="ataTd">
                                <input style="width: 120px" class="easyui-combobox" id="formerOperator"
                                       name="formerOperator"
                                       data-options="required:false,editable:false,onlyview: true"/>
                            </td>
                            <th class="th" align="right" style="width: 80px;">机队：</th>
                            <td class="tdr">
                                <input style="width: 120px" class="easyui-textbox" id="fleet" name="fleet"
                                       data-options="required:true,editable:false,onlyview: true"/>
                            </td>
                        </tr>
                        <tr>

                            <th class="th" align="right" style="width: 80px;">飞行小时：</th>
                            <td class="tdr">
                                <input style="width: 120px" id="fh" name="fh" class="easyui-numberbox"
                                       data-options="required:false,editable:true,onlyview: false"/>
                            </td>
                            <th class="th" align="right" style="width: 80px;">飞行循环：</th>
                            <td class="tdr">
                                <input style="width: 120px" class="easyui-numberbox" id="fc" name="fc"
                                       data-options="required:false,editable:true,onlyview: false"/>
                            </td>
                            <th class="th" align="right" style="width: 80px;">天数：</th>
                            <td class="tdr">
                                <input style="width: 120px" class="easyui-numberbox" id="dates" name="dates"
                                       data-options="required:false,editable:true,onlyview: false"/>
                            </td>
                        </tr>
                    </table>
                </fieldset>
                <fieldset class="fieldset_eui" style="float:left;width:98%;height:440px; margin-right:5px">
                    <legend data-i18n=""><!--前营运人EMR（经验项目）-->条目信息</legend>
                    <table class="table table-bordered table-info"
                           style="border-collapse:separate; border-spacing:0px 5px;">
                        <tr>
                            <th data-i18n="" style="width:80px;padding-right: 6px;" align="right">类型：</th>
                            <td>
                                <input class="easyui-combobox" name="type" id="type"
                                       data-options="editable: true,onChange:changeItemType"
                                       style="width:130px"/>
                            </td>
                            <th data-i18n="" style="width:100px;padding-right: 6px;" align="right">前营运人方案号：</th>
                            <td>
                                <input class="easyui-comboxbox" name="formerMpNo" id="formerMpNo"
                                       data-options="editable: true"
                                       style="width:130px"/>
                            </td>
                            <th data-i18n="" style="width:80px;padding-right: 6px;" align="right">评估结论：</th>
                            <td>
                                <input class="easyui-combobox" name="evalResult" id="evalResult"
                                       data-options="editable: true"
                                       style="width:130px"/>
                            </td>
                            <th data-i18n="" style="width:80px;padding-right: 6px;" align="right">过渡措施：</th>
                            <td>
                                <input class="easyui-combobox" name="tempMeasures" id="tempMeasures"
                                       data-options="editable: true"
                                       style="width:130px"/>
                            </td>
                            <td style="right: auto" colspan="2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                &nbsp;&nbsp;
                                <a class="searchBtn" type="button" onclick="searchEmrData()"
                                   data-options="iconCls:'icon-search'">
                                    <span data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>
                                <a id="addButton" class="clearBtn" onclick="addButton()" data-options="iconCls:'icon-clear'">
                                <span data-i18n="common:COMMON_OPERATION.ADD">增加</span></a>
                            </td>
                        </tr>
                    </table>
                    <table cellspacing="0" cellpadding="2">
                    </table>
                    <table id="emrDg"></table>
                </fieldset>
                <!--<fieldset class="fieldset_eui" style="float:left;width:98%;height:420px; margin-right:5px">
                    <legend data-i18n="">前营运人MPD+顺丰MP全量</legend>
                    <table cellspacing="0" cellpadding="2">
                    </table>
                    <table id="mpdDg"></table>
                </fieldset>-->
            </form>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var param;
    var operation;
    var PAGE_DATA = {};
    var pkid = null;//主表PKID
    var mainType = null;
    var func = "";
    function i18nCallBack() {
        param = getParentParam_();
        pkid = param.pkid;
        mainType = param.type;
        $("#pkid").val(pkid);
        InitFuncCodeRequest_({
            data: {
                domainCode: "EM_TASK_TYPE,EM_AC_IN_CHECK_EVAL_RESULT,EM_AC_IN_CHECK_TEMP_MEASUTRS,EM_AC_IN_CHECK_TYPE,DM_COMPANY_CODE2",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    PAGE_DATA ["EM_AC_IN_CHECK_EVAL_RESULT"] = DomainCodeToMap_(jdata.data["EM_AC_IN_CHECK_EVAL_RESULT"]);
                    PAGE_DATA ["EM_AC_IN_CHECK_TEMP_MEASUTRS"] = DomainCodeToMap_(jdata.data["EM_AC_IN_CHECK_TEMP_MEASUTRS"]);
                    PAGE_DATA ["EM_AC_IN_CHECK_TYPE"] = DomainCodeToMap_(jdata.data["EM_AC_IN_CHECK_TYPE"]);
                    pkid = $("#pkid").val();
                    $('#formerOperator').combobox({
                        panelHeight: '100px',
                        data: jdata.data.DM_COMPANY_CODE2,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });

                    //jdata.data.EM_AC_IN_CHECK_TYPE.unshift({TEXT: "-select-", VALUE: ""});
                    $('#type').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_AC_IN_CHECK_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#type').combobox("setValue", "EMR");

                    jdata.data.EM_AC_IN_CHECK_EVAL_RESULT.unshift({TEXT: "-select-", VALUE: ""});
                    $('#evalResult').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_AC_IN_CHECK_EVAL_RESULT,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });

                    jdata.data.EM_AC_IN_CHECK_TEMP_MEASUTRS.unshift({TEXT: "-select-", VALUE: ""});
                    $('#tempMeasures').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_AC_IN_CHECK_TEMP_MEASUTRS,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    if (pkid) {
                        InitDataForm(pkid);
                        func = "EM_AC_IN_CHECK_EMR";
                        InitEmrDgGrid();
                        //InitMpdDgGrid();
                    }
                    if (mainType == "VIEW") {
                        $("#submit").hide();
                        $("#submitFlow").hide();
                        $("#close").hide();
                        $("#addButton").hide();
                    }
                    if (mainType == "RETURN"){
                        $("#submitFlow").hide();
                    }
                }
            }
        })
    }

    function InitEmrDgGrid() {
        $("#emrDg").MyDataGrid({
            identity: 'emrDg',
            //sortable: true,
            //singleSelect: true,
            //enableLineEdit: true,
            //fit: true,
            resize: function () {
                return {width: 1180, height: 410};
            },
            queryParams: {pkid: pkid},
            pageSize: 13,
            columns: {
                param: {FunctionCode: func},
                alter: {
                    EVAL_RESULT: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['EM_AC_IN_CHECK_EVAL_RESULT'][value];
                        }
                    },
                    TEMP_MEASURES: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['EM_AC_IN_CHECK_TEMP_MEASUTRS'][value];
                        }
                    },
                    TYPE: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['EM_AC_IN_CHECK_TYPE'][value];
                        }
                    }
                }
            },
            onLoadSuccess: function (data) {
            },
            validAuth: function (row, items) {
            },
            contextMenus: [{
                id: "m-evalItem", i18nText: "评估条目",
                onclick: function () {
                    var rowdata = getDG("emrDg").datagrid('getSelected');
                    var pkid = rowdata.PKID;
                    ShowWindowIframe({
                        width: 860,
                        height: 580,
                        param: {
                            pkid: pkid,
                            type: rowdata.TYPE,
                            fleet:$('#fleet').textbox("getValue")
                        },
                        title: "评估条目",
                        url: "/views/em/eminspecteval/evalItemDetail.shtml"
                    });

                }
            }, {
                id: "m-evalR", i18nText: "改版",
                onclick: function () {
                    var rowdata = getDG("emrDg").datagrid('getSelected');
                    var pkid = rowdata.PKID;
                    InitFuncCodeRequest_({
                        data: {
                            FunctionCode: "EM_AC_IN_CHECK_ITEM_REV",
                            pkid: pkid,
                            revCode: "R"
                        },
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                ShowWindowIframe({
                                    width: 860,
                                    height: 580,
                                    param: {
                                        pkid: pkid,
                                        type: rowdata.TYPE,
                                        fleet:$('#fleet').textbox("getValue")
                                    },
                                    title: "评估条目",
                                    url: "/views/em/eminspecteval/evalItemDetail.shtml"
                                });
                                //searchEmrData();
                            } else {
                                MsgAlert({content: jdata.msg, type: 'error'});
                            }
                        }
                    });
                }
            }, /*{
                id: "m-evalD", i18nText: "改版D",
                onclick: function () {
                    var rowdata = getDG("emrDg").datagrid('getSelected');
                    var pkid = rowdata.PKID;

                    InitFuncCodeRequest_({
                        data: {
                            FunctionCode: "EM_AC_IN_CHECK_ITEM_REV",
                            pkid: pkid,
                            revCode: "D"
                        },
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                MsgAlert({content: jdata.msg});
                                emrDgReload();
                            } else {
                                MsgAlert({content: jdata.msg, type: 'error'});
                            }
                        }
                    });
                }
            },*/{
                id: "m-evalDelete", i18nText: "删除",
                onclick: function () {
                    var rowdata = getDG("emrDg").datagrid('getSelected');
                    var pkid = rowdata.PKID;
                    var revCode = rowdata.REV_CODE;
                    if(revCode != "N"){
                        InitFuncCodeRequest_({
                            data: {
                                FunctionCode: "EM_AC_IN_CHECK_ITEM_REV",
                                pkid: pkid,
                                revCode: "D"
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: jdata.msg});
                                    emrDgReload();
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }else{
                        InitFuncCodeRequest_({
                            data: {
                                FunctionCode: "EM_AC_IN_CHECK_ITEM_DELETE",
                                pkid: pkid
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: jdata.msg});
                                    emrDgReload();
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }



                }
            }],
            onDblClickRow: function (index, field, value) {
                openDetai(value.PKID, "VIEM");
            },
            validAuth: function (row, items) {

                if (mainType == "VIEW") {
                    items['删除'].enable = false;
                } else {
                    items['删除'].enable = true;
                }

                if (mainType == "VIEW" || row.REV_CODE == "N") {
                    items['改版'].enable = false;
                } else {
                    items['改版'].enable = true;
                }

                if (mainType == "VIEW" || row.REV_CODE != "N") {
                    items['评估条目'].enable = false;
                } else {
                    items['评估条目'].enable = true;
                }

                return items;
            },
        });
    }
    function addButton(){
        ShowWindowIframe({
            width: 860,
            height: 580,
            param: {
                pkid: '',
                type: 'ADD',
                parentPkid:pkid,
                fleet:$('#fleet').textbox("getValue")
            },
            title: "增加条目",
            url: "/views/em/eminspecteval/evalItemDetail.shtml"
        });
    }

    function changeItemType() {
        var type = $('#type').combobox('getValue');
        if (type == "EMR") {
            func = "EM_AC_IN_CHECK_EMR";
        } else {
            func = "EM_AC_IN_CHECK_MPD";
        }
        InitEmrDgGrid();
        //$("#emrDg").datagrid("reload");
    }

    function openDetai(pkid, type) {
        ShowWindowIframe({
            width: 860,
            height: 580,
            param: {
                pkid: pkid,
                type: type,
                parentPkid:pkid,
                fleet:$('#fleet').textbox("getValue")
            },
            title: "查看条目",
            url: "/views/em/eminspecteval/evalItemDetail.shtml"
        });
    }


    //回填
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "EM_AC_IN_CHECK_EDIT"}, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }
    function validDate(){
        //飞行小时、飞行循环、天数，至少有一个
        var fh = $("#fh").numberbox("getValue");
        var fc = $("#fc").numberbox("getValue");
        var dates = $("#dates").numberbox("getValue");
        if(fh==""&&fc==""&&dates==""){
            alert("飞行小时、飞行循环、天数不能同时为空。");
            return false;
        }
        return true;
    }
    // 保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        if(!validDate()){
            return;
        }

        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas = $.extend({}, datas, {FunctionCode: 'EM_AC_IN_CHECK_SAVE'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    param.OWindow.onSearch_('dg', '#ffSearch');
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    //param.OWindow.MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    // CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    function commit() {
        //var rowData = getDG('dg').datagrid('getSelected');
        var evapkid = pkid;
        /*if (!rowData.PKID) {
            MsgAlert({content: "请选择数据！", type: 'error'});
            return;
        }*/
        if(!validDate()){
            return;
        }
        if($("#status").val()!="YCJ"&&$("#status").val()!="PGZ"){
            MsgAlert({content: "该数据已被提交过了。", type: 'error'});
            return;
        }
        var evalResultMsg = null;
        //评价结论，过渡措施不能为空。
        InitFuncCodeRequest_({
            data: {pkid: evapkid, FunctionCode: "EM_AC_IN_CHECK_FOR_EVAL_RESULT"},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE && jdata.data != null) {
                    console.info(jdata.data);
                    evalResultMsg = "前营运人方案号:【" + jdata.data.FORMER_MP_NO + "】评估结论、过渡措施不能为空。"
                }
            }
        });
        if (evalResultMsg != null) {
            MsgAlert({content: evalResultMsg, type: 'warn'});
            return;
        }

        common_add_edit_({
            identity: '', isEdit: '', width: 520, height: 300, title: $.i18n.t('选择审批人'),
            param: {
                roleId: '',
                otherParam: evapkid,
                FunctionCode_: 'EM_AC_IN_CHECK_SUMBIT',
                successCallback: reload_,
                flowKey:'emAcInCheckFlow'
            },
            url: "/views/flow/work_flow_account_select.shtml"
        });
    }

    function reload_() {
        param.OWindow.onSearch_('dg', '#ffSearch');
        CloseWindowIframe();
    }

    //重置
    function doClear_() {
        $("#ffSearch").form('clear');
        searchEmrData();
    }
    //查询
    function searchEmrData() {
        onSearch_('emrDg', '#mform');
    }

    function emrDgReload() {
        $('#emrDg').datagrid('reload');
    }

</script>

</html>