<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
    <script type="text/javascript" src="/js/em/common_em.js"></script>
    <title></title>
</head>
<body>

<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform" action="" method="POST" enctype="multipart/form-data">
                <table class="table table-bordered table-info">
                    <caption style="padding-bottom: 7px;font-weight:bold;">新增方案更改单</caption>
                </table>
                <table class="table table-bordered table-info">
                    <tr>
                        <td class="tdl" colspan="9">
                            &nbsp;&nbsp;<a class="searchBtn" id="preBtn" onclick="print();">预览</a>
                            &nbsp;&nbsp;<a class="searchBtn" id="saveBtn" onclick="save();">保存</a>
                            &nbsp;&nbsp;<a class="searchBtn" id="subBtn" onclick="sub();">提交</a>
                            &nbsp;&nbsp;<a class="searchBtn" style="margin-right: 20px;" onclick="CloseWindowIframe();">关闭</a>
                        </td>
                    </tr>
                </table>
                <table class="table table-bordered table-info">
                    <tr>
                        <th class="tdr" style="width:100px;" align="left" colspan="6">申请信息：</th>
                    </tr>
                    <tr>
                        <th class="td5" style="width:100px;" align="right">更改单号：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="applyNo" name="applyNo"
                                   data-options="onlyview:true,editable:false,validType:['maxLength[30]'],prompt:'系统自动生成'"
                                   style="width: 200px"/>
                        </td>
                        <th class="td5" style="width:100px;" align="right">机队：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="fleet" name="fleet"
                                   data-options="required:true,validType:['maxLength[10]']" style="width: 200px"/>
                        </td>
                        <th class="td5" style="width:100px;" align="right">ATA：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="ata" name="ata" data-options="required:false"
                                   style="width: 200px"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="td5" style="width:100px;" align="right">更改内容和理由：</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox" id="applyDesc" name="applyDesc"
                                   data-options="required:true,multiline:true,validType:['maxLength[2000]']"
                                   style="height:80px;width: 865px"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="td5" style="width:100px;" align="right">更改者：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="applyName" name="applyName"
                                   data-options="onlyview:true,editable:false,validType:['maxLength[30]']"
                                   style="width: 200px"/>
                        </td>
                        <th class="td5" style="width:100px;" align="right">日期：</th>
                        <td class="tdr">
                            <input class="easyui-datetimebox" id="applyDate" name="applyDate"
                                   data-options="onlyview:true,editable:false" style="width: 200px"/>
                        </td>
                        <th class="td5" style="width:100px;" align="right">过渡截止日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="gracePeriod" name="gracePeriod"
                                   data-options="required:true" style="width: 200px"/>
                        </td>
                    </tr>
                    <tr hidden="hidden">
                        <th class="td5" style="width:100px;" align="right">修订方案版本：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="cmpVer" name="cmpVer" data-options="required:false"
                                   style="width: 200px"/>
                        </td>
                        <th class="td5" style="width:100px;" align="right">方案修订类型：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="cmpVerType" name="cmpVerType"
                                   data-options="required:false" style="width: 200px"/>
                        </td>

                    </tr>
                    <tr>

                    </tr>
                    <tr>
                        <th class="td5" style="width:100px;" align="right">备注：</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox" id="remark" name="remark"
                                   data-options="multiline:true,validType:['maxLength[2000]']"
                                   style="height:80px;width: 865px"/>
                        </td>
                    </tr>
                </table>
                <table class="table table-bordered table-info">
                    <tr>
                        <th class="tdr" style="width:100px;" align="left" colspan="5">预修订项目清单：</th>
                        <td class="tdl" style="width: 220px;">
                            &nbsp;&nbsp;<a class="searchBtn" id="yxdBtn" onclick="yxd();">预修订</a>
                            &nbsp;&nbsp;<a class="searchBtn" id="ybxBtn" onclick="ybx();">预新增</a>
                        </td>
                    </tr>
                </table>
                <table id="dg"></table>
                <table class="table table-bordered table-info">
                    <tr>
                        <th class="tdr" style="width:100px;" align="left" colspan="5">相关附件：</th>
                        <td class="tdl" style="width: 220px;">
                            &nbsp;&nbsp;<a class="searchBtn" id="uploadBtn" onclick="uploadFile();">上传附件</a>
                        </td>
                    </tr>
                </table>
                <table id="dg1"></table>
            </form>
        </div>
    </div>
</div>
</body>
<script type="text/javascript">
    var param;
    var operation;
    var applyNo;
    var cmprevApply;
    var PAGE_DATA = {};
    var segPkid = '';
    var evaPkid = '';
    var emFileEvaId = '';
    var fleet = "";

    function i18nCallBack() {
        param = getParentParam_();
        segPkid = param.segPkid;
        evaPkid = param.evaPkid;
        emFileEvaId = param.emFileEvaId;
        fleet = param.fleet;
        cmprevApply = param.cmprevApply;
        operation = param.operation;
        applyNo = param.APPLY_NO ? param.APPLY_NO : '';
        InitFuncCodeRequest_({
            data: {
                domainCode: "DA_FLEET,DA_ATA,EM_IF_REV_CMP,EM_IF_APPL,EM_APPL_TYPE,EM_MPD_CTL_TYPE,CMP_VER_TYPE,CMP_VER",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    PAGE_DATA ["ifRevCmp"] = DomainCodeToMap_(jdata.data["EM_IF_REV_CMP"]);
                    PAGE_DATA ["ifAppl"] = DomainCodeToMap_(jdata.data["EM_IF_APPL"]);
                    PAGE_DATA ["applType"] = DomainCodeToMap_(jdata.data["EM_APPL_TYPE"]);
                    PAGE_DATA ["ctlType"] = DomainCodeToMap_(jdata.data["EM_MPD_CTL_TYPE"]);

                    jdata.data.DA_ATA.push({TEXT: "XX", VALUE: "XX", NAME: "XX"});
                    $('#fleet').combobox({
                        panelHeight: '150',
                        editable: true,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        data: jdata.data.DA_FLEET,
                        onSelect: function (item) {
                            InitFuncCodeRequest_({
                                data: {fleet: item.VALUE, FunctionCode: "GET_CMP_VER"},
                                successCallBack: function (jdata) {
                                    $('#cmpVer').MyComboGrid({
                                        panelHeight: '180',
                                        editable: true,
                                        width: 200,
                                        data: jdata.data,
                                        columns: [[
                                            {field: 'FLEET', title: '机对', width: 50},
                                            {field: 'CMP_VER', title: '修订方案版本', width: 50}
                                        ]],
                                        idField: 'CMP_VER',  //实际选择值
                                        textField: 'CMP_VER', //文本显示值
                                        onSelect: function () {
                                            var fleet = $("#fleet").combobox('getValue');
                                            var cmpVer = $("#cmpVer").combobox('getValue');
                                            InitFuncCodeRequest_({
                                                data: {fleet: fleet, cmpVer: cmpVer, FunctionCode: "GET_CMP_VER_TYPE"},
                                                successCallBack: function (jdata) {
                                                    for (var i = 0; i < jdata.data.length; i++) {
                                                        console.log(jdata.data[i].VALUE);
                                                        if (jdata.data[i].VALUE == "F") {
                                                            $('#cmpVerType').combobox('setValue', "正式");
                                                        } else if (jdata.data[i].VALUE == "T") {
                                                            $('#cmpVerType').combobox('setValue', "临时");
                                                        }
                                                    }
//                                                    $('#cmpVerType').combobox({
//                                                        panelHeight: '48',
//                                                        editable: true,
//                                                        data: jdata.data,
//                                                        valueField: 'VALUE',
//                                                        textField: 'TEXT'
//                                                    });
                                                }
                                            })
                                        }
                                    });
                                }
                            })
                        }
                    });
                    $('#ata').combobox({
                        panelHeight: '150',
                        editable: true,
                        multiple: true,
                        data: jdata.data.DA_ATA,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
//                    $('#cmpVer').MyComboGrid({
//                        panelHeight: '180',
//                        editable: true,
//                        width: 200,
//                        params: {FunctionCode: 'GET_CMP_VER',fleet:fleet},
//                        columns: [[
//                            {field: 'FLEET', title: '机对', width: 50},
//                            {field: 'CMP_VER', title: '修订方案版本', width: 50}
//                        ]],
//                    });
                    $('#cmpVerType').combobox({
                        panelHeight: '48',
                        editable: true,
                        data: jdata.data.CMP_VER_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });

                    if ('add' == operation) {
                        var remark = '※ 若涉及CCAR-121R5要求的相关标识的，需在涉及工卡对应栏目中增加相关字符。\n' +
                            '※ 注意RII、TCI、Dual_M分别对附录三、附录五和附录十的联动修订。';
                        $('#remark').textbox('setValue', remark);

                    } else if ('edit' == operation) {

                    } else if ('view' == operation) {
                        $("#saveBtn").hide();
                        $("#subBtn").hide();
                        $("#yxdBtn").hide();
                        $("#ybxBtn").hide();
                        $("#uploadBtn").hide();
                    }
                    //回显数据
                    InitDataForm();
                    generateIntervals();
                    InitDataGrid();
                    InitDataGrid1();

                }
            }
        });
    }

    //回显数据
    function InitDataForm() {
        //工程文件调用该参数cmprevApply，请勿随意删除，后果自负
        if (cmprevApply) {
            applyNo = cmprevApply;
        }
        InitFuncCodeRequest_({
            async: false,
            data: {applyNo: applyNo, FunctionCode: "EM_CMPREV_APPLY_INIT_ONE"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    var ata = jdata.data.ATA;
                    $("#ata").combobox('setValue', ata.split(','));
                    if ("view" == operation) {
                        onlyViewEasyUI_();
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    function InitDataGrid() {
        var identity = "dg";
        $("#dg").MyDataGrid({
            identity: 'dg',
            singleSelect: true,
            pageSize: 15,
            enableLineEdit: false,
            resize: function () {
                return {width: '100%', height: 300};
            },
            queryParams: {applyNo: applyNo},
            columns: {
                param: {FunctionCode: 'EM_EVAL_CMPREV_ITEM_LIST'},
                alter: {
                    IF_REV_CMP: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['ifRevCmp'][value];
                        }
                    },
                    IF_APPL: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['ifAppl'][value];
                        }
                    },
                    APPL_TYPE: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['applType'][value];
                        }
                    },
                    CTL_TYPE: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['ctlType'][value];
                        }
                    },
                    EVAL_DATE: {
                        type: 'date'
                    },
                    APPLICABILITY: {
                        formatter: function (value) {
                            return newLineFlyDetaile(value, 10);
                        }
                    },
                    APPLY_ACNOS: {
                        formatter: function (value) {
                            return newLineFlyDetaile(value, 10);
                        }
                    },
                    NOAPPLY_ACNOS: {
                        formatter: function (value) {
                            return newLineFlyDetaile(value, 10);
                        }
                    },
                }
            },
            validAuth: function (row, items) {
                if (operation == 'view') {
                    items['编辑'].enable = false;
                    items['删除'].enable = false;
                }
                return items;
            },
            contextMenus: [
                {
                    id: "m-edit", i18nText: "编辑", auth: "",
                    onclick: function () {
                        var rowdata = getDG(identity).datagrid('getSelected');
                        var evalNo = rowdata.EVAL_NO;
                        var itemNumber = rowdata.TASK_NUMBER;
                        var isUdf = rowdata.DOC_TYPE == "UDF" ? 'Y' : 'N';
                        var fleetPass = rowdata.FLEET;
                        common_add_edit_({
                            identity: 'dg',
                            //isEdit: '1',
                            width: 1200,
                            height: 620,
                            title: $.i18n.t('MPD评估单'),
                            param: {
                                evalNo: evalNo,
                                Flag: '1',
                                isUdf: isUdf,
                                isEdit: 1,
                                itemNumber: itemNumber,
                                fleetPass: fleetPass,
                                applyNo: $("#applyNo").textbox("getValue")
                            },
                            /* param: {
                                 isEdit: '1',
                                 fleet:$("#fleet").combobox("getValue"),
                                 ata:$("#ata").combobox("getValue"),
                                 applyNo:$("#applyNo").textbox("getValue"),
                                 evalNo:evalNo
                             },*/
                            url: "/views/em/emmpdeval/em_mpd_eval_evalnote.shtml"
                        });
                    }
                },
                {
                    id: "m-edit", i18nText: "删除", auth: "",
                    onclick: function () {
                        var rowData = getDG("dg").datagrid('getSelected');
                        InitFuncCodeRequest_({
                            data: {evalNo: rowData.EVAL_NO, FunctionCode: "EM_CMPREV_APPLY_DELETE_EVAL"},
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    InitDataGrid();
                                }
                            }
                        })
                    }
                }
            ]
        });
    }

    function InitDataGrid1() {
        $("#dg1").MyDataGrid({
            identity: 'dg1',
            singleSelect: true,
            pageSize: 15,
            enableLineEdit: false,
            resize: function () {
                return {width: '100%', height: 200};
            },
            queryParams: {fileCategory: 'CMPREVAPPLY', sourceId: applyNo},
            columns: {
                param: {FunctionCode: 'EM_CMPREV_APPLY_FILE_LIST'},
                alter: {}
            },
            validAuth: function (row, items) {
                if (operation == 'view') {
                    items['删除'].enable = false;
                }
                return items;
            },
            contextMenus: [
                {
                    id: "m-delete", i18nText: "删除", auth: "",
                    onclick: function () {
                        var rowData = $("#dg1").datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: '请选择文件！', type: 'error'});
                            return;
                        }
                        $.messager.confirm('', '是否刪除？', function (r) {
                            if (r) {
                                var fileId = rowData.PKID;
                                InitFuncCodeRequest_({
                                    data: {pkid: rowData.PKID, FunctionCode: 'ATTACHMENT_DEL'},
                                    successCallBack: function (jdata) {
                                        if (jdata.code == 200) {
                                            InitFuncCodeRequest_({
                                                data: {
                                                    applyNo: applyNo,
                                                    fileId: fileId,
                                                    operFlag: 'del',
                                                    FunctionCode: 'EM_CMPREV_APPLY_UPATE_REVFILES'
                                                },
                                                successCallBack: function (jdata1) {
                                                    if (jdata1.code == 200) {
                                                        MsgAlert({content: jdata1.msg ? jdata1.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                                        reload_1();
                                                    }

                                                }
                                            });

                                        }
                                    }
                                });
                            }
                        });
                    }
                },
                {
                    id: "m-download", i18nText: "下载", auth: "",
                    onclick: function () {
                        var rowData = $('#dg1').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: '请选择文件！', type: 'error'});
                            return;
                        }
                        downFileLocal(rowData.PKID);
                    }
                }
            ]
        });
    }

    //保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate) {
            return;
        }
        var datas = $("#mform").serializeObject();
        var ata = $("#ata").combogrid("getValues");
        datas['ata'] = ata.toString();
        datas = $.extend({segPkid: segPkid}, {evaPkid: evaPkid}, datas, {FunctionCode: 'EM_CMPREV_APPLY_ADD_EDIT'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    console.log(jdata.data);
                    param.OWindow.onSearch_();
                    if (segPkid != undefined && segPkid != "") {
                        param.OWindow.reloadParam_("#ass");
                    }
                    if (emFileEvaId != undefined && emFileEvaId != "") {
                        param.OWindow.setCmpApply(jdata.data.applyNo);
                    }
                    if (jdata.data) {
                        $("#applyNo").textbox('setValue', jdata.data.applyNo);
                        applyNo = jdata.data.applyNo;
                        $("#applyBy").val(jdata.data.applyManId);
                        $("#applyName").textbox('setValue', jdata.data.applyName);
                        $("#applyDate").datetimebox('setValue', jdata.data.applyDate);
                        param.APPLY_STATE = jdata.data.applyState;
                    }
                } else {
                    MsgAlert({content: jdata.msgData ? jdata.msgData[0] : jdata.msg, type: 'error'});
                }
            }
        });
    }

    //提交
    function sub() {
        if (!applyNo || applyNo == '') {
            MsgAlert({content: '请先保存后再提交！', type: 'error'});
            return;
        }
        if (param.APPLY_STATE != '01' && param.APPLY_STATE != '11') {
            MsgAlert({content: '状态不是已创建或者任务回退，不允许提交！', type: 'error'});
            return;
        }
        common_add_edit_({
            identity: '', isEdit: '', width: 520, height: 300, title: $.i18n.t('选择审批人'),
            param: {
                roleId: '',
                otherParam: applyNo,
                FunctionCode_: 'EM_CMPREV_APPLY_SUBMIT',
                successCallback: reload_M
            },
            url: "/views/em/workflow/work_flow_account_select.shtml"
        });
    }

    //上传文件
    function uploadFile() {
        if (!applyNo || applyNo == '') {
            MsgAlert({content: '请先保存后再上传文件！', type: 'error'});
            return;
        }
        common_upload_({
            identity: 'dg1',
            param: {
                cat: 'CMPREVAPPLY',
                sourceId: applyNo,
                PKID: applyNo,
                successCallBack: reload_1,
                failCallBack: ""
            }
        });
    }

    function common_upload_(edopt) {
        var title_ = $.i18n.t('common:COMMON_OPERATION.UPLOAD');
        var fleet = $('#fleet').combobox('getValue');
        ShowWindowIframe({
            width: 575,
            height: 400,
            title: title_,
            param: $.extend({}, edopt.param),
            url: '/views/em/emcmp/attachment_add.shtml?fleet=' + fleet
        });
    }

    //预修订
    function yxd() {
        if ($("#applyNo").textbox("getValue") == "") {
            alert("请先保存方案更改单。");
            return;
        }
        common_add_edit_({
            identity: '', isEdit: '', width: 1200, height: 620, title: $.i18n.t('MPD评估单'),
            param: {applyNo: $("#applyNo").textbox("getValue"), successCallback: ''},
            url: "/views/em/emmpdeval/em_mpd_eval_rev_list.shtml"
        });
    }

    //预编写
    function ybx() {
        if ($("#applyNo").textbox("getValue") == "") {
            alert("请先保存方案更改单。");
            return;
        }
        common_add_edit_({
            identity: '', isEdit: '', width: 1200, height: 620, title: $.i18n.t('MPD评估单'),
            param: {
                fleet: $("#fleet").combobox("getValue"),
                ata: $("#ata").combobox("getValue"),
                applyNo: $("#applyNo").textbox("getValue")
            },
            url: "/views/em/emmpdeval/em_mpd_eval_evalnote.shtml"
        });
    }

    function reload_() {
        $("#dg").datagrid("reload", {applyNo: applyNo});
    }

    function reload_1() {
        $("#dg1").datagrid("reload", {fileCategory: 'CMPREVAPPLY', sourceId: applyNo});
        param.OWindow.onSearch_();
    }

    function reload_M() {
        param.OWindow.onSearch_();
        CloseWindowIframe();
    }

    //换行
    function newLineFlyDetaile(str, n) {
        if (isEmpty(str)) {
            return;
        }
        strs = str.split(',');
        len = strs.len;
        if (len <= n) {
            return str;
        } else {
            var ret = '';
            $.each(strs, function (index, data) {
                if ((index + 1) % n == 0) {
                    ret += data + ',' + '<br>';
                } else {
                    ret += data + ','
                }
            });
            return ret.substring(0, ret.length - 1);
        }
    }

    function print() {
        if (!applyNo || applyNo == '') {
            MsgAlert({content: '请先保存后再预览！', type: 'error'});
            return;
        }
        if (applyNo != null && applyNo != '') {
            ajaxLoading();
            InitFuncCodeRequest_({
                data: {
                    applyNo: applyNo,
                    FunctionCode: "EM_CMPREV_APPLY_PRINTPDF"
                },
                successCallBack: function (jdata1) {
                    ajaxLoadEnd();
                    if (jdata1.code == 200) {
                        jcPreview(jdata1.data);
                    }
                    else {
                        MsgAlert({content: jdata1.msg, type: 'error'});
                    }
                }
            });
        }
    }

    function jcPreview(url) {
        ShowWindowIframe({
            width: 1200,
            height: 650,
            param: {url: url},
            title: "更改单预览PDF",
            url: "/views/em/emeo/emeo_add_pdf.shtml"
        });
    }

    //生成間隔
    function generateIntervals() {
        if (applyNo == null || applyNo == '') {
            return;
        }
        InitFuncCodeRequest_({
            async: false,
            data: {
                applyNo: applyNo,
                FunctionCode: "EM_CMPREV_APPLY_GENERATE_EXPRESSION"
            },
            successCallBack: function (jdata) {
                if (jdata.code == 200) {

                }
                else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }
</script>
</html>