<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="em_cmp">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
    <title></title>
    <style>
        #mform table tr th {
            width: 80px;
        }
    </style>
    <script type="text/javascript">

        //维修方案发布
        var isEdit_;
        var param = {};

        var userName = {};

        $(function () {
            param = getParentParam_();
            isEdit_ = param.pkid;
        });

        function i18nCallBack() {

            InitEditForm_();
            InitFuncCodeRequest_({
                data: {
                    //PM_MP_ACTYPE
                    domainCode: "EM_CMP_VER_TYPE,EM_CMP_STATE,USER_NAME,EM_REV_CODE",
                    FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
                },
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        userName = DomainCodeToMap_(jdata.data["USER_NAME"]);
                        //机队
                        $('#fleet').combobox({
                            panelHeight: '150px',
                            data: jdata.data.PM_MP_ACTYPE,
                            valueField: 'VALUE',
                            textField: 'TEXT'
                        });
                        //版本类型
                        $('#verType').combobox({
                            panelHeight: '150px',
                            data: jdata.data.EM_CMP_VER_TYPE,
                            valueField: 'VALUE',
                            textField: 'TEXT'
                        });
                        //状态
                        $('#status').combobox({
                            panelHeight: '150px',
                            data: jdata.data.EM_CMP_STATE,
                            valueField: 'VALUE',
                            textField: 'TEXT'
                        });
                        //改版标识
                        $('#revCode').combobox({
                            panelHeight: '150px',
                            data: jdata.data.EM_REV_CODE,
                            valueField: 'VALUE',
                            textField: 'TEXT'
                        });
                        // oldStatus
                        $('#oldStatus').combobox({
                            panelHeight: '150px',
                            data: jdata.data.EM_CMP_STATE,
                            valueField: 'VALUE',
                            textField: 'TEXT'
                        });

                        InitFuncCodeRequest_({
                            data: {
                                pkid: param.pkid,
                                FunctionCode: "EM_CMP_GETONE"
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                                    $("#createByName").textbox({value: userName[jdata.data.CREATE_BY]});
                                    ParseFormField_(jdata.data, null, Constant.CAMEL_CASE);
                                    bxr();
                                    //获取上一个版本
                                    InitFuncCodeRequest_({
                                        data: {
                                            fleet: jdata.data.FLEET,
                                            FunctionCode: "EM_CMP_OLD_ONE"
                                        },
                                        successCallBack: function (jdata) {
                                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                                                /* 上一版本号*/
                                                $("#oldMajorVer").textbox({value: jdata.data.MAJOR_VER});
                                                $("#oldMinorVer").textbox({value: jdata.data.MINOR_VER});
                                                $("#oldStatus").combobox({value: 'VALID'});
                                            }
                                            else {
                                                MsgAlert({content: jdata.msg, type: 'error'});
                                            }
                                        }
                                    });
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });

                        //编写人
                        /*   $('#createByName').textbox('setValue', getLoginInfo().userName);
                           $('#createBy').val(getLoginInfo().userId);*/
                    } else {
                        MsgAlert({content: jdata.msg, type: 'error'});
                    }
                }
            });
        }


        function DomainCodeToMap_(list) {
            var d = {};
            $.each(list, function (k, it) {
                d[it.VALUE] = it.TEXT;
            });
            return d;
        }

        //获取当前时间
        function formatDates(date) {
            var day = date.getDate() > 9 ? date.getDate() : "0" + date.getDate();
            var month = (date.getMonth() + 1) > 9 ? (date.getMonth() + 1) : "0"
                + (date.getMonth() + 1);
            var hor = date.getHours();
            var min = date.getMinutes();
            var sec = date.getSeconds();
            return date.getFullYear() + '-' + month + '-' + day + " " + hor + ":" + min + ":" + sec;
        }

        function bxr() {
            //校对人
            /* $('#checkByName').textbox('setValue', getLoginInfo().userName);
             $('#checkBy').val(getLoginInfo().userId);

             //审核人
             $('#auditbByName').textbox('setValue', getLoginInfo().userName);
             $('#auditBy').val(getLoginInfo().userId);

             //批准人
             $('#approveByName').textbox('setValue', getLoginInfo().userName);
             $('#approveBy').val(getLoginInfo().userId);

             //局方批准人
             $('#caacapproveByName').textbox('setValue', getLoginInfo().userName);
             $('#caacapproveBy').val(getLoginInfo().userId);
             */
            //发布人
           /*

            $('#createDate').datebox({value: formatDates(new Date())});
            $('#checkDate').datebox({value: formatDates(new Date())});
            $('#auditDate').datebox({value: formatDates(new Date())});
            $('#approveDate').datebox({value: formatDates(new Date())});*/
            $('#publishbByName').textbox('setValue', getLoginInfo().userName);
            $('#publishBy').val(getLoginInfo().accountId);
            $('#caacapproveDate').datebox({value: formatDates(new Date())});
            $('#publishDate').datebox({value: formatDates(new Date())});
            $('#validDate').datebox({value: formatDates(new Date())});
            $('#status').combobox('setValue', 'VALID');
        }

        //关闭按钮
        function baoCun() {
            var isValidate = $("#mform").form('validate');
            if (!isValidate)
                return;
            $.messager.confirm('', '是否要执行发布操作，执行操作后数据将不能回退', function (r) {
                if (r) {
                    saveFunction();
                } else {
                    return false;
                }
            });
        }

        function saveFunction() {
            var $form = $("#mform");
            var datas = $form.serializeObject();
            datas = $.extend({}, datas, {FunctionCode: 'EM_CMP_SX', pkid: param.pkid});
            InitFuncCodeRequest_({
                data: datas,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        param.OWindow.getCmpOne();
                        param.OWindow.reloadFym_();
                        CloseWindowIframe();

                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }

                }
            });
        }

        function InitEditForm_() {
            var $form = $("#mform");
            $form.form({});
        }

        function upload() {
            common_uploadFile({
                identity: 'dg',
                param: {
                    cat: "emCmpWxfaRelease",
                    sourceId: param.pkid,
                    successCellBack: function () {
                        CloseWindowIframe();
                    },
                    fialCellBack: ""
                }
            });
        }

        function common_uploadFile(edopt) {
            var title_ = $.i18n.t('common:COMMON_OPERATION.UPLOAD');
            ShowWindowIframe({
                width: 575,
                height: 200,
                title: title_,
                param: $.extend({}, edopt.param),
                url: "/views/impoertExcelData/attachment_add.shtml"
            });
        }

        //附件查看
        function viewAttach() {
            InitFuncCodeRequest_({
                data: {
                    SOURCE_ID: param.pkid,
                    CATEGORY: "emCmpWxfaRelease",
                    FunctionCode: 'ATTACHMENT_RSPL_GET'
                },
                successCallBack: function (jdata) {
                    //为0时提示没有上传附件，无法查看
                    if (jdata.data.length == 0) {
                        MsgAlert({content: "请先上传附件", type: 'error'});

                    } else {
                        //打开一个列表页面
                        ShowWindowIframe({
                            width: "515",
                            height: "285",
                            param: {
                                pkid: param.pkid,
                                category: "emCmpWxfaRelease",
                            },
                            url: "/views/data_manager/dm/upload/editAttach.shtml"
                        });
                    }
                }
            });
        }
    </script>
</head>
<body>

<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">

                <table class="table table-bordered table-info">
                    <tr>
                        <td colspan="6" align="right">
                            <input id="upBtn" class="btn btn-primary" type="button" onclick="upload()" value="上传"
                                   style="width: 50px;margin:5px;"/>
                            <input id="attBtn" class="btn btn-primary" type="button" onclick="viewAttach()" value="附件查看"
                                   style="width: 60px;margin:5px;"/>
                            <input class="btn btn-primary" onclick="baoCun()" type="button" value="发布"
                                   style="margin:5px;"/>

                        </td>
                    </tr>

                    <tr>
                        <th class="tdl">机队：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" name="fleet" id="fleet"
                                   data-options="required:true,editable:false,onlyview:true"
                                   style="height:25px; width: 150px;"/>
                        </td>
                        <th class="tdl">版本类型：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" name="verType" id="verType"
                                   data-options="required:true,editable:false,onlyview:true"
                                   style="height:25px; width:150px;"/>
                        </td>
                        <th class="tdl">版本：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" name="majorVer" id="majorVer"
                                   data-options="required:true,editable:false,onlyview:true"
                                   style="height:25px; width: 30px;" value="01"/>/
                            <input class="easyui-textbox" name="minorVer" id="minorVer"
                                   data-options="required:true,editable:false,onlyview:true"
                                   style="height:25px; width: 30px;" value="0"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="tdl">改版标识 ：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" name="revCode" id="revCode"
                                   data-options="required:true,editable:false,onlyview:true"
                                   style="height:25px; width: 150px;"/>
                        </td>
                        <th class="tdl">状态 ：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-combobox" name="status" id="status"
                                   data-options="required:true,editable:false,onlyview:true"
                                   style="height:25px; width:150px"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="tdl">编写人 ：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" name="createByName" id="createByName"
                                   data-options="editable:false,onlyview:true,required:true"
                                   style="height:25px; width: 150px;"/>
                            <input type="hidden" id="createBy" name="createBy"/>
                        </td>
                        <th class="tdl">编写日期 ：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-datebox" name="createDate" id="createDate"
                                   data-options="editable:false,onlyview:true,required:true"
                                   style="height:25px; width:150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="tdl">校对人 ：</th>
                        <td class="tdr" colspan="">
                            <input class="easyui-textbox" name="checkByName" id="checkByName"
                                   data-options="editable:false,onlyview:true,required:true"
                                   style="height:25px; width: 150px;"/>
                            <input type="hidden" id="checkBy" name="checkBy"/>
                        </td>

                        <th class="tdl">校对日期 ：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-datebox" name="checkDate" id="checkDate"
                                   data-options="editable:false,onlyview:true,required:true"
                                   style="height:25px; width:150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="tdl">审核人 ：</th>
                        <td class="tdr" colspan="">
                            <input class="easyui-textbox" name="auditByName" id="auditByName"
                                   data-options="editable:false,onlyview:true,required:true"
                                   style="height:25px; width: 150px;"/>
                             <input type="hidden" id="auditBy" name="auditBy"/>
                        </td>

                        <th class="tdl">审核日期 ：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-datebox" name="auditDate" id="auditDate"
                                   data-options="editable:false,onlyview:true,required:true"
                                   style="height:25px; width:150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="tdl">批准人 ：</th>
                        <td class="tdr" colspan="">
                            <input class="easyui-textbox" name="approveByName" id="approveByName"
                                   data-options="editable:false,onlyview:true,required:true"
                                   style="height:25px; width: 150px;"/>
                            <input type="hidden" id="approveBy" name="approveBy"/>
                        </td>
                        <th class="tdl">批准日期 ：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-datebox" name="approveDate" id="approveDate"
                                   data-options="editable:false,onlyview:true,required:true"
                                   style="height:25px; width:150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="tdl">局方批准人 ：</th>
                        <td class="tdr" colspan="">
                            <input class="easyui-textbox" name="caacapproveByName" id="caacapproveByName"
                                   data-options="editable:true,onlyview:false,required:true"
                                   style="height:25px; width: 150px;"/>
                            <input type="hidden" id="caacapproveBy" name="caacapproveBy"/>
                        </td>
                        <th class="tdl">局方批准日期 ：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-datebox" name="caacapproveDate" id="caacapproveDate"
                                   data-options="required:true"
                                   style="height:25px; width:150px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th class="tdl">发布人 ：</th>
                        <td class="tdr" colspan="">
                            <input class="easyui-textbox" name="publishbByName" id="publishbByName"
                                   data-options="editable:false,onlyview:true"
                                   style="height:25px; width: 150px;"/>
                            <input type="hidden" id="publishBy" name="publishBy"/>
                        </td>
                        <th class="tdl">发布日期 ：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-datebox" name="publishDate" id="publishDate"
                                   data-options="required:true"
                                   style="height:25px; width:150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="tdl">生效日期 ：</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-datebox" name="validDate" id="validDate"
                                   data-options="required:true"
                                   style="height:25px; width:150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="tdl">备注 ：</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox" name="memo" id="memo"
                                   data-options="required:true"
                                   style="height:25px; width:300px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="tdl">上一版本号：</th>
                        <td class="tdr" colspan="">
                            <input class="easyui-textbox" name="oldMajorVer" id="oldMajorVer"
                                   data-options="editable:false,onlyview:true"
                                   style="height:25px; width: 30px;"/>/
                            <input class="easyui-textbox" name="oldMinorVer" id="oldMinorVer"
                                   data-options="editable:false,onlyview:true"
                                   style="height:25px; width: 30px;"/>
                        </td>
                        <th class="tdl">上一版本状态 ：</th>
                        <td class="tdr" colspan="">
                            <input class="easyui-combobox" name="oldStatus" id="oldStatus"
                                   data-options="editable:false,onlyview:true"
                                   style="height:25px; width:150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="6">
                            注意：<br/>
                            1.发布之前，以上所有信息必须填写！发布之后。上一版本将存档，此版本将生效，之后不能再对此版本进行任何改动。只能
                            执行改版操作，（系统在继承上一版本的基础上生成一个新的草稿版本），然后再这个新版本上修改。
                            <br/>
                            2.发布时通知相关部门。
                        </td>
                    </tr>

                </table>
            </form>
        </div>
    </div>
</div>

</body>
</html>