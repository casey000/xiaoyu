<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html
        xmlns="http://www.w3.org/1999/html">
<head id="i18n_" module="emmpdeval">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>增加适用性</title>
</head>
<body>
<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <div class="form-horizontal m-t">
                <form id="mform">
                    <fieldset class="fieldset_eui">
                        <legend data-i18n="">适用范围</legend>
                        <table class="table table-bordered table-info">
                            <tr>
                                <input type="hidden" id="pkid" name="pkid">
                                <input type="hidden" id="rangeAll" name="rangeAll">
                                <th class="tdl">范围类型：</th>
                                <td class="tdr">
                                    <input class="easyui-combobox" name="rangeType" id="rangeType"
                                           data-options="editable:false,onChange:changeFormat"
                                           style="height:25px; width:193px;"/>
                                </td>
                                <th class="tdl">操作符：</th>
                                <td class="tdr">
                                    <input class="easyui-combobox" name="op" id="op"
                                           data-options="required:false,editable:false,onChange:changeFormat2"
                                           style="height:25px; width:193px;"/>
                                </td>

                            </tr>
                            <tr id="fwz">
                                <th class="tdl">范围值：</th>
                                <td class="tdr" colspan="3">
                                    <input class="easyui-textbox" name="rangeValue" id="rangeValue"
                                           data-options="required:false,editable:false,onlyview:true,multiline:true"
                                           style="height:60px; width:460px;"/>&nbsp;
                                    <a href="javascript:void(0)" id="xz" class="easyui-linkbutton"
                                       data-options="iconCls:'icon-add'"
                                       onclick="add_()"><span>选择</span></a>
                                </td>
                            </tr>
                            <tr id="fwz2">
                                <th class="tdl">范围值：</th>
                                <td class="tdr">
                                    <input class="easyui-textbox" name="rangeValue1" id="rangeValue1"
                                           data-options=""
                                           style="height:25px; width:193px;"/>&nbsp;
                                </td>

                                <th id="zhi" class="tdl">至：</th>
                                <td id="zhi1" class="tdr">
                                    <input class="easyui-textbox" name="rangeValue2" id="rangeValue2"
                                           data-options=""
                                           style="height:25px; width:193px;"/>&nbsp;
                                </td>
                            </tr>
                        </table>
                    </fieldset>
                    <!-- <fieldset class="fieldset_eui">
                         <legend data-i18n="">关联类型</legend>
                         <table class="table table-bordered table-info">
                             <tr>
                                 <th class="tdl">类型：</th>
                                 <td class="tdr">
                                     <input class="easyui-combobox" name="joinType" id="joinType"
                                            data-options="required:false,editable:false,onChange:changeFormat1"
                                            style="height:25px; width:193px;"/>
                                 </td>
                             </tr>
                         </table>
                     </fieldset>-->
                    <!--<div id="glzf">
                        <fieldset class="fieldset_eui">
                            <legend data-i18n="">关联范围</legend>
                            <table class="table table-bordered table-info">
                                <tr>
                                    <th class="tdl">范围类型：</th>
                                    <td class="tdr">
                                        <input class="easyui-combobox" name="joinRangeType" id="joinRangeType"
                                               data-options="required:false,editable:false"
                                               style="height:25px; width:193px;"/>
                                    </td>
                                    <th class="tdl">操作符：</th>
                                    <td class="tdr">
                                        <input class="easyui-combobox" name="joinOp" id="joinOp"
                                               data-options="required:false,editable:false"
                                               style="height:25px; width:193px;"/>
                                    </td>

                                </tr>

                            </table>
                        </fieldset>
                    </div>-->
                    <!-- <div id="glzfw">
                         <fieldset class="fieldset_eui" style="width:98%;margin-right:5px">
                             <legend data-i18n="">关联子范围</legend>
                             <table class="table table-bordered table-info">
                                 <tr>
                                     <td colspan="8" align="right">
                                         <a href="javascript:void(0)" style="margin:5px;" class="easyui-linkbutton"
                                            data-options=""
                                            onclick="addappl()"><span data-i18n="">增加子范围</span></a>
                                         &nbsp;&nbsp;
                                     </td>
                                 </tr>
                             </table>
                             <table id="dg1"></table>
                         </fieldset>
                     </div>-->
                    <fieldset class="fieldset_eui" style="width:98%;height:150px;margin-right:5px">
                        <legend data-i18n="">间隔-适用性-前后置条件</legend>
                        <table class="table table-bordered table-info">
                            <tr>
                                <td colspan="8" align="right">
                                    <input class="btn btn-primary" data-options="iconCls:'icon-filter'"
                                           type="button" id="QH" onclick="evalMemo()"
                                           style="margin-right:5px;margin-top:5px;float: right" value="增加前后置条件"/>
                                </td>
                            </tr>
                        </table>
                        <table id="dg2"></table>
                    </fieldset>


                    <table class="table table-bordered table-info">
                        <tr align="right">
                            <td colspan="8" align="right">
                                <input class="btn btn-primary" type="submit" value="保存" style="margin:5px;"/>
                                <input class="btn btn-primary" value="关闭" type="button" onclick="closeAdd()"
                                       style="margin:5px;"/>
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">

    var rangeValue1;
    var rangeValue2;
    var rangeValue;
    var isEdit_;
    var intervalPkid;
    var MPKID;
    var param = {};
    param = getParentParam_();
    intervalPkid = param.intervalPkid;//间隔主键
    MPKID = param.MPKID;//适用性pkid
    isEdit_ = param.isEdit;
    evalNo = param.evalNo;
    var fleet = param.fleet;
    if (!isEdit_) {
        $("#QH").attr("disabled", "true");
    }

    function i18nCallBack() {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "EM_RANGE_TYPE,EM_OP"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#rangeType').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_RANGE_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });

                    $('#op').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_OP,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }

            }
        });


        InitDataGrid2();
        InitEditForm_();
    }


    if (isEdit_) {
        $(function () {
            InitFuncCodeRequest_({
                data: {MPKID: MPKID, FunctionCode: "EM_CMP_APPLICABILITY"},
                successCallBack: function (jdata) {
                    $("#pkid").val(jdata.data.pkid);
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        ParseFormField_(jdata.data, null, Constant.CAMEL_CASE);
                        $('#rangeType').combobox({value: jdata.data.RANGE_TYPE});
                        $('#op').combobox({value: jdata.data.OP});
                        if (jdata.data.RANGE_TYPE == "ACNO") {
                            changeData();
                            /*$('op').val('等于多值');*/
                            $('#op').combobox({value: jdata.data.OP});
                        }
                        if (jdata.data.RANGE_TYPE == "ALL") {
                            /*  $('#op').combobox({value:''});
                              $('#op').combobox({editable: false, onlyview: true});
                              $('#rangeValue').val('ALL');
                              $("#fwz").hide();
                              $("#fwz2").hide();*/
                            changeDataOp();
                            if (jdata.data.OP == "eq") {
                                $('#rangeValue').val('ALL');
                            } else {
                                $('#rangeValue').textbox('setValue', jdata.data.RANGE_VALUE);
                                $('#rangeAll').val(jdata.data.RANGE_VALUE);

                            }
                            $("#fwz").show();
                            $("#fwz2").hide();
                        }
                        else if (jdata.data.RANGE_TYPE == "ALL" && (jdata.data.OP == "neq" || jdata.data.OP == "except")) {
                            $("#xz").show();
                            $("#fwz").show();
                            $("#fwz2").hide();
                        } else if (jdata.data.RANGE_TYPE == "JX" && (jdata.data.OP == "neq" || jdata.data.OP == "except")) {
                            $('#rangeValue').textbox('setValue', jdata.data.RANGE_VALUE);
                            $('#rangeAll').val(jdata.data.RANGE_VALUE);
                            $("#fwz").show();
                            $("#fwz2").hide();
                        }
                        else {
                            if (jdata.data.OP == "eq" || jdata.data.OP == "lt" || jdata.data.OP == "gl" || jdata.data.OP == "le" || jdata.data.OP == "ge") {
                                $('#rangeValue1').textbox('setValue', jdata.data.RANGE_VALUE)
                            }
                        }

                        if (jdata.data.OP == "between") {
                            var rangeValue = jdata.data.RANGE_VALUE;
                            $('#rangeValue1').textbox('setValue', rangeValue.substring(rangeValue.indexOf("A"), rangeValue.indexOf("至")));
                            $('#rangeValue2').textbox('setValue', rangeValue.substring(rangeValue.indexOf("至") + 1, rangeValue.length));
                            $('#rangeValue').textbox('setValue', '');
                        }
                        changeFormat();
                        changeFormat2();
                    }

                }
            });
        });
    }

    /* function InitDataGrid1() {
     var identity = 'dg1';
     $("#dg1").MyDataGrid({
     identity: identity,
     fit: true,
     queryParams: {evalNo: evalNo},
     columns: {
     param: {FunctionCode: 'EM_MPD_APPLSHOW_EDIT'},
     },
     contextMenus: []
     });
     }*/
    function InitDataGrid2() {
        //
        if (!intervalPkid) {
            intervalPkid = -1;
        }

        var identity = 'dg2';
        $("#dg2").MyDataGrid({
            identity: identity,
            fit: true,
            queryParams: {PKID: intervalPkid},
            columns: {
                param: {FunctionCode: 'EM_CMP_EVAL_APL_CON_LIST_G'},
            },
            contextMenus: [
                {
                    id: "m-edit", i18nText: "编辑", auth: "",
                    onclick: function () {
                        var rowdata = getDG(identity).datagrid('getSelected');
                        PKID = rowdata.PKID;
                        common_add_edit_({
                            identity: identity, isEdit: 1, width: 500, height: 340,
                            param: {PKID: PKID, isEdit: 1},
                            url: '/views/em/emcmp/em_cmpeval.addAppCon.shtml'
                        });
                    }

                },
                {
                    id: "m-delete", i18nText: "删除", auth: "",
                    onclick: function () {
                        var rowdata = getDG(identity).datagrid('getSelected');
                        PKID = rowdata.PKID;


                        var rowdata = getDG(identity).datagrid('getSelected');
                        PKID = rowdata.PKID;
                        var APL_PKID = rowdata.APL_PKID;
                        var LOGIC_OPERATOR = rowdata.LOGIC_OPERATOR;
                        common_delete_({
                            identity: identity,
                            cfmI18next: "msg_tip:TIP.COMMON.DEL_CONFIRM",
                            param: {PKID: "PKID", APL_PKID: "APL_PKID", LOGIC_OPERATOR: "LOGIC_OPERATOR"},
                            FunctionCode: "EM_CMP_EVAL_APL_CON_DELETE"
                        });

                    }
                },
            ]
        });
    }

    /* function InitDataGrid3() {
     var identity = 'dg2';
     $("#dg2").MyDataGrid({
     identity: identity,
     fit: true,
     queryParams: {evalNo: evalNo},
     columns: {
     param: {FunctionCode: 'EM_MPD_EVAL_APL_CON_LIST_EDIT'},
     },
     contextMenus: []
     });
     }*/

    /*function addappl() {
        ShowWindowIframe({
            width: 700,
            height: 340,
             param: {PKID:PKID},
            title: "增加适用性",
            url: " /views/em/emmpdeval/em_mpdeval.addChildrenApp.shtml"
        });
    }*/
    function InitEditForm_() {
        var $form = $("#mform");
        $form.form({
            onSubmit: function () {
                var oId;
                oId = intervalPkid;
                rangeValue = $('#rangeValue').textbox('getValue');
                var OP = $('#op').combobox('getValue');

                var $form = $("#mform");
                var datas = {};
                var data = $form.serializeObject();
                if (rangeValue == '') {
                    rangeValue1 = $('#rangeValue1').textbox('getValue');
                    rangeValue2 = $('#rangeValue2').textbox('getValue');
                    if (OP == "eq" || OP == "lt" || OP == "gl" || OP == "le" || OP == "ge") {
                        data.rangeValue = rangeValue1;
                    }
                    if (rangeValue == '' && rangeValue2 == '') {
                        data.rangeValue = rangeValue1;
                    }
                    if (rangeValue == '' && rangeValue2 != '') {
                        data.rangeValue = rangeValue1 + '至' + rangeValue2;
                    }
                    /*if (rangeValue == '' && rangeValue2 == '') {
                        data.rangeValue = rangeValue1;
                    }*/
                }
                if (isEdit_) {
                    data.MPKID = MPKID;
                    rangeValue1 = $('#rangeValue1').textbox('getValue');
                    rangeValue2 = $('#rangeValue2').textbox('getValue');
                    if (OP == "eq" || OP == "lt" || OP == "gl" || OP == "le" || OP == "ge") {
                        data.rangeValue = rangeValue1;
                    }
                    if (rangeValue == '' && rangeValue2 == '') {
                        data.rangeValue = rangeValue1;
                    }
                    if (rangeValue == '' && rangeValue2 != '') {
                        data.rangeValue = rangeValue1 + '至' + rangeValue2;
                    }
                }
                if (intervalPkid != null) {
                    data.oId = oId;
                }
                data = $.extend({}, data, {
                    // FunctionCode: ('EM_MPD_EVAL_APPLICABILITY_SAVE' )
                    FunctionCode: (isEdit_ ? 'EM_CMP_APPLICABILITY_EDIT' : 'EM_CMP_APPLICABILITY_SAVE')
                });
                InitFuncCodeRequest_({
                    data: data,
                    successCallBack: function (jdata) {
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                            MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                            $("#pkid").val(jdata.data.pkid);
                            $('#QH').removeAttr("disabled");
                            if (!isEdit_) {
                                isEdit_ = jdata.data.pkid;
                            }
                            param.OWindow.reload_();
                            param.OWindow.subMitData();
                            reload_();
                            // closeAdd();
                        } else {
                            MsgAlert({content: jdata.msg, type: 'error'});
                        }
                    }
                });
                return false;
            }
        });
    }

    function evalMemo() {
        //适用性的pkid
        var PKID = $("#pkid").val();
        ShowWindowIframe({
            width: 500,
            height: 340,
            param: {PKID: PKID},
            title: "适用性前后置条件",
            //url: " /views/em/emmpdeval/em_mpdeval.addAppCon.shtml"
            url: " /views/em/emcmp/em_cmpeval.addAppCon.shtml"
        });
    }

    //当数据域范围类型选中不同的值时对应初始化展示文本内容
    function changeFormat() {
        var rangeType = $('#rangeType').combobox('getValue');
        if (rangeType == "ALL") {
            changeDataOp();
            $("#xz").hide();
            $("#fwz2").hide();
            $("#zhi").hide();
            $("#zhi1").hide();
        }

        if (rangeType == "MSN") {
            $('#op').combobox({editable: true, onlyview: false});
            $("#fwz").hide();
            $("#zhi").hide();
            $("#zhi1").hide();
            changeData1();


        }

        if (rangeType == "JX") {
            changeDataJx();
            var op = $('#op').combobox('getValue');
            if (op == "between") {
                $('#op').combobox({value: ''});
            }
            $('#op').combobox({editable: true, onlyview: false});
            $("#fwz").hide();
            $("#fwz2").hide();
            // $("#op").val('等于多值')
        }

        if (rangeType == "ACNO" || rangeType == "ENG" || rangeType == "APU") {
            var op = $('#op').combobox('getValue');
            if (op == "between") {
                $('#op').combobox({value: ''});
            }
            $('#op').combobox({editable: true, onlyview: false});
            $("#fwz").hide();
            $("#fwz2").hide();
            changeData();
            // $("#op").val('等于多值')
        }
        if (rangeType != "MSN" && rangeType != "ACNO" && rangeType != "JX" && rangeType != "ALL") {
            $('#op').combobox({editable: true, onlyview: false});
            $("#fwz").hide();
            $("#zhi").hide();
            $("#zhi1").hide();
        }

    }

    //当数据域类型选中不同的值时对应初始化展示文本内容
    /*function changeFormat1() {
        var joinType = $('#joinType').combobox('getValue');
        if (joinType == "EXCEPT SUB") {
            $("#glzfw").show();
            $("#glzf").hide();
        } else {
            $("#glzfw").hide();
            $("#glzf").show();
        }

    }*/
    //当数据域操作符选中不同的值时对应初始化展示文本内容
    function changeFormat2() {
        var op = $('#op').combobox('getValue');
        var rangeType = $('#rangeType').combobox('getValue');
        var rangeAll = $('#rangeAll').val();

        if (rangeType == "ALL") {
            if (op == "eq") {
                //选择
                $('#rangeValue').textbox({editable: false, onlyview: true, value: 'ALL'});
                $("#fwz").show();
                $("#fwz2").hide();
                $("#xz").hide();
            } else {
                if (!isEdit_) {
                    $('#rangeValue').textbox({editable: false, onlyview: true, value: ""});
                }
                else {
                    if (rangeValue != "ALL") {
                        $('#rangeValue').textbox({editable: false, onlyview: true, value: rangeAll});
                    } else {
                        $('#rangeValue').textbox({editable: false, onlyview: true});
                    }
                }
                $("#xz").show();
                $("#fwz").show();
                $("#fwz2").hide();
            }
        } else if (rangeType == "JX") {
            if (op == "neq" || op == "except") {
                $("op").val('等于多值');
                $("#fwz").show();
                $("#fwz2").hide();
                $("#xz").show();
                if (!isEdit_ && op == "except") {
                    $('#rangeValue').textbox({editable: false, onlyview: true, value: ""});
                }
                /* if(isEdit_ && (op == "except"||op=="neq"){
                 $('#rangeData').textbox({editable: false, onlyview: true, value:rangeAll});
                 }*/
            } else {
                $("#glzfw").hide();
                $("#fwz2").show();
                $("#fwz").hide();
                $("#zhi").hide();
                $("#zhi1").hide();
            }
        }
        else {
            if (op == "between") {
                $("#glzf").hide();
                $("#fwz2").show();
                $("#fwz").hide();
                $("#zhi").show();
                $("#zhi1").show();
            }
            if (op == "neq") {
                $("op").val('等于多值');
                $("#fwz").show();
                $("#fwz2").hide();
                $("#xz").show();
            }
            if (op != "between" && op != "neq") {
                $("#glzfw").hide();
                $("#fwz2").show();
                $("#fwz").hide();
                $("#zhi").hide();
                $("#zhi1").hide();
            }
            /*if (op == '') {
             $('#op').combobox({editable: false, onlyview: true});
             $('#rangeData').val('ALL');
             $("#fwz").hide();
             $("#fwz2").hide();
             }*/
        }

    }

    //再次初始化数据域
    function changeData() {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "EM_OP1"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#op').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_OP1,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function changeDataJx() {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "EM_OP_JX"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#op').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_OP_JX,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function changeData1() {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "EM_OP"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#op').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_OP,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function changeDataOp() {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "EM_RANGE_TYPE_OP"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#op').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_RANGE_TYPE_OP,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //回填后一页面获取的数据
    function insertRangeData(rangeValue) {
        var s = rangeValue.substring(0, rangeValue.length - 1);
        $("#rangeValue").textbox({value: s})
    }

    //选择方法
    function add_() {
        var rangeValue = $('#rangeType').combobox('getValue');
        var op = $('#op').combobox('getValue');
        if (rangeValue == "JX" && op == "except") {

            ShowWindowIframe({
                width: "700px",
                height: "500px",
                param: {rangeData: rangeValue, fleet: fleet, op: op, PKID: intervalPkid, isEdit: isEdit_},
                title: "增加可选范围",
                //url: " /views/em/emmpdeval/em_mpd_item_add_scope.shtml"
                url: " /views/em/emcmp/em_cmp_item_add_scope_acno.shtml"
            });
        } else if (rangeValue == "MSN") {
            ShowWindowIframe({
                width: "700px",
                height: "500px",
                param: {rangeData: rangeValue, fleet: fleet, op: op},
                title: "增加可选范围",
                url: " /views/em/emcmp/em_cmp_item_add_scope_msn.shtml"
            });
        }
        else {
            ShowWindowIframe({
                width: "700px",
                height: "500px",
                param: {rangeData: rangeValue, fleet: fleet, op: op},
                title: "增加可选范围",
                url: " /views/em/emcmp/em_cmp_item_add_scope.shtml"
            });
        }
    }

    //自动保存当前页面
    function commitTheWin() {
        var $form = $("#mform");
        $form.submit();
    }

    //关闭按钮
    function closeAdd() {
        CloseWindowIframe();
        param.OWindow.reload_();
    }

    /** 刷新列表数据 */
    function reload_() {
        // param.OWindow.subMitData();
        InitDataGrid2();
        $("#dg2").datagrid("reload");
    }

    function subMitData() {
        var $form = $("#mform");
        $form.submit();
    }


</script>
</html>


