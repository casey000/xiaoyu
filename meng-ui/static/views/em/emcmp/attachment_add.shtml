<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <link rel="stylesheet" href="/css/table.css">
    <title>上传附件</title>
</head>
<body>
<script src="/js/plugins/ajaxfileupload/ajaxfileupload.js" type="text/javascript"></script>
<script src="/js/datagrid_utils.js" type="text/javascript"></script>
<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <table cellspacing="0" cellpadding="2" class="table table-bordered table-info">
                <form id="actionForm" method="post">
                    <tr>
                        <th class="tdl">文件目录</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="uploadDir" name="uploadDir" data-options="required:true"/>
                            <input type="hidden" id="catPkid" name="catPkid">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="6" align="center">
                            <div id="scdir"><input class="searchBtn" type="button" id="dir" value="选择目录"
                                                   style="border: none;cursor: pointer" onclick="selectDir()"/></div>
                        </td>
                    </tr>
                    <tr id="catBox">
                        <th class="tdl">文件分类：</th>
                        <td class="tdr">
                            <input class="textbox easyui-validatebox" type="text" id="fileCategory" size="30"
                                   name="fileCategory" data-options="required:true"/>
                            <input class="textbox easyui-validatebox" type="text" id="sourceId" size="30"
                                   name="sourceId" value="" placeholder="来源标识"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="tdl">上传文件：</th>
                        <td class="tdr">
                            <input class="textbox easyui-validatebox" type="file" id="fileToUpload" size="25"
                                   name="file" data-options="required:true"/>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="6" align="center">
                            <div id="sc"><input class="searchBtn" type="button" id="buttonSubmit" value="上&nbsp;&nbsp;传"
                                                style="border: none;cursor: pointer"/></div>
                        </td>
                    </tr>
                </form>
            </table>
        </div>
    </div>
</div>
</body>
<script type="text/javascript">
    var successCallBack;
    var param = {};
    var fileName;
    param = getParentParam_();
    var fleet = param.fleet;
    if (!param["sourceId"]) {
        $("#catBox").show();
    } else {
        $("#catBox").hide();
        $("#fileCategory").val(param["cat"]);
        $("#sourceId").val(param["sourceId"]);
    }

    $(function () {
        $("#buttonSubmit").click(function () {
            var sourceId = $("#sourceId").val();
            var fileCategory = $.trim($('#fileCategory').val());
            //文件目录
            var uploadDir = $("#uploadDir").textbox('getValue');
            if (fileCategory == "") {
                MsgAlert({content: "文件分类不能为空", type: 'error'});
                return;
            }
            var fileToUpload = $.trim($('#fileToUpload').val());
            if (fileToUpload == "") {
                MsgAlert({content: "请选择上传文件", type: 'error'});
                return;
            }
            if (uploadDir == null || uploadDir == "") {
                MsgAlert({content: "文件目录不能为空", type: 'error'});
                return;
            }
            $.ajaxFileUpload({
                url: Constant.API_URL + 'ATTACHMENT_UPLOAD',
                secureuri: false,
                fileElementId: 'fileToUpload', //file控件id
                dataType: 'json',
                data: {
                    "fileCategory": fileCategory,
                    "sourceId": sourceId
                },
                success: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        var oid = $('#catPkid').val();
                        var fileId = jdata.data.originalInfo.fileId;
                        InitFuncCodeRequest_({
                            data: {
                                oid: oid,
                                fileId: fileId,
                                applyNo: sourceId,
                                operFlag: 'add',
                                FunctionCode: "EM_CMPREV_APPLY_UPATE_REVFILES"
                            },
                            success: function (jdata) {

                            }
                        });
                        if (jdata.data == 'repeat') {
                            tanchuang();
                            return;

                        }
                        if (jdata.data != 'repeat') {
//                            if(typeof(param.OWindow.reload_) == 'function'){
//                                param.OWindow.reload_();
//                            }
                            if (typeof(param.successCallBack) == 'function') {
                                param.successCallBack(jdata);
                            }
                            param.OWindow.MsgAlert({content: "上传成功"});
                            if (typeof(param.OWindow.successCallBack) == 'function') {
                                param.OWindow.successCallBack();//用于上传时成功刷新页面用
                            }
                            CloseWindowIframe();
                        }

                    } else {
                        MsgAlert({content: "上传失败" + jdata.msg, type: 'error'});
                        if (typeof(param.failCallBack) == 'function') {
                            param.failCallBack(jdata);
                        }
                    }
                }

            })
        })
    });

    function tanchuang() {
        var $form = $("#mform");
        layerConfirm_({
            content: '己存在相同文件名的文件，是否覆盖并保存？',
            yesFunc: function (index) {
                var sourceId = $("#sourceId").val();
                var fileCategory = $.trim($('#fileCategory').val());
                if (fileCategory == "") {
                    MsgAlert({content: "文件分类不能为空", type: 'error'});
                    return;
                }
                var fileToUpload = $.trim($('#fileToUpload').val());
                if (fileToUpload == "") {
                    MsgAlert({content: "请选择上传文件", type: 'error'});
                    return;
                }
                $.ajaxFileUpload({
                    url: Constant.API_URL + 'ATTACHMENT_UPLOAD',
                    secureuri: false,
                    fileElementId: 'fileToUpload', //file控件id
                    dataType: 'json',
                    data: {
                        "fileCategory": fileCategory,
                        "sourceId": sourceId,
                        "repeat": "repeat"
                    },
                    success: function (jdata) {
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                            if (typeof(param.OWindow.reload_) == 'function') {
                                param.OWindow.reload_();
                            }
                            if (typeof(param.OWindow.successCallBack) == 'function') {
                                param.OWindow.successCallBack(jdata);
                            }
                            param.OWindow.MsgAlert({content: "上传成功"});
                            CloseWindowIframe();
                        } else {
                            param.OWindow.MsgAlert({content: "上传失败" + jdata.msg, type: 'error'});
                        }
                    }

                })
            },
            noFunc: function (index) {
                CloseWindowIframe();
            }


        });

    }

    function selectDir() {
        var title_ = '选择目录';
        ShowWindowIframe({
            width: "400",
            height: "500",
            title: title_,
            param: {fleet: fleet},
            url: "/views/em/emcmp/em_cmp_list_fleet.shtml"
        });
    }
</script>
</html>