<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html
        xmlns="http://www.w3.org/1999/html">
<head id="i18n_" module="emmpdeval">
    <!--#include virtual="/views/items/resource_.shtml"-->

    <title>增加间隔</title>
</head>
<body>
<div style="">
    <div class="ibox float-e-margins" id="div2">
        <form class="form-horizontal m-t" id="mform">
            <fieldset class="fieldset_eui" style="width:100%;margin-right:5px">
                <legend data-i18n="">间隔-基本信息</legend>
                <div class="ibox-content">
                    <tr>
                        <th class="td1" style="width:80px;">间隔类型：</th>
                        <td class="tdr">
                            <input class="easyui-combobox easyui-validatebox" id="itervalType" name="itervalType"
                                   data-options="required:true,onChange:ifUdf"/>
                        </td>
                    </tr>
                    <input type="hidden" id="pkid" name="pkid">
                    <input type="hidden" id="itemPkid" name="itemPkid">
                    <div class="form-horizontal m-t">
                        <fieldset class="fieldset_eui" style="float:left;width:10%;height:200px">

                            <table>
                                <legend>首检说明</legend>
                                <td class="tdr">
                                    <input class="easyui-textbox easyui-validatebox" id="thresholdDesc"
                                           name="thresholdDesc"
                                           style="width: 100px;height:150px;border: 1px solid #ddd;border-radius: 5px;"
                                           data-options="multiline:true,editable:false,onlyview:true"/>
                                </td>
                            </table>
                        </fieldset>

                        <fieldset class="fieldset_eui" style="float:left;width:200px;height:200px">
                            <table>
                                <legend>首检</legend>
                                <tr>
                                    <td class="tdr" colspan="2">
                                        <input class="easyui-numberbox easyui-validatebox" id="tFh" name="tFh"
                                               style="width:140px;height:30px;"
                                               data-options="onChange:newArrayTo1"/>AH
                                    </td>
                                </tr>
                                <tr>
                                    <td class="tdr">
                                        <input class="easyui-numberbox easyui-validatebox" id="tFc" name="tFc"
                                               style="width:140px;height:30px;"
                                               data-options="onChange:newArrayTo2"/>AC
                                    </td>
                                </tr>
                                <tr>
                                    <td class="tdr">
                                        <input class="easyui-numberbox easyui-validatebox" id="tCal" name="tCal"
                                               style="width:80px;height:30px"
                                               data-options="onChange:tCal"/>
                                        <input class="easyui-combobox easyui-validatebox" id="tCalUnit" name="tCalUnit"
                                               style="width:80px;height:30px"
                                               data-options="onChange:newArrayTo5"/>
                                    </td>
                                </tr>

                                <!--<tr>
                                    <td class="tdr">
                                        <input class="easyui-numberbox easyui-validatebox" id="tCheck" name="tCheck"
                                               style="width:80px;height:30px"
                                               data-options="onChange:tCheck"/>
                                        <input class="easyui-combobox easyui-validatebox" id="tCheckUnit"
                                               name="tCheckUnit" style="width:80px;height:30px"
                                               data-options="onChange:newArrayTo6"/>
                                    </td>
                                </tr>-->
                            </table>
                        </fieldset>

                        <fieldset class="fieldset_eui" style="float:left;width:10%;margin-right:5px;height:200px">
                            <table>
                                <legend>重检说明</legend>
                                <td class="tdr">
                                    <input class="easyui-textbox easyui-validatebox" id="intervalDesc"
                                           name="intervalDesc"
                                           style="width: 100px;height:150px;border: 1px solid #ddd;border-radius: 5px;"
                                           data-options="multiline:true,editable:false,onlyview:true"/>
                                </td>
                            </table>
                        </fieldset>

                        <fieldset class="fieldset_eui" style="float:left;width:200px;height:200px">
                            <table>
                                <legend>重检</legend>
                                <tr>
                                    <td class="tdr" colspan="2">
                                        <input class="easyui-textbox easyui-validatebox" id="ivFh" name="ivFh"
                                               style="width:140px;height:30px"
                                               data-options="onChange:newArrayTo3"/>AH
                                    </td>
                                </tr>
                                <tr>
                                    <td class="tdr">
                                        <input class="easyui-textbox easyui-validatebox" id="ivFc" name="ivFc"
                                               style="width:140px;height:30px"
                                               data-options="onChange:newArrayTo4"/>AC
                                    </td>
                                </tr>
                                <tr>
                                    <td class="tdr">
                                        <input class="easyui-textbox easyui-validatebox" id="ivCal" name="ivCal"
                                               style="width:80px;height:30px"
                                               data-options="onChange:ivCal"/>
                                        <input class="easyui-combobox easyui-validatebox" id="ivCalUnit"
                                               name="ivCalUnit"
                                               style="width:80px;height:30px"
                                               data-options="onChange:newArrayTo7"/>
                                    </td>
                                </tr>

                                <!--<tr>
                                    <td class="tdr">
                                        <input class="easyui-textbox easyui-validatebox" id="ivCheck" name="ivCheck"
                                               style="width:80px;height:30px"
                                               data-options="onChange:ivCheck"/>
                                        <input class="easyui-combobox easyui-validatebox" id="ivCheckUnit"
                                               name="ivCheckUnit" style="width:80px;height:30px"
                                               data-options="onChange:newArrayTo8"/>
                                    </td>
                                </tr>-->
                            </table>
                        </fieldset>

                        <fieldset class="fieldset_eui" style="float:left;width:150px;margin-right:5px;height:200px">
                            <table>
                                <legend>适用性描述</legend>
                                <td class="tdr">
                                    <input class="easyui-textbox easyui-validatebox" id="applDesc" name="applDesc"
                                           style="width: 140px;height:150px;border: 1px solid #ddd;border-radius: 5px;"
                                           data-options="multiline:true,editable:false,onlyview:true"/>
                                </td>
                            </table>
                        </fieldset>


                        <fieldset class="fieldset_eui" style="width:98%;height:150px;margin-right:5px">
                            <legend data-i18n="">间隔-适用性</legend>
                            <table class="table table-bordered table-info">
                                <tr>
                                    <td colspan="8" align="right">
                                        <!--<a href="javascript:void(0)" id="ZJ" style="margin:5px;"
                                           class="easyui-linkbutton"
                                           data-options=""
                                           onclick="addappl()"><span data-i18n="">增加适用性</span></a>-->
                                        <input class="btn btn-primary" data-options="iconCls:'icon-filter'"
                                               type="button" id="ZJ" onclick="addappl()"
                                               style="margin-right:5px;margin-top:5px;float: right" value="增加适用性"/>
                                        <!--  <a href="javascript:void(0)" style="margin:5px;" class="easyui-linkbutton"
                                              data-options=""
                                              onclick="viewAppl()"><span data-i18n="">预览适用性</span></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                          &nbsp;&nbsp;&nbsp;&nbsp;-->
                                    </td>
                                </tr>
                            </table>
                            <table id="dg2"></table>
                        </fieldset>

                        <table class="table table-bordered table-info">
                            <tr>
                                <td colspan="7" align="right">

                                    <input class="btn btn-primary" type="submit" value="保存" style="margin:5px;"/>
                                    <input class="btn btn-primary" value="关闭" type="button" onclick="closeAdd();"
                                           style="margin:5px;"/>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

            </fieldset>
        </form>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">


    var isEdit_;
    var itemPkid;
    var type;
    var intervalPkid;
    var Add;
    var op = {};
    var PAGE_DATA = {};
    param = getParentParam_();
    isEdit_ = param.isEdit;
    itemPkid = param.itemPkid;
    intervalPkid = param.PKID;
    type = param.type;
    var PKID = param.PKID;
    var fleet = param.fleet;
    var appltype = param.appltype;
    var doMainType;

    function i18nCallBack() {
        $("#itemPkid").val(itemPkid);
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "EM_TICHK_UNIT,EM_MP_TICHK_UNIT,EM_INTERVAL_TYPE_APU,EM_INTERVAL_TYPE_APU_1,EM_INTERVAL_TYPE_APU_2,EM_OPALL,EM_RANGE_TYPE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    PAGE_DATA ["op"] = DomainCodeToMap_(jdata.data["EM_OPALL"]);
                    PAGE_DATA ["rangeType"] = DomainCodeToMap_(jdata.data["EM_RANGE_TYPE"]);

                    //首先执行一个方法目的是判断获取对应的数据域
                    InitFuncCodeRequest_({
                        data: {itemPkid: itemPkid, FunctionCode: "EM_CMP_DOMAIN_TYPE"},
                        async: false,
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                if (jdata.data.length == 1) {//有一种间隔了
                                    if (jdata.data[0].ITERVAL_TYPE == "100") {
                                        doMainType = 1;//间隔100
                                    } else {
                                        doMainType = 2;//间隔NOTE
                                    }
                                }
                                if (jdata.data.length == 0) {//一种间隔也没有
                                    doMainType = 0;
                                }
                                if (jdata.data.length == 2) {//两种间隔都有了
                                    doMainType = 3;
                                }
                            }
                        }
                    });

                    if (doMainType == 0) {
                        $('#itervalType').combobox({
                            panelHeight: '120px',
                            data: jdata.data.EM_INTERVAL_TYPE_APU,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                        });
                    }
                    if (doMainType == 1) {
                        $('#itervalType').combobox({
                            panelHeight: '120px',
                            data: jdata.data.EM_INTERVAL_TYPE_APU_1,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                        });
                    }
                    if (doMainType == 2) {
                        $('#itervalType').combobox({
                            panelHeight: '120px',
                            data: jdata.data.EM_INTERVAL_TYPE_APU_2,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                        });
                    }
                    if (doMainType == 3) {
                        $('#itervalType').combobox({
                            panelHeight: '120px',
                            data: "",
                            valueField: 'VALUE',
                            textField: 'TEXT',
                        });
                        if (!isEdit_) {
                            alertNews();
                        }
                    }


                    /*    $('#itervalType').combobox({
                            panelHeight: '120px',
                            data: jdata.data.EM_INTERVAL_TYPE_APU,
                            valueField: 'VALUE',
                            textField: 'TEXT',
                        });*/

                    $('#tCalUnit').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_TICHK_UNIT,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    $('#tCheckUnit').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_MP_TICHK_UNIT,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    $('#ivCalUnit').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_TICHK_UNIT,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    $('#ivCheckUnit').combobox({
                        panelHeight: '120px',
                        data: jdata.data.EM_MP_TICHK_UNIT,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }

            }
        });
        InitEditForm_();
        InitDataGrid();
        filetheappldesc();

    }

    function alertNews() {
        $.messager.confirm('', '最多可以添加两种间隔，已经没有可添加间隔类型了！', function (r) {
            if (r) {
                CloseWindowIframe();
            } else {
                CloseWindowIframe();
            }
        });
    }

    function filetheappldesc() {//初始化适用性描述
        if (!PKID) {
            PKID = $("#pkid").val();
        }
        if (PKID) {
            InitFuncCodeRequest_({
                data: {PKID: PKID, FunctionCode: "EM_CMP_SET_APPLDESC"},
                successCallBack: function (jdata) {
                    console.log(jdata.data);
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        var i = 0;
                        var arr = [];//放查询结果
                        arr = jdata.data;
                        // InitDataGrid(arr[0].RANGE_DATA);
                        var strs = [];//用于存放切割字符串
                        var v = '';
                        for (; i < jdata.data.length; i++) {
                            // if (i == 0) {//i==0时第一条数据的加入，机型只需要加入一次，在此处理防止重复加入
                            if (i == 0) {
                                v = arr[i].RANGE_VALUE + "\r\n";
                            } else {
                                v += arr[i].RANGE_VALUE + "\r\n";
                            }

                            if (arr[i].MOD == undefined) {
                                if (arr[i].SB == undefined) {
                                    $('#applDesc').textbox({value: v});
                                } else {
                                    v += arr[i].PRE_POST + "\r\n";
                                }

                            } else {
                                v += arr[i].PRE_POST + ' ' + arr[i].MOD + "\r\n";
                            }
                            if (arr[i].SB == undefined) {//没有sb的时候
                                $('#applDesc').textbox({value: v});
                            }
                            if (arr[i].SB != undefined) {//有sb的时候
                                if (arr[i].SB.indexOf(",") != -1) {//判断是否有逗号，存在多个SB的情况
                                    var strs = arr[i].SB.split(","); //字符分割
                                    for (var j = 0; j < strs.length; j++) {
                                        if (j < strs.length - 1) {
                                            v += "(" + strs[j] + ")" + "," + "\r\n";
                                        } else {
                                            v += "(" + strs[i] + ")" + "\r\n";//最后一个Sb不要逗号分隔
                                        }

                                    }
                                    $('#applDesc').textbox({value: v});
                                }
                                if (arr[i].SB.indexOf(",") == -1) {//只有一个Sb的时候
                                    v += "(" + arr[i].SB + ")" + "\r\n";
                                    $('#applDesc').textbox({value: v});
                                }
                            }

                        }

                        ParseFormField_(jdata.data, null, Constant.CAMEL_CASE);

                    }
                }
            });
        }
    }


    if (isEdit_) {
        $(function () {
            InitFuncCodeRequest_({
                data: {PKID: PKID, FunctionCode: "EM_CMP_GET_INTERVAL"},
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        ParseFormField_(jdata.data, null, Constant.CAMEL_CASE);
                        $('#pkid').val(PKID);
                        $('#itervalType').combobox({value: jdata.data.ITERVAL_TYPE});
                        $('#tCalUnit').combobox({value: jdata.data.T_CAL_UNIT});
                        $('#tCheckUnit').combobox({value: jdata.data.T_CHECK_UNIT});
                        $('#ivCalUnit').combobox({value: jdata.data.IV_CAL_UNIT});
                        $('#ivCheckUnit').combobox({value: jdata.data.IV_CHECK_UNIT});
                        $('#itervalType').combobox({editable: false, onlyview: true});
                        InitDataGrid();
                    }
                }
            });
        });
    }
    /*//勾选上抽样和优化时选中的数据域
     function InitDomaincode() {
     InitFuncCodeRequest_({
     data: {FunctionCode: "ANALYSIS_DOMAIN_BYCODE", domainCode: "EM_INTERVAL_TYPE1"},
     successCallBack: function (jdata) {

     if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
     $('#itervalType').combobox({
     panelHeight: '120px',
     data: jdata.data.EM_INTERVAL_TYPE1,
     valueField: 'VALUE',
     textField: 'TEXT',
     });

     } else {
     MsgAlert({content: jdata.msg, type: 'error'});
     }

     }
     });

     }*/
    //用于验证单位必填
    /*    function ivCal(a, b) {
            if (a) {
                $('#ivCalUnit').combobox({required: true});
            } else {
                $('#ivCalUnit').combobox({required: false});
            }

        }
        function tCal(a, b) {
            if (a) {
                $('#tCalUnit').combobox({required: true});
            } else {
                $('#tCalUnit').combobox({required: false});
            }

        }*/
    function tCheck(a, b) {
        if (a) {
            $('#tCheckUnit').combobox({required: true});
        } else {
            $('#tCheckUnit').combobox({required: false});
        }

    }

    function ivCheck(a, b) {
        if (a) {
            $('#ivCheckUnit').combobox({required: true});
        } else {
            $('#ivCheckUnit').combobox({required: false});
        }

    }


    //用于回填首重检描述的值
    var a = [];
    var b = [];

    function newArrayTo1(value, ov) {
        index = 0;
        if (value == '') {
            var v = '';
            $('#thresholdDesc').textbox({value: v});
        }
        a[index] = value ? value + ('AH') : '';
        var v = '';
        $.each(a, function (k, item) {
            v += item ? item + "\r\n" : '';
        });
        $('#thresholdDesc').textbox({value: v});

    }

    function newArrayTo2(value, ov) {
        index = 1;
        if (value != null) {
            a[index] = value ? value + ('AC') : '';
            var v = '';
            $.each(a, function (k, item) {
                v += item ? item + "\r\n" : '';
            });
            $('#thresholdDesc').textbox({value: v});
        }
    }

    function newArrayTo3(value, ov) {
        index = 0;
        b[index] = value ? value + ('AH') : '';
        var v = '';
        $.each(b, function (k, item) {
            v += item ? item + "\r\n" : '';
        });
        $('#intervalDesc').textbox({value: v});
    }

    function newArrayTo4(value, ov) {
        index = 1;
        b[index] = value ? value + ('AC') : '';
        var v = '';
        $.each(b, function (k, item) {
            v += item ? item + "\r\n" : '';
        });
        $('#intervalDesc').textbox({value: v});
    }

    function newArrayTo5(value, ov) {
        var tCal = $('#tCal').textbox('getValue');
        var tCalUnit = $('#tCalUnit').combobox('getValue');
        if (tCalUnit) {
            $('#tCal').textbox({required: true});
        } else {
            $('#tCal').textbox({required: false});
        }

        index = 2;
        a[index] = value ? tCal + value : '';
        var v = '';
        $.each(a, function (k, item) {
            v += item ? item + "\r\n" : '';
        });
        $('#thresholdDesc').textbox({value: v});
    }

    function newArrayTo6(value, ov) {
        var tCheck = $('#tCheck').textbox('getValue');
        var tCheckUnit = $('#tCheckUnit').combobox('getValue');
        if (tCheckUnit) {
            $('#tCheck').textbox({required: true});
        } else {
            $('#tCheck').textbox({required: false});
        }
        index = 3;
        a[index] = value ? tCheck + value : '';
        var v = '';
        $.each(a, function (k, item) {
            v += item ? item + "\r\n" : '';
        });
        $('#thresholdDesc').textbox({value: v});
    }

    function newArrayTo7(value, ov) {
        var ivCal = $('#ivCal').textbox('getValue');
        var ivCalUnit = $('#ivCalUnit').combobox('getValue');
        if (ivCalUnit) {
            $('#ivCal').textbox({required: true});
        } else {
            $('#ivCal').textbox({required: false});
        }
        index = 2;
        b[index] = value ? ivCal + value : '';
        var v = '';
        $.each(b, function (k, item) {
            v += item ? item + "\r\n" : '';
        });
        $('#intervalDesc').textbox({value: v});
    }

    function newArrayTo8(value, ov) {
        var ivCheck = $('#ivCheck').textbox('getValue');
        var ivCheckUnit = $('#ivCheckUnit').combobox('getValue');
        if (ivCheckUnit) {
            $('#ivCheck').textbox({required: true});
        } else {
            $('#ivCheck').textbox({required: false});
        }
        index = 3;
        b[index] = value ? ivCheck + value : '';
        var v = '';
        $.each(b, function (k, item) {
            v += item ? item + "\r\n" : '';
        });
        $('#intervalDesc').textbox({value: v});
    }

    function tCal(value, b) {
        if (value) {
            $('#tCalUnit').combobox({required: true});
        } else {
            $('#tCalUnit').combobox({required: false});
        }

        var tCal = $('#tCal').textbox('getValue');
        var tCalUnit = $('#tCalUnit').combobox('getValue');
        index = 2;
        a[index] = tCal ? tCal + tCalUnit : '';
        var v = '';
        $.each(a, function (k, item) {
            v += item ? item + "\r\n" : '';
        });
        $('#thresholdDesc').textbox({value: v});
    }

    //用于验证单位必填
    function ivCal(value, bc) {
        if (value) {
            $('#ivCalUnit').combobox({required: true});
        } else {
            $('#ivCalUnit').combobox({required: false});
        }
        var ivCal = $('#ivCal').textbox('getValue');
        var ivCalUnit = $('#ivCalUnit').combobox('getValue');
        index = 2;
        b[index] = ivCal ? ivCal + ivCalUnit : '';
        var v = '';
        $.each(b, function (k, item) {
            v += item ? item + "\r\n" : '';
        });
        $('#intervalDesc').textbox({value: v});

    }

    //间隔类型为自定时
    function ifUdf(a) {
        if (a == "NOTE") {
            $('#thresholdDesc').textbox({editable: true, onlyview: false});
            $('#intervalDesc').textbox({editable: true, onlyview: false});
            $('#tFh').textbox({editable: false, onlyview: true, value: ''});
            $('#tCal').textbox({editable: false, onlyview: true, value: ''});
            $('#tFc').textbox({editable: false, onlyview: true, value: ''});
            $('#tCalUnit').combobox({editable: false, onlyview: true, value: ''});
            $('#tCheck').textbox({editable: false, onlyview: true, value: ''});
            $('#tCheckUnit').combobox({editable: false, onlyview: true, value: ''});
            $('#ivFh').textbox({editable: false, onlyview: true, value: ''});
            $('#ivFc').textbox({editable: false, onlyview: true, value: ''});
            $('#ivCal').textbox({editable: false, onlyview: true, value: ''});
            $('#ivCalUnit').combobox({editable: false, onlyview: true, value: ''});
            $('#infc').textbox({editable: false, onlyview: true, value: ''});
            $('#ivCheck').textbox({editable: false, onlyview: true, value: ''});
            $('#ivCheckUnit').combobox({editable: false, onlyview: true, value: ''});

        } else {
            $('#tFh').textbox({editable: true, onlyview: false});
            $('#tCal').textbox({editable: true, onlyview: false});
            $('#tFc').textbox({editable: true, onlyview: false});
            $('#tCalUnit').combobox({editable: true, onlyview: false});
            $('#tCheck').textbox({editable: true, onlyview: false});
            $('#tCheckUnit').combobox({editable: true, onlyview: false});
            $('#ivFh').textbox({editable: true, onlyview: false});
            $('#ivFc').textbox({editable: true, onlyview: false});
            $('#ivCal').textbox({editable: true, onlyview: false});
            $('#ivCalUnit').combobox({editable: true, onlyview: false});
            $('#infc').textbox({editable: true, onlyview: false});
            $('#ivCheck').textbox({editable: true, onlyview: false});
            $('#ivCheckUnit').combobox({editable: true, onlyview: false});
            $('#thresholdDesc').textbox({editable: false, onlyview: true});
            $('#intervalDesc').textbox({editable: false, onlyview: true})
        }
    }

    function InitDataGrid() {
        if (!intervalPkid) {
            intervalPkid = -1;
        }
        if (intervalPkid != "") {
            var identity = 'dg2';
            $("#dg2").MyDataGrid({
                identity: identity,
                fit: true,
                queryParams: {intervalPkid: intervalPkid},
                columns: {
                    param: {FunctionCode: 'EM_CMP_APPLSHOW'},
                    alter: {
                        OP: {
                            formatter: function (value, row, index) {
                                return PAGE_DATA['op'][value];
                            }
                        },
                        RANGE_TYPE: {
                            formatter: function (value, row, index) {
                                return PAGE_DATA['rangeType'][value];
                            }
                        }
                    },
                },
                contextMenus: [
                    {
                        id: "m-delete", i18nText: "删除", auth: "",
                        onclick: function () {
                            common_delete_({
                                identity: identity,
                                cfmI18next: "msg_tip:TIP.COMMON.DEL_CONFIRM",
                                param: {PKID: "PKID",},
                                FunctionCode: "EM_DELETE_CMP_APPL",
                                successCallBack: function (jdata) {
                                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                        subMitData();
                                        reload_();
                                    }
                                }
                            });
                        }
                    },
                    {
                        id: "m-edit", i18nText: "编辑", auth: "",
                        onclick: function () {
                            PKID = $("#pkid").val();
                            var rowdata = getDG(identity).datagrid('getSelected');
                            MPKID = rowdata.PKID;
                            common_add_edit_({
                                identity: identity, isEdit: 1, width: 830, height: 340,
                                param: {MPKID: MPKID, intervalPkid: PKID, isEdit: 1, fleet: fleet},
                                url: '/views/em/emcmp/em_cmpeval.addApp.shtml'
                            });
                        }

                    },
                ]
            });
        }
    }

    function InitEditForm_() {
        var $form = $("#mform");
        $form.form({
            onSubmit: function () {
                var $form = $("#mform");
                //var datas = $form.serializeObject();
                var data = $form.serializeObject();
                if (!isEdit_) {
                    data.itemPkid = itemPkid;
                }
                data = $.extend({}, data, {
                    FunctionCode: (isEdit_ ? 'EM_CMP_EVAL_INTERVAL_EDIT' : 'EM_CMP_INTERVAL_ADD')
                });
                InitFuncCodeRequest_({
                    data: data,
                    successCallBack: function (jdata) {
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                            if (!isEdit_) {
                                alertMassage();//弹出信息提示首次加间隔需要录入适用性
                            }

                            $("#pkid").val(jdata.data.pkid);
                            intervalPkid = jdata.data.pkid;
                            isEdit_ = jdata.data.pkid;
                            // reload_();
                            param.OWindow.reload_();
                            // MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        } else {
                            MsgAlert({content: jdata.msg, type: 'error'});
                        }
                    }
                });
                return false;
            }
        });
    }

    //关闭窗口
    function closeAdd() {
        $.messager.confirm('', '是否关闭', function (r) {
            if (r) {
                CloseWindowIframe();
                param.OWindow.reload_();
                $("#dg").form('clear');
            }
        });
    }

    function alertMassage() {
        $.messager.confirm('', '数据保存成功，若为新增数据，请至少增加一条适用性！', function (r) {
            if (r) {
                param.OWindow.reload_();
                $("#dg").form('clear');
            }
        });
    }

    /** 刷新列表数据 */

    /*doSearch_查询*/
    function reload_() {
        var data = {intervalPkid: intervalPkid};
        var dgopt = getDgOpts('dg2');
        var url = dgopt.url;
        var $dg = $(dgopt.owner);
        $dg.datagrid({
            url: url,
            queryParams: data
        });
        filetheappldesc();
        param.OWindow.reload_();
    }

    function addappl() {
        intervalPkid = $("#pkid").val();
        if (intervalPkid == "") {
            MsgAlert({content: "请先保存间隔", type: 'error'});
            return false;
        }
        ShowWindowIframe({
            width: 830,
            height: 370,
            param: {intervalPkid: intervalPkid, fleet: fleet},
            title: "增加适用性",
            url: "/views/em/emcmp/em_cmpeval.addApp.shtml"
        });
    }

    //预览适用性
    function viewAppl() {
        ShowWindowIframe({
            width: 830,
            height: 370,
            param: {itemPkid: itemPkid, appltype: appltype, fleet: fleet},
            title: "预览适用性",
            url: "/views/em/emcmp/em_cmpeval.previewApp.shtml"
        });
    }

    //后一页面保存时自动保存当前页内容
    function subMitData() {
        var $form = $("#mform");
        $form.submit();
    }


</script>
</html>


