<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<style>
    .ctbox {
        margin: 0 auto;
        width: 990px;
    }
</style>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>EO/EA新飞机引进评估</title>
</head>

<body class="ibody">
<div id="tt" class="ibox  float-e-margins" style="width:100%; height: 380px">
    <div class="ibox-content">
        <form class="form-horizontal m-t" id="mform">
            <input type="hidden" id="pkid" name="pkid"/>

            <table class="table table-bordered table-info">
                <tr>
                    <td colspan="6" align="right">
                        <input id="saveBtn" class="btn btn-primary" type="button" value="保存" onclick="save()"/>&nbsp;&nbsp;
                        <input id="combtn" class="btn btn-primary" type="button" value="提交" onclick="submitA()"/>&nbsp;&nbsp;
                        <input id="closeBtn" class="btn btn-primary" style="margin-right: 32px"  type="button" onclick="closeW()" value="关闭"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 80px;">评估单号：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" style="width: 150px;"
                               id="evaNo" name="evaNo" data-options="editable:false,onlyview:true"/>
                    </td>
                    <th class="th" align="right" style="width: 80px;">机队：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" style="width: 150px;"
                               id="fleet" name="fleet" data-options="editable:false,onlyview:true"/>
                    </td>
                    <th class="th" align="right" style="width: 80px;">章节：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" style="width: 150px;"
                               id="ata" name="ata" data-options="editable:false,onlyview:true"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 80px;">任务类型：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" style="width: 150px;"
                               id="taskType" name="taskType" data-options="editable:false,onlyview:true"/>
                    </td>
                    <th class="th" align="right" style="width: 80px;">MSN：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" style="width: 150px;"
                               id="msn" name="msn" data-options="editable:false,onlyview:true"/>
                    </td>
                    <th class="th" align="right" style="width: 80px;">状态：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-combobox" style="width: 150px;"
                               id="status" name="status" data-options="editable:false,onlyview:true"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 80px;">备注：</th>
                    <td colspan="5" style="padding: 3px;">
                        <input class="easyui-textbox" style="width: 870px;height:80px"
                               id="memo" name="memo"
                               data-options="multiline:true"/>
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div id='dealbtn'>
        <table style="width: 30%;float: left">
            <tr>
                <td align="right">
                    <input class="btn btn-primary" type="button" value="改版-添加适用性" onclick="appDeal('yes')"/>&nbsp;&nbsp;
                    <input class="btn btn-primary" type="button" onclick="appDeal('no')" value="无需处理"/>
                </td>
            </tr>
        </table>
        <table style="width: 67%;">
            <tr>
                <td align="right">
                    <input class="btn btn-primary" type="button" onclick="remove()" value="移除"/>
                </td>
            </tr>
        </table>
    </div>

    <div id="mlayout" class="easyui-layout" style="height: 440px;">
        <div id="lay_left" data-options="region:'west',split:false" style="width: 30%;">
            <fieldset class="fieldset_eui">
                <legend>未处理</legend>
                <table>
                    <tr>
                        <td style="width: 40px;">编号：</td>
                        <td align="left">
                            <input class="easyui-textbox" name="eoNo1" id="eoNo1" data-options=""
                                   style="width:80px;"/>
                        </td>
                        <!--<td style="width: 50px;">适用性：</td>
                        <td align="left">
                            <input class="easyui-textbox" name="app1" id="app1" data-options=""
                                   style="width:80px;"/>
                        </td>-->
                        <td id="querbtn">
                            <a href="javascript:" id="querySn" onclick="query1()" class="easyui-linkbutton"
                               iconCls="icon-search"></a>
                        </td>
                    </tr>
                </table>
                <table id="dg1"></table>
            </fieldset>
        </div>
        <div id="lay_right" data-options="region:'east'" style="width: 67%">
            <fieldset class="fieldset_eui">
                <legend>已处理</legend>
                <table>
                    <tr>
                        <td style="width: 40px;">编号：</td>
                        <td align="left">
                            <input class="easyui-textbox" name="eoNo2" id="eoNo2" data-options=""
                                   style="width:80px;"/>
                        </td>
                        <td style="width: 60px;">处理方式：</td>
                        <td align="left">
                            <input class="easyui-combobox" name="proMode" id="proMode" data-options=""
                                   style="width:120px;"/>
                        </td>
                        <!--<td style="width: 50px;">适用性：</td>
                        <td align="left">
                            <input class="easyui-textbox" name="app2" id="app2" data-options=""
                                   style="width:80px;"/>
                        </td>-->
                        <td id="querbtn1">
                            <a href="javascript:" id="queryS1" onclick="query2()" class="easyui-linkbutton"
                               iconCls="icon-search"></a>
                        </td>
                    </tr>
                </table>
                <table id="dg2"></table>
            </fieldset>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var param;
    var op = null;// operation[add,edit,view,flow]
    var pkid = null;//主表PKID
    var PAGE_DATA ={};
    var app1;
    var eoNo1;
    var app2;
    var eoNo2;
    var proMode;
    var taskPropId;
    var evalApplyType;
    var ifEvaProduce;

    function i18nCallBack() {
        param = getParentParam_();
        op = param.operation;
        pkid = param.recordId;
        taskPropId = param.taskPropId;
        if (op == 'flow') {
            $("#combtn").hide();
            $('#saveBtn').hide();
            $('#closeBtn').hide();
        } else if (op == "view") {
            $("#saveBtn").hide();
            $("#combtn").hide();
            $("#dealbtn").hide();
        }
        //taskEmAcEeeoeatb2 任务退回
        if (taskPropId && taskPropId != 'taskEmAcEeeoeatb2') {
            $("#btn").hide();
            $("#dealbtn").hide();
        }

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "YESORNO,EM_AC_TASK_TYPE,EM_AC_PRO_MODE,EM_AC_EVAL_STATUS,EM_APPL_TYPE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    PAGE_DATA['YESORNO'] = DomainCodeToMap_(jdata.data["YESORNO"]);
                    PAGE_DATA['EM_AC_TASK_TYPE'] = DomainCodeToMap_(jdata.data["EM_AC_TASK_TYPE"]);
                    PAGE_DATA['EM_AC_PRO_MODE'] = DomainCodeToMap_(jdata.data["EM_AC_PRO_MODE"]);
                    PAGE_DATA['EM_APPL_TYPE'] = DomainCodeToMap_(jdata.data["EM_APPL_TYPE"]);
                    $('#status').combobox({
                        data: jdata.data.EM_AC_EVAL_STATUS,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: 'auto'
                    });
                    $('#proMode').combobox({
                        data: jdata.data.EM_AC_PRO_MODE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: 'auto'
                    });

                    InitDataForm(pkid);
                    InitDataGrid1(pkid);
                    InitDataGrid2(pkid);
                }
            }
        });

    }

    //回填
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_EO_AC_EEEOEATB_EVA_PKID",
                pkid: pkid
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function InitDataGrid1(pkid) {
        var identity = 'dg1';
        var pageSize = Math.floor(($(document.body).height() - $("fieldset").height() - 130) / 25);
        $("#dg1").MyDataGrid({
                identity: identity,
                sortable: true,
                firstLoad: true,
                singleSelect: true,
                pageSize: pageSize,
                queryParams: {evaPkid: pkid, eoNo:eoNo1, app: app1},
                columns: {
                    param: {FunctionCode: 'EM_EO_NEW_AC_UNTREATED_LIST'},
                    alter: {
                        EO_NO: {
                            formatter: function (value, row, index) {
                                var operation = 'view';
                                return '<a href="javascript:void(0);" onclick="openDetai(\''+operation+'\',\'' + row.EO_PKID +'\',\'' + row.EO_VER+ '\',\'' + row.JOB_CATEGORY+ '\',\'' + row.APPLY_TYPE+'\',\''+row.EO_EA+'\')">' + value + '</a>';
                            },
                        },
                        IF_APPLY_SYS: {
                            formatter: function (value, row, index) {
                                return PAGE_DATA['YESORNO'] [value];
                            }
                        },
                        APPLY_TYPE:{
                            formatter: function (value, row, index) {
                                return PAGE_DATA['EM_APPL_TYPE'] [value];
                            }
                        }
                    }

                },
                resize: function () {
                    return {width: 270, height: 370};
                },
                onLoadSuccess: function (data) {
                },
                rowStyler: function (index, row) {

                },
                contextMenus: [],
                onClickRow: function (rowIndex, rowData) {
                },
                onDblClickRow: function (index, field, value) {
                }
            }
        );
    }

    function InitDataGrid2(pkid) {
        var identity = 'dg2';
        var pageSize = Math.floor(($(document.body).height() - $("fieldset").height() - 130) / 25);
        $("#dg2").MyDataGrid({
                identity: identity,
                sortable: true,
                firstLoad: true,
                singleSelect: true,
                pageSize: pageSize,
                queryParams: {evaPkid: pkid, eoNo: eoNo2, proMode: proMode, app: app2},
                columns: {
                    param: {FunctionCode: 'EM_EO_NEW_AC_TREATED_LIST'},
                    alter: {
                        EO_NO: {
                            formatter: function (value, row, index) {
                                var operation = 'view';
                                return '<a href="javascript:void(0);" onclick="openDetai(\''+operation+'\',\'' + row.EO_PKID +'\',\'' + row.EO_VER+ '\',\'' + row.JOB_CATEGORY+ '\',\'' + row.APPLY_TYPE+'\',\''+row.EO_EA+'\')">' + value + '</a>';
                            },
                        },
                        IF_APPLY_ENG: {
                            formatter: function (value, row, index) {
                                return PAGE_DATA['YESORNO'] [value];
                            }
                        },
                        PRO_MODE : {
                            formatter: function (value, row, index) {
                                return PAGE_DATA['EM_AC_PRO_MODE'] [value];
                            }
                        },
                        APPLY_TYPE:{
                            formatter: function (value, row, index) {
                                return PAGE_DATA['EM_APPL_TYPE'] [value];
                            }
                        }

                    }

                },
                resize: function () {
                    return {width: 630, height: 370};
                },
                onLoadSuccess: function (data) {
                },
                rowStyler: function (index, row) {

                },
                contextMenus: [
                    {
                        i18nText: "维护备注", auth: "",
                        onclick: function () {
                            var row = $('#dg2').datagrid('getSelected');
                            if (!row.PKID) {
                                MsgAlert({content: '请选择记录！', type: 'error'});
                                return;
                            }
                            addMemo(row.PKID);
                        }
                    },
                ],
                onClickRow: function (rowIndex, rowData) {
                },
                validAuth: function (row, items) {
                    if(row.PRO_MODE != 'WXCL'){
                        items['维护备注'].display = false;
                    }
                    return items;
                },
                onDblClickRow: function (index, field, value) {
                }
            }
        );
    }

    //适用与不适用
    function appDeal(type) {
        var rowData =  $('#dg1').datagrid('getChecked');
        if(!rowData || rowData.length == 0){
            MsgAlert({content: '请至少选择一条数据', type: 'error'});
            return;
        }
        ajaxLoading();
        var pkids = [];
        for(var i=0; i<rowData.length;i++){
            pkids.push(rowData[i].PKID);
        }
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_EO_NEW_AC_APP_DEAL",
                pkids: pkids.toString(),
                type : type
            },
            successCallBack: function (jdata) {
                ajaxLoadEnd();
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    reload_("#dg1");
                    reload_("#dg2");
                    MsgAlert({content: '操作成功'});
                } else {
                    MsgAlert({content: '操作失败', type: 'error'});
                }
            }
        });
    }

    //移除
    function remove() {
        var rowData =  $('#dg2').datagrid('getChecked');
        if(!rowData || rowData.length == 0){
            MsgAlert({content: '请至少选择一条数据', type: 'error'});
            return;
        }
        ajaxLoading();
        var pkids = [];
        for(var i=0; i<rowData.length;i++){
            pkids.push(rowData[i].PKID);
        }
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_EO_NEW_AC_APP_REMOVE",
                pkids: pkids.toString()
            },
            successCallBack: function (jdata) {
                ajaxLoadEnd();
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    reload_("#dg1");
                    reload_("#dg2");
                    MsgAlert({content: '操作成功'});
                } else {
                    MsgAlert({content: '操作失败', type: 'error'});
                }
            }
        });
    }

    //刷新主页面
    function reload_(dg) {
        $(dg).datagrid("reload");
    }

    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas.pkid = pkid;
        datas = $.extend({}, datas, {FunctionCode: 'EM_AC_EEEOEATB_EVA_SAVE'});
        InitFuncCodeRequest_({
            data: datas,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_err:ERRMSG.COMMON.SUCCESS_CODE')});
                } else {
                    MsgAlert({content: '保存失败',type: 'error'});
                }
            }
        });
    }

    function submitA() {
        var rowData = $('#dg1').datagrid('getRows');
        if(rowData.length != 0){
            MsgAlert({content: '请完成未处理的记录', type: 'error'});
            return;
        }

        var reqCou = 0;
        InitFuncCodeRequest_({
            data: {evaId: pkid, FunctionCode: 'EM_NEW_AC_WXCL'},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        reqCou = jdata.data.COU;
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
        if (reqCou > 0) {
            MsgAlert({content: "【无需处理】，请右键在备注中填写原因！", type: 'error'});
            return;
        }
        common_add_edit_({
            identity: '', isEdit: '', width: 520, height: 300, title: $.i18n.t('选择审批人'),
            param: {
                roleId: '',
                otherParam: pkid,
                FunctionCode_: 'EM_AC_NEW_SUBMIT',
                msgpkid: param.msgpkid,
                flag:"newac",
                successCallback: closeW
            },
            url: "/views/flow/work_flow_account_select.shtml"
        });

    }

    function query1() {
        eoNo1 = $('#eoNo1').textbox('getValue');
        // app1 = $('#app1').textbox('getValue');
        InitDataGrid1(pkid);
    }

    function query2() {
        eoNo2 = $('#eoNo2').textbox('getValue');
        // app2 = $('#app2').textbox('getValue');
        proMode = $('#proMode').combobox('getValue');
        InitDataGrid2(pkid);
    }

    function closeW() {
        CloseWindowIframe();
    }

    //打开资料类型详细页面
    function openDetai(operation, pkid, eoVer, jobCategory, applyType, eoEa) {
        var url = "/views/em/emeo/eoEdit.shtml";
        if(eoEa == 'EA'){
            url = "/views/em/emea/eaEdit.shtml";
        }
        isEvalProduce(pkid, applyType, eoEa);
        var title_ = $.i18n.t(eoEa+'详细页');
        ShowWindowIframe({
            width: "1248",
            height: "720",
            title: title_,
            param: {operation: operation, pkid: pkid, ifEvaProduce: ifEvaProduce, evalApplyType: evalApplyType, eoVer: eoVer, jobCategory:jobCategory,applyType:applyType, isFlow: true, accountId:1},
            url: url
        });
    }

    function isEvalProduce(pkid, applyType, eoEa) {
        InitFuncCodeRequest_({
            async: false,
            data: {eoPkid: pkid, eoEa: eoEa, applyType: applyType ,FunctionCode: 'EM_EO_EVALFILE_TYPE'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    evalApplyType = jdata.data.EVAL_COUNT;
                    if(evalApplyType == 0){
                        ifEvaProduce = 'N';
                    }else{
                        ifEvaProduce = 'Y';
                    }
                }
            }
        });
    }

    function addMemo(pkid){
        var title_ = $.i18n.t('维护备注');
        ShowWindowIframe({
            width: "800",
            height: "500",
            param: {
                pkid:pkid
            },
            url: "/views/em/emfileeval/emfileeva_new_ac_add_memo.shtml"
        });
    }

</script>

</html>
