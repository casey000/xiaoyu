<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>系统构型查看</title>
</head>

<body class="ibody">
<div id="tt" class="ibox  float-e-margins" style="width:100%; height: 100%">
    <div class="ibox-content">
        <fieldset class="fieldset_eui">
            <legend>构型基本信息</legend>
            <form class="form-horizontal m-t" id="mform">
                <input type="hidden" id="pkid" name="pkid"/>
                <table class="table table-bordered table-info">
                    <tr id="id_btn_row">
                        <td colspan="9" align="right">
                            <input class="btn btn-primary" type="button" onclick="closeW();" value="关闭"
                                   style="margin-left:3px;margin-right: 18px;"/>
                            <br/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">构型编号：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input class="easyui-textbox" id="configNo" name="configNo" readonly style="width: 150px;"/>
                        </td>
                        <th class="th" align="right" style="width: 60px;">章节：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input class="easyui-textbox" id="ata" name="ata" data-options="required:true" readonly style="width: 80px;"/>
                        </td>
                        <th class="th" align="right" style="width: 70px;">适用类型：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input class="easyui-combobox" id="appType" name="appType" data-options="required:true" readonly style="width: 80px;"/>
                        </td>
                        <th id="id_fleet" class="th" align="right" style="width: 60px;">机队：</th>
                        <td style="width: 80px; padding: 3px">
                            <input class="easyui-textbox" id="fleet" name="fleet" data-options="required:true" readonly style="width: 80px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th id="id_submodel" class="th" align="right" style="width: 60px;">子型号：</th>
                        <td style="width: 80px; padding: 3px">
                            <input class="easyui-combobox" id="subModel" name="subModel" data-options="required:false,editable:false,onlyview:true" style="width: 150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">构型描述：</th>
                        <td colspan="7" style="padding: 3px;">
                            <input class="easyui-textbox" id="configDesc" name="configDesc" data-options="required:true,multiline:true" readonly style="width: 610px;height:60px" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">构型描述（英）：</th>
                        <td colspan="7" style="padding: 3px;">
                            <input class="easyui-textbox" id="configDescEn" name="configDescEn" data-options="required:true,multiline:true" readonly style="width: 610px;height:60px" />
                        </td>
                    </tr>

                    <tr>
                        <th class="th" align="right" style="width: 100px;">构型说明：</th>
                        <td colspan="7" style="padding: 3px;">
                            <input class="easyui-textbox" id="configMemo" name="configMemo"
                                   data-options="multiline:true,editable:true"
                                   style="width: 610px;height:60px"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">通知单位：</th>
                        <td id="sendTo" colspan="7" style="padding: 3px"></td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">改版原因：</th>
                        <td colspan="7" style="padding: 3px;">
                            <input class="easyui-textbox" id="revReason" name="revReason" data-options="multiline:true" readonly style="width: 610px;height:60px" />
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
        <fieldset class="fieldset_eui">
            <legend>子构型清单</legend>
            <table id="dg"></table>
        </fieldset>
        <fieldset class="fieldset_eui">
            <legend>构型分组清单</legend>
            <table id="dg1"></table>
        </fieldset>
        <fieldset class="fieldset_eui">
            <legend>引用构型文件清单</legend>
            <table id="dg2"></table>
        </fieldset>
        <fieldset class="fieldset_eui">
            <legend>适用性变更历史记录</legend>
            <table id="dg3"></table>
        </fieldset>
        <fieldset class="fieldset_eui">
            <legend>版本反馈状态</legend>
            <table id="dg4"></table>
        </fieldset>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript" src="../../../js/em/sysconfig/feedbackDetail.js"></script>
<script type="text/javascript">
    var param;
    var pkid = null;//主表PKID

    function i18nCallBack() {
        param = getParentParam_();
        pkid = param.pkid;
        if (!! param.taskPropId) {
            $('#id_btn_row').hide();
        }

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode:
                    "EM_SYSCONFIG_APP_TYPE," +
                    "EM_SYSCONFIG_ORG"
            },
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    $('#appType').combobox({
                        data: jdata.data.EM_SYSCONFIG_APP_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '135px'
                    });

                    var orgList = jdata.data.EM_SYSCONFIG_ORG;
                    for (var i = 0; i < orgList.length; i++) {
                        var orgId = orgList[i].ORG_ID;
                        var orgName = orgList[i].ORG_NAME;
                        $('#sendTo').append("&nbsp;<input id='send_" + orgId + "' value='" + orgId + "' name='dept' type='checkbox' disabled /> " + orgName);
                    }

                    InitDataForm(pkid);
                }
            }
        });
    }

    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_SYSCONFIG_REG_PKID",
                pkid: pkid
            },
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    if (jdata.data.SEND_DEPT && jdata.data.SEND_DEPT.length > 0) {
                        var sends = jdata.data.SEND_DEPT.split(",");
                        for (var i = 0; i < sends.length; i++) {
                            $('#send_' + sends[i]).prop("checked", true);
                        }
                    }

                    InitDataGrid(pkid);
                    InitDataGrid1(pkid);
                    InitDataGrid2(pkid);
                    InitDataGrid3(pkid);
                    InitDataGrid4(pkid);
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function InitDataGrid(pkid) {
        $("#dg").MyDataGrid({
            identity: 'dg',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 780, height: 200};
            },
            queryParams: {configId: pkid},
            columns: {
                param: {FunctionCode: 'EM_SYSCONFIG_SUB_LIST'},
                alter: {
                    SUB_CONFIG_VALUE: {
                        formatter: function (value, row, index) {
                            if (! value) {
                                return "";
                            }

                            var subs = value.split(";");
                            return subs.join("<br />");
                        }
                    },
                    SUB_CONFIG_VALUE_EN: {
                        formatter: function (value, row, index) {
                            if (! value) {
                                return "";
                            }

                            var subs = value.split(";");
                            return subs.join("<br />");
                        }
                    }
                }
            }
        });
    }

    function InitDataGrid1(pkid) {
        $("#dg1").MyDataGrid({
            identity: 'dg1',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 780, height: 200};
            },
            queryParams: {configId: pkid},
            columns: {
                param: {FunctionCode: 'EM_SYSCONFIG_LIST_LIST'},
                alter: {
                    REF_GRAPHIC: {
                        formatter: function (value, row, index) {
                            if (! value) return "";

                            var attachments = value.split(',');
                            if (attachments.length == 0) {
                                return "";
                            }

                            var result = ['<ul>'];
                            for (var i = 0; i < attachments.length; i++) {
                                var attachment = attachments[i].split('/');
                                var fileId = attachment[0];
                                var filename = attachment[1];
                                result.push('<li><a onclick="downFile(' + fileId + ')" href="javascript:void(0);">' + filename + '</a></li>');
                            }
                            result.push('</ul>');
                            return result.join('');
                        }
                    }
                }
            },
            onLoadSuccess: function (value, rowData, rowIndex) {
                mergeCellsByField('dg1','CONFIG_GROUP_NO,CONFIG_GROUP_DESC');
            }
        });
    }

    function mergeCellsByField(tableID, colList) {
        var ColArray = colList.split(",");
        var tTable = $("#" + tableID);
        var TableRowCnts = tTable.datagrid("getRows").length;
        var tmpA;
        var tmpB;
        var PerTxt = "";
        var CurTxt = "";
        var alertStr = "";
        for (j = ColArray.length - 1; j >= 0; j--) {
            PerTxt = "";
            tmpA = 1;
            tmpB = 0;
            for (i = 0; i <= TableRowCnts; i++) {
                if (i == TableRowCnts) {
                    CurTxt = "";
                }
                else {
                    CurTxt = tTable.datagrid("getRows")[i][ColArray[j]];
                }
                if (PerTxt == CurTxt) {
                    tmpA += 1;
                }
                else {
                    tmpB += tmpA;
                    tTable.datagrid("mergeCells", {
                        index: i - tmpA,
                        field: ColArray[j],　　//合并字段
                        rowspan: tmpA,
                        colspan: null
                    });
                    tmpA = 1;
                }
                PerTxt = CurTxt;
            }
        }
    }

    function InitDataGrid2() {
        $("#dg2").MyDataGrid({
            identity: 'dg2',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 780, height: 235};
            },
            queryParams: {configNo: $('#configNo').textbox('getValue')},
            columns: {
                param: {FunctionCode: 'EM_SYSCONFIG_REF_DOC_LIST'}
            }
        });
    }

    function InitDataGrid3() {
        $("#dg3").MyDataGrid({
            identity: 'dg3',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 780, height: 235};
            },
            queryParams: {configId: pkid,rows:100},
            columns: {
                param: {FunctionCode: 'EM_SYSCONFIG_LOG_LIST'}
            },
            contextMenus: [
                {
                    id: "m-view",
                    i18nText: "查看",
                    onclick: function () {
                        var rowdata = getDG("dg3").datagrid('getSelected');
                        if (!rowdata.PKID) {
                            MsgAlert({content: '请选择记录！', type: 'error'});
                            return;
                        }
                        var params = {
                            configRegId:pkid,
                            eoId:rowdata.EO_ID,
                            aplId:rowdata.APP_ID,
                            feedbackFrom:"EO"};
                        $.ajax({
                            url: '/api/v1/emSysConfigFeedback/findSysconfigFeedback',
                            type: 'post',
                            data: JSON.stringify(params),
                            contentType: "application/json;charset=utf-8",
                            dataType: "json",
                            success: function (data) {
                                //判断操作是否成功
                                if (data.code == RESULT_CODE.SUCCESS_CODE) {
                                    var feedbackId ="";
                                    var data = data.data;
                                    if(data.pkid){
                                        feedbackId =data.pkid;
                                    }
                                    common_add_edit_({
                                        url: "feedback_detail_view.shtml?recordId=" + feedbackId,
                                        identity: "",
                                        title:"反馈状态",
                                        isEdit: 0,
                                        width: 800,
                                        height: 600
                                    });
                                } else {
                                    MsgAlert({content: data.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }]
        });
    }


    /**
     *     初始化版本反馈记录：   构型触发来源 SYS_CONFIG：系统构型创建和改版变更  EO
     */
    function InitDataGrid4(pkid) {
        var params = {configRegId:pkid,feedbackFrom:"SYS_CONFIG"};
        $.ajax({
            url: '/api/v1/emSysConfigFeedback/findSysconfigFeedback',
            type: 'post',
            data: JSON.stringify(params),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
            //判断操作是否成功
            if (data.code == RESULT_CODE.SUCCESS_CODE) {
                var feedbackId ="";
                var data = data.data;
                if(data.pkid){
                    feedbackId =data.pkid;
                }
                initConfigFeedbackDetail("dg4",feedbackId);
            } else {
                MsgAlert({content: data.msg, type: 'error'});
            }
        }
    });

    }


    function closeW() {
        CloseWindowIframe();
    }
</script>

</html>
