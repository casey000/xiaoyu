<!DOCTYPE html PUBLIC "-//W4C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>系统构型维护</title>
</head>

<body class="ibody">
<div id="tt" class="ibox float-e-margins" style="width:100%; height: 100%">
    <fieldset class="fieldset_eui">
        <legend>构型基本信息</legend>
        <form class="form-horizontal m-t" id="mform">
            <input type="hidden" id="pkid" name="pkid"/>
            <input type="hidden" id="sendDept" name="sendDept"/>
            <input type="hidden" id="configDescNo" name="configDescNo"/>
            <table class="table table-bordered table-info">
                <tr>
                    <td colspan="9" align="right">
                        <input class="btn btn-primary" type="button" id="submitBtn" onclick="commit()" value="提交"/>
                        <input class="btn btn-primary" type="button" id="saveBtn" onclick="save()" value="保存"/>
                        <input class="btn btn-primary" type="button" id="closeBtn" onclick="closeW();" value="关闭"
                               style="margin-left:3px;margin-right: 18px;"/>
                        <br/>
                    </td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 100px;">构型编号：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-textbox" id="configNo" name="configNo" readonly style="width: 150px;"/>
                    </td>
                    <th class="th" align="right" style="width: 60px;">章节：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-combobox" id="ata" name="ata" data-options="required:true" style="width: 80px;"/>
                    </td>
                    <th class="th" align="right" style="width: 70px;">适用类型：</th>
                    <td style="width: 80px;  padding: 3px">
                        <input class="easyui-combobox" id="appType" name="appType" data-options="required:true" style="width: 80px;"/>
                    </td>
                    <th id="id_fleet" class="th" align="right" style="width: 60px;">机队：</th>
                    <td style="width: 80px; padding: 3px">
                        <input class="easyui-combobox" id="fleet" name="fleet" data-options="required:true" style="width: 80px;"/>
                    </td>
                </tr>
                <tr>
                    <th id="id_submodel" class="th" align="right" style="width: 60px;">子型号：</th>
                    <td style="width: 80px; padding: 3px">
                        <input class="easyui-combobox" id="subModel" name="subModel" data-options="required:false,editable:false,onlyview:true" style="width: 150px;"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 100px;">构型描述：</th>
                    <td colspan="7" style="padding: 3px;">
                        <input class="easyui-textbox" id="configDesc" name="configDesc"
                               data-options="required:true,multiline:true,editable:false,onlyview:true"
                               style="width: 580px;height:60px"/>
                        <a id="sourceSelect" href="javascript:void(0)" class="easyui-linkbutton"
                           data-options="iconCls:'icon-add'"
                           onclick="addSource()"><span>选择</span></a>
                    </td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 100px;">构型描述（英）：</th>
                    <td colspan="7" style="padding: 3px;">
                        <input class="easyui-textbox" id="configDescEn" name="configDescEn"
                               data-options="required:true,multiline:true,editable:false,onlyview:true"
                               style="width: 580px;height:60px"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 100px;">构型说明：</th>
                    <td colspan="7" style="padding: 3px;">
                        <input class="easyui-textbox" id="configMemo" name="configMemo"
                               data-options="multiline:true,editable:true"
                               style="width: 580px;height:60px"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 100px;">通知单位：</th>
                    <td id="sendTo" colspan="7" style="padding: 3px"></td>
                </tr>
                <tr>
                    <th class="th" align="right" style="width: 100px;">改版原因：</th>
                    <td colspan="7" style="padding: 3px;">
                        <input class="easyui-textbox" id="revReason" name="revReason" data-options="multiline:true" readonly style="width: 610px;height:60px" />
                    </td>
                </tr>
            </table>
        </form>
    </fieldset>
    <fieldset class="fieldset_eui">
        <legend>子构型清单</legend>
        <table id="dg"></table>
    </fieldset>
    <fieldset class="fieldset_eui">
        <legend>构型分组清单</legend>
        <table id="dg1"></table>
    </fieldset>
    <fieldset class="fieldset_eui">
        <legend>引用构型文件清单</legend>
        <table id="dg2"></table>
    </fieldset>
    <fieldset class="fieldset_eui">
        <legend>适用性变更历史记录</legend>
        <table id="dg3"></table>
    </fieldset>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var param; // operation[add,edit,view]
    var pkid = null;//主表PKID
    var status;

    function i18nCallBack() {
        param = getParentParam_();
        status = param.status;
        if(status == "RETURNED"){
            $('#submitBtn').hide();
        }
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode:
                    "BM_ATA_CHAP_SECT," +
                    "DA_FLEET," +
                    "DA_ENG_MODEL," +
                    "EM_SYSCONFIG_APP_TYPE," +
                    "EM_SYSCONFIG_ORG,"+
                    "CONFIG_FEEDBACK_STATUS"
            },
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    $('#appType').combobox({
                        panelHeight: '135px',
                        data: jdata.data.EM_SYSCONFIG_APP_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (rec) {
                            var appType = $('#appType').combobox('getValue');
                            var value = $('#appType').combobox("getValue");
                            if(value == 'ENG'){
                                $('#subModel').combobox({required : true,editable:true,onlyview:false});
                            }else{
                                $('#subModel').combobox({required : false,editable:false,onlyview:true});
                                $('#subModel').combobox('setValue','');
                            }
                            $('#id_fleet').text(value === "APL" ? "机队：" : "型号：");
                            $('#fleet').combobox({
                                panelHeight: '135px',
                                data: value === "APL" ? jdata.data.DA_FLEET : jdata.data.DA_ENG_MODEL,
                                valueField: 'VALUE',
                                textField: 'TEXT',
                                onSelect: function (item) {
                                   getSubModel(item.VALUE);
                                }
                            });
                        }
                    });
                    $('#ata').combobox({
                        panelHeight: '135px',
                        data: jdata.data.BM_ATA_CHAP_SECT,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });

                    var orgList = jdata.data.EM_SYSCONFIG_ORG;
                    for (var i = 0; i < orgList.length; i++) {
                        var orgId = orgList[i].ORG_ID;
                        var orgName = orgList[i].ORG_NAME;
                        $('#sendTo').append("&nbsp;<input id='send_" + orgId + "' value='" + orgId + "' name='dept' type='checkbox' /> " + orgName);
                    }

                    pkid = param.pkid;
                    if (pkid) {
                        InitDataForm(pkid);
                    }
                    if (!! param.taskPropId) {
                        $('#submitBtn').hide();
                        $('#closeBtn').hide();
                    }
                }
            }
        });
    }

    function getSubModel(engModel){
        var datas = $.extend({engModel: engModel?engModel:"1"}, {FunctionCode: 'EM_SYSCONFIG_SUB_MODEL'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#subModel').combobox({
                        panelHeight: '150px',
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        multiple: true,
                        data: jdata.data
                    });
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    //回填
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_SYSCONFIG_REG_PKID",
                pkid: pkid
            },
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    $('#appType').combobox("select", jdata.data.APP_TYPE);
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    var appType = $('#appType').combobox('getValue');
                    if(appType == 'ENG'){
                        $('#subModel').combobox({required : true,editable:true,onlyview:false});
                        getSubModel(jdata.data.FLEET);
                        $('#subModel').combobox({value: jdata.data.SUB_MODEL});
                    }
                    if (jdata.data.SEND_DEPT && jdata.data.SEND_DEPT.length > 0) {
                        var sends = jdata.data.SEND_DEPT.split(",");
                        for (var i = 0; i < sends.length; i++) {
                            $('#send_' + sends[i]).prop("checked", true);
                        }
                    }
                    if (jdata.data.VER >= 1) {
                        $('#ata').combobox('readonly', true);
                        $('#appType').combobox('readonly', true);
                        $('#fleet').combobox('readonly', true);
                        //允许录入改版原因
                        $('#revReason').textbox('readonly', false);
                        $('#revReason').textbox({required : true});
                    }
                    InitDataGrid(pkid);
                    InitDataGrid1(pkid);
                    InitDataGrid2(pkid);
                    InitDataGrid3(pkid);
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function InitDataGrid(pkid) {
        $("#dg").MyDataGrid({
            identity: 'dg',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 780, height: 200};
            },
            queryParams: {configId: pkid},
            columns: {
                param: {FunctionCode: 'EM_SYSCONFIG_SUB_LIST'},
                alter: {
                    SUB_CONFIG_VALUE: {
                        formatter: function (value, row, index) {
                            if (! value) {
                                return "";
                            }

                            var subs = value.split(";");
                            return subs.join("<br />");
                        }
                    },
                    SUB_CONFIG_VALUE_EN: {
                        formatter: function (value, row, index) {
                            if (! value) {
                                return "";
                            }

                            var subs = value.split(";");
                            return subs.join("<br />");
                        }
                    }
                }
            },
            toolbar: [{
                id: 'btnAdd',
                text: $.i18n.t('common:COMMON_OPERATION.ADD'),
                iconCls: 'icon-add',
                handler: function () {
                    if (! param.pkid) {
                        MsgAlert({content: "请先保存构型基本信息！", type: "warn"});
                    } else if ($('#dg').datagrid('getRows').length >= 3) {
                        MsgAlert({content: "子构型最多添加三项！", type : "warn"});
                    } else if (param.pkid) {
                        common_add_edit_({
                            url: "/views/em/emsysconfig/em_sysconfig_sub_add.shtml?operation=add&configId=" + param.pkid,
                            isEdit: 0,
                            width: 600,
                            height: 390
                        });
                    } else {
                        MsgAlert({content: "请先保存构型基本信息！", type: "info"});
                    }
                }
            }],
            contextMenus: [
                {
                    id: "m-edit",
                    i18nText: "common:COMMON_OPERATION.EDIT",
                    auth: "",
                    onclick: function () {
                        var rowdata = getDG('dg').datagrid('getSelected');
                        if (!rowdata.PKID) {
                            MsgAlert({content: '请选择记录！', type: 'error'});
                            return;
                        }
                        common_add_edit_({
                            url: "/views/em/emsysconfig/em_sysconfig_sub_add.shtml?operation=add&pkid=" + rowdata.PKID,
                            identity: 'dg',
                            isEdit: 1,
                            width: 600,
                            height: 390
                        });
                    }
                },
                {
                    id: "m-delete",
                    i18nText: "common:COMMON_OPERATION.DEL",
                    auth: "",
                    onclick: function () {
                        var rowdata = getDG('dg').datagrid('getSelected');
                        if (!rowdata.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (!confirm("确认删除该记录？")) {
                            return;
                        }
                        InitFuncCodeRequest_({
                            data: {
                                FunctionCode: 'EM_SYSCONFIG_SUB_DEL',
                                pkid: rowdata.PKID
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    reload_();
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }
            ]
        });
    }


    /**
      * 检验分组是否添加来源,false 不存在 true 存在
     * @return
     */
    function validateAppGroup() {
        var flag = false;
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_SYSCONFIG_LIST_LIST",
                configId: $('#pkid').val(),
            },
            async: false,
            successCallBack: function (jdata) {
                var data = jdata.data;
                if (!data || data.length === 0) {
                    return;
                }
                for(var index in data){
                    if(!data[index].CONFIG_SOURCE_DESC){
                        MsgAlert({
                            content: "构型分组【"+data[index].CONFIG_GROUP_NO+"】未维护构型来源,不能提交！",
                            type: "error"
                        });
                        flag =  true;
                    }
                }
            }
        });
        return flag;
    }

    function InitDataGrid1(pkid) {
        var subModel = $('#subModel').combobox('getValues');
        $("#dg1").MyDataGrid({
            identity: 'dg1',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 780, height: 200};
            },
            queryParams: {configId: pkid},
            columns: {
                param: {FunctionCode: 'EM_SYSCONFIG_LIST_LIST'},
                alter: {
                    REF_GRAPHIC: {
                        formatter: function (value, row, index) {
                            if (! value) return "";

                            var attachments = value.split(',');
                            if (attachments.length == 0) {
                                return "";
                            }

                            var result = ['<ul>'];
                            for (var i = 0; i < attachments.length; i++) {
                                var attachment = attachments[i].split('/');
                                var fileId = attachment[0];
                                var filename = attachment[1];
                                result.push('<li><a onclick="downFile(' + fileId + ')" href="javascript:void(0);">' + filename + '</a>&nbsp;' +
                                    '<span onclick="deleteFile(' + fileId + '); initAttachment(' + pkid + '); return false;" class="icon-cross">&nbsp;&nbsp;&nbsp;&nbsp;</span></li>');
                            }
                            result.push('</ul>');
                            return result.join('');
                        }
                    }
                }
            },
            toolbar: [{
                id: 'btnAdd',
                text: $.i18n.t('common:COMMON_OPERATION.ADD'),
                iconCls: 'icon-add',
                handler: function () {
                    if (! param.pkid) {
                        MsgAlert({content: "请先保存构型基本信息！", type: "warn"});
                    } else {
                        common_add_edit_({
                            url: "/views/em/emsysconfig/em_sysconfig_list_add_add.shtml?operation=add&configId=" + param.pkid+"&subModel="+subModel,
                            isEdit: 0,
                            width: 1000,
                            height: 400
                        });
                    }
                }
            }],
            contextMenus: [
                {
                    id: "m-edit",
                    i18nText: "common:COMMON_OPERATION.EDIT",
                    auth: "",
                    onclick: function () {
                        var rowdata = getDG('dg1').datagrid('getSelected');
                        if (!rowdata.PKID) {
                            MsgAlert({content: '请选择记录！', type: 'error'});
                            return;
                        }
                        common_add_edit_({
                            url: "/views/em/emsysconfig/em_sysconfig_list_add_add.shtml?operation=add&pkid=" + rowdata.PKID + "&configId=" + param.pkid+"&subModel="+subModel,
                            identity: 'dg1',
                            isEdit: 1,
                            width: 1000,
                            height: 400
                        });
                    }
                },
                {
                    id: "m-delete",
                    i18nText: "common:COMMON_OPERATION.DEL",
                    auth: "",
                    onclick: function () {
                        var rowdata = getDG('dg1').datagrid('getSelected');
                        if (!rowdata.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (!confirm("确认删除该记录？")) {
                            return;
                        }
                        InitFuncCodeRequest_({
                            data: {
                                FunctionCode: 'EM_SYSCONFIG_LIST_DEL',
                                pkid: rowdata.PKID
                            },
                            successCallBack: function (jdata) {
                                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    reload1();
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }
            ],
            onLoadSuccess: function (value, rowData, rowIndex) {
                mergeCellsByField('dg1','CONFIG_GROUP_NO,CONFIG_GROUP_DESC');
            }
        });
    }

    function mergeCellsByField(tableID, colList) {
        var ColArray = colList.split(",");
        var tTable = $("#" + tableID);
        var TableRowCnts = tTable.datagrid("getRows").length;
        var tmpA;
        var tmpB;
        var PerTxt = "";
        var CurTxt = "";
        var alertStr = "";
        for (j = ColArray.length - 1; j >= 0; j--) {
            PerTxt = "";
            tmpA = 1;
            tmpB = 0;
            for (i = 0; i <= TableRowCnts; i++) {
                if (i == TableRowCnts) {
                    CurTxt = "";
                }
                else {
                    CurTxt = tTable.datagrid("getRows")[i][ColArray[j]];
                }
                if (PerTxt == CurTxt) {
                    tmpA += 1;
                }
                else {
                    tmpB += tmpA;
                    tTable.datagrid("mergeCells", {
                        index: i - tmpA,
                        field: ColArray[j],　　//合并字段
                        rowspan: tmpA,
                        colspan: null
                    });
                    tmpA = 1;
                }
                PerTxt = CurTxt;
            }
        }
    }

    function InitDataGrid2() {
        $("#dg2").MyDataGrid({
            identity: 'dg2',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 780, height: 200};
            },
            queryParams: {configNo: $('#configNo').textbox('getValue')},
            columns: {
                param: {FunctionCode: 'EM_SYSCONFIG_REF_DOC_LIST'}
            }
        });
    }

    function InitDataGrid3() {
        $("#dg3").MyDataGrid({
            identity: 'dg3',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 780, height: 200};
            },
            queryParams: {configId: param.pkid},
            columns: {
                param: {FunctionCode: 'EM_SYSCONFIG_LOG_LIST'}
            }
        });
    }

    /** 刷新列表数据 */
    function reload_() {
        $("#dg").datagrid("reload", {configId: param.pkid});
    }

    function reload1() {
        $("#dg1").datagrid("reload", {configId: param.pkid});
    }

    // 保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;

        var configDescEn = $('#configDescEn').textbox('getValue');
        for (var i = 0; i < configDescEn.length; i++) {
            var unicode_code = configDescEn.charCodeAt(i);
            if (unicode_code > 127) {
                MsgAlert({
                    content: "构型描述（英）必须全部录入英文及英文字符！",
                    type: "warn"
                });
                return;
            }
        }

        var sends = [];
        $("input[name='dept']").each(function () {
            if ($(this).is(':checked')) {
                sends.push($(this).val());
            }
        });
        $('#sendDept').val(sends.join(","));
        var $form = $("#mform");
        var datas = $form.serializeObject();

        if (Array.isArray(datas['subModel'])) {
            datas['subModel'] = datas['subModel'].join(',');
        }
        datas = $.extend({}, datas, {FunctionCode: 'EM_SYSCONFIG_REG_ADD'});
        InitFuncCodeRequest_({
            data: datas,
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"));
                    if (! param.pkid) {
                        param.pkid = $('#pkid').val();
                        InitDataForm(param.pkid);
                    }
                    if (!! param.taskPropId) {
                        alert("保存成功！");
                    } else {
                        param.OWindow.reload_();
                        MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }



    function commit() {
        var pkid = $('#pkid').val();
        if (! $('#pkid').val()) {
            MsgAlert({content: '请选择记录！', type: 'error'});
            return;
        }
        var subModel = $('#subModel').combobox('getValues');
        // 校验分组是否添加来源
        if(validateAppGroup()){
            return;
        }

        var reqCou = 0;
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: 'EM_SYSCONFIG_REVRESON'},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        reqCou = jdata.data.COU;
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
        if (reqCou > 0) {
            MsgAlert({content: "请先填写改版原因，保存之后再提交！", type: 'error'});
            return;
        }

        var  sysConfigAppType = $('#appType').combobox('getValue');
        if (sysConfigAppType && (sysConfigAppType === "APL" || sysConfigAppType ==="ENG" ) ) {
            var spare_num = 0;
            InitFuncCodeRequest_({
                data: {
                    FunctionCode: sysConfigAppType === "APL" ? "EM_SYSCONFIG_SUBMIT_VALIDATE" : "EM_SYSCONFIG_SUBMIT_ENG_VALIDATE",
                    configId: $('#pkid').val(),
                    fleet: $('#fleet').combobox('getValue'),
                    subModel:subModel
                },
                async: false,
                successCallBack: function (jdata) {
                    spare_num = jdata.data.SPARE_NUM;
                }
            });
            if (spare_num > 0) {
                MsgAlert({
                    content: "还有适用"+ (sysConfigAppType === "APL" ? "飞机" : "发动机")+"未分配适用性，不能提交！",
                    type: "error"
                });
                return;
            }
        }


        var flowKey = "emSysconfigFlow";
        $.messager.confirm("", "是否确认提交？", function (r) {
            if (r) {
                common_add_edit_({
                    url: "/views/em/workflow/work_flow_account_select.shtml",
                    param: {
                        FunctionCode_: "EM_SYSCONFIG_SUBMIT",
                        otherParam: $('#pkid').val(),
                        successCallBack: closeW,
                        flowKey: flowKey
                    },
                    title: $.i18n.t("选择审批人"),
                    width: 520,
                    height: 300
                });
            }
        });
    }

    function addSource() {
        ShowWindowIframe({
            width: 590,
            height: 670,
            param: {type: "0"},
            title: "构型描述",
            url: "/views/em/emsysconfig/em_sysconfig_desc.shtml"
        });
    }
    function closeW() {
        //刷新父页面
        param.OWindow.reload_();
        CloseWindowIframe();
    }
</script>

</html>
