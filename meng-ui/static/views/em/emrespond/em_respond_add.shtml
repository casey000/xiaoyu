<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>工程反馈信息维护</title>
</head>

<body class="ibody">
<div id="tt" class="ibox  float-e-margins" style="width:100%; height: 100%">
    <div class="ibox-content">
        <fieldset class="fieldset_eui">
            <legend>反馈基本信息</legend>
            <form class="form-horizontal m-t" id="mform">
                <input type="hidden" id="pkid" name="pkid"/>
                <table class="table table-bordered table-info">
                    <tr id="id_btn_row">
                        <td colspan="9" align="right">
                            <input class="btn btn-primary" type="button" id="saveBtn" onclick="save()" value="保存"/>
                            <input class="btn btn-primary" type="button" id="commitBtn" onclick="commit()" value="提交" />
                            <input class="btn btn-primary" type="button" id="closeBtn" onclick="closeW();" value="关闭"
                                   style="margin-left:3px;margin-right: 18px;"/>
                            <br/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">文件类型：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input id="fileType" name="fileType"
                                   class="easyui-combobox" style="width: 120px;"
                                   data-options="required:true,editable:false" />
                        </td>
                        <th class="th" align="right" style="width: 80px;">文件编号：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input id="fileNo" name="fileNo"
                                   class="easyui-combobox" style="width: 120px;"
                                   data-options="required:true" />
                        </td>
                        <th class="th" align="right" style="width: 80px;">版本：</th>
                        <td style="width: 80px; padding: 3px">
                            <input id="fileVer" name="fileVer"
                                   class="easyui-textbox" style="width: 120px;"
                                   data-options="required:true" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">章节：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input id="ata" name="ata"
                                   class="easyui-textbox" style="width: 120px;"
                                   data-options="required:true" />
                        </td>
                        <th class="th" align="right" style="width: 80px;">适用类型：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input id="appType" name="appType"
                                   class="easyui-combobox" style="width: 120px;"
                                   data-options="required:true" />
                        </td>
                        <th class="th" align="right" style="width: 80px;">型号：</th>
                        <td style="width: 80px; padding: 3px">
                            <input id="model" name="model"
                                   class="easyui-textbox" style="width: 120px;"
                                   data-options="required:true" />
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">紧急程度：</th>
                        <td colspan="5" style="width: 80px; padding: 3px">
                            <input id="urgencyDegree" name="urgencyDegree"
                                   class="easyui-combobox" style="width: 120px;"
                                   data-options="required:true"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">反馈描述：</th>
                        <td colspan="5" style="padding: 3px;">
                        <textarea id="respondDesc" name="respondDesc"
                                  class="easyui-textbox" style="width: 650px;height:60px"
                                  data-options="required:true,multiline:true"></textarea>
                        </td>
                    </tr>
                    <tr id="id_isAccept">
                        <th class="th" align="right" style="width: 100px;">是否采纳：</th>
                        <td style="padding: 3px;">
                            <input id="isAccept" name="isAccept"
                                   class="easyui-combobox" style="width: 120px;"
                                   data-options=""/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">是否实质性问题：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input id="ifSubstan" name="ifSubstan"
                                   class="easyui-combobox" style="width: 120px;"
                                   data-options="" />
                        </td>
                        <th class="th" align="right" style="width: 80px;">预计解决日期：</th>
                        <td style="width: 80px; padding: 3px">
                            <input id="expectDate" name="expectDate"
                                   class="easyui-datebox" style="width: 118px;"
                                   data-options="" />
                        </td>
                    </tr>
                    <tr id="id_dealwith">
                        <th class="th" align="right" style="width: 100px;">处理结果：</th>
                        <td colspan="5" style="padding: 3px;">
                        <textarea id="dealwithDesc" name="dealwithDesc"
                                  class="easyui-textbox" style="width: 650px;height:60px"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" style="width: 100px;">责任工程师：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input id="dutyEngineer" name="dutyEngineer"
                                   class="easyui-combobox" style="width: 120px;"
                                   data-options="required:true" readonly/>

                        </td>
                        <th class="th" align="right" style="width: 80px;">状态：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input id="status" name="status"
                                   class="easyui-combobox" style="width: 120px;"
                                   data-options="required:true" readonly/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">手机号：</th>
                        <td style="width: 80px; padding: 3px">
                            <input id="mobileNumber" name="mobileNumber"
                                   class="easyui-textbox" style="width: 120px;" />
                        </td>
                    </tr>
                    <tr id="id_respond_man">
                        <th class="th" align="right" style="width: 100px;">创建人：</th>
                        <td style="width: 80px; padding: 3px">
                            <input id="respondBy" name="respondBy"
                                   class="easyui-combobox" style="width: 120px;"
                                   readonly/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">反馈期限：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input id="respondDate" name="respondDate"
                                   class="easyui-textbox" style="width: 120px;"
                                   readonly/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">EMAIL：</th>
                        <td style="width: 80px;  padding: 3px">
                            <input id="email" name="email"
                                   class="easyui-textbox" style="width: 120px;"
                                   readonly/>
                        </td>
                    </tr>
                    <tr id="id_attachment">
                        <th class="th" align="right" style="width: 100px;">上传附件：</th>
                        <td colspan="5" style="padding: 3px;">
                            <input id="fileToUpload" name="file"
                                   class="easyui-filebox" style="width: 450px">
                            <font color="red">注意：上传附件后请先保存再提交</font>
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
        <fieldset class="fieldset_eui">
            <legend>附件清单</legend>
            <table id="dg"></table>
        </fieldset>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
<script type="text/javascript">
    var param; // operation[add,edit,view]
    var pkid = null;//主表PKID

    function i18nCallBack() {
        param = getParentParam_();
        pkid = param.pkid;

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "YESORNO,EM_RESPOND_FILE_TYPE,EM_RESPOND_APP_TYPE,EM_RESPOND_STATUS,WS_USER,EM_URGENCY_DEGREE"
            },
            successCallBack: function (jdata) {
                $('#ifSubstan').combobox({
                    panelHeight: '80px',
                    data: jdata.data.YESORNO,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    onSelect:function (value) {
                        var isAccept = $('#isAccept').combobox('getValue');
                        if(value.VALUE=="Y" &&isAccept=="Y"){
                            $('#expectDate').datebox({required: true});
                        }else{
                            $('#expectDate').datebox({required: false});
                        }
                    }
                });
                $('#urgencyDegree').combobox({
                    panelHeight: '100px',
                    data: jdata.data.EM_URGENCY_DEGREE,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });
                $('#isAccept').combobox({
                    panelHeight: '100px',
                    data: jdata.data.YESORNO,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    onSelect:function (value) {
                        var ifSubstan = $('#ifSubstan').combobox('getValue');
                        if(value.VALUE=="Y" &&ifSubstan=="Y"){
                            $('#expectDate').datebox({required: true});
                        }else{
                            $('#expectDate').datebox({required: false});
                        }
                    }
                });
                $('#appType').combobox({
                    panelHeight: '300px',
                    data: jdata.data.EM_RESPOND_APP_TYPE,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });
                $('#status').combobox({
                    panelHeight: '300px',
                    data: jdata.data.EM_RESPOND_STATUS,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });
                $('#dutyEngineer').combobox({
                    panelHeight: '300px',
                    data: jdata.data.WS_USER,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });
                $('#respondBy').combobox({
                    panelHeight: '300px',
                    data: jdata.data.WS_USER,
                    valueField: 'VALUE',
                    textField: 'TEXT'
                });
                $('#dealwithDesc').textbox({
                    multiline: true
                });
                var operation = param.operation;
                if (operation == "add") {
                    $('#fileNo').combobox('readonly', true);
                    $('#fileVer').textbox('readonly', true);
                    $('#ata').textbox('readonly', true);
                    $('#appType').textbox('readonly', true);
                    $('#model').textbox('readonly', true);

                    $('#id_dealwith').hide();
                    $('#id_respond_man').hide();

                    $('#id_isAccept').hide();
                    $('#status').combobox('setValue', 'WRITING');
                } else if (operation == "edit") {
                    $('#id_dealwith').hide();
                    $('#id_respond_man').hide();
                    $('#id_isAccept').hide();
                    // InitDataForm(pkid);
                } else if (operation == "view") {
                    $('#saveBtn').hide();
                    $('#commitBtn').hide();

                    $('#fileNo').combobox('readonly', true);
                    $('#fileVer').textbox('readonly', true);
                    $('#ata').textbox('readonly', true);
                    $('#appType').textbox('readonly', true);
                    $('#model').textbox('readonly', true);
                    $('#respondDesc').textbox('readonly', true);
                    $('#dealwithDesc').textbox('readonly', true);
                    $('#mobileNumber').textbox('readonly', true);
                    $('#isAccept').combobox('readonly', true);
                    $('#id_attachment').hide();

                    // InitDataForm(pkid);
                } else if (operation == "flow") {
                    $('#id_btn_row').hide();

                    $('#fileNo').combobox('readonly', true);
                    $('#fileVer').textbox('readonly', true);
                    $('#ata').textbox('readonly', true);
                    $('#appType').textbox('readonly', true);
                    $('#model').textbox('readonly', true);
                    $('#respondDesc').textbox('readonly', true);
                    $('#mobileNumber').textbox('readonly', true);

                    if (param.taskPropId == "taskEmRespond1") {
                        $('#id_dealwith').hide();
                        $('#id_isAccept').hide();
                    } else if (param.taskPropId == "taskEmRespond2") {
                        $('#dealwithDesc').textbox({required: true});
                        $('#isAccept').combobox({required: true});
                        $('#ifSubstan').combobox({required: true});
                    }

                    $('#id_attachment').hide();

                    // InitDataForm(pkid);
                }
                $('#fileType').combobox({
                    panelHeight: '300px',
                    data: jdata.data.EM_RESPOND_FILE_TYPE,
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    onSelect: function (item) {
                        $('#fileNo').combobox('readonly', false);
                        var arr = ['MP', 'EO', 'EA', 'TB', 'SMJC', 'EOJC', 'EAJC', 'NSJC', 'LMJC', 'CMJC', 'TES', 'TD', 'MEL', 'OTHER'];
                        if ($.inArray(item.VALUE, arr) == -1) {
                            $('#fileVer').textbox('readonly', false);
                            $('#ata').textbox('readonly', false);
                            $('#appType').textbox('readonly', false);
                            $('#model').textbox('readonly', false);
                            $('#dutyEngineer').combobox('readonly', false);
                        } else {
                            $('#fileNo').MyComboGrid({
                                params: {
                                    FunctionCode: "EM_RESPOND_FILE_NO_LIST",
                                    fileType: item.VALUE
                                },
                                columns: [[
                                    {title: '文件编号', field: 'FILE_NO', width: 140, sortable: true},
                                    {title: '版本', field: 'FILE_VER', width: 40, sortable: true},
                                    {title: '章节', field: 'ATA', width: 40, sortable: true},
                                    {title: '适用类型', field: 'APP_TYPE', width: 50, sortable: true},
                                    {title: '型号', field: 'MODEL', width: 70, sortable: true},
                                ]],
                                singleSelect: true,
                                pagination: true,
                                idField: 'FILE_NO',
                                textField: 'FILE_NO',
                                width: 150,
                                onSelect: function (index, row) {
                                    $('#fileVer').textbox('setValue', row.FILE_VER);
                                    if ("LMJC" === row.FILE_TYPE) {
                                        $('#ata').textbox('setValue', "N/A");
                                        $('#appType').textbox('setValue', "N/A");
                                    } else {
                                        $('#ata').textbox('setValue', row.ATA);
                                        $('#appType').textbox('setValue', row.APP_TYPE);
                                    }
                                    $('#model').textbox('setValue', row.MODEL);
                                    $('#dutyEngineer').combobox('setValue', row.DUTY_ENGINEER);
                                }
                            });
                        }
                        //当文件类型为波音手册
                        if (item.VALUE == "TD" || item.VALUE == "MEL" || item.VALUE == "OTHER") {
                           // $('#fileNo').textbox({editable: true, onlyview: false, required: true});
                            $('#fileNo').combobox({
                                hasDownArrow:false,
                                panelHeight:1,
                                editable:true,
                                required:true
                            });
                            $('#fileNo').combobox('readonly', false);
                            $('#fileVer').textbox('readonly', false);
                            $('#ata').textbox('readonly', false);
                            $('#appType').textbox('readonly', false);
                            $('#model').textbox('readonly', false);
                            $('#fileVer').textbox({editable: true, onlyview: false, required: false});
                            $('#ata').textbox({editable: true, onlyview: false, required: true});
                            $('#appType').textbox({editable: true, onlyview: false, required: false});
                            $('#model').textbox({editable: true, onlyview: false, required: false});
                            $('#dutyEngineer').combobox('readonly', false);
                            //当文件类型为波音或其他厂家手册，则系统默认责任工程师为胡英杰
                            if (item.VALUE == "TD" || item.VALUE == "OTHER") {
                                $('#dutyEngineer').combobox('setValue', '4');
                            }
                            //MEL手册默认工程师为蔡乔龙
                            if (item.VALUE == "MEL") {
                                $('#dutyEngineer').combobox('setValue', '11381');
                            }
                            // $('#status').combobox("setValue",'');
                            // $('#status').combobox({required: false});
                        }
                    }
                });



                if(pkid){
                    InitDataForm(pkid);
                }
            }
        });

        InitDataGrid(pkid);
    }

    //回填
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_RESPOND_PKID",
                pkid: pkid
            },
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    //待反馈状态  只能编辑处理结果
                    if (jdata.data.STATUS == "DFK") {
                        $("#commitBtn").hide();
                        $('#id_dealwith').show();
                        $('#id_isAccept').show();
                        $('#id_attachment').hide();
                        $('#fileType').combobox({onlyview: true});
                        $('#fileNo').combobox({onlyview: true});
                        $('#urgencyDegree').combobox({onlyview: true});
                        $('#respondDesc').textbox({onlyview: true});
                        $('#mobileNumber').textbox({onlyview: true});
                        $('#fileToUpload').filebox({onlyview: true});
                        $('#dealwithDesc').textbox({required: true});
                        //显示保存按钮
                        $('#id_btn_row').show();
                        $("#commitBtn").hide();
                        $("#closeBtn").hide();
                    }
                    if (jdata.data.FILE_TYPE == "TD" || jdata.data.FILE_TYPE == "MEL" || jdata.data.FILE_TYPE == "OTHER") {
                        $('#fileNo').combobox({
                            hasDownArrow: false,
                            panelHeight: 1,
                            editable: true,
                            required: true
                        });
                        $('#fileNo').combobox('readonly', false);
                        $('#fileVer').textbox('readonly', false);
                        $('#ata').textbox('readonly', false);
                        $('#appType').textbox('readonly', false);
                        $('#model').textbox('readonly', false);
                        $('#fileVer').textbox({editable: true, onlyview: false, required: false});
                        $('#ata').textbox({editable: true, onlyview: false, required: true});
                        $('#appType').textbox({editable: true, onlyview: false, required: false});
                        $('#model').textbox({editable: true, onlyview: false, required: false});
                        $('#dutyEngineer').combobox('readonly', false);
                    }
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    if (param.operation == "flow") parent.$('#authId').val(jdata.data.DUTY_ENGINEER);
                    //驳回的状态编辑，隐藏提交按钮
                    if (jdata.data.STATUS == "RETURNED") {
                        // $("#commitBtn").hide();
                    }


                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }

            }
        });
    }

    function InitDataGrid(pkid) {
        $("#dg").MyDataGrid({
            identity: 'dg',
            sortable: true,
            singleSelect: true,
            pagination: false,
            resize: function () {
                return {width: 780, height: 150};
            },
            queryParams: {
                category: "emrespond",
                sourceId: !! pkid ? pkid : "0"
            },
            columns: {
                param: {FunctionCode: 'ATTACHMENT_LIST'},
                alter: {
                    ORG_NAME: {
                        formatter: function (value, row, index) {
                            if (! value) {
                                return "";
                            }

                            var fileId = row.FILE_ID;
                            var filename = row.ORG_NAME;
                            var results = [];
                            results.push('<li><a onclick="downFile(' + fileId + ')" href="javascript:void(0);">' + filename + '</a>&nbsp;');
                            if (param.operation != 'view' && param.operation != 'flow') {
                                results.push('<span onclick="deleteFile(' + fileId + '); reload_(); return false;" class="icon-cross">&nbsp;&nbsp;&nbsp;&nbsp;</span>');
                            }

                            results.push('</li>');
                            return results.join('')
                        }
                    }
                }
            }
        });
    }

    function save() {
        var isValidate = $('#mform').form('validate');
        if (! isValidate) {
            return "false";
        }
        var formData = JSON.stringify($('#mform').serializeObject());

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "EM_RESPOND_ADD",
                formData: formData
            },
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), null);
                    // $('#respondBy').combobox("setValue",jdata.data.respondBy);
                    $('#pkid').val(jdata.data.pkid);
                    pkid = jdata.data.pkid;

                    if (!! $('#fileToUpload').filebox('getValue')) {
                        upload(jdata.data.pkid);
                    }

                    if (param.operation != "flow") {
                        param.OWindow.reload_();
                        MsgAlert({
                            content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')
                        });
                    } else {
                        MsgAlert({
                            content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')
                        });
                    }
                } else {
                    if (/ORA-01400.*NULL.*EMAIL.*/.test(jdata.msg)) {
                        MsgAlert({
                            content: "当前操作人没有维护EMAIL，无法保存。请联系相关业务员维护帐户信息！",
                            type: 'error'
                        });
                    } else {
                        MsgAlert({
                            content: jdata.msg,
                            type: 'error'
                        });
                    }
                }
            }
        });
    }
    
    function upload(pkid) {
        $.ajaxFileUpload({
            url: Constant.API_URL + "ATTACHMENT_UPLOAD",
            secureuri: false,
            fileElementId: "filebox_file_id_1",
            dataType: "json",
            type: "post",
            data: {
                "fileCategory": "emrespond",
                "sourceId": pkid
            },
            success: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    $('#fileToUpload').filebox('clear');
                    $('#dg').datagrid('load', {
                        category: "emrespond",
                        sourceId: pkid
                    });
                } else {
                    MsgAlert({
                        content: $.i18n.t('msg_tip:TIP.COMMON.UPLOAD_FAILED') + jdata.msg,
                        type: 'error'
                    });
                }
            }
        });
    }

    function commit() {
        if (! pkid) {
            MsgAlert({content: '请保存记录！', type: 'error'});
            return;
        }
        $.messager.confirm("", "是否确认提交？", function (r) {
            if (r) {
                common_add_edit_({
                    url: "/views/em/emrespond/workflow/work_flow_account_select.shtml",
                    param: {
                        FunctionCode_: "EM_RESPOND_SUBMIT",
                        otherParam: pkid,
                        successCallBack: closeW
                    },
                    title: $.i18n.t("选择审批人"),
                    width: 610,
                    height: 300
                });
            }
        });
    }

    /** 刷新列表数据 */
    function reload_() {
        $("#dg").datagrid("reload");

    }

    function closeW() {
        param.OWindow.reload_();
        CloseWindowIframe();
    }
</script>

</html>
