<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>评估</title>
</head>

<body>
<div style="">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <table class="table table-bordered table-info">
                    <tr>
                        <td id="baocun" align="right" style="width:20% ">
                            <input class="btn btn-primary" type="button" id="submit" onclick="save()" value="保存"/>
                            <input class="btn btn-primary" type="button" id="submitFlow" onclick="commit()"
                                   value="提交校对"/>
                            <input class="btn btn-primary" type="button" id="close" onclick=" CloseWindowIframe()"
                                   value="关闭"/>
                            <a class="btn btn-primary" type="button" onclick="compute()"
                               data-options="iconCls:'icon-search'">手动计算适用性</a>
                        </td>
                    </tr>
                </table>
                <fieldset class="fieldset_eui" style="width:100%;margin-right:5px">
                    <legend data-i18n="">基础信息</legend>
                    <table class="table table-bordered table-info">
                        <tr>
                            <th class="th" align="right" style="width: 80px;">评估单号：</th>
                            <td class="tdr">
                                <input class="easyui-textbox" id="evalNo" name="evalNo" style="width: 240px"
                                       data-options="required:true,editable:false,onlyview: true"/>
                            </td>
                            <th class="th" align="right" style="width: 80px;">机队 ：</th>
                            <td class="tdr">
                                <input style="width: 120px" class="easyui-textbox" id="fleet"
                                       name="fleet"
                                       data-options="required:true,editable:false,onlyview: true"/>
                            </td>
                            <th class="th" align="right" style="width: 80px;">章节：</th>
                            <td class="tdr">
                                <input style="width: 120px" class="easyui-textbox" id="ata" name="ata"
                                       data-options="required:true,editable:false,onlyview: true"/>
                            </td>
                        </tr>
                        <tr>
                            <th class="th" align="right" style="width: 80px;">飞机注册号：</th>
                            <td class="tdr">
                                <input class="easyui-textbox" id="acnos" name="acnos" style="width: 240px"
                                       data-options="required:true,editable:false,onlyview: true"/>
                            </td>
                            <th class="th" align="right" style="width: 80px;">状态 ：</th>
                            <td class="tdr">
                                <input style="width: 120px" class="easyui-combobox" id="wfStatus"
                                       name="formerOperator"
                                       data-options="required:false,editable:false,onlyview: true"/>
                            </td>

                        </tr>
                        <tr>

                            <th class="th" align="right" style="width: 80px;">备注：</th>
                            <td class="tdr" colspan="5">
                                <input style="width: 900px;height:60px" class="easyui-textbox" id="memo" name="memo"
                                       data-options="required:false,multiline:true,editable:true,onlyview: false"/>
                            </td>
                        </tr>
                    </table>
                </fieldset>
                <div id="mlayout" class="easyui-layout" style="height: 620px;">

                    <div id="lay_left" data-options="region:'west',split:false" style="width: 51%;">
                        <fieldset class="fieldset_eui" style="width:96%;margin-right:5px">
                            <legend data-i18n="">未评估MP评估单</legend>
                            <div>
                                <table class="table table-bordered table-info"
                                       style="border-collapse:separate; border-spacing:0px 5px;">
                                    <tr>
                                        <th data-i18n="" style="width:90px;padding-right: 6px;" align="right">系统计算结论：</th>
                                        <td>
                                            <input class="easyui-combobox" name="ifApl" id="ifApl"
                                                   data-options="editable: true"
                                                   style="width:130px"/>
                                        </td>
                                        <th data-i18n="" style="width:80px;padding-right: 6px;" align="right">人工确认：</th>
                                        <td>
                                            <input class="easyui-comboxbox" name="manualConfirmation1" id="manualConfirmation1"
                                                   data-options="editable: true"
                                                   style="width:130px"/>
                                        </td>

                                    </tr>
                                    <tr>
                                        <th data-i18n="" style="width:80px;padding-right: 6px;" align="right">适用性：</th>
                                        <td>
                                            <input class="easyui-textbox" name="applDesc1" id="applDesc1"
                                                   data-options="editable: true"
                                                   style="width:130px"/>
                                        </td>
                                        <th data-i18n="" style="width:80px;padding-right: 6px;" align="right">MP号：</th>
                                        <td>
                                            <input class="easyui-comboxbox" name="cmpNo1" id="cmpNo1"
                                                   data-options="editable: true"
                                                   style="width:130px"/>
                                        </td>


                                    </tr>
                                    <tr>
                                        <td  style="padding-right: 6px" colspan="4">
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

                                            <a class="searchBtn" type="button" onclick="searchDg1Data()"
                                               data-options="iconCls:'icon-search'" id="searchBtn">
                                                <span data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>
                                            <a class="searchBtn" type="button" onclick="revDatas()"
                                               data-options="iconCls:'icon-search'" id="revDatas">
                                                <span data-i18n="">改版</span></a>
                                            <a class="searchBtn" type="button" onclick="noRevDatas()" id="noRevDatas"
                                               data-options="iconCls:'icon-search'">
                                                <span data-i18n="">不改版</span></a>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <table id="dg1"></table>
                        </fieldset>
                    </div>


                    <div id="lay_right" data-options="region:'center'" style="width: 49%;">
                        <fieldset class="fieldset_eui" style="width:96%;margin-right:5px">
                            <legend data-i18n="">已评估MP评估单</legend>
                            <div>
                                <table class="table table-bordered table-info"
                                       style="border-collapse:separate; border-spacing:0px 5px;">
                                    <tr>
                                        <th data-i18n="" style="width:80px;padding-right: 6px;" align="right">评估结论：</th>
                                        <td>
                                            <input class="easyui-combobox" name="evalResult" id="evalResult"
                                                   data-options="editable: true"
                                                   style="width:130px"/>
                                        </td>
                                        <th data-i18n="" style="width:80px;padding-right: 6px;" align="right">人工确认：</th>
                                        <td>
                                            <input class="easyui-combobox" name="manualConfirmation2" id="manualConfirmation2"
                                                   data-options="editable: true"
                                                   style="width:130px"/>
                                        </td>

                                    </tr>
                                    <tr>
                                        <th data-i18n="" style="width:80px;padding-right: 6px;" align="right">适用性：</th>
                                        <td>
                                            <input class="easyui-textbox" name="applDesc2" id="applDesc2"
                                                   data-options="editable: true"
                                                   style="width:130px"/>
                                        </td>
                                        <th data-i18n="" style="width:80px;padding-right: 6px;" align="right">MP号：</th>
                                        <td>
                                            <input class="easyui-comboxbox" name="cmpNo2" id="cmpNo2"
                                                   data-options="editable: true"
                                                   style="width:130px"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="right: auto" colspan="4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

                                            <a class="searchBtn" id="refreshBtn" type="button" onclick="refreshMpd()"
                                               data-options="iconCls:'icon-search'">
                                                <span>刷新新版MP</span></a>
                                            &nbsp;&nbsp;&nbsp;
                                            <a class="searchBtn" id="refreshAplBtn" type="button"
                                               onclick="refreshAplMpd()"
                                               data-options="iconCls:'icon-search'">
                                                <span>适用结论刷新</span></a>
                                            &nbsp;&nbsp;&nbsp;
                                            <a class="searchBtn" type="button" onclick="searchDg2Data()"
                                               data-options="iconCls:'icon-search'">
                                                <span data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>
                                            <!--<a class="searchBtn" type="button" onclick="revokeDatas()"
                                               data-options="iconCls:'icon-search'">
                                                <span data-i18n="">撤销</span></a>-->
                                        </td>
                                    </tr>
                                </table>
                            </div>
                            <div>
                                <table id="dg2"></table>
                            </div>
                        </fieldset>
                    </div>
                    </fieldset>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var param;
    var operation;
    var PAGE_DATA = {};
    var evalNo = null;//主表
    var mainType = null;
    var flowType;
    function i18nCallBack() {
        param = getParentParam_();
        evalNo = param.evalNo;
        mainType = param.type;
        flowType = param.flowType;


        //$("#evalNo").val(evalNo);
        InitFuncCodeRequest_({
            data: {
                domainCode: "EM_APPL_TYPE,EM_AC_IN_EVAL_STATUS,YESORNO,EM_AC_IN_ITEM_EVAL_RESULT,EM_AC_IN_ITEM_COMMITE,EM_IF_APPL",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    PAGE_DATA ["YESORNO"] = DomainCodeToMap_(jdata.data["YESORNO"]);
                    PAGE_DATA ["evalResult"] = DomainCodeToMap_(jdata.data["EM_AC_IN_ITEM_EVAL_RESULT"]);
                    PAGE_DATA ["itemCommite"] = DomainCodeToMap_(jdata.data["EM_AC_IN_ITEM_COMMITE"]);
                    PAGE_DATA ["itemCommite1"] = DomainCodeToMap_(jdata.data["EM_AC_IN_ITEM_COMMITE"]);
                    PAGE_DATA ["itemCommite1"] = DomainCodeToMap_(jdata.data["EM_AC_IN_ITEM_COMMITE"]);
                    PAGE_DATA ["EM_IF_APPL"] = DomainCodeToMap_(jdata.data["EM_IF_APPL"]);
                    PAGE_DATA ["APPL_TYPE"] = DomainCodeToMap_(jdata.data["EM_APPL_TYPE"]);
                    $('#wfStatus').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_AC_IN_EVAL_STATUS,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#ifApl').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_AC_IN_ITEM_COMMITE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#manualConfirmation1').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_AC_IN_ITEM_COMMITE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#manualConfirmation2').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_AC_IN_ITEM_COMMITE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#evalResult').combobox({
                        panelHeight: '100px',
                        data: jdata.data.EM_AC_IN_ITEM_EVAL_RESULT,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    if (evalNo) {
                        InitDataForm(evalNo);
                        InitDg1Grid();
                        InitDg2Grid();
                    }
                    if (mainType == "VIEM") {
                        $("#submit").hide();
                        $("#submitFlow").hide();
                        $("#revDatas").hide();
                        $("#noRevDatas").hide();
                        $("#searchBtn").hide();
                        $("#refreshBtn").hide();
                        $("#refreshAplBtn").hide();
                    }
                    if (flowType == "flowSh") {
                        $("#refreshBtn").hide();
                        $("#refreshAplBtn").hide();
                    }
                    if (flowType == "flowTh") {
                        $("#refreshBtn").show();
                        $("#refreshAplBtn").show();
                    }
                }
            }
        })
    }

    function InitDg1Grid() {
        var identity = 'dg1';
        $("#dg1").MyDataGrid({
            identity: 'dg1',
            sortable: true,
            singleSelect: true,
            enableLineEdit: true,
            //fit: true,
            resize: function () {
                return {
                    width: 614, height: 480
                };
            },
            queryParams: {evalNo: evalNo, ifEval: "N"},
            //pageSize: 13,
            columns: {
                param: {FunctionCode: 'EM_AC_IN_ITEM_FOR_N'},
                alter: {
                    MPD_EVAL_NO: {
                        formatter: function (value, row, index) {
                            return '<a href="javascript:void(0);" onclick="viewPointImgrTab(\'' + value + '\');">' + value + '</a>';
                        }
                    },
                    IF_APL: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['itemCommite'][value];
                        }
                    },
                    MANUAL_CONFIRMATION: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['itemCommite'][value];
                        }
                    },
                    IF_APPL: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['EM_IF_APPL'][value];
                        }
                    },
                    APPL_TYPE: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA ["APPL_TYPE"][value];
                        }
                    },
                }
            },
            onLoadSuccess: function (data) {
            },
            validAuth: function (row, items) {
            },
            contextMenus: [{
                id: "m-apl", i18nText: "适用",
                onclick: function () {
                    var rowdata = getDG(identity).datagrid('getSelected');
                    var pkid = rowdata.PKID;
                    editManualConfirmation(pkid, 'APL');
                }
            }, {
                id: "m-noApl", i18nText: "不适用",
                onclick: function () {
                    var rowdata = getDG(identity).datagrid('getSelected');
                    var pkid = rowdata.PKID;
                    editManualConfirmation(pkid, 'NOAPL');
                }
            }, {
                id: "m-partApl", i18nText: "部分适用",
                onclick: function () {
                    var rowdata = getDG(identity).datagrid('getSelected');
                    var pkid = rowdata.PKID;
                    editManualConfirmation(pkid, 'PARTAPL');
                }
            }],
            validAuth: function (row, items) {
                if (mainType != 'VIEM') {
                    items['适用'].enable = true;
                    items['不适用'].enable = true;
                    items['部分适用'].enable = true;
                } else {
                    items['适用'].enable = false;
                    items['不适用'].enable = false;
                    items['部分适用'].enable = false;
                }
                return items;
            },
        });
    }

    function viewPointImgrTab(evalNo) {
        // var rowData = getDG("dg").datagrid('getSelected');
        ShowWindowIframe({
            width: 1350,
            height: 850,
            param: {evalNo: evalNo},
            title: "查看",
            url: "/views/em/emmpdeval/workflow/evalNoteView.shtml"
        });
    }

    /*
        更改人工确认
     */
    function editManualConfirmation(pkid, type) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, type: type, FunctionCode: "EM_AC_IN_EVAL_EDIT_APL"}, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $("#dg1").datagrid("reload");
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function InitDg2Grid() {
        $("#dg2").MyDataGrid({
                identity: 'dg2',
                resize: function () {
                    return {width: 580, height: 480};
                },
                queryParams: {evalNo: evalNo, ifEval: "Y"},
                pageSize: 13,
                columns: {
                    param: {FunctionCode: 'EM_AC_IN_ITEM_FOR_Y'},
                    alter: {
                        MPD_EVAL_NO: {
                            formatter: function (value, row, index) {
                             /*   var newEvalNo = "";
                                if (typeof (row.NEW_EVAL_NO) != "undefined") {
                                    newEvalNo = row.NEW_EVAL_NO;
                                } else {
                                    newEvalNo = value;
                                }*/
                                return '<a href="javascript:void(0);" onclick="viewPointImgrTab(\'' + value + '\');">' + value + '</a>';
                            }
                        },
                        IF_APL: {
                            formatter: function (value, row, index) {
                                return PAGE_DATA['itemCommite'][value];
                            }
                        },
                        MANUAL_CONFIRMATION: {
                            formatter: function (value, row, index) {
                                return PAGE_DATA['itemCommite'][value];
                            }
                        },
                        EVAL_RESULT: {
                            formatter: function (value, row, index) {
                                return PAGE_DATA['evalResult'][value];
                            }
                        },
                        IF_APPL: {
                            formatter: function (value, row, index) {
                                return PAGE_DATA['EM_IF_APPL'][value];
                            }
                        }
                    }
                },
                contextMenus:
                    [
                        {
                            id: "m-revoke", i18nText: "撤销", auth: "",
                            onclick: function () {
                                var rowData = $("#dg2").datagrid('getSelected');
                                revokeDatas(rowData.PKID);
                            }
                        }
                    ],
                validAuth: function (row, items) {
                    if (mainType != 'VIEM') {
                        items['撤销'].enable = true;
                    } else {
                        items['撤销'].enable = false;
                    }
                    return items;
                }
            }
        )
        ;
    }

    //回填
    function InitDataForm(evalNo) {
        InitFuncCodeRequest_({
            data: {evalNo: evalNo, FunctionCode: "EM_AC_IN_EVAL_DETAIL"}, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    $('#wfStatus').combobox({value: jdata.data.WF_STATUS});
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function save(flag) {
        var $form = $("#mform");
        var mainData = JSON.stringify($('#mform').serializeObject());
        InitFuncCodeRequest_({
            data: {
                mainData: mainData,
                FunctionCode: "EM_AC_IN_EVAL_SAVE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $("#wfStatus").combobox('setValue', 'PGZ');
                    param.OWindow.reload_();
                    // CloseWindowIframe();
                } else {
                    if (!flag) {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            }
        });
    }

    /*
        不改版
     */
    function noRevDatas() {
        var rows = $('#dg1').datagrid('getChecked');
        if (rows.length == 0) {
            MsgAlert({content: "请选择数据。", type: 'error'});
            return;
        }
        for (i = 0; i < rows.length; i++) {
            if (typeof(rows[i].MANUAL_CONFIRMATION) == "undefined") {
                MsgAlert({content: "存在未人工确认的数据，请确认。", type: 'error'});
                return;
            }
       /*     //系统计算部分使用用户选择适用无需改版需校验不允许提交只能改版不管用户的结论是否适用
            if (rows[i].IF_APL == "PARTAPL") {
                MsgAlert({content: "部分适用必须改版，请确认。", type: 'error'});
                return;
            }*/
            //系统计算适用，用户选择不适用不允许无需改版
            if (rows[i].IF_APL == "APL" && rows[i].MANUAL_CONFIRMATION == "NOAPL") {
                MsgAlert({content: "系统计算适用，人工选择不适用则必须改版，请确认。", type: 'error'});
                return;
            }
            //系统计算不适用，用户选择适用不允许无需改版
            if (rows[i].IF_APL == "NOAPL" && rows[i].MANUAL_CONFIRMATION == "APL") {
                MsgAlert({content: "系统计算不适用,人工选择适用则必须改版，请确认。", type: 'error'});
                return;
            }
            rows[i] = toCamelCase(rows[i]);
        }
        var detailData = JSON.stringify(rows);

        InitFuncCodeRequest_({
            data: {
                detailData: detailData,
                FunctionCode: "EM_AC_IN_EVAL_NO_REV"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //param.OWindow.reloadg3();
                    // CloseWindowIframe();
                    searchDg1Data();
                    searchDg2Data();
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    /*
        改版
     */
    function revDatas() {
        var rows = $('#dg1').datagrid('getChecked');
        if (rows.length == 0) {
            MsgAlert({content: "请选择数据。", type: 'error'});
            return;
        }
        if (rows.length > 1) {
            MsgAlert({content: "只能处理单条。", type: 'error'});
            return;
        }
        if (rows[0].MANUAL_CONFIRMATION == "" || typeof (rows[0].MANUAL_CONFIRMATION) == "undefined") {
            MsgAlert({content: "存在未人工确认的数据，请确认。", type: 'error'});
            return;
        }
        var rFlag = false;
        InitFuncCodeRequest_({
            data: {evalNo: rows[0].MPD_EVAL_NO, FunctionCode: "EM_AC_IN_EVAL_QUERY_EVAL"},
            async: false, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data.NUM > 0) {
                        MsgAlert({content: "该评估单已改版并在流程中，请退回流程并在流程中修改适用性，此新飞机条目可设置为【不改版】。", type: 'error'});
                        rFlag = true;
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
        if(rFlag){
            return;
        }
        for (i = 0; i < rows.length; i++) {
            rows[i] = toCamelCase(rows[i]);
        }
        var detailData = JSON.stringify(rows);

        InitFuncCodeRequest_({
            data: {
                detailData: detailData,
                FunctionCode: "EM_AC_IN_EVAL_REV"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ShowWindowIframe({
                        width: 1300,
                        height: 750,
                        param: {
                            evalNo: jdata.data,
                            Flag: '1',
                            isUdf: "N",
                            isEdit: 1,
                            itemNumber: "",
                            fleetPass: $('#fleet').textbox('getValue')
                        },
                        title: "评估",
                        url: "/views/em/emmpdeval/evalNote.shtml"
                    });
                    searchDg1Data();
                    searchDg2Data();
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    /*
        撤销数据
     */
    function revokeDatas(pkid) {
        InitFuncCodeRequest_({
            data: {
                pkid: pkid,
                FunctionCode: "EM_AC_IN_EVAL_REVOKE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //param.OWindow.reloadg3();
                    // CloseWindowIframe();
                    $("#dg1").datagrid("reload");
                    $("#dg2").datagrid("reload");
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    /*
        提交
     */
    function commit() {
        var $form = $("#mform");
        var isValidate = $form.form('validate');
        if (!isValidate) {
            return false;
        }
        var wfstatus = $('#wfStatus').combobox("getValue");
        if(wfstatus !="PGZ"&&wfstatus !="YCJ"){
            MsgAlert({content: "该数据已被提交过了。", type: 'error'});
            return;
        }
        var flag = true;
        InitFuncCodeRequest_({
            data: {evalNo: $("#evalNo").textbox("getValue"), FunctionCode: "EM_AC_IN_EVAL_CHECK"},
            async: false, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data.NUM > 0) {
                        MsgAlert({content: "存在未评估的MP评估单，无法提交。", type: 'error'});
                        flag = false
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
        if (!flag) {
            return;
        }
        if (!confirm("确认提交该记录？")) {
            return;
        }
        save(false);

        InitFuncCodeRequest_({
            data: {
                evalNo: $("#evalNo").textbox("getValue"),
                asnyc: false,
                FunctionCode: "EM_AC_IN_CHECK_STATUS"
            },
            successCallBack: function (jdata) {
                if (jdata.code != null) {
                    // ajaxLoading();
                    common_add_edit_({
                        identity: '', isEdit: '', width: 520, height: 300, title: $.i18n.t('选择审批人'),
                        param: {
                            roleId: '',
                            otherParam: $("#evalNo").textbox("getValue"),
                            FunctionCode_: 'EM_AC_IN_EVAL_SUBMIT',
                            msgpkid: param.msgpkid,
                            successCallback: sumbitReload,
                            flowKey:"emAcInEvalFlow"
                        },
                        url: "/views/flow/work_flow_account_select.shtml"
                    });
                }
                else {
                    MsgAlert({content: "该数据已被提交过了。", type: 'error'});
                    // ajaxLoadEnd();
                }
            }
        })
    }

    //手动重新计算适用性
    function compute() {
        InitFuncCodeRequest_({
            data: {
                evalNo: $("#evalNo").textbox("getValue"),
                FunctionCode: "EM_AC_IN_EVAL_COMPUTE"
            }, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function sumbitReload() {
        CloseWindowIframe();
        param.OWindow.reload_();
    }

    //查询
    function searchDg1Data() {
        onSearch_('dg1', '#mform');
    }

    function searchDg2Data() {
        onSearch_('dg2', '#mform');
    }
    function reload_() {
        $("#dg1").datagrid("reload");
        $("#dg2").datagrid("reload");
    }

    function refreshMpd() {
        InitFuncCodeRequest_({
            data: {evalNo: $("#evalNo").textbox("getValue"), FunctionCode: "EM_AC_IN_EVAL_REFRESH_MPD"},
            async: false, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    searchDg1Data();
                    searchDg2Data();
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function refreshAplMpd() {
        InitFuncCodeRequest_({
            data: {evalNo: $("#evalNo").textbox("getValue"), FunctionCode: "EM_AC_IN_EVAL_REFRESH_APL_MPD"},
            async: false, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.msg == "") {
                        MsgAlert({content: '当前条目适用性均为最新的。'});
                    } else {
                        searchDg1Data();
                        searchDg2Data();
                        MsgAlert({content: jdata.msg, type: 'error'});
                    }

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }
</script>

</html>