<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html >
<head id="i18n_" module="pm_mplanconf">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
    <title>章节主数据编辑</title>
</head>
<body>

<div class="ibox-content">
    <form class="form-horizontal m-t" id="mform" style="width:100%;">
        <input type="hidden" id="pkid" name="pkid">
        <table class="table table-bordered table-info">
            <tr>
                <td align="right" style="padding-top: 6px;">
                    <input class="btn btn-primary" type="button" onclick="save();" value="保存"/>&nbsp;&nbsp;
                    <input class="btn btn-primary" type="button" style="margin-right: 25px;" onclick="closeAdd();"
                           value="关闭"/>
                </td>
            </tr>
        </table>
        <table class="table table-bordered table-info">
            <tr>
                <th class="td5 hs" style="width:70px;" align="right">机型：</th>
                <td class="tdr hs">
                    <input class="easyui-combobox" id="fleet" name="fleet"
                           data-options="required:true" style="width:70px;"/>
                </td>
                <th class="td5 hs" style="width:70px;" align="right">手册类型：</th>
                <td class="tdr hs">
                    <input class="easyui-combobox" id="manualType" name="manualType"
                           data-options="required:true" style="width:70px;"/>
                </td>
                <th class="td5 hs" style="width:150px;" align="right">子机型：</th>
                <td class="tdr hs">
                    <input class="easyui-combobox" id="subFleet" name="subFleet"
                           data-options="required:false" style="width:150px;"/>
                </td>
            </tr>
            <tr>
                <th class="td5 hs" style="width:110px;" align="right"> CHAPTER：</th>
                <td class="tdr hs">
                    <input class="easyui-textbox" id="chapter" name="chapter"
                           data-options="required:true,validType:['maxLength[3]']" style="width:70px;"/>
                </td>
                <th class="td5 hs" style="width:110px;" align="right"> SECTION：</th>
                <td class="tdr hs">
                    <input class="easyui-textbox" id="section" name="section"
                           data-options="validType:['maxLength[3]']" style="width:70px;"/>
                </td>
                <th class="td5 hs" style="width:110px;" align="right"> SUBJECT：</th>
                <td class="tdr hs">
                    <input class="easyui-textbox" id="subject" name="subject"
                           data-options="validType:['maxLength[3]']" style="width:70px;"/>
                </td>
            </tr>
            <tr>
                <th class="td5 hs" style="width:110px;" align="right"> PGBLOCK：</th>
                <td class="tdr hs">
                    <input class="easyui-textbox" id="pgblock" name="pgblock"
                           data-options="validType:['maxLength[3]']" style="width:70px;"/>
                </td>
                <th class="td5 hs" style="width:110px;" align="right"> CONFNBR：</th>
                <td class="tdr hs">
                    <input class="easyui-textbox" id="confnbr" name="confnbr"
                           data-options="validType:['maxLength[10]']" style="width:70px;"/>
                </td>
                <th class="td5 hs" style="width:110px;" align="right"> FUNCTION：</th>
                <td class="tdr hs">
                    <input class="easyui-textbox" id="function" name="function"
                           data-options="validType:['maxLength[3]']" style="width:70px;"/>
                </td>
            </tr>
            <tr>
                <th class="td5 hs" style="width:110px;" align="right"> SEQ：</th>
                <td class="tdr hs">
                    <input class="easyui-textbox" id="seq" name="seq"
                           data-options="validType:['maxLength[3]']" style="width:70px;"/>
                </td>
                <th class="td5 hs" style="width:110px;" align="right"> CONFLTR：</th>
                <td class="tdr hs">
                    <input class="easyui-textbox" id="confltr" name="confltr"
                           data-options="validType:['maxLength[3]']" style="width:70px;"/>
                </td>
                <th class="td5 hs" style="width:110px;" align="right">双重维修：</th>
                <td class="tdr hs">
                    <input class="easyui-combobox" id="dualMaintenance" name="dualMaintenance"
                              style="width:70px;"/>
                </td>
            </tr>
            <tr>
                <th class="td5 hs" style="width:110px;" align="right"> 标题：</th>
                <td class="tdr hs" colspan="5">
                    <input class="easyui-textbox" id="title" name="title"
                           data-options="required:true,multiline:true"
                           style="width:470px;height:200px"/>
                </td>
            </tr>
        </table>
    </form>
</div>
<script type="text/javascript">
    var param;

    function i18nCallBack() {
        param = getParentParam_();

        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "DA_FLEET,DA_SUB_FLEET,DM_DATA_TYPE_AC"
            },
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#fleet').combobox({
                        data: jdata.data.DA_FLEET,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '100px'
                    });
                    $('#subFleet').combobox({
                        data: jdata.data.DA_SUB_FLEET,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '100px'
                    });
                    //手册类型
                    $("#manualType").combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_DATA_TYPE_AC,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (data) {
                            changeFleet(data.VALUE);
                        }
                    });
                }
            }
        });
        //初始化双重维修
        $('#dualMaintenance').combobox({
            valueField: 'key',
            textField: 'value',
            panelHeight: '50px',
            data: [{key: "1", value: "是"}, {key: "0", value: "否"}],
        });
        if (!! param.pkid) {
            InitDataForm(param.pkid);
        }
    }

    //回显数据
    function InitDataForm(pkId) {
        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/online-manual/chapterHostData/selectById/" + pkId,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    ParseFormField_(jdata.obj, $("#mform"));
                    changeFleet(jdata.obj.manualType);
                    $('#subFleet').combobox({value: jdata.obj.subFleet});
                } else {
                    MsgAlert({content: '操作失敗', type: 'error'})
                }
            }
        });
    }
    function changeFleet(dataType){
        if(dataType =="SRM"){
            $("#subFleet").combobox({required: true});
            $('#confnbr').combobox({onlyview: true, editable: false});
            $('#seq').combobox({onlyview: true, editable: false});
            $('#confltr').combobox({onlyview: true, editable: false});
        }else{
            $("#subFleet").combobox({required: false});
            $('#confnbr').combobox({onlyview: false, editable: true});
            $('#seq').combobox({onlyview: false, editable: true});
            $('#confltr').combobox({onlyview: false, editable: true});
        }
    }

    // 保存
    function save() {

        var isValidate = $("#mform").form('validate');
        if (!isValidate) {
            return;
        }
        var title = $('#title').textbox('getValue').toUpperCase();
        $('#title').textbox('setValue', title);
        var $form = $("#mform");
        var datas = $form.serializeObject();
        if (!!datas.pkid) {
            InitGatewayRequest_({
                type: "post",
                async: false,
                data: datas,
                path: "/online-manual/chapterHostData/update",
                successCallBack: function (jdata) {
                    if (jdata.success == true) {
                        param.OWindow.MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        param.OWindow.reload_();
                        CloseWindowIframe();
                    } else {
                        if (jdata.errorMessage.indexOf("UNI_BM_MANUAL_ATA") != -1) {
                            MsgAlert({content: "请检查各章节是否重复.", type: 'error'});
                        } else {
                            MsgAlert({content: jdata.errorMessage ? jdata.errorMessage : jdata.obj, type: 'error'});
                        }
                    }
                }
            });

        } else {

            InitGatewayRequest_({
                type: "post",
                async: false,
                data: datas,
                path: "/online-manual/chapterHostData/insert",
                successCallBack: function (jdata) {
                    if (jdata.success == true) {
                        param.OWindow.MsgAlert({content:$.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        param.OWindow.reload_();
                        CloseWindowIframe();
                    } else {
                        if (jdata.errorMessage.indexOf("UNI_BM_MANUAL_ATA") != -1) {
                            MsgAlert({content: "请检查各章节是否重复.", type: 'error'});
                        } else {
                            MsgAlert({content: jdata.errorMessage ? jdata.errorMessage : jdata.obj, type: 'error'});
                        }
                    }
                }
            });
        }
    }

    function closeAdd() {
        $.messager.confirm('', '是否关闭', function (r) {
            if (r) {
                param.OWindow.reload_();
                CloseWindowIframe();
            }
        });
    }

</script>
</body>
</html>
