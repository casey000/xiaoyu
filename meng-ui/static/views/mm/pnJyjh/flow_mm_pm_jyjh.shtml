<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="ws_work_flow">
  <!--#include virtual="/views/items/resource_.shtml"-->
  <script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
  <script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
  <title>件号禁用激活流程</title>
</head>
<body class="ibody">

<div id="tabs" style="width: 100%; height: 100%;">
  <div id="tab01" title="业务表单数据" style="">
    <div class="ibox float-e-margins">
      <div class="ibox-content">
        <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
          <input type="hidden" id="isFirstNode" name="isFirstNode">
          <input type="hidden" name="jhsprid" id="jhsprid"/>
          <!-- 业务数据展示 start-->
            <div id="p0" class="easyui-panel" title="件号激活/禁用">
              <input type="hidden" id="pkid" name="pkid">
              <table class="table table-bordered table-info">
                <tr>
                  <th class="td5" style="width:120px;" align="right"> 申请编号：</th>
                  <td class="tdr">
                    <input class="easyui-textbox" id="zno" name="zno" data-options="editable:false,onlyview:true"
                           style="width:200px;"/>
                  </td>
                  <th align="right" class="td5" style="width:120px;"> 申请类别：</th>
                  <td class="tdr">
                    <input class="easyui-combobox" id="zzpnzt" name="zzpnzt" data-options="editable:false,onlyview:true"
                           style="width:200px;"/>
                  </td>
                  <th class="td5" style="width:120px;" align="right"> 申请件号：</th>
                  <td class="tdr">
                    <input class="easyui-combogrid" id="matnr" name="matnr" data-options="editable:false,onlyview:true"
                           style="width:200px;"/>
                  </td>
                </tr>
                <tr>
                  <th align="right" class="td5" style="width:120px;"> 件号状态：</th>
                  <td class="tdr">
                    <input class="easyui-combobox" id="zzpnzt2" name="zzpnzt2"
                           data-options="editable:false,onlyview:true"
                           style="width:200px;"/>
                  </td>
                  <th align="right" class="td5" style="width:120px;"> 件号类别：</th>
                  <td class="tdr">
                    <input class="easyui-combobox" id="zzpnlx" name="zzpnlx"
                           data-options="editable:false,onlyview:true"
                           style="width:200px;"/>
                  </td>
                  <th align="right" class="td5" style="width:120px;"> 适用机型：</th>
                  <td class="tdr">
                    <input class="easyui-textbox" id="appcab" name="appcab" data-options="editable:false,onlyview:true"
                           style="width:200px;"/>
                  </td>
                </tr>
                <tr>
                  <th class="td5" style="width: 130px;" align="right">备注：</th>
                  <td class="tdr" colspan="5">
                    <input class="easyui-textbox " name="memo" id="memo"
                           data-options="editable:false,onlyview:true" multiline="true"
                           style="height:50px;width: 500px"/>
                  </td>
                </tr>
              </table>
            </div>
          </form>
          <!-- 业务数据展示end-->

          <h5 style="margin-bottom: 4px;">流程处理：</h5>
          <input name="taskId" type="hidden" />
          <table class="table table-bordered table-info" id="mtable">
            <tr>
              <th class="tdl"> 处理意见：</th>
              <td class="tdr">
                <input id="notes" class="easyui-textbox easyui-validatebox" name="notes"
                       data-options="multiline:true, validType:['maxLength[500]'] "
                       style="height:65px; width: 90%;"/>
              </td>
              <!--<th id="nextTh" class="tdl xmclass" style="width: 100px">下一级办理人：</th>
              <td id="nextTd" class="tdr xmclass">
                <input id="authId" class="easyui-textbox easyui-validatebox"
                       data-options="validType:['maxLength[20]'] " style="height:25px; width:150px;"/>
              </td>-->
            </tr>
            <tr>
              <td colspan="4" align="center">
                <input class="btn btn-primary" type="button" onclick="save();" value="保存"/>
                <input id="canSubmit" class="btn" type="button" onclick="mySubmit();" value="提交"/>
                <input id="canReturn" class="btn" type="button" onclick="doReturn();" value="退回"/>
              </td>
            </tr>
          </table>
        </form>
      </div>
    </div>
  </div>
  <div title="流程信息">
    <table class="table table-bordered table-info" id="processInfo">
      <tr>
        <th class="tdl" style="width: 145px;">流程业务Key ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="businessKey"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="executionName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <tr>
        <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="createTime"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">流程创建人 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="userName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <tr>
        <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="nodeName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="isJoint"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <!--<tr>
        <th class="tdl" style="width: 145px;">流程任务-配置 ：</th>
        <td class="tdr" colspan="3" style="vertical-align: middle;">
          <input type="checkbox" name="canReturn" value="" disabled/> 可退回
          <input type="checkbox" name="canTrunTo" value="" disabled/> 可转办
          <input type="checkbox" name="canTerminate" value="" disabled/> 可终止
          <input type="checkbox" name="canHangUp" value="" disabled/> 可挂起
        </td>
      </tr>-->
    </table>
    <div id="workflow" style="overflow-x: scroll;"></div>
  </div>
  <div id="tab02" title="历史任务信息" style="">
    <table id="historyDg"></table>
  </div>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
/**
 * 初始化流程业务处理页面
 * @param resource  业务数据
 * @param execution 流程实例数据
 * @param node 节点配置数据
 * @constructor
 */
var pageData;
var currNode;
var operation = 'view';
var PAGE_DATA = {};
var COMBOBOX_DATA = {};
var isReturn = false;
var zt1 = "";
var zt2 = "";
function InitLoadResource(resource, execution, node) {
    pageData = resource;
    if(pageData && pageData.pkid){
        $("#pkid").val(pageData.pkid);
    }
    InitFuncCodeRequest_({
        data: {
            FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
            domainCode: "MM_DIC_PART_STATUS,MM_DIC_SAP_STATUS,MM_DIC_SAP_TYPE"
        },
        successCallBack: function (jdata) {
            PAGE_DATA['jyjh'] = DomainCodeToMap_(jdata.data.MM_DIC_PART_STATUS);
            //禁用激活
            $('#zzpnzt').combobox({
                panelHeight: '140px',
                valueField: 'VALUE',
                textField: 'TEXT',
                data: jdata.data.MM_DIC_PART_STATUS,
                onSelect: function (item) {
                    if (item.VALUE == "1") {
                        zt1 = "2";
                        zt2 = "X";
                    } else if (item.VALUE == "2") {
                        zt1 = "1";
                    } else {
                        zt1 = "1";
                        zt2 = "2";
                    }
                    $("#matnr").MyComboGrid({
                        idField: 'MATNR',  //实际选择值
                        textField: 'MATNR', //文本显示值
                        panelHeight: '200px',
                        width: 200,
                        params: {zzpnzt1: zt1, zzpnzt2: zt2, FunctionCode: 'SELECT_PARTNO'},
                        columns: [[
                            {field: 'MATNR', title: '件号', width: 80},
                            {field: 'UDCHNDESC', title: '中文名称', width: 100},
                            {field: 'DESCEN', title: '英文名称', width: 100}
                        ]],
                        onHidePanel: function () {
                            var t = $(this).combogrid('getValue');
                            if (t != null && t != '' & t != undefined) {
                                if (selectRow == null || t != selectRow.MATNR) {//没有选择或者选项不相等时清除内容
                                    alert('请选择，不要直接输入！');
                                    $(this).combogrid({value: ''});
                                }
                            }
                        },
                        onSelect: function (index, row) {
                            selectRow = row;
                            $('#zzpnzt2').combobox("setValue", row.ZZPNZT);
                            $('#zzpnlx').combobox("setValue", row.ZZPNLX);
                            $("#appcab").textbox('setValue', row.APPCAB);
                        }
                    });
                }
            });
            $('#zzpnzt2').combobox({
                panelHeight: '140px',
                valueField: 'VALUE',
                textField: 'TEXT',
                data: jdata.data.MM_DIC_SAP_STATUS
            });

            $('#zzpnlx').combobox({
                panelHeight: '140px',
                valueField: 'VALUE',
                textField: 'TEXT',
                data: jdata.data.MM_DIC_SAP_TYPE
            });
            // 控制退回按钮和退回弹窗
            if('task1566272550699' == node.taskPropId){     //第一个节点
                $("#isFirstNode").val('Y');
            }else if('task1566272552727' == node.taskPropId){   // 任务退回节点只能提交
                $("#canReturn").hide();
                $("#isFirstNode").val('N');
                isReturn = true;
                $("#returnTable").show();
                $("#zzpnzt").combobox({required:true,editable:true,onlyview:false});
                $("#matnr").combogrid({required: true, editable: true, onlyview: false});
                $("#memo").textbox({required: false, editable: true, onlyview: false});
            }else{
                $("#isFirstNode").val('N');
            }

            /*if('task1566272550699' == node.taskPropId){//审批
                $('#authId').combogrid({required:false});
                $('#nextTh').hide();
                $('#nextTd').hide();
            }*/
            InitDataForm(pageData.pkid);
        }
    });
}
//回显数据
function InitDataForm(pkid) {
    InitFuncCodeRequest_({
        data: {pkid: pkid, FunctionCode: "MM_VPN_JYJH_GET"},
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                if (jdata.data.ZZPNZT == "1") {
                    zt1 = "2";
                    zt2 = "X";
                } else if (jdata.data.ZZPNZT == "2") {
                    zt1 = "1";
                } else {
                    zt1 = "1";
                    zt2 = "2";
                }
                $("#matnr").MyComboGrid({
                    idField: 'MATNR',  //实际选择值
                    textField: 'MATNR', //文本显示值
                    panelHeight: '200px',
                    width: 200,
                    params: {zzpnzt1: zt1, zzpnzt2: zt2, FunctionCode: 'SELECT_PARTNO'},
                    columns: [[
                        {field: 'MATNR', title: '件号', width: 80},
                        {field: 'UDCHNDESC', title: '中文名称', width: 100},
                        {field: 'DESCEN', title: '英文名称', width: 100}
                    ]],
                    onHidePanel: function () {
                        var t = $(this).combogrid('getValue');
                        if (t != null && t != '' & t != undefined) {
                            if (selectRow == null || t != selectRow.MATNR) {//没有选择或者选项不相等时清除内容
                                alert('请选择，不要直接输入！');
                                $(this).combogrid({value: ''});
                            }
                        }
                    },
                    onSelect: function (index, row) {
                        selectRow = row;
                        $('#zzpnzt2').combobox("setValue", row.ZZPNZT);
                        $('#zzpnlx').combobox("setValue", row.ZZPNLX);
                        $("#appcab").textbox('setValue', row.APPCAB);
                    }
                });
                ParseFormField_(jdata.data, null, Constant.CAMEL_CASE);
            }
        }
    });
}

function save() {
    var isValidate = $("#mform").form('validate');
    if (!isValidate) {
        return false;
    }
    var data = $("#mform").serializeObject();
    data = $.extend({}, data, {FunctionCode: 'MM_VPN_JYJH_ADD_EDIT'});
    InitFuncCodeRequest_({
        data: data,
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
            } else {
                MsgAlert({content: jdata.msgData ? jdata.msgData[0] : jdata.msg, type: 'error'});
            }
        }
    });
}

function mySubmit() {
    var isValidate = $("#mform").form('validate');
    if (!isValidate) {
        return false;
    }
    var data = $("#mform").serializeObject();
    data = $.extend({}, data, {FunctionCode: 'MM_VPN_JYJH_ADD_EDIT'});
    InitFuncCodeRequest_({
        data: data,
        successCallBack: function (jdata) {
            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                doSubmit();
            } else {
                MsgAlert({content: jdata.msgData ? jdata.msgData[0] : jdata.msg, type: 'error'});
            }
        }
    });
}




</script>
</body>
</html>