<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="ws_work_flow">
  <!--#include virtual="/views/items/resource_.shtml"-->
  <script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
  <script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
  <title>件号申请流程</title>
  <style>
    .combobox-item {
      height: 16px;
    }
  </style>

</head>
<body class="ibody">

<div id="tabs" style="width: 100%; height: 100%;">
  <div id="tab01" title="业务表单数据" style="">
    <div class="ibox float-e-margins">
      <div class="ibox-content">
        <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
          <input type="hidden" id="isFirstNode" name="isFirstNode">
          <input type="hidden" name="jhsprid" id="jhsprid"/>
          <!-- 业务数据展示 start-->
            <div id="p0" class="easyui-panel" title="件号申请">
                <input type="hidden" id="pkid" name="pkid">
                <input type="hidden" id="zzpma1" name="zzpma1">
                <table class="table table-bordered table-info" id="returnTable">
                    <tr>
                        <th class="td5" style="width:120px;" align="right"> 申请编号：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="zno" name="zno"
                                   data-options="editable:false,onlyview:true"
                                   style="width:200px;"/>
                        </td>
                        <th class="td5" style="width:120px;" align="right"> 申请件号：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="matnr" name="matnr"
                                   data-options="editable:false,onlyview:true"
                                   style="width:200px;"/>
                        </td>
                        <th class="td5" style="width:120px;" align="right"> 件号来源：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="zzpnly" name="zzpnly"
                                   data-options="required:true,editable:false"
                                   style="width:200px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="td5" style="width:120px;" align="right"> 件号中文名：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="nameZh" name="nameZh"
                                   data-options="required:true,validType:['maxLength[120]']"
                                   style="width:200px;"/>
                        </td>
                        <th class="td5" style="width:120px;" align="right"> 件号英文名：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="nameEn" name="nameEn"
                                   data-options="required:true,validType:['maxLength[120]']"
                                   style="width:200px;"/>
                        </td>
                        <th class="td5" style="width:120px;" align="right"> 来源机型：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="stort" name="stort"
                                   data-options="required:true,editable:false"
                                   style="width:200px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="td5" style="width:120px;" align="right"> 章节号：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-combobox" id="zzata1" name="zzata1" data-options="editable:false"
                                   style="width:150px;"/>-
                            <input class="easyui-textbox" id="zzata2" name="zzata2" data-options=""
                                   style="width:60px;"/>-
                            <input class="easyui-textbox" id="zzata3" name="zzata3" data-options=""
                                   style="width:60px;"/>-
                            <input class="easyui-textbox" id="zzata4" name="zzata4" data-options=""
                                   style="width:60px;"/>
                            <a class="clearBtn" id="clearAtaId" href="javascript:void(0)" onclick="clearAta();"
                               data-options="iconCls:'icon-clear'">
                                <span data-i18n="清空章节">清空章节</span></a>
                        </td>
                        <th class="td5" style="width:120px;" align="right"> 是否PMA件：</th>
                        <td class="tdr">
                            &nbsp;&nbsp;<input type="checkbox" name="zzpma" value="Y"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="tdl" style="width: 100px;">当前附件：</th>
                        <td colspan="5">
                            <div id="attachesUl"></div>
                        </td>
                    </tr>
                </table>
                <table class="table table-bordered table-info" id="spTable">
                    <tr>
                        <th class="td5" style="width:120px;" align="right"> 件号类型：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="zzpnlx" name="zzpnlx"
                                   data-options="required:true,editable:false"
                                   style="width:200px;"/>
                        </td>
                        <th class="td5" style="width:120px;" align="right"> 件号分类：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="matkl" name="matkl"
                                   data-options="required:true,editable:false"
                                   style="width:200px;"/>
                        </td>
                        <th class="td5" style="width:120px;" align="right"> OEM件号：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="zzoem" name="zzoem"
                                   data-options="required:true,validType:['maxLength[40]']"
                                   style="width:200px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="td5" style="width:120px;" align="right"> 库存基本单位：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="meins" name="meins"
                                   data-options="required:false,editable:false"
                                   style="width:200px;"/>
                        </td>
                        <th class="td5" style="width:120px;" align="right"> 是否工程可修：</th>
                        <td class="tdr">
                            是&nbsp;&nbsp;<input type="radio" name="zzgckx" value="Y"/>
                            &nbsp;&nbsp;&nbsp;&nbsp;否&nbsp;&nbsp;<input type="radio" name="zzgckx" value="N"/>
                        </td>
                        <th class="td5" style="width:120px;" align="right"> 是否航材可修：</th>
                        <td class="tdr">
                            是&nbsp;&nbsp;<input type="radio" name="zzhckx" value="Y" disabled/>
                            &nbsp;&nbsp;&nbsp;&nbsp;否&nbsp;&nbsp;<input type="radio" name="zzhckx" value="N" disabled/>
                        </td>
                    </tr>
                    <tr>
                        <th class="td5" style="width:120px;" align="right"> 适用机型：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="stortApp" name="stortApp"
                                   data-options="required:false,editable:false,validType:['maxLength[1000]']"
                                   style="width:200px;"/>
                        </td>
                        <th class="td5" style="width:120px;" align="right"> 规范号：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="zzgfh" name="zzgfh"
                                   data-options="required:false,validType:['maxLength[1000]'],events:{blur:checkSpecNo}" style="width:200px;"/>
                        </td>
                        <th class="td5" style="width:120px;" align="right"> 是否序号管控：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="zxhj" name="zxhj"
                                   data-options="required:true,editable:false"
                                   style="width:200px;"/>
                        </td>
                    </tr>
                    <!--<tr>
                      <th class="td5" style="width:120px;" align="right"> 适用飞机号：</th>
                      <td class="tdr" colspan="5">
                        <input class="easyui-combobox" id="msgrpApp" name="msgrpApp"
                               data-options="required:false,editable:false"
                               style="width:500px;"/>
                      </td>
                    </tr>-->
                </table>
                <table class="table table-bordered table-info">
                    <tr>
                        <th class="td5" style="width: 120px;" align="right">备注：</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox" name="memo" id="memo"
                                   data-options="validType:['maxLength[1000]']" multiline="true"
                                   style="height:100px; width:500px;"/>
                        </td>
                    </tr>
                </table>
            </div>
        </form>
          <!-- 业务数据展示end-->

          <h5 style="margin-bottom: 4px;">流程处理：</h5>
          <input name="taskId" type="hidden"/>
          <table class="table table-bordered table-info" id="mtable">
              <tr>
                  <th class="tdl"> 处理意见：</th>
                  <td class="tdr">
                      <input id="notes" class="easyui-textbox easyui-validatebox" name="notes"
                             data-options="multiline:true, validType:['maxLength[500]'] "
                             style="height:65px; width: 90%;"/>
                  </td>
                  <!--<th id="nextTh" class="tdl xmclass" style="width: 100px">下一级办理人：</th>
                  <td id="nextTd" class="tdr xmclass">
                    <input id="authId" class="easyui-textbox easyui-validatebox"
                           data-options="validType:['maxLength[20]'] " style="height:25px; width:150px;"/>
                  </td>-->
              </tr>
              <tr>
                  <td colspan="4" align="center">
                      <input class="btn btn-primary" type="button" onclick="save();" value="保存"/>
                      <input id="canSubmit" class="btn" type="button" onclick="mySubmit();" value="提交"/>
                      <input class="btn btn-primary" type="button" onclick="turnTo();" value="转办"/>
                      <input id="canReturn" class="btn" type="button" onclick="doReturn();" value="退回"/>
                  </td>
              </tr>
          </table>
        </form>
      </div>
    </div>
  </div>
  <div title="流程信息">
    <table class="table table-bordered table-info" id="processInfo">
      <tr>
        <th class="tdl" style="width: 145px;">流程业务Key ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="businessKey"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="executionName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <tr>
        <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="createTime"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">流程创建人 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="userName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <tr>
        <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="nodeName"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
        <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
        <td class="tdr">
          <input class="easyui-textbox easyui-validatebox" name="isJoint"
                 data-options="multiline:true, onlyview: true " style="height:25px; width: 90%;"/>
        </td>
      </tr>
      <!--<tr>
        <th class="tdl" style="width: 145px;">流程任务-配置 ：</th>
        <td class="tdr" colspan="3" style="vertical-align: middle;">
          <input type="checkbox" name="canReturn" value="" disabled/> 可退回
          <input type="checkbox" name="canTrunTo" value="" disabled/> 可转办
          <input type="checkbox" name="canTerminate" value="" disabled/> 可终止
          <input type="checkbox" name="canHangUp" value="" disabled/> 可挂起
        </td>
      </tr>-->
    </table>
    <div id="workflow" style="overflow-x: scroll;"></div>
  </div>
  <div id="tab02" title="历史任务信息" style="">
    <table id="historyDg"></table>
  </div>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    /**
     * 初始化流程业务处理页面
     * @param resource  业务数据
     * @param execution 流程实例数据
     * @param node 节点配置数据
     * @constructor
     */
    var pageData;
    var currNode;
    var operation = 'view';
    var PAGE_DATA = {};
    var COMBOBOX_DATA = {};
    var isReturn = false;
    var isKfsp = false;
    var isSave = false;
    var executionId;
    var accountId = getLoginInfo().accountId;
    var param = getParentParam_();
    function InitLoadResource(resource, execution, node) {
        pageData = resource;
        executionId = execution.executionId;
        if (pageData && pageData.pkid) {
            $("#pkid").val(pageData.pkid);
        }
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE",
                domainCode: "DA_ACREG_MP_ACTYPE,MSGRP,MM_DIC_PART_SOURCE,MM_VPN_KCDW,ATA_2_SORT,MM_DIC_PART_TYPE,MM_DIC_PART_TYPE_C,MM_DIC_PART_TYPE_C1,MM_DIC_PART_TYPE_C2,MM_DIC_PART_TYPE_C3,MM_VPN_ZXHJ"
            },
            successCallBack: function (jdata) {
                COMBOBOX_DATA['type1'] = jdata.data.MM_DIC_PART_TYPE_C1;
                COMBOBOX_DATA['type2'] = jdata.data.MM_DIC_PART_TYPE_C2;
                COMBOBOX_DATA['type3'] = jdata.data.MM_DIC_PART_TYPE_C3;
                COMBOBOX_DATA['actypes'] = jdata.data.DA_ACREG_MP_ACTYPE;
                //来源机型
                $('#stort').combobox({
                    panelHeight: '140px',
                    multiple: true, //是否可多选
                    valueField: 'VALUE',
                    textField: 'VALUE',
                    data: jdata.data.DA_ACREG_MP_ACTYPE
                });
                //库存基本单位
                $('#meins').combobox({
                    panelHeight: '140px',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data.MM_VPN_KCDW
                });
                //是否序号管控
                $('#zxhj').combobox({
                    panelHeight: '140px',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data.MM_VPN_ZXHJ
                });
                //件号来源
                $('#zzpnly').combobox({
                    panelHeight: '140px',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data.MM_DIC_PART_SOURCE,
                    onSelect: function (item) {
                        //如果选择OTHERS，则需维护备注
                        if (item.VALUE == 17) {
                            $("#memo").textbox({required: true});
                        } else {
                            $("#memo").textbox({required: false});
                        }
                        //如果选择IPC，则需维护章节号
                        var ata1 = $("#zzata1").combobox('getValue');
                        if (item.VALUE == 01) {
                            $("#zzata1").combobox({value: ata1, required: true});
                            $("#zzata2").textbox({required: true});
                            $("#zzata3").textbox({required: true});
                            $("#zzata4").textbox({required: true});
                        } else if (item.VALUE == 15 || item.VALUE == 16) {
                            //件号来源为化工品或标准件时，章节号不必填
                            $("#zzata1").combobox({value: ata1, required: false});
                            $("#zzata2").textbox({required: false});
                            $("#zzata3").textbox({required: false});
                            $("#zzata4").textbox({required: false});
                        } else {
                            //件号来源不为以上三种时，章节号必填一段
                            $("#zzata1").combobox({value: ata1, required: true});
                            $("#zzata2").textbox({required: false});
                            $("#zzata3").textbox({required: false});
                            $("#zzata4").textbox({required: false});
                        }
                        checkAta();
                    }
                });
                checkPn();
                checkAta();
                $('#zzata1').combobox({
                    panelHeight: '140px',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data.ATA_2_SORT,
//                    loadFilter: function (data) {
//                        data.shift({VALUE: '', TEXT: ''});
//                        data.unshift({VALUE: '', TEXT: ''});
//                        return data;
//                    }
                });
                //件号类型
                $('#zzpnlx').combobox({
                    panelHeight: '140px',
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data.MM_DIC_PART_TYPE,
                    onSelect: function (item) {
                        //库存单位
                        var kcdw = $("#meins").combobox('getValue');
                        $('#matkl').combobox('setValue', '');
                        //周转件
                        if (item.VALUE == 1) {
                            //件号类型选择周转件时，是否工程可修默认为“可修”
                            $("input[name='zzgckx'][value='Y']").prop('checked', true);
                            $("input[name='zzhckx'][value='Y']").prop('checked', true);
                            $('#stortApp').combobox({required: false});
                            $('#matkl').combobox({
                                panelHeight: '140px',
                                valueField: 'VALUE',
                                textField: 'TEXT',
                                data: jdata.data.MM_DIC_PART_TYPE_C1
                            });
                            $("#meins").combobox({value: kcdw, required: false, onlyview: true});
                            $('#meins').combobox('setValue', 'EA');

                            $("#zxhj").combobox({value: "Y", editable: false, onlyview: true});
                            $('#zxhj').combobox('setValue', 'Y');

                        }
                        //控修件
                        if (item.VALUE == 2) {
                            $("input[name='zzgckx'][value='Y']").prop('checked', true);
                            $("input[name='zzhckx'][value='Y']").prop('checked', true);
                            $('#stortApp').combobox({required: true});
                            $('#matkl').combobox({
                                panelHeight: '140px',
                                valueField: 'VALUE',
                                textField: 'TEXT',
                                data: jdata.data.MM_DIC_PART_TYPE_C2
                            });
                            $("#meins").combobox({value: kcdw, required: false, onlyview: true});
                            $('#meins').combobox('setValue', 'EA');

                            $("#zxhj").combobox({value: "Y", editable: false, onlyview: true});
                            $('#zxhj').combobox('setValue', 'Y');
                        }
                        //消耗件
                        if (item.VALUE == 3) {
                            //件号类型选择消耗件时，是否工程可修默认为“不可修”
                            $("input[name='zzgckx'][value='N']").prop('checked', true);
                            $("input[name='zzgckx'][value='N']").prop('disabled', true);
                            $("input[name='zzgckx'][value='Y']").prop('disabled', true);
                            $("input[name='zzhckx'][value='N']").prop('checked', true);
                            $('#stortApp').combobox({required: true});
                            $('#matkl').combobox({
                                panelHeight: '140px',
                                valueField: 'VALUE',
                                textField: 'TEXT',
                                data: jdata.data.MM_DIC_PART_TYPE_C3,
                                onSelect: function (matk) {
                                    var zzpnlx = $('#zzpnlx').combo('getValue');
                                    if(zzpnlx == '3'){
                                        //如果分类是化工品117或标准件113，默认所有机型
                                        if (matk.VALUE == 117 || matk.VALUE == 113) {
                                            var actypes = jdata.data.DA_ACREG_MP_ACTYPE;
                                            var actypeArray = [];
                                            $.each(actypes, function (index, matk) {
                                                var val = matk.VALUE;
                                                if (val != "customer model") {
                                                    actypeArray.push(val);
                                                }
                                            });
                                            $('#stortApp').combobox({value: actypeArray});
                                        }
                                        //如果航材分类是化工品，则必须维护该字段；航材分类不是化工品，则这个字段不是必输项
                                        if (matk.VALUE == 117) {
                                            $("#zzgfh").textbox({required: true});
                                        } else {
                                            $("#zzgfh").textbox({required: false});
                                        }
                                        //“机轮刹车（轮胎 胎皮）、改装包”时,
                                        if (matk.VALUE == 116 || matk.VALUE == 121) {
                                            $("#zxhj").combobox({value: "Y", editable: false, onlyview: true});
                                            $('#zxhj').combobox('setValue', 'Y');
                                        } else {
                                            $("#zxhj").combobox({value: "N", editable: true, onlyview: false});
                                            $('#zxhj').combobox('setValue', 'N');
                                        }
                                    }
                                }
                            });
                            $("#meins").combobox({value: kcdw, required: true, onlyview: false});
                            $('#meins').combobox('setValue', kcdw);
                        }else{
                            $("input[name='zzgckx'][value='N']").prop('disabled', false);
                            $("input[name='zzgckx'][value='Y']").prop('disabled', false);
                        }
                    }
                });
                //是否航材可修随是否工程可修联动一致
                $("input[name='zzgckx']").change(function () {
                    var checked = $("input[name='zzgckx'][value='Y']").is(':checked');
                    if (checked) {
                        $("input[name='zzhckx'][value='Y']").prop('checked', true);
                    } else {
                        $("input[name='zzhckx'][value='N']").prop('checked', true);
                    }
                });
                //适用机型
                $('#stortApp').combobox({
                    panelHeight: '140px',
                    multiple: true, //是否可多选
                    valueField: 'VALUE',
                    textField: 'TEXT',
                    data: jdata.data.DA_ACREG_MP_ACTYPE
                });
                //适用机号
                /*$('#msgrpApp').combobox({
                 panelHeight: '140px',
                 multiple: true, //是否可多选
                 valueField: 'VALUE',
                 textField: 'TEXT',
                 data: jdata.data.MSGRP
                 });*/
                // 控制退回按钮和退回弹窗
                if ('task1566204230112' == node.taskPropId) {     //工程审批
                    $("#isFirstNode").val('Y');
                } else if ('task1566204232814' == node.taskPropId) {   // 任务退回节点只能提交
                    $("#canReturn").hide();
                    //$('#authId').combogrid({required:false});
                    //$('#nextTh').hide();
                    //$('#nextTd').hide();
                    $("#isFirstNode").val('N');
                    isReturn = true;
                    $("#zzpnlx").combobox({required: false});
                    $("#matkl").combobox({required: false});
                    $("#zzoem").textbox({required: false});
                    $("#stortApp").combobox({required: false});
                    $("#zxhj").combobox({required: false});
                    $("#spTable").hide();
                } else {
                    $("#isFirstNode").val('N');
                }

                if ('task1567654886073' == node.taskPropId) {//质量审批
                    //质量审批时其他信息只读
                    isKfsp = true;
                    $("#returnTable input").prop('disabled', true);
                    $("#spTable input").prop('disabled', true);
                }
                InitDataForm(pageData.pkid);

                showUploadedFiles(pageData.pkid, "MMPNAPPLY", $("#attachesUl"));
            }
        });
    }
    function checkPn() {
        $("input", $("#zzoem").next("span")).blur(function () {
            var pn = ($("#zzoem").textbox('getValue')).toUpperCase();
            $("#zzoem").textbox('setValue', pn);
            var pat = /^[A-Z0-9.\s#()/\\,&-]+$/;
            //错误1：不能以特殊字符开头
            var patE1 = /^[.\s#()/\\,&-]/;
            //错误2：不能以空格结尾
            var patE2 = /[\s]$/;
            //错误3：特殊字符不能连续
            var patE3 = /[.\s#()/\\,&-]{2,}/;
            var errorMsg = "件号输入规范：</br>";
            errorMsg += "1.   支持的字符包括：</br>①大写英文字母(半角) A-Z；②阿拉伯数字(半角) 0-9；③英文小数点(半角) .；④英文井号(半角)#；";
            errorMsg += "⑤英文圆括号(半角) (  )；⑥英文正斜杠(半角) /；⑦英文反斜杠(半角) \；⑧英文逗号(半角) ,；⑨英文和符号(半角)&；⑩英文中横线(半角)-⑪英文空格（半角）；</br>";
            errorMsg += "2.   除了以上11类符号外，中文、*、？、%等其它的符号一律不允许；</br>";
            errorMsg += "3.   -.,()/\#&等特殊字符只能出现在字母或数字之间，不能出现在件号开头，也不能连续，例如：23-%5678（特殊字符连续）和.56（特殊字符出现在开头）都是不符规范的件号。</br>";
            errorMsg += "4.   只有化工品件号允许空格，但空格不能在开头和结尾，且不能连续多个空格；";

            if (pn.match(patE1)) {
                $("#zzoem").textbox('setValue', '');
                MsgAlert({content: errorMsg, type: 'warn'});

            } else if (pn.match(patE2)) {
                $("#zzoem").textbox('setValue', '');
                MsgAlert({content: errorMsg, type: 'warn'});

            } else if (pn.match(patE3)) {
                $("#zzoem").textbox('setValue', '');
                MsgAlert({content: errorMsg, type: 'warn'});

            } else {
                if (pn != "" && !pn.match(pat)) {
                    $("#zzoem").textbox('setValue', '');
                    MsgAlert({content: errorMsg, type: 'warn'});
                }
            }
        });
    }
    function clearAta() {
        $("#zzata1").combobox('setValue', '');
        $("#zzata2").textbox('setValue', '');
        $("#zzata3").textbox('setValue', '');
        $("#zzata4").textbox('setValue', '');
    }
    function checkAta() {
        $("input", $("#zzata2").next("span")).blur(function () {
            var ata = $("#zzata2").textbox('getValue');
            var pat = /^\d{2}$/;
            if (ata != "" && !ata.match(pat)) {
                $("#zzata2").textbox('setValue', '');
                MsgAlert({content: '章节为两位数字', type: 'warn'});
            }
        });
        $("input", $("#zzata3").next("span")).blur(function () {
            var ata = $("#zzata3").textbox('getValue');
            var pat = /^\d{2}$/;
            if (ata != "" && !ata.match(pat)) {
                $("#zzata3").textbox('setValue', '');
                MsgAlert({content: '章节为两位数字', type: 'warn'});
            }
        });
        $("input", $("#zzata4").next("span")).blur(function () {
            var ata = $("#zzata4").textbox('getValue');
            var pat = /^\d{2}$/;
            if (ata != "" && !ata.match(pat)) {
                $("#zzata4").textbox('setValue', '');
                MsgAlert({content: '章节为两位数字', type: 'warn'});
            }
        });
    }
    //回显数据
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "MM_VPN_APPLY_GET"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //件号分类
                    if (jdata.data.ZZPNLX == 1) {
                        $('#matkl').combobox({
                            panelHeight: '140px',
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            data: COMBOBOX_DATA['type1']
                        });
                        $("#zxhj").combobox({value: "Y", editable: false, onlyview: true});
                        $('#zxhj').combobox('setValue', 'Y');
                        $("#meins").combobox({required: false, onlyview: true});
                    }
                    if (jdata.data.ZZPNLX == 2) {
                        $('#matkl').combobox({
                            panelHeight: '140px',
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            data: COMBOBOX_DATA['type2']
                        });
                        $("#zxhj").combobox({value: "Y", editable: false, onlyview: true});
                        $('#zxhj').combobox('setValue', 'Y');
                        $("#meins").combobox({required: false, onlyview: true});
                    }
                    if (jdata.data.ZZPNLX == 3) {
                        $('#matkl').combobox({
                            panelHeight: '140px',
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            data: COMBOBOX_DATA['type3'],
                            onSelect: function (item) {
                                //如果分类是化工品117或标准件113，默认所有机型
                                if (item.VALUE == 117 || item.VALUE == 113) {
                                    var actypes = COMBOBOX_DATA['actypes'];
                                    var actypeArray = [];
                                    $.each(actypes, function (index, item) {
                                        var val = item.VALUE;
                                        if (val != "customer model") {
                                            actypeArray.push(val);
                                        }
                                    });
                                    $('#stortApp').combobox({value: actypeArray});
                                }
                                if (item.VALUE == 117) {
                                    $("#zzgfh").textbox({required: true});
                                } else {
                                    $("#zzgfh").textbox({required: false});
                                }
                            }
                        });
                        $("#zxhj").combobox({editable: true, onlyview: false});
                    }
                    ParseFormField_(jdata.data, null, Constant.CAMEL_CASE);
                    //if("Y" == jdata.data.ZZDKCG){
                    //    $("#zzdkcg").prop('checked',true);
                    //}
                    if (jdata.data.STORT) {
                        $('#stort').combobox({value: jdata.data.STORT.split(',')});
                    }
                    if (jdata.data.STORT_APP) {
                        $('#stortApp').combobox({value: jdata.data.STORT_APP.split(',')});
                    }
                    /*if(jdata.data.MSGRP_APP){
                     $('#msgrpApp').combobox({value: jdata.data.MSGRP_APP.split(',')});
                     }*/
                    if (jdata.data.ZZGCKX == 'Y') {
                        $("input[name='zzgckx'][value='Y']").prop('checked', true);
                    } else if (jdata.data.ZZGCKX == 'N') {
                        $("input[name='zzgckx'][value='N']").prop('checked', true);
                    }
                    if (jdata.data.ZZHCKX == 'Y') {
                        $("input[name='zzhckx'][value='Y']").prop('checked', true);
                    } else if (jdata.data.ZZHCKX == 'N') {
                        $("input[name='zzhckx'][value='N']").prop('checked', true);
                    }
                    if (jdata.data.ZZPMA == 'Y') {
                        $("input[name='zzpma']").prop('checked', true);
                        $("#zzpma1").val("Y");
                    } else {
                        $("input[name='zzpma']").prop('checked', false);
                        $("#zzpma1").val("N");
                    }
                    if (jdata.data.ZZPNLY == 01) {
                        $("#zzata1").combobox({value: jdata.data.ZZATA1, required: true});
                        $("#zzata2").textbox({required: true});
                        $("#zzata3").textbox({required: true});
                        $("#zzata4").textbox({required: true});
                        checkAta();
                    }
                    if (jdata.data.MATKL != 113 && jdata.data.MATKL != 117 && !isReturn) {
                        $("#zzata1").combobox({value: jdata.data.ZZATA1, required: true});
                        checkAta();
                    }
                    if (isKfsp) {
                        $("#returnTable input").prop('disabled', true);
                        $("#spTable input").prop('disabled', true);

                        $("#clearAtaId").hide();

                        $("#zzpnly").combobox({
                            value: jdata.data.ZZPNLY,
                            required: false,
                            onlyview: true,
                            editable: false
                        });
                        $("#zzata1").combobox({
                            value: jdata.data.ZZATA1,
                            required: false,
                            onlyview: true,
                            editable: false
                        });
                        $("#stort").combobox({
                            value: jdata.data.STORT,
                            required: false,
                            onlyview: true,
                            editable: false
                        });
                        $("#zzpnlx").combobox({
                            value: jdata.data.ZZPNLX,
                            required: false,
                            onlyview: true,
                            editable: false
                        });
                        $("#stortApp").combobox({
                            value: jdata.data.STORT_APP,
                            required: false,
                            onlyview: true,
                            editable: false
                        });
                        //$("#msgrpApp").combobox({value: jdata.data.MSGRP_APP,required: false,onlyview:true,editable:false});
                        $('#matkl').combobox({
                            value: jdata.data.MATKL,
                            required: false,
                            onlyview: true,
                            editable: false
                        });
                        $('#meins').combobox({
                            value: jdata.data.MEINS,
                            required: false,
//                            onlyview: true,
                            editable: false
                        });
                        $("input[name='zzpma']").prop('disabled', false);
                        $('#memo').textbox({value: jdata.data.MEMO, required: false, onlyview: true, editable: false});
                    }
                }
            }
        });
    }
    function showUploadedFiles(sourceId, category, ulNode) {
        if (sourceId) {
            InitFuncCodeRequest_({
                data: {
                    SOURCE_ID: sourceId,
                    CATEGORY: category,
                    FunctionCode: 'ATTACHMENT_RSPL_GET'
                },
                successCallBack: function (jdata) {
                    if (jdata.code == 200 && jdata.data.length > 0) {
                        //var ulNode = $("#attachesUl");
                        ulNode.find("div").remove();
                        for (var i = 0; i < jdata.data.length; i++) {
                            var imgSrc = "/img/";
                            var fileName = jdata.data[i].ORG_NAME;
                            var fileType = fileName.substr(fileName.lastIndexOf(".") + 1);
                            if (!fileType)
                                continue;

                            fileType = fileType.toLowerCase();
                            if (fileType == 'pdf') {
                                imgSrc += 'icon_pdf.gif';
                            } else if (fileType == 'doc' || fileType == 'docx') {
                                imgSrc += 'icon_word.png';
                            } else if (fileType == 'xls' || fileType == 'xlsx') {
                                imgSrc += 'icon_excel.png';
                            } else if (fileType == 'zip' || fileType == 'rar') {
                                imgSrc += 'icon_zip.png';
                            } else {
                                imgSrc += 'icon_other.png';
                            }

                            var attachFile = '<div style="float:left;margin-left:10px;">' +
                                '<a target="_blank" onclick="downFile(\'' + jdata.data[i].PKID + '\')">' +
                                '<img src="' + imgSrc + '" border="0" style="width:25px;height:25px;"/>' +
                                '<div>' + jdata.data[i].ORG_NAME + '</div></a>';
                            if (isReturn) {
                                attachFile = attachFile + '<a aIndex=\'i' + jdata.data[i].PKID + '\' target="_blank" onclick="deleteFileBefore(\'' + jdata.data[i].PKID + '\');return false;">' +
                                    '<img src="/css/icons/cross.png" border="0" /></a>';
                            }
                            attachFile = attachFile + '</div>';

                            ulNode.append(attachFile);
                        }
                    }
                }
            });
        }
    }
    //保存
    function save() {
        if (isReturn) {
            var isValidate = $("#returnTable").form('validate');
            if (!isValidate) {
                return false;
            }
        } else {
            var isValidate = $("#mform").form('validate');
            if (!isValidate) {
                return false;
            }
            //件号校验：只有化工品件号允许空格
            var ml = $('#matkl').combobox('getValue');
            var mr = $('#matnr').textbox('getValue');

            if (ml != 117 && mr.indexOf(" ") > -1) {
                MsgAlert({content: '除化工品，件号不能有空格', type: 'error'});
                return false;
            }
        }
        var zzgckx = $("input[name='zzgckx']").is(':checked');
        if (!zzgckx && !isReturn) {
            MsgAlert({content: '是否工程可修必填', type: 'error'});
            return;
        }
        var zzhckx = $("input[name='zzhckx']").is(':checked');
        if (!zzhckx && !isReturn) {
            MsgAlert({content: '是否航材可修必填', type: 'error'});
            return;
        }

        var data = $("#mform").serializeObject();
        var stortApp = $("#stortApp").combobox("getValues");
        var stort = $("#stort").combobox("getValues");
        //var msgrpApp = $("#msgrpApp").combobox("getValues");
        data['stortApp'] = stortApp.join(",");
        data['stort'] = stort.join(",");
        //data['msgrpApp'] = msgrpApp.join(",");
        data['zzgckx'] = $("input[name='zzgckx']:checked").val();
        data['zzhckx'] = $("input[name='zzhckx']:checked").val();
        var zzpma = $("input[name='zzpma']").is(':checked');
        if (zzpma) {
            data['zzpma'] = "Y";
            $("#zzpma1").val("Y");
        } else {
            data['zzpma'] = "N";
            $("#zzpma1").val("N");
        }

        //var zzdkcg = $("#zzdkcg").val();
        //data['zzdkcg'] = zzdkcg;
        data = $.extend({}, data, {FunctionCode: 'MM_VPN_APPLY_ADD_EDIT'});
        InitFuncCodeRequest_({
            data: data,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    isSave = true;
                } else {
                    MsgAlert({content: jdata.msgData ? jdata.msgData[0] : jdata.msg, type: 'error'});
                }
            }
        });
    }
    //提交
    function mySubmit() {
        if (isReturn) {
            var isValidate = $("#returnTable").form('validate');
            if (!isValidate) {
                return false;
            }
        } else {
            var isValidate = $("#mform").form('validate');
            if (!isValidate) {
                return false;
            }
            //件号校验：只有化工品件号允许空格
            var ml = $('#matkl').combobox('getValue');
            var mr = $('#matnr').textbox('getValue');

            if (ml != 117 && mr.indexOf(" ") > -1) {
                MsgAlert({content: '除化工品，件号不能有空格', type: 'error'});
                return false;
            }
        }
        var zzgckx = $("input[name='zzgckx']").is(':checked');
        if (!zzgckx && !isReturn) {
            MsgAlert({content: '是否工程可修必填', type: 'error'});
            return;
        }
        var zzhckx = $("input[name='zzhckx']").is(':checked');
        if (!zzhckx && !isReturn) {
            MsgAlert({content: '是否航材可修必填', type: 'error'});
            return;
        }
        /*var authId = $("#authId").textbox('getValue');
         if(!authId && isReturn){
         MsgAlert({content:'请选择审批人',type:'error'});
         return;
         }*/
        $("#zzpma1").val($("input[name='zzpma']:checked").val());
        var data = $("#mform").serializeObject();
        var stortApp = $("#stortApp").combobox("getValues");
        //var msgrpApp = $("#msgrpApp").combobox("getValues");
        data['stortApp'] = stortApp.join(",");
        //data['msgrpApp'] = msgrpApp.join(",");
        data['zzgckx'] = $("input[name='zzgckx']:checked").val();
        data['zzhckx'] = $("input[name='zzhckx']:checked").val();
        var zzpma = $("input[name='zzpma']").is(':checked');
        if (zzpma) {
            data['zzpma'] = "Y";
            $("#zzpma1").val("Y");
        } else {
            data['zzpma'] = "N";
            $("#zzpma1").val("N");
        }

        //var zzdkcg = $("#zzdkcg").val();
        //data['zzdkcg'] = zzdkcg;
        data = $.extend({}, data, {FunctionCode: 'MM_VPN_APPLY_ADD_EDIT'});
        InitFuncCodeRequest_({
            data: data,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    doSubmit();
                } else {
                    MsgAlert({content: jdata.msgData ? jdata.msgData[0] : jdata.msg, type: 'error'});
                }
            }
        });
    }

    //转办
    function turnTo() {
        common_add_edit_({
            url: "/views/flow/work_flow_turn_to_account_select.shtml",
            param: {
                taskId: param.TASK_ID,
                taskName: param.TASK_NAME,
                successCallback: function (data) {
                    param.OWindow.reload_();
                    CloseWindowIframe();
                }
            },
            title: $.i18n.t("选择代办人"),
            width: 520,
            height: 300
        });
    }


    function checkSpecNo() {
        var zgfh = $(this).val();
        var msg = '';
        var newGfh = '';
        var arr1 = [];
        var arr2 = [];
        var resData = '';
        if(zgfh){
            arr1 = zgfh.split(',');
            InitFuncCodeRequest_({
//        data: {zgfh: zgfh, FunctionCode: 'MM_VPN_APPLY_CHECK_SPEC'},//RFC
                data: {zgfh: zgfh, FunctionCode: 'MM_VPN_APPLY_CHECK_SPEC1'},//PI JSON形式
                async: false,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        if (jdata.data != null) {
                            msg = jdata.msg;
                            resData = jdata.data;
                        }
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
            if(msg.indexOf("校验结果") != -1){
                arr2 = resData.split(',');
                MsgAlert({content: msg, type: 'error'});
                newGfh = arr1.filter(function (val) { return arr2.indexOf(val) === -1 })
                $("#zzgfh").textbox('setValue',newGfh);
            }
        }
    }

</script>
</body>
</html>