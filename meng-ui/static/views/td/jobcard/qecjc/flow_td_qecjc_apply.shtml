<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="ws_work_flow">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
    <script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
    <script src="/js/datagrid_utils.js" type="text/javascript"></script>
    <title></title>


</head>
<body class="ibody">

<div id="tabs" style="width: 100%; height: 100%;">
    <div id="tab01" title="业务表单数据" style="">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
                    <input type="hidden" id="reviewedBy" name="reviewedBy">
                    <input type="hidden" id="approvedBy" name="approvedBy">
                    <input type="hidden" id="publicBy" name="publicBy">
                    <input type="hidden" id="pkid" name="pkid"/>
                    <!--zhangxun-->
                    <input type="hidden" id="isFirstNode" name="isFirstNode">
                    <!--zhangxun-->

                    <!-- 业务数据展示 start-->
                    <h5 style="margin-bottom: 4px;">任务数据详情：</h5>
                    <table class="table table-bordered table-info">
                        <caption style="padding-bottom: 7px;font-weight:bold;">QEC工卡</caption>
                    </table>

                    <table class="table table-bordered table-info">
                        <!--<tr>-->
                        <!--<td colspan="9" align="right"   >-->
                        <!--<input class="btn btn-primary" type="button" id="saveBtn" onclick="save()" value="保存"/>-->
                        <!--<input class="btn btn-primary" type="button" id="editBtn" onclick="editProcedure()"-->
                        <!--value="编辑工序"-->
                        <!--style="margin-left:3px;"/>-->
                        <!--<input class="btn btn-primary" type="button" id="viewBtn" onclick="previewPDF()"-->
                        <!--value="PDF预览"-->
                        <!--style="margin-left:3px;"/>-->
                        <!--<input class="btn btn-primary" type="button" id="submitBtn" onclick="submitWorkflow()"-->
                        <!--value="提交"-->
                        <!--style="margin-left:3px;"/>-->
                        <!--<input class="btn btn-primary" type="button" onclick="closeW();" value="关闭"-->
                        <!--style="margin-left:3px;margin-right: 18px;"/>-->
                        <!--<br/>-->
                        <!--</td>-->
                        <!--</tr>-->
                        <tr>
                            <th class="th" align="right" style="width: 80px;">机队：</th>
                            <td width="100">
                                <input class="easyui-combobox" id="fleet" name="fleet"
                                       data-options="editable:false,required:true"
                                       style="width: 100px;"/>
                            </td>

                            <th class="th" align="right" style="width: 120px;">发动机型号：</th>
                            <td width="120">
                                <input class="easyui-combobox" id="engNo" name="engNo"
                                       data-options="editable:false,required:true"
                                       style="width: 120px;"/>
                            </td>

                            <th class="th" align="right" width="100">工卡号：</th>
                            <td>
                                <input class="easyui-textbox" id="jcNoA" data-options="editable:false"
                                       style="width: 180px;"></input>
                                -
                                <input class="easyui-textbox" style="width: 40px;" id="jcNoB"
                                       data-options="required:true"></input>

                                <input type="hidden" id="ver" name="ver"></input>
                            </td>
                        </tr>
                        <tr>

                            <th class="th" align="right" style="width: 80px;">是否必检：</th>
                            <td>
                                <input class="easyui-combobox" id="ifRii" name="ifRii"
                                       data-options="editable:false,required:true"
                                       style="width: 100px;"/>
                            </td>

                            <th class="th" align="right">检验等级：</th>
                            <td>
                                <input class="easyui-combobox" id="checkLevel" name="checkLevel"
                                       data-options="editable:false,required:true"
                                       style="width: 120px;"/>
                            </td>

                            <th class="th" align="right">额定工时：</th>
                            <td>
                                <input class="easyui-numberbox" id="planHours" name="planHours"
                                       data-options="required:true,validType:['maxLength[7]'],precision:0"
                                       style="width: 180px;"/>
                            </td>

                        </tr>

                        <tr>
                            <th class="th" align="right" style="width: 100px;">中文标题：</th>
                            <td colspan="13" style="width: 100px;padding: 3px">
                                <input id="subjectCn" name="subjectCn" class="easyui-textbox"
                                       data-options="mutiline:true,required:true"
                                       style="width: 98%;height:35px;"></input>
                            </td>
                        </tr>

                        <tr>
                            <th class="th" align="right" style="width: 100px;">英文标题：</th>
                            <td colspan="13" style="width: 100px;padding: 3px">
                                <input id="subjectEn" name="subjectEn" class="easyui-textbox"
                                       data-options="mutiline:true"
                                       style="width: 98%;height:35px;"></input>
                            </td>
                        </tr>

                        <tr>
                            <th class="th" align="right" style="width: 100px;">参考资料：</th>
                            <td colspan="13" style="width: 100px;padding: 3px">
                                <input id="refData" name="refData" class="easyui-textbox" data-options="mutiline:true"
                                       style="width: 98%;height:35px;"></input>
                            </td>
                        </tr>

                        <tr>
                            <th class="th" align="right" style="width: 100px;">补充信息：</th>
                            <td colspan="13" style="width: 100px;padding: 3px">
                                <input id="suppleInfo" name="suppleInfo" class="easyui-textbox"
                                       data-options="mutiline:true"
                                       style="width: 98%;height:35px;"></input>
                            </td>
                        </tr>

                        <tr>
                            <th class="th" align="right" style="width: 100px;">备注：</th>
                            <td colspan="13" style="width: 100px;padding: 3px">
                                <input id="memo" name="memo" class="easyui-textbox" data-options="mutiline:true"
                                       style="width: 98%;height:35px;"></input>
                            </td>
                        </tr>

                    </table>

                    <div id="tt" class="easyui-tabs" style="width: 98%;height:300px;">
                        <div title="QEC工卡所需材料">
                            <table id="dg"></table>
                        </div>
                    </div>
                    <!-- 业务数据展示end-->

                    <h5 style="margin-bottom: 4px;">流程处理：</h5>
                    <input name="taskId" type="hidden"/>
                    <table class="table table-bordered table-info">
                        <tbody id="custom_options"></tbody>
                    </table>
                    <table class="table table-bordered table-info" id="mtable">
                        <tr>
                            <th class="tdl" style="width: 100px;">处理意见：</th>
                            <td class="tdr">
                                <input id="notes" name="notes" class="easyui-textbox easyui-validatebox"
                                       data-options="multiline:true,validType:['maxLength[200]']"
                                       style="height:55px; width: 100%;"/>
                            </td>
                            <th class="tdl xmclass" style="width: 100px">下一级办理人：</th>
                            <td class="tdr xmclass">
                                <input id="authId" class="easyui-textbox easyui-validatebox"
                                       data-options="validType:['maxLength[20]'] " style="height:25px; width:150px;"/>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="6" align="center">
                                <input id="canSubmit" class="btn" disabled="disabled" type="button"
                                       onclick="doSubmit();" value="提交"/>
                                <input id="canTrunTo" class="btn" disabled="disabled" type="button"
                                       onclick="doTurnTo();" value="转办"/>
                                <input id="canReturn" class="btn" disabled="disabled" type="button"
                                       onclick="doReturn();" value="退回"/>
                                <!--<input id="canReturnStart" class="btn" type="button" onclick="javascript: doReturnToStart();"value="退回到办理人"/>-->
                                <!--<input id="canTerminate" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="终止"/>
                                <input id="canHangUp" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="挂起"/>-->
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>
    <div title="流程信息" style="">
        <table class="table table-bordered table-info" id="processInfo">
            <tr>
                <th class="tdl" style="width: 145px;">流程业务Key ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="businessKey"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="executionName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="createTime"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程创建人 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="userName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="nodeName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="isJoint"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务-配置 ：</th>
                <td class="tdr" colspan="3" style="vertical-align: middle;">
                    <input type="checkbox" name="canReturn" value="" disabled/> 可退回
                    <input type="checkbox" name="canTrunTo" value="" disabled/> 可转办
                    <input type="checkbox" name="canTerminate" value="" disabled/> 可终止
                    <input type="checkbox" name="canHangUp" value="" disabled/> 可挂起
                </td>
            </tr>
        </table>
        <div id="workflow" style="overflow-x: scroll;"></div>
    </div>
    <div id="tab02" title="历史任务信息" style="">
        <table id="historyDg"></table>
    </div>
</div>

<script type="text/javascript">
    /**
     *
     * @param resource  业务数据
     * @param execution 流程实例数据
     * @param node 节点配置数据
     * @constructor
     */
    var jc_pkid;
    var selectRow;
    var COMBOBOX_DATA = {};

    function InitLoadResource(resource, execution, node) {
        //ParseFormField_(resource, null, Constant.CAMEL_CASE);

        jc_pkid = resource.pkid;
        InitFuncCodeRequest_({
            data: {
                domainCode: "DA_FLEET,YESORNO,TD_JC_ALL_QECJC_CHECK_LEVEL,TD_JC_ALL_ENGINE_VPN,TD_JC_MATER_SORT,TD_JC_MATER_TYPE,TD_JC_MATER_UNIT,TD_JC_MATER_IMPORTANCE,TD_JC_EXTEND",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                    //机队
                    COMBOBOX_DATA['fleet'] = jdata.data.DA_FLEET;
                    //是否必检
                    COMBOBOX_DATA['ifRii'] = jdata.data.YESORNO;
                    //检验等级
                    COMBOBOX_DATA['checkLevel'] = jdata.data.TD_JC_ALL_QECJC_CHECK_LEVEL;
                    //发动机型号
                    COMBOBOX_DATA['engNo'] = jdata.data.TD_JC_ALL_ENGINE_VPN;

                    //航材/工具
                    COMBOBOX_DATA['materSort'] = DomainCodeToMap_(jdata.data["TD_JC_MATER_SORT"]);
                    //航材类别
                    COMBOBOX_DATA['materType'] = DomainCodeToMap_(jdata.data["TD_JC_MATER_TYPE"]);
                    //数量按需
                    COMBOBOX_DATA['qtyReq'] = DomainCodeToMap_(jdata.data["YESORNO"]);
                    //单位
                    COMBOBOX_DATA['unit'] = DomainCodeToMap_(jdata.data["TD_JC_MATER_UNIT"]);
                    //适用情况（是否视情）
                    COMBOBOX_DATA['importance'] = DomainCodeToMap_(jdata.data["TD_JC_MATER_IMPORTANCE"]);

                    //发动机型号
                    $('#engNo').combobox({
                        panelHeight: '160px',
                        data: jdata.data.TD_JC_ALL_ENGINE_VPN,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onChange: function () {
                            //获取选中的机队
                            var engNoValue = $('#engNo').combobox('getValue');
                            if (engNoValue == null || engNoValue == "") {
                                return;
                            }
                            $('#jcNoA').textbox({value: "SFN-QECJC-" + engNoValue});
                            // $('#ver').textbox({value: '0'});
                        }
                    });

                    //是否必检
                    $('#ifRii').combobox({
                        panelHeight: '50px',
                        data: jdata.data.YESORNO,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                        // value: 'Y'
                    });

                    //检验等级
                    $('#checkLevel').combobox({
                        panelHeight: '135px',
                        data: jdata.data.TD_JC_ALL_QECJC_CHECK_LEVEL,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                        // value: 'Y'
                    });

                    //机队
                    $('#fleet').combobox({
                        panelHeight: '135px',
                        data: jdata.data.DA_FLEET,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                        // value: 'Y'
                    });

                    //下个审批人选择初始化
                    $("#authId").MyComboGrid({
                        idField: 'ACCOUNT_ID',  //实际选择值
                        textField: 'USER_NAME', //文本显示值
                        panelHeight: '180px',
                        required: true,
                        width: 140,
                        params: {FunctionCode: 'FLOW_WORK_ACCOUNT'},
                        columns: [[
                            {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                            {field: 'USER_NAME', title: '审核人', width: 50}
                        ]],
                        onHidePanel: function () {
                            var t = $(this).combogrid('getValue');
                            if (t != null && t != '' & t != undefined) {
                                if (selectRow == null || t != selectRow.ACCOUNT_ID) {//没有选择或者选项不相等时清除内容
                                    alert('请选择，不要直接输入！');
                                    $(this).combogrid({value: ''});
                                }
                            }
                        },
                        onSelect: function (index, row) {
                            selectRow = row;
                            if ('task1531123461355' == node.taskPropId) {//任务退回提交
                                $("#reviewedBy").val(row.ACCOUNT_ID);
                            } else if ('task1531123257349' == node.taskPropId) {//当前节点为校验，送审
                                $("#approvedBy").val(row.ACCOUNT_ID);
                            } else if ('task1531123335564' == node.taskPropId) {//当前节点为审核，送批准
                                $("#publicBy").val(row.ACCOUNT_ID);
                            }
                        }
                    });
                    /*---zhangxun---*/
                    if ('task1531123257349' == node.taskPropId) {     //第一个节点
                        $("#isFirstNode").val('Y');
                    } else if ('task1531123461355' == node.taskPropId) {   // 任务退回节点只能提交
                        $("#canReturn").hide();
                        $("#isFirstNode").val('N');
                    } else {
                        $("#isFirstNode").val('N');
                    }
                    /*---zhangxun---*/
                    //当前节点为审核节点批准节点时
                    if ('task1531123406243' == node.taskPropId) {//批准节点
                        $(".xmclass").hide();
                        $("#authId").combogrid({required: false});
                    }
                    // if (param.pkid) {
                    InitDataForm(jc_pkid);
                    // }
                }


                InitDataGrid();
            }
        })
    }

    //初始化表格
    function InitDataGrid() {
        if ($.trim(jc_pkid) == null || $.trim(jc_pkid) == "") {
            jc_pkid = 0;
        }
        var pageSize = Math.floor(($(document.body).height() - $("fieldset").height() - 200) / 50);
        $("#dg").MyDataGrid({
            identity: "dg",
            sortable: true,
            singleSelect: true,
            pageList: [pageSize],
            resize: function () {
                return tabs_standard_resize($("#tt"), 0.13, 0.0001, 5, 4);
            },
            queryParams: {jcPkid: jc_pkid},
            columns: {
                param: {FunctionCode: 'TD_JC_MATER_LIST'},
                alter: {
                    TEST_UPLOAD: {},
                    MATER_SORT: {
                        formatter: function (value) {
                            return COMBOBOX_DATA['materSort'][value];
                        }
                    },
                    MATER_TYPE: {
                        formatter: function (value) {
                            return COMBOBOX_DATA['materType'][value];
                        }
                    },
                    QTY_REQ: {
                        formatter: function (value) {
                            return COMBOBOX_DATA['qtyReq'][value];
                        }
                    },
                    UNIT: {
                        formatter: function (value) {
                            return COMBOBOX_DATA['unit'][value];
                        }
                    },
                    IMPORTANCE: {
                        formatter: function (value) {
                            return COMBOBOX_DATA['importance'][value];
                        }
                    }
                }
            }
        });
    }

    //回填
    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "TD_JC_ALL_CMJC_PKID"}, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);

                    //截取流水号 3U-QECJC-0332章-A-0
                    var jcNob = jdata.data.JC_NO.substring((("SFN-QECJC-" + jdata.data.ENG_NO + "-").length), (("SFN-QECJC-" + jdata.data.ENG_NO + "-").length) + 1);
                    $("#engNo").combobox({onlyview: true, editable: false, value: jdata.data.ENG_NO});
                    $("#jcNoA").textbox({onlyview: true, editable: false});
                    $("#jcNoB").textbox({onlyview: true, editable: false, value: "" + jcNob});
                    $("#ver").textbox({onlyview: true, editable: false});


                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }


</script>


<script id="tempCombobox" type="text/html">
    <tr>
        <th class="tdl">{{d.titleName }} ：</th>
        <td class="tdr">
            <select name="{{d.fieldName}}" class="easyui-combobox"
                    data-options="required:true, editable: false" panelHeight="120" style="width:180px">
                {{#
                for(var i = 0; i < d.options.length; i++){
                }}
                <option value="{{d.options[i]['value']}}">{{d.options[i]['text']}}</option>
                {{# } }}
            </select>
        </td>
    </tr>
</script>
<script id="tempTextbox" type="text/html">
    <tr>
        <th class="tdl">{{d.titleName }} ：</th>
        <td class="tdr">
            <input name="{{d.fieldName}}" class="easyui-textbox"
                   data-options="required:true, editable: true" style="width:180px"/>
        </td>
    </tr>
</script>

</body>
</html>