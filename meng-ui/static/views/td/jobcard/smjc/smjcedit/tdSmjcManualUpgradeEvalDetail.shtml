<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>手册改版评估详情页面</title>
</head>

<body class="ibody">
<div id="tt" class="ibox  float-e-margins" style="width:100%; height: 100%">
    <div class="ibox-content">
        <table class="table table-bordered table-info">
            <tr>
                <td colspan="9" align="right">
                    <input id="btnComplete" class="btn btn-primary" type="button" onclick="submitFlow()" value="提交审核"
                           style="margin-left:3px;"/>
                    <input id="btnClose" class="btn btn-primary" type="button" onclick=" CloseWindowIframe()" value="关闭"
                           style="margin-left:3px;margin-right: 18px;"/>
                    <br/>
                </td>
            </tr>
        </table>
        <fieldset class="fieldset_eui">
            <legend>评估单信息</legend>
            <form class="form-horizontal m-t" id="mform">
                <input type="hidden" id="pkid" name="pkid"/>
                <table class="table table-bordered table-info">
                    <tr>
                        <th class="th" align="right" style="width: 80px;">评估单号：</th>
                        <td style="width: 80px; padding: 3px">
                            <input class="easyui-textbox" style="width: 160px;"
                                   id="evalNo" name="evalNo"
                                   data-options="onlyview:true" readonly/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">关联手册：</th>
                        <td style="width: 80px; padding: 3px">
                            <input class="easyui-textbox" style="width: 260px;"
                                   id="relateManual" name="relateManual"
                                   data-options="onlyview:true" readonly/>
                        </td>
                        <th class="th" align="right" style="width: 80px;">章节：</th>
                        <td style="width: 80px; padding: 3px">
                            <input class="easyui-textbox" style="width: 80px;"
                                   id="ata" name="ata"
                                   data-options="onlyview:true" readonly/>
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
        <fieldset class="fieldset_eui">
            <legend>涉及工卡清单</legend>
            <form id="ffSearch" class="form-horizontal">
                <table class="table table-bordered table-info">
                    <tr>
                        <td colspan="8"></td>
                        <td align="left" style="padding: 3px;">
                            &nbsp; &nbsp;
                            <a class="searchBtn" type="button" onclick="onSearch_('dg','#ffSearch')"
                               data-options="iconCls:'icon-search'">
                                <span data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>
                            <a class="clearBtn" onclick="doClear_('#ffSearch','dg')"
                               data-options="iconCls:'icon-clear'">
                                <span data-i18n="common:COMMON_OPERATION.RESET">重置</span></a>
                            <a class="addBtn ifDjClass" data-options="'" id="disBtn"
                               onclick="distribute()"><span>分配</span></a>
                           <a class="excelBtn" data-options="iconCls:'icon-page_excel'" id="exportExcelBtn"
                               onclick="exportExelData()"><span>导出</span></a>
                            <!-- <a class="addBtn ifDjClass" onclick="importExcel()" id="importExcelBtn"><span>导入</span></a>-->
                        </td>
                    </tr>
                    <tr id = 'jc'>
                        <th class="th" style="width:100px;" align="right">工卡号：</th>
                        <td style="padding: 3px;width: 106px">
                            <input class="easyui-textbox" id="jcNo" name="jcNo" data-options=""
                                   style="width: 170px"/>
                        </td>
                        <th class="th" style="width:100px;" align="right">评估结论：</th>
                        <td style="padding: 3px;width: 106px">
                            <input class="easyui-combobox" id="ifRevision" name="ifRevision" data-options=""
                                   style="width: 170px"/>
                        </td>
                        <th class="th" style="width:100px;" align="right">状态：</th>
                        <td style="padding: 3px;width: 106px">
                            <input class="easyui-combobox" id="status" name="status" data-options=""
                                   style="width: 110px"/>
                        </td>
                    </tr>
                    <tr id = 'na'>
                        <th class="th" style="width:60px;" align="right">评估结论：</th>
                        <td style="padding: 3px;width: 106px">
                            <input class="easyui-combobox" id="ifRevision1" name="ifRevision1" data-options=""
                                   style="width: 170px"/>
                        </td>
                        <th class="th" style="width:100px;" align="right">TaskCode：</th>
                        <td style="padding: 3px;width: 106px">
                            <input class="easyui-textbox" id="oemTaskCode" name="oemTaskCode" data-options=""
                                   style="width: 170px"/>
                        </td>
                        <th class="th" style="width:60px;" align="right">修订标识：</th>
                        <td style="padding: 3px;width: 106px">
                            <input class="easyui-combobox" id="oemChangeType" name="oemChangeType" data-options="editable:false"
                                   style="width: 80px"/>
                        </td>
                        <th class="th" style="width:60px;" align="right">备注：</th>
                        <td style="padding: 3px;width: 106px">
                            <input class="easyui-textbox" id="memo" name="memo" data-options=""
                                   style="width: 110px"/>
                        </td>
                    </tr>
                </table>
            </form>
            <table id="dg"></table>
        </fieldset>
    </div>
</div>
</body>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var PAGE_DATA = {};
    var COMBO_DATA = {};
    var param; // operation[add,edit,view]
    var evalNo;//评估单号
    var operation;//操作
    var fleet;//机队
    var taskId;//流程ID
    var status;//状态
    var refPkid;
    var ata;
    var func;

    function i18nCallBack() {
        param = getParentParam_();
        evalNo = param.evalNo;
        operation = param.operation;
        fleet = param.fleet;
        taskId = param.taskId;
        status = param.status;
        refPkid = param.refPkid;
        ata = param.ata;
        if(ata == 'N/A'){
           func = 'TD_SMJC_MANUAL_UPGRADE_EVAL_DETAIL_NA';
           $('#jc').hide();
        }else{
            func = 'TD_SMJC_MANUAL_UPGRADE_EVAL_DETAIL_LIST';
            $('#na').hide();
        }
        InitFuncCodeRequest_({
            data: {
                domainCode: "TD_SMJC_STATUS,NEWAC_EVAL_RESULT,TD_JC_STATE,JC_OEM_CHANGE_TYPE",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $("#status").combobox({
                        panelHeight: '136px',
                        data: jdata.data.TD_SMJC_STATUS,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#ifRevision").combobox({
                        panelHeight: '50px',
                        data: jdata.data.NEWAC_EVAL_RESULT,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#ifRevision1").combobox({
                        panelHeight: '50px',
                        data: jdata.data.NEWAC_EVAL_RESULT,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#oemChangeType").combobox({
                        panelHeight: '80px',
                        data: jdata.data.JC_OEM_CHANGE_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //工卡流程状态
                    PAGE_DATA['status'] = DomainCodeToMap_(jdata.data["TD_SMJC_STATUS"]);
                    PAGE_DATA['jcStatus'] = DomainCodeToMap_(jdata.data["TD_JC_STATE"]);
                    //是否改版
                    PAGE_DATA['ifVersion'] = DomainCodeToMap_(jdata.data["NEWAC_EVAL_RESULT"]);

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
                if (operation == "view") {
                    $('#btnComplete').hide();
                    $("#importExcelBtn").hide();
                    $("#disBtn").hide();
                }
                if ("task1599134069755" == taskId) { //退回节点
                    $('#btnComplete').hide();
                    $('#btnClose').hide();
                }
                if ("TURNBACK" == status) {
                    $('#btnComplete').hide();
                }
                InitDataForm(evalNo);
            }
        })
    }

    //回填
    function InitDataForm(evalNo) {
        InitFuncCodeRequest_({
            data: {
                FunctionCode: "TD_MANUAL_UPGRADE_EVAL_PKID",
                evalNo: evalNo
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    if(!refPkid && jdata.data.REF_PKID){
                        refPkid = jdata.data.REF_PKID;
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
                InitDataGrid(evalNo);
            }
        });
    }

    function InitDataGrid(evalNo) {
        $("#dg").MyDataGrid({
            identity: 'dg',
            sortable: true,
            singleSelect: true,
            resize: function () {
                return {width: 1169, height: 440};
            },
            queryParams: {evalNo: evalNo, fleet: fleet,refPkid:refPkid},
            columns: {
                param: {FunctionCode: func},
                alter: {
                    IF_REVISION: {
                        formatter: function (value) {
                            return PAGE_DATA['ifVersion'][value];
                        }
                    },
                    STATUS: {
                        formatter: function (value) {
                            return PAGE_DATA['status'][value];
                        }
                    },
                    JC_STATUS: {
                        formatter: function (value) {
                            return PAGE_DATA['jcStatus'][value];
                        }
                    }
                }
            },
            contextMenus: [
                {
                    id: "m-review",
                    i18nText: "评估",
                    auth: "",
                    onclick: function () {
                        var rowData = getDG('dg').datagrid('getSelected');
                        var msgArr = [];
                        if (msgArr.length > 0) {
                            hints(msgArr);
                        } else {
                            var evalNo = rowData.EVAL_NO;
                            if(ata == 'N/A'){
                                openManualNa('edit',rowData);
                            }else{
                                openReview("edit", rowData.PKID, rowData.REV_DETAIL_ID, rowData.IF_REVISION, rowData.EVAL_MEMO, evalNo);
                            }
                        }
                    }
                }
            ],
            validAuth: function (row, items) {
                if ("CHECKING" == status) {
                    items['评估'].display = false;
                }
                if ("task1599133976283" == taskId) { //审批节点
                    items['评估'].display = false;
                }
                if (operation == "view") {
                    items['评估'].display = false;//双击查看预览页面时
                }
                return items;
            },
            onDblClickRow: function (index, field, value) {
                var evalNo = value.EVAL_NO;
                if (ata == 'N/A') {
                    openManualNa('view', value);
                } else {
                    openReview("view", value.PKID, value.REV_DETAIL_ID, value.IF_REVISION, value.EVAL_MEMO,evalNo);
                }
            }
        });
    }

    //打开评估页面
    function openReview(operation, jcId, evalDetailId, ifRevision, evalMemo, evalNo) {
        var title_ = "";
        title_ = $.i18n.t('手册改版评估-维修方案工卡评估');
        ShowWindowIframe({
            width: "830",
            height: "680",
            title: title_,
            param: {
                jcId: jcId,
                evalDetailId: evalDetailId,
                ifRevision: ifRevision,
                evalMemo: evalMemo,
                evalNo: evalNo,
                operation: operation
            },
            url: "/views/td/jobcard/smjc/smjcedit/tdSmjcManualUpgradeEval.shtml"
        });
    }

    function reloadJcDetail() {
        $("#dg").datagrid("reload");
    }

    //提交校对
    function submitFlow() {
        //提交校对前校验评估结论是否都已填
        var rowDatas = $("#dg").datagrid('getData');//获取所有行数据
        for (var i = 0; i < rowDatas.data.length; i++) {
            if (rowDatas.data[i].IF_REVISION == null || rowDatas.data[i].IF_REVISION == undefined || rowDatas.data[i].IF_REVISION == '') {
                MsgAlert({content: "手册改版评估清单中中存在评估结论为空的数据，请评估后再提交！", type: 'error'});
                return;
            }
        }
        InitFuncCodeRequest_({
            data: {
                evalNo: evalNo,
                fleet: fleet,
                FunctionCode: 'TD_MANUAL_UPGRADE_RELATE_JC_CHECK_BEFORE_SUBMIT'
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //查看是否有存在的工作流程
                    var datas = $.extend({}, {}, {
                        FunctionCode: 'TD_JC_MANUAL_UPGRADE_CHECK_SUBMIT_BEFORE',
                        evalNo: evalNo
                    });
                    InitFuncCodeRequest_({
                        data: datas, successCallBack: function (jdata) {
                            if (jdata.data == null) {
                                common_add_edit_({
                                    identity: '',
                                    isEdit: '',
                                    width: 520,
                                    height: 300,
                                    title: $.i18n.t('选择审批人'),
                                    param: {
                                        roleId: '',
                                        otherParam: evalNo,
                                        FunctionCode_: 'TD_JC_MANUAL_UPGRADE_EVAL_SUMBIT',
                                        successCallback: reload_,
                                        flowKey: "tdNewacJcReEval"
                                    },
                                    url: "/views/em/workflow/work_flow_account_select.shtml"
                                });
                            } else {
                                MsgAlert({content: "该数据已被提交过了。", type: 'error'});
                            }
                        }
                    });
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

    }

    function reload_() {
        CloseWindowIframe();
        param.OWindow.reload_manual_upgrade();
    }

    function doClear_(search, grid) {
        $(search).form('clear');
        searchData(grid, search);
    }

    function searchData(grid, search) {
        onSearch_(grid, search);
    }

    //    //完成评估
    //    function finishEval() {
    //        var rowDatas = $("#dg").datagrid('getData');//获取所有行数据
    //        var revsionDatas = [];
    //        for (var i = 0; i < rowDatas.data.length; i++) {
    //            if (rowDatas.data[i].IF_REVISION == null || rowDatas.data[i].IF_REVISION == undefined || rowDatas.data[i].IF_REVISION == '') {
    //                MsgAlert({content: "重评工卡清单中存在未被评估是否改版的工卡，请评估后再点击完成评估！", type: 'error'});
    //                return;
    //            }
    //            if (rowDatas.data[i].IF_REVISION == "Y") {
    //                revsionDatas.push(rowDatas.data[i]);
    //            }
    //        }
    //        if (!isEmpty(revsionDatas)) {
    //            var detailData = JSON.stringify(revsionDatas);
    //            InitFuncCodeRequest_({
    //                data: {evaId: pkid, detailData: detailData, appType: 'APL', FunctionCode: 'TD_SMJC_REVISION'},
    //                successCallBack: function (jdata) {
    //                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
    //                        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
    //                        param.OWindow.reload_();
    //                        CloseWindowIframe();
    //                    } else {
    //                        MsgAlert({content: jdata.msg, type: 'error'});
    //                    }
    //                }
    //            });
    //        }
    //
    //    }

    //批量导入
    function importExcel() {
        var sourceId = new Date().getTime();
        common_uploadFile2({
            identity: '',
            param: {
                cat: "TD_SMJC_MANUAL_UPGRADE_DETAIL",
                sourceId: sourceId,
                operation: "TD_JC_MANUAL_UPGRADE_DETAIL_IMPORT",
                upload: "Y",
                successCellBack: function () {
                    reloadJcDetail();
                },
                fialCellBack: ''
            }
        })
    }
    //导出EXCEL数据
    function exportExelData() {
        excelExport('dg', '手册改版评估-工卡');
    }

    function openManualNa(operation, rowData) {
        var evalNo = rowData.EVAL_NO;
        var pkid = rowData.PKID;
        var oemChangeType = rowData.OEM_CHANGE_TYPE;
        ShowWindowIframe({
            width: "700",
            height: "400",
            title: "手册改版评估明细页面",
            param: {operation: operation, evalNo: evalNo,oemChangeType:oemChangeType,pkid:pkid},
            url: "/views/td/jobcard/manualUpgrade/revEval/tdSmjcManualUpgradeNaEval.shtml"
        });
    }

    function distribute(){
        var rows = $('#dg').datagrid('getChecked');
        var pkids = '';
        if(rows.length == 0){
            MsgAlert({content: "至少勾选一条数据。", type: 'error'});
            return;
        }
        for(var i = 0;i<rows.length;i++){
            var row = rows[i];
            var id = "";
            if(ata == 'N/A'){
                id = row.PKID;
            }else{
                id = row.REV_DETAIL_ID;
            }
            if(id && pkids.indexOf(id) == -1){
                pkids = pkids + ',' + id;
            }
        }
        pkids = pkids.substring(1);
        var title_ = "";
        title_ = $.i18n.t('条目分配');
        ShowWindowIframe({
            width: "530",
            height: "250",
            title: title_,
            param: {
                pkids:pkids
            },
            url: "/views/td/jobcard/smjc/smjcedit/manualUpgradeTran.shtml"
        });
    }

</script>

</html>