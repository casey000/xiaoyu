<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>未升版手册清单</title>
</head>
<body class="ibody">
<div id="tt" class="easyui-tabs" style="width: 100%;height: 100%">

    <div title="受影响工卡清单" style="display:none;" id="searchBar1">
        <form id="ffSearch1" method="post">
            <table class="table table-bordered table-info">
                <tr>
                    <th class="tdl" style="width: 60px">机队：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-combobox" name="fleet6" id="fleet6"
                               data-options="editable:true"
                               style=" width:80px;"/>
                    </td>
                    <th class="tdl" style="width: 80px">手册类型：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-combobox" name="manualType6" id="manualType6"
                               data-options="editable:true"
                               style=" width:80px;"/>
                    </td>
                    <th class="tdl" style="width: 80px">手册编号：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-textbox" name="sbNo6" id="sbNo6"
                               data-options="editable:true"
                               style=" width:100px;"/>
                    </td>
                    <th class="tdl" style="width: 80px">厂家版本：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-textbox" name="manualVer6" id="manualVer6"
                               data-options="editable:true"
                               style=" width:80px;"/>
                    </td>
                    <td align="left">
                        <a href="javascript:void(0)" class="searchBtn" data-options="iconCls:'icon-search'"
                           onclick="searchData('dg1','#ffSearch1')">
                            <span data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>
                        <a class="clearBtn" href="javascript:void(0)" onclick="doClear_('#ffSearch1')"
                           data-options="iconCls:'icon-clear'">
                            <span data-i18n="common:COMMON_OPERATION.RESET">重置</span></a>
                    </td>
                </tr>
            </table>
        </form>
        <table id="dg1"></table>
    </div>

    <div title="未受影响工卡清单" style="display:none;" id="searchBar2">
        <form id="ffSearch2" method="post">
            <table class="table table-bordered table-info">
                <tr>
                    <th class="tdl" style="width: 60px">机队：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-combobox" name="fleet" id="fleet"
                               data-options="editable:true"
                               style=" width:80px;"/>
                    </td>
                    <th class="tdl" style="width: 80px">手册类型：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-combobox" name="manualType" id="manualType"
                               data-options="editable:true"
                               style=" width:80px;"/>
                    </td>
                    <th class="tdl" style="width: 80px">手册编号：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-textbox" name="sbNo" id="sbNo"
                               data-options="editable:true"
                               style=" width:100px;"/>
                    </td>
                    <th class="tdl" style="width: 80px">厂家版本：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-textbox" name="manualVer" id="manualVer"
                               data-options="editable:true"
                               style=" width:80px;"/>
                    </td>
                    <th class="tdl" style="width: 80px">评估状态：</th>
                    <td class="tdr" style="width: 80px;">
                        <input class="easyui-combobox" name="noStatus" id="noStatus"
                               data-options="editable:false"
                               style=" width:80px;"/>
                    </td>
                    <td align="left">
                        <a href="javascript:void(0)" class="searchBtn" data-options="iconCls:'icon-search'"
                           onclick="searchData('dg2','#ffSearch2')">
                            <span data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>
                        <a class="clearBtn" href="javascript:void(0)" onclick="doClear_('#ffSearch2')"
                           data-options="iconCls:'icon-clear'">
                            <span data-i18n="common:COMMON_OPERATION.RESET">重置</span></a>
                    </td>
                </tr>
            </table>
        </form>
        <table id="dg2"></table>
    </div>
    <div title="手册改版评估" style="display:none;" id="searchBar3">
        <form id="ffSearch3" method="post">
            <table class="table table-bordered table-info">
                <tr>
                    <th class="tdl" style="width: 60px">机队：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-combobox" name="fleet1" id="fleet1"
                               data-options="editable:true"
                               style=" width:80px;"/>
                    </td>
                    <th class="tdl" style="width: 80px">手册类型：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-combobox" name="manualType1" id="manualType1"
                               data-options="editable:true"
                               style=" width:80px;"/>
                    </td>
                    <th class="tdl" style="width: 80px">手册编号：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-textbox" name="sbNo1" id="sbNo1"
                               data-options="editable:true"
                               style=" width:100px;"/>
                    </td>
                    <th class="tdl" style="width: 80px">厂家版本：</th>
                    <td class="tdr" style="width: 100px;">
                        <input class="easyui-textbox" name="manualVer1" id="manualVer1"
                               data-options="editable:true"
                               style=" width:80px;"/>
                    </td>
                    <th class="tdl" style="width: 80px">评估状态：</th>
                    <td class="tdr" style="width: 80px;">
                        <input class="easyui-combobox" name="evaStatus" id="evaStatus"
                               data-options="editable:false"
                               style=" width:80px;"/>
                    </td>
                    <td align="left">
                        <a href="javascript:void(0)" class="searchBtn" data-options="iconCls:'icon-search'"
                           onclick="searchData('dg3','#ffSearch3')">
                            <span data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>
                        <a class="clearBtn" href="javascript:void(0)" onclick="doClear_('#ffSearch3')"
                           data-options="iconCls:'icon-clear'">
                            <span data-i18n="common:COMMON_OPERATION.RESET">重置</span></a>
                    </td>
                </tr>
            </table>
        </form>
        <table id="dg3"></table>
    </div>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var PAGE_DATA = {};
    var user;
    var hiddenBatchDelete = true;
    var companyCode3;
    var eflag = '';
    var ifQua = '';
    var name = getLoginInfo().userName;
    var accountId = getLoginInfo().accountId;
    var searchFlag = true;

    function i18nCallBack() {

        $(".easyui-tabs").tabs({
            onSelect: function (title, index) {
                if ("受影响工卡清单" == title) {
                    searchData('dg1', '#ffSearch1');//切换tab初始化查询
                    //绑定回车查询
                    bindFormonSearch_('#ffSearch1', function () {
                        searchData('dg1', '#ffSearch1');//切换tab初始化查询
                    });
                } else if ("未受影响工卡清单" == title) {
                    searchData('dg2', '#ffSearch2');//切换tab初始化查询
                    //绑定回车查询
                    bindFormonSearch_('#ffSearch2', function () {
                        searchData('dg2', '#ffSearch2');
                    });
                }else if ("手册改版评估" == title) {
                    searchData('dg3', '#ffSearch3');//切换tab初始化查询
                    //绑定回车查询
                    bindFormonSearch_('#ffSearch3', function () {
                        searchData('dg3', '#ffSearch3');
                    });
                }
            }
        });

        user = getLoginInfo();
        InitFuncCodeRequest_({
            data: {
                domainCode: "TD_JC_NO_STATUS,TD_JC_EVA_STATUS,TD_JC_APP_TYPE,DA_FLEET,TD_SMJC_STATUS,YESORNO," +
                "TD_JC_FROM_TO,TD_JC_MODEL,TD_JC_STATE,TD_JC_EXTEND,TD_JC_SMJC_WRITER,TD_JC_CHECKLEVEL," +
                "TD_JC_CHANGE_FLAG,DA_ENG_TYPE,TD_ATA,TD_MANUAL_TYPE",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#fleet').combobox({
                        panelHeight: '110px',
                        data: jdata.data.DA_FLEET,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    $('#fleet1').combobox({
                        panelHeight: '110px',
                        data: jdata.data.DA_FLEET,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    $('#fleet6').combobox({
                        panelHeight: '110px',
                        data: jdata.data.DA_FLEET,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    //流程状态
                    $('#manualType1').combobox({
                        panelHeight: '110px',
                        data: jdata.data.TD_MANUAL_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#manualType6').combobox({
                        panelHeight: '110px',
                        data: jdata.data.TD_MANUAL_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //工卡流程状态
                    $('#status').combobox({
                        panelHeight: '110px',
                        data: jdata.data.TD_SMJC_STATUS,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        value: 'EDIT'
                    });
                    $("#ata").combobox({
                        panelHeight: '80px',
                        data: jdata.data.TD_ATA,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#ata1").combobox({
                        panelHeight: '80px',
                        data: jdata.data.TD_ATA,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#evaStatus").combobox({
                        panelHeight: '80px',
                        data: jdata.data.TD_JC_EVA_STATUS,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#noStatus").combobox({
                        panelHeight: '80px',
                        data: jdata.data.TD_JC_NO_STATUS,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });

                    //流程状态
                    $("#status").combobox('setValue', 'EDIT');
                    $("#statusAff").combobox('setValue', 'EDIT');
                    $("#statusNoAff").combobox('setValue', 'EDIT');
                    //编写人
//                    $('#quaManName').textbox("setValue", name);
//                    $('#quaManName2').textbox("setValue", name);
//                    $('#quaManName3').textbox("setValue", name);

                    //机队
                    PAGE_DATA['fleet'] = DomainCodeToMap_(jdata.data["DA_FLEET"]);
                    //工卡流程状态
                    PAGE_DATA['status'] = DomainCodeToMap_(jdata.data["TD_SMJC_STATUS"]);
                    //检验级别
                    PAGE_DATA['checkLevel'] = DomainCodeToMap_(jdata.data["TD_JC_CHECKLEVEL"]);
                    //是否必检
                    PAGE_DATA['ifRii'] = DomainCodeToMap_(jdata.data["YESORNO"]);
                    //是否超期
                    PAGE_DATA['isExtend'] = DomainCodeToMap_(jdata.data["YESORNO"]);
                    //项目来源
                    PAGE_DATA['itemFrom'] = DomainCodeToMap_(jdata.data["TD_JC_FROM_TO"]);
                    //修订标识
                    PAGE_DATA['changeFlag'] = DomainCodeToMap_(jdata.data["TD_JC_CHANGE_FLAG"]);
                    //工卡有效性
                    PAGE_DATA['jcStatus'] = DomainCodeToMap_(jdata.data["TD_JC_STATE"]);
                    //工序是否检出
                    PAGE_DATA['cepCheckout'] = DomainCodeToMap_(jdata.data["YESORNO"]);
                    PAGE_DATA['noStatus'] = DomainCodeToMap_(jdata.data["TD_JC_NO_STATUS"]);
                    PAGE_DATA['evaStatus'] = DomainCodeToMap_(jdata.data["TD_JC_EVA_STATUS"]);

                    InitDataGrid1();
                    initJCManual();
                    initNewacManual();
                    InitDataGrid2();
                    InitDataGrid3();
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function reload1_() {
        $("#dg2").datagrid("reload");
    }

    //打开工卡详情页
    function openEdit(operation, pkid, cmpNo, fleet, companyCode, jcType, jcNo, cepCheckout, cepFilePath, appType, status) {
        var title_ = $.i18n.t('维修方案工卡详情');
        var dataFrom = "";
        if (operation == "cmpadd") {
            dataFrom = "CMP";
        } else {
            dataFrom = "CUS";
        }
        ShowWindowIframe({
            width: "1430",
            height: "750",
            title: title_,
            param: {
                pkid: pkid,
                type: operation,
                from: dataFrom,
                cmpNo: cmpNo,
                fleet: fleet,
                companyCode: companyCode,
                jcType: jcType,
                jcNo: jcNo,
                cepCheckout: cepCheckout,
                cepFilePath: cepFilePath,
                operation: operation,
                appType: appType,
                jcStatus: status
            },
            url: "/views/td/jobcard/smjc/smjcedit/tdSmjcEditDetail.shtml"
        });
    }

    //打开mtop详情页
    function openMtopEdit(operation, cmpNo, pkid) {
        var title_ = $.i18n.t('定检工卡详情');
        var dataFrom = "";
        if (operation == "cmpadd") {
            dataFrom = "CMP";
        } else {
            dataFrom = "CUS";
        }
        ShowWindowIframe({
            width: "1000",
            height: "400",
            title: title_,
            param: {cmpNo: cmpNo, type: operation, from: dataFrom, pkid: pkid},
            url: "/views/td/jobcard/smjc/smjcedit/tdSmjcMtopEdit.shtml"
        });
    }

    function jcPreview(url) {
        var title_ = $.i18n.t('定检工卡预览');
        ShowWindowIframe({
            width: "850",
            height: "650",
            title: title_,
            param: {url: url},
            url: "/views/td/jobcard/smjc/smjcedit/jobcardPreview.shtml"
        });
    }

    //查询
    function searchData(grid, search) {
        onSearch_(grid, search);
    }

    //查询
    function searchData_() {
        onSearch_('dg2', '#ffSearch2');
    }

    //重置
    function doClear_(search, grid) {
        $(search).form('clear');
        // searchData(grid, search);
    }


    function importExcel() {
        InitFuncCodeRequest_({
            data: {FunctionCode: "TD_JC_CMP_IMPORT"},
            successCallBack: function (jdata) {
            }
        });
    }

    //对比
    function openDiff(fleet, operation, pkid) {
        if (operation == null || operation == "") {
            MsgAlert({content: "请选择需要对比的类型！", type: 'error'});
            return;
        }
        if (typeof(pkid) == "undefined" || pkid == null || pkid == "") {
            MsgAlert({content: "请选择数据！", type: 'error'});
            return;
        }
        var curPath = window.document.location.href;
        var url;
        if (curPath.indexOf('me.sichuanair.com') >= 0 || curPath.indexOf('172.31.240.46') >= 0) {//生产
            url = 'http://172.30.129.125:8001';
        } else if (curPath.indexOf('172.30.129.101') >= 0) {//测试
            url = 'http://172.30.129.104:8001';
        } else if (curPath.indexOf('172.30.129.111') >= 0) {//开发
            url = 'http://172.30.129.113:8001';
        } else {//本地
            url = 'http://localhost:8001';
        }
        // if (fleet == "A350") {
        if (operation == "mm") {

            /**ajax加载遮罩层*/
            ajaxLoading();
            InitFuncCodeRequest_({
                data: {FunctionCode: 'TD_JC_MANUAL_DIFF', pkid: pkid},
                successCallBack: function (jdata) {
                    /**ajax销毁遮罩层*/
                    ajaxLoadEnd();
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        var filePaths = jdata.data;
                        var firstFilePath = "";
                        var secondFilePath = "";
                        if (filePaths.indexOf(",") != -1) {
                            var pathArr = filePaths.split(",");
                            if (pathArr.length == 2) {
                                firstFilePath = pathArr[0];
                                secondFilePath = pathArr[1];
                            } else if (pathArr.length == 1) {
                                firstFilePath = pathArr[0];
                                secondFilePath = pathArr[0];
                            } else {
                                MsgAlert({content: "手册对比出错，请联系管理员！", type: 'error'});
                                return;
                            }
                        }
                        window.open(url + "/diff/diff-ui/index.html?difffirstdoc=" + firstFilePath + "&diffseconddoc=" + secondFilePath);
                    } else if (jdata.code == 201) {
                        MsgAlert({content: "当前手册与最新手册版本相同，无法对比。", type: 'error'});

                    } else {
                        MsgAlert({content: jdata.msg, type: 'error'});
                    }
                }
            });

        } else if (operation == "mj") {
            var firstFilePath = "";
            var secondFilePath = "";
            /**ajax加载遮罩层*/
            ajaxLoading();
            InitFuncCodeRequest_({
                data: {FunctionCode: 'TD_JC_MANUALJC_DIFF', pkid: pkid, async: false},
                successCallBack: function (jdata) {
                    /**ajax销毁遮罩层*/
                    ajaxLoadEnd();
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                        var filePaths = jdata.data;
                        var firstFilePath = "";
                        var secondFilePath = "";
                        if (filePaths.indexOf(",") != -1) {
                            var pathArr = filePaths.split(",");
                            if (pathArr.length == 2) {
                                firstFilePath = pathArr[0];
                                secondFilePath = pathArr[1];
                            } else if (pathArr.length == 1) {
                                firstFilePath = pathArr[0];
                                secondFilePath = pathArr[0];
                            } else {
                                MsgAlert({content: "手册对比出错，请联系管理员！", type: 'error'});
                            }
                        }
                        window.open(url + "/diff/diff-ui/index.html?difffirstdoc=" + firstFilePath + "&diffseconddoc=" + secondFilePath);

                    } else {
                        MsgAlert({content: jdata.msg, type: 'error'});
                    }
                }
            });
        } else {

        }


    }

    //查看手册
    function viewManual(pkid) {

    }



    /*--------zhangxun-------*/

    /*撤销分配*/
    function cancelWriter(pkid) {
        if (!confirm("确认撤销该通知单的编卡人？")) {
            return;
        }
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: 'TD_CMP_NOTICE_CANCEL_WRITER'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    $("#dg2").datagrid("reload");
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function distributionWriter() {
        var cmpfleet = $("#fleetCmp").combobox("getValue");
        if (cmpfleet == null || cmpfleet == "") {
            MsgAlert({content: '请选择机队！', type: 'error'});
            return;
        }
        var selectRows = $("#dg2").datagrid('getChecked');
        var selectCount = selectRows.length;
        if (selectCount < 1) {
            MsgAlert({content: '请选择要分配工卡编写人的CMP通知单！', type: 'error'});
            return;
        }
        var cmpPkid = "";
        $.each(selectRows, function (k, item) {
            cmpPkid += item.PKID + ',';
        });
        var cmpPkids = cmpPkid.substring(0, cmpPkid.length - 1);

        var title_ = $.i18n.t('人员分配');
        ShowWindowIframe({
            width: "600",
            height: "300",
            title: title_,
            param: {cmppkids: cmpPkids, cmpfleet: cmpfleet},
            url: "/views/td/jobcard/smjc/smjcedit/cmpNoticeDistrib.shtml"
        });
    }

    function InitDataGrid1(){
        var pageSize = Math.floor(($(document.body).height() - $("fieldset").height() - 185) / 50);
        $("#dg1").MyDataGrid({
            identity: "dg1",
            sortable: true,
            singleSelect: true,
            queryParams: {},
            pageSize: pageSize, pageList: [pageSize],
            resize: function () {
                return {
                    height: $(document.body).height() - 70,
                    width: $(document.body).width()-5
                };
            },
            columns: {
                param: {FunctionCode: 'TD_MANUAL_AFFECT_LIST'},
                alter: {
                    SB_NO: {
                        formatter: function (value, row, index) {
                            var refPkid = row.PKID;
                            return '<a href="javascript:void(0);" onclick="affectList(\'' + refPkid + '\')">' + value + '</a>';
                        },
                    }
                }
            },
            contextMenus: [
            ],
            onDblClickRow: function (index, field, row) {
                var refPkid = row.PKID;
                affectList(refPkid);
            },
            validAuth: function (row, items) {
                return items;
            }
        });
    }



    function reCountAffectJobcard() {
        InitFuncCodeRequest_({
            data: {FunctionCode: "TD_JC_REPEAT_REV"}, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data == 200) {
                        MsgAlert({content: "成功", type: 'error'});

                    }
                } else {
                    MsgAlert({content: "失败", type: 'error'});

                }
            }
        });
    }


    //未升版手册清单
    function initJCManual() {
        InitFuncCodeRequest_({
            data: {
                domainCode: "DA_FLEET,TD_MANUAL_TYPE,DM_REC_VER_TYPE,TD_JC_MANUAL_IF_REV",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //机队
                    $('#fleetManual').combobox({
                        panelHeight: '100px',
                        data: jdata.data.DA_FLEET,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //流程状态
                    $('#manualType').combobox({
                        panelHeight: '120px',
                        data: jdata.data.TD_MANUAL_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //机队
                    PAGE_DATA['fleetManual'] = DomainCodeToMap_(jdata.data["DA_FLEET"]);
                    //控制类别
                    PAGE_DATA['manualType'] = DomainCodeToMap_(jdata.data["TD_MANUAL_TYPE"]);
                    PAGE_DATA['isTr'] = DomainCodeToMap_(jdata.data["DM_REC_VER_TYPE"]);
                    PAGE_DATA['ifJcRev'] = DomainCodeToMap_(jdata.data["TD_JC_MANUAL_IF_REV"]);
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function InitDataGrid2() {
        var pageSize = Math.floor(($(document.body).height() - $("fieldset").height() - 185) / 50);
        $("#dg2").MyDataGrid({
            identity: "dg2",
            sortable: true,
            singleSelect: true,
            queryParams: {},
            pageSize: pageSize, pageList: [pageSize],
            resize: function () {
                return {
                    height: $(document.body).height() - 70,
                    width: $(document.body).width()-5
                };
            },
            columns: {
                param: {FunctionCode: 'TD_MANUAL_NO_LIST'},
                alter: {
                    NO_STATUS: {
                        formatter: function (value) {
                            return PAGE_DATA['noStatus'][value];
                        }
                    },
                    SB_NO: {
                        formatter: function (value, row, index) {
                            var sta = row.NO_STATUS;
                            var refPkid = row.PKID;
                            var operation = "";
                            if(sta == 'WSB'){
                                operation = 'edit';
                            }else{
                                operation = 'view';
                            }
                            return '<a href="javascript:void(0);" onclick="noEffList(\'' + operation + '\',\'' + refPkid + '\')">' + value + '</a>';
                        },
                    }
                }
            },
            contextMenus: [
                {
                    id: "m-edit",
                    i18nText: "升版",
                    auth: "",
                    onclick: function () {
                        var rowData = getDG('dg2').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        upgrade(rowData);
                    }
                },
            ],
            onDblClickRow: function (index, field, row) {
                var refPkid = row.PKID;
                noEffList('view', refPkid);
            },
            validAuth: function (row, items) {
                if (row.NO_STATUS != "WSB") {
                    items['升版'].enable = false;
                }
                return items;
            }
        });
    }

    function InitDataGrid3() {
        var pageSize = Math.floor(($(document.body).height() - $("fieldset").height() - 185) / 50);
        $("#dg3").MyDataGrid({
            identity: "dg3",
            sortable: true,
            singleSelect: true,
            queryParams: {},
            pageSize: pageSize, pageList: [pageSize],
            resize: function () {
                return {
                    height: $(document.body).height() - 70,
                    width: $(document.body).width()-5
                };
            },
            columns: {
                param: {FunctionCode: 'TD_MANUAL_EVA_LIST'},
                alter: {
                    REV_STATUS: {
                        formatter: function (value) {
                            return PAGE_DATA['evaStatus'][value];
                        }
                    },
                }
            },
            contextMenus: [
                {
                    id: "m-edit",
                    i18nText: "评估",
                    auth: "",
                    onclick: function () {
                        var rowData = getDG('dg3').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        recEva('edit',rowData.PKID,rowData.OEM_CHANGE_TYPE);
                    }
                },
            ],
            onDblClickRow: function (index, field, row) {
                var refPkid = row.PKID;
                var oemChangeType = row.OEM_CHANGE_TYPE;
                recEva('view', refPkid,oemChangeType);
            },
            validAuth: function (row, items) {
                if (row.REV_STATUS != "PGZ") {
                    items['评估'].enable = false;
                }
                return items;
            }
        });
    }


    function sync() {
        MaskUtil.mask("正在同步...");
        InitFuncCodeRequest_({
            data: {FunctionCode: "TD_CMP_NOTICE_SYNC"},
            successCallBack: function (jdata) {
                MaskUtil.unmask();
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    $("#dg2").datagrid("reload");
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //新飞机引进未升级手册清单
    function initNewacManual() {
        InitFuncCodeRequest_({
            data: {
                domainCode: "DA_ACREG_ACNO2",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //机队
                    $('#newAcno').combobox({
                        panelHeight: '100px',
                        data: jdata.data.DA_ACREG_ACNO2,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (item) {
                            var acid = item.VALUE;
                            setCompanyCodeValue(acid);
                        }
                    });
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function setCompanyCodeValue(acid) {
        InitFuncCodeRequest_({
            data: {acid: acid, FunctionCode: 'DA_ACREG_HISTORY_DIC'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data.length > 0) {
                        $("#companyCode").textbox('setValue', jdata.data[0].VALUE);
                        companyCode3 = jdata.data[0].VALUE;
                        InitDataGridNewacManual();
                    }

                }
            }
        });
    }


    function checkQua(rowData) {
        InitFuncCodeRequest_({
            data: {pkid: rowData.PKID, taskType: "SMJC", FunctionCode: 'TD_JC_CHECK_QUA'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    eflag = jdata.data.eflag;
                    ifQua = jdata.data.ifQua;
                    var tips = '';
                    if (eflag == "NO") {
                        tips = "当前用户没有该工卡的资质，请提交给有资质的用户！";
                    }
                    if (eflag == "ALL") {
                        //校验编写期限是否到期
                        var curJcWriteLimit = rowData.WRITE_LIMIT;
                        InitFuncCodeRequest_({
                            data: {curJcWriteLimit: curJcWriteLimit, FunctionCode: "TD_CHECK_WRITE_LIMIT_IF_EXPIRE"},
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    if (!confirm("确认提交该记录？")) {
                                        return;
                                    }
                                    datas = $.extend({}, {}, {FunctionCode: 'TD_JC_ALL_SMJC_STATUS', pkid: rowData.PKID});
                                    InitFuncCodeRequest_({
                                        data: datas, successCallBack: function (jdata) {
                                            if (jdata.data == null) {
                                                common_add_edit_({
                                                    identity: '',
                                                    isEdit: '',
                                                    width: 520,
                                                    height: 300,
                                                    title: $.i18n.t('选择审批人'),
                                                    param: {
                                                        roleId: '',
                                                        otherParam: rowData.PKID,
                                                        FunctionCode_: 'TD_JC_ALL_SMJC_SUMBIT',
                                                        successCallback: reload_,
                                                        flowKey: "tdSmjcFlow"
                                                    },
                                                    url: "/views/em/workflow/work_flow_account_select.shtml"
                                                });
                                            } else {
                                                MsgAlert({content: "该数据已被提交过了。", type: 'error'});
                                            }
                                        }
                                    });
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        })
                    } else {
                        $.messager.confirm('', tips, function (r) {
                            if (r) {
                                ShowWindowIframe({
                                    width: 550,
                                    height: 250,
                                    title: "联合评估",
                                    param: {
                                        pkid: rowData.PKID,
                                        ata: rowData.ATA,
                                        fleet: rowData.FLEET,
                                        cflag: "commit",
                                        fluflag: "list",
                                        taskType: "SMJC",
                                        accountId: accountId,
                                        ifQua: ifQua,
                                        eflag: eflag
                                    },
                                    url: '/views/td/jobcard/smjc/smjcedit/tdJcTrans.shtml'
                                });
                            }
                        });
                    }
                } else {
                    MsgAlert({content: $.i18n.t(jdata.msg), type: 'error'});
                }
            }
        });
    }

    function turnTdJc(row) {
        var evaManId = row.WRITER;
        var pkid = row.PKID;
        var cflag = "turn";
        ShowWindowIframe({
            width: 550,
            height: 250,
            title: "驳回",
            param: {
                accId: evaManId,
                pkid: pkid,
                cflag: cflag,
                fluflag: "list",
                ata: row.ATA,
                fleet: row.FLEET,
                ifQua: "N",
                taskType: "SMJC",
                accountId: accountId
            },
            url: '/views/td/jobcard/smjc/smjcedit/tdJcTrans.shtml'
        });
    }

    function transTdJc(row) {
        var evaManId = row.WRITER;
        var pkid = row.PKID;
        var cflag = "zf";
        ShowWindowIframe({
            width: 550,
            height: 250,
            title: "转发",
            param: {
                accId: evaManId,
                pkid: pkid,
                cflag: cflag,
                fluflag: "list",
                ata: row.ATA,
                fleet: row.FLEET,
                taskType: "SMJC",
                accountId: accountId
            },
            url: '/views/td/jobcard/smjc/smjcedit/tdJcTrans.shtml'
        });
    }

    function tranHis(pkid) {
        var title_ = $.i18n.t('办理轨迹列表');
        ShowWindowIframe({
            width: "790",
            height: "519",
            title: title_,
            param: {pkid: pkid},
            url: "/views/td/jobcard/smjc/smjcedit/tdJcTransList.shtml"
        });
    }

    function reload_all() {
        $("#dg1").datagrid("reload");
        $("#dg2").datagrid("reload");
    }

    function turnEvalAct(row) {
        var pkid = row.PKID;
        var objNo = pkid;
        var objKey = "TD_JC_ALL";
        var taskId = "";
        var procInstId = "";
        $.messager.confirm('提示?', "是否确认退回?", function (r) {
            if (r) {
                MaskUtil.mask("请求处理中...");
                InitFuncCodeRequest_({
                    data: {
                        FunctionCode: 'WS_FLOW_EXECUTION_QUERY',
                        objNo: objNo,
                        objKey: objKey
                    },
                    async: false,
                    successCallBack: function (jdata) {
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                            taskId = jdata.data["TASK_ID"];
                            procInstId = jdata.data["PROC_INST_ID_"];
                            InitFuncCodeRequest_({
                                data: {pkid: pkid, procInstId: procInstId, FunctionCode: 'TD_SMJC_TURN_ACT'},
                                async: false,
                                successCallBack: function (jdata) {
                                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                        MaskUtil.unmask();
                                        reload_();
                                        MsgAlert({content: '操作成功!'});
                                    } else {
                                        MaskUtil.unmask();
                                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                                    }
                                }
                            });
                        }
                    }
                });
            }
        });
    }

    function hints(mgs) {
        ShowWindowIframe({
            width: 320,
            height: 300,
            param: {mgs: mgs},
            title: "工卡提示",
            url: "/views/td/jobcard/commonjc/TdHints.shtml"
        });
    }

    //查询方法
    function onSearchFor(identity, fromId, breforSearch) {
        fromId = fromId || "#ffSearch1";
        var dgopt = getDgOpts(identity);
        var $dg = $(dgopt.owner);
        var url = dgopt.url;
        if ($dg && url) {
            var queryParams = $(fromId).serializeObject();
            queryParams = $.extend({}, dgopt.queryParams, dgopt._params, queryParams);
            if (typeof(breforSearch) == 'function') {
                breforSearch(queryParams);
            }
            clearAdvancedQueryData(queryParams);
            if (dgopt.treeField) {
                $dg.treegrid('load', queryParams);
            } else {
                $dg.datagrid('load', queryParams);
            }
        }
    }

    function onSearchForEffect(identity, fromId, breforSearch) {
        fromId = fromId || "#ffSearch1";
        var dgopt = getDgOpts(identity);
        var $dg = $(dgopt.owner);
        var url = dgopt.url;
        if ($dg && url) {
            var queryParams = $(fromId).serializeObject();
            queryParams = $.extend({}, dgopt.queryParams, dgopt._params, queryParams);
            if (typeof(breforSearch) == 'function') {
                breforSearch(queryParams);
            }
            clearAdvancedQueryData(queryParams);
            if (dgopt.treeField) {
                $dg.treegrid('load', queryParams);
            } else {
                $dg.datagrid('load', queryParams);
            }
        }
    }

    function onSearchForNoEffect(identity, fromId, breforSearch) {
        fromId = fromId || "#ffSearch2";
        var dgopt = getDgOpts(identity);
        var $dg = $(dgopt.owner);
        var url = dgopt.url;
        if ($dg && url) {
            var queryParams = $(fromId).serializeObject();
            queryParams = $.extend({}, dgopt.queryParams, dgopt._params, queryParams);
            if (typeof(breforSearch) == 'function') {
                breforSearch(queryParams);
            }
            clearAdvancedQueryData(queryParams);
            if (dgopt.treeField) {
                $dg.treegrid('load', queryParams);
            } else {
                $dg.datagrid('load', queryParams);
            }
        }
    }

    function reload_manual_upgrade() {
        $("#dg2").datagrid('reload');
    }


    function noEffList(operation,refPkid) {
        ShowWindowIframe({
            width: "1188",
            height: "636",
            title: "未受影响工卡清单",
            param: {operation: operation,refPkid: refPkid,name:name,accountId:accountId},
            url: "/views/td/jobcard/manualUpgrade/revEval/rev_eval_noeff.shtml"
        });
    }

    function affectList(refPkid) {
        ShowWindowIframe({
            width: "1188",
            height: "636",
            title: "受影响工卡清单",
            param: {refPkid: refPkid,name:name,accountId:accountId},
            url: "/views/td/jobcard/manualUpgrade/revEval/rev_eval_affect.shtml"
        });
    }

    //整体升版
    function upgrade(row){
        MaskUtil.mask("数据请求中...");
        var pkid = row.PKID;
        InitFuncCodeRequest_({
            data: {
                pkid: pkid,
                FunctionCode: 'TD_JC_MANUAL_UPGRADE'
            },
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MaskUtil.unmask();
                    reload_manual_upgrade();
                    MsgAlert({content: '操作成功!'});
                } else {
                    MaskUtil.unmask();
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    function recEva(operation,refPkid,oemChangeType){
        ShowWindowIframe({
            width: "1188",
            height: "636",
            title: "工卡改版评估",
            param: {operation: operation,refPkid: refPkid,oemChangeType:oemChangeType,name:name,accountId:accountId},
            url: "/views/td/jobcard/manualUpgrade/revEval/rev_eval_edit.shtml"
        });
    }
</script>
</body>
</html>