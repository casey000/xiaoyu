<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title data-i18n="">补充手册发布</title>
    <style type="text/css">
        /*td, th {*/
        /*padding: 3px;*/
        /*}*/

        ul {
            width: 770px;
        }

        li {
            float: right;
            padding: 5px;
        }

        span {
            color: #0c2e58;
            text-align: right;
            font-weight: bold;
        }

        l-btn-left l-btn-icon-left {
            padding-left: 5px;
        }

        .p-title {
            width: 60px;
            text-align: right;
        }

        button {
            width: 45px;
            height: 20px;
            margin-left: 3px;
            vertical-align: middle;
            border: 1px solid #cfcfcf;
            -moz-border-radius: 5px;
            border-radius: 5px;
            backgroud: #d5d5d5;
            letter-spacing: 20px;
        }
    </style>
</head>
<body class="ibody">

<!--<div id="tt" class="easyui-tabs" style="width:100%; height: 100%">-->
<!--<fieldset class="fieldset_eui">-->
<form id="mform" class="form-horizontal">
    <input type="hidden" id="pkid" name="pkid"/>
    <table class="table table-bordered table-info">
        <tr>
            <th class="th" style="width:80px;" align="right">片段编号：</th>
            <td class="td5" style="width:380px;">
                <input class="easyui-textbox" id="chapter" data-options="editable:false,onlyview:true"
                       name="chapter"
                       style="width:50px;"/>
                -
                <input class="easyui-textbox" id="section" data-options="editable:false,onlyview:true"
                       name="section"
                       style="width:50px;"/>
                -
                <input class="easyui-textbox" id="subject" data-options="editable:false,onlyview:true"
                       name="subject"
                       style="width:50px;"/>
                -
                <input class="easyui-textbox" id="pgblock" data-options="editable:false,onlyview:true"
                       name="pgblock"
                       style="width:50px;"/>
                -
                <input class="easyui-textbox" id="function" data-options="editable:false,onlyview:true"
                       name="function"
                       style="width:50px;"/>
                -
                <input class="easyui-textbox" id="seq" data-options="editable:false,onlyview:true" name="seq"
                       style="width:50px;"/>
            </td>

            <th class="th" style="width:80px;" align="left">是否生效：</th>
            <td class="td5">
                <input class="easyui-combobox" id="active" name="active"
                       data-options="editable:false,onlyview:true" style="width:100%;"/>
            </td>
            <th class="th" style="width:80px;" align="right">机型：</th>
            <td class="td5">
                <input class="easyui-combobox" id="fleet" data-options="editable:false,onlyview:true"
                       name="fleetType"
                       style="width:100%;"/>
            </td>

        </tr>
        <tr>
            <th class="th" style="width:80px;" align="right">手册标题：</th>
            <td class="td5" colspan="5">
                <input class="easyui-textbox" id="dataTitle" data-options="multiline:true,events:{blur:upper}"
                       style="width:100%;height:80px" name="dataTitle"/>
            </td>
        </tr>
        <tr>
            <th class="th" style="width:80px;" align="left">编写方式：</th>
            <td class="td5">
                <input class="easyui-combobox" id="dealOption" name="dealOption" data-options="editable:true"
                />
            </td>
            <th class="th" style="width:80px;" align="right">来源文件编号：</th>
            <td class="td5">
                <input class="easyui-textbox" id="sourceDataNo" name="sourceDataNo" data-options=""
                       style=""/>
            </td>
            <th class="th" style="width:80px;" align="left">手册类型：</th>
            <td class="td5">
                <input class="easyui-combobox" id="dataType" name="dataType"
                       data-options="editable:false,onlyview:true" style="width:100%;"/>
            </td>
        </tr>
        <tr>
            <td colspan="6" align="right">

                <input id="subBtn" class="btn btn-primary" type="button" onclick="publishSupple()" value="发布"
                       style="width: 50px;margin:10px;"/>
            </td>
        </tr>
    </table>
</form>
<!--</fieldset>-->
<!--</div>-->
<script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var PAGE_DATA = {};
    var param;
    var operation;
    var pkid = "";
    var cepid = "";
    var isFlow = "";
    var taskCode = "";
    var dealOption;
    var global = null;
    var dataType;
    var userName = "";
    var diffURL;

    function i18nCallBack() {

        //绑定回车查询事件
        param = getParentParam_();
        operation = param.operation;
        pkid = param.pkid;
        cepid = param.cepid;
        isFlow = param.isFlow;
        taskCode = param.taskCode;
        if (typeof(isFlow) != "undefined" && isFlow != null && isFlow != "" && isFlow == "true") {
            $("#subBtn").hide();
            $("#closeBtn").hide();
            userName = param.userName;
        } else {
            var userInfo = getLoginInfo();
            userName = userInfo.userName;
        }
        InitFuncCodeRequest_({
            data: {
                domainCode: "TD_EFFECT_TYPE,DA_FLEET,DM_DATA_TYPE,DEAL_OPTION,SUPPLEMENT_STATUS,TD_SUPPLEMENT_CHECK_OUT,SUPPLEMENT_ACTIVE,YESORNO,TD_MANUAL_CONTENT_STATUS",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#dealOption').combobox({
                        panelHeight: '110px',
                        data: jdata.data.DEAL_OPTION,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (data) {
                            // var dealOption = $("#dealOption").combobox('getValue');
                            // ComOrPerChange(dealOption);
                        }
                    });
                    $('#active').combobox({
                        panelHeight: '110px',
                        data: jdata.data.SUPPLEMENT_ACTIVE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    PAGE_DATA['effectType'] = DomainCodeToMap_(jdata.data["TD_EFFECT_TYPE"]);
                    PAGE_DATA['status'] = DomainCodeToMap_(jdata.data["YESORNO"]);
                    PAGE_DATA['isEffective'] = DomainCodeToMap_(jdata.data["TD_MANUAL_CONTENT_STATUS"]);
                    InitDataForm(pkid);


                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

    }

    function ComOrPerChange(dealOption) {
        // $("#upload").hide();
        // if (dealOption == "unstructured") {
        //     InitDataGrid2(pkid);
        //     $("#upload").show();
        // }
        // if (dealOption == "structured") {
        //     // upCheckOut();
        //     InitDataGrid();
        //     $("#upload").hide();
        // }
        //
        // if(operation == "view"){
        //     $("#upload").hide();
        //     $("#saveBtn").hide();
        //     $("#closeBtn").hide();
        //     $("#subBtn").hide();
        //     $('#dealOption').combobox({onlyview: true, editable: false});
        // }
    }

    function afterUploadFile() {
        ComOrPerChange(dealOption);
    }

    function callbackCheckin(pkid) {
        $('#btnEdit').linkbutton("enable");//编辑
        $('#btnCheckIn').linkbutton("disable");//检入
        $('#btnCancel').linkbutton("disable");//取消
    }


    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "TD_SUPPLEMENT_BY_PKID"}, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);

                    global = jdata.data;
                    dataType = jdata.data.DATA_TYPE;
                    cepid = jdata.data.CEPID;
                    taskCode = jdata.data.TASK_CODE;
                    $('#fleet').combobox({value: jdata.data.FLEET});
                    $('#dealOption').combobox({value: jdata.data.DEAL_OPTION});
                    dealOption = jdata.data.DEAL_OPTION;
                    ComOrPerChange(jdata.data.DEAL_OPTION);
//                    if ($($("#chapter").textbox('getValue') != null && $("#chapter").textbox('getValue') != "" && $("#chapter").textbox('getValue') != undefined)) {
//                        taskcode = $("#chapter").textbox('getValue');
//                    }
//                    if ($("#section").textbox('getValue') != null && $("#section").textbox('getValue') != "" && $("#section").textbox('getValue') != undefined) {
//                        taskcode = taskcode + "-" + $("#section").textbox('getValue');
//                    }
//                    if ($("#subject").textbox('getValue') != null && $("#subject").textbox('getValue') != "" && $("#subject").textbox('getValue') != undefined) {
//                        taskcode = taskcode + "-" + $("#subject").textbox('getValue');
//                    }
//                    if ($("#pgblock").textbox('getValue') != null && $("#pgblock").textbox('getValue') != "" && $("#pgblock").textbox('getValue') != undefined) {
//                        taskcode = taskcode + "-" + $("#pgblock").textbox('getValue');
//                    }
//                    if ($("#function").textbox('getValue') != null && $("#function").textbox('getValue') != "" && $("#function").textbox('getValue') != undefined) {
//                        taskcode = taskcode + "-" + $("#function").textbox('getValue');
//                    }
//                    if ($("#seq").textbox('getValue') != null && $("#seq").textbox('getValue') != "" && $("#seq").textbox('getValue') != undefined) {
//                        taskcode = taskcode + "-" + $("#seq").textbox('getValue');
//                    }

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //打开附件编辑页面
    function openAttachmentDetail(pkid, effect, dataTitle, effectType) {
        var fleet = $('#fleet').combobox("getValue");
        var title_ = $.i18n.t('附件资料编辑');
        ShowWindowIframe({
            width: "690",
            height: "290",
            title: title_,
            param: {effect: effect, pkid: pkid, dataTitle: dataTitle, effectType: effectType, fleet: fleet},
            url: "/views/td/rev/attachmentDetail.shtml"
        });
    }

    //刷新
    function reload_() {
        // $("#dg").datagrid("reload");
        InitDataGrid();
    }

    function reloadNew(taskCode2) {
        taskCode = taskCode2;
        InitDataForm(pkid);
        $("#dg").datagrid("reload");
    }

    function upper() {
        var title = $(this).val();
        title = title.toUpperCase();
        $("#dataTitle").textbox('setValue', title);
    }

    //刷新
    function reload_par() {
        getParentParam_().OWindow.reload_();
        window.close();
    }

    //刷新
    function reload_par() {
        getParentParam_().OWindow.reload_();
        window.close();
    }

    //发布
    function publishSupple() {
        if (!confirm("确认发布?")) {
            return;
        }
        ajaxLoading();
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: 'TD_SUPPLEMENT_PUBLISH'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //关闭待办
                    // InitFuncCodeRequest_({
                    //     data: {pkid: pkid, FunctionCode: 'TD_SUPPLEMENT_CLOSE_MSG_QUA'},
                    //     successCallBack: function (jdata) {
                    //         if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ajaxLoadEnd();
                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    reload_par();
                    // } else {
                    //     MsgAlert({content: jdata.msg, type: 'error'});
                    // }
                    //     }
                    // });

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }
</script>
</body>
</html>