<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title data-i18n="">SRM手册编写</title>
    <style type="text/css">
        /*td, th {*/
            /*padding: 3px;*/
        /*}*/

        ul {
            width: 770px;
        }

        li {
            float: right;
            padding: 5px;
        }

        span{
            color: #0c2e58;
            text-align: right;
            font-weight: bold;
        }

        l-btn-left l-btn-icon-left{
            padding-left: 5px;
        }

        .p-title {
            width: 60px;
            text-align: right;
        }

        button {
            width: 45px;
            height: 20px;
            margin-left: 3px;
            vertical-align: middle;
            border: 1px solid #cfcfcf;
            -moz-border-radius: 5px;
            border-radius: 5px;
            backgroud: #d5d5d5;
            letter-spacing:20px;
        }
    </style>
</head>
<body class="ibody">

<div id="tt" class="easyui-tabs" style="width:100%; height: 100%">
    <fieldset class="fieldset_eui">
        <form id="mform" class="form-horizontal">
            <input type="hidden" id="pkid" name="pkid"/>
            <input type="hidden" id="rev" name="rev"/>
            <table class="table table-bordered table-info">
                <tr>
                    <th class="th" style="width:80px;" align="right">片段编号：</th>
                    <td class="td5" style="width:380px;">
                        <input class="easyui-textbox" id="chapter" data-options="editable:true,onlyview:false,required:true"
                               name="chapter"
                               style="width:50px;"/>
                        -
                        <input class="easyui-textbox" id="section" data-options="editable:true,onlyview:false"
                               name="section"
                               style="width:50px;"/>
                        -
                        <input class="easyui-textbox" id="subject" data-options="editable:true,onlyview:false"
                               name="subject"
                               style="width:50px;"/>
                        -
                        <input class="easyui-textbox" id="pgblock" data-options="editable:true,onlyview:false"
                               name="pgblock"
                               style="width:50px;"/>
                        -
                        <input class="easyui-textbox" id="function" data-options="editable:true,onlyview:false"
                               name="function"
                               style="width:50px;"/>
                        -
                        <input class="easyui-textbox" id="seq" data-options="editable:true,onlyview:false" name="seq"
                               style="width:50px;"/>
                    </td>
                    <th class="th" style="width:80px;" align="left">是否生效：</th>
                    <td class="td5">
                        <input class="easyui-combobox" id="active" name="active"
                               data-options="editable:true,onlyview:false,required:true" style="width:100%;"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" style="width:80px;" align="right">机型：</th>
                    <td class="td5">
                        <input class="easyui-combobox" id="fleet" name="fleet" data-options="editable:true,onlyview:false,required:true" name="fleetType" style="width:100%;"/>
                    </td>
                    <th class="th" style="width:80px;" align="left">子机型：</th>
                    <td class="td5">
                        <input class="easyui-combobox" id="subFleet" name="subFleet" data-options="editable:true,onlyview:false,required:true" name="subFleetType" style="width:100%;"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" style="width:80px;" align="right">手册标题：</th>
                    <td class="td5" colspan="5" >
                        <input class="easyui-textbox" id="dataTitle" data-options="multiline:true,events:{blur:upper}"
                               style="width:100%;height:80px" name="dataTitle"/>
                    </td>
                </tr>
                <tr>
                    <th class="th" style="width:80px;" align="left">编写方式：</th>
                    <td  class="td5" >
                        <!--<input class="easyui-combobox" id="dealOption" name="dealOption" data-options="editable:true"/>-->
                        <input class="easyui-combobox" id="dealOption" name="dealOption" data-options="editable:true"
                        />

                    </td>
                    <th class="th" style="width:80px;" align="right">来源文件编号：</th>
                    <td class="td5">
                        <input class="easyui-combobox" id="sourceDataNo" name="sourceDataNo" data-options="required:true"
                               style=""/>
                    </td>
                    <th class="th" style="width:80px;" align="left">手册类型：</th>
                    <td class="td5">
                        <input class="easyui-combobox" id="dataType" name="dataType" data-options="editable:true"
                              />
                    </td>
                </tr>
                <tr>
                    <td colspan="6" align="right">
                        <input id="saveBtn" class="btn btn-primary" type="button" onclick="save()" value="保存"
                               style="width: 50px;margin:10px;"/>
                        <input id="upload" class="btn btn-primary" type="button" onclick="uploadFile()" value="上传" style="width: 50px;margin:10px;"/>
                        <input id="subBtn" class="btn btn-primary" type="button" onclick="submitSupple()" value="提交"
                               style="width: 50px;margin:10px;"/>
                        <input class="btn btn-primary" type="button" id = "closeBtn" onclick="CloseWindowIframe();" value="关闭"
                               style="width: 50px;margin:10px;"/>
                    </td>
                </tr>
            </table>
        </form>
        <table id="dg"></table>
    </fieldset>
    <table class="table table-bordered table-info xmclass" style="margin-top: 10px">
        <tr>
            <th class="tdl" style="width: 100px">是否发起重评：</th>
            <td>
                <select class="easyui-combobox"   style="width: 120px;" id="ifDrRepeat" name="ifDrRepeat"  data-options="editable:false,panelHeight:'auto',onSelect: function(val){saveDrRepeat(val)}">
                    <option value="N">否</option>
                    <option value="Y">是</option>
                    <option value="U">不涉及</option>
                </select>
            </td>
            <td class="tdr">
                <input style="margin-right: 30px" class="btn btn-primary" type="button" id="relationDr" onclick="openDrListGrid()"
                       value="关联损伤"/>
            </td>
        </tr>
    </table>

</div>
<script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var PAGE_DATA = {};
    var param;
    var operation;
    var pkid = "";
    var cepid = "";
    var isFlow="";
    var taskCode = "";
    var dealOption;
    var global=null;
    var dataType;
    var userName = "";
    var diffURL;
    var oemTaskCode;
    var rev;
    function i18nCallBack() {
        console.log("123-----");
        param = getParentParam_();
        operation = param.operation;
        version=param.version;
        pkid = param.pkid;
        cepid = param.cepid;
        isFlow=param.isFlow;
        flag=param.flag;
        taskCode = param.taskCode;
        console.log(operation)
        if(isFlow=="true"){
            $("#subBtn").hide();
            $("#closeBtn").hide();
            userName = param.userName;
        } else {
            var userInfo = getLoginInfo();
            userName = userInfo.userName;
        }
        console.log(flag)
        if(flag=="editRepeat"){
            $('#ifDrRepeat').combobox({onlyview: false, editable: true});
        }else{
            $('#ifDrRepeat').combobox({onlyview: true, editable: false});
        }
        InitFuncCodeRequest_({
            data: {
                domainCode: "TD_EFFECT_TYPE,DA_FLEET,DA_SUB_FLEET,DM_DATA_TYPE,DEAL_OPTION,SUPPLEMENT_STATUS,TD_SUPPLEMENT_CHECK_OUT,SUPPLEMENT_ACTIVE,YESORNO,TD_MANUAL_CONTENT_STATUS",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#dealOption').combobox({
                        panelHeight: '110px',
                        data: [{TEXT:'上传附件',VALUE:'unstructured',selected:true}],
                        valueField: 'VALUE',
                        textField: 'TEXT',
                    });
                    // //手册类型
                    $('#dataType').combobox({
                        panelHeight: '110px',
                        data: [{TEXT:'SRM',VALUE:'SRM',selected:true}],
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });

                    //机型
                    $('#fleet').combobox({
                        panelHeight: '80px',
                        data: jdata.data.DA_FLEET,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (data) {
                            initSubFleet(data.TEXT,"");
                        }
                    });
                    //子机型
                    $('#subFleet').combobox({
                        panelHeight: '80px',
                        data: jdata.data.DA_SUB_FLEET,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function () {
                            selectSouceNo();
                        }
                    });
                    //是否有效
                    $('#active').combobox({
                        panelHeight: '110px',
                        data: jdata.data.SUPPLEMENT_ACTIVE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });

                    PAGE_DATA['effectType'] = DomainCodeToMap_(jdata.data["TD_EFFECT_TYPE"]);
                    PAGE_DATA['status'] = DomainCodeToMap_(jdata.data["YESORNO"]);
                    PAGE_DATA['isEffective'] = DomainCodeToMap_(jdata.data["TD_MANUAL_CONTENT_STATUS"]);

                    // if (param.pkid) {
                    //     InitDataForm(param.pkid);
                    // }else{
                    //     $("#upload").hide()
                    //     $("#subBtn").hide()
                    // }
                    $('#dealOption').combobox({onlyview: true, editable: false});
                    $('#dataType').combobox({onlyview: true, editable: false});
                    //save是新增？
                    if(operation == "save"){
                        $("#upload").hide()
                        $("#subBtn").hide()
                    }
                    if(operation == "edit"){
                        if(version>0){
                            $('#rev').val('Y');
                            $('#sourceDataNo').combobox({onlyview: true, editable: false});
                            $('#fleet').combobox({onlyview: true, editable: false});
                            $('#subFleet').combobox({onlyview: true, editable: false});
                            $('#active').combobox({onlyview: true, editable: false});
                            $('#chapter').textbox({onlyview: true, editable: false});
                            $('#section').textbox({onlyview: true, editable: false});
                            $('#subject').textbox({onlyview: true, editable: false});
                            $('#pgblock').textbox({onlyview: true, editable: false});
                            $('#function').textbox({onlyview: true, editable: false});
                            $('#seq').textbox({onlyview: true, editable: false});
                        }
                        InitDataForm(param.pkid);
                    }
                    if(operation == "view"){
                        $("#upload").hide();
                        $("#saveBtn").hide();
                        $("#closeBtn").hide();
                        $("#subBtn").hide();
                        $('#sourceDataNo').combobox({onlyview: true, editable: false});
                        $('#dataTitle').textbox({onlyview: true, editable: false});
                        $('#fleet').combobox({onlyview: true, editable: false});
                        $('#subFleet').combobox({onlyview: true, editable: false});
                        $('#active').combobox({onlyview: true, editable: false});
                        $('#chapter').textbox({onlyview: true, editable: false});
                        $('#section').textbox({onlyview: true, editable: false});
                        $('#subject').textbox({onlyview: true, editable: false});
                        $('#pgblock').textbox({onlyview: true, editable: false});
                        $('#function').textbox({onlyview: true, editable: false});
                        $('#seq').textbox({onlyview: true, editable: false});
                        InitDataForm(param.pkid);
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }



            }
        });
    }

    //保存是否重评
    function saveDrRepeat(select){
        var datas = {
            "pkid":pkid,
            "ifDrRepeat":select.value,
        };
        InitGatewayRequest_({
            type: "post",
            async: false,
            data: datas,
            path: "/online-manual/supplement/update",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    MsgAlert( { content : $.i18n.t('msg_err:ERRMSG.COMMON.COMMON.OPT_SUCCESS')  });
                }
            }
        });
    }

    //打开关联损伤列表
    function openDrListGrid() {
        var title_ = $.i18n.t("关联损伤列表");
        ShowWindowIframe({
            width: "800",
            height: "460",
            title:title_,
            param: {subFleet: global.subFleet,taskCode:taskCode},
            url: "/views/td/rev/DrList.shtml"
        });
    }

    //上传
    function uploadFile() {
        var fleet = $('#fleet').combobox("getValue");
        if (isEmpty(pkid)) {
            alert("系统错误！");
            return;
        }
        common_uploadFile({
            identity: 'dg',
            param: {
                cat: "supplementEdit",
                srmFlag:true,
                sourceId: pkid,
                successCellBack: "",
                fialCellBack: "",
                fleet: fleet,
                taskCode: taskCode
            }
        });
    }
    function InitDataGrid(pkid) {
        $("#dg").MyDataGrid({
            identity: 'dg',
            sortable: true,
            singleSelect: true,
            pageSize: 15,
            enableLineEdit: true,
            enableCellEdit: true,
            queryParams: {pkid: pkid},
            columns: {
                param: {FunctionCode: 'TD_SUPPLEMENT_DETAIL_PDF'},
                alter: {
                    EFFECT_TYPE: {
                        formatter: function (value) {
                            return PAGE_DATA['effectType'][value];
                        }
                    },
                    /*  DATA_DELETE:{
                          formatter: function (value, row, index) {
                              var treeId="";
                              var pkid=row.PKID;
                              var op = "删除";
                              return '<a href="javascript:deleteFile(\''+pkid+'\');" >' + op + '</a>';
                          }
                      }*/
                }
            },
            onLoadSuccess: function () {
            },
            onEndEdit: function (index, row, changes) {
            },
            onBeginEdit: function (index, row) {
            },
            contextMenus: [
                {
                    id: "m-edit", i18nText: "编辑", auth: "",
                    onclick: function () {
                        var rowData = getDG('dg').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        openAttachmentDetail(rowData.PKID, rowData.DATA_TITLE, rowData.EFFECT_TYPE);

                    }
                },
                {
                    id: "m-del", i18nText: "删除", auth: "",
                    onclick: function () {
                        var rowData = getDG('dg').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        deleteFile(rowData.PKID);

                    }
                },
                {
                    id: "m-view", i18nText: "附件预览", auth: "",
                    onclick: function () {
                        var rowData = getDG('dg').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        var curWwwPath = window.document.location.href;
                        var pathName = window.document.location.pathname;
                        var pos = curWwwPath.indexOf(pathName);
                        var localIp = curWwwPath.substring(0, pos + 1);
                        var pdfurl = localIp + rowData.DATA_URL;
                        console.log(pdfurl);
                        manualPreview(pdfurl);
                    }
                }],

            validAuth: function (row, items) {
                if (operation == "view") {
                    items['删除'].enable = false;
                    items['编辑'].enable = false;
                }

                return items;
            }
        });
    }

    function InitDataForm(pkid) {
        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/online-manual/supplement/selectById/" + pkid,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    ParseFormField_(jdata.obj, $("#mform"));
                    global=jdata.obj;
                    dataType=jdata.obj.dataType;
                    cepid = jdata.obj.cepid;
                    taskCode = jdata.obj.taskCode;
                    oemTaskCode=jdata.obj.oemTaskCode
                    $('#fleet').combobox({value: jdata.obj.fleet});
                    $('#dealOption').combobox({value: jdata.obj.dealOption});
                    InitDataGrid(pkid)
                    initSubFleet(jdata.obj.fleet,jdata.obj.subFleet);
                    selectSouceNo();
                    $('#sourceDataNo').combobox({value: jdata.obj.sourceDataNo});
                    $('#ifDrRepeat').combobox({value: jdata.obj.ifDrRepeat});
                    ifShowDrList(jdata.obj.status);

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }
    function ifShowDrList(status) {
        if(status!=="EDIT" && global.ver>0){
            $(".xmclass").show();
        }else{
            $(".xmclass").hide();
        }
    }
    // 保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        var $form = $("#mform");
        var datas = $form.serializeObject();
        // $('#dealOption').combobox({value: datas.dealOption});
        if(!!datas.pkid){
            InitGatewayRequest_({
                type: "post",
                async: false,
                data: datas,
                path: "/online-manual/supplement/update",
                successCallBack: function (jdata) {
                    if (jdata.success == true) {
                        if(isFlow){
                            MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        }else{
                            if (param.OWindow.onSearch_) {
                                param.OWindow.MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                param.OWindow.reload_();
                                CloseWindowIframe();
                            }
                        }
                    } else {
                        MsgAlert({content: jdata.errorMessage ? jdata.errorMessage : jdata.obj, type: 'error'});
                    }
                }

            });
     }else {
            InitGatewayRequest_({
                type: "post",
                async: false,
                data: datas,
                path: "/online-manual/supplement/addSrmManual",
                successCallBack: function (jdata) {
                    if (jdata.success == true) {
                        if (param.OWindow.onSearch_) {
                            param.OWindow.MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                            param.OWindow.reload_();
                            $("#upload").show();
                            $("#subBtn").show();
                            pkid = jdata.obj.pkid;
                            $('#pkid').val(pkid);
                            InitDataForm(pkid);
                        }
                    } else {
                        MsgAlert({content: jdata.errorMessage ? jdata.errorMessage : jdata.obj, type: 'error'});
                    }
                }
            });
        }

    }

    //提交
    function submitSupple() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        var $form = $("#mform");
        var datas = $form.serializeObject();
        if(global.ver=="0"){//新增
            if(confirm("是否确认发布？")){
                InitGatewayRequest_({
                    type: "post",
                    async: false,
                    data: datas,
                    path: "/online-manual/supplement/srmSubmit",
                    successCallBack: function (jdata) {
                        if(jdata.success == true){
                            param.OWindow.MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                            reload_par();
                            CloseWindowIframe();
                        }else {MsgAlert({content: jdata.msg, type: 'error'});}
                    }
                });
            }
        }else{//改版
            //编辑中
            var data = $.extend({}, {pkId: pkid}, {FunctionCode: "TD_SRM_SUPPLEMENT_SUMBIT"});
            InitFuncCodeRequest_({
                data: data,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        param.OWindow.MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        reload_par();
                        CloseWindowIframe();
                    } else {
                        MsgAlert({content: jdata.msg, type: 'error'});
                    }
                }
            });
        }

    }
    //刷新
    function reload_par() {
        getParentParam_().OWindow.reload_();
        window.close();
    }
    //上传
    function common_uploadFile(edopt) {
        var title_ = $.i18n.t('common:COMMON_OPERATION.UPLOAD');
        ShowWindowIframe({
            width: 690,
            height: 290,
            title: title_,
            param: $.extend({}, edopt.param),
            url: "/views/data_manager/dm/upload/attachment.shtml"
        });
    }
    //打开附件编辑页面
    function openAttachmentDetail(pkid, dataTitle, effectType) {
        var fleet = $('#fleet').combobox("getValue");
        var title_ = $.i18n.t('附件资料编辑');
        ShowWindowIframe({
            width: "690",
            height: "290",
            title: title_,
            param: {pkid: pkid, dataTitle: dataTitle, effectType: effectType, fleet: fleet},
            url: "/views/td/rev/attachmentDetail.shtml"
        });
    }

    function deleteFile(detailPkid) {
        if(!confirm("确认删除?")){
            return;
        }
        InitFuncCodeRequest_({
            data:{pkid:detailPkid,FunctionCode:'TD_SUPPLEMENT_DETAIL_DELETE'},
            successCallBack: function (jdata) {
                if (jdata.code == 200) {
                    InitFuncCodeRequest_({
                        data: {pkid: detailPkid, FunctionCode: 'ATTACHMENT_RSPL_DEL'},
                        successCallBack: function(jdata){
                            if(jdata.code == RESULT_CODE.SUCCESS_CODE){
                                MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                InitDataGrid(pkid);
                            }
                        }
                    });

                }
            }
        });
    }

    function manualPreview(url) {
        var title_ = $.i18n.t('工卡预览 ');
        ShowWindowIframe({
            width: "850",
            height: "650",
            title: title_,
            param: {url: url},
            url: "/views/td/manual/manualPreview.shtml"
        });
    }
    function upper(){
        var title = $(this).val();
        title = title.toUpperCase();
        $("#dataTitle").textbox('setValue', title);
    }
    /**
     *  功能描述: 通过机型获取子机型
     *   applic 大机型
     *  subFleet 子机型
     *  01379392(王大桥)
     *  2020/11/3
     */
    function initSubFleet(applic,subFleet){
        $.ajax({
            type: "get",
            url: "/ee/emFileModelAction/selectAllModel",
            contentType: "application/json;charset=utf-8",
            async: false,
            success: function (result) {
                if(!result || !result.data){
                    return;
                }
                //不是当前机型删除
                if(applic) {
                    var subFleetArr = [];
                    for (var index in result.data) {
                        var model = result.data[index].modelSeries;
                        if (model.indexOf(applic) === -1) {
                            continue;
                        }
                        subFleetArr.push(result.data[index]);
                    }
                    $('#subFleet').combobox({panelHeight: '150px',valueField: 'modelSeries', textField: 'modelSeries',data: subFleetArr});
                }else{
                    $('#subFleet').combobox({panelHeight: '150px',valueField: 'modelSeries', textField: 'modelSeries',data: result.data});
                }
                if(subFleet){
                    $("#subFleet").combobox("setValue",subFleet);
                }

            },
            error: function (data) {
                MsgAlert({content: "机型信息查询失败！", type: 'error'});
            }
        });
    }

    function selectSouceNo() {
        $("#sourceDataNo").combobox("setValue",'');
        var $form = $("#mform");
        var datas = $form.serializeObject();
        InitGatewayRequest_({
            type: "post",
            async: false,
            data:datas,
            path: "/online-manual/supplement/selectSourceNo",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    var item =jdata.obj;
                    // if(!item.length){
                    //     MsgAlert({content: "未匹配到来源文件编号！", type: 'error'});
                    // }else {
                        $('#sourceDataNo').combobox({
                            panelHeight: '110px',
                            data:item,
                            valueField: 'dataNo',
                            textField: 'dataNo',
                        });
                    // }
                }
            }
        })
    }

    function afterUploadFile() {
        ComOrPerChange(dealOption);
    }
    
    function ComOrPerChange(dealOption) {
        $("#upload").hide();
        if (dealOption == "unstructured") {
            InitDataGrid2(pkid);
            $("#upload").show();
        }
        if(operation == "view"){
            $("#upload").hide();
            $("#saveBtn").hide();
            $("#closeBtn").hide();
            $("#subBtn").hide();
            $('#dealOption').combobox({onlyview: true, editable: false});
        }
    }
    //刷新
    function reload_2() {
        $("#dg").datagrid("reload");
    }

</script>
</body>
</html>