<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title data-i18n="">附件信息</title>
</head>
<body class="ibody">

<div class="ibox-content">
    <table class="table table-bordered table-info" id="dg">

        <tr>
            <th class="td5" style="width:110px;text-align: left"> 文件名</th>
            <th class="td5" style="width:110px;text-align: left"> 操作</th>
        </tr>
    </table>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var PAGE_DATA = {};
    var param;
    var operation;
    var namespace;
    var status;
    var pkid;
    function i18nCallBack() {
        param = getParentParam_();
        operation = param.operation;
        namespace = param.namespace;
        pkid=param.pkid;
        status = param.status;
        if (namespace == "emFileEvaluate") {
            viewFile(param.pkid, param.category);
        } else {
            InitDataGrid(param.pkid, param.category);
        }
    }

    function InitDataGrid(pkid, category) {
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: pkid,
                CATEGORY: category,
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                if (operation == "view"||operation == "flowView") {
                    for (var i = 0; i < jdata.data.length; i++) {
                        var trHTML = '<tr align="left"><td class="td5" align="left" style="text-align:left;"><a target="_blank" onclick="downFile(' + jdata.data[i].PKID + ',' + jdata.data[i].PKID + ')">' + jdata.data[i].ORG_NAME + '</a></td></tr>';
                        $("#dg").append(trHTML);//在table最后面添加一行
                    }
                } else {
                    for (var i = 0; i < jdata.data.length; i++) {
                        var trHTML = '<tr align="left"><td class="td5" align="left" style="text-align:left;"><a target="_blank" onclick="downFile(' + jdata.data[i].PKID + ',' + jdata.data[i].PKID + ')">' + jdata.data[i].ORG_NAME + '</a></td><td class="td5" align="left" style="text-align:left;"><input class="btn btn-primary" type="button"  value="删除" style="width: 50px;margin:5px;" onclick="deletePdf(' + jdata.data[i].PKID + ');return false;"/></td></tr>';
                        $("#dg").append(trHTML);//在table最后面添加一行
                        // downFile(jdata.data[i].PKID,jdata.data[i].PKID);
                    }
                }
            }
        });
    }

    function viewFile(pkid, category) {
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: pkid,
                CATEGORY: category,
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {

                for (var i = 0; i < jdata.data.length; i++) {
                    var trHTML = '<tr align="left"><td class="td5" align="left" style="text-align:left;">' +
                        '<a target="_blank" onclick="downFile(' + jdata.data[i].PKID + ',' + jdata.data[i].PKID + ')">' + jdata.data[i].ORG_NAME + '</a></td>' +
                        '</tr>';
                    $("#dg").append(trHTML);//在table最后面添加一行
                }
            }
        });
    }    //删除的时候一块删除业务表的file_path

    function deletePdf(filePkid) {
        if(!confirm("确认删除?")){
            return;
        }
        InitFuncCodeRequest_({
            data: {pkid: filePkid, FunctionCode: 'ATTACHMENT_RSPL_DEL'},
            successCallBack: function(jdata){
                if(jdata.code == RESULT_CODE.SUCCESS_CODE){
                    InitFuncCodeRequest_({
                        data: {
                            pkid: pkid,
                            FunctionCode: 'TD_SUPPLEMENT_INTRODUCTION_DEL_UPLOAD'
                        },
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                if (param.operation=="flowEdit") {
                                    param.OWindow.reload3();
                                    CloseWindowIframe();
                                }else {
                                    param.OWindow.reload_();
                                    CloseWindowIframe();
                                }
                            }else{
                                MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                            }
                        }
                    });
                }
            }
        });
    }
    //刷新
    function reload_() {
        location.reload();
    }

    //查询
    function searchData() {
        onSearch_('dg', '#ffSearch');
    }

    //重置
    function doClear_() {
        $("#ffSearch").form('clear');
        searchData();
    }

</script>
</body>
</html>