<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title data-i18n="">增加DS</title>
</head>
<body class="ibody">

<div id="tt" class="easyui-tabs" style="width:100%; height: 100%">
    <fieldset class="fieldset_eui">
        <form id="mform" class="form-horizontal">
            <input type="hidden" class="easyui-textbox" id="pkid" name="pkid"/>
            <table class="table table-bordered table-info">
                <tr>
                    <th class="th" style="width:80px;" align="left">TASKCODE：</th>
                    <td class="td5">
                        <input class="easyui-textbox" id="taskCode" name="taskCode"
                               data-options="editable:false,required:true"/>
                        <input id="chooseBtn" class="btn btn-primary" type="button" onclick="choose()" value="选取"
                               style="width: 50px;margin:10px;"/>
                    </td>
                    <td align="right">
                        <input id="saveBtn" class="btn btn-primary" type="button" onclick="save()" value="保存"
                               style="width: 50px;margin:10px;"/>
                    </td>
                </tr>
            </table>
        </form>
    </fieldset>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var PAGE_DATA = {};
    var companyCode;
    var param;
    var fleet;
    var dataType;
    var flag;
    var typeFlag;
    var operation;
    var isStructure;
    function i18nCallBack() {
        param = getParentParam_();
        dataType = param.dataType;
        fleet = param.fleet;
        companyCode = param.companyCode;
        pkid = param.pkid;
        flag = param.flag;
        typeFlag = param.typeFlag;
        operation = param.operation;
        isStructure=param.isStructure;

        //绑定回车查询事件
        bindFormonSearch_('#ffSearch', function () {
            searchData()
        });

        InitFuncCodeRequest_({
            data: {
                domainCode: "BOE_TYPE,SUPP_TYPE,DA_FLEET,TD_SUPPLEMENT_CHECK_OUT,TD_SUPPLEMENT_STATUS",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (typeFlag == "BOEING") {
                        $('#dataType').combobox({
                            panelHeight: '110px',
                            data: jdata.data.BOE_TYPE,
                            valueField: 'VALUE',
                            textField: 'TEXT'
                        });

                        PAGE_DATA['dataType'] = DomainCodeToMap_(jdata.data["BOE_TYPE"]);
                    } else if (typeFlag == "SUPPLEMENT") {
                        $('#dataType').combobox({
                            panelHeight: '110px',
                            data: jdata.data.SUPP_TYPE,
                            valueField: 'VALUE',
                            textField: 'TEXT'
                        });

                        PAGE_DATA['dataType'] = DomainCodeToMap_(jdata.data["SUPP_TYPE"]);
                    }
                    //获取CompanyCode
                    InitFuncCodeRequest_({
                        data: {FunctionCode: "COMMON_COMPANY_CODE"},
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                companyCode = jdata.data;
                            }
                        }
                    });

                    if (isStructure=="N"){
                        $("#chooseBtn").hide();
                        $("#taskCode").textbox({editable:true,onlyview:false});

                    }
                    if (pkid) {
                        InitDataForm(pkid);
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

    }

    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas = $.extend({mpkid: pkid}, datas, {FunctionCode: 'TD_REVSUG_DS_ADD'});
        InitFuncCodeRequest_({
            data: datas,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (typeof(isFlow) == "undefined" || isFlow == null || isFlow == "") {
                        $("#pkid").textbox('setValue', jdata.data.pkid);
                        pkid = jdata.data.pkid;
                        MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        param.OWindow.reload_();
                        CloseWindowIframe();
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    function choose() {
        var title_ = $.i18n.t('选取手册');
        if (!dataType) {
            alert("请先在父页面选择参考资料类型");
            return;
        }
        ShowWindowIframe({
            width: 954,
            height: 346,
            title: title_,
            param: {
                manualType: dataType,
                fleet: fleet,
                companyCode: companyCode,
                flag: flag,
                typeFlag: typeFlag
            },
            url: "/views/td/manual/revsug/manualList.shtml"
        });
    }


    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "TD_REVSUG_DS_BY_PKID"}, async: false, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

</script>
</body>
</html>