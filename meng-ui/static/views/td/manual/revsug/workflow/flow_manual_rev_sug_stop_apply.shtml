<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="pm_mplanconf">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title data-i18n="RES.EM_ALLOCATE_RULE.TITLE">手册修改建议单失效</title>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
</head>
<body class="ibody">
<div id="tabs" style="width: 100%; height: 100%;">
    <div id="tab01" title="业务表单数据" style="">
        <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
            <input type="hidden" id="isFirstNode" name="isFirstNode">
            <input type="hidden" id="approvalBy" name="approvalBy">
            <table class="table table-bordered table-info">
                <tr>
                    <br/>
                    <a href="javascript:void(0)" id="fromManualRevsug" onclick="previewManualRevsugInfo()">
                        <span style="font-size: 13px">点击链接可查看建议单相关信息</span>
                    </a><br/><br/>
                    <th data-i18n="" style="width: 100px">建议单编号：</th>
                    <td>
                        <input class="easyui-textbox" name="revsugNo" id="revsugNo"
                               data-options="editable:false,onlyview:true"
                               style="width:150px;"/></td>
                    <th data-i18n="" style="width: 100px">版本：</th>
                    <td colspan="3">
                        <input class="easyui-textbox" name="ver" id="ver" data-options="editable:false,onlyview:true"
                               style="width:150px;"/>
                    </td>
                </tr>
                <tr>
                    <th data-i18n="" style="width: 100px">失效原因：</th>
                    <td colspan="5">
                        <input class="easyui-textbox" name="stopReason" id="stopReason" data-options="multiline:true"
                               style="width:825px;height: 50px;"/>
                    </td>
                </tr>
                <tr>
                    <th data-i18n="" style="width: 100px">申请人：</th>
                    <td>
                        <input class="easyui-textbox" name="applyMan" id="applyMan"
                               data-options="editable:false,onlyview:true"
                               style="width:150px;"/>
                    </td>
                    <th data-i18n="" style="width: 100px">申请日期：</th>
                    <td>
                        <input class="easyui-datebox" name="applyDate" id="applyDate"
                               data-options="editable:false,onlyview:true"
                               style="width:150px;"/>
                    </td>
                    <th data-i18n="" style="width: 100px">状态：</th>
                    <td>
                        <input class="easyui-combobox" name="status" id="status"
                               data-options="editable:false,onlyview:true"
                               style="width:150px;"/>
                    </td>
                </tr>
                <tr id="saveBtn">
                    <td style="height: 30px" colspan="6" align="center">
                        <a class="searchBtn" data-options="iconCls:'icon-search'"
                           data-i18n="" onclick="save()"
                        >保存</a>
                    </td>
                </tr>
            </table>
            <h5 style="margin-bottom: 4px;">流程处理：</h5>
            <input name="taskId" type="hidden"/>
            <table class="table table-bordered table-info">
                <tbody id="custom_options"></tbody>
            </table>
            <table class="table table-bordered table-info" id="mtable">
                <tr>
                    <th class="tdl" style="width: 80px;">处理意见：</th>
                    <td class="tdr">
                        <input id="notes" name="notes" class="easyui-textbox easyui-validatebox"
                               data-options="multiline:true,validType:['maxLength[200]']"
                               style="height:55px; width: 680px;"/>
                    </td>
                    <th id="nextTh" class="tdl xmclass" style="width: 90px">下一级办理人：</th>
                    <td id="nextTd" class="tdr xmclass">
                        <input id="authId" class="easyui-textbox easyui-validatebox"
                               data-options="validType:['maxLength[20]'] " style="height:25px; width:100px;"/>
                    </td>
                </tr>
                <tr>
                    <td colspan="6" align="center">
                        <input id="canSubmit" class="btn" disabled="disabled" type="button" onclick="doSubmit();"
                               value="提交"/>
                        <input id="canReturn" class="btn" disabled="disabled" type="button" onclick="doReturn();"
                               value="退回"/>
                    </td>
                </tr>
            </table>
        </form>
    </div>
    <div title="流程信息" style="">
        <table class="table table-bordered table-info" id="processInfo">
            <tr>
                <th class="tdl" style="width: 145px;">流程业务Key ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="businessKey"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="executionName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="createTime"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程创建人 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="userName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="nodeName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="isJoint"
                           data-options="multiline:true, onlyview: true" style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务-配置 ：</th>
                <td class="tdr" colspan="3" style="vertical-align: middle;">
                    <input type="checkbox" name="canReturn" value="" disabled/> 可退回
                    <input type="checkbox" name="canTrunTo" value="" disabled/> 可转办
                    <input type="checkbox" name="canTerminate" value="" disabled/> 可终结
                    <input type="checkbox" name="canHangUp" value="" disabled/> 可挂起
                </td>
            </tr>
        </table>
        <div id="workflow" style="overflow-x: scroll;"></div>
    </div>
    <div id="tab02" title="历史任务信息" style="">
        <table id="historyDg"></table>
    </div>
</div>
<script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
<script src="formtemplet.js" type="text/javascript"></script>
<script src="/js/datagrid_utils.js" type="text/javascript"></script>
<script type="text/javascript">
    var PAGE_DATA = {};
    var param;
    var pkid;
    var revsugPkid;
    var operation;
    var revsugNo = '';
    var userId = '';
    var evalApplyType = '';

    function InitLoadResource(resource, execution, node) {
        pkid = resource.pkid;
        revsugPkid = resource.revsugPkid;
        userId = getLoginInfo().accountId;
        InitFuncCodeRequest_({
            async: false,
            data: {
                domainCode: "MANUAL_REVSUG_STOP_STATUS",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    PAGE_DATA['status'] = DomainCodeToMap_(jdata.data["MANUAL_REVSUG_STOP_STATUS"]);

                    $('#status').combobox({
                        panelHeight: '140px',
                        data: jdata.data.MANUAL_REVSUG_STOP_STATUS,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });

                    $("#authId").MyComboGrid({
                        idField: 'ACCOUNT_ID',  //实际选择值
                        textField: 'USER_NAME', //文本显示值
                        panelHeight: '180px',
                        required: true,
                        width: 140,
                        params: {userId: userId, FunctionCode: 'FLOW_WORK_ACCOUNT'},
                        columns: [[
                            {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                            {field: 'USER_NAME', title: '审核人', width: 50}
                        ]],
                        onHidePanel: function () {
                            var t = $(this).combogrid('getValue');
                            if (t != null && t != '' & t != undefined) {
                                if (selectRow == null || t != selectRow.ACCOUNT_ID) {//没有选择或者选项不相等时清除内容
                                    alert('请选择，不要直接输入！');
                                    $(this).combogrid({value: ''});
                                }
                            }
                        },
                        onSelect: function (index, row) {
                            selectRow = row;
                            if ('task1598613819383' == node.taskPropId) {//任务退回
                                $("#approvalBy").val(row.ACCOUNT_ID);
                            }
                        }
                    });

                    ParseFormField_(resource, null, null);
                    initForm(pkid);
                    // 控制退回按钮和退回弹窗
                    if ('task1598613819383' == node.taskPropId) {
                        $('#stopReason').textbox({required: true, editable: true, onlyview: false});
                        $("#saveBtn").show();
                        $("#canReturn").hide();
                        $("#isFirstNode").val('N');
                    } else if ('task1598613686103' == node.taskPropId) {     //第一个节点
                        $("#isFirstNode").val('Y');
                        $('#authId').combogrid({required: false});
                        $('#nextTh').hide();
                        $('#nextTd').hide();

                        $('#stopReason').textbox({required: false, editable: false, onlyview: true});
                        $("#saveBtn").hide();
                    } else {
                        $('#stopReason').textbox({required: false, editable: false, onlyview: true});
                        $("#saveBtn").hide();
                        $("#isFirstNode").val('N');
                    }
                }
                else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

    }

    function initForm(pkid) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: 'MANUAL_REVSUG_STOP_PKID'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#revsugNo').textbox('setValue', jdata.data.REVSUG_NO);
                    $('#ver').textbox('setValue', jdata.data.VER);
                    revsugNo = jdata.data.REVSUG_NO;
                }
                else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //保存
    function save() {
        var data = $("#mform").serializeObject();
        if (pkid) {
            data.pkid = pkid;
        }
        data.revsugPkid = revsugPkid;
        data.status = $('#status').combobox('getValue');
        data = $.extend({}, data, {FunctionCode: 'MANUAL_REVSUG_STOP_ADD'});
        MaskUtil.mask("正在处理...");
        InitFuncCodeRequest_({
            async: false,
            data: data,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MaskUtil.unmask();
                    pkid = jdata.data;
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    param.OWindow.reload_();
                }
                else {
                    MaskUtil.unmask();
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //预览手册修改建议单
    function previewManualRevsugInfo() {
        var title_ = $.i18n.t('手册修改建议单编写页面');
        ShowWindowIframe({
            width: "960",
            height: "670",
            title: title_,
            param: {operation: "view", pkid: revsugPkid},
            url: "/views/td/manual/revsug/manualRevsugDetail.shtml"
        });
    }

</script>
</body>
</html>