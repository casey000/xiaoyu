<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="ws_work_flow">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
    <script src="/js/workflow/formtemplet.js" type="text/javascript"></script>
    <script src="/js/datagrid_utils.js" type="text/javascript"></script>
    <title></title>
    <style type="text/css">
        td {
            padding: 3px;
        }

        button {
            width: 45px;
            height: 20px;
            margin-left: 3px;
            vertical-align: middle;
            border: 1px solid #cfcfcf;
            -moz-border-radius: 5px;
            border-radius: 5px;
            backgroud: #d5d5d5;
        }

        .addBtn {
            padding: 1px 10px;
        }
    </style>




</head>
<body class="ibody">

<div id="tabs" style="width: 100%; height: 100%;">
    <div id="tab01" title="业务表单数据" style="">
        <div class="ibox float-e-margins">
            <div class="ibox-content">
                <form class="form-horizontal m-t" id="mform" style="margin-top: 0px;">
                    <input type="hidden" id="isFirstNode" name="isFirstNode">
                    <input type="hidden" id="pkid" name="pkid"/>
                    <input type="hidden" id="reviewedBy" name="reviewedBy"/>
                    <input type="hidden" id="approvedBy" name="approvedBy"/>
                    <input type="hidden" id="dealBy" name="dealBy"/>
                    <input type="hidden" id="checkBy" name="checkBy"/>

                    <div style="height: 640px;">
                        <iframe scrolling="auto" id="iframe01" frameborder="0" src="" style="width:100%;height:100%;"></iframe>
                    </div>


                    <!-- 业务数据展示end-->

                    <h5 style="margin-bottom: 4px;">流程处理：</h5>
                    <input name="taskId" type="hidden" />
                    <table class="table table-bordered table-info"><tbody id="custom_options"></tbody></table>
                    <table class="table table-bordered table-info" id="mtable">
                        <tr>
                            <th class="tdl" style="width: 100px;">处理意见：</th>
                            <td class="tdr">
                                <input id="notes" name="notes" class="easyui-textbox easyui-validatebox"
                                       data-options="multiline:true,validType:['maxLength[200]']" style="height:55px; width: 100%;"/>
                            </td>
                            <th class="tdl xmclass" style="width: 100px">下一级办理人：</th>
                            <td class="tdr xmclass">
                                <input id="authId" name="authId" class="easyui-textbox easyui-validatebox"
                                       data-options="validType:['maxLength[20]'] " style="height:25px; width:150px;"/>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="6" align="center">
                                <input id="canSubmit" class="btn" disabled="disabled" type="button" onclick="checkSubimt()" value="提交"/>
                                <input id="canTrunTo" class="btn" disabled="disabled" type="button" onclick="doTurnTo();" value="转办"/>
                                <input id="canReturn" class="btn" disabled="disabled" type="button" onclick="doReturn();" value="退回"/>
                                <!--<input id="canReturnStart" class="btn" type="button" onclick="javascript: doReturnToStart();"value="退回到办理人"/>-->
                                <!--<input id="canTerminate" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="终止"/>
                                <input id="canHangUp" class="btn" disabled="disabled" type="button" onclick="javascript: ;"value="挂起"/>-->
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
        </div>
    </div>
    <div title="流程信息" style="">
        <table class="table table-bordered table-info" id="processInfo">
            <tr>
                <th class="tdl" style="width: 145px;">流程业务Key ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="businessKey"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程业务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="executionName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程创建时间 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="createTime"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">流程创建人 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="userName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务名称 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="nodeName"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
                <th class="tdl" style="width: 145px;">是否会签任务 ：</th>
                <td class="tdr">
                    <input class="easyui-textbox easyui-validatebox" name="isJoint"
                           data-options="multiline:true, onlyview: true " style="height:25px; width: 60%;"/>
                </td>
            </tr>
            <tr>
                <th class="tdl" style="width: 145px;">流程任务-配置 ：</th>
                <td class="tdr" colspan="3" style="vertical-align: middle;">
                    <input type="checkbox" name="canReturn" value="" disabled/> 可退回
                    <input type="checkbox" name="canTrunTo" value="" disabled/> 可转办
                    <input type="checkbox" name="canTerminate" value="" disabled/> 可终止
                    <input type="checkbox" name="canHangUp" value="" disabled/> 可挂起
                </td>
            </tr>
        </table>
        <div id="workflow" style="overflow-x: scroll;"></div>
    </div>
    <div id="tab02" title="历史任务信息" style="">
        <table id="historyDg"></table>
    </div>
</div>

<script type="text/javascript">
    /**
     *
     * @param resource  业务数据
     * @param execution 流程实例数据
     * @param node 节点配置数据
     * @constructor
     */
    var selectRow=null;
    var flow_node=null;
    var fun = 'FLOW_WORK_ACCOUNT';
    var userInfo = getLoginInfo();
    var userId = userInfo.accountId;
    function InitLoadResource(resource, execution, node){

        pkid = resource.pkid;
        flow_node=node;
        $("#pkid").val(pkid);
        var type="view";

        if ('task1550651318249111' == node.taskPropId || 'task1550644918721' == node.taskPropId) {//当前节点为退回
            type = "back";
        }

        $("#iframe01").attr("src","/views/td/manual/revsug/manualRevsugDetail.shtml?pkid="+pkid+"&operation="+type+"&isFlow=true");


        if ('task1550644778074' == node.taskPropId) {
            fun = "REVSUG_FLOW";
        }
        var roleId = queryNodeRole(pkid, "TD_MANUAL_REVSUG").ROLE_ID;
        //下个审批人选择初始化
        $("#authId").MyComboGrid({
            idField: 'ACCOUNT_ID',  //实际选择值
            textField: 'USER_NAME', //文本显示值
            panelHeight: '180px',
            required: true,
            width: 140,
            queryParams: {userId: userId, pkid: pkid, roleId: roleId},
            params: {FunctionCode: fun},
            columns: [[
                {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                {field: 'USER_NAME', title: '审核人', width: 50}
            ]],
            onHidePanel: function () {
                var t = $(this).combogrid('getValue');
                if(t != null && t != '' & t != undefined){
                    if (selectRow == null || t != selectRow.ACCOUNT_ID) {//没有选择或者选项不相等时清除内容
                        alert('请选择，不要直接输入！');
                        $(this).combogrid({value:''});
                    }
                }
            },
            onSelect: function (index, row) {
                selectRow = row;
                //当前在审核页面中选择下一位审核人
                //BOEING
                if('task1550644918721' == node.taskPropId) {//任务退回提交
                    $("#reviewedBy").val(row.ACCOUNT_ID);
                }else if('task1550643287370' == node.taskPropId){//当前节点为审核，送批准
                    $("#approvedBy").val(row.ACCOUNT_ID);
                }else if('task1550644716529' == node.taskPropId){//当前节点为批准，送资料管理员
                    $("#dealBy").val(row.ACCOUNT_ID);
                }else if('task1550644778074' == node.taskPropId){//当前节点为资料管理员，送复核
                    $("#checkBy").val(row.ACCOUNT_ID);
                }

                //SP
                if('task1550651318249111' == node.taskPropId) {//任务退回提交
                    $("#reviewedBy").val(row.ACCOUNT_ID);
                }else if('task1550651249297111' == node.taskPropId){//当前节点为审核，送批准
                    $("#approvedBy").val(row.ACCOUNT_ID);
                }else if('task1550651285587111' == node.taskPropId){//当前节点为批准，送资料管理员
                    $("#dealBy").val(row.ACCOUNT_ID);
                }

            }
        });

        //BOEING
        if('task1550643287370' == node.taskPropId){     //审核中
            $("#isFirstNode").val('Y');
        }else if('task1550644918721' == node.taskPropId){   // 任务退回
            $("#canReturn").hide();
            $("#isFirstNode").val('N');
        }else if('task1550644716529' == node.taskPropId){   // 批准中
            $("#isFirstNode").val('Y');
        }else if('task1550644778074' == node.taskPropId){   // 资料管理员
            $("#canReturn").hide();
            $("#isFirstNode").val('N');
        }

        //SP
        if('task1550651249297111' == node.taskPropId){     //审核中
            $("#isFirstNode").val('Y');
        }else if('task1550651318249111' == node.taskPropId){   // 任务退回
            $("#canReturn").hide();
            $("#isFirstNode").val('N');
        }

        //BOEING 手册修订阶段，复核人自动填入编写人
        if ('task1550644778074' == node.taskPropId) {
            $(".xmclass").hide();
            $("#authId").combogrid({required: false});
            $("#checkBy").val(resource.modifyBy);
            // $("#isFirstNode").val('Y');
        }
        //BOEING 当前节点复核人
        if('task1550644826544' == node.taskPropId) {
            $(".xmclass").hide();
            $("#authId").combogrid({required:false});
            $("#isFirstNode").val('Y');
        }


        //SP 批准人
        if('task1560857408188' == node.taskPropId) {
            $(".xmclass").hide();
            $("#authId").combogrid({required:false});
            $("#isFirstNode").val('Y');
        }

    }
    function checkSubimt(){
        //判断处理期限是否大于当前日期至少1天
        InitFuncCodeRequest_({
            async: false,
            data: {pkid: pkid, FunctionCode: "TD_REVSUG_BY_PKID"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    var deadline = new Date(jdata.data.DEADLINE).Format("yyyy-MM-dd");
                    var deadlineDate=new Date(deadline);
                    var current= new Date().Format("yyyy-MM-dd");
                    var currentDate = new Date(current);
                    var total = (deadlineDate.getTime() - currentDate.getTime())/1000;
                    var day = parseInt(total / (24*60*60));//计算整数天数
                    if (day>=0){
                        doSubmit();
                    }else {
                        MsgAlert({content: "处理期限必须大于或等于当前日期.", type: 'error'});

                    }
                }
            }
        });

    }
    function doReturn(){
        var msg;
        var isFirstNode = $("#isFirstNode").val();
        var v="";
        if('Y' == isFirstNode){
            msg = '是否进行退回?';
            v="up";
            if('task1550651249297111' == flow_node.taskPropId || 'task1550643287370' == flow_node.taskPropId || 'task1550651285587111' == flow_node.taskPropId || 'task1550644716529' == flow_node.taskPropId){//第一个节点 和批准节点
                v='top';
            }
        }else{
            msg = '您确定要退回吗?<br/> <input name="rdo_return" type="radio" value="up" checked="checked"/> 退回到上一级 <br/> <input name="rdo_return" type="radio" value="top"/> 退回到开始';
        }
        $.messager.confirm('提示:', msg, function(r){
            if (r){
                var notes = $("#notes").textbox('getValue');
                if($.trim(notes) == ''){
                    MsgAlert({ content :'请输入您的退回意见',  type:'error' });
                    return;
                }
                if('Y' != isFirstNode){
                    v = $("input[name='rdo_return']:checked").val();
                    if($.trim(v) == ''){
                        MsgAlert({ content :'请选择退回项',  type:'error' });
                        return;
                    }
                }

                if($.trim(v) == ''){
                    MsgAlert({ content :'请选择退回项(v==null)',  type:'error' });
                    return;
                }

                var $form = $("#mform");
                var data = $form.serializeObject();
                data = $.extend({}, data, {
                    FunctionCode: 'WS_FLOW_TURNBACK', reSelect: v,
                    taskId: param.TASK_ID, procDefId : param.PROC_DEF_ID, notes: notes
                });
                if(!PAGE_EVENTS.beforeTurnBack(data)){
                    return;
                }
                MaskUtil.mask("请求处理中...");
                InitFuncCodeRequest_({
                    data: data,
                    successCallBack: function (jdata) {
                        MaskUtil.unmask();
                        PAGE_EVENTS.afterTurnBack(jdata);
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                            if(typeof(param.OWindow.reload_ == 'function')) {
                                param.OWindow.reload_();
                            }
                            param.OWindow.MsgAlert({ content : jdata.msg ? jdata.msg : $.i18n.t('msg_err:ERRMSG.COMMON.COMMON.OPT_SUCCESS')  });
                            CloseWindowIframe();
                        } else {
                            MsgAlert({ content: jdata.msg, type: 'error'});
                        }
                    }
                });
            }
        });
    }


</script>


<script id="tempCombobox" type="text/html">
    <tr>
        <th class="tdl">{{d.titleName }} ：</th>
        <td class="tdr">
            <select name="{{d.fieldName}}" class="easyui-combobox"
                    data-options="required:true, editable: false" panelHeight="120" style="width:180px">
                {{#
                for(var i = 0; i < d.options.length; i++){
                }}
                <option value="{{d.options[i]['value']}}">{{d.options[i]['text']}}</option>
                {{# } }}
            </select>
        </td>
    </tr>
</script>
<script id="tempTextbox" type="text/html">
    <tr>
        <th class="tdl">{{d.titleName }} ：</th>
        <td class="tdr">
            <input name="{{d.fieldName}}" class="easyui-textbox"
                   data-options="required:true, editable: true" style="width:180px" />
        </td>
    </tr>
</script>

</body>
</html>