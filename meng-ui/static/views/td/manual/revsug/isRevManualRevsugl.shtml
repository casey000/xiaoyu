<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title data-i18n="">修改建议单编辑</title>
</head>
<body class="ibody">

<div id="tt" class="easyui-tabs" style="width:100%; height: 100%">
    <fieldset class="fieldset_eui">
        <form id="mform" class="form-horizontal">
            <input type="hidden" class="easyui-textbox" id="pkid" name="pkid"/>
            <input type="hidden" id="companyCode" name="companyCode"/>
            <input type="hidden" class="easyui-textbox" id="ver" name="ver"/>
            <div id="searchBar">
                <table class="table table-bordered table-info">
                    <tr>
                        <th class="th" style="width:80px;" align="right">手册修订类别：</th>
                        <td class="td5">
                            <input class="easyui-combobox" id="isStructure" name="isStructure"
                                   data-options="required:true,onChange:isStructureChange"/>
                        </td>
                        <th class="th" style="width:80px;" align="right" id="dataNoTh">手册编号：</th>
                        <td class="td5" id="dataNoTd">
                            <input class="easyui-textbox" id="dataNo" name="dataNo"
                                   data-options=""/>
                        </td>
                        <th class="th" style="width:80px;" align="right">建议单类型：</th>
                        <td class="td5">
                            <input class="easyui-combobox" id="revsugType" name="revsugType"
                                   data-options="required:true"/>
                        </td>

                    </tr>
                    <tr>
                        <th class="th" style="width:80px;" align="right">建议单号：</th>
                        <td class="td5">
                            <input class="easyui-textbox" id="revsugNo" name="revsugNo"
                                   data-options="required:true,onlyview:true,editable:false"/>
                        </td>
                        <th class="th" style="width:80px;" align="right">手册类型：</th>
                        <td class="td5">
                            <input class="easyui-combobox" id="manualType" name="manualType"
                                   data-options="editable:true,required:true"/>
                        </td>
                        <th class="th" style="width:100px;" align="right">参考资料类型：</th>
                        <td class="td5">
                            <input class="easyui-combobox" id="dataType" name="dataType"
                                   data-options="editable:true,required:true,onChange:dataTypeChange"/>
                        </td>

                    </tr>
                    <tr>
                        <th class="th" style="width:80px;" align="right">机型：</th>
                        <td class="td5">
                            <input class="easyui-combobox" id="fleet" name="fleet"
                                   data-options="editable:true,required:true,onChange:changeFleet"/>
                        </td>
                        <th class="th" style="width:80px;" align="right">处理期限：</th>
                        <td class="td5">
                            <input class="easyui-datebox" id="deadline" name="deadline"
                                   data-options="editable:true,required:true"/>
                        </td>
                        <th class="th" style="width:80px;" align="right">章节：</th>
                        <td class="td5">
                            <input class="easyui-combobox" id="ata" name="ata"
                                   data-options="editable:true,required:true"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" style="width:80px;" align="right">是否改版：</th>
                        <td class="td5">
                            <input class="easyui-combobox" id="isRev" name="isRev"
                                   data-options="editable:true,required:true"/>
                        </td>
                        <th class="th" style="width:80px;" align="right">重评日期：</th>
                        <td class="td5">
                            <input class="easyui-datebox" id="revDate" name="revDate"
                                   data-options="editable:true"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" style="width:80px;" align="right">适用性：</th>
                        <td class="td5" colspan="5">
                            <input class="easyui-combobox" id="apply" name="apply" style="width: 80%;"
                                   data-options="editable:false,required:true,onlyview:true"/>
                            <input id="chooseBtn" class="btn btn-primary" type="button" onclick="chooseApply()"
                                   value="选取"
                                   style="width: 50px;margin:10px;"/>
                        </td>
                    </tr>
                    <tr id="old">
                        <th class="th" style="width:80px;" align="right">修改记录：</th>
                        <td class="td5" colspan="5">
                            <input class="easyui-textbox" id="oldreason" data-options="editable:false,multiline:true"
                                   style="width:100%;height:80px" name="oldreason"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" style="width:80px;" align="right">修改原因：</th>
                        <td class="td5" colspan="5">
                            <input class="easyui-textbox" id="revmnReason" data-options="editable:true,multiline:true"
                                   style="width:100%;height:80px" name="revmnReason"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" style="width:80px;" align="right">建议单编写原因：</th>
                        <td class="td5" colspan="5">
                            <input class="easyui-textbox" id="memo" name="memo"
                                   data-options="editable:true,multiline:true"
                                   style="width:100%;height:80px"/>
                        </td>
                    </tr>
                    <!--<tr id="file">-->
                    <!--<th class="th" style="width:80px;" align="right">附件：</th>-->
                    <!--<td class="td5">-->
                    <!--<input class="easyui-textbox" id="filename" name="filename" data-options="editable:true"/>-->
                    <!--</td>-->
                    <!--</tr>-->
                    <tr>
                        <td colspan="6" align="right">
                            <!--<input id="delete" class="btn btn-primary" type="button" onclick="deleteFile()" value="删除附件"-->
                            <!--style="width: 70px;margin:10px;"/>-->
                            <input id="sureBtn" class="btn btn-primary" type="button" onclick="sure()" value="确定"
                                   style="width: 50px;margin:10px;"/>
                            <input id="saveBtn" class="btn btn-primary" type="button" onclick="msave()" value="保存"
                                   style="width: 50px;margin:10px;"/>
                            <input id="addDs" class="btn btn-primary" type="button" onclick="add()" value="增加DS"
                                   style="width: 70px;margin:10px;"/>
                            <input id="addAr" class="btn btn-primary" type="button" onclick="addAR()" value="增加AR"
                                   style="width: 70px;margin:10px;"/>
                            <input id="upload" class="btn btn-primary" type="button" onclick="uploadFile()" value="上传"
                                   style="width: 50px;margin:10px;"/>
                            <input id="viewAttachBtn" class="btn btn-primary" type="button" onclick="viewAttach()"
                                   value="附件查看" style="width: 60px;margin:5px;"/>
                            <input id="subBtn" class="btn btn-primary" type="button" onclick="submitSupple()" value="提交"
                                   style="width: 50px;margin:10px;"/>
                            <input class="btn btn-primary" type="button" id="closeBtn" onclick="CloseWindowIframe();"
                                   value="关闭"
                                   style="width: 50px;margin:10px;"/>
                        </td>
                    </tr>
                </table>
            </div>
        </form>
    </fieldset>
    <div id="stru">
        <table id="dg"></table>
    </div>
</div>
<script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var PAGE_DATA = {};
    var COMBOBOX_DATA = {};
    var param;
    var operation;
    var pkid = "";
    var ver = "";
    var isFlow = "";
    var taskcode = "";
    var partAttr = {};
    var BOE_TYPE = {};
    var SUPP_TYPE = {};
    var flag;
    var typeFlag = "";
    var fleetNum = "";
    var func = "TD_MANUAL_REVSUG_AR_LIST";
    var fpkid;
    var revsugNo;

    function i18nCallBack() {
        //绑定回车查询事件
        param = getParentParam_();
        operation = param.operation;
        pkid = param.pkid;
        isFlow = param.isFlow;
        if (operation == 'add') {
            $("#old").hide();
        }
        if (typeof(isFlow) != "undefined" && isFlow != null && isFlow != "" && isFlow == "true") {
            $("#subBtn").hide();
            $("#closeBtn").hide();
        }
        InitFuncCodeRequest_({
            data: {
                domainCode: "YESORNO,TD_REVISED_CATEGORIES,REVSUG_IS_STRUCTURE,YESORNO,REVSUG_FLEET,REVSUG_DATA_TYPE,BOE_TYPE,SUPP_TYPE,REVSUG_DEAL_OPTION,REVSUG_STATUS,DM_ATA,REVSUG_APPLY",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $('#isRev').combobox({
                        panelHeight: '135px',
                        data: jdata.data.YESORNO,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#ata').combobox({
                        panelHeight: '135px',
                        data: jdata.data.DM_ATA,
                        multiple: true,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    // $('#apply').combobox({
                    //     panelHeight: '135px',
                    //     data: jdata.data.REVSUG_APPLY,
                    //     multiple: true,
                    //     valueField: 'VALUE',
                    //     textField: 'TEXT'
                    // });
                    $('#isStructure').combobox({
                        panelHeight: '135px',
                        data: jdata.data.REVSUG_IS_STRUCTURE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#dataNoTh").hide();
                    $("#dataNoTd").hide();
                    $('#fleet').combobox({
                        panelHeight: '110px',
                        data: jdata.data.REVSUG_FLEET,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (data) {
                            fleetNum = $("#fleet").textbox('getValue');
                        }
                    });
                    $('#revsugType').combobox({
                        panelHeight: '110px',
                        data: jdata.data.REVSUG_DEAL_OPTION,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (data) {
                            var dealOption = $("#revsugType").combobox('getValue');
                            ComOrPerChange(dealOption);
                        }
                    });
                    $('#manualType').combobox({
                        panelHeight: '110px',
                        data: jdata.data.REVSUG_DATA_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (data) {
                            var dealOption = $("#manualType").combobox('getValue');
                            changeType(dealOption);
                        }
                    });
                    //手册标准
                    PAGE_DATA['fleet'] = DomainCodeToMap_(jdata.data["REVSUG_FLEET"]);
                    PAGE_DATA['revsugType'] = DomainCodeToMap_(jdata.data["REVSUG_DEAL_OPTION"]);
                    PAGE_DATA['manualType'] = DomainCodeToMap_(jdata.data["REVSUG_DATA_TYPE"]);
                    PAGE_DATA['boeType'] = DomainCodeToMap_(jdata.data["BOE_TYPE"]);
                    PAGE_DATA['suppType'] = DomainCodeToMap_(jdata.data["SUPP_TYPE"]);
                    PAGE_DATA['revisedCategories'] = DomainCodeToMap_(jdata.data["TD_REVISED_CATEGORIES"]);
                    ////待办任务状态禁用除了是否重评等控件
                    $("#isStructure").combobox({onlyview: true, editable: false});
                    $("#revsugType").combobox({onlyview: true, editable: false});
                    $("#dataNo").textbox({onlyview: true, editable: false});
                    $("#manualType").combobox({onlyview: true, editable: false});
                    $("#dataType").combobox({onlyview: true, editable: false});
                    $("#fleet").combobox({onlyview: true, editable: false});
                    $("#deadline").datebox({onlyview: true, editable: false});
                    $("#ata").combobox({onlyview: true, editable: false});
                    $("#oldreason").textbox({onlyview: true, editable: false});
                    $("#revmnReason").textbox({onlyview: true, editable: false});
                    $("#memo").textbox({onlyview: true, editable: false});

                    ////待办任务状态禁用除了是否重评等控件
                    InitFuncCodeRequest_({
                        data: {
                            // applyModel: applyModel,
                            // companyCode: param.companyCode,
                            FunctionCode: "TD_REVSUG_FLEET_LIST2"
                        },
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                $('#apply').combobox({
                                    panelHeight: '135px',
                                    data: jdata.data,
                                    multiple: true,
                                    // editable: false,
                                    // onlyview: true,
                                    valueField: 'VALUE',
                                    textField: 'TEXT'
                                });
                                if (pkid) {
                                    InitDataForm(pkid);
                                }
                            } else {
                                MsgAlert({content: jdata.msg, type: 'error'});
                            }
                        }
                    });
                    //
                    if (operation == "edit") {
                        $("#revsugType").combobox({onlyview: true, editable: false});
                        $("#manualType").combobox({onlyview: true, editable: false});
                        $("#fleet").combobox({onlyview: true, editable: false});
                        $("#dataType").combobox({onlyview: true, editable: false});
                    }


                    BOE_TYPE = jdata.data.BOE_TYPE;
                    SUPP_TYPE = jdata.data.SUPP_TYPE;
                    if (typeFlag == "BOEING") {
                        $('#dataType').combobox({
                            panelHeight: '110px',
                            data: BOE_TYPE,
                            valueField: 'VALUE',
                            textField: 'TEXT'
                        });

                        PAGE_DATA['dataType'] = DomainCodeToMap_(jdata.data["BOE_TYPE"]);
                    } else if (typeFlag == "SUPPLEMENT") {
                        $('#dataType').combobox({
                            panelHeight: '110px',
                            data: SUPP_TYPE,
                            valueField: 'VALUE',
                            textField: 'TEXT'
                        });

                        PAGE_DATA['dataType'] = DomainCodeToMap_(jdata.data["SUPP_TYPE"]);
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

    }

    function changeFleet() {
        var fleet = $("#fleet").combobox('getValue');
        // InitFuncCodeRequest_({
        //     data: {fleet: fleet, FunctionCode: 'REVSUG_APPLY'},
        //     successCallBack: function (jdata) {
        //         if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
        //             $('#apply').combobox({
        //                 panelHeight: '135px',
        //                 data: jdata.data,
        //                 multiple: true,
        //                 valueField: 'VALUE',
        //                 textField: 'TEXT'
        //             });
        //         } else {
        //             MsgAlert({content: jdata.msg, type: 'error'});
        //         }
        //     }
        // });
    }

    function isStructureChange() {
        var isStructure = $('#isStructure').combobox('getValue');
        if (isStructure == "N") {
            $("#dataNo").textbox({required: true});
            $("#dataNoTh").show();
            $("#dataNoTd").show();
        } else {
            $("#dataNo").textbox({required: false});
            $("#dataNoTh").hide();
            $("#dataNoTd").hide();
        }
    }

    function changeType(deal) {
        if (deal == "BOEING") {
            typeFlag = "BOEING";
            // $("#revsugType").combobox({onlyview: true, editable: false});
            // $("#revsugType").textbox('setValue', 'AR');
            $('#dataType').combobox({
                panelHeight: '110px',
                data: BOE_TYPE,
                valueField: 'VALUE',
                textField: 'TEXT'
            });

            // InitDataGridAR(pkid);
        } else {
            typeFlag = "SUPPLEMENT";
            $('#dataType').combobox({
                panelHeight: '110px',
                data: SUPP_TYPE,
                valueField: 'VALUE',
                textField: 'TEXT'
            });
            // $("#revsugType").combobox({onlyview: true, editable: false});

            // InitDataGridDS(pkid);
        }
        ComOrPerChange($("#revsugType").combobox('getValue'));
    }

    function dataTypeChange() {
        var dataType = $("#dataType").combobox('getValue');
        if (dataType == "AMM" || dataType == "SAMM") {
            func = "TD_MANUAL_REVSUG_AR_AMM_LIST";
        } else if (dataType == "IPC" || dataType == "SIPC") {
            func = "TD_MANUAL_REVSUG_AR_IPC_LIST";
        } else if (dataType == "WDM" || dataType == "SSM") {
            func = "TD_MANUAL_REVSUG_AR_WDM_LIST";
        } else {
            func = "TD_MANUAL_REVSUG_AR_LIST";
        }
        var revSug = $("#revsugType").combobox('getValue');
        if (revSug == "DS") {
            InitDataGridDS(pkid);
        }
        if (revSug == "AR") {
            InitDataGridAR(pkid);
        }

    }

    function ComOrPerChange(revSug) {
        flag = revSug;
        $("#upload").hide();
        if (revSug == "DS") {
            InitDataGridDS(pkid);
            $("#upload").show();
            $("#viewAttachBtn").show();
            $("#file").show();
            $("#delete").show();
            $("#addDs").show();
            $("#addAr").hide();
        }
        if (revSug == "AR") {
            // InitDataGridAR(pkid);
            $("#upload").show();
            $("#viewAttachBtn").show();
            $("#file").hide();
            $("#delete").hide();
            $("#addDs").hide();
            $("#addAr").show();

        }

        if (operation == "view") {
            $("#upload").hide();
            $("#saveBtn").hide();
            $("#closeBtn").hide();
            $("#subBtn").hide();
            $("#delete").hide();
            $("#addDs").hide();
            $("#addAr").hide();
            $("#viewAttachBtn").hide();
        }
    }

    //上传
    function uploadFile() {
        if (isEmpty(pkid)) {
            MsgAlert({content: "请先保存主表数据！", type: 'error'});
            return;
        }
        // InitFuncCodeRequest_({
        //     data: {pkid: pkid, FunctionCode: "REVSUG_FILE_COUNT"}, async: false, successCallBack: function (jdata) {
        //         if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
        //             ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
        //             if (jdata.data.FILECOUNT != 0) {
        //                 MsgAlert({content: "不能上传多个附件！", type: 'error'});
        //             } else {
        msave();//如果切换编写方式需要先保存主表否则有问题
        common_uploadFile({
            identity: 'dg',
            param: {
                cat: "tdManualRevsug",
                sourceId: pkid,
                successCellBack: "",
                fialCellBack: "",
                taskcode: taskcode
            }
        });
        // }
        //         } else {
        //             MsgAlert({content: jdata.msg, type: 'error'});
        //         }
        //     }
        // });

    }

    //上传
    function common_uploadFile(edopt) {
        var title_ = $.i18n.t('common:COMMON_OPERATION.UPLOAD');
        ShowWindowIframe({
            width: 690,
            height: 290,
            title: title_,
            param: $.extend({}, edopt.param),
            url: "/views/data_manager/dm/upload/attachment_revsug.shtml"
        });
    }

    function InitDataGridDS(pkid) {

        $("#dg").GatewayDataGrid({
            identity: 'dg',
            sortable: true,
            singleSelect: true,
            pageSize: 15,
            enableLineEdit: true,
            enableCellEdit: true,
            queryParams: {"sugId": pkid},
            path:"/online-manual/tdManualRevsugDs/queryPageRevsugDsBySugId",
            columns: {
                param: {FunctionCode: 'TD_MANUAL_REVSUG_DS_LIST'},
                alter: {}
            },
            onLoadSuccess: function (row) {
                formatterUpperDataGrid(row,"dg");
            },
            onEndEdit: function (index, row, changes) {
                editDate(index, row, changes);
            },
            onBeginEdit: function (index, row) {
            },
            contextMenus: [
                {
                    id: "m-edit", i18nText: "编辑", auth: "",
                    onclick: function () {
                        var rowData = getDG('dg').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        openDetaiDs('edit', rowData.PKID);

                    }
                },
                {
                    id: "m-edit", i18nText: "删除", auth: "",
                    onclick: function () {
                        var rowData = getDG('dg').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (!confirm("确认删除该记录？")) {
                            return;
                        }
                        InitFuncCodeRequest_({
                            data: {pkid: rowData.PKID, FunctionCode: 'TD_MANUAL_REVSUG_DS_DEL'},
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    reload_();
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }],


            validAuth: function (row, items) {
                if (operation == "view") {
                    items['删除'].enable = false;
                    items['编辑'].enable = false;
                }

                return items;
            }

        });
    }

    function InitDataGridAR(pkid) {
        var domain = "";
        if (typeFlag == "BOEING") {
            domain = "BOE_TYPE";
        } else if (typeFlag == "SUPPLEMENT") {
            domain = "SUPP_TYPE";
        }
        $("#dg").GatewayDataGrid({
            identity: 'dg',
            sortable: true,
            singleSelect: true,
            pageSize: 15,
            queryParams: {"sugId": pkid},
            path:"/online-manual/tdManualRevsugAr/queryPageRevsugArBySugId",
            columns: {
                param: {FunctionCode: func},
                alter: {
                    REVISED_CATEGORIES: {
                        formatter: function (value) {
                            return PAGE_DATA['revisedCategories'][value];
                        }
                    },
                }
            },
            onLoadSuccess: function (data) {
                formatterUpperDataGrid(data,"dg");
            },

            onBeginEdit: function (index, row) {
            },
            contextMenus: [

                {
                    id: "m-edit", i18nText: "编辑", auth: "",
                    onclick: function () {
                        var rowData = getDG('dg').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        openDetaiAr('edit', rowData.PKID);

                    }
                },
                {
                    id: "m-edit", i18nText: "删除", auth: "",
                    onclick: function () {
                        var rowData = getDG('dg').datagrid('getSelected');
                        if (!rowData.PKID) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (!confirm("确认删除该记录？")) {
                            return;
                        }
                        InitFuncCodeRequest_({
                            data: {pkid: rowData.PKID, FunctionCode: 'TD_MANUAL_REVSUG_AR_DEL'},
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    reload_();
                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }],

            toolbar: [],
            onBeforeLoad: function (data) {
                if (operation == "view" || operation == 'workflow') {
                    $("div.datagrid-toolbar [id ='btnAdd']").eq(0).hide();
                    $("div.datagrid-toolbar [id ='btnSave']").eq(0).hide();
                }
            },

            validAuth: function (row, items) {
                if (operation == "view") {
                    items['删除'].enable = false;
                    items['编辑'].enable = false;
                }

                return items;
            },
            onClickRow: function (rowIndex, rowData) {
            },
            onDblClickRow: function (index, field, value) {
                openDetaiAr("view", value.PKID);
            }

        });
    }


    function InitDataForm(pkid) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "TD_REVSUG_BY_PKID"}, async: false, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                    $('#fleet').combobox({value: jdata.data.FLEET});
                    $('#dataType').combobox({value: jdata.data.DATA_TYPE});
                    $("#apply").combobox({value: jdata.data.APPLY});
                    revsugNo = jdata.data.REVSUG_NO;
                    // $("#apply").combobox("setValue", jdata.data.APPLY);
//                    $('#ata').textbox({value: jdata.data.ATA});
                    ComOrPerChange(jdata.data.REVSUG_TYPE);
                    changeType(jdata.data.MANUAL_TYPE);
                    dataTypeChange();
                    ver = $("#ver").textbox('getValue');
                    if (ver == 0) {
                        $("#old").hide();
                    }
                    $("#revDate").datebox('setValue', '');
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    //刷新
    function reload_() {
        // $("#dg").datagrid("reload");
        ComOrPerChange($("#revsugType").combobox('getValue'));
    }

    //刷新
    function reloadAr() {
        dataTypeChange();
    }

    // 保存
    function msave() {
        if (!pkid) {
            $("#revsugNo").textbox('setValue', randomNumber());//评估单号
        }
        var oldDeal = '';
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: "TD_REVSUG_BY_PKID"}, async: false, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        oldDeal = jdata.data.DEAL_OPTION;
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        var $form = $("#mform");
        var datas = $form.serializeObject();
        if (Array.isArray(datas['ata'])) {
            datas['ata'] = datas['ata'].join(',');
        }
        if (Array.isArray(datas['apply'])) {
            datas['apply'] = datas['apply'].join(',');
        }
        datas = $.extend({}, datas, {FunctionCode: 'TD_REVSUG_ADD'});
        InitFuncCodeRequest_({
            data: datas, successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (typeof(isFlow) == "undefined" || isFlow == null || isFlow == "") {
                        $("#pkid").textbox('setValue', jdata.data.pkid);
                        pkid = jdata.data.pkid;
                        param.OWindow.reload_();
                    }
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('保存数据成功')});
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });
    }

    function deleteFile() {
        if (!confirm("是否刪除"))
            return;
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: 'REVSUG_ATTACHMENT_DEL'},
            successCallBack: function (jdata) {
                if (jdata.code == 200) {
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    $("#filename").textbox('setValue', '');
                }
            }
        });
    }

    function checkDeadline() {
        var deadline = $('#deadline').datebox('getValue');
        var deadlineDate = new Date(deadline);
        var current = new Date().Format("yyyy-MM-dd");
        var currentDate = new Date(current);

        // var currentDate = new Date();
        var total = (deadlineDate.getTime() - currentDate.getTime()) / 1000;
        var day = parseInt(total / (24 * 60 * 60));//计算整数天数
        if (day >= 0) {
            return true;
        }
        return false;
    }

    //提交
    function submitSupple() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate)
            return;
        var $form = $("#mform");
        var datas = $form.serializeObject();

        if (!pkid) {
            MsgAlert({content: "请保存数据后提交.", type: 'error'});
            return;
        }
        //判断处理期限是否大于当前日期至少1天
        if (!checkDeadline()) {
            MsgAlert({content: "处理期限必须大于或等于当前日期.", type: 'error'});
            return;
        }
        InitFuncCodeRequest_({
            data: {pkid: pkid, pkid: pkid, FunctionCode: "TD_REVSUG_BEG_SUBMIT"}, async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data.COU == 0) {
                        MsgAlert({content: "请先添加子表数据！", type: 'error'});

                    } else {
                        if ($("#revsugType").combobox('getValue') == "DS") {
                            // if (!$("#filename").textbox('getValue')) {
                            //     MsgAlert({content: "请先上传附件！", type: 'error'});
                            //     return;
                            // }
                        }
                        if (!confirm("确认提交该记录？")) {
                            return;
                        }
                        datas = $.extend({}, {}, {
                            FunctionCode: 'FLOW_BEFORE_CHECK',
                            pkid: pkid,
                            TABLE_NAME: "TD_MANUAL_REVSUG"
                        });
                        InitFuncCodeRequest_({
                            data: datas, successCallBack: function (jdata) {
                                if (jdata.data != null) {
                                    common_add_edit_({
                                        identity: '', isEdit: '', width: 520, height: 300, title: $.i18n.t('选择审批人'),
                                        param: {
                                            operation: "",
                                            roleId: '',
                                            otherParam: pkid,
                                            FunctionCode_: 'TD_MANUAL_REV_SUG_SUBMIT',
                                            successCallback: reload_par
                                        },
                                        url: "/views/flow/work_flow_account_select.shtml"
                                    });
                                } else {
                                    MsgAlert({content: "该数据已被提交过了。", type: 'error'});
                                }
                            }
                        });
                    }
                } else {
                    MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                }
            }
        });


    }


    function upper() {
        var title = $(this).val();
        title = title.toUpperCase();
        $("#dataTitle").textbox('setValue', title);
    }

    function add() {
        if (isEmpty(pkid)) {
            alert("请先保存主表数据！");
            return;
        }
        var isStructure = $('#isStructure').combobox('getValue');

        var title_ = $.i18n.t('增加DS');
        ShowWindowIframe({
            width: 690,
            height: 290,
            title: title_,
            param: {
                dataType: $("#dataType").combobox('getValue'),
                fleet: $("#fleet").combobox('getValue'),
                companyCode: $("#companyCode").val(),
                pkid: pkid,
                flag: flag,
                typeFlag: typeFlag,
                isStructure: isStructure
            },
            url: "/views/td/manual/revsug/addDs.shtml"
        });
    }

    function chooseApply() {
        //获取机型 fleet
        var fleet = $("#fleet").combobox('getValue');
        if (!fleet) {
            MsgAlert({content: "请先选择机型.", type: 'error'});
            return;
        }

        var title_ = $.i18n.t('选取适用性');
        var acIds = $("#apply").combobox("getValues");
        var acId;
        if (Array.isArray(acIds)) {
            acId = acIds.join(',');
        } else {
            acId = acIds;
        }
        ShowWindowIframe({
            width: 644,
            height: 506,
            title: title_,
            param: {
                // applyModel: applyModel,
                // companyCode: companyCode,
                fleet: fleet,
                acId: acId
                // pkid: pkid,
                // spkid: spkid
            },
            url: "/views/td/manual/revsug/fleetList.shtml"
        });
    }

    function addAR() {
        if (isEmpty(pkid)) {
            alert("请先保存主表数据！");
            return;
        }
        //获取手册类型
        var dataType = $('#dataType').combobox('getValue');
        if (isEmpty(dataType)) {
            MsgAlert({content: "请保存数据后提交.", type: 'error'});
            return;
        }
        var url = "/views/td/manual/revsug/addOtherAr.shtml";
        if (dataType == "AMM" || dataType == "SAMM") {
            url = "/views/td/manual/revsug/addAMMAr.shtml";
        } else if (dataType == "IPC" || dataType == "SIPC") {
            url = "/views/td/manual/revsug/addIPCAr.shtml";
        } else if (dataType == "WDM" || dataType == "SSM") {
            url = "/views/td/manual/revsug/addWDMAr.shtml";
        } else {
            url = "/views/td/manual/revsug/addOtherAr.shtml";
        }
        var isStructure = $('#isStructure').combobox('getValue');
        var title_ = $.i18n.t('增加AR');
        ShowWindowIframe({
            width: 1050,
            height: 470,
            title: title_,
            param: {
                dataType: $("#dataType").combobox('getValue'),
                fleet: $("#fleet").combobox('getValue'),
                companyCode: $("#companyCode").val(),
                mpkid: pkid,
                flag: flag,
                typeFlag: typeFlag,
                isStructure: isStructure
            },
            url: url
        });
    }

    function randomNumber() {
        var ata = $("#ata").combobox('getValues');
        if (Array.isArray(ata)) {
            ata = ata.join(',');
        }
        var num = 1;
        if (ata.indexOf(",") != -1) {
            ata = "MULT";
        }
        var todayDate = new Date();
        var year = todayDate.getFullYear();
        var serialNo = fleetNum + "-" + ata + "-" + year;
        InitFuncCodeRequest_({
            data: {serialNo: serialNo, FunctionCode: "TD_REVSUG_BY_NO"},
            async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data != null) {
                        if (jdata.data.OLDNUM) {
                            num = parseInt(jdata.data.OLDNUM, 10) + 1;
                        }
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

        num = pad(num, 4);
        serialNo = serialNo + num;
        return serialNo;
    }

    var pad = function () {
        var tbl = [];
        return function (num, n) {
            var len = n - num.toString().length;
            if (len <= 0) return num;
            if (!tbl[len]) tbl[len] = (new Array(len + 1)).join('0');
            return tbl[len] + num;
        }
    }();

    function choose(da, index) {
        var title_ = $.i18n.t('选取手册');
        ShowWindowIframe({
            width: 954,
            height: 346,
            title: title_,
            param: {
                index: index,
                manualType: da,
                fleet: $("#fleet").combobox('getValue'),
                companyCode: $("#companyCode").val(),
                flag: flag,
                typeFlag: typeFlag
            },
            url: "/views/td/manual/revsug/manualList.shtml"
        });
    }


    //刷新
    function reload_par() {
        getParentParam_().OWindow.reload_();
        window.close();
    }


    function openDetaiDs(operation, pkid) {
        var isStructure = $('#isStructure').combobox('getValue');
        var title_ = $.i18n.t('DS编辑页面');
        ShowWindowIframe({
            width: "690",
            height: "290",
            title: title_,
            param: {
                dataType: $("#dataType").combobox('getValue'),
                fleet: $("#fleet").combobox('getValue'),
                companyCode: $("#companyCode").val(),
                pkid: pkid,
                flag: flag,
                typeFlag: typeFlag,
                operation: operation,
                isStructure: isStructure
            },
            url: "/views/td/manual/revsug/addDs.shtml"
        });
    }

    function openDetaiAr(operation, pkid) {

        //获取手册类型
        var dataType = $('#dataType').combobox('getValue');
        var url = "/views/td/manual/revsug/addOtherAr.shtml";
        if (dataType == "AMM" || dataType == "SAMM") {
            url = "/views/td/manual/revsug/addAMMAr.shtml";
        } else if (dataType == "IPC" || dataType == "SIPC") {
            url = "/views/td/manual/revsug/addIPCAr.shtml";
        } else if (dataType == "WDM" || dataType == "SSM") {
            url = "/views/td/manual/revsug/addWDMAr.shtml";
        } else {
            url = "/views/td/manual/revsug/addOtherAr.shtml";
        }
        var isStructure = $('#isStructure').combobox('getValue');
        var title_ = $.i18n.t('AR编辑页面');
        ShowWindowIframe({
            width: 1050,
            height: 470,
            title: title_,
            param: {
                dataType: $("#dataType").combobox('getValue'),
                fleet: $("#fleet").combobox('getValue'),
                companyCode: $("#companyCode").val(),
                pkid: pkid,
                flag: flag,
                typeFlag: typeFlag,
                operation: operation,
                isStructure: isStructure
            },
            url: url
        });
    }

    //附件查看
    function viewAttach() {
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: pkid,
                CATEGORY: "tdManualRevsug",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                //为0时提示没有上传附件，无法查看
                if (jdata.data.length == 0) {
                    MsgAlert({content: "请先上传附件", type: 'error'});

                } else {
                    //打开一个列表页面
                    ShowWindowIframe({
                        width: "515",
                        height: "285",
                        param: {pkid: pkid, category: "tdManualRevsug"},
                        url: "/views/data_manager/dm/upload/editRevsugAttach.shtml"
                    });
                }
            }
        });
    }

    function sure() {
        //编写人选择是否重评，若否，则重新设定重评日期；若是，则改版该建议单
        var isRev = $("#isRev").combobox('getValue');
        if (!isRev) {
            MsgAlert({content: "请选择是否重评", type: 'error'});
            return;
        }
        if (isRev == "N") {
            var revDate = $("#revDate").datebox("getValue");
            if (!revDate) {
                MsgAlert({content: "请选择重评日期", type: 'error'});
                return;
            }
            //保存
            InitFuncCodeRequest_({
                data: {pkid: pkid, revDate: revDate, FunctionCode: 'TD_REVSUG_UPDATE_REVDATE'},
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        getParentParam_().OWindow.reloadTodo();
                        CloseWindowIframe();
                    } else {
                        MsgAlert({content: jdata.msg, type: 'error'});
                    }
                }
            });
        } else {
            //查询fpkid
            InitFuncCodeRequest_({
                data: {pkid: pkid, FunctionCode: 'TD_MANUAL_REVSUG_GET_FPKID'},
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        //改版
                        revision(jdata.data.PKID, jdata.data.FPKID, jdata.data.REVSUG_NO);
                    } else {
                        MsgAlert({content: jdata.msg, type: 'error'});
                    }
                }
            });

        }

    }

    function revision(mpkid, fpkid, revsugNo) {
        if (!confirm("确认改版?")) {
            return;
        }

        //校验是否已经做过改版
        InitFuncCodeRequest_({
            data: {revsugNo: revsugNo, FunctionCode: 'TD_REVSUG_REVISION_CHECK'}, async: false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jdata.data.COU != 0) {
                        MsgAlert({content: "该记录已经改版，请不要重复操作!", type: 'error'});

                    } else {
                        InitFuncCodeRequest_({
                            data: {pkid: mpkid, fpkid: fpkid, FunctionCode: 'TD_REVSUG_REVISION'},
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    // MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                    // reload_();
                                    //关闭待办
                                    closeDaiban();

                                } else {
                                    MsgAlert({content: jdata.msg, type: 'error'});
                                }
                            }
                        });
                    }
                }
            }
        });

    }

    //关闭待办任务
    function closeDaiban() {
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: 'TD_REVSUG_CLOSE_MSG'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    getParentParam_().OWindow.reloadTodo();
                    CloseWindowIframe();
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }
</script>
</body>
</html>