<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head id="i18n_" module="">
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
    <title></title>
    <!-- load css -->
    <!--#include virtual="/views/items/resource_.shtml"-->
    <link href="/css/mccdoc/mr_commons.css" rel="stylesheet" type="text/css"/>

    <!--    <script src="/js/mccdoc/common/mr_common.js" type="text/javascript"></script>-->
<!--    <script src="/js/mccdoc/edit/mr_add.js" type="text/javascript"></script>-->
    <script src="/views/common/select_store_mr.js" type="text/javascript"></script>
    <style>
        #buttom {
            text-align: right;
            margin-top: 30px;
            display: none;
        }

        .btn {
            background: #2465a8;
            border: none;
            color: #fff;
        }

        #buttom a {
            display: inline-block;
            cursor: pointer;
            background: #2465a8;
            color: #fff;
            border-radius: 4px;
            padding: 5px 20px;
            border: none;
            font-size: 14px;
            margin-top: 50px;
            margin-right: 12px;
        }
        .post_table #singleAcNotice .mrItem td{
            /*height: 35px;*/
            line-height: 22px;
            padding: 2px;
        }
        .tabs li.tabs-selected a.tabs-inner{
            color: #f60;
        }
        .chItem{
            background-color: #ffffaa;
        }
        .newItem{
            background-color: #aaffaa;
        }
        .delItem{
            background-color: #ffaaaa;
        }
        #singleAcNotice {
            color: #333;
        }
    </style>
</head>
<body>
<div class="easyui-tabs" id="texttabs" style="width:100%;height:50px;">
<!--    <div style="padding:20px;" title="REV1">-->

<!--    </div>-->
<!--    <div data-options="" style="overflow:auto;padding:20px;" title="REV2">-->

<!--    </div>-->
<!--    <div data-options="" style="padding:20px;" title="REV3">-->

<!--    </div>-->
</div>
<form id="addForm" method="get">
    <input id="acIds" name="mrAcIds" type="hidden"/>
    <input id="esnIds" name="mrEsnIds" type="hidden"/>
    <table border="0" cellpadding="0" cellspacing="0" class="post_table">
        <tr>
            <td class="tab_title_bg" width="16%">Mr No:</td>
            <td width="34%">
                <span id="mrNo"></span>
            </td>
            <td class="tab_title_bg" width="16%"></td>
            <td width="34%">
                <span id="status"></span>
            </td>
        </tr>
        <tr>
            <td class="tab_title_bg" width="16%">A/C/ENG:</td>
            <td width="34%">
                <span id="acReg"></span>
            </td>
            <td class="tab_title_bg"  width="16%">RequireDate:</td>
            <td width="34%">
                <span id="requireDate"></span>
            </td>
        </tr>
        <tr>
            <td class="tab_title_bg" width="16%">Card No:</td>
            <td width="34%">
                <span>
                    <span id="workType"></span>
                    <span id="cardNum" style="margin-left: 7px"></span>
                    <span id="pknum" style=" margin-left: 7px"></span>
                    <span id="aogSta" style="color: red; margin-left: 7px"></span>
                </span>
            </td>
            <td class="tab_title_bg"  width="16%">Interval:</td>
            <td width="34%">
                <span id="Interval"></span>
            </td>
        </tr>
        <tr>
            <!--            <td class="tab_title_bg" width="16%">Send:</td>-->
            <!--            <td width="34%">-->
            <!--                <span id="send"></span>-->
            <!--            </td>-->
            <td class="tab_title_bg" width="16%">Station:</td>
            <td width="34%">
                <span id="station"></span>
            </td>
            <td class="tab_title_bg"  width="16%">Satisfy:</td>
            <td width="34%">
                <span id="Satisfy"></span>
            </td>
        </tr>
        <tr>
            <td class="tab_title_bg"  width="16%">Create Time:</td>
            <td width="34%">
                <span id="createTime"></span>
            </td>
            <td class="tab_title_bg"  width="16%">Approver:</td>
            <td width="34%">
                <span id="approver"></span>
            </td>
<!--            <td colspan="3">-->
<!--                <span id="createTime"></span>-->
<!--            </td>-->

        </tr>
        <tr class="timeLimittr" style="display: none">
            <td class="tab_title_bg" width="16%">时限类型:</td>
            <td width="34%">
                <span id="timeLimit"></span>
            </td>
            <td class="tab_title_bg"  width="16%">延期次数:</td>
            <td width="34%">
                <span id="delayTime"></span>
            </td>
        </tr>
        <tr>
            <td class="tab_title_bg" width="16%">Ext Message:</td>
            <td colspan="3">
                <span id="message"></span>
            </td>
        </tr>
        <tr>
            <td class="tab_title_bg" width="16%">Remark:</td>
            <td colspan="3">
                <span id="remark"></span>
            </td>
        </tr>
        <tr>
            <td class="tab_title_bg" width="16%">Reason:</td>
            <td colspan="3">
                <span id="reason"></span>
            </td>
        </tr>

        <tr>
            <td colspan="4">
                <table id="singleAcNotice"  width="100%">
                    <tr>
                        <td colspan="16" style="font-weight: 600;">Material Requires Items</td>
                    </tr>
                    <tr>
                        <td class="tab_title_bg" style="text-align: center; width : 5%">NO.</td>
                        <td class="tab_title_bg" style="text-align: center; width : 5%">REV</td>
                        <td class="tab_title_bg" style="text-align: center; width : 7%">P/N</td>
                        <td class="tab_title_bg" style="text-align: center; width : 7%">Optional P/N</td>
                        <td class="tab_title_bg" style="text-align: center; width : 7%">Invertory P/N</td>
                        <td class="tab_title_bg" style="text-align: center; width : 12%">Name</td>
                        <td class="tab_title_bg" style="text-align: center; width :6%">QTY</td>
                        <td class="tab_title_bg" style="text-align: center; width : 5%">Asset Num</td>
                        <td class="tab_title_bg" style="text-align: center; width : 5%">S/N</td>
                        <td class="tab_title_bg" style="text-align: center; width : 6%">Lot Num</td>
                        <td class="tab_title_bg" style="text-align: center; width : 5%">Station</td>
                        <td class="tab_title_bg" style="text-align: center; width : 8%">Shortages QYT</td>
                        <td class="tab_title_bg" style="text-align: center; width : 7%">FeedBack</td>
                        <td class="tab_title_bg" style="text-align: center; width : 5%">Remark</td>
<!--                        <td class="tab_title_bg" style="text-align: center; width : 5%!important;">Satisfy</td>-->
                        <td class="tab_title_bg" style="text-align: center; width : 7%">Rev Note</td>
                    </tr>


                </table>
            </td>
        </tr>
    </table>
    <div id="unitMrId" style="display:none">
        <select style="width: 80px">
            <option value="">--select--</option>
            <option value="PR">PR</option>
            <option value="CN">CN</option>
            <option value="QT">QT</option>
            <option value="SH">SH</option>
            <option value="OZ">OZ</option>
            <option value="PK">PK</option>
            <option value="RL">RL</option>
            <option value="BG">BG</option>
            <option value="CA">CA</option>
            <option value="DZ">DZ</option>
            <option value="EA">EA</option>
            <option value="FT">FT</option>
            <option value="GL">GL</option>
            <option value="GR">GR</option>
            <option value="IN">IN</option>
            <option value="KG">KG</option>
            <option value="KT">KT</option>
            <option value="LB">LB</option>
            <option value="LM">LM</option>
            <option value="ME">ME</option>
            <option value="PT">PT</option>
            <option value="QI">QI</option>
            <option value="SF">SF</option>
            <option value="SI">SI</option>
            <option value="SM">SM</option>
            <option value="ST">ST</option>
            <option value="SY">SY</option>
            <option value="TH">TH</option>
            <option value="TU">TU</option>
            <option value="YD">YD</option>
            <option value="FH">FH</option>
            <option value="DAY">DAY</option>
            <option value="CY">CY</option>
            <option value="PL">PL</option>
            <option value="HU">HU</option>
            <option value="BT">BT</option>
            <option value="LT">LT</option>
        </select>
    </div>
</form>
<div id="buttom">
    <a href="javascript:void(0);" id="shortApply" onclick="apply()">缺料申请</a>
    <a href="javascript:void(0);" id="reviseBtn" onclick="Revise()">修订</a>
    <a href="javascript:void(0);" id="cancelBtn" onclick="cancelDia()">取消</a>
</div>
<div class="easyui-dialog" id="dd" style="width:35%;height:70%;padding:10px;display: none" title="Edit">
    <form action="" id="approval_form" method="post">
        <table cellpadding="0" cellspacing="0" class="post_table"
               style="border-top: 1px solid #ccc;border-left: 1px solid #ccc;" width="100%">
            <tr hidden="true">
                <td class="key">ID:</td>
                <td style="position: relative;">
                    <input class="td_input"  name="id" value="">
                </td>
            </tr>
            <tr>
                <td colspan="2">请填写取消原因:</td>
            </tr>
            <tr>
                <td class="key">Reason:<font color="red">*</font></td>
                <td style="position: relative;">
                    <textarea class="td_input" id="cancelReason" name="cancelReason" rows="5" value=""></textarea>
                </td>
            </tr>
        </table>
    </form>
    <div align="right" style="margin-top: 50px">
        <tr id="view">
            <td align="right">
                <input class="btn btn-primary bianji" onclick="cancel()"
                       style="width: 60px;margin:5px;height: 25px;background-color: #2465a8;cursor: pointer"
                       type="button" value="提交"/>
            </td>
        </tr>
    </div>
</div>
</body>
<script>
    var param = getParentParam_();
    var sapTaskId;
    var mrNo = param.mrNo;
    var rev = param.rev;
    var workOrderId ='';
    var respon = [];
    var tabIndex = "";
    function i18nCallBack() {
        $('#dd').dialog('close');
        data = $.extend({}, {mrNum:mrNo}, {FunctionCode: "MR_SYN_VIEW"});
        InitFuncCodeRequest_({
            data: data,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    respon = jdata.data;
                    InitTable(respon);
                    tabIndex = 0;
                } else {
                    MsgAlert({content: jdata.msgData[0] ? jdata.msgData[0] : jdata.msg, type: 'error'});
                }
            }
        });
    }
    function undefineFilter(value) {
        return typeof (value) == "undefined" || value == null ? "" : value;
    }

    function listReload_() {
        window.location.reload()
    }

    function InitTable(respon) {
        let mrNum = "MR"+respon.mrNum.substring(1,respon.mrNum.length);
        $('#mrNo').text(mrNum);
        $('#workType').text(respon.tdWorkType);
        if(respon.workType == 'DEF') {
            $('#reviseBtn').css({'display':'none'});
            $('#cancelBtn').css({'display':'none'});
        }
        if(respon.workType == 'NRC') {
            $('.timeLimittr').show();
            var timeType = '';
            if(respon.timeLimitType == 'Hard_Limit') {
                timeType = '硬时限'
            } else if(respon.timeLimitType == 'Soft_Limit') {
                timeType = '软时限'
            }else{
                timeType = respon.timeLimitType
            }
            $('#timeLimit').text(timeType);
            $('#delayTime').text(respon.delayTimes);
        }else{
            $('#timeLimittr').hide();
        }
        $('#cardNum').text(respon.cardNum);
        $('#pknum').text(respon.packageNum || '');
        if(respon.aog == '1') {
            $('#aogSta').text('AOG');
        }else{
            $('#aogSta').text('');
        }
        if(respon.assetType == 'E') {
            $('#acReg').text(respon.assetId);
        } else if(respon.assetType == 'NA') {
            $('#acReg').text(respon.assetType);
        }else{
            $('#acReg').text(respon.assetId);
        }
        $('#requireDate').text(respon.requiredDate);
        $('#createTime').text(respon.mrCreatedDate);
        $('#Interval').text(respon.interval);
        $('#remark').text(respon.description);
        $('#Satisfy').text(undefineFilter(respon.materialStatus));
        $('#reason').text(respon.reason || '');
        $('#station').text(respon.station);
        if(respon.approver) {
            _data = $.extend({}, {accountName: respon.approver}, {FunctionCode: "GET_WS_USER_SN_NAME"});
            InitFuncCodeRequest_({
                data: _data,
                successCallBack: function (jdata) {
                    $('#approver').text(jdata.data.NAME || '');
                }
            });
        }
        $('#buttom').show();
        workOrderId = respon.workOrderId;
        sapTaskId = respon.sapTaskId;
        data = $.extend({}, {sapTaskId: respon.sapTaskId}, {FunctionCode: "MR_ITEM_SYN_DETAILS"});
        InitFuncCodeRequest_({
            data: data,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $(".mrItem").remove();
                    respon = jdata.data;
                    var html = '';
                    if(respon.length < 1){
                        html ="<tr class='mrItem'><td align='center' colspan='15'>N/A</td></tr>";
                    }else{
                        $.each(respon,function (index,value) {
                            console.log(value);
                            var ind = index + 1;
                            var smHtml = '';
                            if(value.ar == '1') {
                                smHtml = 'AR(' + undefineFilter(value.itemQty) + '' + undefineFilter(value.orderUnit) + ')';
                            }else{
                                smHtml = undefineFilter(value.itemQty) + '' + undefineFilter(value.orderUnit);
                            }
                            html += "<tr class='" + judgeColor(value.revRemark) + "'>" +
                                "<td align='center'>"+ ind +"</td>"+
                                "<td align='center'>" + undefineFilter(value.revRemark) + "</td>" +
                                "<td align='center'>" + undefineFilter(value.partNo) + "</td>" +
                                "<td align='center'>" + undefineFilter(value.originalPartNo) + "</td>" +
                                "<td align='center'>"+"</td>"+
                                "<td align='center'>" + undefineFilter(value.description) + "</td>" +
                                "<td align='center'>"+ smHtml +"</td>"+
                                "<td align='center'>" + undefineFilter(value.assetNum) + "</td>" +
                                "<td align='center'>"+"</td>"+
                                "<td align='center'>" + undefineFilter(value.udLotNum) + "</td>" +
                                "<td align='center'>" + undefineFilter(value.location) + "</td>" +
                                "<td align='center'>" + undefineFilter(value.shortageQty) + "</td>" +
                                "<td align='center'>"+''+"</td>"+
                                "<td align='center'>" + undefineFilter(value.remark) + "</td>" +
                                "<td align='center'>" + undefineFilter(value.revNote) + "</td>" +
                                "</tr>"
                        });
                    }
                    $("#singleAcNotice").append(html);
                } else {

                    MsgAlert({content: jdata.msgData[0] ? jdata.msgData[0] : jdata.msg, type: 'error'});
                }
            }
        });
    }
    function judgeColor(val) {
        if(val){
            switch(val){
                case 'D':
                    return 'mrItem delItem';
                case 'I':
                    return 'mrItem newItem';
                case 'U':
                    return 'mrItem chItem';
                default:
                    return 'mrItem'
            }
        }else{
            return 'mrItem'
        }
    }
    function apply() {
        $.ajax({
            url : basePath + "/api/v1/mr/mr/addMissProcess",
            dataType : "json",
            contentType : 'application/json;charset=utf-8',
            type : 'POST',
            data: JSON.stringify({mrNum: mrNo}),
            async : true,
            cache : false,
            beforeSend:function(){
                ajaxLoading();
                $('#saveBtn').text("提交中...")
            },
            success : function(obj, textStatus) {
                ajaxLoadEnd();
                console.log(obj);
                if(obj.code == '200'){
                    MsgAlert({content: '提交申请成功'});
                }else{
                    MsgAlert({content: obj.msgData[0] ? obj.msgData[0]:obj.msg, type: 'error'});
                }
                $('#saveBtn').text("保存");
            },
            error:function () {
                $('#saveBtn').text("保存");
            }
        });
    }
    function Revise() {
        let tdWorkType = $('#workType').text();
        let tdWorkTypeArray = ['TET','AMR','TOOL','STR','CR','FTW','CT','EUR','EDT','LM','DEFECT'];
        if(tdWorkTypeArray.indexOf(tdWorkType) == -1) {
            MsgAlert({content: "只有"+tdWorkTypeArray.join(",")+"可以编辑", type: 'error'});
            return;
        }
        let url = "/views/mr/revise_mr.shtml";
        let curWidth = $(window).width().toString();
        let curheight = $(window).height().toString();
        let params = {
            mrNo:mrNo,
            rev:rev,
            sapTaskId:sapTaskId,
            tabIndex:tabIndex,
            station:$("#station").text(),
            REQUIREDDATE:$("#requireDate").text()
        }
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: '',
            param: params,
            url: url
        });
    }
    function cancelDia() {
        $('#dd').dialog('open');
    }
    function cancel(){
        if($.trim($('#cancelReason').val()) == ''){
            MsgAlert({content: "请填写取消Reason", type: 'error'});
            return;
        }
        $('#dd').dialog('close');
        $.messager.confirm('', '确认取消？', function (r) {
            if (r) {
                $.ajax({
                    url : basePath + "/api/v1/mr/mr/cancel",
                    dataType : "json",
                    contentType : 'application/json;charset=utf-8',
                    type : 'POST',
                    data: JSON.stringify({sapTaskId: sapTaskId}),
                    async : true,
                    cache : false,
                    beforeSend:function(){
                        ajaxLoading();
                    },
                    success : function(obj, textStatus) {
                        ajaxLoadEnd();
                        console.log(obj);
                        if(obj.code == '200'){
                            if (param.OWindow.reload_) {
                                param.OWindow.reload_();
                            }else{
                                param.OWindow.location.reload();
                            }
                            param.OWindow.MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                            CloseWindowIframe();
                        }else{
                            MsgAlert({content: obj.msgData[0] ? obj.msgData[0]:obj.msg, type: 'error'});
                        }
                    },
                    error:function () {
                    }
                });
            } else {
                $('#dd').dialog('close');
            }
        });

    }

</script>
</html>