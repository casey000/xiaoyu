<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <meta http-equiv="X-UA-Compatible" content="IE=9;IE=10;IE=11;IE=EDGE"/>
    <!--#include virtual="/views/items/resource_.shtml"-->
    <script src="/js/workflow/activiti_workflow.js" type="text/javascript"></script>
    <script src="/js/jquery.media.js" type="text/javascript"></script>
    <!--<script src="/js/workflow/formtemplet.js" type="text/javascript"></script>-->
    <title></title>
    <style type="text/css">
        .tdl {
            width: 100px;
            font-size: 12px;
            color: #333;
            font-family: '\5FAE\8F6F\96C5\9ED1', Tahoma, Arial, Helvetica, sans-serif, "open sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        .J_iframe {
            border: 1px solid #D4D4D4;
            border-bottom: 0px;
        }

        .lay_right_1 {
            width: 40%;
            border: 1px solid #D4D4D4;
            border-left: 0px;
            clear: left;
            float: right;
            position: relative;
            overflow-x: hidden;
        }

        .lay_left {
            width: 60%;
            border: 1px solid #D4D4D4;
            border-right: 0px;
            float: left;
            position: absolute;
            overflow: hidden;
        }

        .btn {
            background-color: #18a689;
            border-color: #18a689;
            color: #FFF;
        }

        ._historyDg th {
            color: #333;
            font-size: 14px;
            font-family: '\5FAE\8F6F\96C5\9ED1', Tahoma, Arial, Helvetica, sans-serif, "open sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
            border: 1px solid #E6E6E6;
            cellspacing: 0;
            cellpadding: 0;
            border-collapse: collapse;
            border-spacing: 0px;
        }

        ._historyDg {
            color: #333;
            font-size: 14px;
            font-family: '\5FAE\8F6F\96C5\9ED1', Tahoma, Arial, Helvetica, sans-serif, "open sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
            border: 1px solid #E6E6E6;
            cellspacing: 0;
            cellpadding: 0;
            border-collapse: collapse;
            border-spacing: 0px;
        }

        ._historyDg td {
            width: 150px;
            padding: 0 4px;
            border-left: 1px solid #E6E6E6;
            border-top: 1px solid #E6E6E6;
        }

        ._historyDg tr {
            height: 25px;
        }
    </style>
    <script type="text/javascript">
        var param = {};
        var url;
        var TypeMap_ = {};
        var TASK_STATE_MAP = {
            "N": "未执行", "F": "已完成", "T": "已终止",
            "R": "已退回", "J": "已跳转", "H": "已转办"
        };

        function i18nCallBack() {
            var key = GetUrlPars(window.location).BUSINESS_KEY_;
            if (!key) {
                MsgAlert({content: "请求有误", type: 'error'});
                return;
            }
            if (key == 'WF_000102648') {
                window.location.href = "http://cscsupplier.sichuanair.com/views/YWorkFlow/EmCmpOa.shtml?BUSINESS_KEY_=WF_000102648&trustCode=23a6cf4b24f190050455d00753bfc5a58fa9cd78e2aec58b1db895e58541ad10";
            }
            InitFuncCodeRequest_({
                data: {key: key, FunctionCode: "WS_FLOW_OA_GET_DATA"},
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        param = jdata.data;
                        if (!jdata.data) {
                            return;
                        }
                        $("#workflow").DiagramWorkFlow({
                            imageUrl: "/api/activiti/diagram/flowimage?procInstId=" + param.PROC_INST_ID,   //流程图url
                            traceUrl: '',
                            isRevert: true,//是否还原展示流程图，{还原Activiti裁剪后的流程图，即将偏移量x=x+minX,y=y+minY}
                            offsetX: 0,  //偏移量X
                            offsetY: 0   //偏移量Y
                        });
                        InitResources();
                        InitFuncCodeRequest_({
                            data: {procInstId: param.PROC_INST_ID, FunctionCode: "WS_FLOW_HIS_TASK_LIST"},
                            successCallBack: function (jdata) {
                                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    var _data = jdata.data;
                                    var _htmls = "<table><tr><th>审批角色</th><th>办理人员</th><th>审批意见</th><th>任务状态</th><th>开始时间</th><th>完成时间</th><th>耗时</th></tr>";
                                    if (_data) {
                                        for (var i = 0; i < _data.length; i++) {
                                            _htmls += "<tr><td>" + undefinedToString(_data[i].TASK_NAME) + "</td><td>" + undefinedToString(_data[i].OPERATOR_UNAME) + "</td><td>" +
                                                undefinedToString(_data[i].TASK_NOTES) + "</td><td>" + undefinedToString(taskStatus(_data[i].ACT_STATE, _data[i].RECORD_STATE)) +
                                                "</td><td>" + undefinedToString(_data[i].START_TIME) + "</td><td>" + undefinedToString(_data[i].END_TIME) +
                                                "</td><td>" + undefinedToString(toMsTimeString(_data[i].DURATION || _data[i].DURATION_0)) + "</td></tr>";
                                        }
                                    }
                                    _htmls += "</table>";
                                    $("#historyDg").append(_htmls);
                                }
                            }
                        });
//                        InitHistoryDG(param.PROC_INST_ID);
                    } else {
                        MsgAlert({content: jdata.msg, type: 'error'});
                    }
                }
            });
        }

        // 将undefined转换成''
        function undefinedToString(_value) {
            if (!_value || typeof(_value) == 'undefined') {
                return "";
            } else {
                return _value;
            }
        }

        // 获取任务状态
        function taskStatus(actState, recordState) {
            var v = [TASK_STATE_MAP[actState]];
            if (recordState && recordState != 'N' && recordState != 'F') {
                v.push(TASK_STATE_MAP[recordState])
            }
            return v.join(",")
        }

        function InitResources() {
            InitFuncCodeRequest_({
                data: {
                    FunctionCode: 'PROCESS_FORM_RESOURCE',
                    taskId: param.TASK_ID, flowDefId: param.FLOW_DEF_ID
                },
                successCallBack: function (jdata) {
                    if (jdata.code != RESULT_CODE.SUCCESS_CODE) {
                        MsgAlert({content: jdata.msg, type: 'error'});
                        return;
                    }
                    var resource = jdata.data.data;
                    var form = jdata.data.form;
                    var execution = jdata.data.execution;
                    var node = jdata.data.node;
                    var variables = eval(node.variables);
                    var options = arrangeVariables(variables);
                    $.each(options, function (k, it) {
                        if (it[0].varOption == 'Textbox') {
                            var vdata = {titleName: it[0].varName, fieldName: it[0].varKey, value: ''};
                            if (typeof(TypeMap_[it[0].varKey]) == 'undefined') {
                                TypeMap_[it[0].varKey] = it[0].varDataType || '';
                            }
                        } else if (it[0].varOption == 'Combobox') {
                            var vdata = {titleName: it[0].varName, fieldName: it[0].varKey, options: []};
                            $.each(it, function (k1, it1) {
                                vdata.options.push({text: it1.varValue, value: it1.varValue});
                                if (typeof(TypeMap_[it1.varKey]) == 'undefined') {
                                    TypeMap_[it1.varKey] = it1.varDataType || '';
                                }
                            });
                        }
                    });
                    var resource_ = toCamelCase(resource);
                    if (typeof(InitLoadResource) == 'function') {
                        InitLoadResource(resource, execution, node);
                    }
                }
            });
        }

        /**
         * 组装选项数据
         * @param vars
         * @returns {{}}
         */
        function arrangeVariables(vars) {
            var m = {};
            $.each(vars, function (k, v) {
                if (v.varOption != 'Hidden') {
                    var lst = m[v['varKey']] || [];
                    lst.push(v);
                    m[v['varKey']] = lst;
                }
            });
            return m;
        }

        function InitLoadResource(resource, execution, node) {
            var DOC_NAME = resource.DOC_NAME;
            var DOC_URL = resource.DOC_URL;
            url = DOC_URL + DOC_NAME;
            if (!DOC_NAME) {
                url = "";
                MsgAlert({content: "审批文件名为空", type: 'error'});
            }
            if (!DOC_URL) {
                url = "";
                MsgAlert({content: "审批文件请求路径为空", type: 'error'});
            }
            if (url != '') {
                $('#iframe0').attr('src', '/views/YWorkFlow/YWorkFlowPdf.shtml');
            }
            oaUrl = "/views/YWorkFlow/YWorkFlowOa.shtml?BUSINESS_KEY_=" + execution.businessKey;
            $("#formUrl").val(oaUrl);
            InitDataForm()

        }

        //查询办理人及启动人信息
        function InitDataForm() {
            InitFuncCodeRequest_({
                data: {taskId: param.TASK_ID, FunctionCode: "Y_WORKFLOW_GET_DATA"}, successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        ParseFormField_(jdata.data, $("#mform"), Constant.CAMEL_CASE);
                        initDataGrid(jdata.data.ENTITY_NUM, jdata.data.ENTITY_TYPE)
                    } else {
                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                    }
                }
            });
        }

        //同意的时候，默认意见为“同意”，不同意的时候，意见必填
        function getAdvice() {
            var adopt = $("#adopt").val();
            var notes = $("#notes").textbox("getValue").trim();

            if (adopt == "Y") {
                if (!notes)
                    $("#notes").textbox({value: "同意"});
            } else {
                if (!notes) {
                    MsgAlert({content: "请填写处理意见", type: 'error'});
                    return;
                }
            }
            //查询当前登录人信息
            $.ajax({
                type: 'post',
                data: {"trustCode": GetUrlPars(window.location).trustCode},
                url: Constant.BASE_URL + "getLoginDetail",
                dataType: "json",
                success: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
//                        $("#trustCode").val(jdata.data[2].trustCode);
                        doSubmit(jdata)
                    } else {
                        MsgAlert({content: jdata.msg, type: 'error'});
                    }
                },
                error: function () {

                }
            });
        }

        function GetUrlPars() {
            var url = location.search;
            var theRequest = {};
            if (url.indexOf("?") != -1) {
                var str = url.substr(1);
                strs = str.split("&");
                for (var i = 0; i < strs.length; i++) {
                    var sTemp = strs[i].split("=");
                    theRequest[sTemp[0]] = (sTemp[1]);
                }
            }
            return theRequest;
        }

        function doSubmit(msg) {

            if (confirm("您确定要提交吗?")) {
                var $form = $("#mform");
                var isValidate = $form.form('validate');
                if (!isValidate) {
                    return false;
                }
                var data = $form.serializeObject();
                checkDD();//检测是否有发送短信等任务 add by  zwj
                data = $.extend({}, data, {
                    FunctionCode: 'PROCESS_TASK_SUBMIT', //PROCESS_TERMINATE_TASK
                    taskId: param.TASK_ID, flowDefId: param.FLOW_DEF_ID,
                    typeMap: JSON.stringify(TypeMap_)
                });
                InitFuncCodeRequest_({
                    data: data,
                    successCallBack: function (jdata) {
                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                            MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_err:ERRMSG.COMMON.COMMON.OPT_SUCCESS')});
                            InitFuncCodeRequest_({
                                data: {
                                    trustCode: GetUrlPars(window.location).trustCode,
                                    url: "/api/updateWsSysOatoamro"
                                }, successCallBack: function (jdata) {
                                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                    } else {
                                        MsgAlert({content: jdata.msg ? jdata.msg : jdata.data, type: 'error'});
                                    }
                                }
                            });
                            window.location.replace("http://172.18.8.92/mybox/fleshopener.htm");
                        } else {
                            MsgAlert({content: jdata.msg, type: 'error'});
                        }
                    }
                });
            }
        }

        function checkDD() {
            var $form = $("#mform");
            var data = $form.serializeObject();
            data = $.extend({}, data, {
                FunctionCode: 'Y_MM_DINGDONG_CHECK',
                procInstId: param.PROC_INST_ID, flowDefId: param.FLOW_DEF_ID,
                typeMap: JSON.stringify(TypeMap_)
            });
            InitFuncCodeRequest_({
                data: data,
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        MsgAlert({content: "发送短信等成功"});
                    }
                }
            });
        }

        function initDataGrid(num, entity_type) {
            var pageSize = Math.floor(($("#mlayout").height() - 40) / 30);
            $("#r_dg").MyDataGrid({
                identity: "dg3",
                sortable: true,
                singleSelect: false,
                pagination: false,
                queryParams: {OBJNR: num, ENTITY_TYPE: entity_type},
                pageSize: pageSize, pageList: [pageSize],
                columns: {
                    param: {FunctionCode: 'SAP_ZFTP_GET'},
                    alter: {
                        FILENAME: {
                            formatter: function (value, row, index) {
                                return '<a href="javascript:void(0);" rowindex="' + index + '" class="attach">' + value + '</a>'
                            }
                        }
                    }
                },
                onClickRow: function (rowIndex, rowData, value) {
                    if (!rowData) {
                        return;
                    }
                    InitFuncCodeRequest_({
                        data: {
                            pkid: '',
                            myurl: rowData.DRE_URL,
                            filename: rowData.FILENAME,
                            FunctionCode: 'SYS_HTTP_FTP_DOWN'
                        },
                        successCallBack: function (jdata) {
                            if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                doPost(Constant.API_URL + "SYS_HTTP_FTP_DOWN", {
                                    pkid: '',
                                    myurl: rowData.DRE_URL,
                                    filename: rowData.FILENAME,
                                    down: 'Y'
                                });
                            } else {
                                MsgAlert({content: jdata.msg, type: 'error'});
                            }
                        }
                    });
                }
            })
        }

        // 批办过程
        function InitHistoryDG(procInstId) {
            $("#historyDg").MyDataGrid({
                identity: 'historyDg',
                width: 800,  //宽度
                height: 455,  //高度
                columns: {
                    param: {FunctionCode: 'WS_FLOW_HIS_TASK_LIST'},
                    alter: {
                        DURATION: {
                            formatter: function (value, row, index) {
                                return toMsTimeString(row.DURATION || row.DURATION_0);
                            }
                        },
                        ACT_STATE: {
                            formatter: function (value, row, index) {
                                var v = [TASK_STATE_MAP[row.ACT_STATE]];
                                if (row.RECORD_STATE && row.RECORD_STATE != 'N' && row.RECORD_STATE != 'F') {
                                    v.push(TASK_STATE_MAP[row.RECORD_STATE])
                                }
                                return v.join(",")
                            }
                        },
                    }
                },
                queryParams: {procInstId: procInstId},
                onLoadSuccess: function (data) {
                    console.log(data);
                },
                contextMenus: [],
                toolbar: [
                    {
                        key: "COMMON_RELOAD", text: $.i18n.t('common:COMMON_OPERATION.RELOAD'),
                        handler: function () {
                            common_reload_({identity: identity});
                        }
                    }
                ]
            });
        }
    </script>
</head>
<body class="ibody">
<div class="ibox-content">
    <form id="mform">
        <!-- 业务数据展示 start-->
        <input type="hidden" name="key" id="key"/>
        <input type="hidden" name="entityNum" id="entityNum"/>
        <input type="hidden" name="money" id="money"/>
        <input type="hidden" name="entityType" id="entityType"/>
        <input type="hidden" name="stepName" id="stepName"/>
        <input type="hidden" name="no" id="no"/>
        <input type="hidden" name="name" id="name"/>
        <input type="hidden" name="phone" id="phone"/>
        <input type="hidden" name="dept" id="dept"/>
        <input type="hidden" name="formUrl" id="formUrl"/>
        <input type="hidden" name="creatPhone" id="creatPhone"/>
        <input type="hidden" name="creatTime" id="creatTime"/>
        <input type="hidden" name="creatNo" id="creatNo"/>
        <input type="hidden" name="creatName" id="creatName"/>
        <input type="hidden" name="creatDept" id="creatDept"/>
        <input type="hidden" name="projectName" id="projectName"/>
        <input type="hidden" name="instanceTitle" id="instanceTitle"/>
        <input type="hidden" name="trustCode" id="trustCode"/>
        <!--<input type="hidden" name="commitId" id="commitId"/>-->
        <input name="" id="taskId" type="hidden"/>
        <div id="tabs" class="easyui-tabs">
            <div title="正文信息">
                <iframe class="J_iframe" id="iframe0" name="iframe0" width="100%" height="480px;"
                        src="/views/YWorkFlow/YWorkFlowPdf.shtml" frameborder="0" data-id="index_v1.html"
                        seamless></iframe>

                <div id="mlayout" class="easyui-layout" style="height: 35%;">
                    <div id="lay_left" class="lay_left">
                        <tr>
                            <td>
                                <table class="table table-bordered table-info" id="mtable" style="width: 100%">
                                    <tr>
                                        <th class="tdl"> 是否通过：</th>
                                        <td class="tdr">
                                            <select id="adopt" name="adopt" editable="false" style="width: 80px;">
                                                <option value="Y">通过</option>
                                                <option value="N">不通过</option>
                                                <!--<creatTime value="N">不通过</creatTime>-->
                                            </select>
                                        </td>
                                    </tr>
                                    <tr>
                                        <th class="tdl"> 处理意见：</th>
                                        <td class="tdr">
                                            <input id="notes" class="easyui-textbox easyui-validatebox" name="notes"
                                                   data-options="multiline:true, validType:['maxLength[200]'] "
                                                   style="height:50px; width: 100%;"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="6" align="center">
                                            <input id="canSubmit" class="btn" type="button" style="margin-bottom: 5px;"
                                                   onclick="getAdvice();" value="提交"/>
                                        </td>
                                    </tr>
                                </table>
                            </td>
                        </tr>
                    </div>
                    <div id="lay_right" class="lay_right_1" data-options="region:'east'">
                        <table id="r_dg"></table>
                    </div>
                </div>
            </div>
            <div title="流程节点" style="">
                <div id="workflow" style="irflow-x: scroll;"></div>
            </div>
            <div title="批办过程" style="">
                <table id="historyDg" class="_historyDg"></table>
            </div>
        </div>
    </form>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
</body>
</html>