<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>流程任务管理</title>
</head>
<body class="ibody">
<table id="dg"></table>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var param = {};

    function i18nCallBack() {
        param = getParentParam_();
        InitFuncCodeRequest_({
            data: {FunctionCode: 'PROCESS_ACTTASK_LIST', procInstId: param.processInstId},
            successCallBack: function (jdata) {
                if (jdata.code != RESULT_CODE.SUCCESS_CODE) {
                    layer.msg(jdata.msg, {icon: 5});
                    return;
                }
                var data = toUnderlineCaseArray(jdata.data);
                var treeData = HandleTreeData_(data, 'PID');
                var tdata_ = WarpTreeGridData_(treeData, "0", ['ID', 'PID']);
                InitDataGrid(tdata_);
            }
        });
    }

    function InitDataGrid(tdata_) {
        var identity = 'dg';
        $("#dg").MyDataGrid({
            identity: identity,
            idField: "ID",
            treeField: "OPERATOR_UNAME",
            data: tdata_,
            pagination: false,
            title: $.i18n.t('RES.PROCESS_ACTTASK_LIST.TITLE'),
            rowStyler: function (row) {
                if ((row.ID + '').indexOf('SUGGEST') != 0) {
                    if (!row.END_TIME) {
                        return 'color: #000;font-weight:bold;';
                    }
                }
            },
            columns: {
                param: {FunctionCode: 'PROCESS_ACTTASK_LIST'},
                alter: {
                    END_TIME: {
                        formatter: function (value, row, index) {
                            if ((row.ID + '').indexOf('SUGGEST') != 0) {
                                if (!value) {
                                    return "<span style='color: red;'>执行中</span>";
                                }
                            }
                            return value;
                        }
                    },
                    DURATION: {
                        formatter: function (value, row, index) {
                            if (!value) {
                                return "";
                            }
                            var ms = value % 1000;
                            value = Math.floor(value / 1000);
                            var r = toDateDiffStr(value);
                            return r ? r : ms + "毫秒";
                        }
                    },
                    OPERATOR_UNAME: {
                        formatter: function (value, row, index) {
                            if (!value) {
                                return "";
                            }
                            return value;
                        }
                    }
                }
            },
//            queryParams : { },
            contextMenus: [],
            toolbar: [
                {
                    key: "COMMON_RELOAD", text: $.i18n.t('common:COMMON_OPERATION.RELOAD'),
                    handler: function () {
                        common_reload_({identity: identity});
                    }
                }
            ]
        });
    }

    /** 刷新列表数据 */
    function reload_() {
        $("#dg").datagrid("reload");
    }

</script>
</body>
</html>