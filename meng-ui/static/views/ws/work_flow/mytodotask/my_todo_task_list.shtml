<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title data-i18n="RES.D.TITLE">我的待办任务</title>
</head>
<body class="ibody">
<div id="tabs" class="easyui-tabs" style="width: 100%; height: 100%;">
    <div id="tab01" title="待办工作流" style="display: none; padding: 2px; overflow: hidden;">
        <fieldset id="field01" class="fieldset_eui">
            <!--<legend data-i18n="common:COMMON_OPERATION.SEARCH">搜索</legend>-->
            <form id="ffSearch" method="post">
                <div id="searchBar">
                    <table cellspacing="0" cellpadding="2" class="table table-bordered table-info">
                        <tr>
                            <th style="width: 80px;text-align: center">任务描述：</th>
                            <td style="width: 110px">
                                &nbsp;<input class="easyui-textbox" id="description" name="description"
                                             style="width: 100px"/>
                            </td>
                            <th style="width: 80px;text-align: center">流程名称：</th>
                            <td style="width: 110px">
                                &nbsp;<input class="easyui-textbox" id="operatorCode" name="operatorCode"
                                             style="width: 100px"/>
                            </td>

                            <th style="width: 80px;text-align: center">任务名称：</th>
                            <td style="width: 110px">
                                &nbsp;<input class="easyui-textbox" id="mpActype" name="mpActype" style="width: 100px"/>
                            </td>
                            <th style="width: 80px;text-align: center">业务KEY：</th>
                            <td style="width: 110px">
                                &nbsp;<input class="easyui-textbox" id="itemNo" name="itemNo" style="width: 100px"/>
                            </td>
                            <td colspan="2">
                                &nbsp;&nbsp;
                                <a href="javascript:void(0)" class="searchBtn" onclick="onSearch_('list1')"><span
                                        data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>
                                <a href="javascript:void(0)" class="clearBtn" onclick="onClear_('list1')"><span
                                        data-i18n="common:COMMON_OPERATION.RESET">重置</span></a>

                            </td>
                        </tr>
                    </table>
                </div>
            </form>
        </fieldset>
        <table id="list1"></table>
    </div>
    <div id="tab02" title="待签领工作流" style="display: none; padding: 2px; overflow: hidden;">
        <fieldset id="field02" class="fieldset_eui">
            <!--<legend data-i18n="common:COMMON_OPERATION.SEARCH">搜索</legend>-->
            <form id="search2" method="post">
                <div>
                    <table cellspacing="0" cellpadding="2" class="table table-bordered table-info">
                        <tr>
                            <th style="width: 80px;text-align: center">业务名称：</th>
                            <td style="width: 110px">
                                &nbsp; <input class="easyui-textbox" id="executionName" name="executionName"
                                              style="width: 100px"/>
                            </td>

                            <th style="width: 80px;text-align: center">任务名称：</th>
                            <td style="width: 110px">
                                &nbsp;<input class="easyui-textbox" name="name" style="width: 100px"/>
                            </td>
                            <th style="width: 80px;text-align: center">业务KEY：</th>
                            <td style="width: 110px">
                                &nbsp;<input class="easyui-textbox" id="businessKey" name="businessKey"
                                             style="width: 100px"/>
                            </td>
                            <td colspan="2">
                                &nbsp;&nbsp;
                                <a href="javascript:void(0)" class="searchBtn"
                                   onclick="onSearch_('list2','#search2')"><span
                                        data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>&nbsp;&nbsp;
                                <a href="javascript:void(0)" class="clearBtn"
                                   onclick="onClear_('list2','#search2')"><span
                                        data-i18n="common:COMMON_OPERATION.RESET">重置</span></a>
                            </td>
                        </tr>
                    </table>
                </div>
            </form>
        </fieldset>
        <table id="list2"></table>
    </div>
    <div id="tab03" title="已办理工作流" style="display: none; padding: 2px; overflow: hidden;">
        <fieldset id="field03" class="fieldset_eui">
            <!--<legend data-i18n="common:COMMON_OPERATION.SEARCH">搜索</legend>-->
            <form id="search3" method="post">
                <div>
                    <table cellspacing="0" cellpadding="2" class="table table-bordered table-info">
                        <tr>
                            <th style="width: 80px;text-align: center">流程名称：</th>
                            <td style="width: 110px">
                                &nbsp; <input class="easyui-textbox" name="executionName" style="width: 100px"/>
                            </td>

                            <th style="width: 80px;text-align: center">任务名称：</th>
                            <td style="width: 110px">
                                &nbsp;<input class="easyui-textbox" name="name" style="width: 100px"/>
                            </td>
                            <th style="width: 80px;text-align: center">业务KEY：</th>
                            <td style="width: 110px">
                                &nbsp;<input class="easyui-textbox" name="businessKey" style="width: 100px"/>
                            </td>
                            <td colspan="2">
                                &nbsp;&nbsp;
                                <a href="javascript:void(0)" class="searchBtn"
                                   onclick="onSearch_('list3','#search3')"><span
                                        data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>&nbsp;&nbsp;
                                <a href="javascript:void(0)" class="clearBtn"
                                   onclick="onClear_('list3','#search3')"><span
                                        data-i18n="common:COMMON_OPERATION.RESET">重置</span></a>
                            </td>
                        </tr>
                    </table>
                </div>
            </form>
        </fieldset>
        <table id="list3"></table>
    </div>

    <div id="tab04" title="待办任务" style="display: none; padding: 2px; overflow: hidden;">
        <fieldset id="field04" class="fieldset_eui">
            <!--<legend data-i18n="common:COMMON_OPERATION.SEARCH">搜索</legend>-->
            <form id="search4" method="post">
                <div>
                    <table cellspacing="0" cellpadding="2" class="table table-bordered table-info">
                        <tr>
                            <th data-i18n="" style="width:80px;" align="right">状态：</th>
                            <td>
                                <input class="easyui-combobox" id="state" name="state" style="width:120px;"/>
                            </td>
                            <th data-i18n="" style="width:80px;" align="right">标题：</th>
                            <td>
                                <input class="easyui-textbox" name="msgTitle" id="msgTitle" style="width:200px"
                                       data-options=""/>
                            </td>
                            <th data-i18n="" style="width:80px;" align="right">内容：</th>
                            <td>
                                <input class="easyui-textbox" name="msgBody" id="msgBody" style="width:200px"
                                       data-options=""/>
                            </td>
                            <td >
                                &nbsp;&nbsp;
                                <a class="searchBtn" onclick="onSearch_('list4','#search4')">
                                    <span data-i18n="common:COMMON_OPERATION.QUERY">查询</span></a>&nbsp;&nbsp;
                                <a class="clearBtn" onclick="onClear_('list4','#search4')"><span
                                        data-i18n="common:COMMON_OPERATION.RESET">重置</span></a>&nbsp;&nbsp;
                                <a href="javascript:void(0)" class="searchBtn"
                                   onclick="cal()"><span >定时器</span></a>&nbsp;&nbsp;
                            </td>
                        </tr>
                    </table>
                </div>
            </form>
        </fieldset>
        <table id="list4"></table>
    </div>

</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var loginUserId;
    var domainData;
    var PAGE_DATA = {};

    function i18nCallBack() {
        loginUserId = getLoginInfo().accountId;
        InitFuncCodeRequest_({
            data: {
                domainCode: "WS_FROM_UID,WS_TO_UID,MSG_STATE",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                domainData = DomainCodeToMap_(jdata.data.WS_FROM_UID);
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {

                    PAGE_DATA['state'] = DomainCodeToMap_(jdata.data["MSG_STATE"]);
                    $('#state').combobox({
                        panelHeight: '150px',
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        data: jdata.data.MSG_STATE,
                    });
                    $('#state').combobox('setValue','U');

                    InitDataGrid1();
                    InitDataGrid2();
                    InitDataGrid3();
                    InitDataGrid4();
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        })
    }

    function InitDataGrid1() {
        var identity = 'list1';
        $("#list1").MyDataGrid({
            identity: identity,
            columns: {
                param: {FunctionCode: 'PROCESS_REMAIN_TASK_LIST'}
            },
            validAuth: function (row, items) {
                return items;
            },
            rowStyler: function (index, row) {
                var days = row.REMAIN_DAY;
                if (days <= 0) {
                    return 'font-weight:bold;background-color:#FF0000;';//红色
                } else if (days > 0 && days < 5) {
                    return 'font-weight:bold;background-color:#FFFF00;';//橙黄FFA500
                }
            },
            contextMenus: [
                {
                    i18nText: "处理任务", auth: "",
                    onclick: function () {
                        //flowDefId : FLOW_DEF_ID  taskId: rowData.TASK_ID
                        var rowData = getDG(identity).datagrid('getSelected');
                        if (!rowData) {
                            MsgAlert({PWindow: window, content: $.i18n.t('msg_err:ERRMSG.NO_SELECT_ROW_ERROR')});
                            return;
                        }
                        InitFuncCodeRequest_({
                            data: {
                                FunctionCode: "PROCESS_GET_FORM",
                                taskId: rowData.TASK_ID,
                                flowDefId: rowData.FLOW_DEF_ID
                            },
                            successCallBack: function (jdata) {
                                var form = jdata.data.form;
                                common_page_({
                                    identity: identity,
                                    width: form.width || 800, height: form.height || 380,
                                    param: {
                                        TASK_ID: rowData.TASK_ID, FLOW_DEF_ID: rowData.FLOW_DEF_ID,
                                        PROC_DEF_ID: rowData.PROC_DEF_ID, PROC_INST_ID: rowData.PROC_INST_ID
                                    },
                                    title: "流程任务处理",
                                    url: form.formUrl
                                });
                            }
                        });
                    }
                },
                {
                    i18nText: "转办", auth: "",
                    onclick: function () {
                        //flowDefId : FLOW_DEF_ID  taskId: rowData.TASK_ID
                        var rowData = getDG(identity).datagrid('getSelected');
                        if (!rowData) {
                            MsgAlert({PWindow: window, content: $.i18n.t('msg_err:ERRMSG.NO_SELECT_ROW_ERROR')});
                            return;
                        }
                        common_add_edit_({
                            url: "/views/flow/work_flow_turn_to_account_select.shtml",
                            param: {
                                taskId: rowData.TASK_ID,
                                taskName: rowData.TASK_NAME,
                                successCallback: function (data) {
                                    reload_();
                                }
                            },
                            title: $.i18n.t("选择代办人"),
                            width: 520,
                            height: 300
                        });
                    }
                },
                {
                    i18nText: "查看流程图", auth: "",
                    onclick: function () {
                        var rowData = getDG(identity).datagrid('getSelected');
                        common_page_({
                            identity: identity, checkRowData: true, width: '90%', height: '90%',
                            param: {
                                PROC_DEF_ID: rowData.PROC_DEF_ID,
                                PROC_INST_ID: rowData.PROC_INST_ID,
                                BUSINESS_KEY: rowData.BUSINESS_KEY
                            },
                            title: "查看流程图",
                            url: "/views/ws/work_flow/flow_definition/flow_diagram_view.shtml"
                        });
                    }
                }
            ],
            onLoadSuccess: function () {

                setTimeout('setCount()', 500);
            },
            resize: function () {
                return tabs_standard_resize($('#tabs'), 64)
            }
        });
    }

    function InitDataGrid2() {
        var identity = 'list2';
        $("#list2").MyDataGrid({
            identity: identity,
            columns: {
                param: {FunctionCode: 'PROCESS_CLAIM_TASK_LIST'},
                alter: {
                    TRANSACTOR: {
                        formatter: function (value, row, index) {
                            var v = [row.USER_NAMES || ""];
                            value = "";
                            for (var i = 0; i < v.length; i++) {
                                value += value == "" ? v[i] : "," + v[i]
                            }
                            value += row.GROUP_NAMES ? "[" + row.GROUP_NAMES + "]" : "";
                            return value;
                        }
                    }
                }
            },
            validAuth: function (row, items) {
                return items;
            },
            contextMenus: [
                {
                    i18nText: "签领任务", auth: "",
                    onclick: function () {
                        var rowData = getDG(identity).datagrid('getSelected');
                        if (!rowData) {
                            MsgAlert({PWindow: window, content: $.i18n.t('msg_err:ERRMSG.NO_SELECT_ROW_ERROR')});
                            return;
                        }
                        layerConfirm_({
                            content: '您确定要签领此任务吗？',//$.i18n.t(ci18next),
                            yesFunc: function (index) {
                                InitFuncCodeRequest_({
                                    data: {FunctionCode: "PROCESS_CLAIM_TASK", taskId: rowData.TASK_ID},
                                    successCallBack: function (jdata) {
                                        if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                                            MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_err:ERRMSG.COMMON.SUCCESS_CODE')});
                                        } else {
                                            MsgAlert({content: jdata.msg, type: 'error'});
                                        }
                                        reload_();
                                    }
                                });
                            }
                        });

                    }
                },
                {
                    i18nText: "查看流程图", auth: "",
                    onclick: function () {
                        var rowData = getDG(identity).datagrid('getSelected');
                        common_page_({
                            identity: identity, checkRowData: true, width: '90%', height: '90%',
                            param: {
                                PROC_DEF_ID: rowData.PROC_DEF_ID,
                                PROC_INST_ID: rowData.PROC_INST_ID,
                                BUSINESS_KEY: rowData.BUSINESS_KEY
                            },
                            title: "查看流程图",
                            url: "/views/ws/work_flow/flow_definition/flow_diagram_view.shtml"
                        });
                    }
                }
            ],
            resize: function () {
                return tabs_standard_resize($('#tabs'), 64)
            }
        });
    }

    function InitDataGrid3() {
        var identity = 'list3';
        $("#list3").MyDataGrid({
            identity: identity,
            columns: {
                param: {FunctionCode: 'PROCESS_HAVEDTASK_LIST'},
                alter: {
                    TRANSACTOR: {
                        formatter: function (value, row, index) {
                            var v = [row.USER_NAMES || ""];
                            value = "";
                            for (var i = 0; i < v.length; i++) {
                                value += value == "" ? v[i] : "," + v[i]
                            }
                            value += row.GROUP_NAMES ? "[" + row.GROUP_NAMES + "]" : "";
                            return value;
                        }
                    }
                }
            },
            validAuth: function (row, items) {
                return items;
            },
            contextMenus: [
                {
                    i18nText: "查看流程图", auth: "",
                    onclick: function () {
                        var rowData = getDG(identity).datagrid('getSelected');
                        common_page_({
                            identity: identity, checkRowData: true, width: '90%', height: '90%',
                            param: {
                                PROC_DEF_ID: rowData.PROC_DEF_ID_,
                                PROC_INST_ID: rowData.PROC_INST_ID_,
                                BUSINESS_KEY: rowData.BUSINESS_KEY
                            },
                            title: "查看流程图",
                            url: "/views/ws/work_flow/flow_definition/flow_diagram_view.shtml"
                        });
                    }
                }
            ],
            resize: function () {
                return tabs_standard_resize($('#tabs'), 64)
            }
        });
    }

    //tab 标题数量setCount
    function setCount() {
        var i = 0;
        var total;
        var oldtitle;
        $.each($('#tabs').tabs("tabs"), function () {
            var title = $('#tabs .tabs-title').eq(i).html();
            var ot = title.split("(");
            switch (i) {
                case 0:
                    total = $("#list1").datagrid('getPager').pagination('options').total;
                    break;
                case 1:
                    total = $("#list2").datagrid('getPager').pagination('options').total;
                    break;
                case 3:
                    total = $("#list4").datagrid('getPager').pagination('options').total;
                    break;


                default:
                    total = 0;
            }
            if (i < 4) {
                $('#tabs').tabs('update', {
                    tab: this,
                    options: {
                        //count
                        title: ot[0] + '(' + total + ")"
                    }
                });
            }
            i++;
        });
    }


    /** 刷新列表数据 */
    function reload_() {
        $("#list1").datagrid("reload");
        $("#list2").datagrid("reload");
        $("#list3").datagrid("reload");
        $("#list4").datagrid("reload");
    }

    function InitDataGrid4() {
        var state = $('#state').combobox('getValue');
        var identity = 'list4';
        $("#list4").MyDataGrid({
            identity: identity,
            rowStyler: function (index, row) {
                var state = row.STATE;
                var days = row.REMAIN_DAY;
                if (state == 'U') {
                    if (days <= 0) {
                        return 'font-weight:bold;background-color:#FF0000;';//红色
                    } else if (days > 0 && days <= 5) {
                        return 'font-weight:bold;background-color:#FFFF00;';//橙黄FFA500
                    }
                }
            },
            queryParams: {loginUserId: loginUserId,state:state},
            resize: function () {
                return tabs_standard_resize($('#tabs'), 64)
            },
            columns: {
                param: {FunctionCode: 'PROCESS_MESSAGE_LIST'},
                alter: {
                    STATE: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['state'] [value];
                        }
                    },
                    DUE_DATE: {
                        type: 'date'
                    },
                    MSG_BODY: {
                        formatter: function (value, row, index) {
                            if (row.MSG_TYPE == 1) {
                                return '<a href="javascript:void(0);" onclick="shwowDetail(\'' + 'edit' + '\',\'' + index + '\')">' + value + '</a>';
                            }else{
                                return value;
                            }
                        },
                    },

                    STATE: {
                        formatter: function (value, row, index) {
                            switch (value) {
                                case 'R':
                                    return '已读';
                                case 'U':
                                    return "未读";

                            }
                        }
                    },
                    MSG_TYPE: {
                        formatter: function (value, row, index) {
                            switch (value) {
                                case '1':
                                    return '文本消息';
                                case '2':
                                    return "打开系统连接";
                                case '3':
                                    return "弹出新窗口";
                                default:
                                    return value;

                            }
                        }
                    },
                }

            },
            contextMenus: [
                {
                    i18nText: "处理任务", auth: "",
                    onclick: function () {
                        var rowData = getDG(identity).datagrid('getSelected');
                        if (!rowData) {
                            MsgAlert({PWindow: window, content: $.i18n.t('msg_err:ERRMSG.NO_SELECT_ROW_ERROR')});
                            return;
                        }
                        openDetai("edit",rowData);
                    }
                },   {
                    i18nText: "转发", auth: "",
                    onclick: function () {
                        var rowData = getDG(identity).datagrid('getSelected');
                        if (!rowData) {
                            MsgAlert({PWindow: window, content: $.i18n.t('msg_err:ERRMSG.NO_SELECT_ROW_ERROR')});
                            return;
                        }
                        transMsg(rowData);
                    }
                }

            ],
            onDblClickRow: function (index, field, row) {
                if(row.MSG_TYPE == 1){
                    shwowDetail("view", row);
                }
            },
            validAuth: function (row, items) {
                if (row.MSG_TYPE != "3") {
                    items['处理任务'].display = false;
                }
                if (row.STATE != "U") {
                    items['处理任务'].enable = false;
                }
                return items;
            },

        });
    }


    function openDetai(operation,row) {
        ShowWindowIframe({
            width: row.WIDTH,
            height: row.HEIGHT,
            title: row.MSG_TITLE,
            param: {operation:operation,type: row.MSG_DATA, recordId: row.RECORD_ID, msgpkid: row.PKID, msgData: row.MSG_DATA},
            url: row.MSG_LINK
        });
    }

    function transMsg(row) {
        ShowWindowIframe({
            width: 600,
            height: 300,
            title: '选择接收人',
            param: {msgpkid: row.PKID},
            url: '/views/trans_account_select.shtml'
        })
    }


    function cal(){
        ajaxLoading();
        InitFuncCodeRequest_({
            data: {FunctionCode: "PROCESS_MESSAGE_LIST_CAL"},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    MsgAlert({content: '操作成功'});
                    $("#list4").datagrid("reload");
                    ajaxLoadEnd();
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        })
    }


    /**消息提醒——点击查看详细信息*/
    function shwowDetail(operation,row) {
        if(operation == 'edit'){
            var rowDataS = $("#list4").datagrid('getData');
            row = rowDataS.rows[row];
        }
        setHaveRead(row.PKID);
        setTimeout("reload_()", 100);
        ShowWindowIframe({
            width: 748,
            height: 400,
            title: '详细信息',
            param: {rowData: row,operation:operation},
            url: '/views/ws/message/ws_message_edit_add.shtml'
        })
    }

    /**消息提醒——已读*/
    function setHaveRead(pkid) {
        InitFuncCodeRequest_({
            url: Constant.API_V1_URL + "message/updStatus",
            data: {pkid: pkid, state: 'R'},
            successCallBack: function (jdata) {
            }
        });
    }

    function reloadTodo() {
        $("#list4").datagrid("reload");
    }

</script>
</body>
</html>