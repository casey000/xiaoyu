<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->
    <meta charset="UTF-8">
    <title>edit_withdrawal_application</title>
    <link href="/css/nrc/nrc_add.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/icon.css">
    <link href="/css/mccdoc/to_commons.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="/views/cs/mrSelect.js"></script>
    <style type="text/css">
        .cai_type label {
            margin-right: 20px;
        }

        .sousuo_div {
            position: absolute;
            top: 0px;
            left: 0px;
            right: 0px;
            bottom: 0px;
            padding-top: 8px;
            z-index: 10;
        }

        .zhezhao {
            display: none;
            position: absolute;
            z-index: 9;
            top: 0px;
            bottom: 0px;
            right: 0px;
            left: 0px;
            background-color: #dadada75;
        }
        .red {
            color: red;
        }

        .fullZhezhao {
            display: block;
            position: absolute;
            z-index: 9;
            top: 0px;
            bottom: 0px;
            right: 0px;
            left: 0px;
            background-color: #dadada75;
        }
        .fullZhezhao_new{
            display: none;
            position: absolute;
            z-index: 9;
            top: 0px;
            bottom: 0px;
            right: 0px;
            left: 0px;
            background-color: #dadada75;
        }
        .fullZhezhao_udro{
            position: absolute;
            z-index: 9;
            top: 0px;
            bottom: 0px;
            right: 0px;
            left: 0px;
            background-color: #dadada75;
        }
        #materialLoding{
            display: none;
            width: 100%;
            height:100%;
            position: fixed;
            top:0;
            left:0;
            text-align: center;
            background-color: #eeeeee;
            opacity: 0.3;
        }
        .datagrid-mask-msg{
            margin-left:40%;
            font-weight: bold;
            font-size:14px;
            display: table-cell;
            vertical-align: middle;
            padding: 15px 30px;
        }

        input[id^="childPn"]::placeholder{
            color:#aaa;
        }
        .materialIn1:focus{
            border-color: #BBBBBB;
            border-radius: 5px;
            box-shadow: 0 0 3px 0 #d4d4d4;
            outline: 0;
        }
    </style>
    <script src="/js/common.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
    <script src="/js/datagrid_utils.js" type="text/javascript"></script>
</head>
<body>
<!--<div class="zhezhao" id="dazhehzao" onclick="zhezhao_hide()"></div>-->
<!--<div class="zhezhao" id="zhezhao"></div>-->
<div class="nrc_div">
    <div style="display: none"><input id="ccid" type="text"/> <input class="easyui-textbox" id="ac_id"/></div>
    <table class="addnrc_table"  width="100%">
        <tbody id="tbodysumTr">
        <tr style="display: none">
            <td><input class="easyui-textbox" id="addMrId" style="width: 85%" name="cancelStock.id"
                       type="text">
            </td>
        </tr>
        <tr>
            <td class="key" width="10%">退料类型</td>
            <td width="23%" >
                <input class="easyui-combobox no_entry" id="cancelStockType" name="cancelStock.cancelStockType"
                       style="width: 85%">
                <!--                <span id="cancelStockType" >领出未用退料</span>-->
            </td>
            <td class="key" width="10%">件号(PN)<span>*</span></td>
            <td  width="23%"><input class="easyui-textbox" id="pn" style="width: 85%" name="cancelStock.pn" disabled = "disabled" data-options="prompt:'只允许选择，无法直接输入!'"
                                    type="text">
                <img alt="" class="fangdajin" id="acBtn" onClick="pn_data('A',1)"  src="/img/search.png"/>
            </td>
            <td class="key">MR编号<span  class="mustClass">*</span></td>
            <td width="24%"><input class="easyui-textbox"  id="mrNo" style="width: 85%" name="cancelStock.mrNo" disabled = "disabled" data-options="prompt:'只允许选择，无法直接输入!'"
                       type="text">
                <img alt="" class="fangdajin" id="mrBtn" onClick="mr_data('A',1)"  src="/img/search.png"/>
                <!--                <img alt="" class="fangdajin" id="mrNob" onClick="" src="/img/search.png"/>-->
            </td>
        </tr>
        <tr>

            <td class="key" width="10%">批次号<span class="mustClass">*</span></td>
            <td   >
                <input class="easyui-textbox" id="batchNo" name="cancelStock.batchNo"
                       style="width: 85%">
            </td>
            <td class="key" width="10%">序号(SN)<span class="mustClass snClass">*</span></td>
            <td>
                <div  class="zhezhao"></div>
                <input class="easyui-textbox"  id="sn" style="width: 85%"name="cancelStock.sn"
                       type="text">
            </td>
            <td class="key">发料数量</td>
            <td><input class="easyui-textbox"  disabled="disabled" id="qty" style="width: 85%" name="cancelStock.qty"
                       type="text">
            </td>
        </tr>
        <tr>
            <td class="key">退料数量<span>*</span></td>
            <td><input class="easyui-textbox" id="cancelStockQty" style="width: 85%" name="cancelStock.cancelStockQty"
                       type="text">
            </td>
<!--            <td class="key">航材状态<span>*</span></td>-->
<!--            <td>-->
<!--                <input  class="easyui-combobox no_entry" id="airMaterialState" name="cancelStock.airMaterialState" style="width: 85%"-->
<!--                />-->
<!--            </td>-->
            <td class="key">退料人<span class="red">*</span></td>
            <td>
<!--                <input class="easyui-textbox easyui-validatebox" data-options="validType:['maxLength[20]'] " id="sendBackName" name="sendBackName" style="width: 85%"/>-->
                <!--                <input style="display: none"/>-->
                <input class="easyui-textbox input-sign" id="finderSign"/>
            </td>
            <td class="key">退料单位<span>*</span></td>
            <td  width="23%"  onclick="tipsForUnit()">
                <input id="unit" name="cancelStock.unit"
                       class="easyui-combobox" style="width: 150px;" />
            </td>
        </tr>
        <tr>
            <td class="key">目的航站 <span>*</span></td>
            <td><input class="easyui-textbox" id="station" readonly="readonly" style="width: 85%"
                       type="text"><img alt="" id="stationBtn" onClick="stationQuery()" src="/img/search.png"
                                        style="position: absolute;right: 15px;top: 11px;"/></td>
<!--            <td class="key">工作航站</td>-->
<!--            <td><input class="easyui-textbox" id="fromStation" readonly="readonly" style="width: 85%" type="text">-->
<!--                &lt;!&ndash;                <img alt="" class="fangdajin" id="fromstationImg" onClick="stationQuery()" src="/img/search.png"/>&ndash;&gt;-->
<!--            </td>-->
<!--            <td class="key">计划性<span>*</span></td>-->
<!--            <td>-->
<!--                <input  class="easyui-combobox no_entry" id="plan" name="cancelStock.plan" style="width: 85%"-->
<!--                />-->
<!--            </td>-->
            <td class="key">退料单状态</td>
            <td>
                <input class="easyui-textbox" id="cancelStockStatus" style="width: 85%" name="cancelStock.cancelStockStatus" disabled ="disabled" value="新建"
                       type="text">
            </td>
            <td class="key">是否随机运输<span>*</span></td>
            <td id="transport_type_id">
                <input type="radio" id="transport-yes" value="1" name="dm"  ><label for="transport-yes">是</label>
                <input type="radio" id="transport-no" value="2" name="dm" ><label for="transport-no">否</label>
            </td>
        </tr>
        <tr>

            <td  class="key">退料时间<span class="red">*</span></td>
            <td >
                <input class="easyui-datetimebox" id="sendBackTime" name="repTime"   style="width: 70%" type="text">
            </td>
<!--            <td class="key noReturnLib">MR行号(测试专用)<span class="red">*</span></td>-->
<!--            <td class="noReturnLib"><input class="easyui-textbox"  id="mrItem" style="width: 85%" name="cancelStock.mrItem"-->
<!--                       type="text">-->
<!--            </td>-->
<!--            <td class="key noReturnLib">消耗件(测试专用)<span class="red">*</span></td>-->
<!--            <td class="noReturnLib"><input class="easyui-textbox"  id="rotating" style="width: 85%" name="cancelStock.rotating"-->
<!--                       type="text">-->
<!--            </td>-->
            <td class="key">航材状态<span class="red">*</span></td>
            <td class="">
                <input class="easyui-combobox no_entry" id="airMaterialState" name="cancelStock.airMaterialState"
                       style="width: 85%">
            </td>
            <td class="key noReturnLib"></td>
            <td class="noReturnLib"></td>
            <!--    切换风格        -->
            <td class="key returnLib" style="display: none">退库方式</td>
            <td class="returnLib" style="display: none">
                <input type="radio" id="returnLib-yes" value="Y" name="rl" onClick="returnMatefullSur()" checked="true"><label for="returnLib-yes">整包</label>
                <input type="radio" id="returnLib-no" value="N" name="rl" onClick="returnMatefullSur()"><label for="returnLib-no">余料</label>
            </td>
<!--            <td class="key returnLib" style="display: none"></td>-->
<!--            <td class="returnLib" style="display: none"></td>-->
        </tr>
        <tr class="returnMaterial" style="display: none">
            <td class="key" colspan="6">改装包剩余航材清单
                <button id="sumBtn" style="float:right;margin-right:20px" onClick="add_sumBtnMaterrial()" disabled>添加</button>
            </td>
        </tr>
        <tr class="returnMaterial" style="display: none">
            <td class="key">件号<span>*</span></td>
            <td class="key">序号</td>
            <td class="key">退料数量<span>*</span></td>
            <td class="key">退料单位<span>*</span></td>
            <td class="key" colspan="2">操作</td>
        </tr>
        <tr class="returnMaterial" style="display: none">
            <td class="returnMaterialTd">
<!--                <input class="easyui-textbox" id="childPn" style="width: 80%" name="cancelStock.childPn" disabled = "disabled" data-options="prompt:'只允许选择，无法直接输入!'" type="text">-->
                <div  class="fullZhezhao fullZhezhaoSucc_0"></div>
                <input class="easyui-textbox materialIn" id="childPn0" style="width: 82%" name="cancelStock.childPn" disabled = "disabled" data-options="prompt:'只允许选择，无法直接输入!'"  type="text">
                <img alt="" class="fangdajin" id="childPnBtn" src="/img/search.png" onClick="fullPndata(0)"/></td>
            <td class="returnMaterialTd">
                <div  class="fullZhezhao fullZhezhaoSucc_0"></div>
                <input class="easyui-textbox materialIn" id="childSn0" name="cancelStock.childSn" style="width: 82%">
            </td>
            <td class="returnMaterialTd">
                <div  class="fullZhezhao fullZhezhaoSucc_0"></div>
                <div  class="fullZhezhao_udro fullZhezhao_0" style="display: none"></div>
                <input class="easyui-textbox materialIn" id="childQty0" name="cancelStock.childQty" style="width: 82%">
            </td>
            <td class="returnMaterialTd">
                <div  class="fullZhezhao fullZhezhaoSucc_0"></div>
                <input class="easyui-textbox materialIn" id="childUnit0" name="cancelStock.childUnit" style="width: 82%">
            </td>
            <td colspan="2">
                <div  class="fullZhezhao fullZhezhaoSucc_0"></div>
                <div class="file_duihao submiS0" style="display: none;float:left;">✔</div>
                <div class="icon-delete submiF0" style="display: none;float:left;width:20px;height: 30px;margin-left:11px"></div>
<!--                <button id="delBtn0" style="float:right;margin-right:23px" onClick="delMaterialRow()">删除</button>-->
            </td>
        </tr>
<!--        <tr class="noReturnMaterial">-->
        <tr style="display: none">
        <td class="key">附件</td>
            <td colspan="6" id="attachament_td">
                <div id="attach_file">

                </div>
            </td>
        </tr>
        </tbody>
    </table>
    <table class="addnrc_table" style="margin-top: 5px">
        <tbody>
        <tr>
            <td class="key">拆下挂签里的拆下故障原因</td>
        </tr>
        <tr>
            <td>
                <textarea id="description" name="cancelStock.description" maxlength="1000"></textarea>
            </td>
        </tr>
        </tbody>
    </table>
    <div class="button_a" style="position: relative">
        <a id="submitBtn" class="save display_button"  onclick="save();return false;" >提交</a>
<!--        <a class="save display_button" onclick="submit();return false;">提交</a>-->
    </div>
    <div id="materialLoding">
        <p class="datagrid-mask-msg">正在处理，请稍等...</p>
    </div>
</div>

<script type="text/javascript">
    var issubShow;//用于记录余料提交成功的行数
    var udroArr=[];//用于记录余料清单下件号是不是周转件或者控修件
    var sumBtn_tr=1;
    var mrRotating;
    var mrItem_mr;
    var lisr_file = 0;
    var cancelSocket;
    var workcancelSocket =getParentParam_();
    var objData;
    var hangcaitype_list = [] ;
    var WorkOrderData = {};
    const userName = getLoginInfo().userName;
    const userId = getLoginInfo().accountNumber;

    //立即执行start
    $(function () {
        //下拉数据加载
        addDropDate();
        //添加附件
        add_atta_input_flie();
    //    显示数据
    //     getWorkData();
    //    只能选择不能输入
        noEnter();
        //选择之后触发事件
        switchClass();

    })
    //立即执行end

    //遮罩start
    function zhezhao_hide() {
        $(".sousuo_div").hide();
        $("#dazhehzao").hide();
    }
    //遮罩end

    function filter(tlble, pn, sn, pos) {
        //.date_tr 数据显示行，用于区分标题行
        $("#" + tlble + " tr").each(function (i, e) {
            $(e).hide();
            if (filterTr(e, pn, sn, pos)) {
                $(e).show();
            }
        })
    }

    //赋值操作start
    // function assignment(datas) {
    //     //MR编号
    //     $("#mrNo").textbox("setValue",datas.mrNo);
    //     //任务编号
    //     // $("#cancelStockNo").textbox("setValue",cancelSocket.cancelStockNo);
    //     //部件状态
    //     $("#airMaterialState").textbox("setValue",datas.airMaterialState);
    //     //退库数量
    //     $("#cancelStockQty").textbox("setValue",datas.cancelStockQty);
    //     // 退库类型
    //     // $("#cancelStockType").textbox("setValue",datas.cancelStockType);
    //     //cc编号
    //     $("#ccNo").textbox("setValue",datas.ccNo);
    //     // 件号
    //     $("#pn").textbox("setValue",datas.pn);
    //     //序号
    //     $("#sn").textbox("setValue",datas.sn);
    //     // 数量
    //     $("#qty").textbox("setValue",datas.qty);
    //     // 单位
    //     $("#unit").textbox("setValue",datas.unit);
    //     //批次号
    //     $("#batchNo").textbox("setValue",datas.batchNo);
    //     //目的航站
    //     // $("#station").textbox("setValue",datas.toStation);
    //     //退库单状态
    //     // $("#cancelStockStatus").textbox("setValue",datas.cancelStockStatus);
    //     //描述
    //     $("#description").val(datas.description);
    //     //描述
    //     // $("#noNeedDescription").val(datas.reason);
    //     //是否随机运输
    //     // $("#transport").val(datas.transport);
    //
    //     //拆下航站
    //     $("#fromStation").textbox("setValue",workcancelSocket.fromStation);
    //     //是否随机运输
    //     if(!!datas.transport){
    //         if(datas.transport == "n"){
    //             $("#transport-no").attr("checked","true")
    //         }else if(datas.transport == "y"){
    //             $("#transport-yes").attr("checked","true")
    //         }
    //     };
    //     //退料人名字
    //     $("#sendBackName").textbox("setValue", datas.sendBackName);
    //
    //     //退料时间
    //     $("#sendBackTime").textbox("setValue",datas.sendBackTime);
    //     //退库单号
    //     $("#cancelStockId").html(datas.cancelStockId);
    //     //无需退库
    //     // if(!!datas.noNeed == 'y'){
    //     //     $("#noNeed").prop('checked',true);
    //     // }
    // }
    //赋值操作end

    //提交start
    function submit() {
        //post数据赋值
        var data = getData();
        //校验


        if(validForm(data)){
            return false;
        };
        var url = "/api/v1/cancelSock/edit";
        $.ajax({
            type: "POST",
            url: url,
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(data),
            dataType: "json",
            success: function (data) {
                //console.log(data);
                if (data.code == 200) {
                    alert("成功！");
                    if (typeof workcancelSocket.OWindow.queryCCTable == "function"){workcancelSocket.OWindow.queryCCTable()} ;
                    window.close();
                } else if (data.msgData && data.msgData[0]) {
                    alert(data.msgData[0]);
                } else {
                    alert(data.msg);
                }
            },
            error: function () {
                window.alert("提交失败！");
            }
        });
    }
    //提交end

    //获取数据操作start
function getData() {
   var sendBackName,sendBackNumber;
   var finderSign = $("#finderSign").textbox("getValue");
    if (!!finderSign) {
        sendBackNumber = finderSign.match(/\((.+?)\)/)[1];
        sendBackName = finderSign.split("(")[0];
    };
    var data = {
        'flightNo':workcancelSocket.flightNo,
        'flightId':workcancelSocket.flightId,
        'id': $("#addMrId").val(),
        'pn': $("#pn").val(),
        'sn': $("#sn").val(),
        //批次号
        'batchNo': $("#batchNo").val(),
        //mr编号
        'mrNo': $("#mrNo").val(),
        //数量
        'qty': Number($("#qty").val()),
        'cancelStockQty': Number($("#cancelStockQty").val()),
        //单位
        // 'unit':workcancelSocket.unit ,
        'unit':$("#unit").textbox("getValue"),
        // 'unit':"EA",
        //mr行号
        // "mrItem":$("#mrItem").val(),
        "mrItem":mrItem_mr,


        //部件（航材）状态
        'airMaterialState': $("#airMaterialState").combobox("getValue"),
        //退库单状态
        // 'cancelStockStatus': $("#cancelStockStatus").val(),
        //退库类型
        'cancelStockType': $("#cancelStockType").combobox("getValue"),
        //目标航站
        'toStation': $("#station").val(),
        //是否随机运输
        // 'transport': $("input[type='radio']:checked").val(),
        'transport':$("input[name='dm']:checked").val(),
        //退库原因
        'reason': $("#description").val(),
        //退料人名字
        // 'sendBackName': $("#sendBackName").textbox("getValue"),
        'sendBackName':sendBackName,
        'sendBackNumber':sendBackNumber,
        //退料时间
        'sendBackTime': $("#sendBackTime").textbox("getValue"),
        //无需退库
        // 'noNeed': $("#noNeed").prop('checked'),
        //不退库原因
        // 'reason':$("#noNeedDescription").val(),
        //拆下航站
        'fromStation':workcancelSocket.fromStation,
        'workorderId':workcancelSocket.workorderId,
        //退库单
        // 'cancelStockId':$("#cancelStockId").val(),
    //    计划性
    //     "planType": $("#plan").combobox("getValue"),
        //余料件号
        'childPn':$("#childPn0").val(),
        //余料序号
        'childSn':$("#childSn0").val(),
        //退料数量
        'childQty':$("#childQty0").val(),
        //退料单位
        'childUnit':$("#childUnit0").val()


    };
    return data
}
    //获取数据操作end

    //航站查询start
    function stationQuery() {
        var title_ = $.i18n.t('航站查询');
        var curWidth = ($(window).width() * 0.5).toString();
        var curheight = ($(window).height() * 0.5).toString();
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: title_,
            param: {},
            url: "/views/tbm/flb/station_query.shtml"
        });
    }
    //航站查询end

    //添加附件功能start
    function add_file(i) {
        let file = " <div id=\"atta_input_flie_" + i + "\" class=\"atta_input_fliecss atta_input_fliecss_move\">\n" +
            "       <input class=\"textbox easyui-validatebox\" type=\"file\" id=\"atta_input_flie_a" + i + "\" size=\"300\" name=\"file\" data-options=\"required:true\"/>            \n" +
            "                    <div class=\"add_jiahao\" onclick=\"add_atta_input_flie()\" style='margin-top: 5px'></div>\n" +
            " <div class='file_duihao' onclick=\"atta_input_flie('atta_input_flie_a'+" + i + ")\">✔</div>\n" +
            "                    <div class=\"jianhao icon-delete\" onclick=\"delete_atta_input_flie(atta_input_flie_" + i + ")\" style='margin-top: 4px'></div>\n" +
            "                </div>";
        let html_row = $(file);
        $("#attachament_td").append(html_row);
    }
    //添加附件功能end

    //附件上传增加按钮start
    function add_atta_input_flie() {
        add_file(lisr_file);
        lisr_file++;
    }
    //附件上传增加按钮end

    //附件上传删除按钮start
    function delete_atta_input_flie(val) {
        let geshu = document.getElementsByClassName('atta_input_fliecss_move');
        debugger
        if (geshu.length == 1) {
            return
        }
        let newP = $(val);
        if (newP.length > 0) {
            newP.remove();
        }
    }
    //附件上传删除按钮end

    //附件上传打钩按钮start
    function atta_input_flie(id) {
        if ($("#addMrId").val() != "") {
            var fileInput = $("#" + id).get(0).files[0];
            if (fileInput) {
                $.ajaxFileUpload({
                    url: Constant.API_URL + 'ATTACHMENT_UPLOAD',
                    secureuri: false,
                    fileElementId: id, //file控件id
                    dataType: 'json',
                    data: {
                        "fileCategory": "cancelStock",
                        "sourceId":  cancelSocket.id,
                    },
                    success: function (data) {
                        if (data.code == 200) {
                            var file = document.getElementById("" + id + "");
                            file.value = '';
                            $("#" + id).value = "";
                            add_file_show(cancelSocket.id);
                        }

                    }

                })
            } else {
                alert("请选择上传文件！");
            }
        } else {
            alert("请先提交，再回到对应页面上传附件！")
        }

    }
    //附件上传打钩按钮end

    //删除已添加附件start
    function deleteFile(fileid) {
        var _url = basePath + "/api/v1/mccdoc/to_base_info/deleteAttachment";
        P.$.dialog.confirm('Delete Selected ?', function () {
            $.ajax({
                url: _url,
                type: "get",
                data: {'pkid': fileid},
                dataType: "json",
                cache: false,
                success: function (data) {
                    if (data.code == 200) {
                        P.$.dialog.alert("Success");
                        $("#qc_table_detail #appendTr").remove();
                        add_file_show(cancelSocket.id);
                        // add_file_show(122);
                    }
                }
            });
        }, function () {
        });
    }
    //删除已添加附件end

    //附件增加文件start
    function add_file_show(id) {
        $("#attach_file").empty();
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: id,
                CATEGORY: "cancelStock",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                for (var ind in jdata.data) {
                    let file = " <div id=\"input_flie_show" + jdata.data[ind].PKID + "\" class=\"atta_input_fliecss\" style=\"line-height: 30px;width: 100%;    height: 30px;border-bottom: 1px solid #ccc;\">\n" +
                        "                            <div style=\"width: 60%;text-align: left;\"><a style=\"color:red;font-size: 14px\" onclick=\"downFile(" + jdata.data[ind].PKID + "," + jdata.data[ind].PKID + ")\">" + jdata.data[ind].ORG_NAME + "</a></div>\n" +
                        "\n" +
                        "                        <div class=\"jianhao icon-delete\" onclick=\"deleteFile(" + jdata.data[ind].PKID + ")\"></div>\n" +
                        "                        </div>";
                    let html_row = $(file);
                    $("#attach_file").append(html_row);
                }

            }
        });
    }
    //附件增加文件end

    //    件号搜索start
    function pn_data(type, ind) {
        $.pnSelect({
            success: function (data) {
                if (type == "A") {
                    $("#pn").textbox('setValue', data.partno);
                    getDataByPn(data.partno);
                    $("#sn").textbox("setValue","");
                    $("#qty").textbox("setValue","");
                    $("#batchNo").textbox("setValue","");
                    // $("#mrItem").textbox("setValue","");
                    mrItem_mr="";
                    $("#unit").textbox("setValue","");
                    // $("#rotating").textbox("setValue","");
                    mrRotating="";
                    $("#mrNo").textbox("setValue","");
                    if(!!data.issueunit && data.issueunit != ""){
                        $("#unit").textbox("setValue",data.issueunit);
                    }else {
                        $("#unit").textbox("setValue","EA");
                    }
                    if(data.udro == "0"){
                        //消耗件
                        // $("#rotating").textbox("setValue","Y");
                        mrRotating="Y";
                    }else {
                        //周转件
                        // $("#rotating").textbox("setValue","N");
                        mrRotating="N"
                    };
                    if(data.udro == "0"||$("#cancelStockType").combobox("getValue")=="3"){
                        $("#sn").textbox("setValue","");
                        $(".zhezhao").show();
                        $(".snClass").hide();
                    }else {
                        $(".zhezhao").hide();
                        $(".snClass").show();
                    }

                    // $("#jian_name" + ind).textbox('setValue', data.description);
                    // $("#sn" + ind).textbox('setValue', data.itemnum);
                    // if ($("#sn").textbox("getValue")) {
                    //     caixia_gouxin( data.partno, "");
                    //     caixia_weizhi(data.partno, "no", 'OFF');
                    // }

                } else if (type == "B") {
                    $("#original" + ind).textbox('setValue', data.partno);
                    $("#jian_name" + ind).textbox('setValue', data.description);
                    zhuang_gouxin(data.partno, "");
                    if ($("#stazone").textbox("getValue")) {
                        caixia_weizhi(data.partno, "no", 'ON');
                    }

                } else if (type == "C") {
                    $("#cai_original" + ind).textbox('setValue', data.partno);
                } else if (type == "D") {
                    $("#zhuang_original" + ind).textbox('setValue', data.partno);
                }
                refitPackage();
            }
        })
    }
    //    件号搜索end

    //    下拉框数据加载start
    function addDropDate() {
        //    添加航材部件状态数据
        $("#airMaterialState").combobox({
            textField: 'TEXT',
            valueField:  'VALUE',
            data: [{
                TEXT :"可用件",
                VALUE:"B"
            },{
                TEXT: "不可用件",
                VALUE: "A"
            },{
                TEXT: "待观察件",
                VALUE: "C"
            }
            ],
        });
        //    退库类型
        $("#cancelStockType").combobox({
            textField: 'TEXT',
            valueField:  'VALUE',
            data: [{
                TEXT: "领出未用退料",
                VALUE: "2"
            },{
                TEXT: "装机未用退料",
                VALUE: "4"
            },{
                TEXT: "拆下无序号件退料",
                VALUE: "3"
            },
            //     {
            //     TEXT: "改装包退料",
            //     VALUE: "5"
            // }
            ],
        });
        // $("#plan").combobox({
        //     textField: 'TEXT',
        //     valueField:  'VALUE',
        //     data: [{
        //         TEXT :"非计划性",
        //         VALUE:"1"
        //     },{
        //         TEXT: "计划性",
        //         VALUE: "2"
        //     }
        //     ],
        // });
        //    点击选择工作者
        $("#sendBackName").MyComboGrid({
            idField: 'USER_NAME',  //实际选择值
            textField: 'USER_NAME', //文本显示值
            panelHeight: '180px',
            required: true,
            width: "70%",
            params: {FunctionCode: 'FLOW_WORK_ACCOUNT'},
            columns: [[
                {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                {field: 'USER_NAME', title: '审核人', width: 50}
            ]],
            onHidePanel: function () {
                var t = $(this).combogrid('getValue');
                if (t != null && t != '' & t != undefined) {
                    if (selectRow == null || t != selectRow.USER_NAME) {//没有选择或者选项不相等时清除内容
                        alert('请选择，不要直接输入！');
                        $(this).combogrid({value: ''});
                    }
                }
            },
            onSelect: function (index, row) {
                selectRow = row;
                $("#repname").val(row.ACCOUNT_NUMBER);
            }
        });
        $("#finderSign").textbox({
            value: `${userName}(${userId})`,
            editable: false,
            icons: [{
                iconCls:'icon-search',
                handler: function(e){
                    $.dialog.setting.extendDrag = true;
                    UserUtils.showDialog({
                        callback:function(data){
                            let user_info = data[0];
                            $("#finderSign").textbox("setValue", user_info.userName + "(" + user_info.sn + ")")
                        }
                    });
                }
            }, {
                iconCls:'icon-cross',
                handler: function(e){
                    $("#finderSign").textbox("setValue", "")
                }
            }]
        });
        $('#unit').combobox({
            panelHeight: 'auto',
            data: materialUnit,
            valueField: 'VALUE',
            textField: 'TEXT'
        });
    }
    //    下拉数据加载end

    //根据件号请求数据
    var materialUnit = [];
    function getDataByPn(pn) {
        var postGetUnitParam = {
            "pageModel":{
                "page":1,
                "rows":15
            },
            "vParts":{
                "partno":pn,
                "description":"",
                "udro":"",
                "issueunit":"",
                "prohibitive":"",
                "restrictive":"",
                "isAccurate":true,
                "llp":"",
                "ht":"",
                "udpmaitem":"",
                "repairable":"",
                "udshelfcon":"",
                "uddgr":""
            }
        };
        axios.post("/part/sap_list", postGetUnitParam).then((response) => {
            var data =  response;
            if(data.data.code == 200 && !!data.data.data.pageModel.gridModelData.length > 0 && !!data.data.data.pageModel.gridModelData[0].allunit){
                var getMaterialUnit = data.data.data.pageModel.gridModelData[0].allunit.split(',');
                materialUnit = [];
                for(var i=0;i<getMaterialUnit.length;i++ ){
                    var unit = {};
                    unit.VALUE = getMaterialUnit[i];
                    unit.TEXT = getMaterialUnit[i];
                    materialUnit.push(unit);
                }
                $('#unit').combobox('loadData', materialUnit);
            }
        }).catch(err => {
            console.log(err);
        });
    }

    //提示
    function tipsForUnit(){
        if(!$("#pn").val()){
            alert("请先输入件号(PN)");
            return ;
        }
    }

    //加载数据字典,获取到下拉选择项 start
    // queryDataDict({
    //     "domainCode": "AIR_MATERIAL_STATE",
    //     succFn:function(data){
    //         if(data){
    //             // air_material_state_list = data.AIR_MATERIAL_PROPERTIES;
    //             // jiahua_list = data.CC_PLAN_TYPE;
    //             hangcaitype_list = data.AIR_MATERIAL_STATE;
    //             // caihuanyuanyin_list = data.CC_SOURCE_TYPE;
    //         }
    //     }
    // });
    // $("#cancelStockStatus").combobox({
    //     valueField: 'VALUE',
    //     textField: 'TEXT',
    //     panelHeight: '70px',
    //     data: hangcaitype_list,
    // });
    //加载数据字典,获取到下拉选择项 end

    //    领出未用退库数据校验start
    function validForm(datas) {
    // debugger
        //标记
        var isValid = false,flag = 0;
        var sn = datas.sn;
        var pn = datas.pn;
        var batchNo = datas.batchNo;
        var mrNo = datas.mrNo;
        var mrItem = datas.mrItem;
        var unit = datas.unit;
        var qty = datas.qty;
        var cancelStockQty = datas.cancelStockQty;
        var airMaterialState = datas.airMaterialState;
        var cancelStockType = datas.cancelStockType;
        var toStation = datas.toStation;
       // var cancelStockStatus =datas.cancelStockStatus;
        var transport = datas.transport;
        var sendBackName = datas.sendBackName;
        var sendBackTime = datas.sendBackTime;
        // var noNeed = datas.noNeed;
        // var fromStation = datas.fromStation;
        // var cancelStockId = cancelSocket.cancelStockId;
        var reason = datas.reason;
        //处理退料说明输入空格，去除空格
        reason=reason.trim();
        // var planType = datas.planType;
        var reason = datas.reason;
        if(!!cancelStockType==false){
            alert("请选择退料类型");
            isValid = true;
        }else if(!!pn==false){
            alert("请选择件号");
            isValid = true;
        }else if(!!unit==false){
            alert("请输入退料单位");
            isValid = true;
        }
        else if(!!mrItem==false){
            alert("请输入mr行号");
             isValid = true;
        }
        else if(!!sn==false){
            alert("请输入序号");
            isValid = true;
        }else if(!!batchNo==false){
            alert("请输入批次号");
            isValid = true;
        }else if(!!mrNo==false){
            alert("请输入MR编号");
            isValid = true;
        }else if(!!cancelStockQty==false){
            alert("请输入退料数量");
            isValid = true;
        }else if(!(/(^[1-9]\d*$)/.test(cancelStockQty))){
                alert("请输入正整数退料数量");
                isValid = true;
        }
        else if(!!airMaterialState==false){
            alert("请选择航材状态");
            isValid = true;
        }
        else if(!!toStation==false){
            alert("请选择目的航站");
            isValid = true;
        }else if(!!sendBackName==false){
            alert("请选择退料人");
            isValid = true;
        }
        // else if(!!planType==false){
        //         alert("请选择计划");
        //         isValid = true;
        // }
        else if(!!sendBackTime==false){
            alert("请选择退料时间");
            isValid = true;
        }else if(!!reason==false){
            alert("请输入退料说明/部件故障描述");
            isValid = true;
        } else if(cancelStockQty > qty){
            alert("退库数量大于发料数量");
            isValid = true;
        }else if(transport == null || transport == ""){
            alert('运输方式必填');
            isValid = true;
        }
        //     else if(fromStation != toStation && (transport == null || transport == "")){
        //     alert('任务航站与目的航站不同，运输方式必填');
        //     isValid = true;
        // }
            else if(judgeDate(sendBackTime)>0){
            alert('退料时间不能大于当前时间');
            isValid = true;
        }


        return  isValid
    }
    //    领出未用退库数据校验end

    //    无序号拆下件退库数据校验start
    function noNubValidForm(datas) {
        // debugger
        //标记
        var isValid = false,flag = 0;
        var sn = datas.sn;
        var pn = datas.pn;
        var batchNo = datas.batchNo;
        var mrNo = datas.mrNo;
        var unit = datas.unit;
        var qty = datas.qty;
        var cancelStockQty = datas.cancelStockQty;
        var airMaterialState = datas.airMaterialState;
        var cancelStockType = datas.cancelStockType;
        var toStation = datas.toStation;
        // var cancelStockStatus =datas.cancelStockStatus;
        var transport = datas.transport;
        var sendBackName = datas.sendBackName;
        var sendBackTime = datas.sendBackTime;
        // var noNeed = datas.noNeed;
        var fromStation = datas.fromStation;
        // var cancelStockId = cancelSocket.cancelStockId;
        var description = datas.description;
        // var planType = datas.planType;
        var reason = datas.reason;

        if(!!cancelStockType==false){
            alert("请选择退料类型");
            isValid = true;
        }else if(!!pn==false){
            alert("请选择件号");
            isValid = true;
        }else if(!!cancelStockQty==false){
            alert("请输入退料数量");
            isValid = true;
        }
        else if(!!unit==false){
            alert("请输入退料单位");
            isValid = true;
        }
        else if(!!airMaterialState==false){
            alert("请选择航材状态");
            isValid = true;
        }
        else if(!!toStation==false){
            alert("请选择目的航站");
            isValid = true;
        }else if(!!sendBackName==false){
            alert("请选择退料人");
            isValid = true;
        }
        // else if(!!planType==false){
        //     alert("请选择计划");
        //     isValid = true;
        // }
        else if(!!sendBackTime==false){
            alert("请选择退料时间");
            isValid = true;
        }else if(transport == null || transport == ""){
            alert('运输方式必填');
            isValid = true;
        }else if(judgeDate(sendBackTime)>0){
            alert('退料时间不能大于当前时间');
            isValid = true;
        }

        return  isValid
    }
    //    无序号拆下件退库数据校验end


//    保存按钮start
    function save() {
        $("#submitBtn").attr("disabled",true).css({"pointer-events":"none","opacity":"0.2"});
        //获取已填数据
        var hadData = getData();
        //校验数据
        // if($("#cancelStockType").combobox("getValue")=="拆下无序号件退料"||$("#cancelStockType").combobox("getValue")=="3"||$("#rotating").textbox("getValue")=="Y"){
        if($("#cancelStockType").combobox("getValue")=="拆下无序号件退料"||$("#cancelStockType").combobox("getValue")=="3"||mrRotating=="Y"){

            if(noNubValidForm(hadData)){
                $("#submitBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});
                return false;
            };
        }else {
            if(validForm(hadData)){
                $("#submitBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});
                return false;
            };
        }
        //增加余料清单数据
        getMaterialdata(hadData);
        // if(validForm(hadData)){
        //     return false;
        // }else {
            //    发送数据获取ID，成功后赋值ID start
            //     $.ajax({
            //         type: "POST",
            //         url: "/api/v1/cancelSock/edit",
            //         data: JSON.stringify(hadData),
            //         contentType: "application/json;charset=utf-8",
            //         dataType: "json",
            //         success: function (data) {
            //             if(data.code == 200){
            //                 cancelSocket = data.data;
            //                 console.log(cancelSocket);
            //                 if(data.hasOwnProperty("data")){
            //                     if(data.data.hasOwnProperty("id")){}
            //                     $("#addMrId").textbox("setValue",data.data.id);
            //                 }
            //
            //                 //重载父页面
            //                 if (typeof workcancelSocket.OWindow.queryCCTable == "function"){workcancelSocket.OWindow.queryCCTable()} ;
            //                 alert("提交成功！");
            //                 window.close();
            //             }else {
            //                 alert(data.msg);
            //                 $("#submitBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});
            //             }
            //
            //         },
            //         error: function (obj) {
            //             alert("提交失败！");
            //             $("#submitBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});
            //         }
            //     });
            //    发送数据获取ID，成功后赋值IDend
        // };
    }
//    保存按钮end

    //禁止输入start
    function noEnter(){
        $(".no_entry").combobox({
            required: true,
            editable: false,
        })
    }
    //禁止输入end

//    获取工单信息并显示start
    function getWorkData(){
        $.ajax({
            type: "GET",
            url: "/api/v1/workOrder/getWorkOrder/"+ workcancelSocket.workorderId,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                //console.log(data);
                WorkOrderData = data.data;
                $("#fromStation").textbox("setValue",WorkOrderData.station);
                console.log("工单数据获取成功");
                console.log(data);
            },
            error: function () {
               alert("工单数据获取失败");
            }
        });
    }
//    获取工单信息并显示end

//    判断选择时间和当前时间start
    function judgeDate(tomodifyDate){
        return new Date(tomodifyDate).getTime()-new Date().getTime();
    }
//    判断选择时间和当前时间end

//    切换风格start
    function switchClass() {
        $("#cancelStockType").combobox({
            onSelect: function () {
                if($("#cancelStockType").combobox("getValue")=="3"){
                    $(".zhezhao").show();
                    $("#sn").textbox("setValue","");
                    $("#qty").textbox("setValue","");
                    $("#pn").textbox("setValue","");
                    $("#batchNo").textbox("setValue","");
                    // $("#mrItem").textbox("setValue","");
                    mrItem_mr="";
                    $("#unit").textbox("setValue","");
                    // $("#rotating").textbox("setValue","");
                    mrRotating="";
                    $("#mrNo").textbox("setValue","");
                    $(".mustClass").hide();

                    //退库方式风格切换
                    $(".noReturnLib").show();
                    $(".returnLib").hide();

                    //余料清单和附件/退库原因风格切换
                    // $(".noReturnMaterial").show();
                    $(".returnMaterial").hide();

                    //切换退料类型事删除余料清单添加的行
                    $(".deleteTr").remove();
                }else{
                    $(".zhezhao").hide();
                    $(".mustClass").show();
                    $("#sn").textbox("setValue","");
                    $("#qty").textbox("setValue","");
                    $("#pn").textbox("setValue","");
                    $("#batchNo").textbox("setValue","");
                    // $("#mrItem").textbox("setValue","");
                    mrItem_mr="";
                    $("#unit").textbox("setValue","");
                    // $("#rotating").textbox("setValue","");
                    mrRotating="";
                    $("#mrNo").textbox("setValue","");

                    //退库方式风格切换
                    $(".noReturnLib").show();
                    $(".returnLib").hide();

                    //余料清单和附件/退库原因风格切换
                    // $(".noReturnMaterial").show();
                    $(".returnMaterial").hide();

                    //切换退料类型事删除余料清单添加的行
                    $(".deleteTr").remove();
                }
            }
        });
    }
//    切换风格end

    //获取根据pn号获取mr号，mr行号，SN 号 批次号，数量 start
    function getDataByPnAndWorkId() {

    }
    //获取根据pn号获取mr号，mr行号，SN 号 批次号，数量 end

    //    MR搜索start
    function mr_data(type, ind) {
        if($("#pn").val()==""){
            alert("请先选择件号")
            return false
        };
        $.mrSelect({
            pn : $("#pn").val(),
            sn : $("#sn").val(),
            batchNo:$("#batchNo").val(),
            mrNo:$("#mrNo").val(),
            workorderId: workcancelSocket.workorderId,
            success: function (data) {
                if (type == "A") {
                    $('#batchNo').textbox({
                        onChange: function(value) {
                            $("#sn").textbox("setValue","");
                            // $("#qty").textbox("setValue","");
                            // $("#mrItem").textbox("setValue","");
                            mrItem_mr="";
                            $("#mrNo").textbox("setValue","");
                        }
                    });
                    $("#qty").textbox("setValue",data.qty);
                    $("#batchNo").textbox("setValue",data.batchNo);
                    $("#pn").textbox("setValue",data.pn);
                    // $("#mrItem").textbox("setValue",data.mrItem);
                    mrItem_mr=data.mrItem
                    $("#mrNo").textbox("setValue",data.mrNo);
                    $("#sn").textbox("setValue",data.sn);
                    // $("#jian_name" + ind).textbox('setValue', data.description);
                    // $("#sn" + ind).textbox('setValue', data.itemnum);
                    // if ($("#sn").textbox("getValue")) {
                    //     caixia_gouxin( data.partno, "");
                    //     caixia_weizhi(data.partno, "no", 'OFF');
                    // }
                    $('#batchNo').textbox({
                        onChange: function(value) {
                            $("#sn").textbox("setValue","");
                            $("#qty").textbox("setValue","");
                            $("#mrItem").textbox("setValue","");
                            mrItem_mr="";
                            $("#mrNo").textbox("setValue","");
                        }
                    });

                } else if (type == "B") {
                    $("#original" + ind).textbox('setValue', data.partno);
                    $("#jian_name" + ind).textbox('setValue', data.description);
                    zhuang_gouxin(data.partno, "");
                    if ($("#stazone").textbox("getValue")) {
                        caixia_weizhi(data.partno, "no", 'ON');
                    }

                } else if (type == "C") {
                    $("#cai_original" + ind).textbox('setValue', data.partno);
                } else if (type == "D") {
                    $("#zhuang_original" + ind).textbox('setValue', data.partno);
                }

            }
        })
    }
    //    MR搜索end

    //获取改装包标识和页面展示切换start
    function refitPackage(){
        var pn=$("#pn").val();
        var cancelStockType=$("#cancelStockType").combobox("getValue");
        if(pn&&cancelStockType){
            $.ajax({
                type: "GET",
                url: "/api/v1/material/isModifyPackage/"+pn,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if(data.code== 200){
                        if(cancelStockType=="2"&&data.data){
                            //退库方式风格切换
                            $(".noReturnLib").hide();
                            $(".returnLib").show();

                            //余料清单和附件/退库原因风格切换
                            // $(".noReturnMaterial").hide();
                            $(".returnMaterial").show();

                            //改装包连续查询时，重置退库方式默认为整包start
                            $("#returnLib-yes").click();
                            var rl=$("input[name='rl']:checked").val();
                            if(rl=="Y"){
                                $("#sumBtn").attr("disabled",true).css({"pointer-events":"auto","opacity":"0.5"});
                                $(".fullZhezhao").show();
                                $(".fullZhezhao_new").show();
                                //选整包时，清空余料清单填写的数据
                                $("#childPn0").textbox("setValue","");
                                $("#childSn0").textbox("setValue","");
                                $("#childQty0").textbox("setValue","");
                                $("#childUnit0").textbox("setValue","");

                                //切换退料类型事删除余料清单添加的行
                                $(".deleteTr").remove();
                            }
                            //改装包连续查询时，重置退库方式默认为整包end

                            //处理余料下输入框样式继承问题
                            if($(".returnMaterialTd span")){
                                $(".returnMaterialTd span").css({"width":"80%"});
                                $(".returnMaterialTd input").css({"width":"100%"});

                                //切换退料类型事删除余料清单添加的行
                                $(".deleteTr").remove();
                            }
                        }else{
                            //退库方式风格切换
                            $(".noReturnLib").show();
                            $(".returnLib").hide();

                            //余料清单和附件/退库原因风格切换
                            // $(".noReturnMaterial").show();
                            $(".returnMaterial").hide();

                            //切换退料类型事删除余料清单添加的行
                            $(".deleteTr").remove();
                        }
                    }else{
                        alert(data.msg);
                    }

                }
            });
        }
    }
    //获取改装包标识和页面展示切换end

    //退库方式控制添加余料清单start
    function returnMatefullSur(){
        var rl=$("input[name='rl']:checked").val();
        if(rl=="Y"){
            $("#sumBtn").attr("disabled",true).css({"pointer-events":"auto","opacity":"0.5"});
            $(".fullZhezhao").show();
            $(".fullZhezhao_new").show();
            //选整包时，清空余料清单填写的数据
            $("#childPn0").textbox("setValue","");
            $("#childSn0").textbox("setValue","");
            $("#childQty0").textbox("setValue","");
            $("#childUnit0").textbox("setValue","");
            $(".submiS0").hide();//切换整包时，隐藏第一行已提交成功的标记
            //切换退料类型事删除余料清单添加的行
            $(".deleteTr").remove();

        }else if(rl=="N"){
            issubShow=0;//用于记录余料提交成功的行数
            $("#sumBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});
            $(".fullZhezhao").hide();
            $(".fullZhezhao_new").hide();
        }
    }
    //退库方式控制添加余料清单end

    //余料清单添加按钮功能start
    function sumBtnMaterrial(i){
        var rl=$("input[name='rl']:checked").val();
        if(rl){
            var fullMateial=`<tr class=\"returnMaterial deleteTr\">
                                <td class=\"returnMaterialTd\">
                                    <div  class=\"fullZhezhao_new fullZhezhaoSucc_${i}\"></div>
                                    <input class=\"textbox easyui-textbox  materialIn\" id=\"childPn${i}\" style=\"width: 80%;padding-left:4px;background: rgb(235, 235, 228);\" name=\"cancelStock.childPn\" disabled placeholder="只允许选择，无法直接输入!"  type=\"text\">
                                    <img alt=\"\" class=\"fangdajin\" id=\"childPnBtn\" onclick=\"fullPndata(${i})\" src=\"/img/search.png\"/></td>
                                <td class=\"returnMaterialTd\">
                                    <div  class=\"fullZhezhao_new fullZhezhaoSucc_${i}\"></div>
                                    <input class=\"textbox easyui-textbox materialIn  materialIn1\" id=\"childSn${i}\" name=\"cancelStock.childSn\" style=\"width: 80%;padding-left:4px\">
                               </td>
                                <td class=\"returnMaterialTd\">
                                    <div  class=\"fullZhezhao_new fullZhezhaoSucc_${i}\"></div>
                                    <div  class="fullZhezhao_udro fullZhezhao_${i}" style="display: none"></div>
                                    <input class=\"textbox easyui-textbox materialIn  materialIn1\" id=\"childQty${i}\" name=\"cancelStock.childQty\" style=\"width: 80%;padding-left:4px\">
                                </td>
                                <td class=\"returnMaterialTd\">
                                    <div  class=\"fullZhezhao_new fullZhezhaoSucc_${i}\"></div>
                                    <input class=\"textbox easyui-textbox materialIn  materialIn1\" id=\"childUnit${i}\" name=\"cancelStock.childUnit\" style=\"width: 80%;padding-left:4px\">
                                </td>
                                <td colspan=\"2\">
                                    <div  class=\"fullZhezhao_new fullZhezhaoSucc_${i}\"></div>
                                    <div class="file_duihao submiS${i}" style="display: none;float:left;">✔</div>
                                    <div class="icon-delete submiF${i}" style="display: none;float:left;width:20px;height: 30px;margin-left:11px"></div>
                                    <button class=\"delBtnTr\" style=\"float:right;margin-right:23px\">删除</button>
                                </td>
                            </tr>`;
            var fullMateial_row=$(fullMateial);
            $("#tbodysumTr").append(fullMateial_row);
        }
    }
    //余料清单添加按钮功能

    //点击添加按钮添加行start
    function add_sumBtnMaterrial(){
        sumBtnMaterrial(sumBtn_tr);
        sumBtn_tr++;
    }
    //点击添加按钮添加行end


    // function delMaterialRow(){
    //    alert("此行暂时不可删除");
    // }

    //改装包余料清单 删除行start
    $(document).delegate(".delBtnTr","click",function(){
        $(this).closest("tr").remove();
    });
    //改装包余料清单 删除行end

    //获取余料清单的所有value值start
    function getMaterialdata(hadData){
        var rl=$("input[name='rl']:checked").val();
        if(rl=="Y"){//整包提交
            hadData.allPackage=true;
            hadData.childPn="";
            hadData.childSn="";
            hadData.childQty="";
            hadData.childUnit="";
            //    发送数据获取ID，成功后赋值ID start
            $.ajax({
                type: "POST",
                url: "/api/v1/cancelSock/edit",
                data: JSON.stringify(hadData),
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if(data.code == 200){
                        cancelSocket = data.data;
                        // console.log(cancelSocket);
                        if(data.hasOwnProperty("data")){
                            if(data.data.hasOwnProperty("id")){}
                            $("#addMrId").textbox("setValue",data.data.id);
                        }

                        //重载父页面
                        if (typeof workcancelSocket.OWindow.queryCCTable == "function"){workcancelSocket.OWindow.queryCCTable()} ;
                        alert("提交成功！");
                        window.close();
                    }else {
                        alert(data.msg);
                        $("#submitBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});
                    }

                },
                error: function (obj) {
                    alert("提交失败！");
                    $("#submitBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});
                }
            });
            //    发送数据获取ID，成功后赋值IDend

        }else if(rl=="N"){//余料提交
            //余料提交数据，提示loding框
            $("#materialLoding").css({"display":"table"});
            hadData.allPackage=false;
            var mInput=$("input[id^='childPn']");
            var lenInput=$("input[id^='childPn']").length;

            for(let i=0;i<lenInput;i++){
                let count=mInput[i].id.slice(-1);
                let newPn="childPn"+count;
                let newSn="childSn"+count;
                let newQty="childQty"+count;
                let newUnit="childUnit"+count;
                // console.log("第"+i+"行的input标记："+newPn+","+newSn+","+newQty+","+newUnit);

                hadData.childPn=$("#"+newPn).val();
                hadData.childSn=$("#"+newSn).val();
                hadData.childQty=$("#"+newQty).val();
                hadData.childUnit=$("#"+newUnit).val();

                    if(!material_data(hadData,i+1,count)){//校验余料数据
                        // if($(".submiS"+i).css("display")=="none"){
                        if(!$(".submiS"+count).is(":visible")){
                            //    发送数据获取ID，成功后赋值ID start
                            $.ajax({
                                type: "POST",
                                url: "/api/v1/cancelSock/edit",
                                data: JSON.stringify(hadData),
                                contentType: "application/json;charset=utf-8",
                                dataType: "json",
                                success: function (data) {
                                    if(data.code == 200){
                                        cancelSocket = data.data;
                                        // console.log(cancelSocket);
                                        if(data.hasOwnProperty("data")){
                                            if(data.data.hasOwnProperty("id")){}
                                            $("#addMrId").textbox("setValue",data.data.id);
                                        }
                                        //显示提交成功和隐藏提交失败样式
                                        $(".submiS"+count).show();
                                        $(".submiF"+count).hide();

                                        issubShow+=1;//提交成功后，加1
                                        //显示余料行的遮罩层
                                        $(".fullZhezhaoSucc_"+count).show();

                                        //重载父页面
                                        if (typeof workcancelSocket.OWindow.queryCCTable == "function"){workcancelSocket.OWindow.queryCCTable()} ;
                                        alert("提交成功！");
                                        // window.close();//余料提交时单条数据成功不关闭窗口
                                    }else {
                                        $(".submiF"+count).show();
                                        alert(data.msg);
                                        $("#submitBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});

                                    }

                                },
                                error: function (obj) {
                                    $(".submiF"+count).show();
                                    alert("提交失败！");
                                    $("#submitBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});
                                }
                            });
                            //    发送数据获取ID，成功后赋值IDend

                        }else{
                            $("#submitBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});
                            if(lenInput==issubShow){
                                MsgAlert({type:"error",content:"请添加余料清单行"});
                            }
                        }
                    }else{
                        $("#submitBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});
                        break;
                    }


            }
            //数据提交完成后，关闭loding框
            $("#materialLoding").hide();
        }

    }
    //获取余料清单的所有value值end

    //余料清单搜索件号start
    function fullPndata(t) {
        $.pnSelect({
            success: function (data) {
                //刚开始查找件号时，不管是不是消耗件，退料数量不置灰
                $(`.fullZhezhao_${t}`).hide();
                if(t=="0"){
                    if(data.udro=="0"){//消耗件
                        $("#childQty0").textbox("setValue","");//数量
                        udroArr[0]=false;
                    }else{
                        $("#childQty0").textbox("setValue","1");//数量
                        $(".fullZhezhao_0").show();
                        udroArr[0]=true;
                    }
                    $("#childSn0").textbox("setValue","");//序号
                    $("#childPn0").textbox("setValue",data.partno);//件号
                    $("#childUnit0").textbox("setValue",data.issueunit);//单位

                }else{
                    if(data.udro=="0"){//消耗件
                        $(`#childQty${t}`).val("");//数量
                        udroArr[t]=false;
                    }else{
                        $(`#childQty${t}`).val("1");//数量
                        $(`.fullZhezhao_${t}`).show();
                        udroArr[t]=true;
                    }

                    $(`#childSn${t}`).val("");//序号
                    $(`#childPn${t}`).val(data.partno);
                    $(`#childUnit${t}`).val(data.issueunit);

                }

            }
        })
    }
    //余料清单搜索件号end

    //领出未用改装包余料退料校验start
    function material_data(data,n,c){
        var rl=$("input[name='rl']:checked").val();
        if(rl=="N") {//余料
            var isValid=false;
            var cPn=data.childPn;
            var cSn=data.childSn;
            var cQty=data.childQty;
            var cUnit=data.childUnit;
            if(!!cPn==false){
                MsgAlert({type:"error",content:"请选择第"+n+"行的余料件号"});
                isValid = true;
            }else if(!!cSn==false&&udroArr[c]){
                MsgAlert({type:"error",content:"请输入第"+n+"行的余料序号"});
                isValid = true;
            }else if(!!cQty==false){
                MsgAlert({type:"error",content:"请输入第"+n+"行的余料退料数量"});
                isValid = true;
            }else if(!(/(^[1-9]\d*$)/.test(cQty))){
                MsgAlert({type:"error",content:"请输入第"+n+"行的正整数的余料退料数量"});
                isValid = true;
            }else if(!!cUnit==false){
                MsgAlert({type:"error",content:"请输入第"+n+"行的余料退料单位"});
                isValid = true;
            }
            $("#submitBtn").attr("disabled",false).css({"pointer-events":"auto","opacity":"1"});
            return isValid;
        }
    }
    //领出未用改装包余料退料校验end

</script>
</body>

</html>