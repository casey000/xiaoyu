<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->
    <meta charset="UTF-8">
    <title>有序号拆下退料</title>
    <link href="/css/nrc/nrc_add.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/icon.css">
    <link href="/css/mccdoc/to_commons.css" rel="stylesheet" type="text/css"/>

    <style type="text/css">
        .cai_type label {
            margin-right: 20px;
        }

        .sousuo_div {
            position: absolute;
            top: 0px;
            left: 0px;
            right: 0px;
            bottom: 0px;
            padding-top: 8px;
            z-index: 10;
        }

        .zhezhao {
            display: none;
            position: absolute;
            z-index: 9;
            top: 0px;
            bottom: 0px;
            right: 0px;
            left: 0px;
        }

        .red {
            color: red;
        }

    </style>
    <script src="/js/common.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
    <script src="/js/datagrid_utils.js" type="text/javascript"></script>
</head>
<body>
<div class="zhezhao" id="dazhehzao" onclick="zhezhao_hide()"></div>
<div class="zhezhao" id="zhezhao"></div>
<div class="nrc_div">
    <div style="display: none"><input id="hadCcNoId" type="text"/> <input class="easyui-textbox" id="sapId"/></div>
    <table class="addnrc_table"  width="100%">
        <tbody>
        <tr style="display: none">
            <td><input class="easyui-textbox" id="addMrId" style="width: 85%" name="cancelStock.id"
                       type="text">
            </td>
        </tr>
        <!--        显示信息start-->
        <tr>
            <td class="key" width="10%">退料单</td>
            <td  width="23%">
                <!--                <input class="easyui-textbox" id="cancelStockId" style="width: 85%" name="cancelStock.pn" readonly="readonly"-->
                <!--                                    type="text">-->
                <span id="cancelStockId" ></span>
            </td>
            <td class="key" width="10%">退料单状态</td>
            <td width="24%">
                <!--                <input class="easyui-textbox"  id="cancelStockStatus" style="width: 85%"name="cancelStock.sn" readonly="readonly"-->
                <!--                                   type="text">-->
                <span id="cancelStockStatus" ></span>
            </td>
            <td class="key"  width="10%">退料类型</td>
            <td width="23%">
                <!--                <input class="easyui-combobox" id="cancelStockType" name="cancelStock.cancelStockType" value="拆下件退库料"  readonly="readonly"-->
                <!--                       style="width: 85%">-->
                <span id="cancelStockType" ></span>
            </td>
        </tr>
        <tr>
            <td class="key" width="10%">飞机号</td>
            <td  width="23%">
                <!--                <input class="easyui-textbox" id="cancelStockId" style="width: 85%" name="cancelStock.pn" readonly="readonly"-->
                <!--                                    type="text">-->
                <span id="acReg" ></span>
            </td>
            <td class="key">工作航站</td>
            <td>
                <!--                <input class="easyui-textbox" id="fromStation" readonly="readonly" style="width: 85%" type="text">-->
                <!--                <img alt="" class="fangdajin" id="fromstationImg" onClick="stationQuery()" src="/img/search.png"/>-->
                <span id="fromStation" ></span>
            </td>
            </td>
            <td class="key"  width="10%">关联CC号</td>
            <td width="23%">

                <span id="ccNo" ></span>
            </td>
        </tr>
        <!--        显示信息end-->
        <tr>
            <td class="key" width="10%">件号</td>
            <td  width="23%">
                <span id="pn" ></span>
                <!--                <input class="easyui-textbox" id="pn" style="width: 85%" name="cancelStock.pn"-->
                <!--                                    type="text">-->
                <!--                <img alt="" class="fangdajin" id="acBtn" onClick="pn_data('A',1)"  src="/img/search.png"/>-->
            </td>
            <td class="key" width="10%">序号</td>
            <td width="24%">
                <span id="sn" ></span>
                <!--                <input class="easyui-textbox"  id="sn" style="width: 85%"name="cancelStock.sn"-->
                <!--                                   type="text">-->
            </td>
            <td class="key">目的航站 <span>*</span></td>
            <td>
                <input class="easyui-textbox" id="station" readonly="readonly" style="width: 85%"  disabled = "disabled" type="text">
                <!--                <img alt="" id="stationBtn" onClick="stationQuery()" src="/img/search.png" style="position: absolute;margin-left: -15px;top: 11px;"/>-->
            </td>
        </tr>
        <tr>
            <td class="key">航材状态<span>*</span></td>
            <td>
                <input  class="easyui-combobox no_entry" id="airMaterialState" name="cancelStock.airMaterialState" style="width: 85%" disabled = "disabled"
                />
            </td>
            <!--            <td class="key">MR编号<span>*</span></td>-->
            <!--            <td><input class="easyui-textbox"  id="mrNo" style="width: 85%" name="cancelStock.mrNo"-->
            <!--                       type="text">-->
            <!--                &lt;!&ndash;                <img alt="" class="fangdajin" id="mrNob" onClick="" src="/img/search.png"/>&ndash;&gt;-->
            <!--            </td>-->
            <td class="key">是否随机运输</td>
            <td id="transport_type_id">
                <input type="radio" id="transport-yes" value="1" name="transport"  disabled = "disabled" checked="checked"><label for="transport-yes">是</label>
                <input type="radio" id="transport-no" value="2" name="transport"  disabled = "disabled"><label for="transport-no">否</label>
            </td>
            <!--            <td class="key">发料单位</td>-->
            <!--            <td><input class="easyui-textbox" disabled="disabled" id="unit" style="width: 85%" name="cancelStock.unit"-->
            <!--                       type="text">-->
            <!--            </td>-->
            <!--            <td class="key">发料数量</td>-->
            <!--            <td><input class="easyui-textbox"  disabled="disabled" id="qty" style="width: 85%" name="cancelStock.qty"-->
            <!--                       type="text">-->
            <!--            </td>-->
            <td class="key">计划性<span>*</span></td>
            <td>
                <input  class="easyui-combobox no_entry" id="plan" name="cancelStock.plan" style="width: 85%" disabled = "disabled"
                />
            </td>
        </tr>
        <!--        <tr>-->
        <!--            <td class="key">退料数量<span>*</span></td>-->
        <!--            <td><input class="easyui-textbox" id="cancelStockQty" style="width: 85%" name="cancelStock.cancelStockQty"-->
        <!--                       type="text">-->
        <!--            </td>-->
        <!--        </tr>-->
        <tr>

            <!--            <td class="key">工作航站</td>-->
            <!--            <td>-->
            <!--                <input class="easyui-textbox" id="fromStation" readonly="readonly" style="width: 85%" type="text">-->
            <!--                &lt;!&ndash;                <img alt="" class="fangdajin" id="fromstationImg" onClick="stationQuery()" src="/img/search.png"/>&ndash;&gt;-->
            <!--            </td>-->

        </tr>
        <tr>
            <td class="key">退料人<span class="red">*</span></td>
            <td>
                <input class="easyui-textbox easyui-validatebox" data-options="validType:['maxLength[20]'] " id="sendBackName" name="sendBackName"  disabled = "disabled" style="width: 85%"/>
                <!--                <input style="display: none"/>-->
            </td>
            <td  class="key">退料时间<span class="red">*</span></td>
            <td >
                <input class="easyui-datetimebox" id="sendBackTime" name="repTime"   disabled = "disabled" style="width: 70%" type="text">
            </td>

            <!--            <td class="key">是否需要退料</td>-->
            <!--            <td id="noNeed">-->
            <!--                <input type="radio" id="noNeed-no" value="n" name="noNeed" checked="checked" ><label for="noNeed-no"  disabled = "disabled">需要退料</label>-->
            <!--                <input type="radio" id="noNeed-yes" value="y" name="noNeed"  ><label for="noNeed-yes"  disabled = "disabled">不需要退料</label>-->
            <!--            </td>-->
            <td class="key"></td>
            <td id="noNeed"></td>

        </tr>

        <!--        <tr>-->
        <!--            <td class="key">附件<span class="red">*</span></td>-->
        <!--            <td colspan="6" id="attachament_td">-->
        <!--                <div id="attach_file">-->

        <!--                </div>-->
        <!--            </td>-->
        <!--        </tr>-->
        <tr>
            <td colspan="6">
                <!-- 任务附件tabel-->
                <table border="1" cellpadding="0" cellspacing="0" class="table-zi" id="attachmentHtml" style="border-top: none" width="100%">
                    <tr>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="25%">Doc Name</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="25%">Doc Type</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="25%">Uploader</td>
                        <td class="td-line30-with-bg-center" style="border-top: none;" width="25%">Uploader Data</td>
                        <!--<td class="td-line30-with-bg-center" style="border-top: none;" width="20%">Operate</td>-->
                    </tr>
                    <!-- 这里接收来自后台传来的任务附件信息 -->
                </table>
            </td>
        </tr>
        </tbody>
    </table>
    <table class="addnrc_table" style="margin-top: 5px">
        <tr>
            <td class="key">拆下原因</td>
        </tr>
        <tr>
            <td>
                <textarea id="description" name="cancelStock.description" maxlength="1000" disabled = "disabled"></textarea>
            </td>
        </tr>

        <tr class="noBackReason" >
            <td class="key">拆下挂签里的拆下故障原因<span class="red">*</span></td>
        </tr>
        <tr class="noBackReason" >
            <td>
                <textarea id="noBackReason" name="cancelStock.noBackReason" maxlength="1000"  disabled = "disabled"></textarea>
            </td>
        </tr>

        </tbody>
    </table>
    <div class="button_a" style="position: relative">
        <!--        <a class="save display_button" onclick="save();return false;">提交</a>-->
        <!--        <a class="save display_button" onclick="submit();return false;">提交</a>-->
    </div>
</div>

<script type="text/javascript">
    var lisr_file = 0;
    var cancelSocket;
    var workcancelSocket =getParentParam_();
    var objData;
    var hangcaitype_list = [] ;
    var WorkOrderData = {};


    //立即执行start
    $(function () {
        //从后台获取数据展示到页面start
        $.ajax({
            type: "GET",
            url: "/api/v1/cancelSock/selectById/" + workcancelSocket.id,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                objData = data.data;
                //危险，模拟数据，请勿用于生产
                // objData = mokeSapData;
                // cancelSocket.workorderId =objData.workorderId;
                console.log("请求成功");
                console.log(objData);
                assignment(objData);
                getDataByCcNo(objData.ccNo);
            },
            error: function (obj) {
                alert("请求数据失败！");
            }
        });
        //从后台获取数据展示到页面end
        //附件显示
        searchAttachment();
        // add_file_show(workcancelSocket.id);
        //下拉数据加载
        addDropDate();
        //添加附件
        // add_atta_input_flie();
        //    显示数据

        //    只能选择不能输入
        noEnter();

    })
    //立即执行end

    //遮罩start
    function zhezhao_hide() {
        $(".sousuo_div").hide();
        $("#dazhehzao").hide();
    }
    //遮罩end

    function filter(tlble, pn, sn, pos) {
        //.date_tr 数据显示行，用于区分标题行
        $("#" + tlble + " tr").each(function (i, e) {
            $(e).hide();
            if (filterTr(e, pn, sn, pos)) {
                $(e).show();
            }
        })
    }

    //赋值操作start
    function assignment(datas) {
        //计划性
        if(datas.planType == "1"){
            $("#plan").textbox("setValue","非计划性");
        }else if(datas.planType == "2"){
            $("#plan").textbox("setValue","计划性");
        }

        // 退库单状态
        // $("#cancelStockType").textbox("setValue",datas.cancelStockType);
        if(datas.cancelStockStatus == "1"||datas.cancelStockStatus == "实物登记"){
            $("#cancelStockStatus").html("实物登记");
        }else if(datas.cancelStockStatus == "2"||datas.cancelStockStatus == "已入库"){
            $("#cancelStockStatus").html("已入库");
        }else if(datas.cancelStockStatus == "3"||datas.cancelStockStatus == "待上架"){
            $("#cancelStockStatus").html('待上架');
        }else if(datas.cancelStockStatus == "4"||datas.cancelStockStatus == "已上架"){
            $("#cancelStockStatus").html('已上架');
        }else if(datas.cancelStockStatus == "5"||datas.cancelStockStatus == "已关闭"){
            $("#cancelStockStatus").html('已关闭');
        }else if(datas.cancelStockStatus == "6"||datas.cancelStockStatus == "取消"){
            $("#cancelStockStatus").html('取消');
        }else if(datas.cancelStockStatus== null||datas.cancelStockStatus.trim()==""||datas.cancelStockStatus == "新建"){
            $("#cancelStockStatus").html('新建');
        };


        //赋值ID
        $("#hadCcNoId").val(datas.id);
        //MR编号
        // $("#mrNo").textbox("setValue",datas.mrNo);
        //任务编号
        // $("#cancelStockNo").textbox("setValue",cancelSocket.cancelStockNo);
        //退库数量
        $("#cancelStockQty").textbox("setValue",datas.cancelStockQty);
        // 退库类型
        // $("#cancelStockType").textbox("setValue",datas.cancelStockType);

        if(datas.cancelStockType == "1"){
            $("#cancelStockType").html("拆下件退料");
        }else if(datas.cancelStockType == "2"){
            $("#cancelStockType").html("领出未用退料");
        }else if(datas.cancelStockType == "3"){
            $("#cancelStockType").html("拆下无序号件退料");
        }else if(datas.cancelStockType == "4"){
            $("#cancelStockType").html("装机未用退料");
        }else if(datas.cancelStockType == "5"){
            $("#cancelStockType").html("改装包退料");
        }
        //cc编号
        // $("#ccNo").textbox("setValue",datas.ccNo);
        $("#ccNo").html(datas.ccNo);
        // 件号
        // $("#pn").textbox("setValue",datas.pn);
        $("#pn").html(datas.pn);
        //序号
        // $("#sn").textbox("setValue",datas.sn);
        $("#sn").html(datas.sn);
        // 数量
        $("#qty").textbox("setValue",datas.qty);
        // 单位
        $("#unit").textbox("setValue",datas.unit);
        //批次号
        $("#batchNo").textbox("setValue",datas.batchNo);
        //目的航站
        $("#station").textbox("setValue",datas.toStation);

        //描述
        // $("#description").val(datas.description);
        $("#noBackReason").val(datas.reason);
        //描述
        // $("#noNeedDescription").val(datas.reason);
        //工作航站/拆下航站/当前航站
        // $("#fromStation").textbox("setValue",workcancelSocket.fromStation);
        $("#fromStation").html(datas.fromStation);
        //是否随机运输
        if(!!datas.transport){
            if(datas.transport == "2"){
                $("#transport-no").attr("checked","true")
            }else if(datas.transport == "1"){
                $("#transport-yes").attr("checked","true")
            }
        };

        //退料人名字
        $("#sendBackName").textbox("setValue", datas.sendBackName);

        //退料时间
        $("#sendBackTime").textbox("setValue",datas.sendBackTime);
        //退库单号
        $("#cancelStockId").html(datas.cancelStockId);
        //飞机号
        $("#acReg").html(datas.onModel);
        //无需退库
        // if(!!datas.noNeed == 'y'){
        //     $("#noNeed").prop('checked',true);
        // }
        //部件状态
        if(datas.airMaterialState == "USED"||datas.airMaterialState == "B"){
            $("#airMaterialState").textbox("setValue","可用件");
        }else if(datas.airMaterialState == "UNUSED"||datas.airMaterialState == "A"){
            $("#airMaterialState").textbox("setValue","不可用件");
        }else if(datas.airMaterialState == "WDISPOSE"||datas.airMaterialState == "C"){
            $("#airMaterialState").textbox("setValue",'待观察件');
        }
    }
    //赋值操作end

    //提交start
    // function submit() {
    //     //post数据赋值
    //     var data = getData();
    //     //校验
    //     if(validForm(data)){
    //         return false;
    //     };
    //
    //     var url = "/api/v1/cancelSock/edit";
    //     $.ajax({
    //         type: "POST",
    //         url: url,
    //         contentType: "application/json;charset=utf-8",
    //         data: JSON.stringify(data),
    //         dataType: "json",
    //         success: function (data) {
    //             //console.log(data);
    //             if (data.code == 200) {
    //                 alert("成功！");
    //                 if (typeof workcancelSocket.OWindow.queryCCTable == "function"){workcancelSocket.OWindow.queryCCTable()} ;
    //                 window.close();
    //             } else if (data.msgData && data.msgData[0]) {
    //                 alert(data.msgData[0]);
    //             } else {
    //                 alert(data.msg);
    //             }
    //         },
    //         error: function () {
    //             window.alert("提交失败！");
    //         }
    //     });
    // }
    //提交end

    //获取数据操作start
    function getData() {
        var planType,cancelStockType,airMaterialState;
        if($("#plan").combobox("getValue")=="非计划性"||$("#plan").combobox("getValue")=="1"){
            planType = "1";
        }else if($("#plan").combobox("getValue")=="计划性"||$("#plan").combobox("getValue")=="2"){
            planType = "2";
        };
        // if($("#cancelStockType").combobox("getValue")=="拆下件退料"||$("#cancelStockType").combobox("getValue")=="1") {
        //     cancelStockType = "1";
        // }else if($("#cancelStockType").combobox("getValue")=="领出未用退料"||$("#cancelStockType").combobox("getValue")=="2"){
        //     cancelStockType = "2";
        // }else if($("#cancelStockType").combobox("getValue")=="装机未用退料"||$("#cancelStockType").combobox("getValue")=="3"){
        //     cancelStockType = "3";
        // }else if($("#cancelStockType").combobox("getValue")=="拆下无序号件退料"||$("#cancelStockType").combobox("getValue")=="4"){
        //     cancelStockType = "4";
        // };
        if($("#airMaterialState").combobox("getValue")=="可用件"||$("#airMaterialState").combobox("getValue")=="USED"||$("#airMaterialState").combobox("getValue")=="B"){
            airMaterialState = "USED";
        }else if($("#airMaterialState").combobox("getValue")=="不可用件"||$("#airMaterialState").combobox("getValue")=="UNUSED"||$("#airMaterialState").combobox("getValue")=="A"){
            airMaterialState = "UNUSED";
        }else if($("#airMaterialState").combobox("getValue")=="待观察件"||$("#airMaterialState").combobox("getValue")=="WDISPOSE"||$("#airMaterialState").combobox("getValue")=="C"){
            airMaterialState = "WDISPOSE";
        };
        var data = {
            // 'id': $("#hadCcNoId").val(),
            'id': objData.id,
            'pn': objData.pn,
            // 'sn': $("#sn").val(),
            //批次号
            // 'batchNo': $("#batchNo").val(),
            //mr编号
            // 'mrNo': $("#mrNo").val(),
            //单位
            // 'unit': $("#unit").val(),
            //数量
            // 'qty': $("#qty").val(),
            // 'cancelStockQty': $("#cancelStockQty").val(),
            //部件（航材）状态
            'airMaterialState': airMaterialState,
            //退库单状态
            // 'cancelStockStatus': $("#cancelStockStatus").val(),
            //退库类型
            'cancelStockType': objData.cancelStockType,
            //目标航站
            'toStation': $("#station").val(),
            //是否随机运输
            'transport':$('input[name="transport"]:checked').val(),
            //退库原因
            'reason': $("#noBackReason").val(),
            //退料人名字
            'sendBackName': $("#sendBackName").textbox("getValue"),
            //退料时间
            'sendBackTime': $("#sendBackTime").textbox("getValue"),
            //无需退库
            // 'noNeed': $('input[name="noNeed"]:checked').val(),
            'noNeed':"n",//后台默认n为需要退料，y为不需要退料
            //不退库原因
            // 'noBackReason': $("#noBackReason").val(datas.reason),
            //拆下航站
            // 'fromStation':$("#fromStation").val(),
            // 'workorderId':objData.workorderId,
            'workorderId':objData.workorderId,
            //    计划性
            'planType': planType,
            //退库单
            // 'cancelStockId':$("#cancelStockId").val(),
        };
        return data
    }
    //获取数据操作end

    //航站查询start
    function stationQuery() {
        var title_ = $.i18n.t('航站查询');
        var curWidth = ($(window).width() * 0.5).toString();
        var curheight = ($(window).height() * 0.5).toString();
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: title_,
            param: {},
            url: "/views/tbm/flb/station_query.shtml"
        });
    }
    //航站查询end

    //添加附件功能start
    function add_file(i) {
        let file = " <div id=\"atta_input_flie_" + i + "\" class=\"atta_input_fliecss atta_input_fliecss_move\">\n" +
            "       <input class=\"textbox easyui-validatebox\" type=\"file\" id=\"atta_input_flie_a" + i + "\" size=\"300\" name=\"file\" data-options=\"required:true\"/>            \n" +
            "                    <div class=\"add_jiahao\" onclick=\"add_atta_input_flie()\" style='margin-top: 5px'></div>\n" +
            " <div class='file_duihao' onclick=\"atta_input_flie('atta_input_flie_a'+" + i + ")\">✔</div>\n" +
            "                    <div class=\"jianhao icon-delete\" onclick=\"delete_atta_input_flie(atta_input_flie_" + i + ")\" style='margin-top: 4px'></div>\n" +
            "                </div>";
        let html_row = $(file);
        $("#attachament_td").append(html_row);
    }
    //添加附件功能end

    //附件上传增加按钮start
    function add_atta_input_flie() {
        add_file(lisr_file);
        lisr_file++;
    }
    //附件上传增加按钮end

    //附件上传删除按钮start
    function delete_atta_input_flie(val) {
        let geshu = document.getElementsByClassName('atta_input_fliecss_move');

        if (geshu.length == 1) {
            return
        }
        let newP = $(val);
        if (newP.length > 0) {
            newP.remove();
        }
    }
    //附件上传删除按钮end

    //附件上传打钩按钮start
    function atta_input_flie(id) {
        if ($("#hadCcNoId").val() != "") {
            var fileInput = $("#" + id).get(0).files[0];
            if (fileInput) {
                $.ajaxFileUpload({
                    url: Constant.API_URL + 'ATTACHMENT_UPLOAD',
                    secureuri: false,
                    fileElementId: id, //file控件id
                    dataType: 'json',
                    data: {
                        "fileCategory": "cancelStock",
                        "sourceId":  workcancelSocket.id,
                    },
                    success: function (data) {
                        if (data.code == 200) {
                            var file = document.getElementById("" + id + "");
                            file.value = '';
                            $("#" + id).value = "";
                            add_file_show(workcancelSocket.id);
                        }

                    }

                })
            } else {
                alert("请选择上传文件！");
            }
        } else {
            alert("请先提交，再回到对应页面上传附件！")
        }

    }
    //附件上传打钩按钮end

    //删除已添加附件start
    function deleteFile(fileid) {
        var _url = basePath + "/api/v1/mccdoc/to_base_info/deleteAttachment";
        P.$.dialog.confirm('Delete Selected ?', function () {
            $.ajax({
                url: _url,
                type: "get",
                data: {'pkid': fileid},
                dataType: "json",
                cache: false,
                success: function (data) {
                    if (data.code == 200) {
                        P.$.dialog.alert("Success");
                        $("#qc_table_detail #appendTr").remove();
                        add_file_show(workcancelSocket.id);
                    }
                }
            });
        }, function () {
        });
    }
    //删除已添加附件end

    //附件增加文件start
    function add_file_show(id) {
        $("#attach_file").empty();
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: id,
                CATEGORY: "cancelStock",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                for (var ind in jdata.data) {
                    let file = " <div id=\"input_flie_show" + jdata.data[ind].PKID + "\" class=\"atta_input_fliecss\" style=\"line-height: 30px;width: 100%;    height: 30px;border-bottom: 1px solid #ccc;\">\n" +
                        "                            <div style=\"width: 60%;text-align: left;\"><a style=\"color:red;font-size: 14px\" onclick=\"downFile(" + jdata.data[ind].PKID + "," + jdata.data[ind].PKID + ")\">" + jdata.data[ind].ORG_NAME + "</a></div>\n" +
                        "\n" +
                        "                        <div class=\"jianhao icon-delete\" onclick=\"deleteFile(" + jdata.data[ind].PKID + ")\"></div>\n" +
                        "                        </div>";
                    let html_row = $(file);
                    $("#attach_file").append(html_row);
                }

            }
        });
    }
    //附件增加文件end

    //    件号搜索start
    function pn_data(type, ind) {
        $.pnSelect({
            success: function (data) {
                if (type == "A") {
                    $("#pn").textbox('setValue', data.partno);
                    // $("#jian_name" + ind).textbox('setValue', data.description);
                    // $("#sn" + ind).textbox('setValue', data.itemnum);
                    // if ($("#sn").textbox("getValue")) {
                    //     caixia_gouxin( data.partno, "");
                    //     caixia_weizhi(data.partno, "no", 'OFF');
                    // }

                } else if (type == "B") {
                    $("#original" + ind).textbox('setValue', data.partno);
                    $("#jian_name" + ind).textbox('setValue', data.description);
                    zhuang_gouxin(data.partno, "");
                    if ($("#stazone").textbox("getValue")) {
                        caixia_weizhi(data.partno, "no", 'ON');
                    }

                } else if (type == "C") {
                    $("#cai_original" + ind).textbox('setValue', data.partno);
                } else if (type == "D") {
                    $("#zhuang_original" + ind).textbox('setValue', data.partno);
                }

            }
        })
    }
    //    件号搜索end

    //    下拉框数据加载start
    function addDropDate() {
        //    添加部件状态数据
        $("#airMaterialState").combobox({
            textField: 'TEXT',
            valueField:  'VALUE',
            data: [{
                TEXT :"可用件",
                VALUE:"USED"
            },{
                TEXT: "不可用件",
                VALUE: "UNUSED"
            },{
                TEXT: "待观察件",
                VALUE: "WDISPOSE"
            }
            ],
        });
        $("#plan").combobox({
            textField: 'TEXT',
            valueField:  'VALUE',
            data: [{
                TEXT :"非计划性",
                VALUE:"1"
            },{
                TEXT: "计划性",
                VALUE: "2"
            }
            ],
        });
        //    退库类型
        // $("#cancelStockType").combobox({
        //     textField: 'TEXT',
        //     valueField:  'VALUE',
        //     data: [{
        //         TEXT :"拆下件退料",
        //         VALUE:"1"
        //     },{
        //         TEXT: "领出未用退料",
        //         VALUE: "2"
        //     },{
        //         TEXT: "客改拆下退料",
        //         VALUE: "3"
        //     },{
        //         TEXT: "装机未用退料",
        //         VALUE: "4"
        //     }
        //     ],
        // });
        //    点击选择工作者
        $("#sendBackName").MyComboGrid({
            idField: 'USER_NAME',  //实际选择值
            textField: 'USER_NAME', //文本显示值
            panelHeight: '180px',
            required: true,
            width: "70%",
            params: {FunctionCode: 'FLOW_WORK_ACCOUNT'},
            columns: [[
                {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                {field: 'USER_NAME', title: '审核人', width: 50}
            ]],
            onHidePanel: function () {
                var t = $(this).combogrid('getValue');
                if (t != null && t != '' & t != undefined) {
                    if (selectRow == null || t != selectRow.USER_NAME) {//没有选择或者选项不相等时清除内容
                        alert('请选择，不要直接输入！');
                        $(this).combogrid({value: ''});
                    }
                }
            },
            onSelect: function (index, row) {
                selectRow = row;
                $("#repname").val(row.ACCOUNT_NUMBER);
            }
        });
    }
    //    下拉数据加载end

    //加载数据字典,获取到下拉选择项 start
    // queryDataDict({
    //     "domainCode": "AIR_MATERIAL_STATE",
    //     succFn:function(data){
    //         if(data){
    //             // air_material_state_list = data.AIR_MATERIAL_PROPERTIES;
    //             // jiahua_list = data.CC_PLAN_TYPE;
    //             hangcaitype_list = data.AIR_MATERIAL_STATE;
    //             // caihuanyuanyin_list = data.CC_SOURCE_TYPE;
    //         }
    //     }
    // });
    // $("#cancelStockStatus").combobox({
    //     valueField: 'VALUE',
    //     textField: 'TEXT',
    //     panelHeight: '70px',
    //     data: hangcaitype_list,
    // });
    //加载数据字典,获取到下拉选择项 end

    //  jiaoyan  数据校验start
    function validForm(datas) {

        //标记
        var isValid = false,flag = 0;
        var sn = datas.sn;
        var pn = datas.pn;
        var batchNo = datas.batchNo;
        var mrNo = datas.mrNo;
        var unit = datas.unit;
        var qty = datas.qty;
        var cancelStockQty = datas.cancelStockQty;
        var airMaterialState = datas.airMaterialState;
        var cancelStockType = datas.cancelStockType;
        var toStation = datas.toStation;
        // var cancelStockStatus =datas.cancelStockStatus;
        var transport = datas.transport;
        var sendBackName = datas.sendBackName;
        var sendBackTime = datas.sendBackTime;
        var noNeed = datas.noNeed;
        var fromStation = datas.fromStation;
        // var cancelStockId = cancelSocket.cancelStockId;
        var reason = datas.reason;

        // var reason = datas.reason;
        if(document.getElementsByClassName('atta_input_fliecss').length<2){
            alert("请上传附件");
            isValid = true;
            // }else if($("#noBackReason").val()==""&& noNeed == "n"){
            //     alert("请输入不退库原因");
            //     isValid = true;
        }
        else if(!!toStation==false){
            alert("请选择目的航站");
            isValid = true;
        }else if(!!sendBackName==false){
            alert("请选择退料人");
            isValid = true;
        }else if(!!sendBackTime==false){
            alert("请选择退料时间");
            isValid = true;
        }else if(!!reason==false){
            alert("请输入退料说明/部件故障描述");
            isValid = true;
        }else if(judgeDate(sendBackTime)>0){
            alert('退料时间不能大于当前时间');
            isValid = true;
        }
        return  isValid
    }
    //    数据校验end

    //    保存按钮start
    function save() {
        //获取已填数据
        var hadData = getData();
        //校验数据
        if(validForm(hadData)){
            return false;
        }else {
            //    发送数据获取ID，成功后赋值ID start
            $.ajax({
                type: "POST",
                url: "/api/v1/cancelSock/edit",
                data: JSON.stringify(hadData),
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if(data.code == 200){
                        cancelSocket = data.data;
                        console.log(cancelSocket);
                        // if(data.hasOwnProperty("data")){
                        //     if(data.data.hasOwnProperty("id")){}
                        //     $("#addMrId").textbox("setValue",data.data.id);
                        // }

                        //重载父页面
                        if (typeof workcancelSocket.OWindow.queryCCTable == "function"){workcancelSocket.OWindow.queryCCTable()} ;
                        alert("提交成功！");
                        window.close();
                    }else {
                        alert(data.msg);
                    }

                },
                error: function (obj) {
                    alert("提交失败！");
                }
            });
            //    发送数据获取ID，成功后赋值IDend
        };
    }
    //    保存按钮end

    //禁止输入start
    function noEnter(){
        $(".no_entry").combobox({
            required: true,
            editable: false,
        })
    }
    //禁止输入end

    //    获取工单信息并显示start
    // function getWorkData(){
    //     $.ajax({
    //         type: "GET",
    //         url: "/api/v1/workOrder/getWorkOrder/"+ workcancelSocket.workorderId,
    //         contentType: "application/json;charset=utf-8",
    //         dataType: "json",
    //         success: function (data) {
    //             //console.log(data);
    //             WorkOrderData = data.data;
    //             $("#fromStation").textbox("setValue",WorkOrderData.station);
    //             console.log("工单数据获取成功");
    //             console.log(data);
    //         },
    //         error: function () {
    //             alert("工单数据获取失败");
    //         }
    //     });
    // }
    //    获取工单信息并显示end

    //    判断选择时间和当前时间start
    function judgeDate(tomodifyDate){
        return new Date(tomodifyDate).getTime()-new Date().getTime();
    }
    //    判断选择时间和当前时间end

    //    无需退库start
    //     function ifNeedBack(inde){
    //         if(inde==1){
    //             $(".noBackReason").show();
    //         }else if(inde==2){
    //             $(".noBackReason").hide();
    //         }
    //     }
    //    无需退库end

    //    根据cc编号查询数据start
    function getDataByCcNo(ccNo) {
        $.ajax({
            type: "GET",
            url: "/api/v1/compCc/selectByCcNo/"+ ccNo ,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {

                var datas = data.data;
                //危险，模拟数据，请勿用于生产
                // var datas = mokeCcData;
                showOtherData(datas);
            },
            error: function (obj) {
                alert("提交失败！");
            }
        });
    }
    //    根据cc编号查询数据end

    //    赋值从cc来退料单状态，飞机号，目的航站，计划性，拆下原因，拆下原因start
    function showOtherData(datas) {
        //计划性
        if(datas.planType == "2"){
            $("#plan").textbox("setValue","计划性");
        }else {
            $("#plan").textbox("setValue","非计划性");
        };
        $("#acReg").html(datas.onModel);
        // $("#station").textbox("setValue",datas.toStation);
        //退料时间
        // $("#sendBackTime").textbox("setValue",datas.createTime);
        $("#description").val(datas.reason);
        // //部件状态
        // if(datas.airMaterialState == "USED"||datas.airMaterialState == "B"){
        //     $("#airMaterialState").textbox("setValue","可用件");
        // }else if(datas.airMaterialState == "UNUSED"||datas.airMaterialState == "A"){
        //     $("#airMaterialState").textbox("setValue","不可用件");
        // }else if(datas.airMaterialState == "WDISPOSE"||datas.airMaterialState == "C"){
        //     $("#airMaterialState").textbox("setValue",'待观察件');
        // }
    }
    //    赋值退料单状态，飞机号，目的航站，计划性，拆下原因，拆下原因start


    //已入库时候不可编辑start

    //已入库时候不可编辑end
    //    查询现在有附件信息start

    function searchAttachment() {
        var params = {
            "sourceId": workcancelSocket.id,
            "fileCategory":"cancelStock",
        };
        var actionUrl = basePath + '/api/v1/mccdoc/to_base_info/searchAttachment';
        $.ajax({
            url: actionUrl,
            type: "get",
            cache: false,
            dataType: "json",
            data: params,
            async: false,
            success: function (data) {
                var html = "";

                if (data.code == 200) {
                    $.each(data.data, function (i, v) {
                        let down = basePath + "/api/v1/mccdoc/to_base_info/downloadAttachment?pkid=" + v.pkid + "&down=true";
                        // var pageType = $("#pageType").val();
                        html += "<tr id='appendTr_back'>";
                        html += "<td ><div align='center'><a href=" + down + ">" + v.orgName + "</a></div></td>";
                        html += "<td ><div align='center'>" + v.fileContentType + "</div></td>";
                        html += "<td ><div align='center'>" + v.ernam + "</div></td>";
                        html += "<td ><div align='center'>" + v.erdat + "</div></td>";
                        html += "</tr>";
                        //查看页面不需要删除功能
                        // if (pageType) {

                        // }
                    });
                }
                $("#attachmentHtml").append(html);
            }
        });
    }
    //    查询现有附件信息end
    //    模拟sap传过来的数据start
    var mokeSapData = {
        airMaterialState: "USED",
        batchNo: null,
        cancelStockId: "20200229003",
        cancelStockQty: 1,
        cancelStockStatus: "1",
        cancelStockType: "1",
        ccNo: "RT20200229002",
        ccStatus: null,
        description: "猫和老鼠",
        difference: null,
        docNo: "JC-B757-25-0027",
        docType: "5",
        flightId: "100710554",
        flightNo: "O36864",
        fromStation: "ABC",
        id: "MR-CC-nullCS-1582962472781",
        mrItem: null,
        mrNo: null,
        noNeed: null,
        planType: null,
        pn: "625946-10",
        qty: 1,
        reason: null,
        receiverName: null,
        receiverNumber: null,
        sendBackName: "刘志",
        sendBackNumber: "667096",
        sendBackTime: null,
        sn: "TAM6A038C",
        toStation: null,
        transport: null,
        unit: "EA",
        updateTime: null,
        workorderId: "70779480",
        //新增数据
        toStation: "ATA",

    };
    //    模拟sap传过来的数据end
    //    模拟cc传过来的数据start
    var mokeCcData ={
        ccId: 1540097,
        ccNo:  "200200000560",
        ccType: 4,
        cin: "31-41-10.001",
        completeDate: "2020-02-12 08:28:00",
        createTime: "2020-02-12 00:32:41",
        createdId: "12249",
        defectId: 10023286,
        docNo: "117786",
        docType: 1,
        flightNo: "O36885",
        id: 15627657,
        jobId: 69132534,
        middleStatus: "C",
        offAcId: 50,
        offAcType: 1,
        offName: "EICAS计算机",
        offPn: "822-1033-100",
        offPosition: "1",
        offSn: "753",
        onAcId: 50,
        onAcType: 1,
        onCin: "31-41-10.001",
        onName: "EICAS计算机",
        onPn: "822-1033-100",
        onPosition: "1",
        onSn: "1095",
        remark: "L EICAS COMPUTER",
        status: "n",
        tlbId: 11027973,
        //    新加的
        onModel: "B-2017",
        planType: 1,
        reason: "Tom and Jerry"
    };
    //    模拟cc传过来的数据end
</script>
</body>

</html>