<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->
    <meta charset="UTF-8">
    <title>edit_withdrawal_application</title>
    <link href="/css/nrc/nrc_add.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/css/icon.css">
    <link href="/css/mccdoc/to_commons.css" rel="stylesheet" type="text/css"/>
    <style type="text/css">
        .cai_type label {
            margin-right: 20px;
        }

        .sousuo_div {
            position: absolute;
            top: 0px;
            left: 0px;
            right: 0px;
            bottom: 0px;
            padding-top: 8px;
            z-index: 10;
        }

        .zhezhao {
            display: none;
            position: absolute;
            z-index: 9;
            top: 0px;
            bottom: 0px;
            right: 0px;
            left: 0px;
            background-color: #dadada75;
        }

        .red {
            color: red;
        }

    </style>
    <script src="/js/common.js" type="text/javascript"></script>
    <script type="text/javascript" src="/js/plugins/ajaxfileupload/ajaxfileupload.js"></script>
    <script src="/js/datagrid_utils.js" type="text/javascript"></script>
</head>
<body>
<div class="nrc_div">
    <div style="display: none">
        <input id="ccid" type="text"/>
        <input class="easyui-textbox" id="ac_id"/>
        <input class="easyui-textbox"  id="mrItem" style="width: 85%" name="cancelStock.mrItem" type="text">
    </div>
    <table class="addnrc_table"  width="100%">
        <tbody>
        <tr>
            <td class="key" width="10%">退料类型</td>
            <td width="23%">
                <input class="easyui-combobox  no_entry" id="cancelStockType" name="cancelStock.cancelStockType" disabled="disabled"
                       style="width: 85%">
            </td>
            <td class="key" width="10%">件号(PN)<span>*</span></td>
            <td  width="23%"><input class="easyui-textbox" id="pn" style="width: 85%" name="cancelStock.pn" disabled="disabled"
                       type="text">
<!--                <img alt="" class="fangdajin" id="acBtn" onClick="pn_data('A',1)"   src="/img/search.png"/>-->
            </td>

            <td class="key">MR编号<span>*</span></td>
            <td width="24%"><input class="easyui-textbox"  id="mrNo" style="width: 85%" name="cancelStock.mrNo" disabled="disabled"
                       type="text">
                <!--                <img alt="" class="fangdajin" id="mrNob" onClick="" src="/img/search.png"/>-->
            </td>
        </tr>
        <tr>
            <td class="key" width="10%">批次号<span>*</span></td>
            <td ><input class="easyui-textbox" id="batchNo" name="cancelStock.batchNo" disabled="disabled"
                        style="width: 85%">
            </td>
            <td class="key" width="10%">序号(SN)<span>*</span></td>
            <td >
                <div  class="zhezhao"></div>
                <input class="easyui-textbox"  id="sn" style="width: 85%"name="cancelStock.sn" disabled="disabled"
                       type="text">
            </td>

            <td class="key">发料数量</td>
            <td><input class="easyui-textbox"  disabled="disabled" id="qty" style="width: 85%" name="cancelStock.qty"
                       type="text">
            </td>
        </tr>
        <tr>
            <td class="key">退料数量<span>*</span></td>
            <td><input class="easyui-textbox" id="cancelStockQty" style="width: 85%" name="cancelStock.cancelStockQty"
                       type="text">
            </td>
            <td class="key">退料人<span class="red">*</span></td>
            <td>
                <input class="easyui-textbox input-sign" id="finderSign"/>
            </td>
            <td class="key">退料单位</td>
            <td>
                <input class="easyui-textbox" disabled="disabled" id="unit" style="width: 85%" name="cancelStock.unit"
                       type="text">
            </td>

        </tr>
        <tr>
            <td class="key">目的航站 <span>*</span></td>
            <td><input class="easyui-textbox" id="station" readonly="readonly" style="width: 85%"
                       type="text"><img alt="" id="stationBtn" onClick="stationQuery()" src="/img/search.png"
                                        style="position: absolute;right: 15px;top: 11px;"/>
            </td>
            <td class="key">退料单状态</td>
            <td>
                <input class="easyui-textbox" id="cancelStockStatus" style="width: 85%" name="cancelStock.cancelStockStatus" disabled ="disabled"
                       type="text">
            </td>
            <td class="key">是否随机运输<span>*</span></td>
            <td id="transport_type_id">
                <input type="radio" id="transport-yes" value="1" name="dm"  ><label for="transport-yes">是</label>
                <input type="radio" id="transport-no" value="2" name="dm" ><label for="transport-no">否</label>
            </td>
        </tr>
        <tr>

            <td  class="key">退料时间<span class="red">*</span></td>
            <td >
                <input class="easyui-datetimebox" id="sendBackTime" name="repTime"   style="width: 70%" type="text">
            </td>
<!--            <td class="key">是否需要退料<span class="red">*</span></td>-->
<!--            <td id="noNeed">-->
<!--                <input checked="checked" id="noNeed-no" name="noNeed" type="radio" value="y" ><label for="noNeed-no" >需要退料</label>-->
<!--                <input id="noNeed-yes" name="noNeed" type="radio" value="n"  ><label for="noNeed-yes">不需要退料</label>-->
<!--            </td>-->
            <td class="key">航材状态<span class="red">*</span></td>
            <td class="">
                <input class="easyui-combobox no_entry" id="airMaterialState" name="cancelStock.airMaterialState"
                       style="width: 85%">
            </td>
            <td colspan="2"></td>
        </tr>
        <tr>
            <td class="key">附件</td>
            <td colspan="6" id="attachament_td">
                <div id="attach_file">

                </div>
            </td>
        </tr>
        </tbody>
    </table>
    <table class="addnrc_table" style="margin-top: 5px">
        <tbody>
        <tr>
            <td class="key">拆下挂签里的拆下故障原因<span>*</span></td>
        </tr>
        <tr>
            <td>
                <textarea id="reason" name="cancelStock.reason" maxlength="1000"></textarea>
            </td>
        </tr>
        </tbody>
    </table>
    <div class="button_a" style="position: relative">
        <a class="save display_button" onclick="submit();return false;"style="display: none">提交</a>
    </div>
</div>

<script type="text/javascript">
    var lisr_file = 0;
    var cancelSocket = getParentParam_();
    var objData;
    var hangcaitype_list = [] ;
    const userName = getLoginInfo().userName;
    const userId = getLoginInfo().accountNumber;
    console.log(cancelSocket);
    $(function () {
        //从后台获取数据展示到页面start
        $.ajax({
            type: "GET",
            url: "/api/v1/cancelSock/selectById/" + cancelSocket.id,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if(data.code == 200){
                    objData = data.data;
                    cancelSocket.workorderId =objData.workorderId;
                    console.log("请求成功");
                    console.log(objData);
                    addDropDate(objData);
                    isShow(objData.cc);
                    assignment(objData);
                    switchClass();
                }else {
                    alert(data.msg);
                }

            },
            error: function (obj) {
                alert("失败！");
            }
        });
        //从后台获取数据展示到页面end
        noEnter();



        //添加附件
        add_atta_input_flie();
        add_file_show(cancelSocket.id);

    })

    //禁止输入start
    function noEnter(){
    $(".no_entry").combobox({
        required: true,
        editable: false,
    })
    }
    //禁止输入end


    function zhezhao_hide() {
        $(".sousuo_div").hide();
        $("#dazhehzao").hide();
    }


    function filter(tlble, pn, sn, pos) {
        //.date_tr 数据显示行，用于区分标题行
        $("#" + tlble + " tr").each(function (i, e) {
            $(e).hide();
            if (filterTr(e, pn, sn, pos)) {
                $(e).show();
            }
        })
    }
    //赋值操作start
    function assignment(datas) {
        //MR编号
        $("#mrNo").textbox("setValue",datas.mrNo);
        //任务编号
        // $("#cancelStockNo").textbox("setValue",cancelSocket.cancelStockNo);
        // 部件状态
        // $("#airMaterialState").textbox("setValue",datas.airMaterialState);
        if(datas.airMaterialState == "USED"||datas.airMaterialState == "可用件"||datas.airMaterialState == "B"){
            $("#airMaterialState").textbox("setValue","可用件");
        }else if(datas.airMaterialState == "UNUSED"||datas.airMaterialState == "不可用件"||datas.airMaterialState == "A"){
            $("#airMaterialState").textbox("setValue","不可用件");
        }else if(datas.airMaterialState == "WDISPOSE"||datas.airMaterialState == "待观察件"||datas.airMaterialState == "C"){
            $("#airMaterialState").textbox("setValue",'待观察件');
        };
        //计划性
        // if(datas.planType == "1"||datas.planType == "非计划性"){
        //     $("#plan").textbox("setValue","非计划性");
        // }else if(datas.planType == "2"||datas.planType == "计划性"){
        //     $("#plan").textbox("setValue","计划性");
        // };
        // 退库单状态
        if(datas.cancelStockStatus == ""||datas.cancelStockStatus == null){
            $("#cancelStockStatus").textbox("setValue","新建");
            $(".save").show();
        }else if(datas.cancelStockStatus == "1"||datas.cancelStockStatus == "实物登记"){
            $("#cancelStockStatus").textbox("setValue","实物登记");
        }else if(datas.cancelStockStatus == "2"||datas.cancelStockStatus == "已入库"){
            $("#cancelStockStatus").textbox("setValue","已入库");
        }else if(datas.cancelStockStatus == "3"||datas.cancelStockStatus == "待上架"){
            $("#cancelStockStatus").textbox("setValue",'待上架');
        }else if(datas.cancelStockStatus == "4"||datas.cancelStockStatus == "已上架"){
            $("#cancelStockStatus").textbox("setValue",'已上架');
        }else if(datas.cancelStockStatus == "5"||datas.cancelStockStatus == "已关闭"){
            $("#cancelStockStatus").textbox("setValue",'已关闭');
        }else if(datas.cancelStockStatus== null||datas.cancelStockStatus.trim()==""||datas.cancelStockStatus == "新建"){
            $("#cancelStockStatus").html('新建');
            $(".save").show();

        };
        // 退料类型
        // $("#cancelStockType").textbox("setValue",datas.cancelStockType);
        if(datas.cancelStockType == "2"||datas.cancelStockType == "领出未用退料"){
            $("#cancelStockType").textbox("setValue","领出未用退料");
        }else if(datas.cancelStockType == "3"||datas.cancelStockType == "拆下无序号件退料"){
            $("#cancelStockType").textbox("setValue","拆下无序号件退料");
        }else if(datas.cancelStockType == "4"||datas.cancelStockType == "装机未用退料"){
            $("#cancelStockType").textbox("setValue",'装机未用退料');
        }else if(datas.cancelStockType == "5"||datas.cancelStockType == "改装包退料"){
            $("#cancelStockType").textbox("setValue",'改装包退料');
        };
        //退料数量
        $("#cancelStockQty").textbox("setValue",datas.cancelStockQty);

        //cc编号
        // $("#ccNo").html(datas.ccNo);
        // 件号
        $("#pn").textbox("setValue",datas.pn);
        //序号
        $("#sn").textbox("setValue",datas.sn);
        // 数量
        // $("#qty").textbox("setValue",datas.qty);
        if(datas.cancelStockType == "5"||datas.cancelStockType == "改装包退料"){
            $("#qty").textbox("setValue","");
        }else{
            $("#qty").textbox("setValue",datas.qty);
        }
        // 单位
        $("#unit").textbox("setValue",datas.unit);
        //批次号
        $("#batchNo").textbox("setValue",datas.batchNo);
        //目的航站
        $("#station").textbox("setValue",datas.toStation);
        //描述
        $("#reason").val(datas.reason);
        //描述
        // $("#noNeedDescription").val(datas.reason);
        //是否随机运输
        // $("#transport").val(datas.transport);
        //mrItem    MR行号
        $("#mrItem").textbox("setValue",datas.mrItem);
        //拆下航站
        $("#fromStation").textbox("setValue",datas.fromStation);
        //是否随机运输
        if(!!datas.transport){
            if(datas.transport == "2"){
                $("#transport-no").attr("checked","true")
            }else if(datas.transport == "1"){
                $("#transport-yes").attr("checked","true")
            }
        };
        //退料人名字
            $("#sendBackName").textbox("setValue", datas.sendBackName);

        //退料时间
            $("#sendBackTime").textbox("setValue",datas.sendBackTime);
        //退料单号
        //     $("#cancelStockId").html(datas.cancelStockId);
        //航班号
        // $("#flightNo").html(datas.flightNo);
        //无需退料
        // if(!!datas.noNeed == 'y'){
        //     $("#noNeed-no").prop('checked',true);
        // }else if(!!datas.noNeed == 'n') {
        //     $("#noNeed-yes").prop('checked',true);
        // }
    //    人名工号
        if(datas.sendBackName && datas.sendBackNumber){
            $("#finderSign").textbox("setValue", `${datas.sendBackName}(${datas.sendBackNumber})`)
        }

    }
    //赋值操作end

    //提交start
    function submit() {
        var sendBackName,sendBackNumber;
        var finderSign = $("#finderSign").textbox("getValue");
        if (!!finderSign) {
            sendBackNumber = finderSign.match(/\((.+?)\)/)[1];
            sendBackName = finderSign.split("(")[0];
        };
        // var planType;
        var airMaterialState;
        var cancelStockType;
        // if($("#airMaterialState").combobox("getValue")=="可用件"||$("#airMaterialState").combobox("getValue")=="USED"){
        //     airMaterialState = "USED";
        // }else if($("#airMaterialState").combobox("getValue")=="不可用件"||$("#airMaterialState").combobox("getValue")=="UNUSED"){
        //     airMaterialState = "UNUSED";
        // }else if($("#airMaterialState").combobox("getValue")=="待观察件"||$("#airMaterialState").combobox("getValue")=="WDISPOSE"){
        //     airMaterialState = "WDISPOSE";
        // };
        if($("#airMaterialState").combobox("getValue")=="可用件"||$("#airMaterialState").combobox("getValue")=="USED"||$("#airMaterialState").combobox("getValue")=="B"){
            airMaterialState = "B";
        }else if($("#airMaterialState").combobox("getValue")=="不可用件"||$("#airMaterialState").combobox("getValue")=="UNUSED"||$("#airMaterialState").combobox("getValue")=="A"){
            airMaterialState = "A";
        }else if($("#airMaterialState").combobox("getValue")=="待观察件"||$("#airMaterialState").combobox("getValue")=="WDISPOSE"||$("#airMaterialState").combobox("getValue")=="C"){
            airMaterialState = "C";
        };
        if($("#cancelStockType").combobox("getValue")=="领出未用退料"||$("#cancelStockType").combobox("getValue")=="2"){
            cancelStockType = "2";
        }else if($("#cancelStockType").combobox("getValue")=="拆下无序号件退料"||$("#cancelStockType").combobox("getValue")=="3"){
            cancelStockType = "3";
        }else if($("#cancelStockType").combobox("getValue")=="装机未用退料"||$("#cancelStockType").combobox("getValue")=="4"){
            cancelStockType = "4";
        }else if($("#cancelStockType").combobox("getValue")=="改装包退料"||$("#cancelStockType").combobox("getValue")=="5"){
            cancelStockType = "5";
        };
        // if($("#cancelStockStatus").combobox("getValue")=="实物登记"||$("#cancelStockStatus").combobox("getValue")=="1"){
        //     cancelStockStatus = "1";
        // }else if($("#cancelStockStatus").combobox("getValue")=="已入库"||$("#cancelStockStatus").combobox("getValue")=="2"){
        //     cancelStockStatus = "2";
        // }else if($("#cancelStockStatus").combobox("getValue")=="待上架"||$("#cancelStockStatus").combobox("getValue")=="3"){
        //     cancelStockStatus = "3";
        // }else if($("#cancelStockStatus").combobox("getValue")=="已上架"||$("#cancelStockStatus").combobox("getValue")=="4"){
        //     cancelStockStatus = "4";
        // }else if($("#cancelStockStatus").combobox("getValue")=="已关闭"||$("#cancelStockStatus").combobox("getValue")=="5"){
        //     cancelStockStatus = "5";
        // };
        // if($("#plan").combobox("getValue")=="非计划性"||$("#plan").combobox("getValue")=="1"){
        //     planType = "1";
        // }else if($("#plan").combobox("getValue")=="计划性"||$("#plan").combobox("getValue")=="2"){
        //     planType = "2";
        // };
        //post数据赋值
        var data = {
            'id': objData.id,

            'pn': $("#pn").val(),
            'sn': $("#sn").val(),
            'batchNo': $("#batchNo").val(),
            'mrNo': $("#mrNo").val(),
            'unit': $("#unit").val(),
            "mrItem":$("#mrItem").val(),
            // 'qty': $("#qty").val(),
            'cancelStockQty': $("#cancelStockQty").val(),
            //部件（航材）状态
            // 'airMaterialState': $("#airMaterialState").combobox("getValue"),
            'airMaterialState': airMaterialState,
            //退料单状态
            // 'cancelStockStatus': cancelStockStatus,
            //退料类型
            // 'cancelStockType': $("#cancelStockType").combobox("getValue"),
            'cancelStockType':cancelStockType,
            'toStation': $("#station").val(),

            //是否随机运输
            'transport': $("input[type='radio']:checked").val(),
            //退料原因
            'reason': $("#reason").val(),
            //退料人名字
            'sendBackName': sendBackName,
            'sendBackNumber': sendBackNumber,
            //退料时间
            'sendBackTime': $("#sendBackTime").textbox("getValue"),
            // 'noNeed': $('input[name="noNeed"]:checked').val(),
            'noNeed':"n",//后台默认n为需要退料，y为不需要退料
            //无需退料
            // 'noNeed': $("#noNeed").prop('checked'),
            //拆下航站
            // 'fromStation':$("#fromStation").textbox("getValue"),
            //退料单
            // 'cancelStockId':$("#cancelStockId").val(),
            //航班号
            // 'flightNo':$("#flightNo").val(),
        //    工单ID
            'workorderId':objData.workorderId,
            'flightNo':objData.flightNo,
            'flightId':objData.flightId,
            'fromStation':objData.fromStation,
            //    计划性
            // 'planType': $("#plan").combobox("getValue"),
            // 'planType': planType,
        };
        //校验
        if( $("#cancelStockStatus").val()!="新建"&&$("#cancelStockStatus").val()!="实物登记"){
            alert("非新建状态或是实物登记状态不允许编辑提交");
            return false;
        }else if($("#cancelStockType").combobox("getValue")=="拆下无序号件退料"||$("#cancelStockType").combobox("getValue")=="3"){
            if(noNubValidForm(data)){
                return false;
            };
        }else {
            if(validForm(data)){
                return false;
            };
        }

        var url = "/api/v1/cancelSock/edit";
        $.ajax({
            type: "POST",
            url: url,
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(data),
            dataType: "json",
            success: function (data) {
                //console.log(data);
                if (data.code == 200) {
                    alert("成功！");
                    window.close();
                    if (typeof cancelSocket.OWindow.queryCCTable == "function"){cancelSocket.OWindow.queryCCTable()} ;
                }
                // else if (data.msgData && data.msgData[0]) {
                //     alert(data.msgData[0]);
                // }
                else {
                    alert(data.msg);
                }
            },
            error: function () {
                window.alert("提交失败！");
            }
        });
    }
    //提交end

    //航站查询start
    function stationQuery() {
        var title_ = $.i18n.t('航站查询');
        var curWidth = ($(window).width() * 0.5).toString();
        var curheight = ($(window).height() * 0.5).toString();
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: title_,
            param: {},
            url: "/views/tbm/flb/station_query.shtml"
        });
    }
    //航站查询start

    //添加附件功能
    function add_file(i) {
        let file = " <div id=\"atta_input_flie_" + i + "\" class=\"atta_input_fliecss atta_input_fliecss_move\">\n" +
            "       <input class=\"textbox easyui-validatebox\" type=\"file\" id=\"atta_input_flie_a" + i + "\" size=\"300\" name=\"file\" data-options=\"required:true\"/>            \n" +
            "                    <div class=\"add_jiahao\" onclick=\"add_atta_input_flie()\" style='margin-top: 5px'></div>\n" +
            " <div class='file_duihao' onclick=\"atta_input_flie('atta_input_flie_a'+" + i + ")\">✔</div>\n" +
            "                    <div class=\"jianhao icon-delete\" onclick=\"delete_atta_input_flie(atta_input_flie_" + i + ")\" style='margin-top: 4px'></div>\n" +
            "                </div>";
        let html_row = $(file);
        $("#attachament_td").append(html_row);
    }
    //附件上传增加按钮
    function add_atta_input_flie() {
        add_file(lisr_file);
        lisr_file++;
    }
    //附件上传删除按钮
    function delete_atta_input_flie(val) {
        let geshu = document.getElementsByClassName('atta_input_fliecss_move');

        if (geshu.length == 1) {
            return
        }
        let newP = $(val);
        if (newP.length > 0) {
            newP.remove();
        }
    }
    //附件上传打钩按钮
    function atta_input_flie(id) {

        if ($("#ccid").val() != " ") {
            var fileInput = $("#" + id).get(0).files[0];
            if (fileInput) {
                $.ajaxFileUpload({
                    url: Constant.API_URL + 'ATTACHMENT_UPLOAD',
                    secureuri: false,
                    fileElementId: id, //file控件id
                    dataType: 'json',
                    data: {
                        "fileCategory": "cancelStock",
                        "sourceId":  cancelSocket.id,
                    },
                    success: function (data) {
                        if (data.code == 200) {
                            var file = document.getElementById("" + id + "");
                            file.value = '';
                            $("#" + id).value = "";
                            add_file_show(cancelSocket.id);
                            sapCallBack();
                        }

                    }

                })
            } else {
                alert("请选择上传文件！");
            }
        } else {
            alert("请先保存，在上传附件！")
        }

    }

    //删除已添加附件
    function deleteFile(fileid) {
        var _url = basePath + "/api/v1/mccdoc/to_base_info/deleteAttachment";
        P.$.dialog.confirm('Delete Selected ?', function () {
            $.ajax({
                url: _url,
                type: "get",
                data: {'pkid': fileid},
                dataType: "json",
                cache: false,
                success: function (data) {
                    if (data.code == 200) {
                        P.$.dialog.alert("Success");
                        $("#qc_table_detail #appendTr").remove();
                        add_file_show(cancelSocket.id);
                        sapCallBack();
                    }
                }
            });
        }, function () {
        });
    }
    //增加文件
    function add_file_show(id) {
        $("#attach_file").empty();
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: id,
                CATEGORY: "cancelStock",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                for (var ind in jdata.data) {
                    let file = " <div id=\"input_flie_show" + jdata.data[ind].PKID + "\" class=\"atta_input_fliecss\" style=\"line-height: 30px;width: 100%;    height: 30px;border-bottom: 1px solid #ccc;\">\n" +
                        "                            <div style=\"width: 60%;text-align: left;\"><a style=\"color:red;font-size: 14px\" onclick=\"downFile(" + jdata.data[ind].PKID + "," + jdata.data[ind].PKID + ")\">" + jdata.data[ind].ORG_NAME + "</a></div>\n" +
                        "\n" +
                        "                        <div class=\"jianhao icon-delete\" onclick=\"deleteFile(" + jdata.data[ind].PKID + ")\"></div>\n" +
                        "                        </div>";
                    let html_row = $(file);
                    $("#attach_file").append(html_row);
                }

            }
        });
    }
//    件号搜索start
    //    件号选择后事件
    function pn_data(type, ind) {
        $.pnSelect({
            success: function (data) {
                if (type == "A") {
                    $("#pn").textbox('setValue', data.partno);
                    // $("#jian_name" + ind).textbox('setValue', data.description);
                    // $("#sn" + ind).textbox('setValue', data.itemnum);
                    // if ($("#sn").textbox("getValue")) {
                    //     caixia_gouxin( data.partno, "");
                    //     caixia_weizhi(data.partno, "no", 'OFF');
                    // }

                } else if (type == "B") {
                    $("#original" + ind).textbox('setValue', data.partno);
                    $("#jian_name" + ind).textbox('setValue', data.description);
                    zhuang_gouxin(data.partno, "");
                    if ($("#stazone").textbox("getValue")) {
                        caixia_weizhi(data.partno, "no", 'ON');
                    }

                } else if (type == "C") {
                    $("#cai_original" + ind).textbox('setValue', data.partno);
                } else if (type == "D") {
                    $("#zhuang_original" + ind).textbox('setValue', data.partno);
                }

            }
        })
    }
//    件号搜索end

//    下拉框数据加载start
    function addDropDate(datas) {
       // 添加部件状态数据
       //  $("#airMaterialState").combobox({
       //      textField: 'TEXT',
       //      valueField:  'VALUE',
       //      data: [{
       //          TEXT :"可用件",
       //          VALUE:"USED"
       //      },{
       //          TEXT: "不可用件",
       //          VALUE: "UNUSED"
       //      },{
       //          TEXT: "待观察件",
       //          VALUE: "WDISPOSE"
       //      }
       //      ],
       //  });

        $("#airMaterialState").combobox({
            textField: 'TEXT',
                valueField:  'VALUE',
                data: [{
                TEXT :"可用件",
                VALUE:"B"
            },{
                TEXT: "不可用件",
                VALUE: "A"
            },{
                TEXT: "待观察件",
                VALUE: "C"
            }
            ],
        });
       // 退料类型
        if(datas.cancelStockType == "3"||datas.cancelStockType == "拆下无序号件退料"){
            $("#cancelStockType").combobox({
                textField: 'TEXT',
                valueField:  'VALUE',
                data: [{
                    TEXT: "拆下无序号件退料",
                    VALUE: "3"
                }
                ],
            });
        }else {
            $("#cancelStockType").combobox({
                textField: 'TEXT',
                valueField:  'VALUE',
                data: [{
                    TEXT: "领出未用退料",
                    VALUE: "2"
                },{
                    TEXT: "装机未用退料",
                    VALUE: "4"
                }
                ],
            });
        }
        // 退库单状态
        // if(datas.cancelStockStatus == "2"||datas.cancelStockStatus == "已入库"){
        //     $("#cancelStockStatus").combobox({
        //         textField: 'TEXT',
        //         valueField:  'VALUE',
        //         data: [{
        //             TEXT: "已入库",
        //             VALUE: "2"
        //         }
        //         ],
        //     });
        // }else {
        //     $("#cancelStockStatus").combobox({
        //         textField: 'TEXT',
        //         valueField:  'VALUE',
        //         data: [{
        //             TEXT: "实物登记",
        //             VALUE: "1"
        //         },{
        //             TEXT: "已入库",
        //             VALUE: "2"
        //         },{
        //             TEXT: "待上架",
        //             VALUE: "3"
        //         },{
        //             TEXT: "已上架",
        //             VALUE: "4"
        //         },{
        //             TEXT: "已关闭",
        //             VALUE: "5"
        //         }
        //         ],
        //     });
        // }
        // $("#plan").combobox({
        //     textField: 'TEXT',
        //     valueField:  'VALUE',
        //     data: [{
        //         TEXT :"非计划性",
        //         VALUE:"1"
        //     },{
        //         TEXT: "计划性",
        //         VALUE: "2"
        //     }
        //     ],
        // });

    //    点击选择工作者
        $("#sendBackName").MyComboGrid({
            idField: 'USER_NAME',  //实际选择值
            textField: 'USER_NAME', //文本显示值
            panelHeight: '180px',
            required: true,
            width: "70%",
            params: {FunctionCode: 'FLOW_WORK_ACCOUNT'},
            columns: [[
                {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                {field: 'USER_NAME', title: '审核人', width: 50}
            ]],
            onHidePanel: function () {
                var t = $(this).combogrid('getValue');
                if (t != null && t != '' & t != undefined) {
                    if (selectRow == null || t != selectRow.USER_NAME) {//没有选择或者选项不相等时清除内容
                        alert('请选择，不要直接输入！');
                        $(this).combogrid({value: ''});
                    }
                }
            },
            onSelect: function (index, row) {
                selectRow = row;
                $("#repname").val(row.ACCOUNT_NUMBER);
            }
        });
    //退料人工号名字
        $("#finderSign").textbox({
            value: `${userName}(${userId})`,
            editable: false,
            icons: [{
                iconCls:'icon-search',
                handler: function(e){
                    $.dialog.setting.extendDrag = true;
                    UserUtils.showDialog({
                        callback:function(data){
                            let user_info = data[0];
                            $("#finderSign").textbox("setValue", user_info.userName + "(" + user_info.sn + ")")
                        }
                    });
                }
            }, {
                iconCls:'icon-cross',
                handler: function(e){
                    $("#finderSign").textbox("setValue", "")
                }
            }]
        });


    }
//    下拉数据加载end

    //加载数据字典,获取到下拉选择项 start
    // queryDataDict({
    //     "domainCode": "AIR_MATERIAL_STATE",
    //     succFn:function(data){
    //         if(data){
    //             // air_material_state_list = data.AIR_MATERIAL_PROPERTIES;
    //             // jiahua_list = data.CC_PLAN_TYPE;
    //             hangcaitype_list = data.AIR_MATERIAL_STATE;
    //             // caihuanyuanyin_list = data.CC_SOURCE_TYPE;
    //         }
    //     }
    // });
    // $("#cancelStockStatus").combobox({
    //     valueField: 'VALUE',
    //     textField: 'TEXT',
    //     panelHeight: '70px',
    //     data: hangcaitype_list,
    // });
    //加载数据字典,获取到下拉选择项 end

//    数据校验start
function validForm(datas) {
        //标记
    var isValid = false,flag = 0;
    var sn = datas.sn;
    var pn = datas.pn;
    var batchNo = datas.batchNo;
    var mrItem = datas.mrItem;
    var mrNo = datas.mrNo;
    var unit = objData.unit;
    var qty = objData.qty;
    var cancelStockQty = datas.cancelStockQty;
    // var airMaterialState = datas.airMaterialState;
    // var cancelStockType = datas.cancelStockType;
    var toStation = datas.toStation;
    // var cancelStockStatus =objData.cancelStockStatus;
    var transport = datas.transport;
    var sendBackName = datas.sendBackName;
    var sendBackTime = datas.sendBackTime;
    // var noNeed = datas.noNeed;
    var fromStation = datas.fromStation;
    // var cancelStockId = cancelSocket.cancelStockId;
    // var flightId = cancelSocket.flightId;
    var reason = datas.reason;
    // var planType = datas.planType;
        //查看是否有附件
    var hasAnnex = $("#attach_file").find("a").length;
    if(!!cancelStockQty==false){
        alert("请输入退料数量");
        isValid = true;
    }else if(!!toStation==false){
        alert("请选择目的航站");
        isValid = true;
    }else if(!!sendBackName==false){
        alert("请选择退料人");
        isValid = true;
    }else if(!!sendBackTime==false){
        alert("请选择退料时间");
        isValid = true;
    }else if(!!reason==false){
        alert("请输入退料说明/部件故障描述");
        isValid = true;
    }else if(transport == null || transport == ""){
            alert('运输方式必填');
            isValid = true;
    }else if(judgeDate(sendBackTime)>0){
            alert('退料时间不能大于当前时间');
            isValid = true;
    } else if(!($("#cancelStockType").combobox("getValue")=="5"||$("#cancelStockType").combobox("getValue")=="改装包退料")){

        if(cancelStockQty > qty){
            alert("退料数量大于发料数量");
            isValid = true;
        }
    }

    return  isValid
    }
//    数据校验end

//    是否显示“拆下性质”“关联CC号”start
    function isShow(cc) {
        if( !!cc && cc == "cc"){
        // if(true){
            $(".ccShow").hide();
        }
    }
//    是否显示“拆下性质”“关联CC号”end

    //    判断选择时间和当前时间start
    function judgeDate(tomodifyDate){
        return new Date(tomodifyDate).getTime()-new Date().getTime();
    }
    //    判断选择时间和当前时间end

    //    切换风格start
    function switchClass() {
                if($("#cancelStockType").combobox("getValue")=="3"||$("#cancelStockType").combobox("getValue")=="拆下无序号件退料"){
                    $(".zhezhao").show();
                    $(".mustClass").hide();
                }else {
                    $(".zhezhao").hide();
                    $(".mustClass").show();
                }
    }
    //    切换风格end

    //    无序号拆下件退库数据校验start
    function noNubValidForm(datas) {

        //标记
        var isValid = false,flag = 0;
        var sn = datas.sn;
        var pn = datas.pn;
        var batchNo = datas.batchNo;
        var mrItem = datas.mrItem;
        var mrNo = datas.mrNo;
        var unit = datas.unit;
        var qty = datas.qty;
        var cancelStockQty = datas.cancelStockQty;
        // var airMaterialState = datas.airMaterialState;
        var cancelStockType = datas.cancelStockType;
        var toStation = datas.toStation;
        // var cancelStockStatus =datas.cancelStockStatus;
        var transport = datas.transport;
        var sendBackName = datas.sendBackName;
        var sendBackTime = datas.sendBackTime;
        // var noNeed = datas.noNeed;
        var fromStation = datas.fromStation;
        // var cancelStockId = cancelSocket.cancelStockId;
        var reason = datas.reason;
        // var planType = datas.planType;
        //处理退料说明输入空格，去除空格
        reason=reason.trim();

        if(!!cancelStockQty==false){
            alert("请输入退料数量");
            isValid = true;
        } else if(!!toStation==false){
            alert("请选择目的航站");
            isValid = true;
        }else if(!!sendBackName==false){
            alert("请选择退料人");
            isValid = true;
        } else if(!!sendBackTime==false){
            alert("请选择退料时间");
            isValid = true;
        }else if(transport == null || transport == ""){
            alert('运输方式必填');
            isValid = true;
        }else if(judgeDate(sendBackTime)>0){
            alert('退料时间不能大于当前时间');
            isValid = true;
        }else if(!!reason==false){
            alert("请输入退料说明/部件故障描述");
            isValid = true;
        }
        return  isValid
    }
    //    无序号拆下件退库数据校验end

//    上传附件后回调sap start
    function sapCallBack() {
        var url = "/api/v1/cancelSock/callBack/"+" ' "+ cancelSocket.id+ " ' ";
        $.ajax({
            type: "get",
            url: url,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    console.log("成功");
                }  else {
                    console.log(data.msg);
                }
            },
            error: function () {
                window.alert("附件回调sap失败！");
            }
        });
    };
//    上传附件后回调Sap end

</script>
</body>

</html>