<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head id="i18n_">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->

    <meta charset="UTF-8">

    <title>Title</title>
    <style>
     #fixedPatchInfo{
         background: #fff;
         width: 100%;
         height: 100%;
         table-layout: fixed;
         border-width: 1px;
         display: table;
         border-collapse: collapse;
     }
     #fixedPatchInfo .lineInfo{
         width: 10%;
         height: 25px;
         line-height: 25px !important;
         background: rgb(245, 245, 246);
         border: 0.5px solid #ccc;
         word-break: break-all;
         padding: 8px;
         text-align: center;
     }

     #fixedPatchInfo .lineInfo td .textbox ,#fixedPatchInfo .lineInfo td .td_input {
         width: 95% !important;
     }
     #fixedPatchInfo .lineInfo textarea{
         width: 98%;
         height: 80px;
         display: inline-block;
         margin: 5px 0 5px 5px;
         resize: none;
     }

     #buttom a {
         display: inline-block;
         cursor: pointer;
         background: #2465a8;
         color: #fff;
         border-radius: 4px;
         padding: 5px 20px;
         border: none;
         font-size: 14px;
         margin-right: 12px;
     }

     #buttom {
         text-align: right;
         margin-top: 30px;
     }


    </style>
</head>
<script src="../../../js/datagrid_utils.js" type="text/javascript"></script>
<body>
<div>
    <!--    <form id="ffSearch" class="form-horizontal">-->

    <table id="fixedPatchInfo">
        <tbody>
            <tr>
               <td colspan="2" class="lineInfo">长（inch）:</td>
               <td class="lineInfo">
                   <input class="td_input easyui-textbox" data-options="editable:true,validType:'fixedParams'" name="length" style="width: 80%"
                          type="text" id="length">
               </td>
                <td class="lineInfo">宽（inch）:</td>
                <td class="lineInfo">
                    <input class="td_input easyui-textbox" data-options="editable:true,validType:'fixedParams'" name="wide" style="width: 80%"
                           type="text" id="wide">
                </td >
                <td class="lineInfo">厚度（inch）:</td>
                <td class="lineInfo">
                    <input class="td_input easyui-textbox" name="thickness" style="width: 80%"
                           type="text" id="thickness">
                </td>
                <td class="lineInfo">面积（in²）:</td>
                <td class="lineInfo">
                    <input class="td_input easyui-textbox" data-options="editable:true,validType:'fixedParams'" name="area" style="width: 80%"
                           type="text" id="area">
                </td>
                <td class="lineInfo">材料:</td>
                <td class="lineInfo">
                    <input class="td_input easyui-textbox" name="material" style="width: 80%"
                           type="text" id="material">
                </td>
            </tr>
            <tr>
                <td colspan="2" class="lineInfo">重量（g）:</td>
                <td class="lineInfo">
                    <input class="td_input easyui-textbox" data-options="editable:true,validType:'fixedParams'" name="weight" style="width: 80%"
                           type="text" id="weight">
                </td>
                <td colspan="2" class="lineInfo">力矩变化（LBS）:</td>
                <td colspan="2" class="lineInfo">
                    <input class="td_input easyui-textbox" data-options="editable:true,validType:'fixedParams'" name="torqueChange" style="width: 80%"
                           type="text" id="torque_change">
                </td >
                <td colspan="2" class="lineInfo">内外补:</td>
                <td colspan="3" class="lineInfo">
                    <input id="inner" name="direction" type="radio" value="1"><label for="inner">内补</label>
                    <input id="outer" name="direction" type="radio" value="0"><label for="outer">外补</label>
                </td>
            </tr>
            <tr>
                <td colspan="2" class="lineInfo">
                    备注
                </td>
                <td colspan="9" class="lineInfo">
                    <textarea id="remark" name="remark"></textarea>
                </td>
            </tr>
            <tr>
                <td colspan="2" class="lineInfo">
                    附件
                </td>
                <td colspan="9" class="lineInfo">
                    <div id="fileList"></div>

                    <a class="searchBtn" data-options="iconCls:'icon-clear'" id="upload_button" onclick="open_upload()"
                       style="margin-right: 10px;float: right" type="button">
                        <span data-i18n="common:COMMON_OPERATION.UPLOAD"></span>
                    </a>
                </td>

            </tr>
        </tbody>
    </table>
    <div id="buttom">
        <a href="javascript:" onclick="save()">保存</a>
    </div>
    <!--    </form>-->

</div>
</body>
<script type="text/javascript">
    $(function(){
        var reg = /^\d{0,9}(\.\d{1,3})?$/;	                //正则表达式
        $.extend($.fn.validatebox.defaults.rules, {
            fixedParams: { 				        //自定义校验名称
                validator: function(value, param){
                    return reg.test(value);		//进行校验
                },
                message: '参数为长度不能超过9位的数字且小数位不能超过三位!' 	//提示格式错误的信息
            }
        });
        //获取数据
        get_data();
    });
    var param = getParentParam_();

    //编辑时获取详情数据
    function get_data(){
        if(param.operation == "add"){
            return;
        }
        //编辑时获取修理补片详情内容
        $.ajax({
            type: "GET",
            url: "/api/v1/tbm/nrc/nrcPhysicalInfo/findNrcPhysicalInfoById/"+param.id,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    init_data(data.data)
                }
            },
            error: function () {
                MsgAlert({type: "error", content: "获取补片信息失败: " + err})
            }
        });
    }

    //编辑时 填充内容
    function init_data(data){
        $("#length").textbox('setValue', data.length);
        $("#wide").textbox('setValue', data.wide);
        $("#area").textbox('setValue', data.area);
        $("#weight").textbox('setValue', data.weight);
        $("#torque_change").textbox('setValue', data.torqueChange);
        $("#thickness").textbox('setValue', data.thickness);
        $("#material").textbox('setValue', data.material);
        $("#remark").val(data.remark);
        if(data.inorout == 1){
            $("#inner").prop('checked','checked');
        }else if(data.inorout == 2){
            $("#outer").prop('checked','checked');
        }else if(data.inorout == 0){
            $("#inner").attr("checked", false);
            $("#outer").attr("checked", false);
        }
        for (var i = 0; i < data.attachmentList.length; i++) {
            var trHTML = '<tr><td class="td5"><a target="_blank" onclick="downNrcPhyFile(' + data.attachmentList[i].pkid + '))">' + data.attachmentList[i].orgName + '</a></td><td class="td5"  ><input class="btn btn-primary" type="button"  value="删除" style="width: 50px;margin:5px;" onclick="deleteFile('+ data.attachmentList[i].pkid + ');return false;"/></td></tr>';
            $("#fileList").append(trHTML);//在table最后面添加一行
        }
    }

    //保存
    function save(){
        let params = checkParams().params;
        let flag = checkParams().flag;
        if(!flag){
            MsgAlert({content: '参数为长度不能超过9位的数字且小数位不能超过三位!', type: 'error'});
            return false;
        }
        params.thickness = $("#thickness").textbox('getValue');
        params.material = $("#material").textbox('getValue');
        params.remark = $("#remark").val();
        if($("#inner").is(":checked")){
            params.inorout = 1;
        }else if($("#outer").is(":checked")){
            params.inorout = 2;
        }else{
            params.inorout = 0;
        }
        let empty = true;
        for(let i in params){
            if(!!params[i]){
                empty = false;
            };
        }
        if(empty){
            MsgAlert({content: '参数不能都为空!', type: 'error'});
            return false;
        }
        params.nrcId = param.nrcid;
        if(param.id){
            params.id =  param.id;
        }
        $.ajax({
            type: "POST",
            url: '/api/v1/tbm/nrc/nrcPhysicalInfo/editNrcPhysicalInfo',
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify( params),
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    if(data.data){
                        param.id =  data.data;
                    }
                    if (typeof param.OWindow.queryFixedTable == "function") param.OWindow.queryFixedTable();
                    MsgAlert({type: "success", content: "保存成功！"});
                }
            },
            error: function () {
                MsgAlert({type: "error", content: "补片信息保存失败! "})
            }
        });
    };

    //保存验证
    function checkParams(){
        let obj = {
            flag:true,
            params:{}
        };
        let paramsTest = /^\d{0,9}(\.\d{1,3})?$/;
        obj.params.length = $("#length").textbox('getValue');
        obj.params.wide = $("#wide").textbox('getValue');
        obj.params.thickness = $("#thickness").textbox('getValue');
        obj.params.area = $("#area").textbox('getValue');
        obj.params.weight = $("#weight").textbox('getValue');
        obj.params.torqueChange = $("#torque_change").textbox('getValue');
        if(!paramsTest.test(obj.params.length)){
            obj.flag = false;
        }
        if(!paramsTest.test(obj.params.wide)){
            obj.flag = false;
        }
        if(!paramsTest.test(obj.params.thickness)){
            obj.flag = false;
        }
        if(!paramsTest.test(obj.params.area)){
            obj.flag = false;
        }
        if(!paramsTest.test(obj.params.weight)){
            obj.flag = false;
        }
        if(!paramsTest.test(obj.params.torqueChange)){
            obj.flag = false;
        }
        return obj;
    }

    //补片上传
    function open_upload() {
        //判断是否先保存了isSavedInfo
        if(!param.id){
            MsgAlert({content: '请先保存数据!', type: 'error'});
            return false;
        }
        var catType = 'nrcPhysicalInfo';
        let sonId = param.id;
        var title_ = $.i18n.t('common:COMMON_OPERATION.UPLOAD');
        let option = {
            cat: catType,//文件夹
            sourceId: sonId,//
            successCellBack: function(){},
            fialCellBack: "",
        };
        ShowWindowIframe({
            width: "1000",
            height: "700",
            title: title_,
            param: option,
            url: "/views/data_manager/dm/upload/attachment_add.shtml"
        });
    }

    //上传初始化
    function reload_(id) {
        $("#fileList").empty();
        let sonId = id ? id : param.id;
        var catType = 'nrcPhysicalInfo';
        InitDataGrid(sonId, catType);
        if (typeof param.OWindow.queryFixedTable == "function") param.OWindow.queryFixedTable();
    }

    function InitDataGrid(pkid, category) {
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: pkid,
                CATEGORY: category,
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                for (var i = 0; i < jdata.data.length; i++) {
                    var trHTML = '<tr><td class="td5"><a target="_blank" onclick="downFile(' + jdata.data[i].PKID + ')">' + jdata.data[i].ORG_NAME + '</a></td><td class="td5"  ><input class="btn btn-primary" type="button"  value="删除" style="width: 50px;margin:5px;" onclick="deleteFile(' + jdata.data[i].PKID + ');return false;"/></td></tr>';
                    $("#fileList").append(trHTML);//在table最后面添加一行
                }
            }
        });
    }

    //下载
    function downNrcPhyFile(pkid, filename) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, filename: filename, FunctionCode: 'ATTACHMENT_DOWN'},
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    doPost(Constant.API_URL + "/ATTACHMENT_DOWN", {pkid: pkid, filename: filename, down: 'Y'});
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

</script>

</html>