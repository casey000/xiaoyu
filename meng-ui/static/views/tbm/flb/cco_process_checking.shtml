<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head id="i18n_">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->

    <meta charset="UTF-8">

    <title>Title</title>
    <link href="/css/nrc/addcc_close_dialog.css" rel="stylesheet">
    <style>
        #process {
            width: 100%;
            height: 99%;
        }
        #process_table #ewisTable td{
            background: #fff;
        }
        #process_table #oilSpill1 td{
            background: #fff;
        }
        #process_table {
            background: #fff;
            width: 100%;
            height: 100%;
            table-layout: fixed;
            border-width: 1px;
            display: table;
            border-collapse: collapse;
        }
        /*#process_table td {*/
        /*height: 25px;*/
        /*line-height: 25px;*/
        /*background: rgb(245, 245, 246);*/
        /*border: 0.5px solid #ccc;*/
        /*word-break: break-all;*/
        /*width: 18.4%;*/
        /*padding: 0;*/
        /*}*/
        #process_table .line_process,#process_table .partLine{
            width: 100%;
        }

        #process_table .partLine .partStyle{
            height: 42px;
            line-height:42px;
            color:#666;
            vertical-align: bottom;
            display: inline-block;
            text-align: center;
            border-right: 1px solid #ccc;
            background: rgb(245, 245, 246);
        }

        #process_table .line_process td {
            height: 25px;
            line-height: 25px;
            background: rgb(245, 245, 246);
            border: 0.5px solid #ccc;
            word-break: break-all;
            /*width: 18.4%;*/
            width: 16.8%;
            padding: 0;
        }


        #process_table .partLine td {
            height: 25px;
            line-height: 25px;
            background: rgb(245, 245, 246);
            border: 0.5px solid #ccc;
            word-break: break-all;
            width: 10.4% !important;
            padding:0;
        }
        #process_table .line_process td .key, #process_table .partLine td .key{
            text-align: center;
            padding: 8px;
            font-size: 13px;
        }

        #process_table .line_process td .key span,#process_table .partLine td .key span{
            color:red;
        }

        #process_table .line_process td textarea, #process_table .partLine td textarea{
            width: 98%;
            height: 80px;
            display: inline-block;
            margin: 5px 0 5px 5px;
            resize: none;
        }

        #process_table .line_process td .td_input,#process_table .partLine td .td_input {
            width: 95% !important;
        }

        #process_table .line_process td .textbox, #process_table .partLine td .textbox{
            width:95% !important ;
        }

        #process_table .line_process td .checkb,#process_table .partLine td .checkb{
            display: none;
        }

        tr.tlb {
            display: none;
        }

        /*tr.tlb input{*/
        /*    display: inline-block;*/
        /*}*/
        #process_table .line_process .val,#process_table .partLine .val{
            background-color: #ffffff;
        }

        #process_table td textarea {
            width: 98%;
            display: inline-block;
            margin: 5px 0 5px 5px;
        }

        #buttom a {
            display: inline-block;
            cursor: pointer;
            background: #2465a8;
            color: #fff;
            border-radius: 4px;
            padding: 5px 20px;
            border: none;
            font-size: 14px;
            margin-right: 12px;
        }

        #buttom {
            text-align: right;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .ccconfig {
            margin-left: 5px;
            color: sandybrown;
        }

        .ccconfig span {
            margin-left: 5px;
            color: sandybrown;
        }
        #troubleShootingHtml {

        }

        #troubleShootingHtml td {
            width: auto;

            text-align: center;
            border-bottom: none;
        }

        .td-line30-center {
            height: 25px;
            text-align: center;
            vertical-align: middle;
            /*width: auto !important;*/
        }

        #process_table .td-line30-center txtarea {
            height: auto !important;
        }

        #trouble_shooting_table {
            table-layout: fixed;

            border: none;
            border-collapse: collapse;
        }

        th, td {
            text-align: center;
            padding: 0;
            margin: 0;
        }

        #fileList tr td {
            width: 200px !important;
        }
        .add_tlb{
            position: absolute;
            top: 6px;
            right: 0px;
            display: inline-block;
            cursor: pointer;
            background: #2465a8;
            color: #fff;
            border-radius: 4px;
            padding: 2px 15px;
            border: none;
            font-size: 14px;
            margin-right: 12px;
        }
        .jianhao{
            width: 20px;
            height: 20px;
            float: right;
            margin-right: 10px;
        }

    </style>
</head>
<script src="../../../js/datagrid_utils.js" type="text/javascript"></script>
<script src="../../../js/compccClose.js" type="text/javascript"></script>
<body>
<div id="process">
    <!--    <form id="ffSearch" class="form-horizontal">-->

    <table id="process_table">
        <tbody>
        <tr class="line_process" style="display: none">
            <td class="key">页面id</td>
            <td class="val">
                <div id="ccoId"></div>
            </td>
        </tr>
        <tr class="line_process">
            <td>
                <div class="key">项次号</div>
            </td>
            <td class="val"><span id="itemNo" name="itemNo"></span></td>
            <td>
                <div class="key">任务类型</div>
            </td>
            <td class="val" id="workType"></td>
            <td>
                <div class="key">任务文件号</div>
            </td>
            <td class="val" id="cardNumber"></td>

        </tr>
        <tr class="line_process">
            <!--TODO-->
            <td>
                <div class="key">重要标识</div>
            </td>
            <td class="val"  >
                <div class="checkb dm"><input class="input_checkbox" id="dm" type="checkbox" value="1"  disabled><label
                        for="dm">DM</label>
                </div>
                <div class="checkb rii"><input class="input_checkbox" id="rii" type="checkbox" value="2" disabled><label
                        for="rii">RII</label>
                </div>
                <div class="checkb rci"><input class="input_checkbox" id="rci" type="checkbox" value="3" disabled><label
                        for="rci">RCI</label>
                </div>
                <div class="checkb ifsd"><input class="input_checkbox" id="ifsd" type="checkbox" value="4" disabled><label
                        for="ifsd">IFSD</label>
                </div>
                <div class="checkb cmr"><input class="input_checkbox" id="cmr" type="checkbox" value="5" disabled><label
                        for="cmr">CMR</label>
                </div>
                <div class="checkb ali"><input class="input_checkbox" id="ali" type="checkbox" value="6" disabled><label
                        for="ali">ALI</label>
                </div>
                <div class="checkb cdccl"><input class="input_checkbox" id="cdccl" type="checkbox" value="7" disabled><label
                        for="cdccl">CDCCL</label>
                </div>
                <div class="checkb cpcp"><input class="input_checkbox" id="cpcp" type="checkbox" value="8" disabled><label
                        for="cpcp">CPCP</label>
                </div>
                <div class="checkb ewis"><input class="input_checkbox" id="ewis" type="checkbox" value="9" disabled><label
                        for="ewis">EWIS</label>
                </div>
                <div class="checkb fts"><input class="input_checkbox" id="fts" type="checkbox" value="10" disabled><label
                        for="fts">FTS</label>
                </div>
                <div class="checkb rsc"><input class="input_checkbox" id="rsc" type="checkbox" value="11" disabled><label
                        for="rsc">RSC</label>
                </div>
                <div class="checkb ssi"><input class="input_checkbox" id="ssi" type="checkbox" value="12" disabled><label
                        for="ssi">SSI</label>
                </div>
                <div class="checkb importantModification"><input class="input_checkbox" id="importantModification" type="checkbox" value="13" disabled><label
                        for="importantModification">重要改装</label>
                </div>
            <td>
                <div class="key">需反馈附件</div>
            </td>
            <td class="val">
                <input id="yes" name="flyFiles" type="radio" value="1" disabled><label
                    for="yes">是</label>

                <input id="no" name="flyFiles" type="radio" value="0" disabled><label
                    for="no">否</label>
            </td>
            <td class="line_process">
                <div class="key">任务状态</div>
            </td>
            <td class="val line_process" id="workStatus"></td>
        </tr>
        <tr class="line_process">
            <td>
                <div class="key">任务描述</div>
            </td>
            <td class="val" colspan="5" id="taskDes"></td>
        </tr>
        <tr class="line_process">
            <td colspan="3">
                <div class="key" >反馈信息中文 <span>*</span></div>
            </td>
            <td colspan="3">
                <div class="key">反馈信息英文 <span>*</span></div>
            </td>
        </tr>
        <tr class="line_process">
            <td class="val" colspan="3" style="padding: 8px">
                <textarea id="descChn" name="descChn"></textarea>
            </td>
            <td class="val" colspan="3" style="padding: 8px">
                <textarea id="descEn" name="descEn"></textarea>
            </td>
        </tr>
        <tr class="line_process">
            <td colspan="6">
                <div class="key">部件拆换</div>
            </td>
        </tr>
        <tr class="partLine" id="partContent">
            <td colspan="6">
                <div class="partStyle" style="width:8%;">CC编号</div>
                <div class="partStyle" style="width:12%;">部件名称</div>
                <div class="partStyle" style="width:12%;">拆下件号</div>
                <div class="partStyle" style="width:14%;">拆下序号</div>
                <div class="partStyle" style="width:12%;">位置</div>
                <div class="partStyle" style="width:8%;">装上件号</div>
                <div class="partStyle" style="width:8%;">装上序号</div>
                <div class="partStyle" style="width:20%;border-right: none">操作</div>
            </td>
        </tr>
        <tr class="line_process">
            <td colspan="1">
                <div class="key">完工日期<span>*</span></div>
            </td>
            <td colspan="1">
                <div class="key">工时<span>*</span></div>
            </td>
            <td colspan="1">
                <div class="key">关卡人工号<span>*</span></div>
            </td>
            <td colspan="1">
                <div class="key">关卡人签署<span>*</span></div>
            </td>
            <td colspan="1">
                <div class="key">必检人工号</div>
            </td>
            <td colspan="1">
                <div class="key">必检人签署</div>
            </td>
        </tr>
        <tr class="line_process">
            <td class="val" colspan="1" style="padding: 8px;position: relative">
<!--                完工日期-->
                <input class="td_input easyui-datetimebox" id="completeDate" name="completeDate"
                       type="text">
            </td>
            <td class="val" colspan="1" style="padding: 8px">
<!--                工时-->
                <input class="td_input" name="planHours"
                       type="text" id="planHours">
            </td>
            <td class="val" colspan="1" style="padding: 8px">
<!--                关卡人工号-->
<!--                <input class="td_input easyui-textbox" name="userSn"  data-options="editable:false" type="text" id="userSn">-->
                <input class="td_input easyui-textbox" name="userSn" type="text" id="userSn">
                <input id="userSnId" type="hidden" value="">
            </td>
            <td class="val" colspan="1" style="padding: 8px">
<!--                关卡人签署-->
                <input class="td_input easyui-textbox userSn" name="userSign" type="text" id="userSign">
            </td>
            <td class="val" colspan="1" style="padding: 8px">
<!--                必检人工号-->
                <input class="td_input easyui-textbox" name="checkerSn" type="text" id="checkerSn">
                <input id="checkerSnId" type="hidden" value="">
            </td>
            <td class="val" colspan="1" style="padding: 8px">
<!--                必检人签署-->
                <input class="td_input easyui-textbox checkerSn" name="checkerSign" type="text" id="checkerSign">
            </td>
        </tr>
        <tr class="line_process">
            <td class="tdl">
                <div class="key">附件</div>
            </td>
            <td class="tdr" colspan="5" style="background: #fff">
                <div id="fileList"></div>

                <a class="searchBtn" data-options="iconCls:'icon-clear'" id="upload_button" onclick="open_upload()"
                   style="margin-right: 10px;float: right" type="button">
                    <span data-i18n="common:COMMON_OPERATION.UPLOAD"></span>
                </a>
            </td>
        </tr>

        </tbody>
    </table>
    <div id="buttom">
        <a href="javascript:" onclick="save_z()">保存</a>
        <a href="javascript:" onclick="addCC('add')">添加CC</a>
        <a href="javascript:" onclick="close_z()">关闭任务</a>
    </div>
    <!--    </form>-->

</div>

<div class="force_Dialog">
    <div class="lift_mask"></div>
    <div class="force_content">
        <div class="msgTips"></div>
        <div  class="msgTipsSub" style="text-align: center;margin-top: 20px">
            <a onclick="forceSubmin(1)" class="linkbutton" style="background-color: #ce3c3c">是</a>
            <a onclick="forceSubmin(2)" class="linkbutton" style="margin-left: 20px">否</a>
        </div>
    </div>
</div>


</body>
<script type="text/javascript">
    var param;
    let forceCode="";//存强制关闭的code码
    let ccId="";//cc的id号
    $(function(){
        //附件初始化
        reload_();
    });

    //工号人名下拉选择
    function fengzhuang(id,required) {
        $("#" + id).MyComboGrid({
            idField: 'ACCOUNT_NUMBER',  //实际选择值
            textField: 'ACCOUNT_NUMBER', //文本显示值
            panelHeight: '200px',
            required:  required != undefined ? required : true,
            width: "50%",
            params: {FunctionCode: 'FLOW_WORK_ACCOUNT'},
            columns: [[
                {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                {field: 'USER_NAME', title: '审核人', width: 50}
            ]],
            onHidePanel: function () {
                var t = $(this).combogrid('getValue');
                if (t != null && t != '' & t != undefined) {
                    if (selectRow == null || t != selectRow.ACCOUNT_NUMBER) {//没有选择或者选项不相等时清除内容
                        // alert('请选择系统已存在的工号!');
                        MsgAlert({type:"error",content:"请选择系统已存在的工号！"});
                        $(this).combogrid({value: ''});
                        $("#" + id).parents('td').siblings().children('.'+id).textbox('setValue',"");
                    }
                }else{
                    $("#" + id).parents('td').siblings().children('.'+id).textbox('setValue',"");
                }
            },
            onSelect: function (index, row) {
                selectRow = row;
                $("#" + id).parents('td').siblings().children('.'+id).textbox('setValue', row.USER_NAME);
                $("#" + id).siblings('.'+id).textbox('setValue', row.USER_NAME);
                $("#" + id).siblings('#'+id+'Id').val(row.ACCOUNT_ID);
            }
        });

    }

    /*添加 编辑CC*/
    function addCC(operation, id){
        /*TODO*/
        var title_ = $.i18n.t('添加CC');
        var curWidth = ($(window).width() * 1).toString();
        var curheight = ($(window).height() * 0.85).toString();
        var ccDocType = 11;

        let params = {
            operation: 'add',
            defect_info: {
                acId: param.acId || "",
                ac: param.acReg || "",
                id: "",
                ata:param.ata,
                station:param.station,
                flightNo:param.flightNo || "",
                flightId: param.flightId || "",
                descChn:$('#taskDes').text(),
                // descEn:$("#descEn").val(),
                rectFinishChn:$('#descChn').val(),
                rectFinishEn:$('#descEn').val(),

            },
            docNo: param.cardNumber,
            //{1: 'TLB', 2: 'NRC', 3: 'CC', 4: 'EO', 5: 'JC', 6: 'Defect', 7: 'PCO', 8: 'NRCT', 9: 'TO', 10: 'DDREVIEW', 11: 'CCO'}
            docType: 11
        };

            params.defect_info.workorderId=param.id;

        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: title_,
            param: params,
            url: "/views/defect/new_addcc.shtml"
        });

    }

    //根据工单ID获取部件拆换数据
    function queryCCTable(){
        let id ="";
        if(param.fixedType){
            id=param.id;
        }
        $.ajax({
            type: "GET",
            url: "/api/v1/compCc/selectByDocTypeAndDocNo/11/" + param.cardNumber,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                $(".partChildren").remove();
                let ccoCompCCS=data.data;
                //使用模拟数据
                // ccoCompCCS = mokeData;
                for(let i in ccoCompCCS){
                    addCCRow(ccoCompCCS[i],i);
                }
            },
            error: function () {
                window.alert("失败！");
            }
        });
    }

    //部件拆换行
    function addCCRow(item,index){
        let html = `<tr class="partLine partChildren">
        <td colspan="6" style=";background: #fff">
        <div class="partStyle val" style="width:8%;white-space: nowrap;text-overflow: ellipsis;overflow: hidden;color: #f60;cursor: pointer" onclick="editCC('view', ${item.id})">${item.ccNo? item.ccNo: ""}</div>
        <div class="partStyle val" style="width:12%;white-space: nowrap;text-overflow: ellipsis;overflow: hidden;">${item.offName? item.offName: ""}</div>
        <div class="partStyle val" style="width:12%">${item.offPn? item.offPn: ""}</div>
        <div class="partStyle val" style="width:14%;">${item.offSn? item.offSn: ""}</div>
        <div class="partStyle val" style="width:12%;">${item.offPosition? item.offPosition: ""}</div>
        <div class="partStyle val" style="width:8%;">${item.onPn? item.onPn: ""}</div>
        <div class="partStyle val" style="width:8%;">${item.onSn? item.onSn: ""}</div>
        <div class="partStyle val" id="ccOperation_`+ index +`" style="width:20%;border-right: none">
        </div>
        </td>`;
        $('#partContent').after(html);
        let operationHtml_1 = `
           <a class="searchBtn" type="button" onclick="editCC('edit', ${item.id})" style="margin: 0 5px 0 5px">
                <span>EDIT</span>
           </a>
            <a class="clearBtn" type="button" onclick="deleteCC(${item.id})"  style="margin: 0 5px 0 5px">
                <span>DELETE</span>
            </a>
            <a class="ridoBtn" type="button" onclick="closeCC(${item.id})" style="margin: 0 5px 0 5px">
                <span>CLOSE</span>
            </a>`;
        let operationHtml_2 = `
            <a class="searchBtn" type="button" onclick="editCC('edit', ${item.id})" style="margin: 0 5px 0 5px">
                <span>EDIT</span>
           </a>`;
        //middle状态为O时（open），按钮都显示，middle为close,并且status为n时，编辑按钮显示，middl为C,status为y时，全部隐藏
        if(item.middleStatus == 'O'){
            $("#ccOperation_" + index).append(operationHtml_1);
        }
        if(item.middleStatus == 'C' && item.status == 'n'){
            $("#ccOperation_" + index).append(operationHtml_2);
        }
        if(item.middleStatus == 'C' && item.status == 'y'){
            //do nothing
        }

    }

    //编辑CC
    function editCC(operation,id){
        let title = "edit CCO定检 cc";
        let params = {
            operation: operation,
            defect_info: {
                acId: param.acId || "",
                ac: param.acReg || "",
                tlbId: "",
                id: id,
                flightNo:param.flightNo || "",
                flightId: param.flightId || "",
                workorderId:param.sonId,
                reasonChn:$("#descChn").val(),
                reasonEn:$("#descEn").val(),
                actionChn:$('#taskDes').text(),
                actionEn:$('#taskDes').text(),
            },
            successCallback: ()=>{
                MsgAlert({type: "info", content: "保存成功"})
            }
        }
        params.id = id;
        let url = "/views/defect/new_addcc.shtml";
        var curWidth = ($(window).width() * 1).toString();
        var curheight = $(window).height().toString();
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: title,
            param: params,
            url: url
        });
    }

    /*删除CC*/
    function deleteCC(id) {
        if (confirm("确定删除吗")) {
            $.ajax({
                type: "GET",
                url: "/api/v1/compCc/delete/" + id,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if(data.code==200){
                        MsgAlert({type: "success", content: "删除成功"});
                        queryCCTable()
                    }
                },
                error: function (err) {
                    MsgAlert({type: "error", content: "删除失败: " + err})
                }
            });
        }
    }

    //初始化
    function i18nCallBack() {
        param = getParentParam_().fixedType;
        // getParentParams(function(){
        //     queryCCTable();
        //         fengzhuang("userSn");
        //         if(isCheckerCanSign()){
        //             //rii rci 勾选一个或都勾选 必检人必填
        //             fengzhuang("checkerSn");
        //         }else{
        //             fengzhuang("checkerSn",false);
        //         }
        //
        // });
        getWorkData();
        initShow();
    }

    function reload_() {
        $("#fileList").empty();
        let sonId = param.id;
        var catType = 'feedback';
        // TODO 家宝让改成feedback
        // if (param.workType == 'NRC' || param.workType == 'CCO') {
        //     catType = 'NRC';
        // } else if (param.workType == 'NRCTASK' || param.workType == 'NRCT') {
        //     catType = 'NRCT';
        // }
        InitDataGrid(sonId, catType);
    }

    function InitDataGrid(pkid, category) {
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: pkid,
                CATEGORY: category,
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                //为0时提示没有上传附件，无法查看
                // if (jdata.data.length==0){
                //     MsgAlert({content: "请先上传附件", type: 'error'});
                //     return;
                // }
                for (var i = 0; i < jdata.data.length; i++) {
                    var trHTML = '<tr><td class="td5"><a target="_blank" onclick="downFile(' + jdata.data[i].PKID + ',' + jdata.data[i].PKID + ')">' + jdata.data[i].ORG_NAME + '</a></td><td class="td5"  ><input class="btn btn-primary" type="button"  value="删除" style="width: 50px;margin:5px;" onclick="deleteFile(' + jdata.data[i].PKID + ');return false;"/></td></tr>';
                    $("#fileList").append(trHTML);//在table最后面添加一行
                    // downFile(jdata.data[i].PKID,jdata.data[i].PKID);
                }
            }
        });
    }

    //附件删除
    function deleteFile(pkid) {
        if (!confirm("是否刪除"))
            return;
        InitFuncCodeRequest_({
            data: {pkid: pkid, FunctionCode: 'ATTACHMENT_DEL'},
            successCallBack: function (jdata) {
                if (jdata.code == 200) {
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    reload_()
                }
            }
        });
    }

    //附件上传按钮
    function open_upload() {
        var catType = 'feedback';
        let sonId = param.id;
        var title_ = $.i18n.t('common:COMMON_OPERATION.UPLOAD');
        let option = {
            cat: catType,//文件夹
            sourceId: sonId,//
            successCellBack: "",
            fialCellBack: "",
        };
        ShowWindowIframe({
            width: "1000",
            height: "700",
            title: title_,
            param: option,
            url: "/views/data_manager/dm/upload/attachment_add.shtml"
        });
    }

    //保存
    function save_z() {
        var postData = get_post_data();
        if(checkData(postData)){
            return false;
        };
            $.ajax({
                type: "POST",
                url: '/api/v1/flb/feedBack/tmpSaveNrcCC',
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify(
                    postData
                ),
                dataType: "json",
                success: function (data) {
                    if (data.code == 200) {
                       alert("保存成功");
                        window.close();
                    }
                },
                error: function () {
                    window.alert("失败！");
                }
            });
    };

    /*关闭任务*/
    function close_z() {
        var postData = get_post_data();
        //普通校验
        if(checkData(postData)){
            return false;
        };
        //上传附件校验
        if( ifFile()== true){
            return false;
        };
        postData.status = "COMPLETED";
        $.ajax({
            type: "POST",
            url: '/api/v1/flb/feedBack/completeCco',
            contentType: "application/json;charset=utf-8",
            data: JSON.stringify(
                postData
            ),
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    if (getParentParam_().fixedType) {
                        getParentParam_().OWindow.Refresh();
                    } else {
                        getParentParam_().OWindow.listreload_();
                    }
                    getParentParam_().OWindow.MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    window.close();
                } else {
                    if(data.msgData){
                        if(data.msgData[0] === null || data.msgData[0] == 'null'){
                            data.msgData[0] = '系统异常'
                        }
                    }
                    MsgAlert({content: data.msgData ? data.msgData[0] : data.msg, type: 'error'});
                }
            },
            error: function () {
                MsgAlert({content: "连接失败！", type: 'error'});
            }
        });
    };

    //校验逻辑
    function checkData(data) {
        var flag;
        var now = new Date();
        if($('#completeDate').datetimebox('getValue')==""){
            flag = true;
            alert("请选择完工时间");
        }else if(data.completeDate > now){
            flag = true;
            alert("完工时间不能大于当前时间");
        }else if(!!data.hours==false){
            flag = true;
            alert("请选择工时");
        }else if(!!data.mechanicSn==false){
            flag = true;
            alert("请选择关卡人工号");
        }else if(!!data.feedbackCh==false){
            flag = true;
            alert("请输入反馈信息（中文）");
        };
        if(isCheckerCanSign() && !!data.inspectorNo==false){
            flag = true;
            alert("请选择必检人工号");
        }
        return flag;
    };

    //上传附件校验
    function ifFile() {
        var flag;
        if($('#yes').is(':checked')== true&&$("#fileList").children().length==0){
            alert("附件反馈必须，请提交附件");
            flag = true;
        }
        return flag;
    };

    //提交数据
    function get_post_data() {
        let post_data = {};
        post_data = {
            id: param.id,
            cardId: param.cardId,
            //航站
            station: param.station,
            //重要标志，缺少IFSD!!!!!
            isRci: param.isRci,
            isRii: param.isRii,
            isDm: param.isDm,
            isSd: param.isSd,
            //关卡人ID
            finishId: $('#userSnId').val(),
            //关卡人姓名
            mechanicName: $('#userSign').textbox('getValue'),
            //关卡人工号
            mechanicSn: $("#userSn").textbox('getValue'),
            workType: param.workType,
            //完工日期
            completeDate: new Date($('#completeDate').datetimebox('getValue')),
            //反馈信息（中文）
            feedbackCh: $('#descChn').val(),
            //反馈信息（英文）
            feedbackEn: $('#descEn').val(),
            //必检人工号
            inspectorNo: $("#checkerSn").textbox('getValue'),
            //必检人名字
            inspector: $("#checkerSign").textbox('getValue'),
            //必检人id
            checkerId: $('#checkerSnId').val(),
            //工时
            hours: $.trim($("#planHours").val()),
            //不存在的数据!!!!
            // rectChn: $('#cs_zh').val(),
            // rectEn: $('#cs_eh').val(),
            // componentCC: ccId,
            // componentCCNum: ccNum,
        };
        return post_data
    };


    /*重要标识为RII,RCI时必检人，否则不能填*/
    function isCheckerCanSign(){
        if($('#rii').is(':checked') || $('#rci').is(':checked')){
            return true;
        }else{
            return false;
        }
    };

    function getParentParams(callback){
        // param = getParentParam_().fixedType;
        var itemNo,isRii,isRci,isSd,isCmr,isAli,isCdccl,isCpcp,isEwis,isFts,isRsc,isSsi,isImportantModification,workType,cardNumber,workStatus,status,description,id,isDm,isFeedbackAttachment;
        itemNo=param.itemNo;
        workType=param.workType;
        cardNumber=param.cardNumber;
        workStatus=param.workStatus;
        status=param.status;
        description=param.description;
        isRii = isRii1;
        isRci = isRci1;
        isDm = isDm1;
        isCmr = isCmr1;
        isAli = isAli1;
        isCdccl = isCdccl1;
        isCpcp = isCpcp1;
        isEwis = isEwis1;
        isFts = isFts1;
        isRsc = isRsc1;
        isSsi = isSsi1;
        isSd = isSd1;
        isImportantModification = param.isImportantModification;
        id=param.id;
        // isFeedbackAttachment = param.isFeedbackAttachment;
        $('#itemNo').text(itemNo);
        $('#workType').text(workType);
        $('#cardNumber').text(cardNumber);
        // 缺少重要标志
        if(isRii == "X") {
            $('#rii').prop('checked',true);
            $('.rii').show().css("display","inline-block");
        }

        if(isRci == "X"){
            $('#rci').prop('checked',true);
            $('.rci').show().css("display","inline-block");
        }

        if(isSd == "X") {
            $('#ifsd').prop('checked',true);
            $('.ifsd').show().css("display","inline-block");
        };

        if(isDm == "X") {
            $('#dm').prop('checked',true);
            $('.dm').show().css("display","inline-block");
        }

        if(isCmr == "X") {
            $('#cmr').prop('checked',true);
            $('.cmr').show().css("display","inline-block");
        }

        if(isAli == "X") {
            $('#ali').prop('checked',true);
            $('.ali').show().css("display","inline-block");
        };

        if(isCdccl == "X") {
            $('#cdccl').prop('checked',true);
            $('.cdccl').show().css("display","inline-block");
        };

        if(isCpcp == "X") {
            $('#cpcp').prop('checked',true);
            $('.cpcp').show().css("display","inline-block");
        };

        if(isEwis == "X") {
            $('#ewis').prop('checked',true);
            $('.ewis').show().css("display","inline-block");
        };

        if(isFts == "X") {
            $('#fts').prop('checked',true);
            $('.fts').show().css("display","inline-block");
        };

        if(isRsc == "X") {
            $('#rsc').prop('checked',true);
            $('.rsc').show().css("display","inline-block");
        };

        if(isSsi == "X") {
            $('#ssi').prop('checked',true);
            $('.ssi').show().css("display","inline-block");
        };

        if(isImportantModification == "X") {
            $('#importantModification').prop('checked',true);
            $('.importantModification').show().css("display","inline-block");
        };

        //需反馈附件单选,缺少反馈附件信息
        // if(true){
        // if(param.isFeedbackAttachment=='X'){
        //     $("#yes").prop("checked",'checked');
        // }else {
        //     $("#no").prop("checked",'checked');
        // };
        $('#workStatus').text(status);
        //任务描述
        $('#taskDes').text(description || '');
        $('#ccoId').text(id);
        if(param){
            /*获取完数据后请求cc列表*/
            callback();
        }
    };

    //重要标志
    var isSd1,isCmr1,isAli1,isCdccl1,isCpcp1,isEwis1,isFts1,isRsc1,isSsi1,isImportantModification1,isRii1, isRci1,isDm1;

    //    获取工单信息并显示start
    function getWorkData(){
        $.ajax({
            type: "GET",
            url: "/api/v1/workOrder/getWorkOrder/"+ param.id,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                console.log("工单查询获取的数据: " + JSON.stringify(data));
                var WorkOrderData = data.data;
                if(!!WorkOrderData){
                    isImportantModification1 = WorkOrderData.isImportantModification;
                    isCmr1 = WorkOrderData.isCmr;
                    isAli1 = WorkOrderData.isAli;
                    isCdccl1 = WorkOrderData.isCdccl;
                    isCpcp1 = WorkOrderData.isCpcp;
                    isDm1 = WorkOrderData.isDm;
                    isEwis1 = WorkOrderData.isEwis;
                    isFts1 = WorkOrderData.isFts;
                    isSd1 = WorkOrderData.isSd;
                    isRci1 = WorkOrderData.isRci;
                    isRsc1 = WorkOrderData.isRsc;
                    isSsi1 = WorkOrderData.isSsi;
                    isRii1 = WorkOrderData.isRii;
                    if(WorkOrderData.isFeedbackAttachment=='X'){
                        $("#yes").prop("checked",'checked');
                    }else {
                        $("#no").prop("checked",'checked');
                    };
                };
                getParentParams(function(){
                    queryCCTable();
                    fengzhuang("userSn");
                    if(isCheckerCanSign()){
                        //rii rci 勾选一个或都勾选 必检人必填
                        fengzhuang("checkerSn");
                    }else{
                        //选填
                        fengzhuang("checkerSn",false);
                    }

                });
            },
            error: function () {
                getParentParams(function(){
                    queryCCTable();
                    fengzhuang("userSn");
                    if(isCheckerCanSign()){
                        //rii rci 勾选一个或都勾选 必检人必填
                        fengzhuang("checkerSn");
                    }else{
                        //选填
                        fengzhuang("checkerSn",false);
                    }

                });
                alert("工单数据获取失败");
            }
        });

    }

//页面初始化展示
    function initShow() {
        $.ajax({
            type: "get",
            url: '/api/v1/flb/feedBack/tsNrcTaskCCComplete',
            contentType: "application/json;charset=utf-8",
            data: {Id: param.id},
            dataType: "json",
            success: function (jdata) {
                if(jdata.code==200){
                    if(jdata.hasOwnProperty("data")){
                        var hadData = jdata.data;
                        $('#userSign').textbox('setValue', hadData.mechanicName);
                        $('#userSn').textbox('setValue', hadData.mechanicSn);
                        $('#checkerSn').textbox('setValue', hadData.inspectorNo);
                        $('#checkerSign').textbox('setValue', hadData.inspector);
                        $('#planHours').val(jdata.data.hours);
                        $("#completeDate").textbox('setValue', formatterDate(new Date(hadData.completeDate)));
                        $('#descChn').val(hadData.feedbackCh);
                        $('#descEn').val(hadData.feedbackEn);
                    }

                }
            },
            error: function () {
                window.alert("失败！");
            }
        });
    };

    //日期转换器
    function formatterDate (date) {
        var day = date.getDate() > 9 ? date.getDate() : "0" + date.getDate();
        var month = (date.getMonth() + 1) > 9 ? (date.getMonth() + 1) : "0"
            + (date.getMonth() + 1);
        var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
        var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
        var second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
        return date.getFullYear() + '-' + month + '-' + day+ ' '+hour+':'+minute+':'+second;
    };

    /*重要标识为RII,RCI时必检人，否则不能填*/
    function isCheckerCanSign(){
        if($('#rii').is(':checked') || $('#rci').is(':checked')){
            return true;
        }else{
            return false;
        }
    };




//    模拟数据
//     var mokeData = {
//         isSd:"X",
//         isCmr:"X",
//         isAli:"X",
//         isCdccl:"X",
//         isCpcp:"X",
//         isEwis:"X",
//         isFts:"X",
//         isRsc:"X",
//         isSsi:"X",
//         isSsi:"X",
//         isImportantModification:"X",
//         isRci:"X",
//         isDm:"X",
//     };
</script>

</html>