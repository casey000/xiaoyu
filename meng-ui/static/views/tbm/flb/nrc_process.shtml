<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head id="i18n_">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->

    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/css/nrc/addcc_close_dialog.css" rel="stylesheet">
    <style>
        #process {
            width: 100%;
            height: 99%;
            margin-bottom: 20px;

        }

        #process #fixedTableInfo{
            display: none;
        }

        #process_table, #fixedTableInfo{
            background: #fff;
            width: 100%;
            height: 100%;
            /*table-layout: fixed;*/
            border-width: 1px;
            display: table;
            border-collapse: collapse;
        }

        #process_table td{
            height: 25px;
            line-height: 25px !important;
            background: rgb(245, 245, 246);
            border: 0.5px solid #ccc;
            word-break: break-all;
            width: 16.6666%;
            padding: 0;
        }
        #fixedTableInfo td{
            height: 25px;
            line-height: 25px !important;
            background: rgb(245, 245, 246);
            border: 0.5px solid #ccc;
            word-break: break-all;
            padding: 8px;
        }

        #process_table td .key {
            text-align: right;
            padding: 8px;
            font-size: 13px;
        }

        .td_input {
            width: 95%;
        }

        tr.tlb {
            display: none;
        }

        /*tr.tlb input{*/
        /*    display: inline-block;*/
        /*}*/
        #process_table .val {
            background-color: #ffffff;
        }

        #process_table td textarea {
            width: 98%;
            height: 100px;
            display: inline-block;
            margin: 5px 0 5px 5px;
        }

        #buttom a {
            display: inline-block;
            cursor: pointer;
            background: #2465a8;
            color: #fff;
            border-radius: 4px;
            padding: 5px 20px;
            border: none;
            font-size: 14px;
            margin-right: 12px;
        }

        #buttom {
            text-align: right;
            margin-top: 10px;
        }

        .ccconfig {
            margin-left: 5px;
            color: sandybrown;
        }

        .ccconfig span {
            margin-left: 5px;
            color: sandybrown;
        }

        #troubleShootingHtml {

        }

        #troubleShootingHtml td {
            width: auto;

            text-align: center;
            border-bottom: none;
        }

        .td-line30-center {
            height: 25px;
            text-align: center;
            vertical-align: middle;
            /*width: auto !important;*/
        }

        #process_table .td-line30-center txtarea {
            height: auto !important;
        }

        #trouble_shooting_table {
            table-layout: fixed;

            border: none;
            border-collapse: collapse;
        }

        th, td {
            text-align: center;
            padding: 0;
            margin: 0;
        }

        #attachmengtList tr td {
            width: 200px !important;
        }
        .line_process{
            display: none;
        }
        .fixed_process{
            display: none;
        }
        /*#ccTable th, td{*/
        /*    text-align: center;*/
        /*    padding: 0;*/
        /*    margin: 0;*/
        /*    height: 40px;*/
        /*}*/
        #ccTable .cell-normal {
            height: 40px;
        }

        #fixedTableInfo .fixedLine{
            /*width:8% ;*/
        }

        #fixedTableInfo .fixed_id_list td{
            background: #fff;
        }

    </style>
</head>
<body>
<div id="process">
    <!--    <form id="ffSearch" class="form-horizontal">-->

    <table id="process_table">
        <tbody>
        <tr class="line_process">
            <td>
                <div class="key">飞机号:</div>
            </td>
            <td class="val"><span id="acReg" name="acReg"></span></td>
            <td>
                <div class="key">航班号:</div>
            </td>
            <td class="val" id="flightNo"></td>
            <td>
                <div class="key">航班日:</div>
            </td>
            <td class="val" id="flyDte"></td>
        </tr>
        <tr class="line_process">
            <td>
                <div class="key">航站:</div>
            </td>
            <td class="val" id="flyStation"></td>
            <td>
                <div class="key">航班类型:</div>
            </td>
            <td class="val" colspan="3" id="flyType"></td>
        </tr>
        <tr>
            <td>
                <div class="key">任务类型:</div>
            </td>
            <td class="val" id="taskType"></td>
            <td>
                <div class="key">执行文件号:</div>
            </td>
            <td class="val" id="docNo"></td>
            <td class="line_process">
                <div class="key">任务状态:</div>
            </td>
            <td class="val line_process" id="workStatus"></td>
            <td class="fixed_process">
                <div class="key">项次号:</div>
            </td>
            <td class="val fixed_process" id="xiangci"></td>
        </tr>
        <tr>
            <td>
                <div class="key">任务描述:</div>
            </td>
            <td class="val" colspan="5" id="taskDes"></td>

        </tr>
        <tr>
            <td>
                <div class="key">工作者账号:<span style="color: red">*</span></div>
            </td>
            <td class="val" style="position: relative">
                <input class="easyui-textbox" data-options="editable:true" id="wkCount" name="wkCount"
                       style="width: 98%"/>
                <input id="wkId" type="hidden" value="">
            </td>
            <td>
                <div class="key">工作者姓名:<span style="color: red">*</span></div>
            </td>
            <td class="val"><input class="td_input easyui-textbox wkName" data-options="editable:false" id="wkName"
                                   name="wkName" style="width:50%"
                                   type="text"></td>
            <td>
                <div class="key">完工时间:<span style="color: red">*</span></div>
            </td>
            <td class="val"><input class="td_input easyui-datetimebox" data-options="required:true"
                                   validType="timeLimit"
                                   id="cltTime" style="width: 70%" type="text" value="">
            </td>

        </tr>
        <tr>
            <td>
                <div class="key">人工时:<span style="color: red">*</span></div>
            </td>
            <td class="val"><input class="td_input easyui-textbox" id="rgHours" style="width: 50%;" type="text"
                                   validType="IntDeminumber"></td>
            <td>
                <div class="key">DM:<span style="color: red">*</span></div>
            </td>
            <td class="val" style="padding:0 10px;">
                <input id="DM_no" name="dm" type="radio" value="0"><label for="DM_no">否</label>
                <input id="DM_yes" name="dm" type="radio" value="1"><label for="DM_yes">是</label>
            </td>
            <td class="isrcirii" style="position: relative">

<!--                <div class="key"><label for="mtSign">必检:</label><input id="mtSign" name="checkWay" type="radio"-->
<!--                                                                       value="1"></div>-->
<!--                <div class="key"><label for="ehSign">互检:</label><input id="ehSign" name="checkWay" type="radio"-->
<!--                                                                       value="2"></div>-->
                <div class="key"><label for="mtSign">必检:</label><input id="mtSign" name="checkWay" type="checkbox"
                                                                       value="1"></div>
                <div class="key"><label for="ehSign">互检:</label><input id="ehSign" name="checkWay" type="checkbox"
                                                                       value="2"></div>
            </td>

            <td class="val isrcirii" id="bijian" style="position: relative;">
                <div class="">必检/互检签名</div>
                <input class="td_input easyui-textbox" id="checkWayNum" name="station" style="width: 58%" type="text">
                <input id="checkId" type="hidden" value="">
                <input class="td_input easyui-textbox wkName" id="checkWayName" name="station" style="width: 50%"
                       type="text">
            </td>
        </tr>
        <tr class="plan-time">
            <td>
                <div class="key">计划工时:</div>
            </td>
            <td class="val" id="planeHours"></td>
        </tr>
        <tr>
            <td>
                <div class="key">处理措施(中文):<span style="color: red">*</span></div>
            </td>
            <td class="val" colspan="5"><textarea id="cs_zh" name="cs_zh"></textarea></td>

        </tr>
        <tr>
            <td>
                <div class="key">处理措施(英文):<span style="color: red">*</span></div>
            </td>
            <td class="val" colspan="5"><textarea id="cs_eh" name="cs_eh"></textarea></td>
        </tr>

        <tr>
            <td>
                <div class="key">反馈信息:</div>
            </td>
            <td class="val" colspan="5" style="width: auto;"><textarea id="zfeedback" maxLength="300"
                                                                       name="zfeedback"></textarea></td>

        </tr>
        <tr>
            <td class="tdl">
                <div class="key">附件:</div>
            </td>
            <td class="tdr" colspan="5" style="background: #fff">
                <div id="attachmengtList"></div>

                <a class="searchBtn" data-options="iconCls:'icon-clear'" id="upload_button" onclick="open_upload()"
                   style="margin-right: 10px;float: right" type="button">
                    <span data-i18n="common:COMMON_OPERATION.UPLOAD"></span>
                </a>
            </td>
        </tr>
        <tr>
            <td>
                <div class="key">无照片备注:</div>
            </td>
            <td class="val" colspan="5">
                <textarea id="withoutPic" name="withoutPic"></textarea>
            </td>

        </tr>
        <tr>
            <td width="100px">
                <div class="key">部件拆换:</div>
            </td>
            <td class="val ccconfig" colspan="5" style="width: auto;"></td>
        </tr>
        </tbody>
    </table>
    <table class="table table-bordered table-info " id="ccTable" width="100%" >
        <tr>
            <th class="table-cell cell-normal required" rowspan="99">录入CC</th>
            <th class="table-cell cell-normal" colspan="7"></th>
            <th class="table-cell cell-normal">
                <a class="addBtn" onClick="addCC()" type="button" style="margin: 0 10px 0 10px;">addCC</a>
            </th>
            <td class="table-cell cell-normal"></td>
        </tr>
        <tr>
            <td class="table-cell cell-normal" >NO.</td>
            <td class="table-cell cell-normal" >Type</td>
            <td class="table-cell cell-normal" >P/N OFF</td>
            <td class="table-cell cell-normal" >S/N OFF</td>
            <td class="table-cell cell-normal" >P/N ON</td>
            <td class="table-cell cell-normal" >S/N ON</td>
            <td class="table-cell cell-normal">Status</td>
            <td class="table-cell cell-normal" >航材状态</td>
            <td class="table-cell cell-normal">Operation</td>
        </tr>
    </table>
    <table id="fixedTableInfo">
        <tr>
            <td colspan="15" style="color: rgb(50, 64, 75);font-weight: bold;font-family: 微软雅黑;">
                <span style="margin-left: 50px">修理补片信息</span>
                <input class="btn btn-primary" type="button"  value="增加" style="width: 50px;float: right" onclick="addOrEditFixed('add')">
            </td>

        </tr>
        <tr>
            <td>序号</td>
            <td>长</td>
            <td>宽</td>
            <td>厚度</td>
            <td>面积</td>
            <td>材料</td>
            <td>重量</td>
            <td>力矩变化</td>
            <td>内外部</td>
            <td colspan="2">备注</td>
            <td colspan="2">附件</td>
            <td colspan="2">操作</td>
        </tr>
    </table>

    <div id="buttom">
        <a href="javascript:" onclick="save_z()">暂存</a>
        <!--        <a href="javascript:;" onclick="addCC()">添加CC</a>-->
        <a href="javascript:" onclick="close_z()">关闭任务</a>
    </div>
    <!--    </form>-->

</div>

<div class="force_Dialog">
    <div class="lift_mask"></div>
    <div class="force_content">
        <div class="msgTips"></div>
        <div  class="msgTipsSub" style="text-align: center;margin-top: 20px">
            <a onclick="forceSubmin(1)" class="linkbutton" style="background-color: #ce3c3c">是</a>
            <a onclick="forceSubmin(2)" class="linkbutton" style="margin-left: 20px">否</a>
        </div>
    </div>
</div>
</body>
<script src="../../../js/datagrid_utils.js" type="text/javascript"></script>
<script src="/js/compccClose.js" type="text/javascript"></script>
<script type="text/javascript">
    let forceCode="";//存强制关闭的code码
    let ccId="";//cc的id号
    var proRii="",proRci="";
    var param = getParentParam_();
    var operation, acReg, acId, flightNo, flightId, departure, arrival, station, flyDte, description, workStatus,
        workType, cardNumber, isRii, isRci, orderId, sonId, itemNo,planeHours, cardId,mroCompany;
    if(param.fixedType){
        operation = param.fixedType.operation;
        acReg = param.fixedType.acReg;
        acId = param.fixedType.acId;
        flightNo = param.fixedType.flightNo;
        flightId = param.fixedType.flightId;
        departure = param.fixedType.station;
        arrival = param.fixedType.station;
        station = param.fixedType.station;
        // flyDte = param.fixedType.completeDate;
        flyDte = param.fixedType.jobDate;
        description = param.fixedType.description;
        workStatus = param.fixedType.status;
        workType = param.fixedType.workType;
        cardNumber = param.fixedType.cardNumber;
        planeHours = param.fixedType.planeHours||"";
        isRii = param.fixedType.isRii;
        proRii = param.fixedType.isRii;
        isRci = param.fixedType.isRci;
        proRci = param.fixedType.isRci;
        orderId = param.fixedType.orderId;
        sonId = param.fixedType.id;
        itemNo = param.fixedType.itemNo;
        cardId = param.fixedType.cardId;
        mroCompany = param.fixedType.mroCompany;
        $('.line_process').hide();
        $('.fixed_process').show();
    }else{
        $('.line_process').show();
        $('.fixed_process').hide();
        operation = param.operation;
        acReg = param.acReg;
        acId = param.acId;
        flightNo = param.flightNo;
        flightId = param.flightId;
        departure = param.departure;
        arrival = param.arrival;
        station = param.station;
        flyDte = param.nt_crDate;
        description = param.description;
        workStatus = param.statusCn;
        workType = param.workType;
        cardNumber = param.cardNumber;
        planeHours = param.planeHours||"";
        isRii = param.isRii;
        proRii = param.isRii;
        isRci = param.isRci;
        proRci = param.isRci;
        orderId = param.orderId;
        sonId = param.sonId;
        cardId = param.cardId;
    }

    console.log(param, 'this is param');

    function i18nCallBack() {
        if(workType != 'CCO' && !param.fixedType){
            if(isRii && isRci){
                $("#mtSign").prop("checked", "checked");
                $('#bijian').css({'visibility': 'visible'});
            }
            if(isRii && !isRci){
                $("#mtSign").prop("checked", "checked");
                $('#bijian').css({'visibility': 'visible'});

            }
            if(isRci && !isRii){
                $("#ehSign").prop("checked", "checked");
                $('#bijian').css({'visibility': 'visible'});

            }
            if(!isRci && !isRii){
                $("#ehSign").prop("checked", "checked");
                $('#bijian').css({'visibility': 'visible'});

            }
            if(isRci || isRii){
                $('.block').css('display','block')
            }
        }
        // if(workType == 'NRC' && param.fixedType) {
        //     //如果互检必检都有（理论上不存在）
        //     if(isRii && isRci){
        //         $("#mtSign").prop("checked", "checked");
        //         $('#bijian').css({'visibility': 'visible'});
        //     }
        //     //有必检无互检
        //     if(isRii && !isRci){
        //         $("#mtSign").prop("checked", "checked");
        //         $('#bijian').css({'visibility': 'visible'});
        //
        //     }
        //     //有互检无必检
        //     if(isRci && !isRii){
        //         $("#ehSign").prop("checked", "checked");
        //         $('#bijian').css({'visibility': 'visible'});
        //
        //     }
        //     //都没有
        //     if(!isRci && !isRii){
        //         $('.isrcirii').css('display','none');
        //     }
        //     // 只有一个，但是.block已经没有了
        //     if(isRci || isRii){
        //         $('.block').css('display','block')
        //     }
        // }
        // if(workType == 'NRCT' && param.fixedType) {
        //     if(isRii && isRci){
        //         $("#mtSign").prop("checked", "checked");
        //         $('#bijian').css({'visibility': 'visible'});
        //     }
        //     if(isRii && !isRci){
        //         $("#mtSign").prop("checked", "checked");
        //         $('#bijian').css({'visibility': 'visible'});
        //
        //     }
        //     if(isRci && !isRii){
        //         $("#ehSign").prop("checked", "checked");
        //         $('#bijian').css({'visibility': 'visible'});
        //
        //     }
        //     if(!isRci && !isRii){
        //         $('.isrcirii').css('display','none');
        //     }
        //     if(isRci || isRii){
        //         $('.block').css('display','block')
        //     }
        //
        // }
        //下面的接口测试环境下有出现调调通没数据的情况，原因是取的缓存数据，故做两相同的逻辑
        if(workType == 'NRC' ) {
            setCheckButton();
        }else if(workType == 'NRCT'){
            setCheckButtonTwo();
        }
        $.ajax({
            type: "get",
            url: '/api/v1/flb/feedBack/tsNrcTaskCCComplete',
            contentType: "application/json;charset=utf-8",
            data: {Id: sonId},
            dataType: "json",
            success: function (jdata) {
                if (jdata.code == 200) {


                    var cacheData = jdata.data;
                    reload_();
                    if(cacheData) {
                        $('#wkCount').textbox('setValue', cacheData.mechanicSn);
                        $('#wkName').textbox('setValue', cacheData.mechanicName);
                        $('#zfeedback').val(cacheData.feedbackCh);
                        $("#cltTime").textbox('setValue', formatterDate(new Date(cacheData.completeDate)));
                        $("#rgHours").textbox('setValue', cacheData.hours);
                        $('#cs_zh').val(cacheData.rectChn);
                        $('#cs_eh').val(cacheData.rectEn);
                        $('#checkId').val(cacheData.checkerId);
                        $('#wkId').val(cacheData.finishId);
                        $("#checkWayNum").textbox('setValue', cacheData.inspectorNo);
                        $("#checkWayName").textbox('setValue', cacheData.inspector);
                        $("#withoutPic").val(cacheData.mechanicNoPhotoRemark);
                        // $("input[name='checkWay'][value='" + showData.isRii + "']").prop("checked", "checked");
                        if(cacheData.isRii == '1') {
                            $("#mtSign").prop("checked", "checked");
                        }
                        if(cacheData.isRci == '1') {
                            $("#ehSign").prop("checked", "checked");
                        }
                        if(cacheData.isRii == '1' || cacheData.isRci == '1') {
                            $('#bijian').css({'visibility': 'visible'});
                        }
                        //问题:这个接口取缓存的数据，可能会出现从前页带进来的和接口返回来的数据不一致，如果正常进入以点击带进来的优先
                        isRii = cacheData.isRii == "1"?"X":"";
                        isRci = cacheData.isRci == "1"?"X":"";
                        if(cacheData.workType == 'NRC' ) {
                            setCheckButton();
                        }else if(cacheData.workType == 'NRCT'){
                            setCheckButtonTwo();
                        }
                        $(":radio[name='dm'][value='" + cacheData.isDm + "']").prop("checked", "checked");
                        if(cacheData.componentCCNum != '' && cacheData.componentCCNum) {
                            var ccArr = [];
                            ccArr = cacheData.componentCCNum.split(',');
                            for (let i = 0; i < ccArr.length; i++) {
                                var html = '';
                                html = `<span>CC：<span class="ccNum">${ccArr[i]}</span></span>`;
                                // $('.ccconfig').append(html)
                            }
                        }
                        if(cacheData.componentCC != '' && cacheData.componentCC) {
                            var ccArr = [];
                            ccArr = cacheData.componentCC.split(',');
                            for (let i = 0; i < ccArr.length; i++) {
                                var html = '';
                                html = `<input type="hidden" class="ccId" value="${ccArr[i]}">`;
                                // $('.ccconfig').append(html)
                            }
                        }
                    }
                }
                queryCCTable();
                //

            },
            error: function () {
                window.alert("失败！");
            }
        });

    }

    function reload_() {
        $("#attachmengtList").empty();
        var catType = 'feedback';
        // TODO 家宝让改成feedback
        // if (param.workType == 'NRC' || param.workType == 'CCO') {
        //     catType = 'NRC';
        // } else if (param.workType == 'NRCTASK' || param.workType == 'NRCT') {
        //     catType = 'NRCT';
        // }
        InitDataGrid(sonId, catType)
    }

    function InitDataGrid(pkid, category) {
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: pkid,
                CATEGORY: category,
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jdata) {
                //为0时提示没有上传附件，无法查看
                // if (jdata.data.length==0){
                //     MsgAlert({content: "请先上传附件", type: 'error'});
                //     return;
                // }
                for (var i = 0; i < jdata.data.length; i++) {
                    var trHTML = '<tr><input class="uploadId" value="'+ jdata.data[i].PKID +'" type="hidden"><td class="td5"><a target="_blank" onclick="downFile(' + jdata.data[i].PKID + ',' + jdata.data[i].PKID + ')">' + jdata.data[i].ORG_NAME + '</a></td><td class="td5"  ><input class="btn btn-primary" type="button"  value="删除" style="width: 50px;margin:5px;" onclick="deleteFile(' + jdata.data[i].PKID + ');return false;"/></td></tr>';
                    $("#attachmengtList").append(trHTML);//在table最后面添加一行
                    // downFile(jdata.data[i].PKID,jdata.data[i].PKID);
                }
            }
        });
    }
    /**
     *
     */
    $(function () {

        $('input[name="tlb"]').click(function () {
            // alert($(this).val());
            if ($(this).val() == '1') {
                $('.tlb').show();
                $('.td_input').textbox({})
            } else {
                $('.tlb').hide();
                $("#EWIS").EWIS("destroy");
                $("#oilSpill").oilSpill("destroy");
            }
        });
        $('#acReg').text(acReg);
        $('#flightNo').text(flightNo);
        $('#flyDte').text(flyDte);
        $('#flyStation').text(station);
        $('#taskDes').text(description || '');
        $('#workStatus').text(workStatus);
        $('#taskType').text(workType);
        $('#flyType').text(operation);
        $('#docNo').text(cardNumber);
        $('#planeHours').text(planeHours);
        $('#xiangci').text(itemNo);
        if(workType == "NRCT"){
            $(".plan-time").hide();
        };

        if(mroCompany){
            $("#cs_zh").val(acReg + "客改期间由" + mroCompany + "开卡并执行。");
            $("#cs_eh").val(acReg + "客改期间由" + mroCompany + "开卡并执行。");
        }
        fengzhuang("wkCount");
        fengzhuang('checkWayNum');

        function fengzhuang(id) {
            $("#" + id).MyComboGrid({
                idField: 'ACCOUNT_NUMBER',  //实际选择值
                textField: 'ACCOUNT_NUMBER', //文本显示值
                panelHeight: '200px',
                required: true,
                width: "50%",
                params: {FunctionCode: 'FLOW_WORK_ACCOUNT'},
                columns: [[
                    {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                    {field: 'USER_NAME', title: '审核人', width: 50}
                ]],
                onHidePanel: function () {
                    var t = $(this).combogrid('getValue');
                    if (t != null && t != '' & t != undefined) {
                        if (selectRow == null || t != selectRow.ACCOUNT_NUMBER) {//没有选择或者选项不相等时清除内容
                            alert('请选择，不要直接输入！');
                            $(this).combogrid({value: ''});
                        }
                    }
                },
                onSelect: function (index, row) {
                    selectRow = row;
                    $("#" + id).parents('td').siblings().children('.wkName').textbox('setValue', row.USER_NAME);
                    $("#" + id).siblings('.wkName').textbox('setValue', row.USER_NAME);
                    $("#" + id).siblings('#wkId').val(row.ACCOUNT_ID);
                    $("#" + id).siblings('#checkId').val(row.ACCOUNT_ID);
                }
            });

        }

        $('input[name="checkWay"]').bind('click', function () {
            $('input[name="checkWay"]').not(this).attr("checked", false);
            var zjWay = $('input[name="checkWay"]:checked').val();
            if (zjWay !== null && zjWay !== undefined) {
                $('#bijian').css({'visibility': 'visible'});
            } else {
                $('#bijian').css({'visibility': 'hidden'});
                $("#checkWayNum").textbox('setValue', '');
                $("#checkWayName").textbox('setValue', '');
            }
        });

        //来源为老龄系统的展示修理补片信息
        sourceFromByPost(function () {
            $("#fixedTableInfo").show();
            //获取补片信息
            queryFixedTable();
        });

    });

    //判断nrc来源是否是老龄ASMS
    function sourceFromByPost(callback){
        $.ajax({
            type: "GET",
            url: "/api/v1/tbm/nrc/nrcPhysicalInfo/findNrcSourceFrom/" + cardId,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    if(data.data == "ASMS"){
                        callback();
                    }
                }
            },
            error: function () {
                window.alert("失败！");
            }
        });
    }

    function get_post_data() {
        let post_data = {};
        let isHasOil = $("input[name='oilSpill']:checked").val();
        let isHasEwis = $("input[name='EWIS']:checked").val();
        let ewis = $("#EWIS").EWIS("getData");
        let oilSpill = $("#oilSpill").oilSpill("getData");
        let ccNum = '';
        let ccId = '';
        let rii = $("input[id ='mtSign']:checked").val() ? '1' : '0';   //必检
        let rci = $("input[id ='ehSign']:checked").val() ? '1' : '0';   //互检
        if(workType=="NRC" ){
                if(!!proRii){
                    //RII选中的时候 必检为必填项；RCI选中的时候 互检为必填项
                    if(rii =='0'){
                        MsgAlert({content: '创建任务时RII已选中 必检为必填项', type: 'error'});
                        return false;
                    }
                };
                if(!!proRci){
                    //RII选中的时候 必检为必填项；RCI选中的时候 互检为必填项
                    if(rci =='0' && rii =='0'){
                        MsgAlert({content: '创建任务时RCI已选中 互检、必检请至少选一项', type: 'error'});
                        return false;
                    }
                }
        };
        // if( workType=="NRC" || workType=="CCO"){
        //     if(isRii){
        //         //RII选中的时候 必检为必填项；RCI选中的时候 互检为必填项
        //         if(rii =='0'){
        //             MsgAlert({content: '创建任务时RII已选中 必检为必填项', type: 'error'});
        //             return false;
        //         }
        //
        //     }
        //     if(isRci){
        //         //RII选中的时候 必检为必填项；RCI选中的时候 互检为必填项
        //         if(rci =='0'){
        //             MsgAlert({content: '创建任务时RCI已选中 互检为必填项', type: 'error'});
        //             return false;
        //         }
        //
        //     }
        // }
        let wkType = workType == 'NRCT' ? 'NRCT' : 'NRC';
        if (rii != '0' || rci != '0') {
            if (!$("#checkWayNum").textbox('getValue')) {
                MsgAlert({content: '请填写必检互检签名', type: 'error'});
                return false;
            }
        }
        $.each($('.ccNum'), function (i, v) {
            if (ccNum != '') {
                ccNum += ',';
            }
            ccNum += $(this).text();
        });
        $.each($('.ccId'), function (i, v) {
            if (ccId != '') {
                ccId += ',';
            }
            ccId += $(this).val();
        });
        var now = new Date();
        var cltTime = new Date($('#cltTime').datetimebox('getValue'));
        if (cltTime > now) {
            MsgAlert({content: '完工时间不能大于当前时间', type: 'error'});
            return false;
        }
        // if($('#wkCount').textbox('getValue') == $("#checkWayNum").textbox('getValue')){
        //     MsgAlert({content: '工作者和必互检人不能一致', type: 'error'});
        //     return false;
        // }
        let withoutPic = $("#withoutPic").val().trim();

        post_data = {
            id: sonId,
            cardId: cardId,
            mechanicSn: $('#wkCount').textbox('getValue'),
            mechanicName: $('#wkName').textbox('getValue'),
            finishId: $('#wkId').val(),
            completeDate: new Date($('#cltTime').datetimebox('getValue')),
            hours: $.trim($('#rgHours').textbox('getValue')),
            feedbackCh: $('#zfeedback').val(),
            componentCC: ccId,
            componentCCNum: ccNum,
            rectChn: $('#cs_zh').val(),
            rectEn: $('#cs_eh').val(),
            isDm: $("input[name='dm']:checked").val(),
            isRci: rci,
            isRii: rii,
            workType: wkType,
            station: station,
            inspectorNo: $("#checkWayNum").textbox('getValue'),
            inspector: $("#checkWayName").textbox('getValue'),
            checkerId: $('#checkId').val(),
            mechanicNoPhotoRemark:withoutPic,


        };
        return post_data
    }

    function save_z() {
        var postData = get_post_data();
        if (postData) {
            for (var key in postData) {
                if (!postData[key] && key != 'feedbackCh' && key != 'componentCC'&& key != 'componentCCNum' && key != 'isRci' && key != 'isRii' && key != 'inspectorNo' && key != 'inspector'&& key != 'checkerId'&& key != 'flightNo'&& key != 'station' && key != 'cardId'&& key != 'Id'&& key != 'mechanicNoPhotoRemark') {
                    console.log(key);
                    MsgAlert({content: '请填写必填项', type: 'error'});

                    return false;
                }
            }
            $.ajax({
                type: "POST",
                url: '/api/v1/flb/feedBack/tmpSaveNrcCC',
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify(
                    postData
                ),
                dataType: "json",
                success: function (data) {
                    if (data.code == 200) {
                        param.OWindow.MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        window.close();
                    }
                },
                error: function () {
                    window.alert("失败！");
                }
            });
        }
    }

    function close_z() {
        var postData = get_post_data();
        let uploadItem = $('.uploadId');
        if(uploadItem.length < 1){
            let withoutPic = $("#withoutPic").val().trim();
            if(!withoutPic){
                MsgAlert({type: "error", content: "无附件时，无照片备注必填"});
                return false;
            }
        }
        if (postData) {
            for (var key in postData) {
                if (!postData[key] && key != 'feedbackCh' && key != 'componentCC'&& key != 'componentCCNum' && key != 'isRci' && key != 'isRii' && key != 'inspectorNo' && key != 'inspector'&& key != 'checkerId' && key != 'flightNo'&& key != 'station'&& key != 'cardId'&& key != 'Id'&& key != 'mechanicNoPhotoRemark') {
                    console.log(key);
                    MsgAlert({content: '请填写必填项', type: 'error'});
                    return false;
                }
            }
            var url = '';
            if (workType == 'NRC') {
                url = '/api/v1/flb/feedBack/complete/NRC';
            } else if (workType == 'NRCT') {
                url = '/api/v1/flb/feedBack/complete/NRCT';
            } else if (workType == 'CCO') {
                url = '/api/v1/flb/feedBack/complete/CCO';
            }
            postData.status = "COMPLETED";

            $.ajax({
                type: "POST",
                url: url,
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify(
                    postData
                ),
                dataType: "json",
                success: function (data) {
                    if (data.code == 200) {
                        if (param.fixedType) {
                            param.OWindow.Refresh();
                        } else {
                            param.OWindow.listreload_();
                        }
                        param.OWindow.MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        window.close();
                    } else {
                        if(data.msgData){
                            if(data.msgData[0] === null || data.msgData[0] == 'null'){
                                data.msgData[0] = '系统异常'
                            }
                        }

                        MsgAlert({content: data.msgData ? data.msgData[0] : data.msg, type: 'error'});
                    }
                },
                error: function () {
                    MsgAlert({content: "连接失败！", type: 'error'});
                }
            });
        }
    }
    // 查询station的点击事件
    function addCC() {
        var title_ = $.i18n.t('添加CC');
        var curWidth = ($(window).width() * 1).toString();
        var curheight = ($(window).height() * 0.85).toString();

        var ccDocType = '';
        if (workType == 'NRC') {
            ccDocType = 2;
        } else if (workType == 'NRCT') {
            ccDocType = 8;
        } else if (workType == 'CCO') {
            ccDocType = 11;
        }

        let params = {
            operation: 'add',
            defect_info: {
                acId: acId || "",
                ac: acReg || "",
                tlbId: "",
                id: "",
                ata:param.ata,
                station:param.station,
                flightNo:flightNo || "",
                flightId: flightId || "",
                reasonChn:$("#gz_zh").val(),
                reasonEn:$("#gz_eh").val(),
                actionChn:$('#cs_zh').val(),
                actionEn:$('#taskDes').text(),
            },
            docNo: cardNumber,
            docType: ccDocType
        };
        if(param.fixedType){
            params.defect_info.workorderId=param.fixedType.id;
        }else {
            params.defect_info.workorderId=param.sonId;
        }
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: title_,
            param: params,
            url: "/views/defect/new_addcc.shtml"
        });
    }


    // function queryCCTable(data) {
    //     var html = '';
    //     html = `<span>CC：<span class="ccNum">${data.data.ccNo}</span><input class="ccId" type="hidden" value="${data.data.ccId}"> </span>`;
    //     $('.ccconfig').append(html)
    // }

    function ewis_y() {
        $("#EWIS").EWIS("create")
    }

    function ewis_n() {
        $("#EWIS").EWIS("destroy")
    }

    function os_y() {
        $("#oilSpill").oilSpill("create")
    }

    function os_n() {
        $("#oilSpill").oilSpill("destroy")
    }

    //底部上传按钮打开上传页面
    function open_upload() {
        var catType = 'feedback';
        // TODO 19/6/26 家宝让改成feedback
        // if (workType == 'NRC' || workType == 'CCO') {
        //     catType = 'NRC';
        // } else if (workType == 'NRCTASK' ||workType == 'NRCT') {
        //     catType = 'NRCT';
        // }

        var title_ = $.i18n.t('common:COMMON_OPERATION.UPLOAD');
        let param = {
            cat: catType,//文件夹
            sourceId: sonId,//
            successCellBack: "",
            fialCellBack: "",
            nrc_type: "nrc",
        };
        ShowWindowIframe({
            width: "1000",
            height: "700",
            title: title_,
            param: param,
            url: "/views/data_manager/dm/upload/attachment_add.shtml"
        });
    }

    function queryCCTable() {
        let id ="";
        if(param.fixedType){
            id=param.fixedType.id;
        }else {
            id=param.sonId;
        }
        $.ajax({
            type: "GET",
            url: "/api/v1/cc/findByWorkOrderId?workOrderId=" + id,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                $(".cc_id_list").remove();
                let tlbCompCCS=data.data.tlbCompCCS;
                for(let i in tlbCompCCS){
                    addCCRow(tlbCompCCS[i],i);
                }

            },
            error: function () {
                window.alert("失败！");
            }
        });

    }
    /**
     * 为cc列表添加一行
     * @param {[type]} row_data [description]
     */
    function addCCRow(row_data, index){
        let status = "";
        let opration;
        if(row_data.middleStatus == "O"){
            status = "OPEN";
            opration = `<td class="table-cell cell-normal" >
                <a class="searchBtn" type="button" onclick="ccid_eidt( ${row_data.id})" style="margin: 0 5px 0 5px">
                <span>EDIT</span>
                </a>
                <a class="clearBtn" type="button" onclick="deleteCC(${row_data.id})" style="margin: 0 5px 0 5px">
                <span>DELETE</span>
                </a>
                <a class="ridoBtn" type="button" onclick="closeCC(${row_data.id})" style="margin: 0 5px 0 5px">
                <span>CLOSE</span>
                </a>
                </td>`;
        }
        if(row_data.middleStatus == "C" && row_data.status == 'n'){
            status = "CLOSE";
            opration = `<td class="table-cell cell-normal" >
                            <a class="searchBtn" type="button" onclick="ccid_eidt( ${row_data.id})" style="margin: 0 5px 0 5px">
                                <span>EDIT</span>
                            </a>
                        </td>`;
        }
        if(row_data.middleStatus == "C" && row_data.status == 'y'){
            status = "CLOSE";
            opration='<td class="table-cell cell-normal" ></td>';
        }
        let html = `<tr name="ccRow" class="cc_id_list">
            <td class="table-cell cell-normal"><a style="color: #f60" onclick="ccid_view( ${row_data.id})">${row_data.ccNo || "view"+(index+1)}</a></td>
            <td class="table-cell cell-normal">${row_data.ccTypeStr? row_data.ccTypeStr: ""}</td>
            <td class="table-cell cell-normal">${row_data.offPn? row_data.offPn: ""}</td>
            <td class="table-cell cell-normal">${row_data.offSn? row_data.offSn: ""}</td>
            <td class="table-cell cell-normal">${row_data.onPn? row_data.onPn: ""}</td>
            <td class="table-cell cell-normal">${row_data.onSn? row_data.onSn: ""}</td>
            <td class="table-cell cell-normal">${status? status: ""}</td>
            <td class="table-cell cell-normal">${row_data.airMaterialState? row_data.airMaterialState: ""}</td>
            `+opration+`
        </tr>`;
        $("#ccTable").append($(html))
    }

    /**
     * 删除cc
     */
    function deleteCC(id){
        if (confirm("确定删除吗")) {
            $.ajax({
                type: "GET",
                url: "/api/v1/compCc/delete/" + id,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if(data.code==200){
                        MsgAlert({type: "success", content: "删除成功"});
                        queryCCTable()
                    }
                },
                error: function (err) {
                    MsgAlert({type: "error", content: "删除失败: " + err})
                }
            });
        }
    }

    function ccid_eidt(id) {
        let title = "edit TLB CC";
        let params = {
            operation: "edit",
            defect_info: {
                acId: acId || "",
                ac: acReg || "",
                tlbId: "",
                id: id,
                flightNo:flightNo || "",
                flightId: flightId || "",
                reasonChn:$("#gz_zh").val(),
                reasonEn:$("#gz_eh").val(),
                actionChn:$('#cs_zh').val(),
                actionEn:$('#cs_eh').val(),
                workorderId:sonId,
            },
            successCallback: ()=>{
            MsgAlert({type: "info", content: "保存成功"})
        }
    }
        params.id = id;


        let url = "/views/defect/new_addcc.shtml";
        var curWidth = ($(window).width() * 1).toString();
        var curheight = $(window).height().toString();
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: title,
            param: params,
            url: url
        });
    }

    function ccid_view(id) {
        let title = "View TLB CC";
        let param = {
            operation: "view",
            defect_info: {
                acId: acId || "",
                ac: acReg || "",
                tlbId: "",
                id: id,
                flightNo:flightNo || "",
                flightId: flightId || "",
                reasonChn:$("#gz_zh").val(),
                reasonEn:$("#gz_eh").val(),
                actionChn:$('#cs_zh').val(),
                actionEn:$('#cs_eh').val(),
            },
            successCallback: ()=>{
            MsgAlert({type: "info", content: "保存成功"})
        }
    }
        param.id = id;
        param.type ="see";

        let url = "/views/defect/new_addcc.shtml";

        var curWidth = ($(window).width() * 1).toString();
        var curheight = $(window).height().toString();
        ShowWindowIframe({
            width: curWidth,
            height: curheight,
            title: title,
            param: param,
            url: url
        });
    }
    /************************修理补片信息分割线****************************/
    //补片信息列表
    function queryFixedTable(){
        $.ajax({
            type: "GET",
            url: "/api/v1/tbm/nrc/nrcPhysicalInfo/queryNrcPhysicalInfoList/" + cardId,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                $(".fixed_id_list").remove();
                let tlbCompCCS=data.data;
                for(let i in tlbCompCCS){
                    addFixedRow(tlbCompCCS[i],i);
                }
            },
            error: function () {
                MsgAlert({type: "error", content: "获取补片列表信息失败！"})
            }
        });
    }

    function addFixedRow(row_data, index){
        let opration = `<td colspan="2" class="table-cell cell-normal" >
                <a class="searchBtn" type="button" onclick="addOrEditFixed('edit',${row_data.id})" style="margin: 0 5px 0 5px">
                <span>EDIT</span>
                </a>
                <a class="clearBtn" type="button" onclick="deleteFixed(${row_data.id})" style="margin: 0 5px 0 5px">
                <span>DELETE</span>
                </a>
                </td>`;
        let fileHtml =`<td colspan="2" id="file_`+index+`"></td>`;
        let html = `<tr class="fixed_id_list">
            <td>${row_data.no || (parseInt(index)+1)}</td>
            <td>${row_data.length? row_data.length: ""}</td>
            <td>${row_data.wide? row_data.wide: ""}</td>
            <td>${row_data.thickness? row_data.thickness: ""}</td>
            <td>${row_data.area? row_data.area: ""}</td>
            <td>${row_data.material? row_data.material: ""}</td>
            <td>${row_data.weight? row_data.weight: ""}</td>
            <td>${row_data.torqueChange? row_data.torqueChange: ""}</td>
            <td>${row_data.inorout == 0 ? "--" : (row_data.inorout == 1 ? "内补": "外补")}</td>
            <td colspan="2" title="${row_data.remark? row_data.remark: ''}" >
                ${row_data.remark?  (row_data.remark.length > 15 ? row_data.remark.slice(0,15)+"..." :row_data.remark )   : ""}
           </td>
            `+fileHtml+opration+`
        </tr>`;
        $("#fixedTableInfo").append($(html));
        //多个附件结构
        for(let m=0;m<row_data.attachmentList.length;m++){
            let file = `<div style="cursor:pointer;color: #f60" onClick="previewPdf('${row_data.attachmentList[m].pkid}','${row_data.attachmentList[m].orgName}')">${row_data.attachmentList[m].orgName? row_data.attachmentList[m].orgName: ""}</div>`;
            $("#file_"+index).append(file);
        }
    }

    function deleteFixed(id){
        $.ajax({
            type: "GET",
            url: "/api/v1/tbm/nrc/nrcPhysicalInfo/delete/" + id,
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (data) {
                if (data.code == 200) {
                    MsgAlert({type: "success", content: "删除成功！"});
                    queryFixedTable();
                }
            },
            error: function () {
                MsgAlert({type: "error", content: "删除失败！"})
            }
        });
    }

    function previewPdf(pkid,filename) {
        InitFuncCodeRequest_({
            data: {pkid: pkid, filename: filename, FunctionCode: 'ATTACHMENT_DOWN'},
            successCallBack: function (jdata) {
                if (jdata.code === RESULT_CODE.SUCCESS_CODE) {
                    doPost(Constant.API_URL + "/ATTACHMENT_DOWN", {pkid: pkid, filename: filename, down: 'Y'});
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function addOrEditFixed(type,id){
        let params = {
            operation: type,
            nrcid:cardId
        };
        if(id){
            params.id = id;
        }
        ShowWindowIframe({
            width: "1000",
            height: "400",
            title: 'add Fixed Patch',
            param: params,
            url: "/views/tbm/flb/fixedPatch.shtml"
        });
    }

    //只允许选一个的设置，以及对应的显示和隐藏
    function onlySetting(){
        //    只能填一个
        $('input[name="checkWay"]').bind('click', function () {
            //只允许填一个
            $('input[name="checkWay"]').not(this).attr("checked", false);
            var zjWay = $('input[name="checkWay"]:checked').val();
            // 选中就显示，没选中就隐藏
            if (zjWay !== null && zjWay !== undefined) {
                $('#bijian').css({'visibility': 'visible'});
            } else {
                $('#bijian').css({'visibility': 'hidden'});
                $("#checkWayNum").textbox('setValue', '');
                $("#checkWayName").textbox('setValue', '');
            };
        });
    }

    //设置互必检按钮
    function setCheckButton(){
        //前置条件：必检，互检只会出现一个。
        // 如果必检，就只能选必检；如果互检，至少选一个；如果没设置，三种都可以
        //如果是互检或是都没有
        if(!!proRci ||(!proRci && !proRii)){
            //互检和必检都放开
            $("#mtSign").attr("disabled",false);
            $("#ehSign").attr("disabled",false);
        };
        if(!!proRii){
            //互检和必检都禁止
            $("#mtSign").attr("disabled",true);
            $("#ehSign").attr("disabled",true);
            //必检选上
            $("#mtSign").prop("checked", true);
        };
        if(!!isRci){
            //互检选上
            $("#ehSign").prop("checked", true);
            //必检不选中
            $("#mtSign").prop("checked", false);
            // //互检和必检都放开
            // $("#mtSign").attr("disabled",false);
            // $("#ehSign").attr("disabled",false);
            //显示互必检选框
            $('#bijian').css({'visibility': 'visible'});
        };
        //如果是必检
        if(!!isRii){
            //必检选上
            $("#mtSign").prop("checked", true);
            // //互检关闭
            // $("#ehSign").prop("checked", false);
            // $("#ehSign").attr("disabled",true);
            //显示互必检选框
            $('#bijian').css({'visibility': 'visible'});
        };
        //如果都没有
        if(!isRci && !isRii){
            //互检和必检都放开
            $("#mtSign").prop("checked", false);
            $("#ehSign").prop("checked", false);
            $("#mtSign").attr("disabled",false);
            $("#ehSign").attr("disabled",false);
            //显示互必检复选框，隐藏互必检输入人名框
            $('.isrcirii').show();
            $('#bijian').css({'visibility': 'hidden'});
        };
    }

    function setCheckButtonTwo(){
        if(!!isRci){
            //互检选上
            $("#ehSign").prop("checked", true);
            //必检不选中
            $("#mtSign").prop("checked", false);
            //互检和必检都放开
            $("#mtSign").attr("disabled",false);
            $("#ehSign").attr("disabled",false);
            //显示互必检选框
            $('#bijian').css({'visibility': 'visible'});
        };
        //如果是必检
        if(!!isRii){
            //必检选上
            $("#mtSign").prop("checked", true);
            //互检不选中
            $("#ehSign").prop("checked", false);
            //互检和必检都放开
            $("#mtSign").attr("disabled",false);
            $("#ehSign").attr("disabled",false);
            //显示互必检选框
            $('#bijian').css({'visibility': 'visible'});
        };
        //如果都没有
        if(!isRci && !isRii){
            //互检和必检都放开
            $("#mtSign").prop("checked", false);
            $("#ehSign").prop("checked", false);
            $("#mtSign").attr("disabled",false);
            $("#ehSign").attr("disabled",false);
            //显示互必检复选框，隐藏互必检输入人名框
            $('.isrcirii').show();
            $('#bijian').css({'visibility': 'hidden'});
        };
    }
</script>
</html>