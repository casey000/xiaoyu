<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>

    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
    <script src="/js/jquery/easyui/jquery-1.8.0.min.js" type="text/javascript"></script>
    <!-- 这一段里面包含resource_.shtml里的内容，但是除去了jquery-1.12.0.min.js和easyui-lang-zh_CN.js，因为新旧版本共用会导致冲突
         但是不引入这一段的话会导致页面样式失效，我也不知道哪些是有用的哪些是没用的 -->

    <link href="/css/style.min862f.css?v=4.1.0" rel="stylesheet">
    <link href="/css/common.css" rel="stylesheet" type="text/css">
    <link href="/css/icon.css" rel="stylesheet" type="text/css">
    <link href="/css/plugins/easyui/themes/bootstrap/easyui.css" id="swicth-style" rel="stylesheet" type="text/css">
    <link href="/css/plugins/easyui/themes/icon.css" rel="stylesheet" type="text/css">
    <link href="/css/plugins/easyui/themes/color.css" rel="stylesheet" type="text/css">
    <!--<script type="text/javascript" src="/js/jquery-3.1.0.min.js"></script>-->
    <script src="/js/constants.js" type="text/javascript"></script>
    <!--<script type="text/javascript" src="/js/plugins/Validform_v5.3.2/Validform_v5.3.2.js"></script>
    <link rel="stylesheet" type="text/css" href="/js/plugins/Validform_v5.3.2/css/style.css">-->
    <script src="/js/plugins/easyui/jquery.easyui.custom.min.js" type="text/javascript"></script>
    <script src="/js/plugins/cookie/jquery.cookie.js" type="text/javascript"></script>
    <script src="/js/base64.js" type="text/javascript"></script>
    <script src="/js/plugins/layer/layer.js?style=default" type="text/javascript"></script>
    <script src="/js/plugins/i18next/i18next.min.js"></script>
    <script src="/js/common.js" type="text/javascript"></script>
    <script src="/js/combobox_utils.js" type="text/javascript"></script>
    <script src="/js/plugins/laytpl/laytpl.js" type="text/javascript"></script>
    <script src="/js/pdf.worker.js" type="text/javascript"></script>
    <script src="/js/axios.min.js" type="text/javascript"></script>
    <script src="/js/sfa-query-1.0.js" type="text/javascript"></script>
    <!-- most content of resource_.shtml but without jquery-1.12.0.min.js and easyui-lang-zh_CN.js -->
    <!-- <script type="text/javascript" src="/js/plugins/easyui/jquery.easyui.custom.min.js"></script> -->
    <!-- <script type="text/javascript" src="/js/plugins/easyui/locale/easyui-lang-zh_CN.js"></script> -->
    <!--#include virtual="/views/defect/defect_js.shtml"-->
    <link href="/css/common_new.css" rel="stylesheet" type="text/css"/>
    <link href="/css/jquery-ui-1.8.2.custom.css" rel="stylesheet" type="text/css"/>
    <link href="/css/ui.jqgrid.css" rel="stylesheet" type="text/css"/>
    <link href="/css/common_new.css" rel="stylesheet" type="text/css"/>
    <link href="/css/common_from_me.css" rel="stylesheet" type="text/css"/>
    <link href="/css/dialog_default.css" rel="stylesheet" type="text/css"/>
    <link href="/css/easyui.css" rel="stylesheet" type="text/css"/>
    <link href="/js/jquery/ztree/zTreeStyle.css" rel="stylesheet" type="text/css"/>
    <!-- <link rel="stylesheet" type="text/css" href="/css/easyui/gray/easyui.css"/> -->
    <link href="/css/common_qc.css" rel="stylesheet" type="text/css"/>
    <link href="/js/jquery/jquery-ui-multiselect/jquery.multiselect.css" rel="stylesheet" type="text/css"/>


    <script src="/js/global_var.js"></script>


    <!-- multiSelect -->
    <!-- <script src="/js/jquery-ui-1.8.16.custom.min.js" type="text/javascript"></script> -->
    <!-- <script src="/js/jquery/jquery-ui-multiselect/src/jquery.multiselect.js" type="text/javascript"></script> -->

    <!-- easy UI -->
    <script src="/js/jquery/easyui/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="/js/jquery/easyui/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>

    <!-- Ztree 使用了tree类型的查询条件定义则需要引入此js -->
    <script src="/js/jquery/ztree/jquery.ztree.core-3.4.js" type="text/javascript"></script>
    <script src="/js/jquery/ztree/jquery.ztree.excheck-3.4.js" type="text/javascript"></script>

    <!-- jqGrid-->
    <script src="/js/jquery/jqGrid/jquery.jqGrid.min.js" type="text/javascript"></script>
    <script src="/js/jquery/jqGrid/i18n/grid.locale-cn.js" type="text/javascript"></script>

    <script src="/js/jquery/lhgdialog/lhgdialog.js" type="text/javascript"></script>

    <script src="/js/sfa-query-1.0.js" type="text/javascript"></script>
    <script src="/js/date_utils_from_me.js" type="text/javascript"></script>
    <script src="/js/sfa-executor.js" type="text/javascript"></script>
    <script src="/js/sfa-export.js" type="text/javascript"></script>
    <script src="/js/common/print_card_utils.js" type="text/javascript"></script>

    <title></title>
    <!--    <script src="../../../../../sfa-me-web-v2/src/main/webapp/js/sfa-query-custom.js"></script>-->
    <style type="text/css">

        #background {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        #div1 {
            background: #ffffff;
            width: 50%;
            z-index: 1;
            margin: 12% auto;
            overflow: auto;
        }

        #close span {
            color: white;
            cursor: pointer;
            font-size: 17px;
        }

        #div2 {
            background: #ffffff;
            margin: auto;
            height: 300px;
            padding: 0 20px;
            font-size: 15px;
        }

        #div2 input {
            margin-left: 8px;
            margin-top: 10px;
        }

        #close {
            padding: 5px;
            background: #ccc;
        }

        #close #close_button {
            float: right;
            font-size: 30px;
        }

        h4 {
            color: white;
            padding-left: 15px;
        }

        h3 {
            margin: 0 0px;
            padding-top: 15px;
        }

        #rectEn {
            width: 94%;
            margin-top: 20px;
            margin-left: 11px;
            height: 170px;
        }

        .button {
            display: inline-block;
            cursor: pointer;
            background: #2465a8;
            color: #fff;
            border-radius: 4px;
            padding: 5px 20px;
            border: none;
            font-size: 14px;
            margin-right: 12px;
            float: right;
            margin-top: 15px;
        }

        .div_key {
            width: 100px;
            height: 50px;
            float: left;
            text-align: center;
            line-height: 57px;
        }

        .div_v {
            width: 350px;
            float: left;
        }

    </style>
</head>
<body>
<div class="listbox " style="margin: 2px auto;min-width: 798px;">
    <div id="qc_box"></div>
    <div id="complete_status" style="display: none;"></div>
    <div class="list_btn_row">
        <ul class="button_li">
            <li class="right_button"><input  class="btn" onclick="Batch_Printing()" auth="TO_piliangdaying"  type="button" value="批量打印"/></li>
<!--            <li class="right_button"><input  class="btn" onclick="unLock_task()"auth="TO_jiesuo" type="button" value="解锁"/></li>-->
            <li class="right_button_export" style="float: right"><input  class="btn" id="export_btn" type="button"auth="TO_daochuexcel" value="导出EXCEL"/></li>
            <li class="right_button"><input  class="btn" id="add_nrc" type="button"auth="TO_ADDNRC" value="新建NRC"/></li>
            <li class="right_button"><input  class="btn" id="add_defect" type="button"auth="TO_xinjiandefect" value="新建DEFECT"/></li>
            <li class="right_button"><input  class="btn" onclick="project_delete()"auth="TO_piliangshanchu" type="button" value="批量删除" id="delete_pil"/></li>
            <li class="right_button"><input  class="btn" onclick="batch_feedback()"auth="TO_piliangfankui" type="button" value="批量反馈" id="piliangfen"/></li>
            <li class="right_button"><input  class="btn" onclick="addMr()"auth="TO_ADDMR" type="button" value="MR清单"/></li>
            <li class="right_button"><input  class="btn" onclick="exportMr()"auth="TO_MRdaochu" type="button" value="Mr导出"/></li>
            <li class="right_button"><input  class="btn" onclick="exportTools()"auth="TO_MRdaochu" type="button" value="工具导出" id="toolsExport"/></li>
            <li class="right_button"><input class="btn" type="button" auth="TO_xiangmubaoliu" value="项目退回" id="retain"/>
            </li>
        </ul>
    </div>
    <div class="listbox">
        <div class="gridbox">
            <div class="grid_tab">
                <table id="common_list_grid"></table>
                <div id="gridPager"></div>

            </div>
        </div>
    </div>

    <div id="background" class="back">
        <div id="div1" class="content">
            <div id="close">
                <span id="close_button">×</span>
                <span>退回</span>
            </div>
            <div id="div2">
                <!--                <div class="div_key">保留原因：<span style="color: red">*</span></div>-->
                <!--                <div class="div_v">-->
                <!--                    <input type="radio" name="hangcai" id="A" value="A"><label for="A">航材</label>-->
                <!--                    <input type="radio" name="hangcai" id="B" value="B"><label for="B">工具</label>-->
                <!--                    <input type="radio" name="hangcai" id="C" value="C"><label for="C">技术</label>-->
                <!--                    <input type="radio" name="hangcai" id="D" value="D"><label for="D">人员</label>-->
                <!--                    <input type="radio" name="hangcai" id="E" value="E"><label for="E">时间</label>-->
                <!--                    <input type="radio" name="hangcai" id="F" value="F"><label for="F">天气</label>-->
                <!--                    <input type="radio" name="hangcai" id="G" value="G"><label for="G">机库机位</label>-->
                <!--                </div>-->
                <div class="div_key">描述：<span style="color: red">*</span></div>
                <div class="div_v">
                    <textarea id="rectEn" name="rectEn"></textarea>
                </div>
                <a class="button" onclick="retain_button()">确定</a>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        var PAGE_DATA = {};
        var partGroupList = {};
        let params = getParentParam_();
        let qoperator = 'in';
        var optsCols = [];
        let _mroCompany;// 客改公司
        optsCols.push("feedback", "Printing", "intervals", "sapTaskId");
        $(function () {
            //注意，控制操作栏显示与否的逻辑并不全在这里在父页面通过right_button样式remove
            if (JSON.parse(params.obj).hasOwnProperty('isLook')) {
                $(".button_li").hide();
            }

            if(JSON.parse(params.obj).hasOwnProperty('status')){
                $('#complete_status').val(JSON.parse(params.obj).status||"");
            };

            function listCb() {
                if (params.view == "V_PCHECK_UNSCHEDULED_TASK") {
                    $(".outter_qc_box").hide();
                }
            }

            InitFuncCodeRequest_({
                data: {
                    domainCode: "Verification_status,PCHECK_PART_GROUP",
                    FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
                },
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        PAGE_DATA['status'] = DomainCodeToMap_(jdata.data["Verification_status"]);
                        partGroupList['partGroup'] = DomainCodeToMap_(jdata.data["PCHECK_PART_GROUP"]);
                        listreload_(listCb);
                    }
                }
            });

            loadMRCompany(JSON.parse(params.obj).supid);

            function nrc_delete(obj) {
                params.success(obj);
                close_window();
            }

            /**
             * 关闭当前窗口
             * @return {void}
             */
            function close_window() {
                window.opener = null;
                window.open('', '_self');
                window.close();
            }

            // 导出
            $("#export_btn").click(function () {
                dynamicExportMVC({
                    sfaQuery: $(document).sfaQuery(),
                    container: $(this).parent(),
                    fileName: 'WORKORDER_LIST.xls',//导出文件命名
                    url: "/api/v1/pcheck/pcheck_task/export_by_page"//后端提供的接口

                });
            });
            // ADDNRC
            $("#add_nrc").click(function () {

                if ("K" != JSON.parse(params.obj).revtp && (JSON.parse(params.obj).flightId == "" || JSON.parse(params.obj).flightId == null)) {
                    alert("请先选择航班！");
                    return;
                }

                var curWidth = ($(window).width()).toString();
                var curheight = $(window).height().toString();
                ShowWindowIframe({
                    width: curWidth,
                    height: curheight,
                    title: "",
                    param: {
                        nrcid: "",
                        ae: JSON.parse(params.obj).acid,
                        modelEng: JSON.parse(params.obj).stort,
                        parentWorkId: JSON.parse(params.obj).workId,
                        acEng: JSON.parse(params.obj).msgrp,
                        revtp: JSON.parse(params.obj).revtp,             //添加客改包识别标记
                        wwbz: JSON.parse(params.obj).wwbz
                    },
                    url: "/views/nrc/nrc_toAdd.shtml"
                });
            });
            // ADD故障
            $("#add_defect").click(function () {

                if (JSON.parse(params.obj).flightId == "" || JSON.parse(params.obj).flightId == null) {
                    alert("请先选择航班！");
                    return;
                }
                var curWidth = ($(window).width()).toString();
                var curheight = $(window).height().toString();
                ShowWindowIframe({
                    width: curWidth,
                    height: curheight,
                    title: "新增故障",
                    param: {
                        nrcid: "",
                        operation: "add",
                        ac_data: {
                            acId: JSON.parse(params.obj).acid,
                            minorModel: JSON.parse(params.obj).stort,
                            acReg: JSON.parse(params.obj).msgrp,
                            flightId: JSON.parse(params.obj).flightId,
                            flightNo: JSON.parse(params.obj).flightNo,
                            preFlightId:JSON.parse(params.obj).flightId,
                            preFlightNo:JSON.parse(params.obj).flightNo,
                            jobDate: JSON.parse(params.obj).jobDate,
                            station: JSON.parse(params.obj).station,
                            jobId: JSON.parse(params.obj).workId,
                            userName:JSON.parse(params.obj).userName_mr,
                            accountNumber:JSON.parse(params.obj).accountNumber_mr,
                            model: JSON.parse(params.obj).model,
                        }

                    },
                    url: "/views/defect/defectAddWindow.shtml"
                });
            });
        });

        function listreload_(callBack) {
            InitFuncCodeRequest_({
                data: {
                    domainCode: "Verification_status",
                    FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
                },
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        PAGE_DATA['status'] = DomainCodeToMap_(jdata.data["Verification_status"]);
                    }
                }
            });
            InitFuncCodeRequest_({
                data: {
                    domainCode: "PCHECK_PART_GROUP",
                    FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
                },
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        partGroupList['partGroup'] = DomainCodeToMap_(jdata.data["PCHECK_PART_GROUP"]);
                    }
                }
            });
            if (params.view == "V_PCHECK_SCHEDULED_TASK") {
                $("#add_nrc").hide();
                $("#add_defect").hide();
                $("#delete_pil").hide();

                qoperator = 'equals';
            } else if ("V_PCHECK_UNSCHEDULED_TASK" === params.view) {
                $("#toolsExport").hide();
            } else {
                $("#piliangfen").hide();
                $("#retain").hide();
                $("#qc_box").hide();
                $(".outter_qc_box").hide();
                //专项包的非例行任务不含DEFECT
                let revtp = window.parent.document.getElementById("revtp").innerHTML;
                if (revtp && revtp === "专项") {
                    $("#add_defect").hide();
                }
            }
            var deferTaskId = "";
            if (params.hasOwnProperty('deferTaskId')) {
                $(".button_li").hide();
                deferTaskId = params.deferTaskId;
            }
            let packageNumber = window.parent.document.getElementById("revno").innerHTML;
            let parentId = window.parent.document.getElementById("workId").innerHTML;
            var options = {
                view: params.view,
                qcOptions: {
                    qcBoxId: 'qc_box'
                },
                defaultParam: {
                    'qname': ['packageNumber', 'type', 'parentId', 'id'],
                    'qoperator': ['equals', qoperator, 'equals', 'equals'],
                    'qvalue': [packageNumber, params.qvalue, parentId, deferTaskId]
                },
                gridOptions: {
                    gridId: 'common_list_grid',
                    optsFirst: true,

                    jqGridSettings: {
                        multiselect: true,
                        id: "id",
                    },
                    allColModels: {
                        'feedback': {
                            name: 'f',
                            colNameEn: 'f',
                            isOpts: true,
                            width: 50,
                            formatter: function (cellValue, options, rowObj) {
                                var ele = '<div id="delete_ner' + rowObj.id + '" class="ui-corner-all clever-jqgrid-action clever-jqgrid-edit edit icon-edit" title="反馈"></div>';
                                $('#delete_ner' + rowObj.id).live('click', function () {
                                    nrc_feedback(rowObj);
                                });

                                if (rowObj.status != "ISSUED" || params.hasOwnProperty('deferTaskId') || JSON.parse(params.obj).status != "UNRELEASED") {
                                    ele = "";
                                }
                                return ele;

                            }
                        },
                        'Printing': {
                            name: 'Printing',
                            colNameEn: 'Printing',
                            colNameCn: '预览/打印',
                            isOpts: true,
                            width: 70,
                            formatter: function (cellValue, options, rowObj) {
                                var ele = '<img title="预览" src="/img/icon_pdf.gif" class="fixPrint" style="cursor:pointer" id="preview' + rowObj.id + '"/>';
                                $('#preview' + rowObj.id).live('click', function () {
                                    preview_button(rowObj);
                                });
                                var aba='<div style="margin-left: 8px;" id="printing' + rowObj.id + '" class="ui-corner-all clever-jqgrid-action clever-jqgrid-edit edit icon-disk_download" title="打印"></div>';
                                $('#printing' + rowObj.id).live('click', function () {
                                    printing_button(rowObj);
                                });
                                // if(rowObj.printLock==1 || rowObj.status=="COMPLETED"){
                                //工包状态
                                var completeStatue = $('#complete_status').val();
                                //权限限制
                                var auth_to_piliangdaying = "TO_piliangdaying";
                                var print_card_auth = VALID_AUTH(auth_to_piliangdaying);
                                if( completeStatue == "RELEASED" || completeStatue == "CANCELED" || !print_card_auth){ //放开打印限制，可以无限次打印
                                    aba='<div style="margin-left: 8px;" id="printingg' + rowObj.id + '" class="ui-corner-all clever-jqgrid-action clever-jqgrid-edit edit " ></div>';
                                }
                                if (rowObj.workType && rowObj.workType == "DEFECT") {
                                    return "";
                                }
                                return ele + aba;

                            }
                        },
                        'cardNumber': {
                            name: 'cardNumber',
                            formatter: function (cellValue, options, rowObj) {
                                var ele = '<span id="cardNumber' + rowObj.id + '" title="' + rowObj.cardNumber + '" style="cursor: pointer;color: #f60; ">' + rowObj.cardNumber + '</span><span id="caed'+rowObj.id+'" style="display:none;">'+rowObj.cardId+'</span> ';
                                $('#cardNumber' + rowObj.id).live('click', function () {
                                    cardNumber_jump(rowObj);
                                });
                                if(rowObj.cardNumber==null || rowObj.cardNumber ==""|| rowObj.cardNumber==undefined){
                                    return '<span id="caed'+rowObj.id+'" style="display: none">'+rowObj.cardId+'</span>';
                                }
                                return ele;

                            }
                        },
                        'appobjtyp': {
                            formatter: "select",
                            editoptions: {
                                value: {"A": "机身", "E": "发动机", "O": "其它", "": ""}
                            },
                            formatType: 'map',
                            pattern: {"A": "机身", "E": "发动机", "O": "其它", "": ""}
                        },
                        'status': {
                            name: 'status',
                            formatter: function (cellValue, options, rowObj) {
                                return PAGE_DATA['status'] [cellValue];
                            }
                        },
                        'partGroup': {
                            name: 'partGroup',
                            formatType: 'map',
                            pattern: partGroupList['partGroup'],
                            formatter: function (cellValue, options, rowObj) {
                                let parGroupName = partGroupList['partGroup'][cellValue];
                                if (parGroupName) {
                                    return parGroupName;
                                } else {
                                    return '';
                                }
                            }
                        },
                        'sapTaskId': {
                            name: 'sapTaskId',
                            isOpts: true,
                            formatter: function (cellValue, options, rowObj) {
                                if (rowObj.sapTaskId) {
                                    return rowObj.sapTaskId;
                                } else {
                                    return "";
                                }
                            }
                        },
                        'intervals': {
                            name: 'intervals',
                            isOpts: true,
                            formatter: function (cellValue, options, rowObj) {
                                if (rowObj.intervals) {
                                    return rowObj.intervals;
                                } else {
                                    return "";
                                }
                            }
                        }
                    },
                    optsCols: optsCols,
                }
            };
            $(document).sfaQuery(options);
            callBack();
        }

        function cardNumber_jump(obj) {
            if (obj.workType == "NRC") {
                var curWidth = ($(window).width()).toString();
                var curheight = $(window).height().toString();
                ShowWindowIframe({
                    width: curWidth,
                    height: curheight,
                    title: "",
                    param: {nrcid: obj.cardId, unCurAssignee: "see",wwbz:JSON.parse(params.obj).wwbz},
                    url: "/views/nrc/see_nrc.shtml"
                });

            }else if(obj.workType=="DEFECT"){
                var curWidth = ($(window).width() ).toString();
                var curheight = $(window).height().toString();
                ShowWindowIframe({
                    width: curWidth,
                    height: curheight,
                    title: "",
                    param: {defectId: obj.cardId, defectNo: obj.cardNumber},
                    url: "/views/defect/defectDetails.shtml"
                });
            }
        }

        function exportMr() {
            let type = "";
            if ("V_PCHECK_SCHEDULED_TASK" === params.view) {
                type = "ROUTINE_TASK";
            } else if ("V_PCHECK_UNSCHEDULED_TASK" === params.view) {
                type = "NON_ROUTINE_TASK";
            } else {
                alert("不为例行或非例行任务，无法导出MR");
                return;
            }
            let odId = JSON.parse(params.obj).workId;
            $.ajax({
                url: "/api/v1/sta/mr/query_mr_wonum_by_type?workOrderId=" + odId + "&type=" + type,
                dataType: "json",
                contentType: 'application/json;charset=utf-8',
                type: 'GET',
                async: true,
                cache: false,
                success: function (obj, textStatus) {
                    if (obj.code === 200) {
                        if (obj.data.length !== 0) {
                            let title_ = $.i18n.t('material_list');
                            let currentWidth = $(window).width().toString();
                            let currentHeight = $(window).height().toString();
                            ShowWindowIframe({
                                width: currentWidth,
                                height: currentHeight,
                                title: title_,
                                param: {List: obj.data},
                                url: "/views/mr/mr_item.shtml"
                            });
                        } else {
                            alert("工单下不存在MR");
                        }
                    } else if (obj.msgData[0]) {
                        alert(obj.msgData[0]);
                    } else {
                        alert(obj.msg);
                    }
                },
                error: function () {
                    alert("获得MR失败");
                }
            });
        }

        function exportTools() {
            let type = "";
            if ("V_PCHECK_SCHEDULED_TASK" === params.view) {
                type = "ROUTINE_TASK";
            } else if ("V_PCHECK_UNSCHEDULED_TASK" === params.view) {
                type = "NON_ROUTINE_TASK";
            } else {
                alert("不为例行或非例行任务，无法导出工具");
                return;
            }
            let odId = JSON.parse(params.obj).workId;
            let form = $("<form method='post' style='display:none' action='" + basePath + "/api/v1/sta/mr/export'></form>");
            form.append($("<input type='hidden' name='fileType' value = 'excel'/>"));
            let parentIdInput = $("<input type='hidden' name='parentId' value = ''/>");
            let typeInput = $("<input type='hidden' name='type' value = ''/>");
            parentIdInput.val(odId);
            typeInput.val(type);
            form.append(parentIdInput);
            form.append(typeInput);
            $("body").append(form);
            form.submit();
            form.remove();
        }

        function addMr() {
            var workType, cardNumber, sonId, acReg, cardId, station, intervals, packageNumber, sapTaskId;
            //获得NRC的ID
            let nodes = $(".ui-state-highlight");
            if (nodes.length !== 1) {
                return window.alert("请选择一条数据！");
            }
            let rowDataId = $(nodes).attr("id");
            let rowData = $(document).sfaQuery().queryGrid.jqGrid.getRowData(rowDataId);
            if (!rowData.status || "已下发" !== rowData.status) {
                return window.alert("只有已下发状态的工单才能添加MR！");
            }
            workType = rowData.workType;
            // sonId = $(nodes).attr("id");
            sonId = rowData.id;
            cardNumber = $('#cardNumber' + rowData.id).text();
            cardId = $("#caed" + rowData.id).text();
            station = rowData.station;
            intervals = rowData.intervals;
            let data = JSON.parse(params.obj);
            acReg = data.msgrp;
            packageNumber = data.revnr;
            sapTaskId = rowData.sapTaskId;
            var curWidth = 1200;
            var curheight = 650;
            let parameters = {
                "tdWorkType": workType,
                "sonId": sonId,
                "station": station,
                "cardNum": cardNumber,
                "acReg": acReg,
                "cardId": cardId,
                "interval": intervals,
                "packageNumber": packageNumber,
                "sapTaskId": sapTaskId,
            };
            ShowWindowIframe({
                width: curWidth,
                height: curheight,
                title: "addMr",
                param: parameters,
                url: "/views/mr/add_mr.shtml"
            });
        }

        //打印解锁
        function unLock_task() {
            let nodes = $(".ui-state-highlight");
            if (nodes.length !== 1) {
                return window.alert("请选择一条数据！");
            }
            let rowDataId = $(nodes).attr("id");
            let rowData = $(document).sfaQuery().queryGrid.jqGrid.getRowData(rowDataId);
            $.ajax({
                type: "GET",
                url: "/api/v1/station_task/unlock_task?workOrderId=" + rowData.id,
                contentType: "application/json;charset=utf-8",
                dataType: "json",
                success: function (data) {
                    if (data.code === 200) {
                        alert("解锁成功");
                        Refresh();
                    } else if (data.msgData && data.msgData[0]) {
                        alert(data.msgData[0]);
                    } else {
                        alert(data.msg);
                    }
                },
                error: function () {
                    window.alert("解锁失败！");
                }
            });
        }

        function project_delete() {
            let list_id = [];
            let nodes = $(".ui-state-highlight");
            if (nodes.length == 0) {
                return window.alert("请选择一条数据！");
            }
            for (let i = 0; i < nodes.length; i++) {
                list_id.push($(nodes[i]).attr("id"));
            }
            $.ajax({
                type: "POST",
                url: "/api/v1/periodic/base/delete_non_routine_task",
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify(list_id),
                dataType: "json",
                success: function (data) {
                    //console.log(data);
                    if (data.code == 200) {
                        alert("删除成功");
                        Refresh();
                    } else if (data.msgData && data.msgData[0]) {
                        alert(data.msgData[0]);
                    } else {
                        alert(data.msg);
                    }
                },
                error: function () {
                    window.alert("失败！");
                }
            });
        }

        function batch_feedback() {    //批量反馈
            if ("K" != JSON.parse(params.obj).revtp && (JSON.parse(params.obj).flightId == "" || JSON.parse(params.obj).flightId == null)) {
                alert("请先选择航班！");
                return;
            }

            var curWidth = ($(window).width()).toString();
            var curheight = $(window).height().toString();
            ShowWindowIframe({
                width: curWidth,
                height: curheight,
                title: "",
                param: {obj: JSON.parse(params.obj)},
                url: "/views/fixed/wrong_project_task.shtml"
            });
        }

        // 获取客改公司
        function loadMRCompany(supid) {
            if (supid) {
                $.ajax({
                    url: "/api/v1/mro/selectById/" + supid,
                    dataType: "json",
                    contentType: 'application/json;charset=utf-8',
                    type: 'GET',
                    async: true,
                    cache: false,
                    success: function (obj, textStatus) {
                        if (obj.code === 200) {
                            if (obj.data) {
                                _mroCompany = obj.data.mroCompany;
                            }
                        } else {
                            //alert(obj.msg);
                            console.warn(obj.msg)
                        }
                    },
                    error: function () {
                        console.warn("获得NRC执行公司失败")
                        //alert("获得NRC执行公司失败");
                    }
                });
            }
        }

        function nrc_feedback(obj) {    //单个反馈
            let parentObj = JSON.parse(params.obj);
            if ("K" != JSON.parse(params.obj).revtp && (parentObj.flightId == "" || parentObj.flightId == null)) {
                alert("请先选择航班！");
                return;
            }
            obj.flightId = parentObj.flightId;
            obj.flightNo = parentObj.flightNo;
            obj.flightDate = parentObj.flightDate;
            obj.station = parentObj.station;
            obj.jobDate = parentObj.jobDate;
            obj.preFlightId = parentObj.preFlightId;
            obj.preFlightNo = parentObj.preFlightNo;
            obj.bigModel = parentObj.model;
            obj.acId = parentObj.acid;
            obj.acReg = parentObj.msgrp;
            obj.model = parentObj.model;
            obj.isFeedbackAttachment = parentObj.isFeedbackAttachment;

            //测试CCO
            // obj.workType="CCO";

            var curWidth = ($(window).width()) * 1.4.toString();
            var curheight = $(window).height() * 1.4.toString();
            if (obj.workType == "JC") {
                ShowWindowIframe({
                    width: 1350,
                    height: 700,
                    title: "",
                    param: {fixedType: obj},
                    url: "/views/tbm/flb/jc_process.shtml"
                });
            } else if (obj.workType == "NRC" || obj.workType == "NRCT") {
                //客改包，传递公司名称
                if ("K" == JSON.parse(params.obj).revtp) {
                    obj.mroCompany = _mroCompany || '';
                }
                ShowWindowIframe({
                    width: 1350,
                    height: 700,
                    title: "",
                    param: {fixedType: obj},
                    url: "/views/tbm/flb/nrc_process.shtml"
                });
            } else if (obj.workType == "TO") {
                ShowWindowIframe({
                    width: 1350,
                    height: 700,
                    title: "",
                    param: {fixedType: obj},
                    url: "/views/tbm/flb/to_process.shtml"
                });
            } else if (obj.workType == "CCO") {
                ShowWindowIframe({
                    width: 1350,
                    height: 700,
                    title: "",
                    param: {fixedType: obj},
                    url: "/views/tbm/flb/cco_process_checking.shtml"
                });
            } else if (obj.workType == "PCO") {
                console.log(obj);
                ShowWindowIframe({
                    width: 1350,
                    height: 700,
                    title: "",
                    param: {fixedType: obj},
                    url: "/views/tbm/flb/pco_process.shtml"
                });
            } else if (obj.workType == "DEFECT") {
                var defectId = obj.cardId;
                var defectNo = obj.cardNumber;
                ShowWindowIframe({
                    width: "1000",
                    height: "700",
                    title: "",
                    param: {defectId: defectId, defectNo: defectNo},
                    url: "/views/defect/defectDetails.shtml"
                });
            } else {
                alert("该类型暂不支持反馈！")
            }
        }

        var btn = document.getElementById('retain');
        var div = document.getElementById('background');
        var close = document.getElementById('close_button');
        var id_da = "";
        btn.onclick = function show() {
            if (!JSON.parse(params.obj).actualStartDate || JSON.parse(params.obj).actualStartDate == null) {
                alert("请保存实际开始时间！");
                return;
            }
            let nodes = $(".ui-state-highlight");
            if (nodes.length !== 1) {
                return window.alert("请选择一条！");
            }
            let rowDataId = $(nodes).attr("id");
            let rowData = $(document).sfaQuery().queryGrid.jqGrid.getRowData(rowDataId);

            console.log(rowData);
            id_da = rowData.id;
            div.style.display = "block";
        };

        close.onclick = function close() {
            div.style.display = "none";
        };

        window.onclick = function close(e) {
            if (e.target == div) {
                div.style.display = "none";
            }
        };

        function retain_button() {
            // var riao="";
            // var obj=document.getElementsByName("hangcai");
            //     for(var i=0; i<obj.length; i++){
            //     if(obj[i].checked){
            //         riao=obj[i].value;
            //     }
            // }
            //     if(riao==""){
            //         alert("请选择类型！");
            //         return;
            //     }
            if ($("#rectEn").val() == "" || $("#rectEn").val() == null) {
                alert("退回原因不能为空！");
                return;
            }
            $.ajax({
                type: "POST",
                url: "/api/v1/flb/feedBack/defer_task",
                contentType: "application/json;charset=utf-8",
                data: JSON.stringify({
                    cancelReason: $("#rectEn").val(),
                    id: id_da
                }),
                dataType: "json",
                success: function (data) {
                    if (data.code == 200) {
                        window.alert("退回成功！");
                        document.getElementById('background').style.display = "none";
                        Refresh();
                    } else if (data.msgData && data.msgData[0]) {
                        alert(data.msgData[0]);
                    } else {
                        alert(data.msg);
                    }
                },
                error: function () {
                    window.alert("失败！");
                }
            });
        }

        function printing_button(obj) {          //打印
            console.log(obj);
            var row = {
                id: obj.cardId,
                type: obj.workType,
                wkId: obj.id,
                acId: obj.acId == null ? '' : obj.acId,
                sapId: obj.sapTaskId
            };
            // $("#printing" + obj.id).hide();
            // $("#printingg" + obj.id).show();
            return printCardPdf(row);
        }

        function preview_button(obj) {       //预览
            var row = {
                cardId: obj.cardId,
                workType: obj.workType,
                wkId: obj.id,
                acId: obj.acId == null ? '' : obj.acId,
                sapId: obj.sapTaskId
            };
            return preView_Pdf(row);
        }

        function Batch_Printing() {
            let parentObj = JSON.parse(params.obj);
            //因统一的打印需要有航班日期，所以需要先添加航班（需求调整去掉）
            // if (parentObj.flightId == "" || parentObj.flightId == null) {
            //     alert("请先选择航班！");
            //     return;
            // }
            let view_type = "";
            if ("V_PCHECK_SCHEDULED_TASK" === params.view) {
                view_type = "ROUTINE_TASK";
            } else if ("V_PCHECK_UNSCHEDULED_TASK" === params.view) {
                view_type = "NON_ROUTINE_TASK";
            }
            var con = "<form id='_f0_rm' method='post' ></form>";
            $("#_f0_rm").remove();
            $("body").append(con);
            var dateRange = $("<input type='hidden' name='source'/>");
            dateRange.val("PERIODIC");
            $("#_f0_rm").append(dateRange);

            var date = $("<input type='hidden' name='type' />");
            date.val(view_type);
            $("#_f0_rm").append(date);

            var time = $("<input type='hidden' name='workId' />");
            time.val(JSON.parse(params.obj).workId);
            $("#_f0_rm").append(time);
            var $form = $("#_f0_rm");
            var datas = $form.serializeObject();

            datas = $.extend({}, datas, {FunctionCode: 'DOWNLOAD_STATION_TASK'});
            InitFuncCodeRequest_({
                data: datas, successCallBack: function (jdata) {
                    if (jdata.code !== 200) {
                        window.alert("下载失败." + jdata.msg);
                    } else {
                        var filesForm = "<form id='_f1m' method='post' action='/api/v1/plugins/DOWNLOAD_FILES'></form>";
                        $("#_f1m").remove();
                        $("body").append(filesForm);

                        console.log(jdata.data);
                        var filePath = $("<input type='hidden' name='filePath'/>");
                        filePath.val(jdata.data);
                        $("#_f1m").append(filePath);

                        $("#_f1m").submit();
                        $('#dd').dialog('close');
                        setTimeout(function (){
                            Refresh();
                        }, 1500);

                    }
                }
            });

        }

        function Refresh() {
            console.log(113);
            $("#common_list_grid").jqGrid().trigger("reloadGrid");
        }

        // function Refresh() {
        //     $(".qc_btn_srh").click();
        // }

    </script>

</div>
</body>
</html>
