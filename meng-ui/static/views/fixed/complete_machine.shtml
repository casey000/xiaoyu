<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <!--#include virtual="/views/defect/defect_js.shtml"-->
    <meta charset="UTF-8">
    <title>flb_oilStatistics_view</title>
    <link href="/css/nrc/nrc_add.css" rel="stylesheet">
    <style type="text/css">
        body{
            font-size: 14px;
            height: 100%;
        }
         .input_button{
             border: 0px;
             border-bottom: 1px solid #ccc;
             outline:none;
             text-indent: 1em;
             text-align: center;
         }
          .mach_div{
              margin-top: 5px;
          }
        th{
            text-align: center;
        }
        tr{
            height: 30px;
        }

        .calendar-dtable tr {
            height: 20px;
        }
        td{
            text-align: center;
            color: #000;
        }

        .red {
            color: red;
        }

        #atta_input_flie_1 {
            width: 70%;
            border: 1px solid #D4D4D4;
            border-radius: 5px;
        }

        .file_duihao {
            position: absolute;
            top: 0px;
            right: 13px;
        }

        .add_jiahao {
            position: absolute;
            top: 0px;
            right: 22px;
        }

        .calendar-day {
            height: 20px;
        }

        .com_button {
            width: 76px;
            height: 25px;
            text-align: center;
            line-height: 25px;
            border-radius: 5px;
            color: #fff;
            background: #2465a8;
            cursor: pointer;
            float: right;
            margin-right: 23px;
        }
    </style>
</head>
<body >
<input id="flightId" style="display:none;" type="text">
<input id="workOrderId" style="display:none;" type="text">
<input id="id" style="display:none;" type="text">
<input id="workId" style="display:none;" type="text">
<h4>1.维修单位</h4>
<div class="mach_div"><input type="radio" id="ltd" name="sf_co"><label for="ltd">顺丰航空有限公司/SF Airlines Co.,Ltd</label></div>
<div class="mach_div"><input id="mro" name="sf_co" type="radio" disabled><label for="mro">外委Outsourcing,送修单位/Contracted
    MRO</label><input class="input_button" id="contractedMro" type="text" readonly="readonly"><label for="mro">送修合同/Contract
    No.</label><input class="input_button" id="contractNo" type="text" readonly="readonly"></div>
<h4>2.飞机概况Identification</h4>
<div class="mach_div">飞机型号/Model<input class="input_button" id="model" type="text" readonly="readonly">飞机注册号/AC<input
        class="input_button"
        id="acReg"
        type="text" readonly="readonly"></div>
<div class="mach_div">飞行小时/FH<input class="input_button" id="tsn" type="text" readonly="readonly"> 飞行起落/FC<input class="input_button"
                                                                                             id="csn" type="text" readonly="readonly"></div>
<div class="mach_div">一发件号ENG 1 P/N<input class="input_button" id="engOnePn" type="text"> 一发序号ENG 1 S/N<input
        class="input_button" id="engOneSn" type="text"> </div>
<div class="mach_div">二发件号ENG 2 P/N<input class="input_button" id="engTwoPn" type="text"> 二发序号ENG 2 S/N<input
        class="input_button" id="engTwoSn" type="text"> </div>
<div class="mach_div b_747">三发件号ENG 2 P/N<input class="input_button" id="engThreePn" type="text"> 三发序号ENG 2 S/N<input
        class="input_button" id="engThreeSn" type="text"> </div>
<div class="mach_div b_747">四发件号ENG 2 P/N<input class="input_button" id="engFourPn" type="text"> 四发序号ENG 2 S/N<input
        class="input_button" id="engFourSn" type="text"> </div>
<div class="mach_div">APU型号/APU Mod<input class="input_button" id="apuPn" type="text"> APU序号/ESN<input
        class="input_button" id="apuSn" type="text"> </div>
<h4>3.检修工作/Maintenance Work</h4>
<div class="mach_div">检修级别/Check Type<input class="input_button" id="checkLevel" type="text" readonly="readonly">; 维修工作指令WO<input
        class="input_button" id="revno" type="text" readonly="readonly"></div>
<div class="mach_div">本次检修工作执行例行工作数量:<input class="input_button" id="jcNum" type="text" readonly="readonly">, 详见后附《例行工作清单》</div>
<!--<div class="mach_div">本次检修工作执行工程指令（EO）数量:<input class="input_button" id="eoNum" type="text">, 详见后附《维修工作包工程指令清单》</div>-->
<div class="mach_div">本次检修工作新增执行非例行卡工作数量:<input class="input_button" id="nrcNum" type="text" readonly="readonly">, 详见后附 《非例行工作清单》</div>
<div class="mach_div">本次检修工作执行重要改装及重要修理数量:<input class="input_button" id="mrNum" type="text">,
    详见后附《重要改装及重要修理清单》及对应AAC-085表
</div>
<div class="mach_div">本次检修工作遗留项目:<input class="input_button" id="fltNum" type="text" readonly="readonly">项，详见后附《遗留工作清单》</div>
<h4>4.备注Remark</h4><span>(如本栏不够,可另加附页;如无需要备注的信息,则写"无");</span>
<div class="mach_div">
    <textarea id="remark" name="descChn"></textarea>
</div>
<div style="height: 30px">
    <div class="com_button" onclick="save_data()" auth="TD_Complete_submission">提交</div>
<!--    <div class="com_button" onclick="download_release()" auth="TD_Release_Printing">放行打印</div>-->
</div>

<h4>5.维修放行声明 Certifies of Release Service</h4>
<table class="table table-bordered table-info">
    <tr>
        <th>Type</th>
        <th>Signature</th>
        <th>Licence NO</th>
        <th>report</th>
        <th>Date</th>
        <th>Operate</th>
    </tr>
    <tr>
        <td>整机</td>
        <td><span id="signature"></span></td>
        <td><span id="licenseNo"></span></td>
        <td><span id="file" onclick="downFile_data()" style="cursor: pointer;text-decoration:underline;color: #00F"></span><span id="file_pkid"
                                                                                           style="display:none;"></span>
        </td>
        <td><span id="releaseDate"></span></td>
        <td><input onclick="release_open()" type="button" class="com_button" value="Release"></td>
    </tr>
</table>

<div class="easyui-window" data-options="iconCls:'icon-save',modal:true" id="release"
     style="width:450px;height:300px;padding:10px;display: none"
     title="放行">
    <table class="table table-bordered table-info">
        <tr>
            <th>Type</th>
            <td><span>整机</span></td>
        </tr>
        <tr>
            <th>Signature</th>
            <td><input class="easyui-textbox easyui-validatebox" data-options="validType:['maxLength[20]'] "
                       id="signature2" name="repId" style=" width:20%;"/><span class="red">*</span></td>
            <td class="signature2" style="display:none;">
                <input class="gonghao" id="repidto" style="display: none">
                <input
                        class="easyui-textbox name_in" disabled="disabled" id="releasename" name="repName"
                        style="width: 85%"
                        type="text">
            </td>
        </tr>
        <tr>
            <th>LICENCE NO</th>
            <td><input class="beiliao" id="licenseNo2" type="text"><span class="red">*</span></td>
        </tr>
        <tr>
            <th>Date</th>
            <td><input class="easyui-datetimebox" id="releaseDate2" name="repTime" style="width: 70%" type="text"><span
                    class="red">*</span></td>

        </tr>
        <tr>
            <th>Type</th>
            <td style="position: relative;">
                <input class="textbox easyui-validatebox" data-options="required:true" id="atta_input_flie_" name="file"
                       size="300" style="width: 235px;" type="file"/>
                <div class='file_duihao' onclick="atta_input_flie()">✔</div>
                <!--<div class="add_jiahao" onclick="add_atta_input_flie()"></div>-->
            </td>
        </tr>

    </table>
    <div class="boumnn">
        <a onclick="popup_button()">确定</a>
        <a onclick="release_close()" style="background-color: #ce3c3c">关闭</a>
    </div>
</div>
</body>
<script src="/js/plugins/ajaxfileupload/ajaxfileupload.js" type="text/javascript"></script>
<script src="../../../js/datagrid_utils.js" type="text/javascript"></script>
<script type="text/javascript">
    var overallDeliveryData;

   $(function () {
       $("#ac_register").val("B-7082");
       fengzhuang("repId");
       release_close();
       var ac_data = {};
       let id_data = window.parent.document.getElementById("workId").innerHTML;
       $.ajax({
           type: "GET",
           url: "/api/v1/periodic/delivery/select_overall_delivery?workId=" + id_data,
           contentType: "application/json;charset=utf-8",
           dataType: "json",
           success: function (data) {
               if (data.code == 200) {
                   console.log(data.data);
                   ac_data = data.data;
                   overallDeliveryData = data.data;
                   for (let i in data.data) {          //循环对象赋值
                       $("#" + i).val(data.data[i]);
                   }
                   if (ac_data.isOutsourcing == "n") {
                       $("#ltd").prop("checked", true);
                       $("#contractedMro").val("");
                       $("#contractNo").val("");
                   } else if (ac_data.isOutsourcing == "y") {
                       $("#mro").prop("checked", true);
                   }
                   $("#tsn").val(parseInt(ac_data.tsn/60)+":"+ac_data.tsn%60);
                   $("#signature").text(_null(ac_data.releaseOperationParamVO.releasePersonalInfo.signature));
                   $("#licenseNo").text(_null(ac_data.releaseOperationParamVO.releasePersonalInfo.licenseNo));
                   $("#releaseDate").text(_null(ac_data.releaseOperationParamVO.releasePersonalInfo.releaseDate));
                   $("#flightId").val(ac_data.releaseOperationParamVO.flightId);
                   $("#workOrderId").val(ac_data.releaseOperationParamVO.workOrderId);
                   if (data.data.acReg != "B747") {
                       $(".b_747").hide();
                   }
                   add_file_show();
               } else if (data.msgData && data.msgData[0]) {
                   alert(data.msgData[0]);
               } else {
                   alert(data.msg);
               }
           },
           error: function () {
               window.alert("失败！");
           }
       });
   });
   function toDecimal(x) {
       var f = parseFloat(x);
       if (isNaN(f)) {
           return;
       }
       f = Math.round(x*100)/100;
       return f;
   }

   function _null(obj) {
       if(obj==null || obj==undefined){
           return "";
       }
       return obj;
   }

   function release_open() {
       let flightId = $("#flightId").val();
       if (!flightId || flightId === "") {
           alert("请先选择航班后再放行！");
           return;
       }
       if (!overallDeliveryData.id || overallDeliveryData.id === "") {
           alert("请先选择提交整机信息再放行！");
           return;
       }
       $('#release').window('open');
       fengzhuang("signature2");
   }

   function release_close() {
       $('#release').window('close');
   }

   var subm_data = {};

   function save_data() {          //动态获取输入框数据
       let list = document.getElementsByClassName("input_button");
       for (let i in list) {
           if (list[i].id != undefined) {
               subm_data[list[i].id] = $("#" + list[i].id).val();
           }
       }
       if ($("#ltd").is(":checked")) {
           subm_data["isOutsourcing"] = "n";
       } else if ($("#mro").is(":checked")) {
           subm_data["isOutsourcing"] = "y";
       }
       subm_data["id"] = $("#id").val();
       subm_data["workId"] = $("#workId").val();
       subm_data["remark"] = $("#remark").val();
       //tsn和csn的值不传到到后台--否则类型会报错
       subm_data["tsn"] = null;
       subm_data["csn"] = null;

       $.ajax({
           type: "POST",
           url: "/api/v1/periodic/delivery/save_overall_delivery",
           contentType: "application/json;charset=utf-8",
           data: JSON.stringify(subm_data),
           dataType: "json",
           success: function (data) {
               if (data.code == 200) {
                   alert("成功！");
                   overallDeliveryData.id = data.data;
               } else if (data.msgData && data.msgData[0]) {
                   alert(data.msgData[0]);
               } else {
                   alert(data.msg);
               }
           },
           error: function () {
               window.alert("删除失败！");
           }
       });

   }

   function atta_input_flie(id) {

       var fileInput = $("#atta_input_flie_").get(0).files[0];
       if (fileInput) {
           $.ajaxFileUpload({
               url: Constant.API_URL + 'ATTACHMENT_UPLOAD',
               secureuri: false,
               fileElementId: "atta_input_flie_", //file控件id
               dataType: 'json',
               data: {
                   "fileCategory": "feedback",
                   "sourceId": $("#workOrderId").val()
               },
               success: function (data) {
                   if (data.code == 200) {
                       alert("上传成功！");

                       add_file_show();
                   }
               }

           })
       } else {
           alert("请选择上传文件！");
       }


   }

   function add_file_show() {
       InitFuncCodeRequest_({
           data: {
               SOURCE_ID: $("#workOrderId").val(),
               CATEGORY: "feedback",
               FunctionCode: 'ATTACHMENT_RSPL_GET'
           },
           successCallBack: function (jdata) {
               if (jdata.data.length > 0) {
                   $("#file").text(jdata.data[0].ORG_NAME);
                   $("#file_pkid").text(jdata.data[0].PKID);
                   $(".file_duihao").hide();
               }

           }
       });
   }

   function popup_button() {
       if ($("#signature2").textbox("getValue") == "") {
           MsgAlert({content: 'Signature不能为空', type: 'error'});
           return
       }
       if ($("#licenseNo2").val() == "") {
           MsgAlert({content: 'LICENCE NO不能为空', type: 'error'});
           return
       }
       if ($("#releaseDate2").textbox("getValue") == "") {
           MsgAlert({content: 'Date不能为空', type: 'error'});
           return
       }
       //先校验例行任务中的NRC是否已被关闭，再调用整机放行方法
       //let workId = $("#workOrderId").val();
       let workId=window.parent.document.getElementById("workId").innerHTML;
       $.ajax({
           type: "GET",
           url: "/api/v1/periodic/delivery/list_un_close_nrc_by_work_id_and_type?workId=" + workId + "&type=ROUTINE_TASK",
           contentType: "application/json;charset=utf-8",
           dataType: "json",
           success: function (data) {
               if (data.code === 200) {
                   if (data.data && "" !== data.data) {
                       //确认框
                       if (!confirm("编号为" + data.data + "的NRC未关闭，请确认是否继续放行？")) {
                           //取消时走这里
                           return;
                       }
                   }
                   let releaseData = {
                       flightId: $("#flightId").val(),
                       workOrderId: workId,
                       releasePersonalInfo: {
                           releaseDate: $("#releaseDate2").textbox("getValue"),
                           signature: $("#releasename").textbox("getValue"),
                           licenseNo: $("#licenseNo2").val(),
                           staffNo: $("#signature2").textbox("getValue"),
                       }
                   };
                   $.ajax({
                       type: "POST",
                       url: "/api/v1/tbm/detail/release_package",
                       contentType: "application/json;charset=utf-8",
                       data: JSON.stringify(releaseData),
                       dataType: "json",
                       success: function (data) {
                           if (data.code === 200) {
                               window.alert("放行成功！");
                           } else if (data.msgData && data.msgData[0]) {
                               window.alert("放行失败！失败原因：" + data.msgData[0]);
                           } else {
                               window.alert(data.msg);
                           }
                       },
                       error: function () {
                           window.alert("放行失败！");
                       }
                   });
               } else if (data.msgData && data.msgData[0]) {
                   alert(data.msgData[0]);
               } else {
                   alert(data.msg);
               }
           },
           error: function () {
               window.alert("获得NRC关闭信息失败！");
           }
       });
   }

   function downFile_data() {
       downFile($("#file_pkid").text(), $("#file_pkid").text());
   }

   function download_release() {
       let workId = window.parent.document.getElementById("workId").innerHTML;
       let url = "/api/v1/periodic/delivery/export_pdf";
       let con = "<form id='_f0_rm' method='GET' action='" + url + "'>" +
           "<input class=\"beiliao\" value=\"" + workId + "\"  type=\"text\" name=\"workId\" style='display: none'>" +
           "</form>";
       $("#_f0_rm").remove();
       $("body").append(con);

       $("#_f0_rm").submit();
   }
</script>
</html>