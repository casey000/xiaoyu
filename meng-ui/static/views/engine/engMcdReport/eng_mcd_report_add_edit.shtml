<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>磁堵检查报告管理</title>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
    <script type="text/javascript" src="/js/common.js"></script>
    <style type="text/css">
        td {
            padding: 2px;
        }

        button {
            width: 45px;
            height: 20px;
            margin-left: 3px;
            vertical-align: middle;
            border: 1px solid #cfcfcf;
            -moz-border-radius: 5px;
            border-radius: 5px;
            backgroud: #d5d5d5;
        }

        .addBtn {
            padding: 1px 10px;
        }
    </style>
</head>
<body>
<div style="width:95%;margin:0 auto;">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <div id="p0" class="easyui-panel" title="新增/编辑磁堵报告" style="width: 100%"></div>
                <input type="hidden" id="pkid" name="pkid"/>
                <input type="hidden" id="modifyUser" name="modifyUser"/>
                <input type="hidden" id="modifyName" name="modifyName"/>
                <input type="hidden" id="modifyDate" name="modifyDate"/>
                <input type="hidden" id="checkUser" name="checkUser"/>
                <input type="hidden" id="acId" name="acId"/>
                <table class="table table-bordered table-info" style="width: 100%">
                    <tr>
                        <td colspan="8" align="right" style="padding: 0;">
                            <input class="btn btn-primary" type="button" id="addKeyBtn" onclick="addKey()" value="加入重点监控清单"/>
                            <input class="btn btn-primary" type="button" id="saveBtn" onclick="save()" value="保存"/>
                            <input class="btn btn-primary" type="button" onclick="CloseWindowIframe();" value="关闭"
                                   style="margin-left:3px;margin-right: 20px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>检查日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="checkDate" name="checkDate" data-options="required:true"
                                   style="width: 160px;"/>
                        </td>
                        <th>发动机型号：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="epn" name="epn"
                                   data-options="required:true,editable:false"
                                   style="width: 160px;"/>
                        </td>
                        <th>发动机序号：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="esn" name="esn"
                                   data-options="required:true,editable:false"
                                   style="width: 174px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th style="width: 120px;">任务来源：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="taskSource" name="taskSource"
                                   data-options="required:true,editable:false" style="width: 160px;"/>
                        </td>
                        <th style="width: 120px;">工作单号：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-combobox" id="jobCardNo" name="jobCardNo"
                                   data-options="required:true,editable:false"
                                   style="width: 492px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>检查地点：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="checkAddr" name="checkAddr" data-options="required:true"
                                   style="width: 160px;"/>
                        </td>
                        <th>检查人：</th>
                        <td class="tdr">
                            <input class="easyui-combogrid" id="checkName" name="checkName" data-options=""
                                   style="width: 154px;"/>
                        </td>
                        <th style="width: 120px;">报告编号：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="reportNo" name="reportNo"
                                   data-options="onlyview:true,editable:false"
                                   style="width: 174px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>机号：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="acReg" name="acReg"
                                   data-options="required:true,editable:false"
                                   style="width: 160px;"/>
                        </td>
                        <th>发动机位置：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="engPos" name="engPos"
                                   data-options="required:true,editable:false"
                                   style="width: 180px;"/>
                        </td>
                        <th>机型：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="acType" name="acType"
                                   data-options="onlyview:true,editable:false"
                                   style="width: 174px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>发动机TSN：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="tsn" name="tsn"
                                   data-options="onlyview:true,editable:false"
                                   style="width: 160px;"/>
                        </td>
                        <th>发动机TSO：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="tso" name="tso"
                                   data-options="onlyview:true,editable:false"
                                   style="width: 180px;"/>
                        </td>
                        <th>发动机TSR：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="tsr" name="tsr"
                                   data-options="onlyview:true,editable:false"
                                   style="width: 174px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>发动机CSN：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="csn" name="csn"
                                   data-options="onlyview:true,editable:false"
                                   style="width: 160px;"/>
                        </td>
                        <th>发动机CSO：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="cso" name="cso"
                                   data-options="onlyview:true,editable:false"
                                   style="width: 180px;"/>
                        </td>
                        <th>发动机CSR：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="csr" name="csr"
                                   data-options="onlyview:true,editable:false"
                                   style="width: 174px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>检查部位：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="checkPos" name="checkPos"
                                   data-options="required:true,editable:false"
                                   style="width: 160px;"/>
                        </td>
                        <th>件号：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="partPn" name="partPn"
                                   data-options="onlyview:true,editable:false" style="width: 180px;"/>
                        </td>
                        <th>序号：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="partSn" name="partSn"
                                   data-options="onlyview:true,editable:false" style="width: 174px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>附件TSN：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="partTsn" name="partTsn"
                                   data-options="onlyview:true,editable:false" style="width: 160px;"/>
                        </td>
                        <th>附件TSO：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="partTso" name="partTso"
                                   data-options="onlyview:true,editable:false" style="width: 180px;"/>
                        </td>
                        <th>附件TSR：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="partTsr" name="partTsr"
                                   data-options="onlyview:true,editable:false" style="width: 174px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>附件CSN：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="partCsn" name="partCsn"
                                   data-options="onlyview:true,editable:false" style="width: 160px;"/>
                        </td>
                        <th>附件CSO：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="partCso" name="partCso"
                                   data-options="onlyview:true,editable:false" style="width: 180px;"/>
                        </td>
                        <th>附件CSR：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="partCsr" name="partCsr"
                                   data-options="onlyview:true,editable:false" style="width: 174px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>磁屑性质：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="chipType" name="chipType"
                                   data-options="required:true,editable:false"
                                   style="width: 160px;"/>
                        </td>
                        <th>材料类别：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="mateType" name="mateType"
                                   data-options="required:true,editable:false"
                                   style="width: 180px;"/>
                        </td>
                        <th>送检类别：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="repairType" name="repairType"
                                   data-options="required:true,editable:false" style="width: 174px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>碎屑描述：</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox" id="chipDesc" name="chipDesc" data-options="required:true"
                                   style="width: 790px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>初步处置措施：</th>
                        <td class="tdr" colspan="5">
                            <input class="easyui-textbox" id="dealDesc" name="dealDesc" data-options="required:true"
                                   style="width: 790px;"/>
                        </td>
                    </tr>
                    <tr style="height:30px;">
                        <th><a href="javascript:void(0)" id="mcdCheck"
                               onclick="addOrEditEngMcdCheck('add')">检测报告:&nbsp;&nbsp;</a></th>
                        <td colspan="7">
                            <table id="dg"></table>
                        </td>
                    </tr>
                    <tr>
                        <th>后续处理方案：</th>
                        <td colspan="7">
                            <input style="margin-left: 720px" class="btn btn-primary" type="button" id="busAddBtn"
                                   onclick="addWorkno()" value="相关单据"/>
                            <table id="dg1"></table>
                        </td>
                    </tr>
                    <tr>
                        <th>关注级别：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="attLevle" name="attLevle" data-options="editable:false"
                                   style="width: 160px;"/>
                        </td>
                        <th>报告结论：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="resultType" name="resultType"
                                   data-options="editable:false"
                                   style="width: 160px;"/>
                        </td>
                        <th>可能与上次送修有关：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="lastRepairFlag" name="lastRepairFlag"
                                   data-options="editable:false"
                                   style="width: 174px;"/>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
</div>
<script>
    var PAGE_DATA = {};
    var param = {};
    var pkid;
    var operation;
    var reportOperation;
    var selectRow;
    var userId;//工作流使用
    var userName;//工作流使用
    var isFlow;
    var taskId;
    function i18nCallBack() {
        param = getParentParam_();
        pkid = param.pkid;
        operation = param.operation;
        reportOperation = param.operation;
        isFlow = param.isFlow;
        taskId = param.taskId;
        if (param.taskId == null) {
            var userLogin = getLoginInfo();
            $("#modifyName").val(userLogin.userName);
            var currentDate = new Date();
            var year = currentDate.getFullYear().toString();
            var month = (currentDate.getMonth() + 1).toString();
            var day = currentDate.getDate().toString();
            $("#modifyDate").val(year + "-" + month + "-" + day);
            $("#modifyUser").val(userLogin.accountId);
        }
        $('#addKeyBtn').hide();
        $('#busAddBtn').hide();
        if(isFlow && taskId == 'task1594970650112'){//最后一个节点：磁堵检查报告审核
            $("#addKeyBtn").show();
            $("#busAddBtn").show();
        }
        InitFuncCodeRequest_({
            data: {
                domainCode: "ENG_TASK_SOURCE,ENG_MCD_POS,DA_FLEET,ENG_MCD_CHECK_POS,ENG_MCD_MATE_CHIP_TYPE,ENG_MCD_MATE_TYPE,ENG_MCD_REPAIR_TYPE," +
                "ENG_BSI_MCD_ATT_LEVEL,ENG_MCD_CHECK_RESULT,YESORNO,ENG_DA_ACNO,ENG_BUS_TYPE,ENG_POS",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    //任务来源
                    $('#taskSource').combobox({
                        panelHeight: '60px',
                        data: jdata.data.ENG_TASK_SOURCE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (item) {
                            if ("OTHER" == item.VALUE) {
                                $("#jobCardNo").combobox({
                                    required: true,
                                    editable: true,
                                    hasDownArrow: false,
                                    panelHeight: 1
                                })
                            } else {
                                $("#jobCardNo").combobox({
                                    required: true,
                                    editable: true,
                                    hasDownArrow: true,
                                    panelHeight: '150px'
                                })
                            }
                        }
                    });
                    //发动机位置
                    $('#engPos').combobox({
                        panelHeight: '60px',
                        data: jdata.data.ENG_POS,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //机号
                    $('#acReg').combobox({
                        panelHeight: '100px',
                        data: jdata.data.ENG_DA_ACNO,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (item) {
                            getActype(item.TEXT);
                        }
                    });
                    //检查部位 ENG_MCD_CHECK_POS checkPos
                    $('#checkPos').combobox({
                        panelHeight: '60px',
                        data: jdata.data.ENG_MCD_CHECK_POS,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (item) {
                            var epn = $("#epn").combobox('getValue');
                            var esn = $("#esn").combobox('getValue');
                            var checkDate = $("#checkDate").datebox('getValue');
                            if (epn == '' || esn == '' || checkDate == '') {
                                $("#checkPos").combobox('setValue', '');
                                MsgAlert({
                                    content: '请先选择发动机型号+发动机序号+检查日期！',
                                    type: 'error'
                                });
                            }
                            var checkPos = item.VALUE;
                            InitGatewayRequest_({
                                type: "get",
                                async: false,
                                path: "/meng-engine/EngMcdSet/selectEngMcdSetByEngTypeAndCheckPos/" + epn + "/" + checkPos,
                                successCallBack: function (jdata2) {
                                    if (jdata2.success == true) {
                                        if ("2" == jdata2.obj.objectType) { //附件
                                            var itemNo = jdata2.obj.itemNo;
                                            var epn = $("#epn").combobox('getValue');
                                            var esn = $("#esn").combobox('getValue');
                                            if (itemNo != '' && epn != '' && esn != '') {
                                                InitGatewayRequest_({
                                                    type: 'get',
                                                    async: false,
                                                    path: "/meng-engine/engMcdReport/selectBasPartByEpnEsnItemNo/" + epn + "/" + esn + "/" + itemNo,
                                                    successCallBack: function (jdata3) {
                                                        if (jdata3.success == true) {
                                                            if (jdata3.obj.length > 0) {
                                                                var partPn = jdata3.obj[0].llpPn;
                                                                var partSn = jdata3.obj[0].llpSn;
                                                                $("#partPn").textbox('setValue', partPn);
                                                                $("#partSn").textbox('setValue', partSn);
                                                                var checkDate = $("#checkDate").datebox('getValue');
                                                                if (partPn != '' && partSn != '' && checkDate != '') {
                                                                    InitGatewayRequest_({
                                                                        path: "/meng-engine/engMcdReport/getPartRelateInfoByPnSnDateTime",
                                                                        data: {
                                                                            "partPn": partPn,
                                                                            "partSn": partSn,
                                                                            "checkDate": checkDate,
                                                                        },
                                                                        async: false,
                                                                        successCallBack: function (jdata4) {
                                                                            if (jdata4.success == true) {
                                                                                var partTsn = jdata4.obj.partTsn;
                                                                                var partTso = jdata4.obj.partTso;
                                                                                var partTsr = jdata4.obj.partTsr;
                                                                                var partCsn = jdata4.obj.partCsn;
                                                                                var partCso = jdata4.obj.partCso;
                                                                                var partCsr = jdata4.obj.partCsr;
                                                                                $('#partTsn').textbox('setValue', partTsn);
                                                                                $('#partTso').textbox('setValue', partTso);
                                                                                $('#partTsr').textbox('setValue', partTsr);
                                                                                $('#partCsn').textbox('setValue', partCsn);
                                                                                $('#partCso').textbox('setValue', partCso);
                                                                                $('#partCsr').textbox('setValue', partCsr);
                                                                            } else {
                                                                                MsgAlert({
                                                                                    content: jdata4.errorMessage,
                                                                                    type: 'error'
                                                                                });
                                                                            }
                                                                        }
                                                                    });
                                                                }
                                                            }
                                                        } else {
                                                            MsgAlert({
                                                                content: '获取附件件序号失败！',
                                                                type: 'error'
                                                            });
                                                        }
                                                    }
                                                });
                                            }
                                        }
                                    } else {
                                        MsgAlert({
                                            content: '获取检查部位信息失败',
                                            type: 'error'
                                        });
                                    }
                                }
                            });
                        }
                    });
                    $("#checkName").MyComboGrid({
                        idField: 'PKID',  //实际选择值
                        textField: 'NAME', //文本显示值
                        panelWidth: '380px',
                        panelHeight: '200px',
                        params: {FunctionCode: 'GET_ENG_REPORT_CHECK_NAME'},
                        columns: [[
                            {field: 'ACCOUNT_NUMBER', title: '工号', width: 50},
                            {field: 'NAME', title: '姓名', width: 50},
                        ]],
                        onSelect: function (index, row) {
                            selectRow = row.NAME;
                            $("#checkName").combogrid('setValue', row.NAME);
                            $("#checkUser").val(row.PKID);
                        },
                        onHidePanel: function () {
                            var t = $(this).combogrid('getValue');
                            if (t != null && t != '' & t != undefined) {
                                if (selectRow == null || t != selectRow) {//没有选择或者选项不相等时清除内容
                                    alert('请选择，不要直接输入！');
                                    $(this).combogrid({value: ''});
                                }
                            }
                        }
                    });
                    //磁屑性质 ENG_MCD_MATE_CHIP_TYPE chipType
                    $('#chipType').combobox({
                        panelHeight: '60px',
                        data: jdata.data.ENG_MCD_MATE_CHIP_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //材料类别 ENG_MCD_MATE_TYPE mateType
                    $('#mateType').combobox({
                        panelHeight: '60px',
                        data: jdata.data.ENG_MCD_MATE_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //送检类别 ENG_MCD_REPAIR_TYPE repairType
                    $('#repairType').combobox({
                        panelHeight: '60px',
                        data: jdata.data.ENG_MCD_REPAIR_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //关注级别 ENG_BSI_MCD_ATT_LEVEL attLevel
                    $('#attLevle').combobox({
                        panelHeight: '60px',
                        data: jdata.data.ENG_BSI_MCD_ATT_LEVEL,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //报告结论 ENG_MCD_CHECK_RESULT resultType
                    $('#resultType').combobox({
                        panelHeight: '60px',
                        data: jdata.data.ENG_MCD_CHECK_RESULT,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //可能与上次送修有关 YESORNO
                    $('#lastRepairFlag').combobox({
                        panelHeight: '60px',
                        data: jdata.data.YESORNO,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //发动机型号
                    InitGatewayRequest_({
                        type: "get",
                        async: false,
                        path: "/meng-engine/baseOwn/getEngTypeNew",
                        successCallBack: function (jdata) {
                            if (jdata.success == true) {
                                $('#epn').combobox({
                                    data: jdata.obj,
                                    valueField: 'VALUE',
                                    textField: 'TEXT',
                                    panelHeight: '150px',
                                    onSelect: function (item) {
                                        //获取发动机序号
                                        InitGatewayRequest_({
                                            async: false,
                                            data: {matnr: item.VALUE},
                                            path: "/meng-engine/baseOwn/getEngByTypeNew",
                                            successCallBack: function (jdata) {
                                                if (jdata.success == true) {
                                                    $('#esn').combobox({
                                                        data: jdata.obj,
                                                        valueField: 'VALUE',
                                                        textField: 'TEXT',
                                                        panelHeight: '150px',
                                                        onSelect: function (item1) {
                                                            var checkDate = $("#checkDate").datebox('getValue');
                                                            if (checkDate != '') {
                                                                getEngRelateData(item.VALUE, item1.VALUE, checkDate);
                                                                getAcInfo(item1.VALUE, checkDate);
                                                            }
                                                            getCarNumber(item.VALUE, item1.VALUE);
                                                        }
                                                    });
                                                } else {
                                                    MsgAlert({content: '获取发动机序号列表失败', type: 'error'});
                                                }
                                            }
                                        });
                                        //获取检查部位
                                        InitGatewayRequest_({
                                            type: "get",
                                            async: false,
                                            path: "/meng-engine/EngMcdSet/selectEngMcdSetInfoByEngType/" + item.VALUE,
                                            successCallBack: function (jdata1) {
                                                if (jdata1.success == true) {
                                                    $('#checkPos').combobox({
                                                        data: jdata1.obj,
                                                        valueField: 'VALUE',
                                                        textField: 'TEXT',
                                                        panelHeight: '150px',
                                                        onSelect: function (item2) {
                                                            var epn = $("#epn").combobox('getValue');
                                                            var esn = $("#esn").combobox('getValue');
                                                            var checkDate = $("#checkDate").datebox('getValue');
                                                            if (epn == '' || esn == '' || checkDate == '') {
                                                                $("#checkPos").combobox('setValue', '');
                                                                MsgAlert({
                                                                    content: '请先选择发动机型号+发动机序号+检查日期！',
                                                                    type: 'error'
                                                                });
                                                            }
//                                                            var engType = item.VALUE;
                                                            var checkPos = item2.VALUE;
                                                            InitGatewayRequest_({
                                                                type: "get",
                                                                async: false,
                                                                path: "/meng-engine/EngMcdSet/selectEngMcdSetByEngTypeAndCheckPos/" + epn + "/" + checkPos,
                                                                successCallBack: function (jdata2) {
                                                                    if (jdata2.success == true) {
                                                                        if ("2" == jdata2.obj.objectType) { //附件
                                                                            var itemNo = jdata2.obj.itemNo;
                                                                            var epn = $("#epn").combobox('getValue');
                                                                            var esn = $("#esn").combobox('getValue');
                                                                            if (itemNo != '' && epn != '' && esn != '') {
                                                                                InitGatewayRequest_({
                                                                                    type: 'get',
                                                                                    async: false,
                                                                                    path: "/meng-engine/engMcdReport/selectBasPartByEpnEsnItemNo/" + epn + "/" + esn + "/" + itemNo,
                                                                                    successCallBack: function (jdata3) {
                                                                                        if (jdata3.success == true) {
                                                                                            if (jdata3.obj.length > 0) {
                                                                                                var partPn = jdata3.obj[0].llpPn;
                                                                                                var partSn = jdata3.obj[0].llpSn;
                                                                                                $("#partPn").textbox('setValue', partPn);
                                                                                                $("#partSn").textbox('setValue', partSn);
                                                                                                var checkDate = $("#checkDate").datebox('getValue');
                                                                                                if (partPn != '' && partSn != '' && checkDate != '') {
                                                                                                    InitGatewayRequest_({
                                                                                                        path: "/meng-engine/engMcdReport/getPartRelateInfoByPnSnDateTime",
                                                                                                        data: {
                                                                                                            "partPn": partPn,
                                                                                                            "partSn": partSn,
                                                                                                            "checkDate": checkDate,
                                                                                                        },
                                                                                                        async: false,
                                                                                                        successCallBack: function (jdata4) {
                                                                                                            if (jdata4.success == true) {
                                                                                                                var partTsn = jdata4.obj.partTsn;
                                                                                                                var partTso = jdata4.obj.partTso;
                                                                                                                var partTsr = jdata4.obj.partTsr;
                                                                                                                var partCsn = jdata4.obj.partCsn;
                                                                                                                var partCso = jdata4.obj.partCso;
                                                                                                                var partCsr = jdata4.obj.partCsr;
                                                                                                                $('#partTsn').textbox('setValue', partTsn);
                                                                                                                $('#partTso').textbox('setValue', partTso);
                                                                                                                $('#partTsr').textbox('setValue', partTsr);
                                                                                                                $('#partCsn').textbox('setValue', partCsn);
                                                                                                                $('#partCso').textbox('setValue', partCso);
                                                                                                                $('#partCsr').textbox('setValue', partCsr);
                                                                                                            } else {
                                                                                                                MsgAlert({
                                                                                                                    content: jdata4.errorMessage,
                                                                                                                    type: 'error'
                                                                                                                });
                                                                                                            }
                                                                                                        }
                                                                                                    });
                                                                                                }
                                                                                            }
                                                                                        } else {
                                                                                            MsgAlert({
                                                                                                content: '获取附件件序号失败！',
                                                                                                type: 'error'
                                                                                            });
                                                                                        }
                                                                                    }
                                                                                });
                                                                            }
                                                                        }
                                                                    } else {
                                                                        MsgAlert({
                                                                            content: '获取检查部位信息失败',
                                                                            type: 'error'
                                                                        });
                                                                    }
                                                                }
                                                            });
                                                        }
                                                    });
                                                } else {
                                                    MsgAlert({content: '获取检查部位列表失败', type: 'error'});
                                                }
                                            }
                                        });
                                    }
                                });
                            } else {
                                MsgAlert({content: '获取发动机型号列表失败', type: 'error'});
                            }
                        }
                    });
                    //检查日期
                    $('#checkDate').datebox({
                        onSelect: function (item) {
                            var epn = $("#epn").combobox('getValue');
                            var esn = $("#esn").combobox('getValue');
                            if (epn != '' && esn != '') {
                                getEngRelateData(epn, esn, item);
                            }
                        }
                    });
                    PAGE_DATA['engMcdMateType'] = DomainCodeToMap_(jdata.data["ENG_MCD_MATE_TYPE"]);
                    PAGE_DATA['engMcdMateChipType'] = DomainCodeToMap_(jdata.data["ENG_MCD_MATE_CHIP_TYPE"]);
                    PAGE_DATA['worknoType'] = DomainCodeToMap_(jdata.data["ENG_BUS_TYPE"]);
                    if (pkid) {
                        InitDataForm(pkid);
                        InitDataGrid(pkid);
                        InitDataGrid1(pkid);
                    } else {
                        InitDataGrid(-1);
                        InitDataGrid1(-1);
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

        if ("view" == operation) {
            $(".easyui-textbox").textbox({required: false, editable: false, onlyview: true});
            $(".easyui-combobox").combobox({required: false, editable: false, onlyview: true});
            $(".easyui-combogrid").combobox({required: false, editable: false, onlyview: true});
            $(".easyui-datebox").datebox({required: false, editable: false, onlyview: true});
            $("#saveBtn").hide();
        }
    }

    function getActype(acno){
        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/meng-engine/engMcdReport/selectDaAcregByAcno/" + acno,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#acType').combobox('setValue', jdata.obj.mpActype);
                    $("#acId").val(jdata.obj.acid)
                } else {
                    MsgAlert({content: '获取飞机主数据失败', type: 'error'});
                }
            }
        });
    }

    function InitDataGrid(pkid) {
        InitGatewayRequest_({
            type: "get",
            path: "/meng-engine/engMcdCheck/engMcdCheckListByMcId/" + pkid,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $("#dg").MyDataGrid({
                        identity: "dg",
                        pagination: false,
                        data: jdata.obj,
                        resize: function () {
                            return {width: 800, height: 140};
                        },
                        columns: {
                            param: {FunctionCode: 'ENG_MCD_CHECK_LIST'},
                            alter: {
                                mateType: {
                                    formatter: function (value) {
                                        return PAGE_DATA['engMcdMateType'][value];
                                    }
                                },
                                chipType: {
                                    formatter: function (value) {
                                        return PAGE_DATA['engMcdMateChipType'][value];
                                    }
                                }
                            }
                        },
                        contextMenus: [
                            {
                                id: "m-edit", i18nText: "编辑",
                                auth: "",
                                onclick: function () {
                                    var rowData = getDG('dg').datagrid('getSelected');
                                    if (!rowData.pkid) {
                                        MsgAlert({content: "请选择数据！", type: 'error'});
                                        return;
                                    }
                                    addOrEditEngMcdCheck('edit', rowData.pkid);
                                }
                            },
                            {
                                id: "m-delete", i18nText: "删除",
                                auth: "",
                                onclick: function () {
                                    var rowData = getDG('dg').datagrid('getSelected');
                                    if (!rowData.pkid) {
                                        MsgAlert({content: "请选择数据！", type: 'error'});
                                        return;
                                    }
                                    if (!confirm("是否确认删除？")) {
                                        return;
                                    }
                                    InitGatewayRequest_({
                                        type: "get",
                                        async: false,
                                        path: "/meng-engine/engMcdCheck/deleteEngMcdCheckByCheckId/" + rowData.pkid,
                                        successCallBack: function (jdata) {
                                            if (jdata.success == true) {
                                                MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                                                reload_(pkid);
                                            } else {
                                                MsgAlert({content: jdata.errorMessage, type: 'error'});
                                            }
                                        }
                                    });
                                }
                            }
                        ],
                        validAuth: function (row, items) {
                            if (operation == 'view') {
                                items['编辑'].display = false;
                                items['删除'].display = false;
                            }
                            return items;
                        },
                        onDblClickRow: function (index, field, value) {
                            addOrEditEngMcdCheck("view", value.pkid);
                        }
                    });
                } else {
                    MsgAlert({content: "检测报告信息集失败！", type: 'error'});
                }
            }
        });
    }

    function InitDataGrid1(pkid) {
        InitGatewayRequest_({
            type: "get",
            path: "/meng-engine/engBsiWorkno/listByPageInMcdReport/" + pkid,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $("#dg1").MyDataGrid({
                        identity: "dg1",
                        pagination: false,
                        data: jdata.obj,
                        resize: function () {
                            return {width: 800, height: 140};
                        },
                        columns: {
                            param: {FunctionCode: 'ENG_BSI_WORKNO_LIST'},
                            alter: {
                                createDate: {
                                    type: 'date'
                                },
                                worknoType: {
                                    formatter: function (value) {
                                        return PAGE_DATA['worknoType'][value];
                                    }
                                },
                            }
                        },
                        contextMenus: [
                            {
                                id: "m-delete", i18nText: "删除",
                                auth: "",
                                onclick: function () {
                                    var rowData = getDG('dg1').datagrid('getSelected');
                                    if (!rowData.pkid) {
                                        MsgAlert({content: "请选择数据！", type: 'error'});
                                        return;
                                    }
                                    if (!confirm("确认删除该记录？")) {
                                        return;
                                    }
                                    deleteWorkno(rowData.pkid);
                                }
                            }
                        ],
                        validAuth: function (row, items) {
                            return items;
                        },
                        validAuth: function (row, items) {
                            if (operation == 'view') {
                                items['删除'].display = false;
                            }
                            return items;
                        }
                    });
                } else {
                    MsgAlert({content: "获取后续措施信息失败！", type: 'error'});
                }
            }
        });
    }

    //保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate) {
            return;
        }
        var pkid = $("#pkid").val();
        var tsn = $("#tsn").textbox('getValue');
        var tso = $("#tso").textbox('getValue');
        var tsr = $("#tsr").textbox('getValue');
        var csn = $("#csn").textbox('getValue');
        var cso = $("#cso").textbox('getValue');
        var csr = $("#csr").textbox('getValue');

        if (tsn == '' || tso == '' || tsr == '' || csn == '' || cso == '' || csr == '') {
            MsgAlert({content: "发动机TSN,TSO,TSR,CSN,CSO,CSR不能为空，请选择发动机型号+序号+检查日期进行获取！", type: 'error'});
        }
        if (pkid) {
            operation = 'edit';
        }
        saveOrEditJobcard(operation);
    }

    function saveOrEditJobcard(operation) {
        var $form = $("#mform");
        var datas = $form.serializeObject();
        datas['operation'] = operation;
        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/engMcdReport/addOrEditEngMcdReport",
            data: datas,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    param.OWindow.reload_();
                    InitDataForm(jdata.obj.pkid);
                    $("#pkid").val(jdata.obj.pkid);
                } else {
                    MsgAlert({content: jdata.errorMsg, type: 'error'});
                }
            }
        });
    }

    //回显
    function InitDataForm(pkid) {
        $('#pkid').val(pkid);
        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/meng-engine/engMcdReport/engMcdReportInfoById/" + pkid,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    getCarNumber(jdata.obj.epn, jdata.obj.esn);
                    getCheckPosByEngType(jdata.obj.epn);
                    getEsnByEpn(jdata.obj.epn);
                    ParseFormField_(jdata.obj, $("#mform"));
                } else {
                    MsgAlert({content: jdata.errorMessage, type: 'error'});
                }
            }
        })
    }

    //录入-检测报告
    function addOrEditEngMcdCheck(operation, pkid) {
        var mcdReportId = $("#pkid").val();
        if (mcdReportId) {
            if ("view" == reportOperation) {
                if ("add" == operation) {
                    MsgAlert({content: "查看状态下不可添加检测报告", type: 'error'});
                } else {
                    var title_ = $.i18n.t('检测报告查看');
                    ShowWindowIframe({
                        width: "970",
                        height: "690",
                        title: title_,
                        param: {
                            operation: operation,
                            checkId: pkid,
                            mcdReportId: mcdReportId,
                            taskId: param.taskId,
                            userId: param.userId,
                            userName: param.userName
                        },
                        url: "/views/engine/engMcdReport/eng_mcd_check_add_edit.shtml"
                    });
                }
            } else {
                var title_ = $.i18n.t('检测报告录入');
                ShowWindowIframe({
                    width: "970",
                    height: "690",
                    title: title_,
                    param: {
                        operation: operation,
                        checkId: pkid,
                        mcdReportId: mcdReportId,
                        taskId: param.taskId,
                        userId: param.userId,
                        userName: param.userName
                    },
                    url: "/views/engine/engMcdReport/eng_mcd_check_add_edit.shtml"
                });
            }
        } else {
            MsgAlert({content: "请先保存当前检查报告！", type: 'error'});
        }
    }

    //刷新检测报告列表
    function reload_(pkid) {
        InitDataGrid(pkid);
    }

    //获取发动机相关数据(TSN, TSO, TSR, CSN.CSO, CSR);
    function getEngRelateData(epn, esn, checkDate) {
        InitGatewayRequest_({
            path: "/meng-engine/engMcdReport/getEngRelateInfoByPnSnDateTime",
            data: {
                "epn": epn,
                "esn": esn,
                "checkDate": checkDate,
            },
            async: false,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    var tsn = jdata.obj.tsn;
                    var tso = jdata.obj.tso;
                    var tsr = jdata.obj.tsr;
                    var csn = jdata.obj.csn;
                    var cso = jdata.obj.cso;
                    var csr = jdata.obj.csr;
                    $('#tsn').textbox('setValue', tsn);
                    $('#tso').textbox('setValue', tso);
                    $('#tsr').textbox('setValue', tsr);
                    $('#csn').textbox('setValue', csn);
                    $('#cso').textbox('setValue', cso);
                    $('#csr').textbox('setValue', csr);
                } else {
                    MsgAlert({content: jdata.errorMessage, type: 'error'});
                }
            }
        });
    }
    //根据检查日期和序号获取机号和位置
    function getAcInfo(esn, checkDate) {
        InitGatewayRequest_({
            path: "/meng-engine/baseOwn/getAcInfo",
            data: {
                "sernr": esn,
                "zzlidat": checkDate,
            },
            async: false,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    var acid = '';
                    var strno = '';
                    if(jdata.obj != null){
                        acid = jdata.obj.acid;
                        var acno = jdata.obj.msgrp;
                        strno = jdata.obj.strno;
                        var prio = jdata.obj.prio;
                        if (prio == 'INSTALLED' && strno) {
                            var pos = strno.substr(strno.length - 1, 1);
                            if (pos == 'U' || pos == 'L')
                                strno = 'APU';
                            else
                                strno = pos;
                        } else {
                            strno = "";
                        }
                        getActype(acno);
                    }

                    $('#acReg').combobox('setValue', acid);
                    $('#engPos').combobox('setValue', strno);

                } else {
                    MsgAlert({content: jdata.errorMessage, type: 'error'});
                }
            }
        });
    }

    //删除后续措施
    function deleteWorkno(pkid) {
        var cou = '';
        var datas = {"pkid": pkid};
        InitGatewayRequest_({
            async: false,
            data: datas,
            path: "/meng-engine/engBsiWorkno/deleteWorkno",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    cou = jdata.obj;
                    if (cou > 0) {
                        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        reload_1(pkid);
                    }
                } else {
                    MsgAlert({content: "删除失败!", type: 'error'});
                }
            }
        });
    }

    //刷新后续措施列表
    function reload_1(pkid) {
        InitDataGrid1(pkid);
    }

    //添加或编辑
    function addWorkno() {
        var esn = $('#esn').combobox('getValue');
        if (!pkid) {
            MsgAlert({content: "请先保存磁堵检查报告信息!", type: 'error'});
            return;
        }
        var title_ = $.i18n.t('添加或编辑-相关单据');
        ShowWindowIframe({
            width: "680",
            height: "650",
            title: title_,
            param: {pkid: pkid, busType: 'MCD',esn:esn},
            url: "/views/engine/engBsiReport/eng_bsi_workno_add.shtml"
        });
    }

    //获取工单号
    function getCarNumber(pn, sn) {
        InitGatewayRequest_({
            type: 'get',
            async: false,
            path: "/meng-engine/engMcdReport/getReportCarNo/" + pn + "/" + sn,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#jobCardNo').combobox({
                        data: jdata.obj,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '150px'
                    })
                } else {
                    MsgAlert({content: "获取工单号失败!", type: 'error'});
                }
            }
        });
    }

    //获取检查部位
    function getCheckPosByEngType(epn) {
        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/meng-engine/EngMcdSet/selectEngMcdSetInfoByEngType/" + epn,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#checkPos').combobox({
                        data: jdata.obj,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '150px'
                    })
                }
            }
        })
    }

    //表单回显时通过发动机型号获取发动机序号
    function getEsnByEpn(epn) {
        //获取发动机序号
        InitGatewayRequest_({
            async: false,
            data: {matnr: epn},
            path: "/meng-engine/baseOwn/getEngByTypeNew",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#esn').combobox({
                        data: jdata.obj,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '150px'
                    });
                } else {
                    MsgAlert({content: '获取发动机序号列表失败', type: 'error'});
                }
            }
        });
    }

    //流程最后一个节点可以操作该按钮
    function addKey(){
        checkKeyList();
    }

    function checkKeyList(){
        var esn = $("#esn").combobox('getValue');
        //超限报文
        var msg = '';
        var cflag = false;
        var datas = {'esn':esn,'sourceType':'2'};
        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/engPerKeylist/checkKeyList",
            data:datas,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    msg = jdata.obj;
                    if(msg != ''){
                        if (!confirm("当前发动机正在监控中["+msg+"]，是否继续添加新的监控条目？")) {
                            return;
                        }else{
                            cflag = true;
                        }
                    }else if(msg == ''){
                        alert("当前发动机无监控中条目，请先添加重点监控条目。");
                        cflag = true;
                    }
                    if(cflag){
                        addOrEditKeylist('add','');
                    }
                } else {
                    MsgAlert({content: "校验失败!", type: 'error'});
                }
            }
        });
        return msg;
    }

    //添加或编辑--重点监控清单
    function addOrEditKeylist(operation, pkid) {
        var esn = $("#esn").combobox('getValue');
        var flag = 'mcdReport';
        var title_ = $.i18n.t('添加或编辑--重点监控清单');
        ShowWindowIframe({
            width: "800",
            height: "580",
            title: title_,
            param: {operation: operation,flag:flag,esns:esn,dflag:'report',userName:userName,userId:userId},
            url: "/views/engine/engPerKeylist/eng_per_keylist_add_edit.shtml"
        });
    }

</script>
</body>
</html>