<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>详情页面-孔探报告</title>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
    <style type="text/css">
        td {
            padding: 2px;
        }

        button {
            width: 45px;
            height: 20px;
            margin-left: 3px;
            vertical-align: middle;
            border: 1px solid #cfcfcf;
            -moz-border-radius: 5px;
            border-radius: 5px;
            backgroud: #d5d5d5;
        }

        .addBtn {
            padding: 1px 10px;
        }
    </style>
</head>
<body>
<div style="width:95%;margin:0 auto;">
    <div class="ibox float-e-margins">
        <div id='msg'></div>
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <div id="p0" class="easyui-panel" title="孔探报告录入" style="width: 100%"></div>
                <input type="hidden" id="pkid" name="pkid"/>
                <input type="hidden" id="acReg" name="acReg"/>
                <input type="hidden" id="acType" name="acType"/>
                <input type="hidden" id="childConfig" name="childConfig"/>
                <input type="hidden" id="worker" name="worker"/>
                <input type="hidden" id="inspector" name="inspector"/>
                <input type="hidden" id="rechecker" name="rechecker"/>
                <input type="hidden" id="auditUser" name="auditUser"/>
                <input type="hidden" id="reportType" name="reportType"/>
                <input type="hidden" id="ifAbnormal" name="ifAbnormal"/>
                <table class="table table-bordered table-info" style="width: 100%">
                    <tr>
                        <td colspan="6" align="right" style="padding: 0;">
                            <input class="btn btn-primary" type="button" id="pdfBtn" onclick="print()" value="预览PDF" style="margin-right: 30px"/>
                            <input class="btn btn-primary" type="button" id="saveBtn" onclick="save()" value="保存" style="margin-right: 30px"/>
                            <input id = "cloBtn" class="btn btn-primary" type="button" onclick="CloseWindowIframe();" value="关闭"
                                   style="margin-left:3px;margin-right: 30px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th style="width: 80px">序号：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="esn" name="esn"
                                   data-options="required: true" style="width: 150px;"/>
                        </td>
                        <th style="width: 80px">发动机型号：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="epn" name="epn"
                                   data-options="required: true,editable:false" style="width: 150px;"/>
                        </td>
                        <th style="width: 80px">报告编号：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="reportNo" name="reportNo" data-options="editable:false,onlyview:true"
                                   style="width: 150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>机号：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="acId" name="acId" data-options="editable:false"
                                   style="width: 150px;"/>
                        </td>
                        <th>位置：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="position" name="position" data-options="editable:false"
                                   style="width: 150px;"/>
                        </td>
                        <th>工作者：</th>
                        <td  class="tdr">
                            <input class="easyui-combogrid" id="workerName" name="workerName"
                                   data-options="required: true" style="width: 150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>工作类别：</th>
                        <td colspan="3" class="tdr">
                            <input class="easyui-combobox" id="maintLevel" name="maintLevel"
                                   data-options="required: true,editable:false" style="width:  97%"/>
                        </td>
                        <th>工作日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="workDate" name="workDate"
                                   data-options="required: true,editable:false" style="width: 150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th rowspan="2"><a id="order" href="javascript:void(0)" onclick="orderNoList()"><span>工作指令号：</span></a></th>
                        <td rowspan="2" colspan="3">
                                <textarea class="easyui-textbox " id="workOrderNo" name="workOrderNo" multiline="true"
                                          style="height:60px;width: 97%;border: 1px solid #ddd;border-radius: 5px;"
                                          data-options="required: true"></textarea>
                        </td>
                        <th>检查者：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="inspectorName" name="inspectorName"
                                   data-options="editable:false,onlyview:true" style="width: 150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>检查日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="inspectionDate" name="inspectionDate"
                                   data-options="editable:false,onlyview:true" style="width: 150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>TSN：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="tsn" name="tsn"
                                   data-options="editable:false,onlyview:true" style="width: 150px;"/>
                        </td>
                        <th>CSN：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="csn" name="csn"
                                   data-options="editable:false,onlyview:true" style="width: 150px;"/>
                        </td>
                        <th>复核者：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="recheckerName" name="recheckerName" data-options="editable:false,onlyview:true"
                                   style="width: 150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>TSO：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="tso" name="tso"
                                   data-options="editable:false,onlyview:true" style="width: 150px;"/>
                        </td>
                        <th>CSO：</th>
                        <td class="tdr" style="width: 160px">
                            <input class="easyui-textbox" id="cso" name="cso"
                                   data-options="editable:false,onlyview:true" style="width: 150px;"/>
                        </td>
                        <th>复核日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="recheckDate" name="recheckDate"
                                   data-options="editable:false,onlyview:true" style="width: 150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>孔探部位：</th>
                        <td colspan="5">
                                <textarea class="easyui-textbox " id="area" name="area" multiline="true" data-options="editable:false,onlyview:true"
                                          style="height:60px;width: 97%;border: 1px solid #ddd;border-radius: 5px;"
                                          data-options=""></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="6" align="right" style="padding: 0;">
                            <input style="margin-right: 30px" class="btn btn-primary" type="button" id="subAddBtn" onclick="addOrEditDamage()"
                                   value="损伤录入"/>
                        </td>
                    </tr>

                </table>

                <table  id="tt">
                    <div id="dg" class="easyui-tabs" style="width:100%; height: 100%"></div>
                </table>
                <table class="table table-bordered table-info" style="width: 100%">
                    <tr>
                        <th>工程评估结论：</th>
                        <td colspan="3" class="tdr">
                            <input class="easyui-combobox" id="conclusion" name="conclusion"
                                   data-options="editable:false,onlyview:true" style="width: 150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>工程评估意见：</th>
                        <td colspan="3">
                                <textarea class="easyui-textbox " id="description" name="description" multiline="true" data-options="editable:false,onlyview:true"
                                          style="height:150px;width: 100%;border: 1px solid #ddd;border-radius: 5px;"
                                          data-options=""></textarea>
                        </td>
                    </tr>
                    ———————————————————————————————————————————————————————————————————————————————————————————
                    <tr style="height: 30px"></tr>
                </table>
                <div class="easyui-panel" title="发动机工程师评估" >
                    <table id="engEva" class="table table-bordered table-info" style="width: 100%">
                            <tr>
                                <th align="right" style="width: 90px;"><br/><br/><p style="font-weight: bold">工程评估结论：</p></th>
                                <td colspan="3" align="right" style="width: 50px;" style="padding: 0;">

                                    <div style="float:left;margin:5px;" id="one">
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;可用：
                                        <input type="checkbox" id="ma1" name="engProvAction" value="1" onclick="chooseMa(this.value)"/> 按正常间隔监控&nbsp;&nbsp;
                                    </div>
                                    <div style="float:left;margin:5px;" id="two">
                                        <input type="checkbox" id="ma2" name="engProvAction" data-options="" value="2"  onclick="chooseMa(this.value)" />
                                        缩短间隔&nbsp;&nbsp;
                                    </div>
                                    <div style="float:left;margin:5px;" id="four">
                                        <input type="checkbox" id="ma3" name="engProvAction" data-options="" value="3"  onclick="chooseMa(this.value)"/>超差放行&nbsp;&nbsp;
                                    </div>
                                    <div style="float:left;margin:5px;" id="five">
                                        <input type="checkbox" id="ma4" name="engProvAction" value="4"  onclick="chooseMa(this.value)"
                                        /> 在指定期限内拆发&nbsp;&nbsp;
                                    </div>
                                    <div style="margin-right:570px;" id="six">
                                        不可用：
                                        <input type="checkbox" id="ma5" name="engProvAction" data-options="" value="5"  onclick="chooseMa(this.value)"
                                        />立即拆发&nbsp;&nbsp;
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <th><br/><p style="font-weight: bold">工程评估意见：</p></th>
                                <td colspan="3">
                                    <textarea class="easyui-textbox " id="engProvDesc" name="engProvDesc" multiline="true"
                                              style="height:80px;width: 710px;border: 1px solid #ddd;border-radius: 5px;"
                                              data-options=""></textarea>
                                </td>
                            </tr>
                    </table>
                </div>
                <table>
                    <td  id="dealBtn">
                        处置方式：<input class="easyui-combobox" id="dealType" name="dealType" data-options="" style="width: 164px;"/>
                    </td>
                </table>
               
                <div id="tt1">
                    <div id="dg1" class="easyui-tabs" style="width:100%; height: 100%"></div>
                </div>
                <div>
                    <br>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    var PAGE_DATA = {};
    var param = {};
    var operation;
    var pkid;
    var userId;
    var userName;
    var isFlow;
    var taskId;
    var sourceType='1';

    function i18nCallBack() {
        param = getParentParam_();
        userId = param.userId;
        userName = param.userName;
        isFlow = param.isFlow;
        taskId = param.taskId;
        if(!userId){
            var userInfo = getLoginInfo();
            userId = userInfo.userId;
            userName = userInfo.userName;
        }
        operation = param.operation;
        pkid = param.pkid;
        $("#workDate").datebox('setValue',new Date().Format('yyyy-MM-dd'));
        $("#epn").combobox({required:true,editable:false,onlyview:true});
        $('#dealBtn').hide();
        $('#engEva').hide();
        InitFuncCodeRequest_({
            data: {
                domainCode: "ENG_POS,ENG_BSI_MAINT_LEVEL,ENG_BSI_RESULT,ENG_BUS_TYPE,ENG_OIL_DEAL_TYPE",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    PAGE_DATA['conclusion'] = DomainCodeToMap_(jdata.data["ENG_BSI_RESULT"]);
                    PAGE_DATA['worknoType'] = DomainCodeToMap_(jdata.data["ENG_BUS_TYPE"]);
                    InitGatewayRequest_({
                        async: false,
                        data: {},
                        path: "/meng-engine/engBsiReport/getAcnos",
                        successCallBack: function (jdata) {
                            if (jdata.success == true) {
                                $('#acId').combobox({
                                    data: jdata.obj,
                                    valueField: 'value',
                                    textField: 'text',
                                    panelHeight: '150px',
                                    onSelect: function (item) {
                                        assAcinfo(item.text);
                                    }
                                });
                            } else {
                                MsgAlert({content: '获取机号列表失败', type: 'error'});
                            }
                        }
                    });


                    InitGatewayRequest_({
                        async: false,
                        data:{matnr:""},
                        path: "/meng-engine/baseOwn/getEngByTypeNew",
                        successCallBack: function (jdata) {
                            if (jdata.success == true) {
                                $('#esn').combobox({
                                    data: jdata.obj,
                                    valueField: 'VALUE',
                                    textField: 'TEXT',
                                    panelHeight: '150px',
                                    onSelect: function (item) {
                                        InitGatewayRequest_({
                                            async: false,
                                            data:{serialnum:item.VALUE},
                                            path: "/meng-engine/baseOwn/getSernrBySn",
                                            successCallBack: function (jdata) {
                                                if (jdata.success == true) {
                                                    $('#epn').combobox('setValue',jdata.obj.partno);
                                                } else {
                                                    MsgAlert({content: '获取发动机型号失败', type: 'error'});
                                                }
                                            }
                                        });

                                        getMeasure(item.VALUE);
                                    }
                                });
                            } else {
                                MsgAlert({content: '获取发动机序号列表失败', type: 'error'});
                            }
                        }
                    });



                    $("#workerName").MyComboGrid({
                        idField: 'ACCOUNT_ID',  //实际选择值
                        textField: 'USER_NAME', //文本显示值
                        panelHeight: '220px',
                        width: 150,
                        params: { FunctionCode: 'FLOW_WORK_ACCOUNT'},
                        columns: [[
                            {field: 'ACCOUNT_NUMBER', title: '工号', width: 30},
                            {field: 'USER_NAME', title: '工作者', width: 30}
                        ]],
                        onHidePanel: function () {
                            var t = $(this).combogrid('getValue');
                            if (selectRow == null || t != selectRow.ACCOUNT_ID) {//没有选择或者选项不相等时清除内容
                                alert('请选择，不要直接输入！');
                                $(this).combogrid({value: ''});
                            }else{
                                $("#worker").val(selectRow.ACCOUNT_ID);
                                $("#workerName").textbox('setValue',selectRow.USER_NAME);
                            }
                        },
                        onSelect: function (index, row) {
                            selectRow = row;
                        }
                    });

                    $("#dealType").combobox({
                        panelHeight: '90px',
                        data: jdata.data.ENG_OIL_DEAL_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (item) {
                            checkKeyList(item.VALUE);
                        }
                    });
                    $('#position').combobox({
                        panelHeight: '150px',
                        data: jdata.data.ENG_POS,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#maintLevel').combobox({
                        panelHeight: '150px',
                        data: jdata.data.ENG_BSI_MAINT_LEVEL,
                        multiple: true,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $('#conclusion').combobox({
                        panelHeight: '150px',
                        data: jdata.data.ENG_BSI_RESULT,
                        multiple: true,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    if(operation == 'edit'){
                        $("#epn").combobox({required:true,editable:false,onlyview:true});
                        $("#esn").combobox({required:true,editable:false,onlyview:true});
                        $("#workDate").datebox({required:true,editable:false,onlyview:true});
                    }

                    $("#pdfBtn").hide();

                    if (operation == "view") {
                        $('#order').removeAttr('href');
                        $('#order').removeAttr('onclick');
                        $(".easyui-textbox").textbox({required: false, editable: false, onlyview: true});
                        $(".easyui-combobox").combobox({required: false, editable: false, onlyview: true});
                        $(".easyui-datebox").datebox({required: false, editable: false, onlyview: true});
                        $('#workerName').combogrid({required: false, editable: false, onlyview: true});
                        $("#saveBtn").hide();
                        $("#subAddBtn").hide();
                        $("#engEva").show();
                    }
                    if (pkid) {
                        InitDataForm(pkid);
                        getRes();
                    }

                    InitDataGrid();
                    InitDataGrid1();

                    if(isFlow && taskId == 'task1595321737184'){//孔探报告后续措施
                        $("#engEva").show();
                        $("#dealBtn").show();
                        $("#dealType").combobox({required:true,editable:false, onlyview: false});
                        $("#engProvDesc").textbox({editable:true, onlyview: false});
                        $("#saveBtn").show();
                    }

                    if(isFlow){
                       $('#cloBtn').hide();
                        $("#pdfBtn").show();
                    }
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }

    function assAcinfo(acno){
        $('#acReg').val(acno);
        InitGatewayRequest_({
            async: false,
            type:'get',
            path: "/meng-engine/engMcdReport/selectDaAcregByAcno"+"/"+acno,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    var ifGgy = jdata.obj.ifGgy;
                    if (ifGgy == 'Y'){
                        document.getElementById("msg").innerHTML = '<span style="color: Red">提示：该孔探检查涉及飞高高原的飞机，详细工作要求参照TB-71-0023。</span>';
                    }
                    $('#acType').val(jdata.obj.mpActype);
                } else {
                    MsgAlert({content: '获取机型失败', type: 'error'});
                }
            }
        });
    }


    function InitDataGrid() {
        var queryParams = $("#ffSearch").serializeObject();
        queryParams.bsiId = pkid;
        $('#dg').GatewayDataGrid({
            path: "/meng-engine/engBsiDamage/listByPage",
            async: false,
            queryParams: queryParams,
            identity: 'dg',
            idField: "pkid",
            pagination: true,
            title: $.i18n.t('损伤信息'),
            fitcolumn:true,
            resize: function () {
                return tabs_standard_resize($('#tt'), -300, 0.4, 0, 1);
            },
            columns: {
                param: {FunctionCode: 'ENG_BSI_DAMAGE_LIST'},
                alter: {
                    conclusion:{
                        formatter: function (value) {
                            return PAGE_DATA['conclusion'][value];
                        }
                    },
                    provAction:{
                        formatter: function (value, row, index) {
                            if(value){
                                value =  value.replace('1','按正常间隔检查');
                                value =  value.replace('2','缩短间隔');
                                value =  value.replace('3','超差放行');
                                value =  value.replace('4','在指定期限内拆发');
                                value =  value.replace('5','立即拆发');
                                value =  value.replace('6','需工程评估');
                            }
                            return value;
                        }
                    },
                    modifyDate: {
                        type: 'date'
                    },
                    createDate: {
                        type: 'date'
                    },
                    recheckDate: {
                        type: 'date'
                    },
                    auditDate: {
                        type: 'date'
                    },
                    workDate: {
                        type: 'date'
                    }
                }
            },
            contextMenus: [
                {
                    id: "m-edit", i18nText: "编辑",
                    auth: "",
                    onclick: function () {
                        var rowData = getDG('dg').datagrid('getSelected');
                        if (!rowData.pkid) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        addOrEditEngBsiDamage('edit',rowData);
                    }
                },
                {
                    id: "m-delete", i18nText: "删除",
                    auth: "",
                    onclick: function () {
                        var rowData = getDG('dg').datagrid('getSelected');
                        if (!rowData.pkid) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (!confirm("确认删除该记录？")) {
                            return;
                        }
                        deleteDamage(rowData.pkid);
                    }
                }
            ],
            onLoadSuccess: function (data) {

            },
            validAuth: function (row, items) {
                if(operation == "view"){
                    items['编辑'].display = false;
                    items['删除'].display = false;
                }
                return items;
            },
            onDblClickRow: function (index, field, value) {
                addOrEditEngBsiDamage('view',value);
            }
        });
    }

    function getMeasure(esn){
        $('#position').combobox('setValue','');
        var workDate = $('#workDate').datebox('getValue');
        var epn = $('#epn').combobox('getValue');
        if(workDate == null || workDate == ""){
            MsgAlert({content: '工作日期不能为空！', type: 'error'});
            $('#esn').combobox('setValue','');
            return;
        }
        //获取计量值
        InitGatewayRequest_({
            async: false,
            data:{epn:epn,esn:esn,workDate:workDate},
            path: "/meng-engine/engBsiReport/getMeasure",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                 var tsn = jdata.obj.tsn;
                 var tso = jdata.obj.tso;
                 var csn = jdata.obj.csn;
                 var cso = jdata.obj.cso;
                 $('#tsn').textbox('setValue',tsn);
                 $('#tso').textbox('setValue',tso);
                 $('#csn').textbox('setValue',csn);
                 $('#cso').textbox('setValue',cso);
                } else {
                    MsgAlert({content: '获取计量值失败', type: 'error'});
                }
            }
        });
        //获取 类型/机号/位置
        InitGatewayRequest_({
            async: false,
            data:{matnr:epn,sernr:esn},
            path: "/hanaMaterial/engInfo/getSubModel",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    if(jdata.obj != null){
                        var acno = jdata.obj.msgrp;
                        var eqart = jdata.obj.eqart;
                        var status = jdata.obj.prio;
                        var acId = jdata.obj.acid;
                        var position = jdata.obj.strno;
                        if(position != null){
                            position = position.substring(position.lastIndexOf("_")+1);
                            if(position != 'APU' && position != 'TAIL'){
                                position = position.substring(position.length - 1);
                            }
                        }
                        $('#reportType').val(eqart);
                        if(status == '2'){
                            $('#acId').combobox('setValue',acId);
                            $('#position').combobox('setValue',position);
                            assAcinfo(acno);
                        }
                    }
                } else {
                    MsgAlert({content: '获取信息失败', type: 'error'});
                }
            }
        });
    }

    //回显
    function InitDataForm(pkid) {
        $('#pkid').val(pkid);
        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/meng-engine/engBsiReport/selectById" + "/" + pkid,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    var ifGgy = jdata.obj.ifGgy;
                    if (ifGgy == 'Y'){
                        document.getElementById("msg").innerHTML = '<span style="color: Red">提示：该孔探检查涉及飞高高原的飞机，详细工作要求参照TB-71-0023。</span>';
                    }
                    ParseFormField_(jdata.obj, $("#mform"));
                    if(jdata.obj != null){
                        $(":checkbox").each(function () {
                            if($(this).attr('name') == 'engProvAction'){
                                var str = jdata.obj.engProvAction;
                                if(str){
                                    $(str.split(",")).each(function (i,dom){
                                        $(":checkbox[value='"+dom+"']").prop("checked",true);
                                    });
                                }
                            }
                        });
                    }
                } else {
                    MsgAlert({content: '操作失败', type: 'error'});
                }
            }
        });
    }

    //保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate) {
            return;
        }

        if(operation == 'add'){
            $("#reportNo").textbox('setValue', randomNumber());
        }
        var $form = $("#mform");
        var datas = $form.serializeObject();
        if (Array.isArray(datas['maintLevel'])) {
            datas['maintLevel'] = datas['maintLevel'].join(',');
        }

        if(taskId == 'task1595321737184'){
            var mark_value =[];
            $('input[name="engProvAction"]:checked').each(function(){
                mark_value.push($(this).val());
            });
            if(mark_value.length != 0){
                datas['engProvAction'] = mark_value.join(',');
            }
            var res = '';
            var str = '';
            if(mark_value != null && mark_value.length > 0){
                str = mark_value.join(',');
            }
            if(str != '' && str != null){
                if(str.indexOf("1") != -1 || str.indexOf("2") != -1  || str.indexOf("3") != -1 || str.indexOf("4") != -1){
                    res = '1';
                }else if(str.indexOf("5") != -1){
                    res = '2';
                }
            }else{
                MsgAlert({content: "评估结论为必填字段!", type: 'error'});
                return;
            }
            datas.engConclusion = res;
        }
        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/engBsiReport/checkUnique",
            data: datas,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    var data = jdata.obj;
                    if (data > 0) {
                        MsgAlert({content: "型号+序号+工作时间，不允许重复!", type: 'error'});
                        return;
                    }else{
                        msave(datas,"Y");
                    }
                } else {
                    MsgAlert({content: "校验唯一性失败!", type: 'error'});
                }
            }
        });
    }

    function msave(datas,flag){
        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/engBsiReport/addOrEditBsiReport",
            data: datas,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    var data = jdata.obj;
                    if (data != null) {
                        $('#pkid').val(data.pkid);
                        pkid = data.pkid;
                        operation = 'edit';
                        if(flag == 'Y'){
                            MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        }
                        if(!isFlow){
                            param.OWindow.reload_();
                        }
                    }
                } else {
                    MsgAlert({content: "保存失败!", type: 'error'});
                }
            }
        });
    }

    function randomNumber() {
        var esn = $('#esn').combobox('getValue');
        var num = 1;
        var workDate = $('#workDate').datebox('getValue');
        var dataStr = workDate.replace(/-/g,'');
        var serialNo = "BSI-" + dataStr+"-"+esn;
        return serialNo;
    }

    function orderNoList(){
        var epn = $("#epn").textbox('getValue');
        var esn = $('#esn').combobox('getValue');
        var workOrderNo = $("#workOrderNo").textbox('getValue');
        if(epn == "" || epn == null || esn == "" || esn == null){
            MsgAlert({content: "型号和序号都不能为空!", type: 'error'});
            return;
        }
        var title_ = $.i18n.t('工单号列表');
        ShowWindowIframe({
            width: "857",
            height: "610",
            title: title_,
            param: {pkid:pkid,operation: operation,pn:epn,sn:esn,nos:workOrderNo,userId:userId,userName:userName},
            url: "/views/engine/engBsiReport/eng_bsi_report_order_no.shtml"
        });
    }

    //添加或编辑
    function addOrEditDamage(operation,rowData){
        if(!pkid){
            MsgAlert({content: "请先保存孔探报告信息!", type: 'error'});
            return;
        }
        var epn = $('#epn').combobox('getValue');
        var title_ = $.i18n.t('添加或编辑-损伤');
        ShowWindowIframe({
            width: "900",
            height: "580",
            title: title_,
            param: {epn:epn,pkid:pkid},
            url: "/views/engine/engBsiReport/eng_bsi_damage_check.shtml"
        });
    }

    //刷新列表
    function reload_2(){
        InitDataGrid();
        getRes();
    }
    //刷新列表
    function reload_1(){
        InitDataGrid1();
    }

    //添加或编辑
    function addOrEditEngBsiDamage(operation,rowData){
        var epn = $('#epn').combobox('getValue');
        var esn = $('#esn').combobox('getValue');
        var pkid = rowData.pkid;
        var title_ = $.i18n.t('添加或编辑');
        ShowWindowIframe({
            width: "857",
            height: "610",
            title: title_,
            param: {pkid:pkid,operation: operation,"epn":epn,"esn":esn},
            url: "/views/engine/engBsiReport/eng_bsi_damage_add_edit.shtml"
        });
    }

    function getRes(){
        var $form = $("#mform");
        var res = '';
        var resFlow = 'N';//无异常 2级审批
        var memo = '';
        var tempArea = [];
        var ayyCon = [];
        var rows = [];
        InitGatewayRequest_({
            async: false,
            data:{"bsiId":pkid},
            path: "/meng-engine/engBsiDamage/getDamageList",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    rows = jdata.obj;
                } else {
                    MsgAlert({content: '获取缺陷列表失败', type: 'error'});
                }
            }
        });
        if(rows.length > 0){
            for(var i = 0;i<rows.length; i++){
                var row = rows[i];
                var conclusion = row.conclusion;
                var damagePath = row.damagePath;
                var provDesc = row.provDesc;
                var provAction = row.provAction;
                ayyCon.push(conclusion);
                if(provAction){
                    if(provAction.indexOf('1') == -1){
                        resFlow = 'Y';//异常 3级审批
                    }
                }
                memo = memo + damagePath + '\n' + provDesc + '\n';
                if(damagePath.indexOf('>') != -1){
                    var path = damagePath.substring(damagePath.indexOf('>')+1);
                    if(path.indexOf('>') != -1){
                        path = path.substring(0,path.indexOf('>'));
                    }
                    if(tempArea.indexOf(path) == -1){
                        tempArea.push(path);
                    }
                }
            }
        }else{
            return;
        }
        //优先级：不可用>待定>可用(2>3>1)
        if(ayyCon.indexOf('2') != -1){
            res = '2';
        }else if(ayyCon.indexOf('3') != -1){
            res = '3';
        }else if(ayyCon.indexOf('1') != -1){
            res = '1';
        }
        $('#ifAbnormal').val(resFlow);
        if(operation == 'edit'){
            $('#conclusion').combobox('setValue',res);
            $('#description').textbox('setValue',memo);
            $('#area').textbox('setValue',tempArea.join());
            var datas = $form.serializeObject();
            if (Array.isArray(datas['maintLevel'])) {
                datas['maintLevel'] = datas['maintLevel'].join(',');
            }
            msave(datas,"N");
        }
    }

    //删除
    function deleteDamage(pkid){
        var cou = '';
        var datas = {"pkid":pkid};
        InitGatewayRequest_({
            async: false,
            data:datas,
            path: "/meng-engine/engBsiDamage/deleteBsiDamage",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    cou = jdata.obj;
                    if(cou > 0){
                        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        reload_2();
                    }
                } else {
                    MsgAlert({content: "删除失败!", type: 'error'});
                }
            }
        });
    }

    //删除
    function deleteWorkno(pkid){
        var cou = '';
        var datas = {"pkid":pkid};
        InitGatewayRequest_({
            async: false,
            data:datas,
            path: "/meng-engine/engBsiWorkno/deleteWorkno",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    cou = jdata.obj;
                    if(cou > 0){
                        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        reload_1();
                    }
                } else {
                    MsgAlert({content: "删除失败!", type: 'error'});
                }
            }
        });
    }


    function InitDataGrid1() {
        var queryParams = $("#ffSearch").serializeObject();
        queryParams.busId = pkid;
        $('#dg1').GatewayDataGrid({
            path: "/meng-engine/engBsiWorkno/listByPage",
            async: false,
            queryParams: queryParams,
            identity: 'dg1',
            idField: "pkid",
            pagination: true,
            title: $.i18n.t('后续措施'),
            fitcolumn:true,
            fit:false,
            resize: function () {
                return tabs_standard_resize($('#tt'), -330, 0.4, 0, 1);
            },
            columns: {
                param: {FunctionCode: 'ENG_BSI_WORKNO_LIST'},
                alter: {
                    createDate: {
                        type: 'date'
                    },
                    worknoType: {
                        formatter: function (value) {
                            return PAGE_DATA['worknoType'][value];
                        }
                    },
                }
            },
            toolbar: [{
                id: 'btnAdd',
                text: $.i18n.t('录入'),//相关单据
                auth: "",
                iconCls: 'icon-add',
                handler: function () {
                    addWorkno();
                }
            }],
            contextMenus: [
                {
                    id: "m-delete", i18nText: "删除",
                    auth: "",
                    onclick: function () {
                        var rowData = getDG('dg1').datagrid('getSelected');
                        if (!rowData.pkid) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (!confirm("确认删除该记录？")) {
                            return;
                        }
                        deleteWorkno(rowData.pkid);
                    }
                }
            ],
            onBeforeLoad: function (data) {
                $("div.datagrid-toolbar [id ='btnAdd']").eq(0).hide();
                if(isFlow && (taskId == 'task1595321734943' || taskId == 'task1595321737184')){
                    $("div.datagrid-toolbar [id ='btnAdd']").eq(0).show();
                }
            },
        });
    }

    //添加或编辑
    function addWorkno(){
        var esn = $('#esn').combobox('getValue');
        if(!pkid){
            MsgAlert({content: "请先保存孔探报告信息!", type: 'error'});
            return;
        }
        var title_ = $.i18n.t('添加或编辑-相关单据');
        ShowWindowIframe({
            width: "680",
            height: "650",
            title: title_,
            param: {pkid:pkid,esn:esn},
            url: "/views/engine/engBsiReport/eng_bsi_workno_add.shtml"
        });
    }

    function print(){
        var url = '';
        var datas = {"pkid":pkid};
        InitGatewayRequest_({
            async: false,
            data:datas,
            path: "/meng-engine/engBsiReport/printBsiReport",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    url = jdata.obj;
                    if(url){
                        preview(url);
                    }else{
                        MsgAlert({content: "打印报错，请联系管理员!", type: 'error'});
                    }
                } else {
                    MsgAlert({content: "打印失败!", type: 'error'});
                }
            }
        });
    }

    //流程最后一个节点可以操作该按钮
    function dealSave(){


    }


    function preview(url) {
        var title_ = $.i18n.t('孔探报告');
        ShowWindowIframe({
            width: "850",
            height: "650",
            title: title_,
            param: {url: url},
            url: "/views/engine/engBsiReport/preview_pdf.shtml"
        });
    }


    function checkKeyList(dealType){
        var esns = $('#esn').combobox('getValue');
        var path = "";
        if(dealType == '3'){
            path = "/meng-engine/engPerKeylist/checkKeyList";
        }else if(dealType == '4'){
            path = "/meng-engine/engPerAlert/checkAlert";
        }
        var msg = '';
        var cflag = false;
        var datas = {'esn':esns,'sourceType':sourceType};
        InitGatewayRequest_({
            async: false,
            path: path,
            data:datas,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    msg = jdata.obj;
                    if(dealType == '3'){
                        if(msg != ''){
                            if (!confirm("当前发动机正在监控中["+msg+"]，是否继续添加新的监控条目？")) {
                                return;
                            }else{
                                cflag = true;
                            }
                        }else if(msg == ''){
                            alert("当前发动机无监控中条目，请先添加监控条目。");
                            cflag = true;
                        }
                    }else{
                        cflag = true;
                    }
                    if(cflag){
                        addOrEditKeylist('add',dealType);
                    }
                } else {
                    MsgAlert({content: "校验失败!", type: 'error'});
                }
            }
        });
    }

    function addOrEditKeylist(operation, dealType) {
        var flag = 'bsiReport';
        var esns = $('#esn').combobox('getValue');
        var path = '';
        var width = '';
        var height = '';
        if(dealType == '3'){
            //重点监控清单
            path = "/views/engine/engPerKeylist/eng_per_keylist_add_edit.shtml";
            width = '800';
            height = '580';
        }else if(dealType == '4'){
            //性能报警通知单
            path = "/views/engine/engPerAlert/eng_per_alert_add_edit.shtml";
            width = '920';
            height = '680';
        }
        var title_ = $.i18n.t('新增');
        ShowWindowIframe({
            width: width,
            height: height,
            title: title_,
            param: {operation: operation,flag:flag,esns:esns,userId:userId,userName:userName},
            url: path
        });
    }

    function reload_(){
        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
    }

    function chooseMa(val){
        if(val == '1' || val == '2' || val == '3' || val == '4'){
            $('#ma5').prop('checked', false);
            $('#ma6').prop('checked', false);
        }else if(val == '5'){
            $('#ma1').prop('checked', false);
            $('#ma2').prop('checked', false);
            $('#ma3').prop('checked', false);
            $('#ma4').prop('checked', false);
            $('#ma6').prop('checked', false);
        }
    }

    function checkEngProv(){
        var tem = '';
        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/meng-engine/engBsiReport/selectById" + "/" + pkid,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    if(jdata.obj != null){
                        var str = jdata.obj.engProvAction;
                        if(!str){
                            MsgAlert({content: "评估结论为必填字段，请先填写并点击右上角保存按钮!", type: 'error'});
                            tem = false;
                            return;
                        }else{
                            tem = true;
                        }
                    } else {
                        MsgAlert({content: '校验发动机评估措施失败', type: 'error'});
                        tem = false;
                        return;
                    }
                } else {
                    MsgAlert({content: '校验发动机评估措施失败', type: 'error'});
                    tem = false;
                    return;
                }
            }
        });
        top.jQuery('#tem').val(tem);
    }

</script>
</body>
</html>