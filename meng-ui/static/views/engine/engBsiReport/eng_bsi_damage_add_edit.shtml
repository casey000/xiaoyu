<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>详情页面</title>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
    <style type="text/css">
        td {
            padding: 2px;
        }

        button {
            width: 45px;
            height: 20px;
            margin-left: 3px;
            vertical-align: middle;
            border: 1px solid #cfcfcf;
            -moz-border-radius: 5px;
            border-radius: 5px;
            backgroud: #d5d5d5;
        }

        .addBtn {
            padding: 1px 10px;
        }
    </style>
</head>
<body>
<div style="width:95%;margin:0 auto;">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <div id="p0" class="easyui-panel" title="孔探损伤" style="width: 100%"></div>
                <input type="hidden" id="pkid" name="pkid"/>
                <input type="hidden" id="modifyUser" name="modifyUser"/>
                <input type="hidden" id="createUser" name="createUser"/>
                <table class="table table-bordered table-info" style="width: 100%">
                    <tr>
                        <td colspan="4" align="right" style="padding: 0;">
                            <input class="btn btn-primary" type="button" id="copyBtn" onclick="copyBsiDamage()" value="复制"/>
                            <input class="btn btn-primary" type="button" id="saveBtn" onclick="save()" value="保存"/>
                            <input class="btn btn-primary" type="button" onclick="CloseWindowIframe();" value="关闭"
                                   style="margin-left:3px;margin-right: 20px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th>损伤：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="damagePath" name="damagePath"
                                   data-options="required: true,editable:false,onlyview:true" style="width: 400px;"/>
                        </td>
                        <th style="width: 120px">与上次缺陷的对比：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="preCompare" name="preCompare"
                                   data-options="required: true,editable:false" style="width: 150px;"/>
                        </td>
                    </tr>
                    <tr>
                        <table  id="tt">
                            <div id="dg" class="easyui-tabs" style="width:100%; height: 100%"></div>
                        </table>
                    </tr>
                    <tr>
                        <th><br/><p style="font-weight: bold">缺陷补充描述：</p></th>
                        <td colspan="3">
                                <textarea class="easyui-textbox " id="damageDesc" name="damageDesc" multiline="true"
                                          style="height:80px;width: 98%;border: 1px solid #ddd;border-radius: 5px;"
                                          data-options=""></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="4" align="right" style="padding: 0;">
                            <input class="btn btn-primary" type="button" id="uploadBtn" onclick="uploadFile()" value="上传本次图片"/>
                            <input class="btn btn-primary" type="button" id="viewBtn" onclick="viewSame();" value="查看同一缺陷图片"
                                   style="margin-left:3px;margin-right: 20px;"/>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="4"  align="right" style="height:80px">
                            <table id="img">
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <th align="right" style="width: 90px;"><br/><br/><p style="font-weight: bold">评估结论：</p></th>
                        <td colspan="3" align="right" style="padding: 0;">
                            <table>
                                <tr>
                                    <th align="right" style="width: 160px;">可用：</th>
                                    <td >
                                        <div style="float:left;margin:5px;" id="one">
                                            <input type="checkbox" id="ma1" name="provAction" value="1" onclick="chooseMa(this.value)"/> 按正常间隔监控&nbsp;&nbsp;
                                        </div>
                                        <div style="float:left;margin:5px;" id="two">
                                            <input type="checkbox" id="ma2" name="provAction" data-options="" value="2"  onclick="chooseMa(this.value)" />
                                            缩短间隔&nbsp;&nbsp;
                                        </div>
                                        <div style="float:left;margin:5px;" id="four">
                                            <input type="checkbox" id="ma3" name="provAction" data-options="" value="3"  onclick="chooseMa(this.value)"/>超差放行&nbsp;&nbsp;
                                        </div>
                                        <div style="float:left;margin:5px;" id="five">
                                            <input type="checkbox" id="ma4" name="provAction" value="4"  onclick="chooseMa(this.value)"
                                            /> 在指定期限内拆发&nbsp;&nbsp;
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th align="right" style="width: 160px;">不可用：</th>
                                    <td >
                                        <div style="float:left;margin:5px;" id="six">
                                            <input type="checkbox" id="ma5" name="provAction" data-options="" value="5"  onclick="chooseMa(this.value)"
                                            />立即拆发&nbsp;&nbsp;
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <th align="right" style="width: 160px;">待定：</th>
                                    <td >
                                        <div style="float:left;margin:5px;" id="three">
                                            <input type="checkbox" id="ma6" name="provAction" data-options="" value="6"  onclick="chooseMa(this.value)"/>需工程评估&nbsp;&nbsp;
                                        </div>
                                    </td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                    <tr>
                        <th><br/><p style="font-weight: bold">评估描述：</p></th>
                        <td colspan="3">
                                <textarea class="easyui-textbox " id="provDesc" name="provDesc" multiline="true"
                                          style="height:80px;width: 100%;border: 1px solid #ddd;border-radius: 5px;"
                                          data-options=""></textarea>
                        </td>
                    </tr>
                    <tr>
                        <th><br/><br/><a id="order" href="javascript:void(0)" onclick="manualList()"><p style="font-weight: bold">手册标准：</p></a></th>
                        <td colspan="3">
                                <textarea class="easyui-textbox " id="resultBase" name="resultBase" multiline="true"
                                          style="height:80px;width: 100%;border: 1px solid #ddd;border-radius: 5px;"
                                          data-options="required: true"></textarea>
                        </td>
                    </tr>
                </table>
                <div style="height: 20px"></div>
            </form>
        </div>
    </div>
</div>
<script>
    var PAGE_DATA = {};
    var param = {};
    var operation;
    var pkid;
    var epn;
    var esn;
    var posDamageId;
    var arr = [];

    function i18nCallBack() {
        param = getParentParam_();
        operation = param.operation;
        pkid = param.pkid;
        epn = param.epn;
        esn = param.esn;

        InitFuncCodeRequest_({
            data: {
                domainCode: "ENG_BSI_DAMAGE_CON,ENG_BSI_POS_OR_CD,ENG_BSI_COMPARE_TYPE",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },async:false,
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    PAGE_DATA['posCd'] = DomainCodeToMap_(jdata.data["ENG_BSI_POS_OR_CD"]);
                    PAGE_DATA['compareType'] = DomainCodeToMap_(jdata.data["ENG_BSI_COMPARE_TYPE"]);
                    $('#preCompare').combobox({
                        panelHeight: '150px',
                        data: jdata.data.ENG_BSI_DAMAGE_CON,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    InitDataGrid();
                    if (operation == "view") {
                        $('#order').removeAttr('href');
                        $('#order').removeAttr('onclick');
                        $(".easyui-textbox").textbox({required: false, editable: false, onlyview: true});
                        $(".easyui-combobox").combobox({required: false, editable: false, onlyview: true});
                        $(".easyui-datebox").datebox({required: false, editable: false, onlyview: true});
                        $("#saveBtn").hide();
                        $("#copyBtn").hide();
                        $("#uploadBtn").hide();
                        $("#viewBtn").hide();
                        $('#ma1').prop('disabled', true);
                        $('#ma2').prop('disabled', true);
                        $('#ma3').prop('disabled', true);
                        $('#ma4').prop('disabled', true);
                        $('#ma5').prop('disabled', true);
                        $('#ma6').prop('disabled', true);
                    }

                    if(pkid){
                        InitDataForm();
                    }

                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });
    }


    function InitDataGrid() {
        var queryParams = {"damageId":pkid};
        $('#dg').GatewayDataGrid({
            path: "/meng-engine/engBsiDamageDetail/listByPage",
            async: false,
            queryParams: queryParams,
            identity: 'dg',
            idField: "pkid",
            pagination: true,
            title: $.i18n.t(''),
            fitcolumn:true,
            resize: function () {
                return tabs_standard_resize($('#tt'), -300, 0.4, 0, 1);
            },
            columns:[[
                {title:'位置或者特征尺寸',field:'posCdFlag',width:"100",
                    formatter: function(value,row,index){
                        return PAGE_DATA['posCd'][value];;
                    }},
                {title:'描述信息',field:'descInfo',width:"100"},
                {title: '符号', field: 'compareType', width:"70",
                    editor: {
                        type: 'combobox',
                        options: {
                            editable: false,
                            panelHeight: '180px',
                            valueField: 'VALUE',
                            textField: 'TEXT',
                            queryParams: {domainCode: "ENG_BSI_COMPARE_TYPE"},
                            url: Constant.API_URL + 'ANALYSIS_DOMAIN_BYCODE',
                            required: true,
                            loadFilter: function (jdata) {
                                var v = eval("jdata.data." + "ENG_BSI_COMPARE_TYPE");
                                return v;
                            },
                            tipPosition: 'top'
                        }
                    },
                    formatter: function (value) {
                        if(value){
                            return PAGE_DATA['compareType'][value];
                        }
                    }
                },
                {title:'数量',field:'num',width:"100",
                    editor : {
                        type : 'text',
                    },
                },
                {title:'单位',field:'unit',width:"100"},
            ]],
            onClickCell:onClickCell6,
            onAfterEdit:function (index, row, changes) {
                var pkid = row.pkid;
                var num = changes.num;
                var compareType = changes.compareType;
                if(!num){
                    num = row.num;
                }
                if(!compareType){
                    compareType = row.compareType;
                }
                var temp = pkid+";"+num+";"+compareType;
                if(isStrInArray(pkid,arr)){
                    var index = getIndex(pkid);
                    if(index != -1){
                        arr.splice(index,1);
                    }
                }
                arr.push(temp);
                row.editing = false;
                $('#dg').datagrid('refreshRow', index);
            },
            contextMenus: [
                {
                    id: "m-delete", i18nText: "删除",
                    auth: "",
                    onclick: function () {
                        var rowData = getDG('dg').datagrid('getSelected');
                        if (!rowData.pkid) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        if (!confirm("确认删除该记录？")) {
                            return;
                        }
                        deleteDamage(rowData.pkid);
                    }
                }
            ],
            validAuth: function (row, items) {
                return items;
            },
        });
    }

    function getIndex(pkid){
        var index = -1;
        for(var i = 0 ; i< arr.length ; i++){
            if(arr[i].indexOf(pkid) != -1){
                index = i;
            }
        }
        return index;
    }

    // 传入字符串 str ，数组 arr
    function isStrInArray(str, arr) {
        var n = arr.length;
        for (var i = 0; i < n; i++) {
            if (arr[i].indexOf(str) != -1) {
                return true;
            }
        }
        return false;
    }

    var editIndex = undefined;
    function onClickCell6(index, field){
        if (endEditing("#dg") && operation !== 'view'){
            $("#dg").datagrid('selectRow', index)
                .datagrid('editCell', {index:index,field:field});
            editIndex = index;
        }
    }

    function endEditing(dg){
        if (editIndex == undefined){return true}
        if ($(dg).datagrid('validateRow', editIndex)){
            $(dg).datagrid('endEdit', editIndex);
            editIndex = undefined;
            return true;
        } else {
            return false;
        }
    }

    $.extend($.fn.datagrid.methods, {

        editCell: function(jq,param){
            return jq.each(function(){
                var opts = $(this).datagrid('options');
                var fields = $(this).datagrid('getColumnFields',true).concat($(this).datagrid('getColumnFields'));
                for(var i=0; i<fields.length; i++){
                    var col = $(this).datagrid('getColumnOption', fields[i]);
                    col.editor1 = col.editor;
                    if (fields[i] != param.field){
                        col.editor = null;
                    }
                }
                $(this).datagrid('beginEdit', param.index);
                for(var i=0; i<fields.length; i++){
                    var col = $(this).datagrid('getColumnOption', fields[i]);
                    col.editor = col.editor1;
                }
            });
        }
    });



    //回显
    function InitDataForm() {
        $('#pkid').val(pkid);
        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/meng-engine/engBsiDamage/selectById" + "/" + pkid,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    ParseFormField_(jdata.obj, $("#mform"));
                    posDamageId = jdata.obj.posDamageId;
                    if(jdata.obj != null){
                        $(":checkbox").each(function () {
                            if($(this).attr('name') == 'provAction'){
                                var str = jdata.obj.provAction;
                                if(str){
                                    $(str.split(",")).each(function (i,dom){
                                        $(":checkbox[value='"+dom+"']").prop("checked",true);
                                    });
                                }
                            }
                        });
                    }
                    getImgs();
                } else {
                    MsgAlert({content: '操作失败', type: 'error'});
                }
            }
        });
    }

    function getImgs(){
        //加载图片
        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/engBsiDamage/getImgs",
            data:{"sourceId":pkid,"cat":"engBsiDamage"},
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    var imgs = jdata.obj;
                    if (imgs != null) {
                        var tbody = window.document.getElementById("img");
                        tbody.innerHTML = "";
                        var tdstr = "<tr>";
                        for(var i=0;i<imgs.length;i++){
                            if(operation == 'view'){
                                tdstr = tdstr + '<td ><img name="damage" style="width: 190px;height: 190px" src="'+imgs[i].url+'"  /></td>';
                            }else{
                                tdstr = tdstr + '<td ><img name="damage" style="width: 190px;height: 190px" src="'+imgs[i].url+'"  /> <br/> ' +
                                    '<img style="margin-left: 60px" width="60" height="60" onclick="delImage(' + imgs[i].pkid + ');return false;" src="del.png"/></td>';
                            }
                            if(i != 0 && (i+1) % 4 == 0){
                                tdstr = tdstr + "<tr/><tr>";
                            }
                            if(i == (imgs.length -1) && (i+1) % 4 != 0){
                                tdstr = tdstr + "<tr/>";
                            }
                        }
                        tbody.innerHTML = tdstr;
                    }
                } else {
                    MsgAlert({content: "保存失败!", type: 'error'});
                }
            }
        });
    }

    //保存
    function save() {
        var rows = $('#dg').datagrid('getRows');
        for (var i = 0; i < rows.length; i++) {
            $('#dg').datagrid('endEdit', i);
        }
        var isValidate = $("#mform").form('validate');
        if (!isValidate) {
            return;
        }

        var $form = $("#mform");
        var datas = $form.serializeObject();
        var rows = $('#dg').datagrid('getRows');
        var tempstr = "";
        if(arr.length > 0){
            tempstr = arr.join();
        }

        var mark_value =[];
        $('input[name="provAction"]:checked').each(function(){
            mark_value.push($(this).val());
        });
        if(mark_value.length != 0){
            datas['provAction'] = mark_value.join(',');
        }
        var res = '';
        var str = '';
        if(mark_value != null && mark_value.length > 0){
            str = mark_value.join(',');
        }
        if(str != '' && str != null){
            if(str.indexOf("1") != -1 || str.indexOf("2") != -1  || str.indexOf("3") != -1 || str.indexOf("4") != -1){
                res = '1';
            }else if(str.indexOf("5") != -1){
                res = '2';
            }else if(str.indexOf("6") != -1){
                res = '3';
            }
        }else{
            MsgAlert({content: "评估结论为必填字段!", type: 'error'});
            return;
        }
        datas.conclusion = res;
        datas.tempstr = tempstr;
        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/engBsiDamage/addOrEditBsiDamage",
            data: datas,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    var data = jdata.obj;
                    if (data != null) {
                        MsgAlert({content: jdata.msg ? jdata.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        param.OWindow.reload_2();
                    }
                } else {
                    MsgAlert({content: "保存失败!", type: 'error'});
                }
            }
        });
    }



    //刷新列表
    function reload_() {
        $("#dg").datagrid("reload");
    }

    function chooseMa(val){
        if(val == '1' || val == '2' || val == '3' || val == '4'){
            $('#ma5').prop('checked', false);
            $('#ma6').prop('checked', false);
        }else if(val == '5'){
            $('#ma1').prop('checked', false);
            $('#ma2').prop('checked', false);
            $('#ma3').prop('checked', false);
            $('#ma4').prop('checked', false);
            $('#ma6').prop('checked', false);
        }else if(val == '6'){
            $('#ma1').prop('checked', false);
            $('#ma2').prop('checked', false);
            $('#ma3').prop('checked', false);
            $('#ma4').prop('checked', false);
            $('#ma5').prop('checked', false);
        }
    }

    function copyBsiDamage(){
        var $form = $("#mform");
        var datas = $form.serializeObject();
        var res = $('#preCompare').combobox('getValue');
        if(res == '' || res == null){
            MsgAlert({content: "请先选择[与上次缺陷的对比]!", type: 'error'});
            return;
        }else{
            if(res == '3'){
                MsgAlert({content: "选择[新增损伤]不允许复制!", type: 'error'});
                return;
            }
        }
        if (confirm("确定复制吗")) {
            datas.epn = epn;
            datas.esn = esn;
            if(datas.provAction){
                if(Array.isArray(datas.provAction)){
                    datas.provAction = datas.provAction.join();
                }
            }
            InitGatewayRequest_({
                async: false,
                path: "/meng-engine/engBsiDamage/copyBsiDamage",
                data: datas,
                successCallBack: function (jdata) {
                    if (jdata.success == true) {
                        var msg = jdata.obj;
                        MsgAlert({content: msg, type: 'success'});
                        InitDataForm();
                        reload_();
                        param.OWindow.reload_();
                    } else {
                        MsgAlert({content: "复制失败!", type: 'error'});
                    }
                }
            });
        }
    }

    function uploadFile(){
        common_upload_({
            identity: 'dg',
            param: {
                cat: "engBsiDamage",
                sourceId: pkid,
                successCallBack: function () {
                    getImgs();
                },
                fialCellBack: ""
            }
        });
    }

    function common_upload_(edopt) {
        var title_ = _i18n.t('common:COMMON_OPERATION.UPLOAD');
        ShowWindowIframe({
            width: 900,
            height: 600,
            title: title_,
            param: $.extend({}, edopt.param),
            url: '/views/engine/engBsiReport/uploadImages.shtml'
        });
    }

    function viewSame() {
        var damagePath = $("#damagePath").textbox('getValue');
        var cou = 0;
        var orgName = prompt("请输入叶片编号", "");
        //加载图片
        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/engBsiDamage/viewSame",
            data:{epn:epn,esn:esn,damagePath:damagePath,orgName:orgName},
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    var imgs = jdata.obj;
                    if(imgs != null && imgs.length > 0){
                        ShowWindowIframe({
                            width: "857",
                            height: "610",
                            title: "查看同一缺陷图片",
                            param: {imgs:imgs},
                            url: "/views/engine/engBsiReport/eng_bsi_damage_view_same.shtml"
                        });
                    }else{
                        MsgAlert({content: "没有同一缺陷图片!", type: 'error'});
                    }
                } else {
                    MsgAlert({content: "查看失败!", type: 'error'});
                }
            }
        });
    }

    function delImage(pkid){
        deleteFile(pkid);
        getImgs();
    }

    function manualList(){
        var manualList = $("#resultBase").textbox('getValue');
        var title_ = $.i18n.t('手册标准列表');
        ShowWindowIframe({
            width: "600",
            height: "400",
            title: title_,
            param: {posDamageId:posDamageId,nos:manualList},
            url: "/views/engine/engBsiReport/eng_bsi_damage_manual.shtml"
        });
    }

    //删除
    function deleteDamage(pkid){
        var cou = '';
        var datas = {"pkid":pkid};
        InitGatewayRequest_({
            async: false,
            data:datas,
            path: "/meng-engine/engBsiDamageDetail/deleteDetail",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    cou = jdata.obj;
                    if(cou > 0){
                        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        reload_();
                    }
                } else {
                    MsgAlert({content: "删除失败!", type: 'error'});
                }
            }
        });
    }


</script>
</body>
</html>