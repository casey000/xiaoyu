<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>添加/编辑-超持续适航文件评估</title>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
    <style type="text/css">
        td {
            padding: 2px;

        }

        th {
            width: 120px;
        }

        button {
            width: 45px;
            height: 20px;
            margin-left: 3px;
            vertical-align: middle;
            border: 1px solid #cfcfcf;
            -moz-border-radius: 5px;
            border-radius: 5px;
            backgroud: #d5d5d5;
        }

    </style>
</head>
<body>
<div style="width:95%;margin:0 auto;">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <div id="p0" class="easyui-panel" title="超持续适航文件评估" style="width: 100%"></div>
                <input type="hidden" id="pkid" name="pkid"/>
                <input type="hidden" id="createUser" name="createUser"/>
                <input type="hidden" id="createName" name="createName"/>
                <input type="hidden" id="createDate" name="createDate"/>
                <input type="hidden" id="modifyUser" name="modifyUser"/>
                <input type="hidden" id="companyCode" name="companyCode"/>
                <input type="hidden" id="deleteFlag" name="deleteFlag"/>
                <input type="hidden" id="status" name="status"/>
                <table class="table table-bordered table-info" style="width: 100%">
                    <tr>
                        <td colspan="4" align="right" style="padding: 0;">
                            <input class="btn btn-primary" type="button" id="saveBtn" onclick="saveEngDevApply()"
                                   value="保存"/>
                            <input class="btn btn-primary" type="button" id="closeBtn" onclick="CloseWindowIframe();"
                                   value="关闭"
                                   style="margin-left:3px;margin-right: 20px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th>日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="applyDate" name="applyDate" data-options="required: true"
                                   style="width: 200px;"/>
                        </td>
                        <th>申请编号：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="applyNo" name="applyNo"
                                   data-options="required:false,editable:false,onlyview:true" style="width: 200px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th data-i18n="">机号：</th>
                        <td class="tdr">
                            <input class="easyui-combogrid" name="acno" id="acno"
                                   data-options="editable: true,required:true"
                                   style="width:200px;"/>
                        </td>
                        <th data-i18n="" style="width: 50px">机型：</th>
                        <td class="tdr">
                            <input class="easyui-combogrid" name="actype" id="actype"
                                   data-options="required:true"
                                   style="width:200px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th>发动机序号：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="esn" name="esn"
                                   data-options="editable: true,required:true"
                                   style="width: 200px;"/>
                        </td>
                        <th>发动机型号：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="epn" name="epn"
                                   data-options="onlyview:true"
                                   style="width: 200px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th>TSN：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="tsn" name="tsn"
                                   data-options="required:true,editable:true" style="width: 200px;"/>
                        </td>
                        <th>CSN：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="csn" name="csn"
                                   data-options="required:true,editable:true" style="width: 200px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th>是否缺陷：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="ifDefect" name="ifDefect"
                                   data-options="required:true,editable:false" style="width: 200px;"/>
                        </td>
                        <th>章节号：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="ata" name="ata"
                                   data-options="required:true,editable:false" style="width: 200px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th>依据文件：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="basisFile" name="basisFile"
                                   data-options="required:true,editable:true" style="width: 200px;"/>
                        </td>
                        <th>参考文件：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="referenceFile" name="referenceFile"
                                   data-options="required:true,editable:true" style="width: 200px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th>偏离类别：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="devType" name="devType"
                                   data-options="required:true,editable:false" style="width: 200px;"/>
                        </td>
                        <th>偏离类别_其他：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="devOther" name="devOther"
                                   data-options="required:false,editable:false,onlyview:true" style="width: 200px;"/>
                        </td>
                    </tr>


                    <tr>
                        <th>缺陷/偏离描述：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-textbox" id="devDesc" name="devDesc"
                                   data-options="required:true,multiline:true,required:true"
                                   style="width: 585px;height: 80px;"/>
                        </td>
                    </tr>

                    <tr id="applyResultTr">
                        <th>申请结果：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="applyResult" name="applyResult"
                                   data-options="required:true,editable:false" style="width: 200px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th>制造厂或OEM意见：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-textbox" id="oemComm" name="oemComm"
                                   data-options="required:true, multiline:true,required:true"
                                   style="width: 585px;height: 80px;"/>
                        </td>
                    </tr>

                    <tr id="fileUploadTr">
                        <th>附件：</th>
                        <td class="tdr" id='fileUploadTd'>
                        </td>
                    </tr>

                    <tr>
                        <th>工程师评估意见：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-textbox" id="evaComm" name="evaComm"
                                   data-options="multiline:true,required:false,editable:false,onlyview:true"
                                   style="width: 585px;height: 80px;"/>
                        </td>
                    </tr>


                    <tr>
                        <th>维护人：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="modifyName" name="modifyName" style="width: 200px;"
                                   data-options="onlyview:true,editable:false"/>
                        </td>
                        <th>维护日期：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="modifyDate" name="modifyDate" style="width: 200px;"
                                   data-options="onlyview:true,editable:false"/>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
</div>
<script>
    let param = getParentParam_();
    let operation = param.operation;
    let rowData = param.rowData;
    let nowDate = new Date();
    let nowFormatDate = nowDate.Format("yyyy-MM-dd");
    let isInputTsnOrCsn = false;
    let pkid = param.pkid;
    let userId;
    let userName;
    let ifFlow = param.ifFlow;
    let ifFist = false;

    function i18nCallBack() {
        ifFist = true;
        userId = param.userId;
        userName = param.userName;
        if (!userId) {
            const userInfo = getLoginInfo();
            userId = userInfo.accountId;
            userName = userInfo.userName;
        }

        //顺丰项目默认字符SFN
        $("#companyCode").val("SFN");
        InitFuncCodeRequest_({
            async: false,
            data: {
                domainCode:
                    "YESORNO,DM_ATA,ENG_DEV_APPLY_RESULT,ENG_DEV_TYPE,ENG_DA_ACNO,DA_FLEET",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jData) {
                if (jData.code == RESULT_CODE.SUCCESS_CODE) {
                    $("#applyResult").combobox({
                        panelHeight: '50px',
                        data: jData.data.ENG_DEV_APPLY_RESULT,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onChange: applyResultChange
                    });
                    //偏离类型
                    $("#devType").combobox({
                        panelHeight: '135px',
                        data: jData.data.ENG_DEV_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onChange: deviationCategoryChange
                    });
                    //章节号
                    $("#ata").combobox({
                        panelHeight: '135px',
                        data: jData.data.DM_ATA,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //是否缺陷
                    $('#ifDefect').combobox({
                        panelHeight: '80px',
                        data: jData.data.YESORNO,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    //申请日期选中事件，触发更新tsn和csn
                    $('#applyDate').datebox({
                        onSelect: function (date) {
                            parseMeasureByEsnANDEpn();
                        }
                    });
                    //机型
                    $('#actype').combobox({
                        panelHeight: '140px',
                        data: jData.data.DA_FLEET,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        multiple: true,
                        onSelect: function (date) {
                            setEsnOrAcNoStyle();
                        }
                    });
                    //机号
                    $('#acno').combobox({
                        panelHeight: '100px',
                        data: jData.data.ENG_DA_ACNO,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        multiple: true,
                        onSelect: function (date) {
                            setEsnOrAcNoStyle();
                        }
                    });


                    //绑定输入事件，输入后不在自动生成tsn和csn
                    $('#tsn').textbox('textbox').keydown(function (e) {
                        inputTsnOrCsn();
                    });
                    $('#csn').textbox('textbox').keydown(function (e) {
                        inputTsnOrCsn();
                    });

                    //初始化Esn和Epn
                    initEsnAndEpn();

                    //如果传入数据，将数据写入表单中
                    if (rowData) {
                        ParseFormField_(rowData, $("#mform"));
                        $('#acno').combobox({value: rowData.acno});
                        $('#actype').combobox({value: rowData.actype});
                        //当状态为6的数据进入时不可修改申请结果
                    } else if (operation != "add") {
                        $("#applyResult").combobox({required: false, editable: false, onlyview: true});
                        $("#closeBtn").hide();
                        const url = "/meng-engine/engDevApply/engDevApplyInfoById/" + pkid;
                        InitGatewayRequest_({
                            type: "get",
                            async: false,
                            path: url,
                            successCallBack: function (jData) {
                                if (jData.success == true) {
                                    ParseFormField_(jData.obj, $("#mform"));

                                } else {
                                    MsgAlert({content: jData.errorMessage, type: 'error'});
                                }
                            }
                        })
                    }
                } else {
                    MsgAlert({content: jData.msg, type: 'error'});
                }

            }
        });

        initFlowData();

        //非view操作需要刷新维护人信息
        if (operation != "view") {
            $("#modifyUser").val(userId);
            $("#modifyName").textbox('setValue', userName);
            $("#modifyDate").textbox('setValue', nowFormatDate);

            setEsnOrAcNoStyle();
        }

        ifFist = false;
    }

    //待数据处理完成后执行
    postProcessingByOperation(operation);

    //初始化flow数据，不显示申请结果框，显示附件
    function initFlowData() {
        if (ifFlow) {
            //申请结果框隐藏
            $("#applyResultTr").hide();
            //显示附件框
            $("#fileUploadTr").show();
            initFileUploadS();
        } else {
            $("#fileUploadTr").hide();
        }
    }

    //初始化fileUpload的值
    function initFileUploadS() {
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: $('#pkid').val(),
                CATEGORY: "ENGDEVAPPLY",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jData) {
                if (jData.code == 200) {
                    let html = "";
                    for (let i = 0; i < jData.data.length; i++) {
                        html += '<li  style="list-style-type:none;"><a target="_blank" style="text-decoration:underline;" onclick="downFile(' + jData.data[i].PKID + ')">' + jData.data[i].ORG_NAME + '</a></li>';

                    }
                    $('#fileUploadTd').html(html);
                }
            }
        });
    }

    //输入tsn或csn时更新全局变量为true
    function inputTsnOrCsn() {
        if (!isInputTsnOrCsn) {
            isInputTsnOrCsn = true;
        }
    }

    //初始化发动机型号和发动机序号
    function initEsnAndEpn() {
        InitGatewayRequest_({
            async: false,
            data: {matnr: ""},
            path: "/meng-engine/baseOwn/getEngByType",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#esn').combobox({
                        data: jdata.obj,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '150px',
                        onSelect: function (value) {
                            const data = {serialnum: value.VALUE};
                            if (value && value != '') {
                                InitGatewayRequest_({
                                    async: false,
                                    data: data,
                                    path: "/meng-engine/baseOwn/getSernrBySn",
                                    successCallBack: function (jData) {
                                        if (jData.success == true) {
                                            if (jData.obj) {
                                                $('#epn').combobox('setValue', jData.obj.partno);
                                            } else {
                                                $('#epn').combobox('setValue', '');
                                            }
                                            setEsnOrAcNoStyle();
                                            parseMeasureByEsnANDEpn();
                                        } else {
                                            MsgAlert({content: '获取发动机型号失败', type: 'error'});
                                        }
                                    }
                                })
                            } else {
                                $('#epn').combobox('setValue', '');
                                setEsnOrAcNoStyle();
                            }
                        }
                    });
                } else {
                    MsgAlert({content: '获取发动机序号列表失败', type: 'error'});
                }
            }
        });

    }

    //设置机号和发动机序号为必输入一个
    function setEsnOrAcNoStyle() {

        const esn = $("#esn").combobox("getValue");
        const acNo = $("#acno").combobox("getValues").join();
        const actype = $("#actype").combobox("getValues").join();

        if (esn && esn != '') {
            $("#esn").combobox({
                required: true, editable: true,
                value: $("#esn").combobox("getValue")
            });
            $("#acno").combobox({
                required: false, editable: true,
                value: $("#acno").combobox("getValues").join()
            });
            $("#actype").combobox({
                required: false, editable: true,
                value: $("#actype").combobox("getValues").join()
            });
        } else if (acNo && acNo != '') {
            $("#esn").combobox({
                required: false, editable: true,
                value: $("#esn").combobox("getValue")
            });
            $("#acno").combobox({
                required: true, editable: true,
                value: $("#acno").combobox("getValues").join()
            });
            $("#actype").combobox({
                required: false, editable: true,
                value: $("#actype").combobox("getValues").join()
            });

        } else if (actype && actype != '') {
            $("#esn").combobox({
                required: false, editable: true,
                value: $("#esn").combobox("getValue")
            });
            $("#acno").combobox({
                required: false, editable: true,
                value: $("#acno").combobox("getValues").join()
            });
            $("#actype").combobox({
                required: true, editable: true,
                value: $("#actype").combobox("getValues").join()
            });

        } else {
            $("#esn").combobox({
                required: true, editable: true,
                value: $("#esn").combobox("getValue")
            });
            $("#acno").combobox({
                required: true, editable: true,
                value: $("#acno").combobox("getValues").join()
            });
            $("#actype").combobox({
                required: true, editable: true,
                value: $("#actype").combobox("getValues").join()
            });
        }

    }

    //根据esn和epn获取到当前天的测量数据
    function parseMeasureByEsnANDEpn(ifAcno) {
        //如果人工输入了esn或者csn不在自动更新值
        if (isInputTsnOrCsn || ifFist) {
            return;
        }

        if (ifAcno) {
            getTsnAndCsnByAcno();
        } else {
            getTsnAndCsnByEpnAndEsn();
        }

    }

    //根据发动机序号 发动机型号 时间获取tsn和csn
    function getTsnAndCsnByEpnAndEsn() {
        const epn = $('#epn').combobox('getValue');
        const esn = $('#esn').combobox('getValue');
        const workerDate = $('#applyDate').datebox("getValue");
        if (epn == '' || esn == '' || workerDate == '') {
            return;
        }

        //获取计量值
        InitGatewayRequest_({
            async: false,
            data: {epn: epn, esn: esn, workDate: workerDate},
            path: "/meng-engine/engBsiReport/getMeasure",
            successCallBack: function (jData) {
                if (jData.success == true) {
                    $('#tsn').textbox('setValue', jData.obj.tsn);
                    $('#csn').textbox('setValue', jData.obj.csn);
                } else {
                    MsgAlert({content: '获取计量值失败', type: 'error'});
                }
            }
        });
    }

    //根据机号获取计量信息
    function getTsnAndCsnByAcno() {
        const acno = $('#acno').combobox('getText');
        InitFuncCodeRequest_({
            data: {
                ser_acReg: acno,
                rows: 1,
                page: 1,
                FunctionCode: 'FLB_QUERY'
            },
            successCallBack: function (jData) {
                if (jData.code == RESULT_CODE.SUCCESS_CODE) {
                    if (jData.data && jData.data.length) {
                        $('#tsn').textbox('setValue', jData.data[0].fhTotal);
                        $('#csn').textbox('setValue', jData.data[0].cyTotal);
                    }
                } else {
                    MsgAlert({content: jData.msgData ? jData.msgData[0] : jData.msg, type: 'error'});
                }
            }
        });
    }

    //根据不同操作执行不同后处理
    function postProcessingByOperation(operation) {
        if (operation == "add") {
            $("#createUser").val(userId);
            $("#createName").val(userName);
            $("#createDate").val(nowFormatDate);
        } else if (operation == "view") {
            $(".easyui-textbox").textbox({required: false, editable: false, onlyview: true});
            $(".easyui-combobox").combobox({required: false, editable: false, onlyview: true});
            $(".easyui-combogrid").combobox({required: false, editable: false, onlyview: true});
            $(".easyui-datebox").datebox({required: false, editable: false, onlyview: true});
            $("#saveBtn").hide();
        }
        if (rowData && rowData.status == 6) {
            $("#applyResult").combobox({required: false, editable: false, onlyview: true});
        }
    }

    //检查表单值是否合规
    function checkFromIsValidate() {
        const isValidate = $("#mform").form('validate');
        return isValidate;
    }

    //保存数据，修改或增加
    function saveEngDevApply() {
        const isValidate = checkFromIsValidate();
        if (!isValidate) {
            return;
        }
        const $form = $("#mform");
        const saveEngDevApplyParam = $form.serializeObject();
        if (Array.isArray(saveEngDevApplyParam['acno'])) {
            saveEngDevApplyParam['acno'] = saveEngDevApplyParam['acno'].join(',');
        }
        if (Array.isArray(saveEngDevApplyParam['actype'])) {
            saveEngDevApplyParam['actype'] = saveEngDevApplyParam['actype'].join(',');
        }

        if (saveEngDevApplyParam.applyResult == "2" && !confirm("针对厂商不同意的申请记录，在保存后将会直接归档，不能再次编辑修改，是否确定保存？")) {
            return;
        }

        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/engDevApply/saveEngDevApply",
            data: saveEngDevApplyParam,
            error: function (jData) {
                MsgAlert({content: jData.errorMessage ? jData.errorMessage : "增加偏离文件失败", type: 'error'});
            },
            successCallBack: function (jData) {
                if (jData.success == true) {
                    if (param.OWindow) {
                        param.OWindow.MsgAlert({content: jData.msg ? jData.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        param.OWindow.reload_();
                        CloseWindowIframe();
                    } else {
                        MsgAlert({content: jData.msg ? jData.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    }
                } else {
                    MsgAlert({content: jData.errorMessage ? jData.errorMessage : "增加偏离文件失败", type: 'error'});
                }
            }
        });

    }

    //偏差类别改变事件，【偏离类别_其它】字段，当偏离类别选择“其它”时，必填，否则，清空并不可编辑。
    function deviationCategoryChange(val) {
        if (operation != 'view') {
            if (val == '4') {
                $('#devOther').textbox({required: true, editable: true, onlyview: false});
            } else {
                $('#devOther').textbox({required: false, editable: false, onlyview: true});
                $('#devOther').textbox('setValue', '');
            }
        }
    }

    //申请结果改变事件，【工程师评估意见】字段，当申请结果选择“厂商同意”时，必填，否则，清空并不可编辑。
    function applyResultChange(val) {
        if (operation != 'view') {
            if (val == '1') {
                $('#evaComm').textbox({required: true, editable: true, onlyview: false});
                $("#status").val("1");
                if (operation == 'add') {
                    setApplyNo();
                }
            } else {
                $('#evaComm').textbox({required: false, editable: false, onlyview: false, onlyview: true});
                $('#evaComm').textbox('setValue', '');
                $("#status").val("5");
                if (operation == 'add') {
                    $('#applyNo').textbox('setValue', '');
                }
            }
        }
    }

    //设置applyNo的值根据后台返回结果设置
    function setApplyNo() {
        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/meng-engine/engDevApply/getApplyNo",
            error: function (jData) {
                MsgAlert({content: jData.obj ? jData.obj : "获取申请编号失败", type: 'error'});
            },
            successCallBack: function (jData) {
                if (jData.success == true) {
                    $("#applyNo").textbox('setValue', jData.obj);
                } else {
                    MsgAlert({content: jData.obj ? jData.obj : "获取申请编号失败", type: 'error'});
                }
            }
        });
    }

</script>
</body>
</html>