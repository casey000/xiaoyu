<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>预测调整</title>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
    <style type="text/css">
        td {
            padding: 2px;
        }

        button {
            width: 45px;
            height: 20px;
            margin-left: 3px;
            vertical-align: middle;
            border: 1px solid #cfcfcf;
            -moz-border-radius: 5px;
            border-radius: 5px;
            backgroud: #d5d5d5;
        }

        .addBtn {
            padding: 1px 10px;
        }
    </style>
</head>
<body>
<div style="width:95%;margin:0 auto;">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <form class="form-horizontal m-t" id="mform">
                <div id="p0" class="easyui-panel" title="换发预测调整" style="width: 100%"></div>
                <input type="hidden" id="pkid" name="pkid"/>
                <input type="hidden" id="modifyUser" name="modifyUser"/>

                <table class="table table-bordered table-info" style="width: 100%">
                    <tr>
                        <td colspan="8" align="right" style="padding: 0;">
                            <input class="btn btn-primary" type="button" id="saveBtn" onclick="save()" value="调整"/>
                            <input class="btn btn-primary" type="button" onclick="CloseWindowIframe();" value="关闭"
                                   style="margin-left:3px;margin-right: 20px;"/>
                        </td>
                    </tr>
                    <tr>

                        <th style="width: 120px;">指定拆下日期：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-datebox" id="appointRemoveDate" name="appointRemoveDate" style="width: 160px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th style="width: 120px;">调整原因：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-textbox" id="ardMemo" name="ardMemo" style="width: 620px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th style="width: 120px;">孔探报告剩余值：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="bsiResidualValue" name="bsiResidualValue" data-options="validType:['floatLength[8,2]']"
                                   style="width: 105px;"/>
                            <input class="easyui-combobox" id="bsiResidualUnit" name="bsiResidualUnit" data-options="editable:false" style="width: 50px;"/>
                        </td>
                        <th style="width: 120px;">孔探报告编号：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="bsiReportNo" name="bsiReportNo" data-options="editable:false" style="width: 160px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th style="width: 120px;">调整原因：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-textbox" id="bsiMemo" name="bsiMemo" style="width: 620px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th style="width: 120px;">磁堵报告剩余值：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="mcdResidualValue" name="mcdResidualValue" data-options="validType:['floatLength[8,2]']"
                                   style="width: 105px;"/>
                            <input class="easyui-combobox" id="mcdResidualUnit" name="mcdResidualUnit" data-options="editable:false" style="width: 50px;"/>
                        </td>
                        <th style="width: 120px;">磁堵报告编号：</th>
                        <td class="tdr">
                            <input class="easyui-combobox" id="mcdReportNo" name="mcdReportNo" data-options="editable:false" style="width: 160px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th style="width: 120px;">调整原因：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-textbox" id="mcdMemo" name="mcdMemo" style="width: 620px;"/>
                        </td>
                    </tr>

                    <tr>

                        <th style="width: 120px;">其他因素剩余值：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="comResidualFc" name="comResidualFc" data-options="validType:['floatLength[8,2]']" style="width: 105px;"/>
                            <input class="easyui-combobox" id="comResidualUnit" name="comResidualUnit" data-options="editable:false" style="width: 50px;"/>
                        </td>
                        <th style="width: 120px;">起始日期/计量值：</th>
                        <td class="tdr">
                            <input class="easyui-datebox" id="comStartDate" name="comStartDate" data-options="editable:false" style="width: 100px;"/>
                            <input class="easyui-textbox" id="comStartValue" name="comStartValue" data-options="validType:['floatLength[8,2]']" style="width: 60px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th style="width: 120px;">调整原因：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-textbox" id="comMemo" name="comMemo" style="width: 620px;"/>
                        </td>
                    </tr>

                    <tr>

                        <th style="width: 120px;">Target life延寿量：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-textbox" id="targetLifeFc" name="targetLifeFc" data-options="validType:['floatLength[8,2]']" style="width: 105px;"/>
                            <input class="easyui-combobox" id="targetLifeUnit" data-options="onlyview: true,editable:false" style="width: 50px;"/>
                        </td>
                    </tr>
                    <tr>
                        <th style="width: 120px;">调整原因：</th>
                        <td class="tdr" colspan="3">
                            <input class="easyui-textbox" id="targetLifeMemo" name="targetLifeMemo" style="width: 620px;"/>
                        </td>
                    </tr>

                    <tr>
                        <th style="width: 120px;">调整人：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="modifyName" name="modifyName" data-options="onlyview: true,editable:false"
                                   style="width: 160px;"/>
                        </td>
                        <th style="width: 120px;">调整日期：</th>
                        <td class="tdr">
                            <input class="easyui-textbox" id="modifyDate" name="modifyDate" data-options="onlyview: true,editable:false"
                                   style="width: 160px;"/>
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>
</div>
<script>
    var param = {};
    var rowData;
    var operation;
    var user;
    var esn;
    function i18nCallBack() {
        param = getParentParam_();
        rowData = param.rowData;
        esn = rowData.esn;
        user = getLoginInfo();
        operation = param.operation;

        $('#bsiResidualUnit').combobox({
            data: [{
                TEXT: ' ',
                VALUE: ' '
            },{
                TEXT: 'FC',
                VALUE: 'FC'
            },{
                TEXT: 'FH',
                VALUE: 'FH'
            }],
            valueField: 'VALUE',
            textField: 'TEXT',
            panelHeight: '50px',
        });

        $('#mcdResidualUnit').combobox({
            data: [{
                TEXT: '',
                VALUE: ''
            },{
                TEXT: 'FC',
                VALUE: 'FC'
            },{
                TEXT: 'FH',
                VALUE: 'FH'
            }],
            valueField: 'VALUE',
            textField: 'TEXT',
            panelHeight: '50px',
        });

        $('#comResidualUnit').combobox({
            data: [{
                TEXT: '',
                VALUE: ''
            },{
                TEXT: 'FC',
                VALUE: 'FC'
            },{
                TEXT: 'FH',
                VALUE: 'FH'
            }],
            valueField: 'VALUE',
            textField: 'TEXT',
            panelHeight: '50px',
        });

        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/meng-engine/engBsiReport/listBsiNoByEsn/"+esn,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#bsiReportNo').combobox({
                        data: jdata.obj,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '150px',
                    });
                } else {
                    MsgAlert({content: '获取孔探报告列表失败', type: 'error'});
                }
            }
        });

        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/meng-engine/engMcdReport/listMcdNoByEsn/"+esn,
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#mcdReportNo').combobox({
                        data: jdata.obj,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '150px',
                    });
                } else {
                    MsgAlert({content: '获取磁堵探报告列表失败', type: 'error'});
                }
            }
        });

        if (rowData) {
            InitDataForm(rowData);
        }

        var pos = rowData.curPos;
        if (pos == 'APU')
            $("#targetLifeUnit").combobox('setValue','FH');
        else
            $("#targetLifeUnit").combobox('setValue','FC');

        $("#modifyUser").val(user.accountId);
        $("#modifyName").textbox('setValue',user.userName);
        $("#modifyDate").textbox('setValue',new Date().Format("yyyy-MM-dd"));
    }

    //保存
    function save() {
        var isValidate = $("#mform").form('validate');
        if (!isValidate) {
            return;
        }
        saveOrUpdateData(operation);
    }

    function saveOrUpdateData(operation) {
        var $form = $("#mform");
        var datas = $form.serializeObject();

        if (datas.appointRemoveDate&&!datas.ardMemo){
            //alert("请填写指定拆下日期的调整原因！");
            $("#ardMemo").textbox({required:true});
            return;
        }

        if(datas.bsiResidualUnit||datas.bsiResidualValue){
            if(!datas.bsiReportNo||!datas.bsiResidualValue){
                alert("孔探编号和孔探报告剩余值都需要填写！");
                return;
            }

            if(!datas.bsiMemo){
                //alert("请填写孔探报告剩余值的调整原因！");
                $("#bsiMemo").textbox({required:true});
                return;
            }
        }

        if(datas.mcdResidualUnit||datas.mcdResidualValue){
            if(!datas.mcdReportNo||!datas.mcdResidualValue){
                alert("磁堵编号和磁堵报告剩余值都需要填写！");
                return;
            }
            if(!datas.mcdMemo){
                //alert("请填写磁堵报告剩余值的调整原因！");
                $("#mcdMemo").textbox({required:true});
                return;
            }
        }

        if(datas.comResidualUnit||datas.comResidualFc){
            if(!datas.comResidualFc||!datas.comStartDate||!datas.comStartValue){
                alert("其他因素剩余值、起始日期、起始计量值都需要填写！");
                return;
            }
            if(!datas.comMemo){
                //alert("请填写其他因素剩余值的调整原因！");
                $("#comMemo").textbox({required:true});
                return;
            }
        }

        if (datas.targetLifeFc&&!datas.targetLifeMemo){
            //alert("请填写Target life延寿量的调整原因！");
            $("#targetLifeMemo").textbox({required:true});
            return;
        }

            InitGatewayRequest_({
                async: false,
                path: "/meng-engine/rxForecast/updateForecast",
                data: datas,
                successCallBack: function (jdata) {
                    if (jdata.success == true) {
                        param.OWindow.MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        param.OWindow.onSearchClick();
                        CloseWindowIframe();
                    } else {
                        MsgAlert({content: jdata.errorMessage, type: 'error'});
                    }
                }
            });
    }

    //回显
    function InitDataForm(rowData) {
        ParseFormField_(rowData, $("#mform"));
    }
</script>
</body>
</html>