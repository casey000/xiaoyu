<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>防空停文件评估</title>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
    <style type="text/css">
        td {
            padding: 2px;

        }

        th {
            width: 120px;
        }

        button {
            width: 45px;
            height: 20px;
            margin-left: 3px;
            vertical-align: middle;
            border: 1px solid #cfcfcf;
            -moz-border-radius: 5px;
            border-radius: 5px;
            backgroud: #d5d5d5;
        }

    </style>
</head>
<body onunload="closeByOnunloadAssess()">
<div style="width:95%;margin:0 auto;">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <div id="p0" class="easyui-panel" title="防空停文件评估" style="width: 100%"></div>
            <table class="table table-bordered table-info" style="width: 100%">
                <tr>
                    <td colspan="4" align="right" style="padding: 0;">
                        <input class="btn btn-primary" type="button" id="saveBtn" onclick="saveEngFsdAssess()"
                               value="保存"/>
                        <input class="btn btn-primary" type="button" id="submitBtn" onclick="submitEngFileAssessFlow()"
                               value="提交"/>
                        <input class="btn btn-primary" type="button" id="closeBtn" onclick="closeOrReloadAssess()"
                               value="关闭"
                               style="margin-left:3px;margin-right: 20px;"/>
                    </td>
                </tr>
            </table>

            <fieldset class="fieldset_eui">
                <legend data-i18n="">文件信息</legend>
                <div class="ibox-content">
                    <form class="form-horizontal m-t" id="engFsdFileForm">
                        <table class="table table-bordered table-info" style="width: 100%">
                            <tr>
                                <th>文件类型：</th>
                                <td class="tdr">
                                    <input class="easyui-combobox" id="fileType" name="fileType"
                                           data-options="onlyview:true,editable:false"
                                           style="width: 200px;"/>
                                </td>
                                <th>原文件：</th>
                                <td class="tdr" target="_blank" style="text-decoration:underline;">
                                    <a id='fileUpload'>
                                    </a>
                                </td>
                            </tr>

                            <tr>
                                <th>标题：</th>
                                <td class="tdr" colspan="3">
                                    <input class="easyui-textbox" id="title" name="title"
                                           data-options="onlyview:true,editable:false"
                                           style="width: 585px;"/>
                                </td>
                            </tr>

                            <tr>
                                <th>备注：</th>
                                <td class="tdr" colspan="3">
                                    <input class="easyui-textbox" id="fileDesc" name="fileDesc"
                                           data-options="onlyview:true,editable:false"
                                           style="width: 585px;height: 40px;"/>
                                </td>
                            </tr>


                            <tr>
                                <th>创建人：</th>
                                <td class="tdr">
                                    <input class="easyui-textbox" name="createName"
                                           style="width: 200px;"
                                           data-options="onlyview:true,editable:false"/>
                                </td>
                                <th>创建日期：</th>
                                <td class="tdr">
                                    <input class="easyui-datebox" name="createDate"
                                           style="width: 200px;"
                                           data-options="onlyview:true,editable:false"/>
                                </td>
                            </tr>
                        </table>
                    </form>
                </div>
            </fieldset>
            <fieldset class="fieldset_eui">
                <legend data-i18n="">评估信息</legend>
                <div class="ibox-content">
                    <form class="form-horizontal m-t" id="engFsdFileAssessFrom">
                        <input type="hidden" id="pkid" name="pkid"/>
                        <input type="hidden" id="createUser" name="createUser"/>
                        <input type="hidden" id="status" name="status"/>
                        <table class="table table-bordered table-info" style="width: 100%">
                            <tr>
                                <th>评估结论：</th>
                                <td class="tdr">
                                    <input class="easyui-combobox" id="result" name="result"
                                           data-options="required: true,editable:false"
                                           style="width: 200px;"/>
                                </td>
                                <th>机型：</th>
                                <td class="tdr">
                                    <input class="easyui-combobox" id="acType" name="acType"
                                           data-options="onlyview:true,editable:false"
                                           style="width: 200px;"/>
                                </td>
                            </tr>

                            <tr>
                                <th>评估描述：</th>
                                <td class="tdr" colspan="3">
                                    <input class="easyui-textbox" id="content" name="content"
                                           data-options=" multiline:true"
                                           style="width: 585px;height: 40px;"/>
                                </td>
                            </tr>


                            <tr>
                                <th>评估人：</th>
                                <td class="tdr">
                                    <input class="easyui-textbox" id="createName" name="createName"
                                           style="width: 200px;"
                                           data-options="onlyview:true,editable:false"/>
                                </td>
                                <th>评估日期：</th>
                                <td class="tdr">
                                    <input class="easyui-datebox" id="createDate" name="createDate"
                                           style="width: 200px;"
                                           data-options="onlyview:true,editable:false"/>
                                </td>
                            </tr>
                        </table>
                    </form>
                </div>
            </fieldset>
            <fieldset class="fieldset_eui">
                <legend data-i18n="">评估信息</legend>
                <div id="tt" class="easyui-tabs ibox-content" style="width: 775px;height: 255px">
                    <div title="工程文件措施" style="width: 100%;height: 100%">
                        <table class="table table-bordered table-info">
                            <tr>
                                <td align="right">
                                    <a class="searchBtn" onclick="addOrEditAssessTech('add')"
                                       data-options="iconCls:'icon-clear'" style="margin-left:3px;margin-right: 10px;"
                                       id="addBtn1"
                                    >
                                        <span data-i18n="">增加</span></a>
                                </td>
                            </tr>
                        </table>
                        <table id="dg1"></table>
                    </div>

                    <div title="措施库措施" style="display:none;" id="searchBar3" style="width: 100%;height: 100%">
                        <table class="table table-bordered table-info">
                            <tr>
                                <td align="right">
                                    <a class="searchBtn" onclick="addOrEditAssessProv('add')"
                                       data-options="iconCls:'icon-clear'" style="margin-left:3px;margin-right: 10px;"
                                       id="addBtn2"
                                    >
                                        <span data-i18n="">增加</span></a>
                                </td>
                            </tr>
                        </table>
                        <table id="dg2"></table>
                    </div>
                </div>
            </fieldset>

        </div>
    </div>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script>
    let param = getParentParam_();
    let operation = param.operation;
    let rowData = param.rowData;
    let rowDataM = param.rowDataM;
    let isListEnter = param.isListEnter;
    let type = param.type;
    let assessPkid;
    let userId;
    let userName;
    let nowDate = new Date();
    let nowFormatDate = nowDate.Format("yyyy-MM-dd");
    let PAGE_DATA = {};

    function i18nCallBack() {
        userId = param.userId;
        userName = param.userName;
        if (!userId) {
            const userInfo = getLoginInfo();
            userId = userInfo.accountId;
            userName = userInfo.userName;
        }
        initBasicData();

        if (rowData.status != '1' && rowData.status != null && rowData.status != '') {
            $("#submitBtn").hide();
            $("#result").combobox({required: false, editable: false, onlyview: true});
        }

        //如果传入数据，将数据写入表单中
        initFuncCode();
        assessPkid = rowData.pkid;
        if (rowDataM) {
            ParseFormField_(rowDataM, $("#engFsdFileForm"));
        }
        if (rowData) {
            ParseFormField_(rowData, $("#engFsdFileAssessFrom"));
        }

        initUserInfo();
        initFileUpload();
        initDataGrid1();
        initDataGrid2();

    }

    function initBasicData() {
        if (!rowData) {
            const url = "/meng-engine/engFsdAssess/engFsdAssessInfoById/" + param.pkid;
            InitGatewayRequest_({
                type: "get",
                async: false,
                path: url,
                successCallBack: function (jData) {
                    if (jData.success == true) {
                        rowData = jData.obj;
                    } else {
                        MsgAlert({content: jData.errorMessage, type: 'error'});
                    }
                }
            })
        }
        if (!rowDataM) {
            const url = "/meng-engine/engFsdFile/engFsdFileInfoById/" + param.refPkid;
            InitGatewayRequest_({
                type: "get",
                async: false,
                path: url,
                successCallBack: function (jData) {
                    if (jData.success == true) {
                        rowDataM = jData.obj;
                    } else {
                        MsgAlert({content: jData.errorMessage, type: 'error'});
                    }
                }
            })
        }


    }

    //初始化文件信息
    function initFileUpload() {
        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: rowDataM.pkid,
                CATEGORY: "ENGFSDFILE",
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            successCallBack: function (jData) {
                if (jData.code === RESULT_CODE.SUCCESS_CODE) {
                    for (let i = 0; i < jData.data.length; i++) {
                        $('#fileUpload').unbind('click').removeAttr('onclick').click(function () {
                            downFile(jData.data[i].PKID);
                        });
                        $('#fileUpload').text(jData.data[i].ORG_NAME);
                    }
                }
            }
        });
    }

    //初始化数据字段数据
    function initFuncCode() {
        InitFuncCodeRequest_({
            async: false,
            data: {
                domainCode:
                    "ENG_FSD_FILE_TYPE,ENG_FSD_ASSESS_RESULT,ENG_FSD_PROV_SOURCE",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jData) {
                if (jData.code == RESULT_CODE.SUCCESS_CODE) {
                    PAGE_DATA['source'] = DomainCodeToMap_(jData.data["ENG_FSD_PROV_SOURCE"]);
                    $("#fileType").combobox({
                        panelHeight: '140px',
                        data: jData.data.ENG_FSD_FILE_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#result").combobox({
                        panelHeight: '140px',
                        data: jData.data.ENG_FSD_ASSESS_RESULT,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        onSelect: function (rec) {
                            resultOnSelect(rec)
                        }
                    });
                } else {
                    MsgAlert({content: jData.msg, type: 'error'});
                }

            }
        });
    }

    function resultOnSelect(resultOnSelect) {
        if (resultOnSelect.VALUE == '2') {
            $("#content").textbox({required: true});
        } else {
            $("#content").textbox({required: false});
        }
    }

    //删除工程文件措施信息
    function deleteEngFsdAssessTech(pkid) {
        const data = {"pkid": pkid};
        InitGatewayRequest_({
            async: false,
            data: data,
            path: "/meng-engine/engFsdAssessTech/deleteEngFsdAssessTech",
            successCallBack: function (jData) {
                if (jData.success == true) {
                    const cou = jData.obj;
                    if (cou > 0) {
                        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        reload_('dg1');
                    }
                } else {
                    MsgAlert({content: "删除失败!", type: 'error'});
                }
            }
        });
    }

    //初始化工程文件措施信息
    function initDataGrid1() {
        const queryParams = {refPkid: assessPkid};
        $("#dg1").GatewayDataGrid({
            identity: 'dg1',
            sortable: true,
            singleSelect: true,
            queryParams: queryParams,
            pageSize: 15,
            path: "/meng-engine/engFsdAssessTech/listByPage",
            resize: function () {
                return tabs_standard_resize($('#tt'), 0, 0, 20, 0);
            },
            columns: {
                param: {FunctionCode: 'ENG_FSD_ASSESS_TECH_LIST'}
            },
            contextMenus: [
                {
                    id: "m-delete",
                    i18nText: "删除",
                    onclick: function () {
                        const rowData = getDG('dg1').datagrid('getSelected');
                        if (!rowData.pkid) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        deleteEngFsdAssessTech(rowData.pkid);
                    }
                }
            ],
            validAuth: function (row, items) {
                //查看是不可删除
                if (operation == 'view') {
                    items['删除'].enable = false;
                    items['删除'].hide();
                }
                return items;
            }
        });
    }

    //删除措施库措施信息
    function deleteEngFsdAssessProv(pkid) {
        const data = {"pkid": pkid};
        InitGatewayRequest_({
            async: false,
            data: data,
            path: "/meng-engine/engFsdAssessProv/deleteEngFsdAssessProv",
            successCallBack: function (jData) {
                if (jData.success == true) {
                    const cou = jData.obj;
                    if (cou > 0) {
                        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        reload_('dg2');
                    }
                } else {
                    MsgAlert({content: "删除失败!", type: 'error'});
                }
            }
        });
    }

    //初始化措施库信息
    function initDataGrid2() {
        const queryParams = {refPkid: assessPkid};
        $("#dg2").GatewayDataGrid({
            identity: 'dg2',
            idField: "pkid",
            queryParams: queryParams,
            pagination: true,
            path: "/meng-engine/engFsdAssessProv/listByPage",
            resize: function () {
                return tabs_standard_resize($('#tt'), 0, 0, 20, 0);
            },
            columns: {
                param: {FunctionCode: 'ENG_FSD_ASSESS_PROV_LIST'},
                alter: {
                    source: {
                        formatter: function (value) {
                            return PAGE_DATA['source'][value];
                        }
                    },
                    createDate: {
                        type: 'date'
                    }
                }
            },
            contextMenus: [
                {
                    id: "m-delete",
                    i18nText: "删除",
                    onclick: function () {
                        const rowData = getDG('dg2').datagrid('getSelected');
                        if (!rowData.pkid) {
                            MsgAlert({content: "请选择数据！", type: 'error'});
                            return;
                        }
                        deleteEngFsdAssessProv(rowData.pkid);
                    }
                }
            ],
            validAuth: function (row, items) {
                //查看是不可删除
                if (operation == 'view') {
                    items['删除'].enable = false;
                    items['删除'].hide();
                }
                return items;
            }
        });
    }

    //初始化维护人信息
    function initUserInfo() {
        if (operation == 'add' || operation == 'edit') {
            $("#createUser").val(userId);
            $("#createName").textbox('setValue', userName);
            $("#createDate").textbox('setValue', nowFormatDate);
        }
    }


    //根据不同操作执行不同后处理
    function postProcessingByOperation() {
        if (operation == "view") {
            $(".easyui-textbox").textbox({required: false, editable: false, onlyview: true});
            $(".easyui-combobox").combobox({required: false, editable: false, onlyview: true});
            $(".easyui-combogrid").combobox({required: false, editable: false, onlyview: true});
            $(".easyui-datebox").datebox({required: false, editable: false, onlyview: true});
            $("#closeBtn").hide();
            $("#saveBtn").hide();
            $("#submitBtn").hide();
            $("#addBtn1").hide();
            $("#addBtn2").hide();
        } else if (type == 'flow') {
            $("#closeBtn").hide();
        }

    }

    //检查表单值是否合规
    function checkFromIsValidate() {
        const isValidate = $("#engFsdFileAssessFrom").form('validate');
        return isValidate;
    }

    //保存数据，修改或增加
    function saveEngFsdAssess(ifSubmit) {
        const isValidate = checkFromIsValidate();
        if (!isValidate) {
            MsgAlert({content: "输入数据不符合规则", type: 'error'});
            return false;
        }
        const saveEngFsdFileParam = $("#engFsdFileAssessFrom").serializeObject();

        let ifFirstSave = false;
        //第一次编写保存需要将状态设置为编写中
        if (saveEngFsdFileParam.status == null || saveEngFsdFileParam.status == '') {
            saveEngFsdFileParam.status = '1';
            $('#status').val('1');
            ifFirstSave = true;
        }
        saveEngFsdFileParam.createDate = (new Date()).getTime();
        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/engFsdAssess/saveEngFsdAssess",
            data: saveEngFsdFileParam,
            error: function (jData) {
                MsgAlert({content: jData.errorMessage ? jData.errorMessage : "更新评估信息失败", type: 'error'});
                return false;
            },
            successCallBack: function (jData) {
                if (jData.success == true) {
                    if (!ifSubmit) {
                        MsgAlert({content: jData.msg ? jData.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    }
                    //第一次保存确定处理人，并关闭其他人员待办任务
                    if (ifFirstSave) {
                        return closeMsgQua();
                    }

                    return true;
                } else {
                    return false;
                    MsgAlert({content: jData.errorMessage ? jData.errorMessage : "更新评估信息失败", type: 'error'});
                }
            }
        });

    }

    //关闭代办任务
    function closeMsgQua() {
        InitFuncCodeRequest_({
            data: {
                pkid: rowData.pkid,
                FunctionCode: 'ENG_FSD_ASSESS_CLOSE_MSG'
            },
            failCallBack: function () {
                return false;
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    return true;
                } else {
                    MsgAlert({content: jdata.msgData ? jdata.msgData[0] : jdata.msg, type: 'error'});
                    return false;
                }
            }
        });
    }

    function closeOrReloadAssess() {
        CloseWindowIframe();
        closeByOnunloadAssess();
    }

    function closeByOnunloadAssess() {

        if (param.OWindow) {
            if (param.OWindow.reload_ && !isListEnter) {
                param.OWindow.reload_();
            }
            if (param.OWindow.reload2_) {
                param.OWindow.reload2_();
            }
        }
    }

    function reload_(grid) {
        if (grid == 'dg1') {
            initDataGrid1();
        } else if (grid == 'dg2') {
            initDataGrid2();
        }
    }

    //增加工程文件措施
    function addOrEditAssessTech() {
        const title_ = $.i18n.t('工程文件');
        ShowWindowIframe({
            width: "760",
            height: "400",
            title: title_,
            param: {refPkid: assessPkid},
            url: "/views/engine/engFsd/engFsdFile/eng_fsd_file_assess_tech_edit.shtml"
        });
    }

    //增加措施库措施
    function addOrEditAssessProv() {
        const title_ = $.i18n.t('工程文件');
        ShowWindowIframe({
            width: "760",
            height: "400",
            title: title_,
            param: {refPkid: assessPkid},
            url: "/views/engine/engFsd/engFsdFile/eng_fsd_file_assess_prov_edit.shtml"
        });
    }

    //提交流程
    function submitEngFileAssessFlow() {
        const isSuccess = saveEngFsdAssess(true);
        if (isSuccess == false) {
            return;
        }

        if (!rowData.pkid) {
            MsgAlert({content: "获取pkid失败！", type: 'error'});
        }
        const result = $('#result').combobox('getValue');
        if (result == '2' || result == '3') {
            if (!confirm("不适用或不采取措施提交后将直接变成已完成，请确认是否提交")) {
                return false;
            }
            InitFuncCodeRequest_({
                data: {
                    pkid: rowData.pkid,
                    FunctionCode: 'ENG_FSD_ASSESS_SUBMIT'
                },
                successCallBack: function (jdata) {
                    if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                        MsgAlert({content: $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                        closeOrReloadAssess();
                    } else {
                        MsgAlert({content: jdata.msgData ? jdata.msgData[0] : jdata.msg, type: 'error'});
                    }
                }
            });
        } else {
            common_add_edit_({
                identity: '',
                isEdit: '',
                width: 520,
                height: 300,
                title: $.i18n.t('选择审批人'),
                param: {
                    operation: "flow",
                    roleId: '',
                    otherParam: '',
                    PKID: rowData.pkid,
                    FunctionCode_: 'ENG_FSD_ASSESS_SUBMIT',
                    successCallback: closeOrReloadAssess
                },
                url: "/views/flow/work_flow_account_select.shtml"
            });
        }
    }

    //优先执行
    postProcessingByOperation();

</script>
</body>
</html>