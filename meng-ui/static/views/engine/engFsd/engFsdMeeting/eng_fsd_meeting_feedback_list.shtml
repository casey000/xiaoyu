<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>

<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>防空停会议任务反馈</title>
    <script type="text/javascript" src="/js/datagrid_utils.js"></script>
    <style type="text/css">
        td {
            padding: 2px;

        }

        th {
            width: 120px;
        }

        button {
            width: 45px;
            height: 20px;
            margin-left: 3px;
            vertical-align: middle;
            border: 1px solid #cfcfcf;
            -moz-border-radius: 5px;
            border-radius: 5px;
            backgroud: #d5d5d5;
        }

    </style>
</head>
<body onunload="closeByOnunloadFeedMeeting()">
<div style="width:95%;margin:0 auto;">
    <div class="ibox float-e-margins">
        <div class="ibox-content">
            <div id="p0" class="easyui-panel" title="会议纪要信息" style="width: 100%"></div>
            <table class="table table-bordered table-info" style="width: 100%">
                <tr>
                    <td colspan="4" align="right" style="padding: 0;">
                        <input class="btn btn-primary" type="button" id="saveBtn" onclick="saveEngFsdMeetingTask()"
                               value="保存"/>
                        <input class="btn btn-primary" type="button" id="submitBtn"
                               onclick="saveEngFsdMeetingTask(true)"
                               value="反馈"/>
                        <input class="btn btn-primary" type="button" id="fileUploadBtn"
                               onclick="uploadAttachmentFile()"
                               value="上传附件"/>
                        <input class="btn btn-primary" type="button" id="closeBtn" onclick="closeOrReloadFeedMeeting()"
                               value="关闭"
                               style="margin-left:3px;margin-right: 20px;"/>
                    </td>
                </tr>
            </table>

            <fieldset class="fieldset_eui">
                <legend data-i18n="">会议信息</legend>
                <div class="ibox-content">
                    <form class="form-horizontal m-t" id="engFsdMeetingFrom">
                        <table class="table table-bordered table-info" style="width: 100%">
                            <tr>
                                <th>会议日期</th>
                                <td class="tdr">
                                    <input class="easyui-datebox" id="meetingDate" name="meetingDate"
                                           data-options="required: false, editable: false, onlyview: true"
                                           style="width: 200px;"/>
                                </td>
                                <th>会议纪要附件：</th>
                                <td class="tdr" target="_blank" id="fileUploadTd1" style="text-decoration:underline;">
                                </td>
                            </tr>

                            <tr>
                                <th>会议标题：</th>
                                <td class="tdr" colspan="3">
                                    <input class="easyui-textbox" id="title" name="title"
                                           data-options="required: false, editable: false, onlyview: true"
                                           style="width: 585px;"/>
                                </td>
                            </tr>

                            <tr>
                                <th>会议地点：</th>
                                <td class="tdr">
                                    <input class="easyui-textbox" id="meetingAddr" name="meetingAddr"
                                           data-options="required: false, editable: false, onlyview: true"
                                           style="width: 200px;"/>
                                </td>
                                <th>会议主持人：</th>
                                <td class="tdr">
                                    <input class="easyui-textbox" id="meetingHost" name="meetingHost"
                                           data-options="required: false, editable: false, onlyview: true"
                                           style="width: 167px;"/>
                                </td>
                            </tr>

                            <tr>
                                <th>参会人：</th>
                                <td class="tdr" colspan="3">
                                    <input class="easyui-textbox" id="attendee" name="attendee"
                                           data-options="required: false, editable: false, onlyview: true"
                                           style="width: 585px;height: 40px;"/>
                                </td>
                            </tr>

                            <tr>
                                <th>缺席人：</th>
                                <td class="tdr" colspan="3">
                                    <input class="easyui-textbox" id="absentee" name="absentee"
                                           data-options="required: false, editable: false, onlyview: true"
                                           style="width: 585px;height: 40px;"/>
                                </td>
                            </tr>

                            <tr>
                                <th>会议结论：</th>
                                <td class="tdr" colspan="3">
                                    <textarea class="easyui-textbox " id="conclusion" name="conclusion" multiline="true"
                                              style="width: 585px;height: 70px;border: 1px solid #ddd;border-radius: 5px;"
                                              data-options="required: false, editable: false, onlyview: true"></textarea>
                                </td>
                            </tr>

                        </table>
                    </form>
                </div>
            </fieldset>
            <fieldset class="fieldset_eui" id="tt" style="height: 255px">
                <legend data-i18n="">任务信息</legend>

                <form class="form-horizontal m-t" id="engFsdMeetingTaskFrom">
                    <input type="hidden" id="pkid" name="pkid"/>
                    <input type="hidden" id="refId" name="refId"/>
                    <input type="hidden" id="followUser" name="followUser"/>
                    <input type="hidden" id="followPerson" name="followPerson"/>
                    <input type="hidden" id="feedbackDate" name="feedbackDate"/>
                    <input type="hidden" id="feedbackStatus" name="feedbackStatus"/>
                    <input type="hidden" id="taskStatus" name="taskStatus"/>
                    <input type="hidden" id="meetingId" name="meetingId"/>
                    <input type="hidden" id="delayDate" name="delayDate"/>
                    <input type="hidden" id="delayReason" name="delayReason"/>
                    <input type="hidden" id="createUser" name="createUser"/>
                    <input type="hidden" id="createName" name="createName"/>
                    <input type="hidden" id="createDate" name="createDate"/>

                    <table class="table table-bordered table-info" style="width: 100%">
                        <tr>
                            <th>反馈期限</th>
                            <td class="tdr">
                                <input class="easyui-datebox" id="limitDate" name="limitDate"
                                       data-options="required: false, editable: false, onlyview: true"
                                       style="width: 200px;"/>
                            </td>
                        </tr>

                        <tr>
                            <th>任务标题：</th>
                            <td class="tdr" colspan="3">
                                <input class="easyui-textbox" id="taskTitle" name="taskTitle"
                                       data-options="required: false, editable: false, onlyview: true"
                                       style="width: 585px;"/>
                            </td>
                        </tr>

                        <tr>
                            <th>任务说明：</th>
                            <td class="tdr" colspan="3">
                                <textarea class="easyui-textbox " id="taskDesc" name="taskDesc" multiline="true"
                                          style="width: 585px;height: 70px;border: 1px solid #ddd;border-radius: 5px;"
                                          data-options="required: false, editable: false, onlyview: true"></textarea>
                            </td>
                        </tr>
                        <tr>
                            <th>会议任务附件：</th>
                            <td class="tdr" target="_blank" id="fileUploadTd2" style="text-decoration:underline;">
                            </td>
                        </tr>
                        <tr>
                            <th>反馈措施：</th>
                            <td class="tdr" colspan="3">
                                <input class="easyui-textbox" id="feedbackProv" name="feedbackProv"
                                       data-options="required: true, editable: true,multiline:true"
                                       style="width: 585px;height: 40px;"/>
                            </td>
                        </tr>

                    </table>
                </form>
            </fieldset>

        </div>
    </div>
</div>
<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script>
    let param = getParentParam_();
    let refId = param.refId;
    let pkid = param.pkid;

    function i18nCallBack() {
        initBasicData();
        initFileUpload('view', '#fileUploadTd1', 'ENGFSDMEETING', refId)
        initFileUpload('edit', '#fileUploadTd2', 'ENGFSDMEETINGTASK', pkid)
    }

    function initBasicData() {
        if (refId) {
            const url = "/meng-engine/engFsdMeeting/engFsdMeetingInfoById/" + refId;
            InitGatewayRequest_({
                type: "get",
                async: false,
                path: url,
                successCallBack: function (jData) {
                    if (jData.success == true) {
                        ParseFormField_(jData.obj, $("#engFsdMeetingFrom"));
                    } else {
                        MsgAlert({content: jData.errorMessage, type: 'error'});
                    }
                }
            })
        }

        if (pkid) {
            const url = "/meng-engine/engFsdMeetingTask/engFsdMeetingTaskInfoById/" + pkid;
            InitGatewayRequest_({
                type: "get",
                async: false,
                path: url,
                successCallBack: function (jData) {
                    if (jData.success == true) {
                        ParseFormField_(jData.obj, $("#engFsdMeetingTaskFrom"));
                    } else {
                        MsgAlert({content: jData.errorMessage, type: 'error'});
                    }
                }
            })
        }


    }


    //检查表单值是否合规
    function checkFromIsValidate() {
        const isValidate = $("#engFsdMeetingTaskFrom").form('validate');
        return isValidate;
    }


    function closeOrReloadFeedMeeting() {
        CloseWindowIframe();
        closeByOnunloadFeedMeeting();
    }

    function closeByOnunloadFeedMeeting() {

        if (param.OWindow && param.OWindow.reload_) {
            param.OWindow.reload_();
        }
    }


    //反馈实现逻辑
    function feedEngFsdMeetingTask() {

        if (!confirm("反馈后该任务将不可编辑，请确认是否反馈？")) {
            return;
        }

        const pkid = $('#pkid').val();
        InitFuncCodeRequest_({
            data: {
                pkid: pkid,
                FunctionCode: 'ENG_FSD_MEETING_TASK_CLOSE_MSG'
            },
            failCallBack: function () {
                MsgAlert({content: '系统错误', type: 'error'});
            },
            successCallBack: function (jData) {
                if (jData.code == RESULT_CODE.SUCCESS_CODE) {
                    if (param.OWindow && param.OWindow.MsgAlert) {
                        param.OWindow.MsgAlert({content: jData.msg ? jData.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    }
                    closeOrReloadFeedMeeting();
                } else {
                    MsgAlert({content: jData.msgData ? jData.msgData[0] : jData.msg, type: 'error'});
                }
            }
        });
    }

    //上传附件
    function uploadAttachmentFile() {
        if (!pkid || pkid == '') {
            MsgAlert({content: "没有任务信息！", type: 'error'});
            return;
        }

        common_upload_({
            identity: 'dg',
            resize: {},
            param: {
                cat: 'ENGFSDMEETINGTASK',
                sourceId: pkid,
                successCallBack: reload_,
                failCallBack: ""
            }
        });
    }

    //保存数据，修改或增加
    function saveEngFsdMeetingTask(isFeedback) {
        const isValidate = checkFromIsValidate();
        if (!isValidate) {
            return false;
        }
        const saveEngFsdMeetingTaskParam = $("#engFsdMeetingTaskFrom").serializeObject();

        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/engFsdMeetingTask/saveEngFsdMeetingTask",
            data: saveEngFsdMeetingTaskParam,
            error: function (jData) {
                MsgAlert({content: jData.errorMessage ? jData.errorMessage : "更新会议任务失败", type: 'error'});
                return false;
            },
            successCallBack: function (jData) {
                if (jData.success == true) {
                    if (isFeedback) {
                        feedEngFsdMeetingTask();
                    } else {
                        MsgAlert({content: jData.msg ? jData.msg : $.i18n.t('msg_tip:TIP.COMMON.OPT_SUCCESS')});
                    }
                } else {
                    MsgAlert({content: jData.errorMessage ? jData.errorMessage : "更新会议任务失败", type: 'error'});
                }
            }
        });
    }

    //上传成功处理
    function reload_() {
        initFileUpload('edit', '#fileUploadTd2', 'ENGFSDMEETINGTASK', pkid)
    }

    function initFileUpload(operation, element, category, sourceId) {

        InitFuncCodeRequest_({
            data: {
                SOURCE_ID: sourceId,
                CATEGORY: category,
                FunctionCode: 'ATTACHMENT_RSPL_GET'
            },
            async: false,
            successCallBack: function (jData) {
                if (jData.code == 200) {
                    let html = "";
                    for (let i = 0; i < jData.data.length; i++) {
                        if (operation == 'edit') {
                            html += '<li  style="list-style-type:none;"><a target="_blank" style="text-decoration:underline;" onclick="downFile(' + jData.data[i].PKID + ')">' + jData.data[i].ORG_NAME + '</a><span onclick="deleteFile(\'' + jData.data[i].PKID + '\');return false;" class="icon-cross">&nbsp;&nbsp;&nbsp;&nbsp;</span></li>';
                        } else {
                            html += '<li  style="list-style-type:none;"><a target="_blank" style="text-decoration:underline;" onclick="downFile(' + jData.data[i].PKID + ')">' + jData.data[i].ORG_NAME + '</a></li>';
                        }
                    }
                    $(element).empty();
                    $(element).html(html);
                }
            }
        });
    }


</script>
</body>
</html>