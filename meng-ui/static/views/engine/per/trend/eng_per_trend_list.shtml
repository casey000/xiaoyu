<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head id="i18n_" module="">
    <!--#include virtual="/views/items/resource_.shtml"-->
    <title>性能数据分析</title>
</head>

<body class="ibody">
<div id="tt" class="easyui-tabs" style="width:100%; height: 100%">
    <fieldset class="fieldset_eui">
        <form id="ffSearch" method="post">
            <div id="searchBar">
                <table class="table table-bordered table-info">
                    <tr>

                        <th class="th" align="right" data-i18n="" style="width:80px;">机型：</th>
                        <td style="width:100px" class="td5">
                            <input class="easyui-combobox" name="acType" id="acType"
                                   style="width:100px"/>
                        </td>

                        <th class="th" data-i18n="" style="width:80px;" align="right">机号：</th>
                        <td style="width:150px" class="td5">
                            <input class="easyui-combobox" name="acReg" id="acReg" style="width:110px"/>
                        </td>

                        <th class="th" align="right" data-i18n="" style="width:100px;">警告日期从：</th>
                        <td style="width:100px" class="td5">
                            <input class="easyui-datebox" name="createDateFrom" id="createDateFrom" style="width:100px"/>
                        </td>
                        <th class="th" align="right" data-i18n="" style="width:100px;">至：</th>
                        <td style="width:100px" class="td5">
                            <input class="easyui-datebox" id="createDateTo" name="createDateTo" style="width:100px"/>
                        </td>
                        <td colspan="2" class="td5">
                            <a href="javascript:void(0)" class="searchBtn" data-options="iconCls:'icon-search'"
                               onclick="onSearchClick();"><span>查询</span></a>
                            <a class="clearBtn" onclick="doClear_()" data-options="iconCls:'icon-clear'">
                                <span data-i18n="common:COMMON_OPERATION.RESET">重置</span></a>
                            <a class="addBtn" onclick="dealTrend('','B')" auth="ENG_PER_TREND1"><span>处置</span></a>
                        </td>
                    </tr>
                    <tr>

                        <th class="th" align="right" data-i18n="" style="width:80px;">发动机型号：</th>
                        <td style="width:100px" class="td5">
                            <input class="easyui-combobox" name="applyModel" id="applyModel"
                                   style="width:100px"/>
                        </td>
                        <th class="th" align="right" data-i18n="" style="width:80px;">件号：</th>
                        <td style="width:100px" class="td5">
                            <input class="easyui-combobox" name="epn" id="epn"
                                   style="width:110px"/>
                        </td>
                        <th class="th" data-i18n="" style="width:80px;" align="right">发动机序号：</th>
                        <td style="width:150px" class="td5">
                            <input class="easyui-textbox" name="esn" id="esn" style="width:100px"/>
                        </td>

                        <th class="th" align="right" data-i18n="" style="width:100px;">处置方式：</th>
                        <td style="width:100px" class="td5">
                            <input class="easyui-combobox" name="dealType" id="dealType" style="width:100px"/>
                        </td>
                    </tr>
                    <tr>
                        <th class="th" align="right" data-i18n="" style="width:100px;">数据分类：</th>
                        <td style="width:100px" class="td5">
                            <input class="easyui-combobox" name="dataFrom" id="dataFrom" style="width:100px"/>
                        </td>
                        <th class="th" align="right" data-i18n="" style="width:100px;">是否处置：</th>
                        <td style="width:100px" class="td5">
                            <input class="easyui-combobox" name="ifDeal" id="ifDeal" style="width:110px"/>
                        </td>
                    </tr>
                </table>
            </div>
        </form>
    </fieldset>
    <table id="u_dg"></table>
    <table id="l_dg"></table>
</div>

<script type="text/javascript" src="/js/datagrid_utils.js"></script>
<script type="text/javascript">
    var PAGE_DATA = {};
    var user = getLoginInfo();
    var sourceType='4';
    function i18nCallBack() {
        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/engBsiReport/getMpActypes",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#acType').combobox({
                        data: jdata.obj,
                        valueField: 'value',
                        textField: 'text',
                        panelHeight: '150px',
                        onSelect: function (item) {
                            var datas =  {"mpActype":item.value};
                            InitGatewayRequest_({
                                async: false,
                                data: datas,
                                path: "/meng-engine/engBsiReport/getAcnos",
                                successCallBack: function (jdata) {
                                    if (jdata.success == true) {
                                        $('#acReg').combobox({
                                            data: jdata.obj,
                                            valueField: 'text',
                                            textField: 'text',
                                            panelHeight: '150px',
                                        });
                                    } else {
                                        MsgAlert({content: '获取机号列表失败', type: 'error'});
                                    }
                                }
                            });
                        }
                    });
                } else {
                    MsgAlert({content: '获取机型列表失败', type: 'error'});
                }
            }
        });

        InitGatewayRequest_({
            async: false,
            data: {"mpActype":""},
            path: "/meng-engine/engBsiReport/getAcnos",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#acReg').combobox({
                        data: jdata.obj,
                        valueField: 'text',
                        textField: 'text',
                        panelHeight: '150px',
                    });
                } else {
                    MsgAlert({content: '获取机号列表失败', type: 'error'});
                }
            }
        });
        InitGatewayRequest_({
            async: false,
            path: "/meng-engine/basTypeMapper/getEngtypesAll",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#applyModel').combobox({
                        data: jdata.obj,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '100px',
                    });
                } else {
                    MsgAlert({content: '获取型号列表失败', type: 'error'});
                }
            }
        });
        InitGatewayRequest_({
            type: "get",
            async: false,
            path: "/meng-engine/baseOwn/getEngType",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#epn').combobox({
                        data: jdata.obj,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '150px',
                        onSelect: function (item) {
                            InitGatewayRequest_({
                                async: false,
                                data: {matnr: item.VALUE},
                                path: "/meng-engine/baseOwn/getEngByType",
                                successCallBack: function (jdata) {
                                    if (jdata.success == true) {
                                        $('#esn').combobox({
                                            data: jdata.obj,
                                            valueField: 'VALUE',
                                            textField: 'TEXT',
                                            panelHeight: '150px',
                                        });
                                    } else {
                                        MsgAlert({content: '获取发动机序号列表失败', type: 'error'});
                                    }
                                }
                            });
                        }
                    });
                } else {
                    MsgAlert({content: '获取发动机型号列表失败', type: 'error'});
                }
            }
        });

        InitGatewayRequest_({
            async: false,
            data:{matnr:''},
            path: "/meng-engine/baseOwn/getEngByType",
            successCallBack: function (jdata) {
                if (jdata.success == true) {
                    $('#esn').combobox({
                        data: jdata.obj,
                        valueField: 'VALUE',
                        textField: 'TEXT',
                        panelHeight: '150px',
                    });
                } else {
                    MsgAlert({content: '获取发动机序号列表失败', type: 'error'});
                }
            }
        });

        InitFuncCodeRequest_({
            data: {
                domainCode: "ENG_OIL_DEAL_TYPE,ENG_PER_FLIGHT_PHASE,ENG_PER_SOURCE_TYPE,ENG_OIL_TREND_STATUS",
                FunctionCode: "ANALYSIS_DOMAIN_BYCODE"
            },
            successCallBack: function (jdata) {
                if (jdata.code == RESULT_CODE.SUCCESS_CODE) {
                    $("#dataFrom").combobox({
                        panelHeight: '50px',
                        data: jdata.data.ENG_PER_SOURCE_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#dealType").combobox({
                        panelHeight: '100px',
                        data: jdata.data.ENG_OIL_DEAL_TYPE,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    $("#ifDeal").combobox({
                        panelHeight: '100px',
                        data: jdata.data.ENG_OIL_TREND_STATUS,
                        valueField: 'VALUE',
                        textField: 'TEXT'
                    });
                    PAGE_DATA['dealType'] = DomainCodeToMap_(jdata.data["ENG_OIL_DEAL_TYPE"]);
                    PAGE_DATA['flightPhase'] = DomainCodeToMap_(jdata.data["ENG_PER_FLIGHT_PHASE"]);
                    PAGE_DATA['dataFrom'] = DomainCodeToMap_(jdata.data["ENG_PER_SOURCE_TYPE"]);
                } else {
                    MsgAlert({content: jdata.msg, type: 'error'});
                }
            }
        });

        InitDataGrid();
        InitDataGrid2(-1);
    }

    function InitDataGrid() {
        var queryParams = $("#ffSearch").serializeObject();
        $("#u_dg").GatewayDataGrid({
            identity: 'u_dg',
            idField: "pkid",
            queryParams: queryParams,
            pagination: true,
            path: "/meng-engine/engPerTrend/listByPage",
            fitcolumn:true,
            resize: function () {
                return tabs_standard_resize($('#tt'), 0.55, 0, 70, -6);
            },
            columns: {
                param: {FunctionCode: 'ENG_PER_TREND_LIST'},
                alter: {
                    dealDate: {
                        type: 'date'
                    },
                    createDate: {
                        type: 'date'
                    },
                    dealType: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['dealType'] [value];
                        }
                    },
                    dataFrom: {
                        formatter: function (value, row, index) {
                            return PAGE_DATA['dataFrom'] [value];
                        }
                    },
                    alertName:{
                        formatter: function (value, row, index) {
                            return '<a href="javascript:void(0);" onclick="viewDetail(\'' + row.setId + '\');">' + value + '</a>';
                        }
                    }
                }
            },
            contextMenus: [
                {
                    id: "m-edit",
                    i18nText: "处置",
                    auth: "ENG_PER_TREND1",
                    onclick: function () {
                        var row = $('#u_dg').datagrid('getSelected');
                        if (!row.pkid) {
                            MsgAlert({content: '请选择记录！', type: 'error'});
                            return;
                        }
                        dealTrend(row,'');
                    }
                }
            ],
            onLoadSuccess: function (data) {
                $("input:checkbox").prop("disabled", true);
                $('#u_dg').datagrid('uncheckAll');
                var rows = data.rows;
                for (var i = 0; i < rows.length; i++) {
                    if (!rows[i].dealType) {
                        $("input[type='checkbox']")[i+1].disabled = false;
                    }
                }

            },
            onClickRow: function (rowIndex, row) {
                if (!!row.pkid) {
                    if (row.dataSource.indexOf("-") != -1)
                            InitDataGrid3(row.pkid);
                        else
                            InitDataGrid2(row.pkid);
                }
            },
            validAuth: function (row, items) {
                if(row.dealType){
                    items['处置'].enable = false;
                }

                return items;
            }
        });
    }

    Array.prototype.remove = function(val) {
        var index = this.indexOf(val);
        if (index > -1) {
            this.splice(index, 1);
        }
    };

    function InitDataGrid2(refPkid) {
        var queryParams = $("#ffSearch").serializeObject();
        $("#l_dg").GatewayDataGrid({
            identity: 'l_dg',
            idField: "PKID",
            queryParams: {
                trendId: refPkid
                },
            pagination: true,
            path: "/meng-engine/engPerTrend/listDetailByPage",
            fitcolumn:true,
            resize: function () {
                return tabs_standard_resize($('#tt'), 0.38, 0, 10, -6);
            },

            columns: {
                param: {FunctionCode: 'ENG_PER_DATA_LIST'},
                alter: {
                    flightPhase: {
                        formatter: function (value) {
                            return PAGE_DATA['flightPhase'][value];
                        }
                    },
                    createDate: {
                        type: 'date'
                    },
                    flightDatetime: {
                        type: 'date'
                    },
                    engineInstallDate: {
                        type: 'date'
                    }
                }
            },
            contextMenus: [

            ]
        });
    }

    function InitDataGrid3(refPkid) {
        var queryParams = $("#ffSearch").serializeObject();
        $("#l_dg").GatewayDataGrid({
            identity: 'l_dg',
            idField: "PKID",
            queryParams: {
                trendId: refPkid
            },
            pagination: true,
            path: "/meng-engine/engPerTrend/listDetailByPageForQAR",
            fitcolumn:true,
            resize: function () {
                return tabs_standard_resize($('#tt'), 0.38, 0, 10, -6);
            },

            columns: {
                param: {FunctionCode: 'ENG_PER_QAR_PERFM_LIST'},
                alter: {

                    flightDate: {
                        type: 'date'
                    }
                }
            },
            contextMenus: []
        });
    }

    /** 刷新列表数据 */
    function reload_() {
        $("#u_dg").datagrid("reload");
    }

    //重置
    function doClear_() {
        $("#ffSearch").form('clear');
    }

    function onSearchClick() {
        InitDataGrid();
        InitDataGrid2(-1);
    }


    function viewDetail(pkid){
        var operation = 'view';
        var title_ = $.i18n.t('监控阈值设置');
        ShowWindowIframe({
            width: "1020",
            height: "680",
            title: title_,
            param: {pkid: pkid, operation: operation},
            url: "/views/engine/engPerSet/eng_per_set_add_edit.shtml"
        });
    }


    function dealTrend(rowData,flag){
        var esns = '';
        var pkids = '';
        var rows = $('#u_dg').datagrid('getChecked');
        if("B" == flag){//批量处置
            if (rows.length == 0) {
                MsgAlert({content: '请至少选择一行数据', type: 'error'});
                return false;
            }
            for(var i = 0;i<rows.length;i++){
                var row = rows[i];
                var id = row.pkid;
                var sn = row.esn;
                if(id && pkids.indexOf(id) == -1){
                    pkids = pkids + ',' + id;
                }
                if(sn && esns.indexOf(sn) == -1){
                    esns = esns + ',' + sn;
                }
            }
            pkids = pkids.substring(1);
            esns = esns.substring(1);
        }else {
            pkids = rowData.pkid;
            esns = rowData.esn;
        }
        var title_ = $.i18n.t('性能数据分析处置');
        ShowWindowIframe({
            width: "620",
            height: "400",
            title: title_,
            param: {pkids:pkids,esns:esns,sourceType:sourceType},
            url: "/views/engine/per/trend/eng_per_trend_deal.shtml"
        });
    }
</script>
</body>
</html>

